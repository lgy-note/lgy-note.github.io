



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>nginx2 - mkdocs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.30686662.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#nginx" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="mkdocs" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              mkdocs
            </span>
            <span class="md-header-nav__topic">
              
                nginx2
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href=".." class="md-tabs__link">
        home
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../python-base/" class="md-tabs__link">
          python
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../nginx/" class="md-tabs__link md-tabs__link--active">
          service
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../mysql/" class="md-tabs__link">
          database
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../open-falcon/" class="md-tabs__link">
          monitor
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../tcp-issue/" class="md-tabs__link">
          basis
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="mkdocs" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    mkdocs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="home" class="md-nav__link">
      home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      python
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        python
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../python-base/" title="python-base" class="md-nav__link">
      python-base
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-lib/" title="python-lib" class="md-nav__link">
      python-lib
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-lib2/" title="python-lib2" class="md-nav__link">
      python-lib2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-web/" title="python-web" class="md-nav__link">
      python-web
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-other/" title="python-other" class="md-nav__link">
      python-other
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      service
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        service
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../nginx/" title="nginx" class="md-nav__link">
      nginx
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        nginx2
      </label>
    
    <a href="./" title="nginx2" class="md-nav__link md-nav__link--active">
      nginx2
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#nginx" class="md-nav__link">
    nginx启动脚本
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx_1" class="md-nav__link">
    Nginx优化
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#keepalived" class="md-nav__link">
    keepalived
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx_upstream_check_module" class="md-nav__link">
    nginx_upstream_check_module
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    虚拟主机
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    正向代理
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#404" class="md-nav__link">
    404跳转
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#yum" class="md-nav__link">
    yum代理缓存
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sslh2" class="md-nav__link">
    ssl和h2
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    跨域
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#openresty" class="md-nav__link">
    openresty
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#proxyip" class="md-nav__link">
    proxy获取真实ip
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#php-fpm" class="md-nav__link">
    php-fpm
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../apache/" title="apache" class="md-nav__link">
      apache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../saltstack/" title="saltstack" class="md-nav__link">
      saltstack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tomcat/" title="tomcat" class="md-nav__link">
      tomcat
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ansible/" title="ansible" class="md-nav__link">
      ansible
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../trafficserver/" title="trafficserver" class="md-nav__link">
      trafficserver
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../haproxy/" title="haproxy" class="md-nav__link">
      haproxy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../docker/" title="docker" class="md-nav__link">
      docker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../varnish/" title="varnish" class="md-nav__link">
      varnish
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../bind/" title="bind" class="md-nav__link">
      bind
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lvs/" title="lvs" class="md-nav__link">
      lvs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../log-analysis/" title="log-analysis" class="md-nav__link">
      log-analysis
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      database
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        database
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../mysql/" title="mysql" class="md-nav__link">
      mysql
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mysql2/" title="mysql2" class="md-nav__link">
      mysql2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../memcached/" title="memcached" class="md-nav__link">
      memcached
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../redis/" title="redis" class="md-nav__link">
      redis
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mongodb/" title="mongodb" class="md-nav__link">
      mongodb
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../hadoop/" title="hadoop" class="md-nav__link">
      hadoop
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../postgresql/" title="postgresql" class="md-nav__link">
      postgresql
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      monitor
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        monitor
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../open-falcon/" title="open-falcon" class="md-nav__link">
      open-falcon
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zabbix/" title="zabbix" class="md-nav__link">
      zabbix
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zabbix2/" title="zabbix2" class="md-nav__link">
      zabbix2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../netdata/" title="netdata" class="md-nav__link">
      netdata
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      basis
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        basis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../tcp-issue/" title="tcp-issue" class="md-nav__link">
      tcp-issue
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../git-svn/" title="git-svn" class="md-nav__link">
      git-svn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../vpn/" title="vpn" class="md-nav__link">
      vpn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../shell/" title="shell" class="md-nav__link">
      shell
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../disk/" title="disk" class="md-nav__link">
      disk
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../filesystem/" title="filesystem" class="md-nav__link">
      filesystem
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../source/" title="source" class="md-nav__link">
      source
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../command/" title="command" class="md-nav__link">
      command
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../linux-base/" title="linux-base" class="md-nav__link">
      linux-base
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../linux-soft/" title="linux-soft" class="md-nav__link">
      linux-soft
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../other/" title="other" class="md-nav__link">
      other
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#nginx" class="md-nav__link">
    nginx启动脚本
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx_1" class="md-nav__link">
    Nginx优化
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#keepalived" class="md-nav__link">
    keepalived
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx_upstream_check_module" class="md-nav__link">
    nginx_upstream_check_module
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    虚拟主机
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    正向代理
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#404" class="md-nav__link">
    404跳转
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#yum" class="md-nav__link">
    yum代理缓存
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sslh2" class="md-nav__link">
    ssl和h2
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    跨域
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#openresty" class="md-nav__link">
    openresty
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#proxyip" class="md-nav__link">
    proxy获取真实ip
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#php-fpm" class="md-nav__link">
    php-fpm
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>nginx2</h1>
                
                <h2 id="nginx">nginx启动脚本</h2>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="nv">NGINX</span><span class="o">=</span>/usr/local/nginx/sbin/nginx
<span class="nv">PID</span><span class="o">=</span>/usr/local/nginx/logs/nginx.pid
<span class="c1">##fun</span>
START <span class="o">()</span> <span class="o">{</span>
pstree -p <span class="p">|</span>grep nginx &gt; /dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
   <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$PID</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="m">0</span> <span class="o">]</span>
      <span class="k">then</span>
                        <span class="nb">echo</span> <span class="s2">&quot;Warnning: nginx already running&quot;</span>
   <span class="k">else</span>

               <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$PID</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
                rm -rf <span class="nv">$PID</span>
                <span class="k">fi</span>
     <span class="nv">$NGINX</span>
<span class="c1">##stdin OK</span>
             <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
              <span class="nb">echo</span> -e <span class="s2">&quot;nginx start\t\t\t\t [\033[32m OK \033[0m]&quot;</span>
             <span class="k">else</span>
               <span class="nb">echo</span> -e <span class="s2">&quot;nginx start\t\t\t\t [\033[31m Fail \033[0m]&quot;</span>
             <span class="k">fi</span>
   <span class="k">fi</span>
<span class="o">}</span>
STOP <span class="o">()</span> <span class="o">{</span>
pstree -p <span class="p">|</span>grep nginx &gt; /dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
<span class="k">if</span> <span class="o">[</span> -f <span class="nv">$PID</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="m">0</span> <span class="o">]</span>
      <span class="k">then</span>
                       killall -s QUIT nginx
<span class="c1">#check</span>
                  <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
                    <span class="nb">echo</span> -e <span class="s2">&quot;nginx stop\t\t\t\t [\033[32m OK \033[0m]&quot;</span>
                  <span class="k">fi</span>
   <span class="k">else</span>
             rm -rf /usr/local/nginx/logs/nginx.pid &gt; /dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
             <span class="nb">echo</span> -e <span class="s2">&quot;nginx stop\t\t\t\t [\033[31m Fail \033[0m]&quot;</span>
   <span class="k">fi</span>
<span class="o">}</span>
RESTART <span class="o">()</span> <span class="o">{</span>
STOP<span class="p">;</span>sleep <span class="m">1</span><span class="p">;</span>START
<span class="o">}</span>
RELOAD <span class="o">()</span> <span class="o">{</span>
<span class="k">if</span> <span class="o">[</span> -f <span class="nv">$PID</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="m">0</span> <span class="o">]</span>
      <span class="k">then</span>
          killall -s HUP <span class="nv">$NGINX</span>
<span class="c1">#reload check</span>
              <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
                     <span class="nb">echo</span> -e <span class="s2">&quot;nginx reload\t\t\t\t [\033[32m OK \033[0m]&quot;</span>
              <span class="k">fi</span>
<span class="k">else</span>
         <span class="nb">echo</span> <span class="s2">&quot;Warnning: nginx stop,please start nginx&quot;</span>
<span class="k">fi</span>
<span class="o">}</span>
STATUS <span class="o">()</span> <span class="o">{</span>
elinks http://localhost -dump &gt; /dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
          <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
             <span class="nb">echo</span> <span class="s2">&quot;nginx running...&quot;</span>
          <span class="k">else</span>
             <span class="nb">echo</span> <span class="s2">&quot;nging stop&quot;</span>
          <span class="k">fi</span>
<span class="o">}</span>
<span class="c1">#main</span>
<span class="k">case</span> <span class="nv">$1</span> in
start<span class="o">)</span> START<span class="p">;;</span>
stop<span class="o">)</span> STOP<span class="p">;;</span>
restart<span class="o">)</span> RESTART<span class="p">;;</span>
reload<span class="o">)</span> RELOAD<span class="p">;;</span>
status<span class="o">)</span> STATUS<span class="p">;;</span>
*<span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;USAGE: AVGE is start|stop|restart|reload|status&quot;</span><span class="p">;;</span>
<span class="k">esac</span>
</pre></div>
</td></tr></table>

<h2 id="nginx_1">Nginx优化</h2>
<div class="codehilite"><pre><span></span><span class="nv">Nginx</span><span class="ss">(</span>读音<span class="nv">engine</span> <span class="nv">x</span><span class="ss">)</span>服务器由于性能优秀稳定、配置简单以及跨平台，被越来越多的公司和个人所采用，现已成为市场份额继<span class="nv">Apache</span>之后的
第二大<span class="nv">Web</span>服务器。各大小网站论坛博客也介绍说明了<span class="nv">Nginx</span>从安装到优化的各种配置。不过看了很多这些相关<span class="nv">Nginx</span>的文档之后，发现一个
比较大的问题，就是这些文档基本也就从两个方面着手，一是修改<span class="nv">Nginx</span>的配置文件，二是调整操作系统的相关内核参数；而且文档说明也不
够明了，缺乏比较系统级别的优化。本文将从<span class="nv">Nginx</span>源码编译安装开始，到修改配置文件，调整系统内核参数以及架构四个方面着手分别介绍如何优化。
一.     安装
<span class="ss">(</span><span class="mi">1</span><span class="ss">)</span>  精简模块
<span class="nv">Nginx</span>由于不断添加新的功能，附带的模块也越来越多。很多操作系统厂商为了用户方便安装管理，都增加了<span class="nv">rpm</span>、<span class="nv">deb</span>或者其他自有格式
软件包，可以本地甚至在线安装。不过我不太建议使用这种安装方式。这虽然简化了安装，在线安装甚至可以自动解决软件依赖关系，但是
安装后软件的文件布局过于分散，不便管理维护；同时也正是由于存在软件包之间的依赖关系，导致当有安全漏洞、或者其它问题，想要
通过更新升级<span class="nv">Nginx</span>新版本时却发现<span class="nv">yum</span>、<span class="nv">deb</span>源还未发布新版本<span class="ss">(</span>一般都落后于官网发布的软件版本<span class="ss">)</span>。最重要的是采用非源码编译安装的
方式，默认会添加入许多模块，比如邮件相关、<span class="nv">uwsgi</span>、<span class="nv">memcache</span>等等，很多网站运行时这些模块根本未用到，虽然平时占用的资源很小，
但是仍然可能是压弯骆驼的一根稻草。各种非必需模块默认安装运行的同时，也给<span class="nv">Web</span>系统带来了安全隐患。尽量保持软件的轻装上阵，
是每个运维应当尽力做到的，所以我建议一般常用的服务器软件使用源码编译安装管理。。我一般使用的编译参数如下，<span class="nv">PHP</span>相关模块
<span class="nv">fastcgi</span>被保留用作后文优化说明，：


.<span class="o">/</span><span class="nv">configure</span> \
<span class="s2">&quot;</span><span class="s">--prefix=/App/nginx</span><span class="s2">&quot;</span> \
<span class="s2">&quot;</span><span class="s">--with-http_stub_status_module</span><span class="s2">&quot;</span> \
<span class="s2">&quot;</span><span class="s">--without-http_auth_basic_module</span><span class="s2">&quot;</span> \
<span class="s2">&quot;</span><span class="s">--without-http_autoindex_module</span><span class="s2">&quot;</span> \
<span class="s2">&quot;</span><span class="s">--without-http_browser_module</span><span class="s2">&quot;</span> \
<span class="s2">&quot;</span><span class="s">--without-http_empty_gif_module</span><span class="s2">&quot;</span> \
<span class="s2">&quot;</span><span class="s">--without-http_geo_module</span><span class="s2">&quot;</span> \
<span class="s2">&quot;</span><span class="s">--without-http_limit_conn_module</span><span class="s2">&quot;</span> \
<span class="s2">&quot;</span><span class="s">--without-http_limit_req_module</span><span class="s2">&quot;</span> \
<span class="s2">&quot;</span><span class="s">--without-http_map_module</span><span class="s2">&quot;</span> \
<span class="s2">&quot;</span><span class="s">--without-http_memcached_module</span><span class="s2">&quot;</span> \
<span class="s2">&quot;</span><span class="s">--without-http_proxy_module</span><span class="s2">&quot;</span> \
<span class="s2">&quot;</span><span class="s">--without-http_referer_module</span><span class="s2">&quot;</span> \
<span class="s2">&quot;</span><span class="s">--without-http_scgi_module</span><span class="s2">&quot;</span> \
<span class="s2">&quot;</span><span class="s">--without-http_split_clients_module</span><span class="s2">&quot;</span> \
<span class="s2">&quot;</span><span class="s">--without-http_ssi_module</span><span class="s2">&quot;</span> \
<span class="s2">&quot;</span><span class="s">--without-http_upstream_ip_hash_module</span><span class="s2">&quot;</span> \
<span class="s2">&quot;</span><span class="s">--without-http_upstream_keepalive_module</span><span class="s2">&quot;</span> \
<span class="s2">&quot;</span><span class="s">--without-http_upstream_least_conn_module</span><span class="s2">&quot;</span> \
<span class="s2">&quot;</span><span class="s">--without-http_userid_module</span><span class="s2">&quot;</span> \
<span class="s2">&quot;</span><span class="s">--without-http_uwsgi_module</span><span class="s2">&quot;</span> \
<span class="s2">&quot;</span><span class="s">--without-mail_imap_module</span><span class="s2">&quot;</span> \
<span class="s2">&quot;</span><span class="s">--without-mail_pop3_module</span><span class="s2">&quot;</span> \
<span class="s2">&quot;</span><span class="s">--without-mail_smtp_module</span><span class="s2">&quot;</span> \
<span class="s2">&quot;</span><span class="s">--without-poll_module</span><span class="s2">&quot;</span> \
<span class="s2">&quot;</span><span class="s">--without-select_module</span><span class="s2">&quot;</span> \
<span class="s2">&quot;</span><span class="s">--with-cc-opt=&#39;-O2&#39;</span><span class="s2">&quot;</span>
编译参数根据网站是否真正用到的原则增添或者减少，比如我们公司如果需要用到<span class="nv">ssi</span>模块,从而能够实现访问<span class="nv">shtml</span>页面，可以将第<span class="mi">17</span>行删除，
那么<span class="nv">Nginx</span>将默认安装。大家可以通过运行 <span class="s2">&quot;</span><span class="s">./configure --help</span><span class="s2">&quot;</span> 查看编译帮助，决定是否需要安装哪些模块。
<span class="ss">(</span><span class="mi">2</span><span class="ss">)</span>  <span class="nv">GCC</span>编译参数优化 [可选项】
<span class="nv">GCC</span>总共提供了<span class="mi">5</span>级编译优化级别：
<span class="o">-</span><span class="nv">O0</span>: 无优化。
<span class="o">-</span><span class="nv">O</span>和<span class="o">-</span><span class="nv">O1</span>: 使用能减少目标代码尺寸以及执行时间并且不会使编译时间明显增加的优化。在编译大型程序的时候会显著增加编译时内存的使用。
<span class="o">-</span><span class="nv">O2</span>: 包含<span class="o">-</span><span class="nv">O1</span>的优化并增加了不需要在目标文件大小和执行速度上进行折衷的优化。编译器不执行循环展开以及函数内联。此选项将增加编译
时间和目标文件的执行性能。
<span class="o">-</span><span class="nv">Os</span>: 可以看成 <span class="o">-</span><span class="nv">O2</span>.<span class="mi">5</span>，专门优化目标文件大小，执行所有的不增加目标文件大小的<span class="o">-</span><span class="nv">O2</span>优化选项，并且执行专门减小目标文件大小的优化选项。
适用于磁盘空间紧张时使用。但有可能有未知的问题发生，况且目前硬盘容量很大，常用程序无必要使用。
<span class="o">-</span><span class="nv">O3</span>: 打开所有 <span class="o">-</span><span class="nv">O2</span> 的优化选项外增加 <span class="o">-</span><span class="nv">finline</span><span class="o">-</span><span class="nv">functions</span>、<span class="o">-</span><span class="nv">funswitch</span><span class="o">-</span><span class="nv">loops</span>、<span class="o">-</span><span class="nv">fgcse</span><span class="o">-</span><span class="nv">after</span><span class="o">-</span><span class="nv">reload</span> 优化选项。相对于 <span class="o">-</span><span class="nv">O2</span> 性能
并未有较多提高，编译时间也最长，生成的目标文件也更大更占内存，有时性能不增反而降低，甚至产生不可预知的问题<span class="ss">(</span>包括错误<span class="ss">)</span>，所以并不
被大多数软件安装推荐，除非有绝对把握方可使用此优化级别。
修改<span class="nv">GCC</span>编译参数，提高编译优化级别，此方法适用于所有通过<span class="nv">GCC</span>编译安装的程序，不止<span class="nv">Nginx</span>。稳妥起见用 <span class="o">-</span><span class="nv">O2</span>，这也是大多数软件编译推荐
的优化级别。查看<span class="nv">Nginx</span>源码文件 <span class="nv">auto</span><span class="o">/</span><span class="nv">cc</span><span class="o">/</span><span class="nv">gcc</span>，搜索<span class="nv">NGX_GCC_OPT</span>，默认<span class="nv">GCC</span>编译参数为<span class="o">-</span><span class="nv">O</span>，可以直接修改内容为<span class="nv">NGX_GCC_OPT</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">-O2</span><span class="s2">&quot;</span>或者
在 .<span class="o">/</span><span class="nv">configure</span>配置时添加<span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">cc</span><span class="o">-</span><span class="nv">opt</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">-O2</span><span class="s1">&#39;</span>选项。
二.      配置
应用服务器的性能优化主要在合理使用<span class="nv">CPU</span>、内存、磁盘<span class="nv">IO</span>和网络<span class="nv">IO</span>四个方面，现在我们从<span class="nv">Nginx</span>配置文件 <span class="nv">nginx</span>.<span class="nv">conf</span> 入手进行优化：
<span class="ss">(</span><span class="mi">1</span><span class="ss">)</span>  工作进程数的选择
指令：<span class="nv">worker_processes</span> 
定义了<span class="nv">Nginx</span>对外提供<span class="nv">web</span>服务时的工作进程数。最优值取决于许多因素，包括（但不限于）<span class="nv">CPU</span>核心的数量、存储数据的硬盘数量及负载模式。
不能确定的时候，将其设置为可用的<span class="nv">CPU</span>内核数将是一个好的开始（设置为“<span class="nv">auto</span>”将尝试自动检测它）。
<span class="nv">Shell</span>执行命令  <span class="nv">ps</span> <span class="nv">ax</span> <span class="o">|</span> <span class="nv">grep</span> <span class="s2">&quot;</span><span class="s">nginx: worker process</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">v</span> <span class="s2">&quot;</span><span class="s">grep</span><span class="s2">&quot;</span> 可以看到运行中的<span class="nv">Nginx</span>工作进程数，
一般建议设置成服务器逻辑核心数，<span class="nv">Shell</span>执行命令 <span class="nv">cat</span> <span class="o">/</span><span class="nv">proc</span><span class="o">/</span><span class="nv">cpuinfo</span> <span class="o">|</span> <span class="nv">grep</span> <span class="nv">processor</span> <span class="o">|</span> <span class="nv">wc</span> <span class="o">-</span><span class="nv">l</span> 可以检测出服务
器逻辑核心总数，偷懒可以直接写<span class="nv">auto</span>，<span class="nv">Nginx</span>自适应。
        <span class="ss">(</span><span class="mi">2</span><span class="ss">)</span>  是否绑定<span class="nv">CPU</span>
指令：<span class="nv">worker_cpu_affinity</span>

绑定工作进程到对应<span class="nv">CPU</span>核心，<span class="nv">Nginx</span>默认未开启<span class="nv">CPU</span>绑定。目前的服务器一般为多核<span class="nv">CPU</span>，当并发很大时，服务器各个<span class="nv">CPU</span>的使用
率可能出现严重不均衡的局面，这时候可以考虑使用<span class="nv">CPU</span>绑定，以达到<span class="nv">CPU</span>使用率相对均匀的状态，充分发挥多核<span class="nv">CPU</span>的优势。
<span class="nv">top</span>、<span class="nv">htop</span>等程序可以查看所有<span class="nv">CPU</span>核心的使用率状况。绑定样例：

<span class="mi">1</span>
<span class="mi">2</span>
<span class="nv">worker_processes</span>    <span class="mi">4</span><span class="c1">;</span>
<span class="nv">worker_cpu_affinity</span> <span class="mi">0001</span> <span class="mi">0010</span> <span class="mi">0100</span> <span class="mi">1000</span><span class="c1">;</span>
<span class="ss">(</span><span class="mi">3</span><span class="ss">)</span>  打开文件数限制
指令：<span class="nv">worker_rlimit_nofile</span>
设定了每个<span class="nv">Nginx</span>工作进程打开的最大文件数，受限于系统的用户进程打开文件数限制，未设置则使用系统默认值。理论上应该
设置为当前<span class="nv">Shell</span>启动进程的最大打开文件数除以<span class="nv">Nginx</span>的工作进程数。由于<span class="nv">Nginx</span>的工作进程打开文件数并不一完全均匀，
所以可以将其设置成<span class="nv">Shell</span>启动进程的最大打开文件数。<span class="nv">Shell</span>执行命令 <span class="nv">ulimit</span> <span class="o">-</span><span class="nv">n</span> 可以查看当前登录<span class="nv">Shell</span>会话最大打开
文件数数限制。<span class="nv">Linux</span>系统用户进程默认同时打开文件最大数为<span class="mi">1024</span>，这个值太小，访问量稍大就报“<span class="nv">too</span> <span class="nv">many</span> <span class="nv">open</span> <span class="nv">files</span><span class="s2">&quot;</span><span class="s">。</span>
<span class="nv">Shell</span>执行命令先修改用户打开文件数限制：


<span class="nv">echo</span> <span class="s2">&quot;</span><span class="s">* - nofile 65536</span><span class="s2">&quot;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">security</span><span class="o">/</span><span class="nv">limits</span>.<span class="nv">conf</span>
然后添加入<span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">profile</span>如下两行内容，修改所有<span class="nv">Shell</span>和通过<span class="nv">Shell</span>启动的进程打开文件数限制：

<span class="mi">1</span>
<span class="nv">echo</span> <span class="s2">&quot;</span><span class="s">ulimit -n 65536</span><span class="s2">&quot;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">profile</span>
<span class="nv">Shell</span>执行命令使当前<span class="nv">Shell</span>临时会话立即生效：

<span class="mi">1</span>
<span class="nv">ulimit</span> <span class="o">-</span><span class="nv">n</span> <span class="mi">65536</span>
<span class="ss">(</span><span class="mi">4</span><span class="ss">)</span> 惊群问题
指令：<span class="nv">accept_mutex</span>

如果 <span class="nv">accept_mutex</span> 指令值为 <span class="nv">on</span> 启用，那么将轮流唤醒一个工作进程接收处理新的连接，其余工作进程继续保持睡眠；
如果值为 <span class="nv">off</span> 关闭，那么将唤醒所有工作进程，由系统通过<span class="nv">use</span>指令指定的网络<span class="nv">IO</span>模型调度决定由哪个工作进程处理，
未接收到连接请求的工作进程继续保持睡眠，这就是所谓的“惊群问题”。<span class="nv">Web</span>服务器<span class="nv">Apache</span>的进程数很多，成百上千也是
时有的事，“惊群问题”也尤为明显。<span class="nv">Nginx</span>为了稳定，参数值保守的设置为 <span class="nv">on</span> 开启状态。可以将其设置成<span class="nv">Off</span> 提高性能
和吞吐量，但这样也会带来上下文切换增多或者负载升高等等其它资源更多消耗的后果。
<span class="ss">(</span><span class="mi">5</span><span class="ss">)</span>  网络<span class="nv">IO</span>模型
指令：<span class="nv">use</span>
定义了<span class="nv">Nginx</span>设置用于复用客户端线程的轮询方法<span class="ss">(</span>也可称多路复用网络<span class="nv">IO</span>模型<span class="ss">)</span>。这自然是选择效率更高的优先，<span class="nv">Linux</span> <span class="mi">2</span>.<span class="mi">6</span><span class="o">+</span>内
核推荐使用<span class="nv">epoll</span>，<span class="nv">FreeBSD</span>推荐使用<span class="nv">kqueue</span>，安装时<span class="nv">Nginx</span>会自动选择。
<span class="ss">(</span><span class="mi">6</span><span class="ss">)</span>  连接数
指令：<span class="nv">worker_connections</span>
定义了<span class="nv">Nginx</span>一个工作进程的最大同时连接数，不仅限于客户端连接，包括了和后端被代理服务器等其他的连接。官网文档还指出
了该参数值不能超过 <span class="nv">worker_rlimit_nofile</span> 值，所以建议设置成和 <span class="nv">worker_rlimit_nofile</span> 值相等。
<span class="ss">(</span><span class="mi">7</span><span class="ss">)</span>  打开文件缓存
指令：<span class="nv">open_file_cache</span>

开启关闭打开文件缓存，默认值 <span class="nv">off</span> 关闭，强烈建议开启，可以避免重新打开同一文件带来的系统开销，节省响应时间。如需开启必须
后接参数 <span class="nv">max</span><span class="o">=</span>数字，设置缓存元素的最大数量。当缓存溢出时，使用<span class="nv">LRU</span><span class="ss">(</span>最近最少使用<span class="ss">)</span>算法删除缓存中的元素；可选参数 <span class="nv">inactive</span><span class="o">=</span>
时间 设置超时，在这段时间内缓存元素如果没有被访问，将从缓存中删除。示例：<span class="nv">open_file_cache</span> <span class="nv">max</span><span class="o">=</span><span class="mi">65536</span>  <span class="nv">inactive</span><span class="o">=</span><span class="mi">60</span><span class="nv">s</span>。
指令：<span class="nv">open_file_cache_valid</span>
设置检查<span class="nv">open_file_cache</span>缓存的元素的时间间隔。
指令：<span class="nv">open_file_cache_min_uses</span>
设置在由<span class="nv">open_file_cache</span>指令的<span class="nv">inactive</span>参数配置的超时时间内， 文件应该被访问的最小次数。如果访问次数大于等于此值，文件描
述符会保留在缓存中，否则从缓存中删除。
<span class="ss">(</span><span class="mi">8</span><span class="ss">)</span>  日志相关
指令：<span class="nv">access_log</span> 和 <span class="nv">error_log</span>
当并发很大时，<span class="nv">Nginx</span>的访问日志和错误日志的保存肯定会造成对磁盘的大量读写，也将影响<span class="nv">Nginx</span>的性能。并发量越大，<span class="nv">IO</span>越高。这时候
可以考虑关闭访问日志和错误日志，或者将日志保存到<span class="nv">tmpfs</span>文件系统里，或者减少保存的访问日志条目和错误日志的级别，从而避免磁盘
<span class="nv">IO</span>的影响。关闭日志使用 <span class="nv">access_log</span> <span class="nv">off</span>。如必须保存日志，可以按每日或者每时或者其它时间段对日志做切割，这也可以减小<span class="nv">IO</span>，
虽然可能效果不是特别大，不过因为日志文件尺寸变小了很多，也方便查阅或归档分析日志。一般线上环境建议错误日志设置为 <span class="nv">error</span> 
或者 <span class="nv">crit</span>。自定义访问日志的条目和错误日志的级别，详细信息可以参阅官网或者网上其它文档，按需修改。
<span class="ss">(</span><span class="mi">9</span><span class="ss">)</span>  隐藏<span class="nv">Nginx</span>版本号
指令：<span class="nv">server_tokens</span>
开启或关闭“<span class="nv">Server</span>”响应头中输出的<span class="nv">Nginx</span>版本号。推介设置为 <span class="nv">off</span>，关闭显示响应头的版本号，对性能的提高有小小的裨益，主要还是
为了安全起见，不被骇客找到版本号对应的漏洞，从而被攻击。
<span class="ss">(</span><span class="mi">10</span><span class="ss">)</span> 压缩相关
指令：<span class="nv">gzip</span>
<span class="nv">Nginx</span>默认开启了<span class="nv">gzip</span>压缩功能。有可能很多人认为，开启<span class="nv">gzip</span>压缩会增加<span class="nv">CPU</span>的处理时间和负载。但是经过我们网站的测试发现，关闭了
<span class="nv">gzip</span>压缩功能的<span class="nv">Nginx</span>虽然减少了<span class="nv">CPU</span>计算，节省了服务器的响应时间，但网站页面总体响应时间反而加长了，原因在于<span class="nv">js</span>和<span class="nv">css</span>、<span class="nv">xml</span>、<span class="nv">j</span>

<span class="nv">son</span>、<span class="nv">html</span>等等这些静态文件的数据传输时间的增长大大超过了服务器节省出来的响应时间，得不偿失。<span class="nv">gzip</span> <span class="nv">on</span> 开启压缩后，大约可以减

少<span class="mi">75</span><span class="o">%</span>的文件尺寸，不但节省了比较多的带宽流量，也提高了页面的整体响应时间。所有建议还是开启。当然也不是所有的静态文件都需要压
缩，比如静态图片和<span class="nv">PDF</span>、视频，文件本身就应当做压缩处理后保存到服务器。这些文件再次使用<span class="nv">gzip</span>压缩，压缩的比例并不高，甚至适得其
反，压缩后文件尺寸增大了。<span class="nv">CPU</span>压缩处理这些静态文件增加占用的服务器响应时间绝大部分时候会超过了被压缩减小的文件尺寸减少的数据
传输时间，不划算。是否需要对<span class="nv">Web</span>网站开启压缩，以及对哪些文件过滤压缩，大家可以通过使用<span class="nv">HttpWatch</span>、<span class="nv">Firebug</span>等等网络分析工具对比测试。
指令：<span class="nv">gzip_comp_level</span>
指定压缩等级，其值从<span class="mi">1</span>到<span class="mi">9</span>，数字越大，压缩率越高，越消耗<span class="nv">CPU</span>，负载也越高。<span class="mi">9</span>等级无疑压缩率最高，压缩后的文件尺寸也最小，但也是
最耗<span class="nv">CPU</span>资源，负载最高，速度最慢的，这对于用户访问有时是无法忍受的。一般推荐使用<span class="mi">1</span><span class="o">-</span><span class="mi">4</span>等级，比较折衷的方案。我们公司网站使用等级<span class="mi">2</span>。
指令：<span class="nv">gzip_min_length</span>
指定压缩的文件最小尺寸，单位 <span class="nv">bytes</span> 字节，低于该值的不压缩，超过该值的将被压缩。我们网站设置为<span class="mi">1</span><span class="nv">k</span>，太小的文件没必要压缩，压缩
过小尺寸文件带来增加的<span class="nv">CPU</span>消耗时间和压缩减少的文件尺寸降低的数据下载时间互相抵消，并有可能增加总体的响应时间。
指令：<span class="nv">gzip_types</span>
指定允许压缩的文件类型，<span class="nv">Nginx</span>配置目录 <span class="nv">conf</span> 下的 <span class="nv">mime</span>.<span class="nv">types</span> 文件存放了<span class="nv">Nginx</span>支持的文件类型，<span class="nv">text</span><span class="o">/</span><span class="nv">html</span>类型文件，文件后缀为
<span class="nv">html</span> <span class="nv">htm</span> <span class="nv">shtml</span>默认压缩。推荐配置：<span class="nv">gzip_types</span> <span class="nv">text</span><span class="o">/</span><span class="nv">plain</span> <span class="nv">text</span><span class="o">/</span><span class="nv">css</span> <span class="nv">application</span><span class="o">/</span><span class="nv">json</span> <span class="nv">application</span><span class="o">/</span><span class="nv">x</span><span class="o">-</span><span class="nv">javascript</span> <span class="nv">text</span><span class="o">/</span><span class="nv">xml</span>
 <span class="nv">application</span><span class="o">/</span><span class="nv">xml</span> <span class="nv">application</span><span class="o">/</span><span class="nv">xml</span><span class="o">+</span><span class="nv">rss</span> <span class="nv">text</span><span class="o">/</span><span class="nv">javascript</span>。
<span class="ss">(</span><span class="mi">11</span><span class="ss">)</span> 浏览器缓存
指令：<span class="nv">expires</span>
设置<span class="nv">HTTP</span>应答中的“<span class="nv">Expires</span>”和“<span class="nv">Cache</span><span class="o">-</span><span class="nv">Control</span>”头标。<span class="s2">&quot;</span><span class="s">Expires</span><span class="s2">&quot;</span>一般结合<span class="s2">&quot;</span><span class="s">Last-Modified</span><span class="s2">&quot;</span>使用。当设置了合理的<span class="nv">expires</span>配置时，
浏览器第一次访问<span class="nv">Web</span>页面元素，会下载页面中的的静态文件到本机临时缓存目录下。第二次及之后再次访问相同<span class="nv">URL</span>时将发送带头标识
<span class="s2">&quot;</span><span class="s">If-Modified-Since</span><span class="s2">&quot;</span>和本地缓存文件时间属性值的请求给服务器，服务器比对服务器本地文件时间属性值，如果未修改，服务器直接
返回<span class="nv">http</span> <span class="mi">304</span>状态码，浏览器直接调用本地已缓存的文件；如果时间属性值修改了，重新发送新文件。这样就避免了从服务器再次传送
文件内容，减小了服务器压力，节省了带宽，同时也提高了用户访问速度，一举三得。指令后接数字加时间单位，即为缓存过期时间；<span class="o">-</span><span class="mi">1</span> 
表示永远过期，不缓存。强烈建议添加<span class="nv">expires</span>配置，过期时间的选择具体分析。我们公司的部分<span class="nv">Nginx</span>配置如下：


<span class="nv">location</span> <span class="o">~</span> .<span class="o">+</span>\.<span class="ss">(</span><span class="nv">gif</span><span class="o">|</span><span class="nv">jpg</span><span class="o">|</span><span class="nv">jpeg</span><span class="o">|</span><span class="nv">png</span><span class="o">|</span><span class="nv">bmp</span><span class="o">|</span><span class="nv">swf</span><span class="ss">)</span>$
{
    <span class="nv">expires</span> <span class="mi">30</span><span class="nv">d</span><span class="c1">;</span>
}

<span class="nv">location</span> <span class="o">~</span> .<span class="o">+</span>\.<span class="ss">(</span><span class="nv">js</span><span class="o">|</span><span class="nv">css</span><span class="o">|</span><span class="nv">xml</span><span class="o">|</span><span class="nv">javascript</span><span class="o">|</span><span class="nv">txt</span><span class="o">|</span><span class="nv">csv</span><span class="ss">)</span>$
{
    <span class="nv">expires</span> <span class="mi">30</span><span class="nv">d</span><span class="c1">;</span>
}
或者统一将静态文件放在固定目录下再对目录做<span class="nv">location</span>和<span class="nv">expires</span>，示例：

<span class="nv">location</span> <span class="o">/</span><span class="nv">static</span><span class="o">/</span>
{
    <span class="nv">expires</span> <span class="mi">30</span><span class="nv">d</span><span class="c1">;</span>
}
<span class="ss">(</span><span class="mi">12</span><span class="ss">)</span> 持久连接
指令：<span class="nv">keepalive_timeout</span>
启用<span class="nv">Http</span>的持久连接<span class="nv">Keepalive</span>属性，复用之前已建立的<span class="nv">TCP</span>连接接收请求、发送回应，减少重新建立<span class="nv">TCP</span>连接的资源时间开销。
在此的建议是当网站页面内容以静态为主时，开启持久连接；若主要是动态网页，且不能被转化为静态页面，则关闭持久连接。
后接数字和时间单位符号。正数为开启持久连接，<span class="mi">0</span>关闭。
<span class="ss">(</span><span class="mi">13</span><span class="ss">)</span> 减少<span class="nv">HTTP</span>请求次数
网站页面中存在大量的图片、脚本、样式表、<span class="nv">Flash</span>等静态元素，减少访问请求次数最大的优点就是减少用户首次访问页面的加载
时间。可以采用合并相同类型文件为一个文件的办法减少请求次数。这其实属于<span class="nv">Web</span>前端优化范畴，应当由<span class="nv">Web</span>前段工程师做好相
关静态文件的规划管理，而不是由运维来做。不过<span class="nv">Nginx</span>也可以通过安装阿里巴巴提供的<span class="nv">Concat</span>或者<span class="nv">Google</span>的<span class="nv">PageSpeed</span>模块实
现这个合并文件的功能。我们公司并未使用合并功能，具体安装配置信息请查询网上相关文档，这里不再累述。<span class="nv">Concat</span>源代码网
址：<span class="nv">https</span>:<span class="o">//</span><span class="nv">github</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">alibaba</span><span class="o">/</span><span class="nv">nginx</span><span class="o">-</span><span class="nv">http</span><span class="o">-</span><span class="nv">concat</span><span class="o">/</span>，<span class="nv">PageSpeed</span>源代码网址：<span class="nv">https</span>:<span class="o">//</span><span class="nv">github</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">pagespeed</span><span class="o">/</span><span class="nv">ngx_pagespeed</span>。
<span class="ss">(</span><span class="mi">14</span><span class="ss">)</span> <span class="nv">PHP</span>相关
<span class="nv">Nginx</span>不能直接解析<span class="nv">PHP</span>代码文件，需要调用<span class="nv">FastCGI</span>接口转给<span class="nv">PHP</span>解释器执行，然后将结果返回给<span class="nv">Nginx</span>。<span class="nv">PHP</span>优化本文暂不介绍。
<span class="nv">Nginx</span>可以开启<span class="nv">FastCGI</span>的缓存功能，从而提高性能。
指令：<span class="nv">fastcgi_temp_path</span>
定义<span class="nv">FastCGI</span>缓存文件保存临时路径。
指令：<span class="nv">fastcgi_cache_path</span>
定义<span class="nv">FastCGI</span>缓存文件保存路径和缓存的其它参数。缓存数据以二进制数据文件形式存储，缓存文件名和<span class="nv">key</span>都是通过对访问<span class="nv">URL</span>使用
<span class="nv">MD5</span>计算获得的结果。缓存文件先保存至<span class="nv">fastcgi_temp_path</span>指定的临时目录下，然后通过重命名操作移至<span class="nv">fastcgi_cache_path</span>指
定的缓存目录。<span class="nv">levels</span>指定了目录结构,子目录数以<span class="mi">16</span>为基数；<span class="nv">keys_zone</span>指定了共享内存区名和大小，用于保存缓存<span class="nv">key</span>和数据信息；
<span class="nv">inactive</span>指定了缓存数据保存的时间，当这段时间内未被访问，将被移出；<span class="nv">max_size</span>指定了缓存使用的最大磁盘空间，超过容量时将
最近最少使用数据删除。建议<span class="nv">fastcgi_temp_path</span>和<span class="nv">fastcgi_cache_path</span>设为同一分区，同分区移动操作效率更高。示例：


<span class="nv">fastcgi_temp_path</span> <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">fastcgi_temp</span><span class="c1">;</span>
<span class="nv">fastcgi_cache_path</span> <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">fastcgi_cache</span> <span class="nv">levels</span><span class="o">=</span><span class="mi">1</span>:<span class="mi">2</span> <span class="nv">keys_zone</span><span class="o">=</span><span class="nv">cache_fastcgi</span>:<span class="mi">16</span><span class="nv">m</span> <span class="nv">inactive</span><span class="o">=</span><span class="mi">30</span><span class="nv">m</span> <span class="nv">max_size</span><span class="o">=</span><span class="mi">1</span><span class="nv">g</span><span class="c1">;</span>
示例中使用<span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">fastcgi_temp</span>作为<span class="nv">FastCGI</span>缓存的临时目录；<span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">fastcgi_cache</span>作为<span class="nv">FastCGI</span>缓存保存的最终目录；一级子目录为
<span class="mi">16</span>的一次方<span class="mi">16</span>个，二级子目录为<span class="mi">16</span>的<span class="mi">2</span>次方<span class="mi">256</span>个；共享内存区名为<span class="nv">cache_fastcgi</span>，占用内存<span class="mi">128</span><span class="nv">MB</span>；缓存过期时间为<span class="mi">30</span>分钟；缓存数据
保存于磁盘的最大空间大小为<span class="mi">1</span><span class="nv">GB</span>。
指令：<span class="nv">fastcgi_cache_key</span>
定义<span class="nv">FastCGI</span>缓存关键字。启用<span class="nv">FastCGI</span>缓存必须加上这个配置，不然访问所有<span class="nv">PHP</span>的请求都为访问第一个<span class="nv">PHP</span>文件<span class="nv">URL</span>的结果。
 指令：<span class="nv">fastcgi_cache_valid</span>
为指定的<span class="nv">Http</span>状态码指定缓存时间。
指令：<span class="nv">fastcgi_cache_min_uses</span>
指定经过多少次请求相同的<span class="nv">URL</span>将被缓存。
指令：<span class="nv">fastcgi_cache_use_stale</span>
指定当连接<span class="nv">FastCGI</span>服务器发生错误时，哪些情况使用过期数据回应。
指令：<span class="nv">fastcgi_cache</span>
缓存使用哪个共享内存区。
我常用<span class="nv">nginx</span>.<span class="nv">conf</span>模板，大家根据情况做适当修改：


<span class="nv">user</span>  <span class="nv">nginx</span> <span class="nv">nginx</span><span class="c1">;</span>
<span class="nv">worker_processes</span>  <span class="nv">auto</span><span class="c1">;</span>

<span class="nv">error_log</span>  <span class="nv">logs</span><span class="o">/</span><span class="nv">error</span>.<span class="nv">log</span> <span class="nv">error</span><span class="c1">;</span>

<span class="nv">pid</span>        <span class="nv">logs</span><span class="o">/</span><span class="nv">nginx</span>.<span class="nv">pid</span><span class="c1">;</span>
<span class="nv">worker_rlimit_nofile</span>    <span class="mi">65536</span><span class="c1">;</span>

<span class="nv">events</span>
{
    <span class="nv">use</span> <span class="nv">epoll</span><span class="c1">;</span>
    <span class="nv">accept_mutex</span> <span class="nv">off</span><span class="c1">;</span>
    <span class="nv">worker_connections</span>  <span class="mi">65536</span><span class="c1">;</span>
}


<span class="nv">http</span>
{
    <span class="k">include</span>       <span class="nv">mime</span>.<span class="nv">types</span><span class="c1">;</span>
    <span class="nv">default_type</span>  <span class="nv">text</span><span class="o">/</span><span class="nv">html</span><span class="c1">;</span>

    <span class="nv">charset</span> <span class="nv">UTF</span><span class="o">-</span><span class="mi">8</span><span class="c1">;</span>
    <span class="nv">server_names_hash_bucket_size</span> <span class="mi">128</span><span class="c1">;</span>
    <span class="nv">client_header_buffer_size</span> <span class="mi">4</span><span class="nv">k</span><span class="c1">;</span>
    <span class="nv">large_client_header_buffers</span> <span class="mi">4</span> <span class="mi">32</span><span class="nv">k</span><span class="c1">;</span>
    <span class="nv">client_max_body_size</span>            <span class="mi">8</span><span class="nv">m</span><span class="c1">;</span>

    <span class="nv">open_file_cache</span> <span class="nv">max</span><span class="o">=</span><span class="mi">65536</span>  <span class="nv">inactive</span><span class="o">=</span><span class="mi">60</span><span class="nv">s</span><span class="c1">;</span>
    <span class="nv">open_file_cache_valid</span>      <span class="mi">80</span><span class="nv">s</span><span class="c1">;</span>
    <span class="nv">open_file_cache_min_uses</span>   <span class="mi">1</span><span class="c1">;</span>

    <span class="nv">log_format</span>  <span class="nv">main</span>  <span class="s1">&#39;</span><span class="s">$remote_addr - $remote_user [$time_local] &quot;$request&quot; </span><span class="s1">&#39;</span>
                      <span class="s1">&#39;</span><span class="s">$status $body_bytes_sent &quot;$http_referer&quot; </span><span class="s1">&#39;</span>
                      <span class="s1">&#39;</span><span class="s">&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;</span><span class="s1">&#39;</span><span class="c1">;</span>

    <span class="nv">access_log</span>  <span class="nv">logs</span><span class="o">/</span><span class="nv">access</span>.<span class="nv">log</span>  <span class="nv">main</span><span class="c1">;</span>

    <span class="k">sendfile</span>    <span class="nv">on</span><span class="c1">;</span>
    <span class="nv">server_tokens</span> <span class="nv">off</span><span class="c1">;</span>

    <span class="nv">fastcgi_temp_path</span>  <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">fastcgi_temp</span><span class="c1">;</span>
    <span class="nv">fastcgi_cache_path</span> <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">fastcgi_cache</span> <span class="nv">levels</span><span class="o">=</span><span class="mi">1</span>:<span class="mi">2</span> <span class="nv">keys_zone</span><span class="o">=</span><span class="nv">cache_fastcgi</span>:<span class="mi">128</span><span class="nv">m</span> <span class="nv">inactive</span><span class="o">=</span><span class="mi">30</span><span class="nv">m</span> <span class="nv">max_size</span><span class="o">=</span><span class="mi">1</span><span class="nv">g</span><span class="c1">;</span>
    <span class="nv">fastcgi_cache_key</span> $<span class="nv">request_method</span>:<span class="o">//</span>$<span class="nv">host</span>$<span class="nv">request_uri</span><span class="c1">;</span>
    <span class="nv">fastcgi_cache_valid</span> <span class="mi">200</span> <span class="mi">302</span> <span class="mi">1</span><span class="nv">h</span><span class="c1">;</span>
    <span class="nv">fastcgi_cache_valid</span> <span class="mi">301</span>     <span class="mi">1</span><span class="nv">d</span><span class="c1">;</span>
    <span class="nv">fastcgi_cache_valid</span> <span class="nv">any</span>     <span class="mi">1</span><span class="nv">m</span><span class="c1">;</span>
    <span class="nv">fastcgi_cache_min_uses</span> <span class="mi">1</span><span class="c1">;</span>
    <span class="nv">fastcgi_cache_use_stale</span> <span class="nv">error</span> <span class="nb">timeout</span> <span class="nv">http_500</span> <span class="nv">http_503</span> <span class="nv">invalid_header</span><span class="c1">;</span>

    <span class="nv">keepalive_timeout</span>  <span class="mi">60</span><span class="c1">;</span>

    <span class="nv">gzip</span>  <span class="nv">on</span><span class="c1">;</span>
    <span class="nv">gzip_min_length</span> <span class="mi">1</span><span class="nv">k</span><span class="c1">;</span>
    <span class="nv">gzip_buffers</span>  <span class="mi">4</span> <span class="mi">64</span><span class="nv">k</span><span class="c1">;</span>
    <span class="nv">gzip_http_version</span> <span class="mi">1</span>.<span class="mi">1</span><span class="c1">;</span>
    <span class="nv">gzip_comp_level</span> <span class="mi">2</span><span class="c1">;</span>
    <span class="nv">gzip_types</span> <span class="nv">text</span><span class="o">/</span><span class="nv">plain</span> <span class="nv">text</span><span class="o">/</span><span class="nv">css</span> <span class="nv">application</span><span class="o">/</span><span class="nv">json</span> <span class="nv">application</span><span class="o">/</span><span class="nv">x</span><span class="o">-</span><span class="nv">javascript</span> <span class="nv">text</span><span class="o">/</span><span class="nv">xml</span> <span class="nv">application</span><span class="o">/</span><span class="nv">xml</span> <span class="nv">application</span><span class="o">/</span>
    <span class="nv">xml</span><span class="o">+</span><span class="nv">rss</span> <span class="nv">text</span><span class="o">/</span><span class="nv">javascript</span><span class="c1">;</span>

    <span class="nv">server</span>
    {
        <span class="nv">listen</span>       <span class="mi">80</span><span class="c1">;</span>
        <span class="nv">server_name</span>  <span class="nv">localhost</span><span class="c1">;</span>
        <span class="nv">index</span>        <span class="nv">index</span>.<span class="nv">html</span><span class="c1">;</span>
        <span class="nv">root</span>         <span class="o">/</span><span class="nv">App</span><span class="o">/</span><span class="nv">web</span><span class="c1">;</span>

        <span class="nv">location</span> <span class="o">~</span> .<span class="o">+</span>\.<span class="ss">(</span><span class="nv">php</span><span class="o">|</span><span class="nv">php5</span><span class="ss">)</span>$
        {
            <span class="nv">fastcgi_pass</span>   <span class="nv">unix</span>:<span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">php</span>.<span class="nv">sock</span><span class="c1">;</span>
            <span class="nv">fastcgi_index</span>  <span class="nv">index</span>.<span class="nv">php</span><span class="c1">;</span>
            <span class="k">include</span>        <span class="nv">fastcgi</span>.<span class="nv">conf</span><span class="c1">;</span>
            <span class="nv">fastcgi_cache</span>  <span class="nv">cache_fastcgi</span><span class="c1">;</span>
        }

        <span class="nv">location</span> <span class="o">~</span> .<span class="o">+</span>\.<span class="ss">(</span><span class="nv">gif</span><span class="o">|</span><span class="nv">jpg</span><span class="o">|</span><span class="nv">jpeg</span><span class="o">|</span><span class="nv">png</span><span class="o">|</span><span class="nv">bmp</span><span class="o">|</span><span class="nv">swf</span><span class="o">|</span><span class="nv">txt</span><span class="o">|</span><span class="nv">csv</span><span class="o">|</span><span class="nv">doc</span><span class="o">|</span><span class="nv">docx</span><span class="o">|</span><span class="nv">xls</span><span class="o">|</span><span class="nv">xlsx</span><span class="o">|</span><span class="nv">ppt</span><span class="o">|</span><span class="nv">pptx</span><span class="o">|</span><span class="nv">flv</span><span class="ss">)</span>$
        {
            <span class="nv">expires</span> <span class="mi">30</span><span class="nv">d</span><span class="c1">;</span>
        }

        <span class="nv">location</span> <span class="o">~</span> .<span class="o">+</span>\.<span class="ss">(</span><span class="nv">js</span><span class="o">|</span><span class="nv">css</span><span class="o">|</span><span class="nv">html</span><span class="o">|</span><span class="nv">xml</span><span class="ss">)</span>$
        {
            <span class="nv">expires</span> <span class="mi">30</span><span class="nv">d</span><span class="c1">;</span>
        }

        <span class="nv">location</span> <span class="o">/</span><span class="nv">nginx</span><span class="o">-</span><span class="nv">status</span>
        {
            <span class="nv">stub_status</span> <span class="nv">on</span><span class="c1">;</span>
            <span class="nv">allow</span> <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">1</span>.<span class="mi">0</span><span class="o">/</span><span class="mi">24</span><span class="c1">;</span>
            <span class="nv">allow</span> <span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span><span class="c1">;</span>
            <span class="nv">deny</span> <span class="nv">all</span><span class="c1">;</span>
        }
    }
}
三.        内核
<span class="nv">Linux</span>内核参数部分默认值不适合高并发，一般临时方法可以通过调整<span class="o">/</span><span class="nv">Proc</span>文件系统，或者直接修改<span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">sysctl</span>.<span class="nv">conf</span>配置文件永久保存。
调整<span class="o">/</span><span class="nv">Proc</span>文件系统，系统重启后还原至默认值，所以不推荐。<span class="nv">Linux</span>内核调优，主要涉及到网络和文件系统、内存等的优化，下面是我常用
的内核调优配置：


<span class="nv">grep</span> <span class="o">-</span><span class="nv">q</span> <span class="s2">&quot;</span><span class="s">net.ipv4.tcp_max_tw_buckets</span><span class="s2">&quot;</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">sysctl</span>.<span class="nv">conf</span> <span class="o">||</span> <span class="nv">cat</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">sysctl</span>.<span class="nv">conf</span> <span class="o">&lt;&lt;</span> <span class="nv">EOF</span>
########################################
<span class="nv">net</span>.<span class="nv">core</span>.<span class="nv">rmem_default</span> <span class="o">=</span> <span class="mi">262144</span>
<span class="nv">net</span>.<span class="nv">core</span>.<span class="nv">rmem_max</span> <span class="o">=</span> <span class="mi">16777216</span>
<span class="nv">net</span>.<span class="nv">core</span>.<span class="nv">wmem_default</span> <span class="o">=</span> <span class="mi">262144</span>
<span class="nv">net</span>.<span class="nv">core</span>.<span class="nv">wmem_max</span> <span class="o">=</span> <span class="mi">16777216</span>
<span class="nv">net</span>.<span class="nv">core</span>.<span class="nv">somaxconn</span> <span class="o">=</span> <span class="mi">262144</span>
<span class="nv">net</span>.<span class="nv">core</span>.<span class="nv">netdev_max_backlog</span> <span class="o">=</span> <span class="mi">262144</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">tcp_max_orphans</span> <span class="o">=</span> <span class="mi">262144</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">tcp_max_syn_backlog</span> <span class="o">=</span> <span class="mi">262144</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">tcp_max_tw_buckets</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">ip_local_port_range</span> <span class="o">=</span> <span class="mi">1024</span> <span class="mi">65500</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">tcp_tw_recycle</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">tcp_tw_reuse</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">tcp_syncookies</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">tcp_synack_retries</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">tcp_syn_retries</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">tcp_fin_timeout</span> <span class="o">=</span> <span class="mi">30</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">tcp_keepalive_time</span> <span class="o">=</span> <span class="mi">600</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">tcp_keepalive_intvl</span> <span class="o">=</span> <span class="mi">30</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">tcp_keepalive_probes</span> <span class="o">=</span> <span class="mi">3</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">tcp_mem</span> <span class="o">=</span> <span class="mi">786432</span> <span class="mi">1048576</span> <span class="mi">1572864</span>
<span class="nv">fs</span>.<span class="nv">aio</span><span class="o">-</span><span class="nv">max</span><span class="o">-</span><span class="nv">nr</span> <span class="o">=</span> <span class="mi">1048576</span>
<span class="nv">fs</span>.<span class="nv">file</span><span class="o">-</span><span class="nv">max</span> <span class="o">=</span> <span class="mi">6815744</span>
<span class="nv">kernel</span>.<span class="nv">sem</span> <span class="o">=</span> <span class="mi">250</span> <span class="mi">32000</span> <span class="mi">100</span> <span class="mi">128</span>
<span class="nv">vm</span>.<span class="nv">swappiness</span> <span class="o">=</span> <span class="mi">10</span>
<span class="nv">EOF</span>
<span class="nv">sysctl</span> <span class="o">-</span><span class="nv">p</span>
详细说明大家可以查看我的<span class="nv">Linux</span>内核优化文章：<span class="nv">http</span>:<span class="o">//</span><span class="nv">dongsong</span>.<span class="nv">blog</span>.<span class="mi">51</span><span class="nv">cto</span>.<span class="nv">com</span><span class="o">/</span><span class="mi">916653</span><span class="o">/</span><span class="mi">1631085</span>。
四.        架构
<span class="nv">Nginx</span>的最大优势在于处理静态文件和代理转发功能，支持<span class="mi">7</span>层负载均衡和故障隔离。 动静分离是每个网站发展到一定规模之后必然的结果。
静态请求则应当最好将其拆分，并启用独立的域名，既便于管理的需要，也便于今后能够快速支持<span class="nv">CDN</span>。如果一台<span class="nv">Nginx</span>性能无法满足，
则可以考虑在<span class="nv">Nginx</span>前端添加<span class="nv">LVS</span>负载均衡，或者<span class="nv">F5</span>等硬件负载均衡（费用昂贵，适合土豪公司单位），由多台<span class="nv">Nginx</span>共同分担网站请求。
还可以考虑结合<span class="nv">Varnish</span>或者<span class="nv">Squid</span>缓存静态文件实现类似<span class="nv">CDN</span>功能。新版<span class="nv">Nginx</span>目前已经支持直接读写<span class="nv">Memcache</span>，可以编译安装时候选择
添加此类模块，从而节省了转交给<span class="nv">PHP</span>或者<span class="nv">JPS</span>等动态程序服务器处理时间，提高效率的同时，减小了动态服务器的负载。

来源： <span class="nv">http</span>:<span class="o">//</span><span class="nv">www</span>.<span class="nv">ttlsa</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">nginx</span><span class="o">/</span><span class="nv">web</span><span class="o">-</span><span class="nv">server</span><span class="o">-</span><span class="nv">nginx</span><span class="o">-</span><span class="nv">optimization</span><span class="o">/</span>
</pre></div>


<h2 id="keepalived">keepalived</h2>
<div class="codehilite"><pre><span></span><span class="nv">Keepalived</span>介绍
<span class="nv">keepalived</span>是一个类似于<span class="nv">layer3</span>, <span class="mi">4</span>, <span class="mi">5</span> 交换机制的软件，也就是我们平时说的第<span class="mi">3</span>层、第<span class="mi">4</span>层和第<span class="mi">5</span>层交换。<span class="nv">Keepalived</span>的作用是
检测<span class="nv">web</span>服务器的状态，如果有一台<span class="nv">web</span>服务器死机，或工作出现故障，<span class="nv">Keepalived</span>将检测到，并将有故障的<span class="nv">web</span>服务器从系统中剔除，
当<span class="nv">web</span>服务器工作正常后<span class="nv">Keepalived</span>自动将<span class="nv">web</span>服务器加入到服务器群中，这些工作全部自动完成，不需要人工干涉，需要人工做的只是
修复故障的<span class="nv">web</span>服务器
官网地址：<span class="nv">http</span>:<span class="o">//</span><span class="nv">www</span>.<span class="nv">keepalived</span>.<span class="nv">org</span>
<span class="nv">keepalved</span>官方体系结构图：

环境准备
操作系统：<span class="nv">CentOS6</span>.<span class="mi">6</span> <span class="mi">64</span>位 <span class="mi">2</span>台
<span class="nv">Nginx</span><span class="o">-</span><span class="nv">Master</span>   <span class="mi">10</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">60</span>
<span class="nv">Nginx</span><span class="o">-</span><span class="nv">Backup</span>   <span class="mi">10</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">61</span>
<span class="nv">VIP</span>                      <span class="mi">10</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">62</span>
注：未做特别说明，两台服务器<span class="ss">(</span>两个节点<span class="ss">)</span>都一样操作
安装<span class="nv">Nginx</span>
使用《<span class="nv">OneinStack</span>》<span class="nv">Nginx</span>选择<span class="nv">y</span>，其余<span class="nv">n</span>
安装<span class="nv">Keepalived</span>
在<span class="nv">Nginx</span><span class="o">-</span><span class="nv">Master</span>、<span class="nv">Nginx</span><span class="o">-</span><span class="nv">Backup</span>：
<span class="nv">cd</span> <span class="o">~/</span><span class="nv">oneinstack</span><span class="o">/</span><span class="nv">src</span>
<span class="nv">wget</span> <span class="nv">http</span>:<span class="o">//</span><span class="nv">www</span>.<span class="nv">keepalived</span>.<span class="nv">org</span><span class="o">/</span><span class="nv">software</span><span class="o">/</span><span class="nv">keepalived</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">2</span>.<span class="mi">22</span>.<span class="nv">tar</span>.<span class="nv">gz</span>
<span class="nv">tar</span> <span class="nv">xzf</span> <span class="nv">keepalived</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">2</span>.<span class="mi">22</span>.<span class="nv">tar</span>.<span class="nv">gz</span>
<span class="nv">cd</span> <span class="nv">keepalived</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">2</span>.<span class="mi">22</span>
.<span class="o">/</span><span class="nv">configure</span> <span class="o">--</span><span class="nv">prefix</span><span class="o">=/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">keepalived</span>
<span class="nv">make</span> <span class="o">&amp;&amp;</span> <span class="nv">make</span> <span class="nv">install</span>
配置<span class="nv">Keepalived</span>
在<span class="nv">Nginx</span><span class="o">-</span><span class="nv">Master</span>、<span class="nv">Nginx</span><span class="o">-</span><span class="nv">Backup</span>：
<span class="nv">ln</span> <span class="o">-</span><span class="nv">s</span> <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">keepalived</span><span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">keepalived</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">keepalived</span>
<span class="nv">ln</span> <span class="o">-</span><span class="nv">s</span> <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">keepalived</span><span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">rc</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">init</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">keepalived</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">rc</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">init</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">keepalived</span>
<span class="nv">ln</span> <span class="o">-</span><span class="nv">s</span> <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">keepalived</span><span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">sysconfig</span><span class="o">/</span><span class="nv">keepalived</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">sysconfig</span><span class="o">/</span><span class="nv">keepalived</span>
<span class="nv">ln</span> <span class="o">-</span><span class="nv">s</span> <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">keepalived</span><span class="o">/</span><span class="nv">sbin</span><span class="o">/</span><span class="nv">keepalived</span> <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">keepalived</span>
<span class="nv">chkconfig</span> <span class="nv">keepalived</span> <span class="nv">on</span>
在<span class="nv">Nginx</span><span class="o">-</span><span class="nv">Master</span>修改配置文件，<span class="nv">vi</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">keepalived</span><span class="o">/</span><span class="nv">keepalived</span>.<span class="nv">conf</span>
<span class="o">!</span> <span class="nv">Configuration</span> <span class="nv">File</span> <span class="k">for</span> <span class="nv">keepalived</span>

<span class="nv">global_defs</span> {
   <span class="nv">notification_email</span> {
       <span class="nv">admin</span>@<span class="nv">linuxeye</span>.<span class="nv">com</span>     #设置报警邮件地址，可以设置多个，每行一个。 需开启本机的<span class="nv">sendmail</span>服务
   }
   <span class="nv">notification_email_from</span> <span class="nv">no</span><span class="o">-</span><span class="nv">reply</span>@<span class="nv">linuxeye</span>.<span class="nv">com</span>  #设置邮件的发送地址
   <span class="nv">smtp_server</span> <span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span>            #设置<span class="nv">smtp</span> <span class="nv">server</span>地址
   <span class="nv">smtp_connect_timeout</span> <span class="mi">30</span>    #设置连接<span class="nv">smtp</span> <span class="nv">server</span>的超时时间
   <span class="nv">router_id</span> <span class="nv">LVS_DEVEL</span>              #表示运行<span class="nv">keepalived</span>服务器的一个标识。发邮件时显示在邮件主题的信息
}

<span class="nv">vrrp_script</span> <span class="nv">chk_nginx</span> {
    <span class="nv">script</span> <span class="s2">&quot;</span><span class="s">/usr/local/keepalived/sbin/check_nginx.sh</span><span class="s2">&quot;</span>   #该脚本检测<span class="nv">ngnix</span>的运行状态，并在<span class="nv">nginx</span>进程不存在时尝试
    重新启动<span class="nv">ngnix</span>，如果启动失败则停止<span class="nv">keepalived</span>，准备让其它机器接管。
    <span class="nv">interval</span> <span class="mi">2</span>              #每<span class="mi">2</span><span class="nv">s</span>检测一次，设置的时间要大于<span class="nv">check_nginx</span>.<span class="nv">sh</span> 的运行时间，否则会一直运行而无法生效
    <span class="nv">weight</span> <span class="mi">2</span>               #检测失败（脚本返回非<span class="mi">0</span>）则优先级<span class="mi">2</span>
}

<span class="nv">vrrp_instance</span> <span class="nv">VI_1</span> {
    <span class="nv">state</span> <span class="nv">MASTER</span>              #指定<span class="nv">keepalived</span>的角色，<span class="nv">MASTER</span>表示此主机是主服务器，<span class="nv">BACKUP</span>表示此主机是备用服务器
    <span class="nv">interface</span> <span class="nv">eth0</span>              #指定<span class="nv">HA</span>监测网络的接口
    <span class="nv">virtual_router_id</span> <span class="mi">55</span>    #虚拟路由标识，这个标识是一个数字，同一个<span class="nv">vrrp</span>实例使用唯一的标识。即同一<span class="nv">vrrp_instance</span>下
    ，<span class="nv">MASTER</span>和<span class="nv">BACKUP</span>必须是一致的

    <span class="nv">priority</span> <span class="mi">100</span>                  #定义优先级，数字越大，优先级越高，在同一个<span class="nv">vrrp_instance</span>下，<span class="nv">MASTER</span>的优先级必须大
    于<span class="nv">BACKUP</span>的优先级
    <span class="nv">advert_int</span> <span class="mi">1</span>            #设定<span class="nv">MASTER</span>与<span class="nv">BACKUP</span>负载均衡器之间同步检查的时间间隔，单位是秒
    <span class="nv">authentication</span> {        #设置验证类型和密码
        <span class="nv">auth_type</span> <span class="nv">PASS</span>      #设置验证类型，主要有<span class="nv">PASS</span>和<span class="nv">AH</span>两种
        <span class="nv">auth_pass</span> <span class="nv">linuxeye</span>  #设置验证密码，在同一个<span class="nv">vrrp_instance</span>下，<span class="nv">MASTER</span>与<span class="nv">BACKUP</span>必须使用相同的密码才能正常通信
    }
    <span class="nv">virtual_ipaddress</span> {     #设置虚拟<span class="nv">IP</span>地址，可以设置多个虚拟<span class="nv">IP</span>地址，每行一个
        <span class="mi">10</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">62</span>
    }
    <span class="nv">track_script</span> {
        <span class="nv">chk_nginx</span>           #引用<span class="nv">VRRP</span>脚本，即在 <span class="nv">vrrp_script</span> 部分指定的名字。定期运行它们来改变优先级，并最终引发主备切换。
    }
}
在<span class="nv">Nginx</span><span class="o">-</span><span class="nv">Backup</span>修改配置文件，<span class="nv">vi</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">keepalived</span><span class="o">/</span><span class="nv">keepalived</span>.<span class="nv">conf</span>
<span class="o">!</span> <span class="nv">Configuration</span> <span class="nv">File</span> <span class="k">for</span> <span class="nv">keepalived</span>

<span class="nv">global_defs</span> {
   <span class="nv">notification_email</span> {
       <span class="nv">admin</span>@<span class="nv">linuxeye</span>.<span class="nv">com</span>     #设置报警邮件地址，可以设置多个，每行一个。 需开启本机的<span class="nv">sendmail</span>服务
   }
   <span class="nv">notification_email_from</span> <span class="nv">no</span><span class="o">-</span><span class="nv">reply</span>@<span class="nv">linuxeye</span>.<span class="nv">com</span>  #设置邮件的发送地址
   <span class="nv">smtp_server</span> <span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span>      #设置<span class="nv">smtp</span> <span class="nv">server</span>地址
   <span class="nv">smtp_connect_timeout</span> <span class="mi">30</span>    #设置连接<span class="nv">smtp</span> <span class="nv">server</span>的超时时间
   <span class="nv">router_id</span> <span class="nv">LVS_DEVEL</span>        #表示运行<span class="nv">keepalived</span>服务器的一个标识。发邮件时显示在邮件主题的信息
}

<span class="nv">vrrp_script</span> <span class="nv">chk_nginx</span> {
    <span class="nv">script</span> <span class="s2">&quot;</span><span class="s">/usr/local/keepalived/sbin/check_nginx.sh</span><span class="s2">&quot;</span>   #该脚本检测<span class="nv">ngnix</span>的运行状态，并在<span class="nv">nginx</span>进程不存在时尝试重新
    启动<span class="nv">ngnix</span>，如果启动失败则停止<span class="nv">keepalived</span>，准备让其它机器接管。
    <span class="nv">interval</span> <span class="mi">2</span>              #每<span class="mi">2</span><span class="nv">s</span>检测一次
    <span class="nv">weight</span> <span class="mi">2</span>                #检测失败（脚本返回非<span class="mi">0</span>）则优先级<span class="mi">2</span>
}

<span class="nv">vrrp_instance</span> <span class="nv">VI_1</span> {
    <span class="nv">state</span> <span class="nv">BACKUP</span>            #指定<span class="nv">keepalived</span>的角色，<span class="nv">MASTER</span>表示此主机是主服务器，<span class="nv">BACKUP</span>表示此主机是备用服务器
    <span class="nv">interface</span> <span class="nv">eth0</span>          #指定<span class="nv">HA</span>监测网络的接口
    <span class="nv">virtual_router_id</span> <span class="mi">55</span>    #虚拟路由标识，这个标识是一个数字，同一个<span class="nv">vrrp</span>实例使用唯一的标识。即同一<span class="nv">vrrp_instance</span>下，
    <span class="nv">MASTER</span>和<span class="nv">BACKUP</span>必须是一致的
    <span class="nv">priority</span> <span class="mi">50</span>             #定义优先级，数字越大，优先级越高，在同一个<span class="nv">vrrp_instance</span>下，<span class="nv">MASTER</span>的优先级必须大于<span class="nv">BACKUP</span>的优先级
    <span class="nv">advert_int</span> <span class="mi">1</span>            #设定<span class="nv">MASTER</span>与<span class="nv">BACKUP</span>负载均衡器之间同步检查的时间间隔，单位是秒
    <span class="nv">nopreempt</span>               #设置<span class="nv">nopreempt</span>防止抢占资源，只生效<span class="nv">BACKUP</span>节点
    <span class="nv">authentication</span> {        #设置验证类型和密码
        <span class="nv">auth_type</span> <span class="nv">PASS</span>      #设置验证类型，主要有<span class="nv">PASS</span>和<span class="nv">AH</span>两种
        <span class="nv">auth_pass</span> <span class="nv">linuxeye</span>  #设置验证密码，在同一个<span class="nv">vrrp_instance</span>下，<span class="nv">MASTER</span>与<span class="nv">BACKUP</span>必须使用相同的密码才能正常通信
    }
    <span class="nv">virtual_ipaddress</span> {     #设置虚拟<span class="nv">IP</span>地址，可以设置多个虚拟<span class="nv">IP</span>地址，每行一个
        <span class="mi">10</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">62</span>
    }
    <span class="nv">track_script</span> {
        <span class="nv">chk_nginx</span>           #引用<span class="nv">VRRP</span>脚本，即在 <span class="nv">vrrp_script</span> 部分指定的名字。定期运行它们来改变优先级，并最终引发主备切换。
    }
}
检测脚本，<span class="nv">vi</span> <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">keepalived</span><span class="o">/</span><span class="nv">sbin</span><span class="o">/</span><span class="nv">check_nginx</span>.<span class="nv">sh</span>
#<span class="o">!/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">bash</span>
<span class="k">if</span> [ <span class="s2">&quot;</span><span class="s">$(ps -ef | grep </span><span class="s2">&quot;</span><span class="nv">nginx</span>: <span class="nv">master</span> <span class="nv">process</span><span class="s2">&quot;</span><span class="s">| grep -v grep )</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> ]<span class="c1">;then</span>
    #<span class="nv">echo</span> <span class="mi">1</span>
    <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">init</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">nginx</span> <span class="nv">start</span>
    <span class="nv">sleep</span> <span class="mi">5</span>

    <span class="k">if</span> [ <span class="s2">&quot;</span><span class="s">$(ps -ef | grep </span><span class="s2">&quot;</span><span class="nv">nginx</span>: <span class="nv">master</span> <span class="nv">process</span><span class="s2">&quot;</span><span class="s">| grep -v grep )</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> ]<span class="c1">;then</span>
        <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">init</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">keepalived</span> <span class="nv">stop</span>
        #<span class="nv">echo</span> <span class="mi">2</span>
    <span class="nv">fi</span>
<span class="nv">fi</span>
脚本加上可执行权限
<span class="nv">chmod</span> <span class="o">+</span><span class="nv">x</span> <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">keepalived</span><span class="o">/</span><span class="nv">sbin</span><span class="o">/</span><span class="nv">check_nginx</span>.<span class="nv">sh</span>
验证
<span class="nv">service</span> <span class="nv">keepalived</span> <span class="nv">start</span>  #启动<span class="nv">Nginx</span><span class="o">-</span><span class="nv">Master</span>
<span class="nv">service</span> <span class="nv">keepalived</span> <span class="nv">start</span>  #启动<span class="nv">Nginx</span><span class="o">-</span><span class="nv">Backup</span>
<span class="nv">ip</span> <span class="nv">addr</span>  <span class="sc">#2</span>台服务器分别执行，绑定虚拟<span class="nv">IP</span>在<span class="nv">Nginx</span><span class="o">-</span><span class="nv">Master</span>
<span class="nv">service</span> <span class="nv">keepalived</span> <span class="nv">stop</span>  #停止<span class="nv">Nginx</span><span class="o">-</span><span class="nv">Backup</span>
<span class="nv">ip</span> <span class="nv">addr</span>  <span class="sc">#2</span>台服务器分别执行，绑定虚拟<span class="nv">IP</span>在<span class="nv">Nginx</span><span class="o">-</span><span class="nv">Backup</span>
<span class="nv">service</span> <span class="nv">keepalived</span> <span class="nv">start</span>  #再启动<span class="nv">Nginx</span><span class="o">-</span><span class="nv">Backup</span>
<span class="nv">ip</span> <span class="nv">addr</span>  <span class="sc">#2</span>台服务器分别执行，绑定虚拟<span class="nv">IP</span>在<span class="nv">Nginx</span><span class="o">-</span><span class="nv">Master</span>
上述切换默认测试会导致的<span class="nv">master</span>和<span class="nv">backup</span>之间来回切换
通常如果<span class="nv">master</span>服务死掉后<span class="nv">backup</span>会变成<span class="nv">master</span>，但是当<span class="nv">master</span>服务又好了的时候<span class="nv">master</span>此时会抢占<span class="nv">VIP</span>，这样就会发生两次切换对业务
繁忙的网站来说是不好的。我们可以在配置文件加入<span class="nv">nopreempt</span>非抢占，但是这个参数只能用于<span class="nv">state</span>为<span class="nv">BACKUP</span>，故我们在用<span class="nv">HA</span>的时候最好
<span class="nv">MASTER</span>和<span class="nv">backup</span>的<span class="nv">state</span>都设置成<span class="nv">BACKUP</span>让其通过<span class="nv">priority</span>来竞争。
拓展
假设我要重装这<span class="mi">2</span>台服务器，但是过程不容许丢一个包，通常情况下先替换<span class="nv">backup</span>，把<span class="nv">master</span>停止，让<span class="nv">vip</span>漂移只<span class="nv">backup</span>，替换<span class="nv">master</span>，
但是在<span class="nv">vip</span>漂移过程可能会有丢<span class="mi">2</span>个包，如果避免丢包？
方法：我们可以在<span class="nv">master</span>替换之前，利用<span class="nv">iptables</span>将数据包转发到<span class="nv">backup</span>，再停止<span class="nv">master</span> <span class="nv">keepalived</span>
<span class="nv">iptables</span> <span class="o">-</span><span class="nv">F</span>
<span class="nv">iptables</span> <span class="o">-</span><span class="nv">t</span> <span class="nv">nat</span> <span class="o">-</span><span class="nv">I</span> <span class="nv">PREROUTING</span> <span class="o">-</span><span class="nv">i</span> <span class="nv">eth0</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">DNAT</span> <span class="o">--</span><span class="nv">to</span><span class="o">-</span><span class="nv">destination</span> <span class="mi">10</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">61</span>
<span class="nv">iptables</span> <span class="o">-</span><span class="nv">t</span> <span class="nv">nat</span> <span class="o">-</span><span class="nv">I</span> <span class="nv">POSTROUTING</span> <span class="o">-</span><span class="nv">o</span> <span class="nv">eth0</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">MASQUERADE</span>
</pre></div>


<h2 id="nginx_upstream_check_module">nginx_upstream_check_module</h2>
<div class="codehilite"><pre><span></span><span class="n">提供负载均衡器内节点的健康检查的</span><span class="err">。</span><span class="n">这个就是淘宝技术团队开发的</span><span class="w"> </span><span class="n">nginx</span><span class="w"> </span><span class="n">模块</span><span class="w"> </span><span class="n">nginx_upstream_check_module</span><span class="err">，</span><span class="w"></span>
<span class="n">通过它可以用来检测后端</span><span class="w"> </span><span class="n">realserver</span><span class="w"> </span><span class="n">的健康状态</span><span class="err">。</span><span class="n">如果后端</span><span class="w"> </span><span class="n">realserver</span><span class="w"> </span><span class="n">不可用</span><span class="err">，</span><span class="n">则所以的请求就不会转发到该节点上</span><span class="err">。</span><span class="w"></span>
<span class="n">在淘宝自己的</span><span class="w"> </span><span class="n">tengine</span><span class="w"> </span><span class="n">上是自带了该模块的</span><span class="err">，</span><span class="n">大家可以访问淘宝tengine的官网来获取该版本的nginx</span><span class="err">，</span><span class="n">官方地址</span><span class="err">：</span><span class="w"> </span>
<span class="nl">http</span><span class="p">:</span><span class="o">//</span><span class="n">tengine</span><span class="p">.</span><span class="n">taobao</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="w"> </span><span class="err">。</span><span class="w"></span>

<span class="n">下载</span><span class="w"> </span><span class="n">nginx_upstream_check_module模块</span><span class="w"></span>

<span class="o">[</span><span class="n">root@localhost ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">cd</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">src</span><span class="w"></span>
<span class="n">wget</span><span class="w"> </span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">codeload</span><span class="p">.</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">yaoweibin</span><span class="o">/</span><span class="n">nginx_upstream_check_module</span><span class="o">/</span><span class="n">zip</span><span class="o">/</span><span class="n">master</span><span class="w"></span>
<span class="n">unzip</span><span class="w"> </span><span class="n">master</span><span class="w"></span>
<span class="o">[</span><span class="n">root@localhost /usr/local/src</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">ll</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="n">nginx_upstream_check_module</span><span class="o">-</span><span class="n">master</span><span class="w"></span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span><span class="p">.</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="mi">4096</span><span class="w"> </span><span class="k">Dec</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="mi">02</span><span class="err">:</span><span class="mi">28</span><span class="w"> </span><span class="n">nginx_upstream_check_module</span><span class="o">-</span><span class="n">master</span><span class="w"></span>
<span class="mi">2</span><span class="err">、</span><span class="n">为nginx打补丁</span><span class="w"></span>

<span class="o">[</span><span class="n">root@localhost /usr/local/src</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">cd</span><span class="w"> </span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.6.0</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">进入nginx的源码目录</span><span class="w"></span>
<span class="o">[</span><span class="n">root@localhost nginx-1.6.0</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">patch</span><span class="w"> </span><span class="o">-</span><span class="n">p1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="n">nginx_upstream_check_module</span><span class="o">-</span><span class="n">master</span><span class="o">/</span><span class="n">check_1</span><span class="mf">.5.12</span><span class="o">+</span><span class="p">.</span><span class="n">patch</span><span class="w"></span>
<span class="o">[</span><span class="n">root@localhost nginx-1.6.0</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">configure</span><span class="w"> </span><span class="c1">--user=nginx --group=nginx --prefix=/usr/local/nginx-1.6.0 </span>
<span class="c1">--with-http_ssl_module --with-openssl=/usr/local/src/openssl-0.9.8q --with-pcre=/usr/local/src/pcre-8.32 </span>
<span class="c1">--add-module=/usr/local/src/nginx_concat_module/ --add-module=../nginx_upstream_check_module-master/</span>
<span class="n">make</span><span class="w"> </span><span class="p">(</span><span class="n">注意</span><span class="err">：</span><span class="n">此处只make</span><span class="err">，</span><span class="n">编译参数需要和之前的一样</span><span class="p">)</span><span class="w"></span>
<span class="o">[</span><span class="n">root@localhost nginx-1.6.0</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">mv</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.6.0</span><span class="p">.</span><span class="n">bak</span><span class="w"></span>
<span class="o">[</span><span class="n">root@localhost nginx-1.6.0</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">cp</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">objs</span><span class="o">/</span><span class="n">nginx</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="w"></span>
<span class="o">[</span><span class="n">root@localhost nginx-1.6.0</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span><span class="w"> </span><span class="o">-</span><span class="n">t</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">检查下是否有问题</span><span class="w"></span>
<span class="o">[</span><span class="n">root@localhost nginx-1.6.0</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="k">kill</span><span class="w"> </span><span class="o">-</span><span class="n">USR2</span><span class="w"> </span><span class="err">`</span><span class="n">cat</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span><span class="n">nginx</span><span class="p">.</span><span class="n">pid</span><span class="err">`</span><span class="w"></span>
<span class="mi">3</span><span class="err">、</span><span class="n">在nginx</span><span class="p">.</span><span class="n">conf配置文件里面的upstream加入健康检查</span><span class="err">，</span><span class="n">如下</span><span class="err">：</span><span class="w"></span>

<span class="n">upstream</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">       </span><span class="n">server</span><span class="w"> </span><span class="mf">192.168.0.21</span><span class="err">:</span><span class="mi">80</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="n">server</span><span class="w"> </span><span class="mf">192.168.0.22</span><span class="err">:</span><span class="mi">80</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="k">check</span><span class="w"> </span><span class="k">interval</span><span class="o">=</span><span class="mi">3000</span><span class="w"> </span><span class="n">rise</span><span class="o">=</span><span class="mi">2</span><span class="w"> </span><span class="n">fall</span><span class="o">=</span><span class="mi">5</span><span class="w"> </span><span class="n">timeout</span><span class="o">=</span><span class="mi">1000</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="n">http</span><span class="p">;</span><span class="w"></span>

<span class="err">}</span><span class="w"></span>
<span class="n">上面</span><span class="w"> </span><span class="n">配置的意思是</span><span class="err">，</span><span class="n">对name这个负载均衡条目中的所有节点</span><span class="err">，</span><span class="n">每个3秒检测一次</span><span class="err">，</span><span class="n">请求2次正常则标记</span><span class="w"> </span><span class="n">realserver状态为up</span><span class="err">，</span><span class="w"></span>
<span class="n">如果检测</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">次都失败</span><span class="err">，</span><span class="n">则标记</span><span class="w"> </span><span class="n">realserver的状态为down</span><span class="err">，</span><span class="n">超时时间为1秒</span><span class="err">。</span><span class="w"></span>

<span class="n">这里列出</span><span class="w"> </span><span class="n">nginx_upstream_check_module</span><span class="w"> </span><span class="n">模块所支持的指令意思</span><span class="err">：</span><span class="w"></span>


<span class="nl">Syntax</span><span class="p">:</span><span class="w"> </span><span class="k">check</span><span class="w"> </span><span class="k">interval</span><span class="o">=</span><span class="n">milliseconds</span><span class="w"> </span><span class="o">[</span><span class="n">fall=count</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">rise=count</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">timeout=milliseconds</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">default_down=true|false</span><span class="o">]</span><span class="w"></span>
<span class="w"> </span><span class="o">[</span><span class="n">type=tcp|http|ssl_hello|mysql|ajp</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">port=check_port</span><span class="o">]</span><span class="k">Default</span><span class="err">:</span><span class="w"> </span><span class="n">如果没有配置参数</span><span class="err">，</span><span class="n">默认值是</span><span class="err">：</span><span class="k">interval</span><span class="o">=</span><span class="mi">30000</span><span class="w"> </span><span class="n">fall</span><span class="o">=</span><span class="mi">5</span><span class="w"> </span>
<span class="w"> </span><span class="n">rise</span><span class="o">=</span><span class="mi">2</span><span class="w"> </span><span class="n">timeout</span><span class="o">=</span><span class="mi">1000</span><span class="w"> </span><span class="n">default_down</span><span class="o">=</span><span class="k">true</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="nl">tcpContext</span><span class="p">:</span><span class="w"> </span><span class="n">upstream</span><span class="w"></span>
<span class="n">该指令可以打开后端服务器的健康检查功能</span><span class="err">。</span><span class="w"></span>

<span class="n">指令后面的参数意义是</span><span class="err">：</span><span class="w"></span>

<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="k">interval</span><span class="err">：</span><span class="n">向后端发送的健康检查包的间隔</span><span class="err">。</span><span class="w"></span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">fall</span><span class="p">(</span><span class="n">fall_count</span><span class="p">)</span><span class="err">:</span><span class="w"> </span><span class="n">如果连续失败次数达到fall_count</span><span class="err">，</span><span class="n">服务器就被认为是down</span><span class="err">。</span><span class="w"></span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">rise</span><span class="p">(</span><span class="n">rise_count</span><span class="p">)</span><span class="err">:</span><span class="w"> </span><span class="n">如果连续成功次数达到rise_count</span><span class="err">，</span><span class="n">服务器就被认为是up</span><span class="err">。</span><span class="w"></span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nl">timeout</span><span class="p">:</span><span class="w"> </span><span class="n">后端健康请求的超时时间</span><span class="err">。</span><span class="w"></span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nl">default_down</span><span class="p">:</span><span class="w"> </span><span class="n">设定初始时服务器的状态</span><span class="err">，</span><span class="n">如果是true</span><span class="err">，</span><span class="n">就说明默认是down的</span><span class="err">，</span><span class="n">如果是false</span><span class="err">，</span><span class="n">就是up的</span><span class="err">。</span><span class="n">默认值是true</span><span class="err">，</span><span class="n">也就是一</span><span class="w"></span>
<span class="w">  </span><span class="n">开始服务器认为是不可用</span><span class="err">，</span><span class="n">要等健康检查包达到一定成功次数以后才会被认为是健康的</span><span class="err">。</span><span class="w"></span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">type</span><span class="err">：</span><span class="n">健康检查包的类型</span><span class="err">，</span><span class="n">现在支持以下多种类型</span><span class="w"></span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">tcp</span><span class="err">：</span><span class="n">简单的tcp连接</span><span class="err">，</span><span class="n">如果连接成功</span><span class="err">，</span><span class="n">就说明后端正常</span><span class="err">。</span><span class="w"></span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">ssl_hello</span><span class="err">：</span><span class="n">发送一个初始的SSL</span><span class="w"> </span><span class="n">hello包并接受服务器的SSL</span><span class="w"> </span><span class="n">hello包</span><span class="err">。</span><span class="w"></span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">http</span><span class="err">：</span><span class="n">发送HTTP请求</span><span class="err">，</span><span class="n">通过后端的回复包的状态来判断后端是否存活</span><span class="err">。</span><span class="w"></span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="nl">mysql</span><span class="p">:</span><span class="w"> </span><span class="n">向mysql服务器连接</span><span class="err">，</span><span class="n">通过接收服务器的greeting包来判断后端是否存活</span><span class="err">。</span><span class="w"></span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">ajp</span><span class="err">：</span><span class="n">向后端发送AJP协议的Cping包</span><span class="err">，</span><span class="n">通过接收Cpong包来判断后端是否存活</span><span class="err">。</span><span class="w"></span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nl">port</span><span class="p">:</span><span class="w"> </span><span class="n">指定后端服务器的检查端口</span><span class="err">。</span><span class="n">你可以指定不同于真实服务的后端服务器的端口</span><span class="err">，</span><span class="n">比如后端提供的是443端口的应用</span><span class="err">，</span><span class="n">你可以去检查</span><span class="w"></span>
<span class="w">  </span><span class="mi">80</span><span class="n">端口的状态来判断后端健康状况</span><span class="err">。</span><span class="n">默认是0</span><span class="err">，</span><span class="n">表示跟后端server提供真实服务的端口一样</span><span class="err">。</span><span class="n">该选项出现于Tengine</span><span class="o">-</span><span class="mf">1.4.0</span><span class="err">。</span><span class="w"></span>
<span class="nl">Syntax</span><span class="p">:</span><span class="w"> </span><span class="n">check_keepalive_requests</span><span class="w"> </span><span class="nl">request_numDefault</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="nl">Context</span><span class="p">:</span><span class="w"> </span><span class="n">upstream</span><span class="w"></span>
<span class="n">该指令可以配置一个连接发送的请求数</span><span class="err">，</span><span class="n">其默认值为1</span><span class="err">，</span><span class="n">表示Tengine完成1次请求后即关闭连接</span><span class="err">。</span><span class="w"></span>

<span class="nl">Syntax</span><span class="p">:</span><span class="w"> </span><span class="n">check_http_send</span><span class="w"> </span><span class="nl">http_packetDefault</span><span class="p">:</span><span class="w"> </span><span class="ss">&quot;GET / HTTP/1.0\r\n\r\n&quot;</span><span class="nl">Context</span><span class="p">:</span><span class="w"> </span><span class="n">upstream</span><span class="w"></span>
<span class="n">该指令可以配置http健康检查包发送的请求内容</span><span class="err">。</span><span class="n">为了减少传输数据量</span><span class="err">，</span><span class="n">推荐采用</span><span class="ss">&quot;HEAD&quot;</span><span class="n">方法</span><span class="err">。</span><span class="w"></span>

<span class="n">当采用长连接进行健康检查时</span><span class="err">，</span><span class="n">需在该指令中添加keep</span><span class="o">-</span><span class="n">alive请求头</span><span class="err">，</span><span class="n">如</span><span class="err">：</span><span class="ss">&quot;HEAD / HTTP/1.1\r\nConnection: keep-alive\r\n\r\n&quot;</span><span class="err">。</span><span class="w"> </span>
<span class="n">同时</span><span class="err">，</span><span class="n">在采用</span><span class="ss">&quot;GET&quot;</span><span class="n">方法的情况下</span><span class="err">，</span><span class="n">请求uri的size不宜过大</span><span class="err">，</span><span class="n">确保可以在1个interval内传输完成</span><span class="err">，</span><span class="n">否则会被健康检查模块视为后端服务器或</span><span class="w"></span>
<span class="n">网络异常</span><span class="err">。</span><span class="w"></span>

<span class="nl">Syntax</span><span class="p">:</span><span class="w"> </span><span class="n">check_http_expect_alive</span><span class="w"> </span><span class="o">[</span><span class="n"> http_2xx | http_3xx | http_4xx | http_5xx </span><span class="o">]</span><span class="k">Default</span><span class="err">:</span><span class="w"> </span><span class="n">http_2xx</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nl">http_3xxContext</span><span class="p">:</span><span class="w"> </span>
<span class="n">upstream</span><span class="w"></span>
<span class="n">该指令指定HTTP回复的成功状态</span><span class="err">，</span><span class="n">默认认为2XX和3XX的状态是健康的</span><span class="err">。</span><span class="w"></span>

<span class="nl">Syntax</span><span class="p">:</span><span class="w"> </span><span class="n">check_shm_size</span><span class="w"> </span><span class="nl">sizeDefault</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="nl">MContext</span><span class="p">:</span><span class="w"> </span><span class="n">http</span><span class="w"></span>
<span class="n">所有的后端服务器健康检查状态都存于共享内存中</span><span class="err">，</span><span class="n">该指令可以设置共享内存的大小</span><span class="err">。</span><span class="n">默认是1M</span><span class="err">，</span><span class="n">如果你有1千台以上的服务器并在配置的时候</span><span class="w"></span>
<span class="n">出现了错误</span><span class="err">，</span><span class="n">就可能需要扩大该内存的大小</span><span class="err">。</span><span class="w"></span>

<span class="nl">Syntax</span><span class="p">:</span><span class="w"> </span><span class="n">check_status</span><span class="w"> </span><span class="o">[</span><span class="n">html|csv|json</span><span class="o">]</span><span class="k">Default</span><span class="err">:</span><span class="w"> </span><span class="n">check_status</span><span class="w"> </span><span class="nl">htmlContext</span><span class="p">:</span><span class="w"> </span><span class="n">location</span><span class="w"></span>
<span class="n">显示服务器的健康状态页面</span><span class="err">。</span><span class="n">该指令需要在http块中配置</span><span class="err">。</span><span class="w"></span>

<span class="n">在Tengine</span><span class="o">-</span><span class="mf">1.4.0</span><span class="n">以后</span><span class="err">，</span><span class="n">你可以配置显示页面的格式</span><span class="err">。</span><span class="nl">支持的格式有</span><span class="p">:</span><span class="w"> </span><span class="n">html</span><span class="err">、</span><span class="n">csv</span><span class="err">、</span><span class="w"> </span><span class="n">json</span><span class="err">。</span><span class="n">默认类型是html</span><span class="err">。</span><span class="w"></span>

<span class="n">你也可以通过请求的参数来指定格式</span><span class="err">，</span><span class="n">假设</span><span class="err">‘</span><span class="o">/</span><span class="n">status</span><span class="err">’</span><span class="n">是你状态页面的URL</span><span class="err">，</span><span class="w"> </span><span class="n">format参数改变页面的格式</span><span class="err">，</span><span class="n">比如</span><span class="err">：</span><span class="w"></span>

<span class="o">/</span><span class="n">status</span><span class="vm">?</span><span class="nf">format</span><span class="o">=</span><span class="n">html</span><span class="w"></span>
<span class="o">/</span><span class="n">status</span><span class="vm">?</span><span class="nf">format</span><span class="o">=</span><span class="n">csv</span><span class="w"></span>
<span class="o">/</span><span class="n">status</span><span class="vm">?</span><span class="nf">format</span><span class="o">=</span><span class="n">json</span><span class="w"></span>
<span class="n">同时你也可以通过status参数来获取相同服务器状态的列表</span><span class="err">，</span><span class="n">比如</span><span class="err">：</span><span class="w"></span>

<span class="o">/</span><span class="n">status</span><span class="vm">?</span><span class="nf">format</span><span class="o">=</span><span class="n">html</span><span class="o">&amp;</span><span class="n">status</span><span class="o">=</span><span class="n">down</span><span class="w"></span>
<span class="o">/</span><span class="n">status</span><span class="vm">?</span><span class="nf">format</span><span class="o">=</span><span class="n">csv</span><span class="o">&amp;</span><span class="n">status</span><span class="o">=</span><span class="n">up</span><span class="w"></span>
<span class="n">下面是一个状态也配置的范例</span><span class="err">：</span><span class="w"></span>

<span class="n">http</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">      </span><span class="n">server</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">       </span><span class="n">location</span><span class="w"> </span><span class="o">/</span><span class="n">nstatus</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">         </span><span class="n">check_status</span><span class="p">;</span><span class="w"></span>
<span class="w">         </span><span class="n">access_log</span><span class="w"> </span><span class="k">off</span><span class="p">;</span><span class="w"></span>
<span class="w">         </span><span class="n">#allow</span><span class="w"> </span><span class="n">IP</span><span class="p">;</span><span class="w">         </span><span class="n">#deny</span><span class="w"> </span><span class="ow">all</span><span class="p">;</span><span class="w">       </span><span class="err">}</span><span class="w"></span>
<span class="w">      </span><span class="err">}</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>
<span class="n">配置完毕后</span><span class="err">，</span><span class="n">重启nginx</span><span class="err">。</span><span class="n">此时通过访问定义好的路径</span><span class="err">，</span><span class="n">就可以看到当前</span><span class="w"> </span><span class="n">realserver</span><span class="w"> </span><span class="n">实时的健康状态啦</span><span class="err">。</span><span class="n">效果如下图</span><span class="err">：</span><span class="w"> </span>
<span class="n">realserver</span><span class="w"> </span><span class="n">都正常的状态</span><span class="err">：</span><span class="w"></span>

<span class="n">wKiom1SZZXKQcPJTAAFnMqUEfBo238</span><span class="p">.</span><span class="n">jpg</span><span class="w"></span>

<span class="n">一台</span><span class="w"> </span><span class="n">realserver</span><span class="w"> </span><span class="n">故障的状态</span><span class="err">：</span><span class="w"></span>

<span class="n">wKioL1SZZivDAzdWAAGTyIK9cS8558</span><span class="p">.</span><span class="n">jpgOK</span><span class="err">，</span><span class="n">以上nginx_upstream_check_module模块的相关信息</span><span class="err">，</span><span class="n">更多的信息大家可以去该模块的淘宝</span><span class="w"></span>
<span class="n">tengine页面和github上该项目页面去查看</span><span class="err">，</span><span class="n">下面是访问地址</span><span class="err">：</span><span class="w"></span>

<span class="nl">http</span><span class="p">:</span><span class="o">//</span><span class="n">tengine</span><span class="p">.</span><span class="n">taobao</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">document_cn</span><span class="o">/</span><span class="n">http_upstream_check_cn</span><span class="p">.</span><span class="n">html</span><span class="w"></span>

<span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">yaoweibin</span><span class="o">/</span><span class="n">nginx_upstream_check_module</span><span class="w"></span>

<span class="n">在生产环境的实施应用中</span><span class="err">，</span><span class="n">需要注意的有</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">点</span><span class="err">：</span><span class="w"></span>

<span class="mi">1</span><span class="err">、</span><span class="n">主要定义好type</span><span class="err">。</span><span class="n">由于默认的type是tcp类型</span><span class="err">，</span><span class="n">因此假设你服务启动</span><span class="err">，</span><span class="n">不管是否初始化完毕</span><span class="err">，</span><span class="n">它的端口都会起来</span><span class="err">，</span><span class="n">所以此时前段负载均衡器</span><span class="w"></span>
<span class="n">为认为该服务已经可用</span><span class="err">，</span><span class="n">其实是不可用状态</span><span class="err">。</span><span class="w"></span>

<span class="mi">2</span><span class="err">、</span><span class="n">注意check_http_send值的设定</span><span class="err">。</span><span class="n">由于它的默认值是</span><span class="ss">&quot;GET / HTTP/1.0\r\n\r\n&quot;</span><span class="err">。</span><span class="nl">假设你的应用是通过http</span><span class="p">:</span><span class="o">//</span><span class="n">ip</span><span class="o">/</span><span class="n">name访问的</span><span class="err">，</span><span class="n">那么</span><span class="w"></span>
<span class="n">这里你的</span><span class="w"> </span><span class="n">check_http_send值就需要更改为</span><span class="w"> </span><span class="ss">&quot;GET /name HTTP/1.0\r\n\r\n&quot;</span><span class="n">才可以</span><span class="err">。</span><span class="n">针对采用长连接进行检查的</span><span class="err">，</span><span class="w"> </span><span class="n">这里增加keep</span><span class="o">-</span><span class="n">alive</span><span class="w"></span>
<span class="n">请求</span><span class="w"> </span><span class="n">头</span><span class="err">，</span><span class="n">即</span><span class="ss">&quot;HEAD /name HTTP/1.1\r\nConnection: keep-alive\r\n\r\n&quot;</span><span class="err">。</span><span class="n">如果你后端的tomcat是基于域名的多虚拟机</span><span class="err">，</span><span class="n">此时你需要通</span><span class="w"></span>
<span class="n">过</span><span class="w"> </span><span class="n">check_http_send定义host</span><span class="err">，</span><span class="n">不然每次访问都是失败</span><span class="err">，</span><span class="n">范例</span><span class="err">：</span><span class="n">check_http_send</span><span class="w"> </span><span class="ss">&quot;GET /mobileapi HTTP/1.0\r\n HOST www.redhat.sx</span>
<span class="ss">\r\n\r\n&quot;</span><span class="p">;</span><span class="w"></span>

<span class="n">三</span><span class="err">、</span><span class="w"> </span><span class="n">ngx_http_healthcheck_module模块</span><span class="w"></span>

<span class="n">除了上面两个模块</span><span class="err">，</span><span class="n">nginx官方在早期的时候还提供了一个ngx_http_healthcheck_module</span><span class="w">  </span><span class="n">模块用来进行</span><span class="w"> </span><span class="n">nginx后端节点的健康检查</span><span class="err">。</span><span class="w"></span>
<span class="n">nginx_upstream_check_module模块就是参照</span><span class="w"> </span><span class="n">该模块的设计理念进行开发的</span><span class="err">，</span><span class="n">因此在使用和效果上都大同小异</span><span class="err">。</span><span class="n">但是需要注意的是</span><span class="err">，</span><span class="w"> </span>
<span class="n">ngx_http_healthcheck_module</span><span class="w">  </span><span class="n">模块仅仅支持nginx的1</span><span class="mf">.0.0</span><span class="n">版本</span><span class="err">，</span><span class="mf">1.1.0</span><span class="n">版本以后都不支持了</span><span class="err">！</span><span class="n">因此</span><span class="err">，</span><span class="n">对于目前常见的生产环境上都不</span><span class="w"></span>
<span class="n">会去用了</span><span class="err">，</span><span class="n">这里仅仅留个纪念</span><span class="err">，</span><span class="n">给大家介绍下这个模块</span><span class="err">！</span><span class="w"></span>

<span class="n">具体的使用方法</span><span class="err">，</span><span class="n">这里可以贴出几篇靠谱的博文地址以及官方地址</span><span class="err">：</span><span class="w"></span>

<span class="nl">http</span><span class="p">:</span><span class="o">//</span><span class="n">wiki</span><span class="p">.</span><span class="n">nginx</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">HttpHealthcheckModule</span><span class="w"></span>

<span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">cep21</span><span class="o">/</span><span class="n">healthcheck_nginx_upstreams</span><span class="o">/</span><span class="k">blob</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">README</span><span class="w"></span>

<span class="n">OK</span><span class="err">！</span><span class="w"></span>

<span class="n">以上就是本文的内容</span><span class="err">，</span><span class="n">希望能够对51博友有所帮助</span><span class="err">！</span><span class="w"></span>


<span class="n">来源</span><span class="err">：</span><span class="w"> </span><span class="nl">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="p">.</span><span class="n">tuicool</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">articles</span><span class="o">/</span><span class="n">vuiQry</span><span class="w"></span>
</pre></div>


<h2 id="_1">虚拟主机</h2>
<div class="codehilite"><pre><span></span><span class="err">基于域名的虚拟主机</span>
<span class="nt">server</span> <span class="p">{</span>
    <span class="err">listen</span> <span class="err">80</span><span class="p">;</span>
    <span class="err">server_name</span> <span class="err">www.example.com</span><span class="p">;</span>
    <span class="err">...</span>
<span class="p">}</span>
<span class="nt">server</span> <span class="p">{</span>
    <span class="err">listen</span> <span class="err">80</span><span class="p">;</span>
    <span class="err">server_name</span> <span class="err">www.test.com</span><span class="p">;</span>
    <span class="err">...</span>
<span class="p">}</span>

<span class="err">基于</span><span class="nt">ip</span><span class="err">的虚拟主机</span>
<span class="nt">server</span> <span class="p">{</span>
    <span class="err">listen</span> <span class="err">10.0.0.88:80</span><span class="p">;</span>
    <span class="err">root</span> <span class="err">88.com</span><span class="p">;</span>
    <span class="err">index</span> <span class="err">index.html</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">server</span> <span class="p">{</span>
    <span class="err">listen</span> <span class="err">10.0.0.87:80</span><span class="p">;</span>
    <span class="err">root</span> <span class="err">87.com</span><span class="p">;</span>
    <span class="err">index</span> <span class="err">index.html</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<h2 id="_2">正向代理</h2>
<div class="codehilite"><pre><span></span><span class="nv">server</span> {
 <span class="nv">listen</span> <span class="mi">8093</span><span class="c1">;</span>
 <span class="nv">location</span> <span class="o">/</span> {
 <span class="nv">resolver</span> <span class="mi">218</span>.<span class="mi">85</span>.<span class="mi">157</span>.<span class="mi">99</span> <span class="mi">218</span>.<span class="mi">85</span>.<span class="mi">152</span>.<span class="mi">99</span><span class="c1">; #dns</span>
 <span class="nv">resolver_timeout</span> <span class="mi">30</span><span class="nv">s</span><span class="c1">;</span>
 <span class="nv">proxy_pass</span> <span class="nv">http</span>:<span class="o">//</span>$<span class="nv">host</span>$<span class="nv">request_uri</span><span class="c1">;</span>
 }
 <span class="nv">access_log</span>  <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">log</span><span class="o">/</span><span class="nv">proxy</span><span class="o">-</span><span class="nv">aceess</span>.<span class="nv">log</span><span class="c1">;      </span>
}

因为<span class="nv">Nginx</span>不支持<span class="k">CONNECT</span>，所以无法正向代理<span class="nv">Https</span>网站<span class="ss">(</span>如：网上银行，<span class="nv">Gmail</span><span class="ss">)</span>   但是<span class="nv">squid</span>支持<span class="k">CONNECT</span>
<span class="nv">curl</span> <span class="nv">http</span>:<span class="o">//</span><span class="nv">www</span>.<span class="nv">baidu</span>.<span class="nv">com</span><span class="o">/</span>  <span class="o">-</span><span class="nv">x</span> <span class="mi">172</span>.<span class="mi">29</span>.<span class="mi">0</span>.<span class="mi">70</span>:<span class="mi">8093</span>
<span class="nv">curl</span> <span class="nv">https</span>:<span class="o">//</span><span class="nv">www</span>.<span class="nv">baidu</span>.<span class="nv">com</span>  <span class="o">-</span><span class="nv">x</span> <span class="mi">10</span>.<span class="mi">191</span>.<span class="mi">174</span>.<span class="mi">31</span>:<span class="mi">3128</span>  <span class="nv">squid</span>

<span class="nv">rsync</span>代理设置
<span class="nv">export</span> <span class="nv">RSYNC_PROXY</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">192.168.0.123:8080</span><span class="s2">&quot;</span>
<span class="nv">http</span><span class="o">/</span><span class="nv">ftp</span>代理设置
<span class="nv">export</span> <span class="nv">http_proxy</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">192.168.0.123:8080</span><span class="s2">&quot;</span>
<span class="nv">export</span> <span class="nv">FTP_PROXY</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">192.168.0.123:8080</span><span class="s2">&quot;</span>
<span class="nv">export</span> <span class="nv">HTTP_PROXY</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">192.168.0.123:8080</span><span class="s2">&quot;</span>
<span class="nv">export</span> <span class="nv">ftp_proxy</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">192.168.0.123:8080</span><span class="s2">&quot;</span>
对于<span class="nv">wget</span>可以单独建立.<span class="nv">wgetrc</span>
<span class="nv">http</span><span class="o">-</span><span class="nv">proxy</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">192.168.0.123:8080</span><span class="s2">&quot;</span>
<span class="nv">ftp</span><span class="o">-</span><span class="nv">proxy</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">192.168.0.123:8080</span><span class="s2">&quot;</span>
对于常用代理的，可以写入<span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">profile</span>或者<span class="o">~/</span>.<span class="nv">bash_profile</span>
临时取消代理可以<span class="nv">unset</span>

<span class="o">=======================</span>
<span class="nv">yum</span>使用
<span class="nv">export</span> <span class="nv">http_proxy</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="nv">http</span>:<span class="o">//</span><span class="mi">172</span>.<span class="mi">29</span>.<span class="mi">0</span>.<span class="mi">70</span>:<span class="mi">8093</span>
<span class="s2">&quot;</span><span class="s"> 后直接yum install</span>
<span class="nv">unset</span> <span class="nv">http_proxy</span> <span class="ss">(</span>取消<span class="ss">)</span>
<span class="o">========================</span>

<span class="nv">pip</span>使用
<span class="nv">pip</span> <span class="o">--</span><span class="nv">proxy</span> <span class="nv">http</span>:<span class="o">//</span><span class="mi">172</span>.<span class="mi">29</span>.<span class="mi">0</span>.<span class="mi">70</span>:<span class="mi">8093</span> <span class="nv">install</span> <span class="o">-</span><span class="nv">r</span> <span class="nv">pip_requirements</span>.<span class="nv">txt</span> <span class="o">-</span><span class="nv">i</span>  <span class="nv">http</span>:<span class="o">//</span><span class="nv">pypi</span>.<span class="nv">douban</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">simple</span>


<span class="nv">rsync</span>使用<span class="nv">squid</span>
<span class="nv">yum</span> <span class="nv">install</span> <span class="nv">squid</span>
<span class="nv">vim</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">squid</span><span class="o">/</span><span class="nv">squid</span>.<span class="nv">conf</span>
<span class="nv">acl</span> <span class="nv">localnet</span> <span class="nv">src</span> <span class="mi">10</span>.<span class="mi">191</span>.<span class="mi">173</span>.<span class="mi">0</span><span class="o">/</span><span class="mi">24</span>
<span class="nv">acl</span> <span class="nv">SSL_ports</span> <span class="nv">port</span> <span class="mi">443</span> <span class="mi">563</span> <span class="mi">873</span>
<span class="nv">acl</span> <span class="nv">Safe_ports</span> <span class="nv">port</span> <span class="mi">873</span>

<span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">init</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">squid</span> <span class="nv">start</span>

客户端配置公网<span class="nv">dns</span>
<span class="nv">export</span> <span class="nv">RSYNC_PROXY</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">192.168.0.123:3128</span><span class="s2">&quot;</span>
</pre></div>


<h2 id="404">404跳转</h2>
<p>nginx+php 使用的时候经常需要伪静态，一般大家都手动设置。那有没有办法让 nginx 自动补全路径呢？<br />
这两天折腾很久，才实现了这样一个功能：<br />
请求 /a/b/c<br />
若文件不存在，查找 /a/b/index.php，/c 作为 PATH_INFO；<br />
若文件不存在，查找 /a/index.php，/b/c 作为 PATH_INFO；<br />
若文件不存在，查找 /index.php，/a/b/c 作为 PATH_INFO；<br />
若文件不存在，返回 404.</p>
<p>虽然这种损耗性能的行为不适合部署，但在本机调试的时候还是能够带来方便的 🙂</p>
<p>server 端应有如下代码，其他部分使用自己的配置：</p>
<p>index index.php index.html index.htm;</p>
<div class="codehilite"><pre><span></span><span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
    <span class="n">set</span> <span class="err">$</span><span class="n">path</span> <span class="err">$</span><span class="n">request_uri</span><span class="p">;</span>
    <span class="n">set</span> <span class="err">$</span><span class="n">path_info</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

    <span class="n">try_files</span> <span class="err">$</span><span class="n">uri</span> <span class="err">$</span><span class="n">uri</span><span class="o">/</span> <span class="mi">@404</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">location</span> <span class="mi">@404</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="err">$</span><span class="n">path</span> <span class="o">~</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)(</span><span class="o">/</span><span class="p">.</span><span class="o">+</span><span class="p">)</span><span class="err">$</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">set</span> <span class="err">$</span><span class="n">path</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">php</span><span class="p">;</span>
        <span class="n">set</span> <span class="err">$</span><span class="n">path_info</span> <span class="err">$</span><span class="mi">2</span><span class="p">;</span>
        <span class="n">rewrite</span> <span class="p">.</span><span class="o">*</span> <span class="err">$</span><span class="n">path</span> <span class="n">last</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">404</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">location</span> <span class="o">~</span> <span class="p">.</span><span class="o">+</span><span class="p">.</span><span class="n">php</span><span class="p">(</span><span class="err">$</span><span class="o">|/</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">fastcgi_split_path_info</span> <span class="o">^</span><span class="p">(.</span><span class="o">+</span><span class="p">.</span><span class="n">php</span><span class="p">)(</span><span class="o">/</span><span class="p">.</span><span class="o">+</span><span class="p">)</span><span class="err">$</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="err">$</span><span class="n">path_info</span> <span class="o">!~</span> <span class="p">.</span><span class="o">*</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">set</span> <span class="err">$</span><span class="n">path_info</span> <span class="err">$</span><span class="n">fastcgi_path_info</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">try_files</span> <span class="err">$</span><span class="n">fastcgi_script_name</span> <span class="mi">@404</span><span class="n">php</span><span class="p">;</span>

    <span class="n">fastcgi_param</span> <span class="n">PATH_INFO</span> <span class="err">$</span><span class="n">path_info</span><span class="p">;</span>

    <span class="n">fastcgi_index</span> <span class="n">index</span><span class="p">.</span><span class="n">php</span><span class="p">;</span>
    <span class="n">include</span> <span class="n">fastcgi</span><span class="p">.</span><span class="n">conf</span><span class="p">;</span>

    <span class="n">fastcgi_pass</span> <span class="nl">unix</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">php</span><span class="o">-</span><span class="n">fpm</span><span class="p">.</span><span class="n">sock</span><span class="p">;</span>
    <span class="n">fastcgi_connect_timeout</span> <span class="mi">60</span><span class="p">;</span>
    <span class="n">fastcgi_send_timeout</span> <span class="mi">300</span><span class="p">;</span>
    <span class="n">fastcgi_read_timeout</span> <span class="mi">300</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">location</span> <span class="mi">@404</span><span class="n">php</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="err">$</span><span class="n">path</span> <span class="o">=</span> <span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">php</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">404</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="err">$</span><span class="n">path</span> <span class="o">~</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)(</span><span class="o">/</span><span class="p">.</span><span class="o">+</span><span class="p">)</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">php</span><span class="err">$</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">set</span> <span class="err">$</span><span class="n">path_info</span> <span class="err">$</span><span class="mi">2</span><span class="p">;</span>
        <span class="n">set</span> <span class="err">$</span><span class="n">path</span> <span class="err">$</span><span class="mi">1</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">php</span><span class="p">;</span>
        <span class="n">rewrite</span> <span class="p">.</span><span class="o">*</span> <span class="err">$</span><span class="n">path</span> <span class="n">last</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">404</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<h2 id="yum">yum代理缓存</h2>
<div class="codehilite"><pre><span></span># <span class="nv">nginx</span>.<span class="nv">conf</span> <span class="nv">log_format</span> 添加  <span class="s2">&quot;</span><span class="s">$upstream_cache_status</span><span class="s2">&quot;</span> 命中状态

<span class="nv">proxy_cache_path</span> <span class="o">/</span><span class="nv">data</span><span class="o">/</span><span class="nv">cache</span> <span class="nv">levels</span><span class="o">=</span><span class="mi">1</span>:<span class="mi">2</span> <span class="nv">keys_zone</span><span class="o">=</span><span class="nv">rpm</span><span class="o">-</span><span class="nv">cache</span>:<span class="mi">50</span><span class="nv">m</span> <span class="nv">max_size</span><span class="o">=</span><span class="mi">20</span><span class="nv">g</span> <span class="nv">inactive</span><span class="o">=</span><span class="mi">365</span><span class="nv">d</span> <span class="nv">use_temp_path</span><span class="o">=</span><span class="nv">off</span><span class="c1">; </span>
<span class="nv">proxy_cache_path</span> <span class="o">/</span><span class="nv">data</span><span class="o">/</span><span class="nv">repo</span> <span class="nv">levels</span><span class="o">=</span><span class="mi">1</span>:<span class="mi">2</span> <span class="nv">keys_zone</span><span class="o">=</span><span class="nv">repo</span><span class="o">-</span><span class="nv">cache</span>:<span class="mi">50</span><span class="nv">m</span> <span class="nv">max_size</span><span class="o">=</span><span class="mi">1</span><span class="nv">g</span> <span class="nv">inactive</span><span class="o">=</span><span class="mi">1</span><span class="nv">d</span> <span class="nv">use_temp_path</span><span class="o">=</span><span class="nv">off</span><span class="c1">; </span>
<span class="nv">proxy_redirect</span> <span class="nv">off</span><span class="c1">;</span>
<span class="nv">proxy_connect_timeout</span> <span class="mi">30</span><span class="c1">;</span>
<span class="nv">proxy_cache_valid</span>  <span class="mi">200</span> <span class="mi">304</span> <span class="mi">302</span> <span class="mi">24</span><span class="nv">h</span><span class="c1">;</span>
<span class="nv">proxy_cache_use_stale</span> <span class="nv">error</span> <span class="nb">timeout</span> <span class="nv">updating</span> <span class="nv">http_500</span> <span class="nv">http_502</span> <span class="nv">http_503</span> <span class="nv">http_504</span><span class="c1">; #后端超时使用缓存的数据</span>
<span class="nv">add_header</span> <span class="nv">X</span><span class="o">-</span><span class="nv">Cache</span><span class="o">-</span><span class="nv">Status</span> $<span class="nv">upstream_cache_status</span><span class="c1">;</span>
<span class="nv">server_tokens</span> <span class="nv">off</span><span class="c1">;</span>

<span class="nv">server</span> {
    <span class="nv">listen</span> <span class="mi">80</span><span class="c1">;</span>

    <span class="nv">root</span> <span class="nv">html</span><span class="c1">;</span>
    <span class="nv">index</span> <span class="nv">index</span>.<span class="nv">html</span> <span class="nv">index</span>.<span class="nv">htm</span> <span class="nv">index</span>.<span class="nv">php</span><span class="c1">;</span>
    <span class="nv">location</span> <span class="o">/</span> {
            <span class="k">return</span> <span class="mi">404</span><span class="c1">;</span>
    }

    <span class="nv">location</span> <span class="o">~</span> <span class="ss">(</span>\.<span class="nv">iso</span><span class="o">|</span>\.<span class="nv">filez</span><span class="o">|</span>\.<span class="nv">dirtree</span><span class="o">|</span>\.<span class="nv">png</span><span class="o">|</span>\.<span class="nv">gif</span><span class="ss">)</span>$ {
            <span class="k">return</span> <span class="mi">403</span><span class="c1">;</span>
    }

    <span class="nv">location</span> <span class="o">/</span><span class="nv">itv</span><span class="o">/</span> {
        <span class="nv">alias</span> <span class="o">/</span><span class="nv">data</span><span class="o">/</span><span class="nv">itv</span><span class="o">/</span><span class="c1">;</span>
    }

    <span class="nv">location</span> <span class="o">/</span><span class="nv">base</span><span class="o">/</span> {
        <span class="nv">set</span> $<span class="nv">key</span> <span class="nv">rpm</span><span class="o">-</span><span class="nv">cache</span><span class="c1">;</span>
        <span class="k">if</span> <span class="ss">(</span> $<span class="nv">uri</span> <span class="o">~*</span> <span class="nv">repodata</span> <span class="ss">)</span>{
            <span class="nv">set</span> $<span class="nv">key</span> <span class="nv">repo</span><span class="o">-</span><span class="nv">cache</span><span class="c1">;</span>
        }
        <span class="nv">proxy_pass</span> <span class="nv">http</span>:<span class="o">//</span><span class="nv">mirrors</span>.<span class="nv">aliyun</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">centos</span><span class="o">/</span><span class="c1">;</span>
        <span class="nv">proxy_cache</span> $<span class="nv">key</span><span class="c1">;</span>
    }

    <span class="nv">location</span> <span class="o">/</span><span class="nv">epel</span><span class="o">/</span> {
                <span class="nv">set</span> $<span class="nv">key</span> <span class="nv">rpm</span><span class="o">-</span><span class="nv">cache</span><span class="c1">;</span>
                <span class="k">if</span> <span class="ss">(</span> $<span class="nv">uri</span> <span class="o">~*</span> <span class="nv">repodata</span> <span class="ss">)</span>{
                        <span class="nv">set</span> $<span class="nv">key</span> <span class="nv">repo</span><span class="o">-</span><span class="nv">cache</span><span class="c1">;</span>
                }
                <span class="nv">proxy_pass</span> <span class="nv">http</span>:<span class="o">//</span><span class="nv">mirrors</span>.<span class="nv">aliyun</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">epel</span><span class="o">/</span><span class="c1">;</span>
                <span class="nv">proxy_cache</span> $<span class="nv">key</span><span class="c1">;</span>
        }
}


<span class="nv">repo</span>文件
[<span class="nv">iTV</span>]
<span class="nv">name</span><span class="o">=</span><span class="nv">iTV</span>
<span class="nv">baseurl</span><span class="o">=</span><span class="nv">http</span>:<span class="o">//</span><span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">41</span>.<span class="mi">21</span><span class="o">/</span><span class="nv">itv</span><span class="o">/</span>$<span class="nv">releasever</span><span class="o">/</span><span class="mh">$ba</span><span class="nv">search</span><span class="o">/</span>
<span class="nv">enabled</span><span class="o">=</span><span class="mi">1</span>
<span class="nv">gpgcheck</span><span class="o">=</span><span class="mi">0</span>

[<span class="nv">iTV</span><span class="o">-</span><span class="nv">base</span>]
<span class="nv">name</span><span class="o">=</span><span class="nv">iTV</span><span class="o">-</span><span class="nv">base</span>
<span class="nv">baseurl</span><span class="o">=</span><span class="nv">http</span>:<span class="o">//</span><span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">41</span>.<span class="mi">21</span><span class="o">/</span><span class="nv">base</span><span class="o">/</span>$<span class="nv">releasever</span><span class="o">/</span><span class="nv">os</span><span class="o">/</span><span class="mh">$ba</span><span class="nv">search</span><span class="o">/</span>
<span class="nv">enabled</span><span class="o">=</span><span class="mi">1</span>
<span class="nv">gpgcheck</span><span class="o">=</span><span class="mi">0</span>


[<span class="nv">iTV</span><span class="o">-</span><span class="nv">updates</span>]
<span class="nv">name</span><span class="o">=</span><span class="nv">iTV</span><span class="o">-</span><span class="nv">updates</span>
<span class="nv">baseurl</span><span class="o">=</span><span class="nv">http</span>:<span class="o">//</span><span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">41</span>.<span class="mi">21</span><span class="o">/</span><span class="nv">base</span><span class="o">/</span>$<span class="nv">releasever</span><span class="o">/</span><span class="nv">updates</span><span class="o">/</span><span class="mh">$ba</span><span class="nv">search</span><span class="o">/</span>
<span class="nv">enabled</span><span class="o">=</span><span class="mi">1</span>
<span class="nv">gpgcheck</span><span class="o">=</span><span class="mi">0</span>

[<span class="nv">iTV</span><span class="o">-</span><span class="nv">extras</span>]
<span class="nv">name</span><span class="o">=</span><span class="nv">iTV</span><span class="o">-</span><span class="nv">extras</span>
<span class="nv">baseurl</span><span class="o">=</span><span class="nv">http</span>:<span class="o">//</span><span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">41</span>.<span class="mi">21</span><span class="o">/</span><span class="nv">base</span><span class="o">/</span>$<span class="nv">releasever</span><span class="o">/</span><span class="nv">extras</span><span class="o">/</span><span class="mh">$ba</span><span class="nv">search</span><span class="o">/</span>
<span class="nv">enabled</span><span class="o">=</span><span class="mi">1</span>
<span class="nv">gpgcheck</span><span class="o">=</span><span class="mi">0</span>

[<span class="nv">iTV</span><span class="o">-</span><span class="nv">epel</span>]
<span class="nv">name</span><span class="o">=</span><span class="nv">iTV</span><span class="o">-</span><span class="nv">epel</span>
<span class="nv">baseurl</span><span class="o">=</span><span class="nv">http</span>:<span class="o">//</span><span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">41</span>.<span class="mi">21</span><span class="o">/</span><span class="nv">epel</span><span class="o">/</span>$<span class="nv">releasever</span><span class="o">/</span><span class="mh">$ba</span><span class="nv">search</span><span class="o">/</span>
<span class="nv">enabled</span><span class="o">=</span><span class="mi">1</span>
<span class="nv">gpgcheck</span><span class="o">=</span><span class="mi">0</span>
</pre></div>


<h2 id="sslh2">ssl和h2</h2>
<div class="codehilite"><pre><span></span># <span class="nv">rpm</span> <span class="o">-</span><span class="nv">ivh</span> <span class="nv">https</span>:<span class="o">//</span><span class="nv">nginx</span>.<span class="nv">org</span><span class="o">/</span><span class="nv">packages</span><span class="o">/</span><span class="nv">rhel</span><span class="o">/</span><span class="mi">7</span><span class="o">/</span><span class="nv">x86_64</span><span class="o">/</span><span class="nv">RPMS</span><span class="o">/</span><span class="nv">nginx</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">14</span>.<span class="mi">0</span><span class="o">-</span><span class="mi">1</span>.<span class="nv">el7_4</span>.<span class="nv">ngx</span>.<span class="nv">x86_64</span>.<span class="nv">rpm</span>
# <span class="nv">wget</span> <span class="nv">https</span>:<span class="o">//</span><span class="nv">raw</span>.<span class="nv">githubusercontent</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">Neilpang</span><span class="o">/</span><span class="nv">acme</span>.<span class="nv">sh</span><span class="o">/</span><span class="nv">master</span><span class="o">/</span><span class="nv">acme</span>.<span class="nv">sh</span>
# <span class="nv">sh</span> <span class="nv">acme</span>.<span class="nv">sh</span> <span class="o">--</span><span class="nv">issue</span> <span class="o">-</span><span class="nv">d</span> <span class="o">*</span>.<span class="nv">zxdr</span>.<span class="nv">tk</span> <span class="o">-</span><span class="nv">d</span> <span class="nv">zxdr</span>.<span class="nv">tk</span> <span class="o">--</span><span class="nv">dns</span> <span class="o">--</span><span class="nv">yes</span><span class="o">-</span><span class="nv">I</span><span class="o">-</span><span class="nv">know</span><span class="o">-</span><span class="nv">dns</span><span class="o">-</span><span class="nv">manual</span><span class="o">-</span><span class="nv">mode</span><span class="o">-</span><span class="nv">enough</span><span class="o">-</span><span class="nv">go</span><span class="o">-</span><span class="nv">ahead</span><span class="o">-</span><span class="nv">please</span> # <span class="nv">add</span> <span class="nv">dns</span> <span class="nv">record</span>
# <span class="nv">sh</span> <span class="nv">acme</span>.<span class="nv">sh</span> <span class="o">--</span><span class="nv">issue</span> <span class="o">-</span><span class="nv">d</span> <span class="o">*</span>.<span class="nv">zxdr</span>.<span class="nv">tk</span> <span class="o">-</span><span class="nv">d</span> <span class="nv">zxdr</span>.<span class="nv">tk</span> <span class="o">--</span><span class="nv">dns</span> <span class="o">--</span><span class="nv">yes</span><span class="o">-</span><span class="nv">I</span><span class="o">-</span><span class="nv">know</span><span class="o">-</span><span class="nv">dns</span><span class="o">-</span><span class="nv">manual</span><span class="o">-</span><span class="nv">mode</span><span class="o">-</span><span class="nv">enough</span><span class="o">-</span><span class="nv">go</span><span class="o">-</span><span class="nv">ahead</span><span class="o">-</span><span class="nv">please</span> <span class="o">--</span><span class="nv">renew</span>
<span class="nv">user</span>  <span class="nv">nobody</span><span class="c1">;</span>
<span class="nv">worker_processes</span>  <span class="nv">auto</span><span class="c1">;</span>
<span class="nv">events</span> {
    <span class="nv">use</span> <span class="nv">epoll</span><span class="c1">;</span>
    <span class="nv">accept_mutex</span> <span class="nv">off</span><span class="c1">;</span>
    <span class="nv">worker_connections</span>  <span class="mi">65536</span><span class="c1">;</span>
}
<span class="nv">http</span> {
    <span class="k">include</span>       <span class="nv">mime</span>.<span class="nv">types</span><span class="c1">;</span>
    <span class="nv">default_type</span>  <span class="nv">application</span><span class="o">/</span><span class="nv">octet</span><span class="o">-</span><span class="nv">stream</span><span class="c1">;</span>
    <span class="k">sendfile</span>        <span class="nv">on</span><span class="c1">;</span>
    <span class="nv">keepalive_timeout</span>  <span class="mi">65</span><span class="c1">;</span>
    <span class="nv">gzip</span>  <span class="nv">on</span><span class="c1">;</span>
    <span class="nv">server_tokens</span>  <span class="nv">off</span><span class="c1">;</span>

    <span class="nv">map</span> $<span class="nv">http_upgrade</span> <span class="mh">$c</span><span class="nv">onnection_upgrade</span> {
    <span class="nv">default</span> <span class="nv">upgrade</span><span class="c1">;</span>
    <span class="s1">&#39;&#39;</span> <span class="nv">close</span><span class="c1">;</span>
    }
    #<span class="nv">server</span> { <span class="nv">listen</span> <span class="mi">80</span> <span class="nv">default</span><span class="c1">; location / { root html; } }</span>
    <span class="nv">server</span> {
    <span class="nv">listen</span> <span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">0</span>:<span class="mi">443</span> <span class="nv">ssl</span> <span class="nv">http2</span> <span class="nv">default</span><span class="c1">;</span>
    <span class="nv">ssl</span> <span class="nv">on</span><span class="c1">;</span>
    <span class="nv">ssl_certificate</span> <span class="o">/</span><span class="nv">root</span><span class="o">/</span>.<span class="nv">acme</span>.<span class="nv">sh</span><span class="cm">/*.zxdr.tk/fullchain.cer;</span>
<span class="cm">    ssl_certificate_key /root/.acme.sh/*.zxdr.tk/*.zxdr.tk.key;</span>
<span class="cm">    ssl_session_timeout 1d;</span>
<span class="cm">        ssl_session_cache shared:SSL:50m;</span>
<span class="cm">        ssl_session_tickets off;</span>
<span class="cm">    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span>
<span class="cm">    ssl_ciphers &#39;ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256&#39;;</span>
<span class="cm">        ssl_prefer_server_ciphers on;</span>
<span class="cm">    add_header Strict-Transport-Security max-age=15768000;</span>
<span class="cm">    ssl_stapling on;</span>
<span class="cm">        ssl_stapling_verify on;</span>
<span class="cm">    resolver 8.8.8.8;</span>

<span class="cm">    location / {</span>
<span class="cm">                alias /tmp/down/;</span>
<span class="cm">                autoindex on;</span>
<span class="cm">        charset utf-8;</span>
<span class="cm">        autoindex_localtime on;</span>
<span class="cm">            autoindex_exact_size off;</span>
<span class="cm">        add_before_body /.nginx/header.html;</span>
<span class="cm">                add_after_body /.nginx/footer.html;</span>
<span class="cm">        }</span>

<span class="cm">    location /co/ {</span>
<span class="cm">        proxy_pass http://127.0.0.1:9090;</span>
<span class="cm">            proxy_http_version 1.1;</span>
<span class="cm">            proxy_buffering off;</span>
<span class="cm">            proxy_set_header X-Real-IP  $remote_addr;</span>
<span class="cm">            proxy_set_header Host $host;</span>
<span class="cm">            proxy_set_header X-Forwarded-For $remote_addr;</span>
<span class="cm">            proxy_set_header Upgrade $http_upgrade;</span>
<span class="cm">            proxy_set_header Connection $connection_upgrade;</span>
<span class="cm">            proxy_set_header Origin http://$host;</span>
<span class="cm">            #gzip off;</span>
<span class="cm">    }</span>

<span class="cm">    location /test/ {</span>
<span class="cm">        proxy_redirect off;</span>
<span class="cm">        proxy_pass http://127.0.0.1:7923;</span>
<span class="cm">        proxy_http_version 1.1;</span>
<span class="cm">        proxy_set_header Upgrade $http_upgrade;</span>
<span class="cm">        proxy_set_header Connection &quot;upgrade&quot;;</span>
<span class="cm">        proxy_set_header Host $http_host;</span>
<span class="cm">        proxy_intercept_errors on;</span>
<span class="cm">    }</span>
<span class="cm">    location /stat {</span>
<span class="cm">                stub_status on;</span>
<span class="cm">        }</span>
<span class="cm">        error_page  400 500 502 503 504  /50x.html;</span>
<span class="cm">        location = /50x.html {</span>
<span class="cm">                root   /usr/share/nginx/html;</span>
<span class="cm">        }</span>
<span class="cm">    }</span>
<span class="cm">}</span>
</pre></div>


<h2 id="_3">跨域</h2>
<div class="codehilite"><pre><span></span><span class="nv">add_header</span> <span class="nv">Access</span><span class="o">-</span><span class="nv">Control</span><span class="o">-</span><span class="nv">Allow</span><span class="o">-</span><span class="nv">Origin</span> <span class="o">*</span><span class="c1">;</span>
<span class="nv">location</span> <span class="o">/</span> {
    <span class="k">if</span> <span class="ss">(</span>$<span class="nv">request_method</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">OPTIONS</span><span class="s1">&#39;</span><span class="ss">)</span> { 
        <span class="nv">add_header</span> <span class="nv">Access</span><span class="o">-</span><span class="nv">Control</span><span class="o">-</span><span class="nv">Allow</span><span class="o">-</span><span class="nv">Origin</span> <span class="o">*</span><span class="c1">; </span>
        <span class="nv">add_header</span> <span class="nv">Access</span><span class="o">-</span><span class="nv">Control</span><span class="o">-</span><span class="nv">Allow</span><span class="o">-</span><span class="nv">Methods</span> <span class="nv">GET</span>,<span class="nv">POST</span>,<span class="nv">PUT</span>,<span class="nv">DELETE</span>,<span class="nv">OPTIONS</span><span class="c1">;</span>
        <span class="k">return</span> <span class="mi">204</span><span class="c1">; </span>
    }
    <span class="nv">index</span> <span class="nv">index</span>.<span class="nv">php</span><span class="c1">;</span>
    <span class="nv">try_files</span> $<span class="nv">uri</span> @<span class="nv">rewriteapp</span><span class="c1">;</span>
}
</pre></div>


<h2 id="openresty">openresty</h2>
<p>https://openresty.org/package/centos/openresty.repo</p>
<div class="codehilite"><pre><span></span><span class="k">[openresty]</span>
<span class="na">name</span><span class="o">=</span><span class="s">Official OpenResty Open Source Repository for CentOS</span>
<span class="na">baseurl</span><span class="o">=</span><span class="s">https://openresty.org/package/centos/$releasever/$basearch</span>
<span class="na">skip_if_unavailable</span><span class="o">=</span><span class="s">False</span>
<span class="na">gpgcheck</span><span class="o">=</span><span class="s">1</span>
<span class="na">repo_gpgcheck</span><span class="o">=</span><span class="s">1</span>
<span class="na">gpgkey</span><span class="o">=</span><span class="s">https://openresty.org/package/pubkey.gpg</span>
<span class="na">enabled</span><span class="o">=</span><span class="s">1</span>
<span class="na">enabled_metadata</span><span class="o">=</span><span class="s">1</span>
</pre></div>


<h2 id="proxyip">proxy获取真实ip</h2>
<div class="codehilite"><pre><span></span><span class="nv">upstream</span> <span class="nv">www</span>.<span class="mi">264</span>.<span class="nv">cn</span> {
    <span class="nv">ip_hash</span><span class="c1">;</span>
    <span class="nv">server</span> <span class="nv">serving</span><span class="o">-</span><span class="nv">server1</span>.<span class="nv">com</span>:<span class="mi">80</span><span class="c1">;</span>
    <span class="nv">server</span> <span class="nv">serving</span><span class="o">-</span><span class="nv">server2</span>.<span class="nv">com</span>:<span class="mi">80</span><span class="c1">;</span>
}
<span class="nv">server</span> {
    <span class="nv">listen</span> <span class="nv">www</span>.<span class="mi">264</span>.<span class="nv">cn</span>:<span class="mi">80</span><span class="c1">;</span>
    <span class="nv">server_name</span> <span class="nv">www</span>.<span class="mi">264</span>.<span class="nv">cn</span><span class="c1">;</span>

    <span class="nv">location</span> <span class="o">/</span> {
        <span class="nv">proxy_pass</span> <span class="nv">http</span>:<span class="o">//</span><span class="nv">www</span>.<span class="mi">264</span>.<span class="nv">cn</span><span class="c1">;</span>
    }

    <span class="nv">proxy_set_header</span> <span class="nv">Host</span> $<span class="nv">host</span><span class="c1">;</span>
    <span class="nv">proxy_set_header</span> <span class="nv">X</span><span class="o">-</span><span class="nv">Real</span><span class="o">-</span><span class="nv">IP</span> $<span class="nv">remote_addr</span><span class="c1">;</span>
    <span class="nv">proxy_set_header</span> <span class="nv">X</span><span class="o">-</span><span class="nv">Forwarded</span><span class="o">-</span><span class="k">For</span> $<span class="nv">proxy_add_x_forwarded_for</span><span class="c1">;</span>

}
在<span class="nv">nginx</span>的配置文件中加入下面三个指令，这样后端<span class="nv">php</span>就可以使用$<span class="nv">_SERVER</span>[<span class="s1">&#39;</span><span class="s">HTTP_X_REAL_IP</span><span class="s1">&#39;</span>]获取到访客的<span class="nv">ip</span>。


<span class="nv">proxy_set_header</span> <span class="nv">Host</span> $<span class="nv">host</span><span class="c1">;</span>
<span class="nv">proxy_set_header</span> <span class="nv">X</span><span class="o">-</span><span class="nv">Real</span><span class="o">-</span><span class="nv">IP</span> $<span class="nv">remote_addr</span><span class="c1">;</span>
<span class="nv">proxy_set_header</span> <span class="nv">X</span><span class="o">-</span><span class="nv">Forwarded</span><span class="o">-</span><span class="k">For</span> $<span class="nv">proxy_add_x_forwarded_for</span><span class="c1">;</span>

如果你想使用$<span class="nv">_SERVER</span>[<span class="s1">&#39;</span><span class="s">REMOTE_ADDR</span><span class="s1">&#39;</span>]，不想修改代码，那么可以通过修改<span class="nv">REMOTE_ADDR</span>的值来实现。

经过多层代理后 $<span class="nv">http_x_forwared_for</span> 会含有多个<span class="nv">ip</span>，其中第一个<span class="nv">ip</span>是客户端的<span class="nv">ip</span>，<span class="nv">REMOTE_ADDR</span>只能是客户端的<span class="nv">ip</span>，
所以可以用正则提取 $<span class="nv">http_x_forwarded_for</span>的第一个<span class="nv">ip</span>给<span class="nv">REMOTE_ADDR</span>:


  <span class="nv">set</span> $<span class="nv">realip</span> $<span class="nv">remote_addr</span><span class="c1">;</span>
  <span class="k">if</span> <span class="ss">(</span>$<span class="nv">http_x_forwarded_for</span> <span class="o">~</span> <span class="s2">&quot;</span><span class="s">^(\d+\.\d+\.\d+\.\d+)</span><span class="s2">&quot;</span><span class="ss">)</span> {
    <span class="nv">set</span> $<span class="nv">realip</span> <span class="mh">$1</span><span class="c1">;</span>
  }
  <span class="nv">fastcgi_param</span> <span class="nv">REMOTE_ADDR</span> $<span class="nv">realip</span><span class="c1">;</span>
</pre></div>


<h2 id="php-fpm">php-fpm</h2>
<div class="codehilite"><pre><span></span><span class="nv">yum</span> <span class="nv">install</span> <span class="nv">php</span><span class="o">-</span><span class="nv">fpm</span>
<span class="nv">systemctl</span> <span class="nv">start</span> <span class="nv">php</span><span class="o">-</span><span class="nv">fpm</span>

        <span class="nv">root</span> <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">www</span><span class="c1">;</span>
        <span class="nv">location</span> <span class="o">/</span> {
              <span class="nv">index</span> <span class="nv">index</span>.<span class="nv">php</span><span class="c1">;</span>
        }
        <span class="nv">location</span> <span class="o">~</span> \.<span class="nv">php</span>$ {
              <span class="nv">fastcgi_pass</span> <span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span>:<span class="mi">9000</span><span class="c1">;</span>
              <span class="nv">fastcgi_index</span> <span class="nv">index</span>.<span class="nv">php</span><span class="c1">;</span>
              <span class="nv">fastcgi_param</span> <span class="nv">SCRIPT_FILENAME</span> <span class="mh">$d</span><span class="nv">ocument_root</span><span class="mh">$fa</span><span class="nv">stcgi_script_name</span><span class="c1">;</span>
              <span class="k">include</span> <span class="nv">fastcgi_params</span><span class="c1">;</span>
        }
</pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../nginx/" title="nginx" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                nginx
              </span>
            </div>
          </a>
        
        
          <a href="../apache/" title="apache" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                apache
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>