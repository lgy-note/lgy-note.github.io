



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>log-analysis - mkdocs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.30686662.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#elk" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="mkdocs" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              mkdocs
            </span>
            <span class="md-header-nav__topic">
              
                log-analysis
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href=".." class="md-tabs__link">
        home
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../python-base/" class="md-tabs__link">
          python
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../nginx/" class="md-tabs__link md-tabs__link--active">
          service
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../mysql/" class="md-tabs__link">
          database
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../open-falcon/" class="md-tabs__link">
          monitor
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../tcp-issue/" class="md-tabs__link">
          basis
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="mkdocs" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    mkdocs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="home" class="md-nav__link">
      home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      python
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        python
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../python-base/" title="python-base" class="md-nav__link">
      python-base
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-lib/" title="python-lib" class="md-nav__link">
      python-lib
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-lib2/" title="python-lib2" class="md-nav__link">
      python-lib2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-web/" title="python-web" class="md-nav__link">
      python-web
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-other/" title="python-other" class="md-nav__link">
      python-other
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      service
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        service
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../nginx/" title="nginx" class="md-nav__link">
      nginx
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../nginx2/" title="nginx2" class="md-nav__link">
      nginx2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../apache/" title="apache" class="md-nav__link">
      apache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../saltstack/" title="saltstack" class="md-nav__link">
      saltstack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tomcat/" title="tomcat" class="md-nav__link">
      tomcat
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ansible/" title="ansible" class="md-nav__link">
      ansible
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../trafficserver/" title="trafficserver" class="md-nav__link">
      trafficserver
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../haproxy/" title="haproxy" class="md-nav__link">
      haproxy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../docker/" title="docker" class="md-nav__link">
      docker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../varnish/" title="varnish" class="md-nav__link">
      varnish
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../bind/" title="bind" class="md-nav__link">
      bind
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lvs/" title="lvs" class="md-nav__link">
      lvs
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        log-analysis
      </label>
    
    <a href="./" title="log-analysis" class="md-nav__link md-nav__link--active">
      log-analysis
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#elk" class="md-nav__link">
    elk分析
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logstatsh-http" class="md-nav__link">
    logstatsh http
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoip" class="md-nav__link">
    geoip
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#elasticsearch" class="md-nav__link">
    elasticsearch
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logstash-grop" class="md-nav__link">
    logstash grop正则
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#awstats" class="md-nav__link">
    awstats
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    访问分析
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#es_date" class="md-nav__link">
    es_date
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logstash" class="md-nav__link">
    logstash区分数据
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#winlogbeat" class="md-nav__link">
    winlogbeat
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filebeat" class="md-nav__link">
    filebeat例子
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#elk_1" class="md-nav__link">
    elk优化
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logstash5-root" class="md-nav__link">
    logstash5 root启动
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#es" class="md-nav__link">
    es集群重启
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logio" class="md-nav__link">
    logio
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      database
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        database
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../mysql/" title="mysql" class="md-nav__link">
      mysql
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mysql2/" title="mysql2" class="md-nav__link">
      mysql2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../memcached/" title="memcached" class="md-nav__link">
      memcached
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../redis/" title="redis" class="md-nav__link">
      redis
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mongodb/" title="mongodb" class="md-nav__link">
      mongodb
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../hadoop/" title="hadoop" class="md-nav__link">
      hadoop
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../postgresql/" title="postgresql" class="md-nav__link">
      postgresql
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      monitor
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        monitor
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../open-falcon/" title="open-falcon" class="md-nav__link">
      open-falcon
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zabbix/" title="zabbix" class="md-nav__link">
      zabbix
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zabbix2/" title="zabbix2" class="md-nav__link">
      zabbix2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../netdata/" title="netdata" class="md-nav__link">
      netdata
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      basis
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        basis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../tcp-issue/" title="tcp-issue" class="md-nav__link">
      tcp-issue
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../git-svn/" title="git-svn" class="md-nav__link">
      git-svn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../vpn/" title="vpn" class="md-nav__link">
      vpn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../shell/" title="shell" class="md-nav__link">
      shell
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../disk/" title="disk" class="md-nav__link">
      disk
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../filesystem/" title="filesystem" class="md-nav__link">
      filesystem
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../source/" title="source" class="md-nav__link">
      source
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../command/" title="command" class="md-nav__link">
      command
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../linux-base/" title="linux-base" class="md-nav__link">
      linux-base
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../linux-soft/" title="linux-soft" class="md-nav__link">
      linux-soft
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../other/" title="other" class="md-nav__link">
      other
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#elk" class="md-nav__link">
    elk分析
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logstatsh-http" class="md-nav__link">
    logstatsh http
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#geoip" class="md-nav__link">
    geoip
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#elasticsearch" class="md-nav__link">
    elasticsearch
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logstash-grop" class="md-nav__link">
    logstash grop正则
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#awstats" class="md-nav__link">
    awstats
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    访问分析
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#es_date" class="md-nav__link">
    es_date
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logstash" class="md-nav__link">
    logstash区分数据
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#winlogbeat" class="md-nav__link">
    winlogbeat
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filebeat" class="md-nav__link">
    filebeat例子
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#elk_1" class="md-nav__link">
    elk优化
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logstash5-root" class="md-nav__link">
    logstash5 root启动
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#es" class="md-nav__link">
    es集群重启
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logio" class="md-nav__link">
    logio
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>log-analysis</h1>
                
                <h2 id="elk">elk分析</h2>
<div class="codehilite"><pre><span></span><span class="n">服务端</span><span class="w">    </span><span class="n">Kibana</span><span class="w"></span>
<span class="n">服务端或者独立</span><span class="w"> </span><span class="n">JDK</span><span class="w">  </span><span class="n">ElasticSearch</span><span class="w">  </span><span class="n">redis2</span><span class="mf">.6</span><span class="err">（</span><span class="n">数据队列</span><span class="err">）</span><span class="w"> </span><span class="n">Logstash</span><span class="err">（</span><span class="n">匹配分析数据</span><span class="err">）</span><span class="w"></span>
<span class="n">客户端</span><span class="w"> </span><span class="n">JDK</span><span class="w">   </span><span class="n">Logstash</span><span class="p">(</span><span class="n">导入数据用</span><span class="err">，</span><span class="n">安装一样</span><span class="err">，</span><span class="n">分离开减轻客户端压力</span><span class="p">)</span><span class="w"></span>
<span class="n">下载地址</span><span class="w"> </span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="p">.</span><span class="n">elastic</span><span class="p">.</span><span class="n">co</span><span class="o">/</span><span class="n">downloads</span><span class="w"></span>
<span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">mirrors</span><span class="p">.</span><span class="n">tuna</span><span class="p">.</span><span class="n">tsinghua</span><span class="p">.</span><span class="n">edu</span><span class="p">.</span><span class="n">cn</span><span class="o">/</span><span class="n">ELK</span><span class="o">/</span><span class="w">  </span><span class="n">国内源</span><span class="w"></span>

<span class="n">ElasticSearch和Logstash依赖于JDK</span><span class="err">，</span><span class="n">所以需要安装JDK</span><span class="err">：</span><span class="w"></span>
<span class="n">yum</span><span class="w"> </span><span class="o">-</span><span class="n">y</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">java</span><span class="o">-</span><span class="mf">1.8.0</span><span class="o">-</span><span class="n">openjdk</span><span class="w"> </span><span class="n">java</span><span class="o">-</span><span class="mf">1.8.0</span><span class="o">-</span><span class="n">openjdk</span><span class="o">-</span><span class="n">devel</span><span class="w"></span>
<span class="n">java</span><span class="w"> </span><span class="o">-</span><span class="n">version</span><span class="w"></span>

<span class="n">redis</span><span class="w"> </span><span class="n">源码编译安装2</span><span class="mf">.6</span><span class="n">以上版本</span><span class="w"> </span>

<span class="n">Logstash安装</span><span class="w"></span>
<span class="nl">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="p">.</span><span class="k">open</span><span class="o">-</span><span class="k">open</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="k">view</span><span class="o">/</span><span class="n">open1473661753307</span><span class="p">.</span><span class="n">html</span><span class="w"></span>
<span class="n">Logstash默认的对外服务的端口是9292</span><span class="err">。</span><span class="w"></span>
<span class="n">rpm</span><span class="w"> </span><span class="o">-</span><span class="n">ivh</span><span class="w"> </span><span class="n">logstash</span><span class="o">-</span><span class="mf">2.0.0</span><span class="o">-</span><span class="mf">1.</span><span class="n">noarch</span><span class="p">.</span><span class="n">rpm</span><span class="w"></span>
<span class="n">测试</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">logstash</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">logstash</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="s1">&#39;input{stdin{}}output{stdout{codec=&gt;rubydebug}}&#39;</span><span class="w"></span>
<span class="n">输入hello</span><span class="w"> </span><span class="n">world</span><span class="w"></span>


<span class="n">vim</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">logstash</span><span class="o">/</span><span class="n">conf</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">agent</span><span class="p">.</span><span class="n">conf</span><span class="w"></span>

<span class="k">input</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">   </span><span class="k">file</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">     </span><span class="n">type</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="ss">&quot;ugo_nginx_access&quot;</span><span class="w">   </span><span class="n">##日志文件类型</span><span class="p">,</span><span class="n">自定义</span><span class="err">。</span><span class="n">好区分</span><span class="err">，</span><span class="n">类似于分组这种概念</span><span class="w"></span>
<span class="w">     </span><span class="k">path</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="ss">&quot;/export1/log/access_20150407+00.log&quot;</span><span class="w">  </span><span class="n">##日志文件路径</span><span class="err">。</span><span class="w"></span>
<span class="w">   </span><span class="err">}</span><span class="w"></span>
<span class="w">   </span><span class="k">file</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">     </span><span class="n">type</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="ss">&quot;nginx_access&quot;</span><span class="w"></span>
<span class="w">     </span><span class="k">path</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="ss">&quot;/usr/local/nginx/logs/python-access.log&quot;</span><span class="w"></span>
<span class="w">   </span><span class="err">}</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>
<span class="k">output</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">  </span><span class="n">#将收集到的日志存储到了redis中</span><span class="err">。</span><span class="w"></span>
<span class="w">  </span><span class="n">redis</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">    </span><span class="k">host</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="ss">&quot;103.41.54.16&quot;</span><span class="w">   </span>
<span class="w">    </span><span class="n">port</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="mi">6379</span><span class="w"></span>
<span class="w">    </span><span class="n">data_type</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="ss">&quot;list&quot;</span><span class="w"></span>
<span class="w">    </span><span class="k">key</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="ss">&quot;logstash&quot;</span><span class="w"></span>
<span class="w">  </span><span class="err">}</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>

<span class="n">启动</span><span class="w"> </span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">logstash</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">logstash</span><span class="w"> </span><span class="n">agent</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">logstash</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">agent</span><span class="p">.</span><span class="n">conf</span><span class="w">   </span><span class="n">有时候服务启动没有数据</span><span class="w"></span>

<span class="n">server</span><span class="w"></span>
<span class="n">grok匹配测试</span><span class="w">  </span><span class="nl">http</span><span class="p">:</span><span class="o">//</span><span class="n">grokdebug</span><span class="p">.</span><span class="n">herokuapp</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="w"></span>

<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">logstash</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">logstash</span><span class="w"> </span><span class="n">agent</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">logstash</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">fserver</span><span class="p">.</span><span class="n">conf</span><span class="w"></span>
<span class="k">input</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">    </span><span class="n">redis</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">        </span><span class="k">host</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="ss">&quot;127.0.0.1&quot;</span><span class="w"></span>
<span class="w">        </span><span class="n">port</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="ss">&quot;6379&quot;</span><span class="w"></span>
<span class="w">        </span><span class="n">data_type</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="ss">&quot;list&quot;</span><span class="w"></span>
<span class="w">        </span><span class="k">key</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="ss">&quot;logstash&quot;</span><span class="w"></span>
<span class="w">        </span><span class="n">type</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="ss">&quot;redis-input&quot;</span><span class="w"></span>
<span class="w">    </span><span class="err">}</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>

<span class="k">filter</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">    </span><span class="n">grok</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="ss">&quot;message&quot;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="ss">&quot;%{COMBINEDAPACHELOG} %{QS:x_forwarded_for}&quot;</span><span class="w"> </span><span class="err">}</span><span class="w">   </span><span class="n">nginx日志匹配</span><span class="w"></span>
<span class="w">    </span><span class="err">}</span><span class="w"></span>
<span class="w">    </span><span class="n">geoip</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">      </span><span class="n">source</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="ss">&quot;clientip&quot;</span><span class="w"></span>
<span class="w">      </span><span class="n">target</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="ss">&quot;geoip&quot;</span><span class="w"></span>
<span class="w">      </span><span class="k">database</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="ss">&quot;/opt/logstash/GeoLiteCity.dat&quot;</span><span class="w"></span>
<span class="w">      </span><span class="n">add_field</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">[</span><span class="n"> &quot;[geoip</span><span class="o">][</span><span class="n">coordinates</span><span class="o">]</span><span class="ss">&quot;, &quot;</span><span class="o">%</span><span class="err">{</span><span class="o">[</span><span class="n">geoip</span><span class="o">][</span><span class="n">longitude</span><span class="o">]</span><span class="err">}</span><span class="ss">&quot; ]</span>
<span class="ss">      add_field =&gt; [ &quot;</span><span class="o">[</span><span class="n">geoip</span><span class="o">][</span><span class="n">coordinates</span><span class="o">]</span><span class="ss">&quot;, &quot;</span><span class="o">%</span><span class="err">{</span><span class="o">[</span><span class="n">geoip</span><span class="o">][</span><span class="n">latitude</span><span class="o">]</span><span class="err">}</span><span class="ss">&quot; ]</span>
<span class="ss">    }</span>

<span class="ss">    mutate {</span>
<span class="ss">      convert =&gt; [ &quot;</span><span class="o">[</span><span class="n">geoip</span><span class="o">][</span><span class="n">coordinates</span><span class="o">]</span><span class="ss">&quot;, &quot;</span><span class="nc">float</span><span class="ss">&quot; ]</span>
<span class="ss">      convert =&gt; [ &quot;</span><span class="n">response</span><span class="ss">&quot;,&quot;</span><span class="k">integer</span><span class="ss">&quot; ]</span>
<span class="ss">      convert =&gt; [ &quot;</span><span class="n">bytes</span><span class="ss">&quot;,&quot;</span><span class="k">integer</span><span class="ss">&quot; ]</span>
<span class="ss">      replace =&gt; { &quot;</span><span class="n">type</span><span class="ss">&quot; =&gt; &quot;</span><span class="n">nginx_access</span><span class="ss">&quot; }</span>
<span class="ss">      remove_field =&gt; &quot;</span><span class="n">message</span><span class="ss">&quot;</span>
<span class="ss">    }</span>

<span class="ss">    date {</span>
<span class="ss">      match =&gt; [ &quot;</span><span class="nc">timestamp</span><span class="ss">&quot;,&quot;</span><span class="n">dd</span><span class="o">/</span><span class="n">MMM</span><span class="o">/</span><span class="nl">yyyy</span><span class="p">:</span><span class="nl">HH</span><span class="p">:</span><span class="nl">mm</span><span class="p">:</span><span class="n">ss</span><span class="w"> </span><span class="n">Z</span><span class="ss">&quot;]</span>

<span class="ss">    }</span>
<span class="ss">    mutate {</span>
<span class="ss">      remove_field =&gt; &quot;</span><span class="nc">timestamp</span><span class="ss">&quot;</span>

<span class="ss">    }</span>


<span class="ss">}</span>
<span class="ss">output {</span>
<span class="ss">    elasticsearch {</span>
<span class="ss">        hosts =&gt; [&quot;</span><span class="mf">127.0.0.1</span><span class="err">:</span><span class="mi">9200</span><span class="ss">&quot;]</span>
<span class="ss">        manage_template =&gt; true   可以使用模板匹配地区，geoip，</span>
<span class="ss">        # http://blog.csdn.net/yanggd1987/article/details/50469113</span>
<span class="ss">        index =&gt; &quot;</span><span class="n">logstash</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">access</span><span class="o">-%</span><span class="err">{</span><span class="o">+</span><span class="n">YYYY</span><span class="p">.</span><span class="n">MM</span><span class="p">.</span><span class="n">dd</span><span class="err">}</span><span class="ss">&quot;</span>
<span class="ss">    }</span>
<span class="ss">    stdout {codec =&gt; rubydebug}</span>
<span class="ss">}</span>


<span class="ss"> ##这个命令的意义就是，删除 logstash 2015年4月的所有文件。</span>
<span class="ss">curl -XDELETE &#39;http://10.1.1.99:9200/logstash-2015.04.*</span>

<span class="ss">ElasticSearch 安装</span>
<span class="ss">ElasticSearch默认的对外服务的HTTP端口是9200，节点间交互的TCP端口是9300。</span>
<span class="ss">rpm -ivh elasticsearch-2.0.0.rpm</span>
<span class="ss">vim /etc/elasticsearch/elasticsearch.yml 添加</span>
<span class="ss">node.name: node-1</span>
<span class="ss">network.host: 0.0.0.0</span>
<span class="ss">path.data: /data/elasticsearch/</span>
<span class="ss">http.port: 9200</span>

<span class="ss">mkdir -pv /data/elasticsearch</span>
<span class="ss">chown -R elasticsearch.elasticsearch /data/elasticsearch/</span>
<span class="ss">/etc/init.d/elasticsearch start</span>

<span class="ss">测试ElasticSearch服务是否正常，预期返回200的状态码：</span>
<span class="ss">curl -X GET http://localhost:9200</span>
<span class="ss">head插件</span>
<span class="ss">wget https://github.com/mobz/elasticsearch-head/archive/master.zip</span>
<span class="ss">unzip master.zip</span>
<span class="ss">mv elasticsearch-head-master/ /usr/share/elasticsearch/plugins/head/</span>
<span class="ss">http://112.126.80.182:9200/_plugin/head/</span>

<span class="ss">初始化数据集，为了保证上报事件的时间戳被正常识别为日期格式</span>
<span class="ss">curl -XPUT http://localhost:9200/logstash-qos -d &#39;       索引地址固定的，需要先map，在导入数据</span>
<span class="ss">{</span>
<span class="ss"> &quot;</span><span class="n">mappings</span><span class="ss">&quot; : {</span>
<span class="ss">  &quot;</span><span class="n">_default_</span><span class="ss">&quot; : {</span>
<span class="ss">   &quot;</span><span class="n">properties</span><span class="ss">&quot; : {</span>
<span class="ss">    &quot;</span><span class="nc">timestamp</span><span class="ss">&quot;:{&quot;</span><span class="n">type</span><span class="ss">&quot;:&quot;</span><span class="nc">date</span><span class="err">&quot;}</span><span class="w"></span>
<span class="w">   </span><span class="err">}</span><span class="w"></span>
<span class="w">  </span><span class="err">}</span><span class="w"></span>
<span class="w"> </span><span class="err">}</span><span class="w"></span>
<span class="err">}&#39;</span><span class="p">;</span><span class="w"></span>


<span class="n">Kibana安装</span><span class="w"></span>
<span class="n">tar</span><span class="w"> </span><span class="o">-</span><span class="n">zxf</span><span class="w"> </span><span class="n">kibana</span><span class="o">-</span><span class="mf">4.2.0</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x64</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span><span class="w"></span>
<span class="n">vim</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">kibana</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">kibana</span><span class="p">.</span><span class="n">yml</span><span class="w"> </span><span class="n">修改</span><span class="w"></span>
<span class="n">elasticsearch</span><span class="p">.</span><span class="nl">url</span><span class="p">:</span><span class="w"> </span><span class="nl">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168.1.23</span><span class="err">:</span><span class="mi">9200</span><span class="w"></span>
<span class="n">运行</span><span class="p">.</span><span class="o">/</span><span class="n">kibana</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">kibana</span><span class="w"></span>

<span class="n">kibana</span><span class="w"> </span><span class="n">分析报错</span><span class="err">：</span><span class="nl">http</span><span class="p">:</span><span class="o">//</span><span class="n">elasticsearch</span><span class="p">.</span><span class="n">cn</span><span class="o">/</span><span class="n">question</span><span class="o">/</span><span class="mi">232</span><span class="w"></span>





<span class="n">扩展</span><span class="w"></span>
<span class="nl">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="mf">.99</span><span class="n">ya</span><span class="p">.</span><span class="n">net</span><span class="o">/</span><span class="n">archives</span><span class="o">/</span><span class="mf">523.</span><span class="n">html</span><span class="err">（</span><span class="n">亿万级日志数据实时分析平台</span><span class="err">）</span><span class="w"></span>
</pre></div>


<h2 id="logstatsh-http">logstatsh http</h2>
<div class="codehilite"><pre><span></span><span class="nl">https</span><span class="p">:</span><span class="c1">//www.elastic.co/blog/introducing-logstash-input-http-plugin</span>

<span class="n">How</span> <span class="k">do</span> <span class="n">I</span> <span class="n">use</span> <span class="n">this</span> <span class="n">plugin</span><span class="o">?</span>

<span class="n">By</span> <span class="k">default</span> <span class="n">it</span> <span class="n">will</span> <span class="n">bind</span> <span class="n">the</span> <span class="n">webserver</span> <span class="n">to</span> <span class="n">all</span> <span class="n">hosts</span> <span class="p">(</span><span class="s">&quot;0.0.0.0&quot;</span><span class="p">)</span> <span class="n">and</span> <span class="n">open</span> <span class="n">the</span> <span class="n">TCP</span> <span class="n">port</span> <span class="mi">8080</span> <span class="n">but</span> <span class="n">it</span><span class="err">&#39;</span><span class="n">s</span>
 <span class="n">possible</span> <span class="n">configure</span> <span class="n">these</span> <span class="nl">settings</span><span class="p">:</span>

<span class="n">input</span> <span class="p">{</span>
  <span class="n">http</span> <span class="p">{</span>
    <span class="n">host</span> <span class="o">=&gt;</span> <span class="s">&quot;127.0.0.1&quot;</span> <span class="err">#</span> <span class="k">default</span><span class="o">:</span> <span class="mf">0.0.0.0</span>
    <span class="n">port</span> <span class="o">=&gt;</span> <span class="mi">31311</span> <span class="err">#</span> <span class="k">default</span><span class="o">:</span> <span class="mi">8080</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="n">That</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">all</span> <span class="n">you</span> <span class="n">need</span><span class="o">!</span>

<span class="n">What</span> <span class="n">about</span> <span class="n">security</span><span class="o">?</span>
<span class="n">You</span> <span class="n">can</span> <span class="n">configure</span> <span class="n">basic</span> <span class="n">authentication</span> <span class="n">by</span> <span class="n">setting</span> <span class="n">a</span> <span class="n">username</span> <span class="n">and</span> <span class="n">password</span><span class="p">.</span> <span class="n">All</span> <span class="n">requests</span> <span class="n">done</span> <span class="n">to</span> <span class="n">Logstash</span>
<span class="n">will</span> <span class="n">then</span> <span class="n">have</span> <span class="n">to</span> <span class="n">set</span> <span class="n">the</span> <span class="n">right</span> <span class="n">credentials</span> <span class="n">or</span> <span class="n">receive</span> <span class="n">a</span> <span class="mi">401</span> <span class="n">response</span><span class="p">.</span> <span class="n">Only</span> <span class="n">correctly</span> <span class="n">authenticated</span> <span class="n">requests</span>
 <span class="n">will</span> <span class="n">produce</span> <span class="n">an</span> <span class="n">event</span> <span class="n">inside</span> <span class="n">of</span> <span class="n">Logstash</span><span class="p">.</span> <span class="n">For</span> <span class="n">SSL</span><span class="p">,</span> <span class="n">it</span> <span class="n">is</span> <span class="n">necessary</span> <span class="n">to</span> <span class="n">specify</span> <span class="n">the</span> <span class="n">path</span> <span class="n">to</span> <span class="n">a</span> <span class="n">Java</span> <span class="n">Keystore</span> 
 <span class="n">that</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">certificate</span> <span class="n">that</span> <span class="n">clients</span> <span class="n">use</span> <span class="n">to</span> <span class="n">validate</span> <span class="n">the</span> <span class="n">server</span><span class="p">.</span> <span class="n">Here</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">an</span> <span class="nl">example</span><span class="p">:</span>

<span class="n">input</span> <span class="p">{</span>
   <span class="n">port</span> <span class="o">=&gt;</span> <span class="mi">3332</span>
   <span class="n">user</span> <span class="o">=&gt;</span> <span class="n">myuser</span>
   <span class="n">password</span> <span class="o">=&gt;</span> <span class="s">&quot;$tr0ngP4ssWD!&quot;</span>
   <span class="n">ssl</span> <span class="o">=&gt;</span> <span class="n">on</span>
   <span class="n">keystore</span> <span class="o">=&gt;</span> <span class="s">&quot;/tmp/mykeystore.jks&quot;</span>
   <span class="n">keystore_password</span> <span class="o">=&gt;</span> <span class="s">&quot;keystore_pass&quot;</span>
<span class="p">}</span>


<span class="n">OK</span><span class="p">,</span> <span class="n">now</span> <span class="n">show</span> <span class="n">me</span> <span class="n">this</span> <span class="n">plugin</span> <span class="k">in</span> <span class="n">action</span><span class="o">!</span>

<span class="n">Step</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">starting</span> <span class="n">Logstash</span> <span class="n">with</span> <span class="n">http</span> <span class="nl">input</span><span class="p">:</span>

<span class="n">bin</span><span class="o">/</span><span class="n">logstash</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;input { http { } } output { stdout { codec =&gt; rubydebug} }&quot;</span>
<span class="n">Step</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">That</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">it</span><span class="o">!</span>

<span class="n">To</span> <span class="n">test</span> <span class="n">it</span><span class="p">,</span> <span class="n">let</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">issue</span> <span class="n">two</span> <span class="nl">requests</span><span class="p">:</span>

<span class="o">%</span> <span class="n">curl</span> <span class="o">-</span><span class="n">XPUT</span> <span class="err">&#39;</span><span class="nl">http</span><span class="p">:</span><span class="c1">//127.0.0.1:8080/twitter/tweet/1&#39; -d &#39;hello&#39;                               </span>
<span class="o">%</span> <span class="n">curl</span> <span class="o">-</span><span class="n">H</span> <span class="s">&quot;content-type: application/json&quot;</span> <span class="o">-</span><span class="n">XPUT</span> <span class="err">&#39;</span><span class="nl">http</span><span class="p">:</span><span class="c1">//127.0.0.1:8080/twitter/tweet/1&#39; -d &#39;{</span>
    <span class="s">&quot;user&quot;</span> <span class="o">:</span> <span class="s">&quot;kimchy&quot;</span><span class="p">,</span>
    <span class="s">&quot;post_date&quot;</span> <span class="o">:</span> <span class="s">&quot;2009-11-15T14:12:12&quot;</span><span class="p">,</span>
    <span class="s">&quot;message&quot;</span> <span class="o">:</span> <span class="s">&quot;trying out Elasticsearch&quot;</span>
<span class="p">}</span><span class="err">&#39;</span>
<span class="n">Result</span> <span class="k">in</span> <span class="nl">Logstash</span><span class="p">:</span>

<span class="p">{</span>
       <span class="s">&quot;message&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;hello&quot;</span><span class="p">,</span>
      <span class="s">&quot;@version&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;1&quot;</span><span class="p">,</span>
    <span class="s">&quot;@timestamp&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;2015-05-29T14:49:00.392Z&quot;</span><span class="p">,</span>
       <span class="s">&quot;headers&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span>
           <span class="s">&quot;content_type&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;application/x-www-form-urlencoded&quot;</span><span class="p">,</span>
         <span class="s">&quot;request_method&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;PUT&quot;</span><span class="p">,</span>
           <span class="s">&quot;request_path&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;/twitter/tweet/1&quot;</span><span class="p">,</span>
            <span class="s">&quot;request_uri&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;/twitter/tweet/1&quot;</span><span class="p">,</span>
           <span class="s">&quot;http_version&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;HTTP/1.1&quot;</span><span class="p">,</span>
        <span class="s">&quot;http_user_agent&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;curl/7.37.1&quot;</span><span class="p">,</span>
              <span class="s">&quot;http_host&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;127.0.0.1:8080&quot;</span><span class="p">,</span>
            <span class="s">&quot;http_accept&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;*/*&quot;</span><span class="p">,</span>
         <span class="s">&quot;content_length&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;5&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="p">{</span>
          <span class="s">&quot;user&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;kimchy&quot;</span><span class="p">,</span>
     <span class="s">&quot;post_date&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;2009-11-15T14:12:12&quot;</span><span class="p">,</span>
       <span class="s">&quot;message&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;trying out Elasticsearch&quot;</span><span class="p">,</span>
      <span class="s">&quot;@version&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;1&quot;</span><span class="p">,</span>
    <span class="s">&quot;@timestamp&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;2015-05-29T14:49:04.105Z&quot;</span><span class="p">,</span>
       <span class="s">&quot;headers&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span>
           <span class="s">&quot;content_type&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;application/json&quot;</span><span class="p">,</span>
         <span class="s">&quot;request_method&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;PUT&quot;</span><span class="p">,</span>
           <span class="s">&quot;request_path&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;/twitter/tweet/1&quot;</span><span class="p">,</span>
            <span class="s">&quot;request_uri&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;/twitter/tweet/1&quot;</span><span class="p">,</span>
           <span class="s">&quot;http_version&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;HTTP/1.1&quot;</span><span class="p">,</span>
        <span class="s">&quot;http_user_agent&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;curl/7.37.1&quot;</span><span class="p">,</span>
              <span class="s">&quot;http_host&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;127.0.0.1:8080&quot;</span><span class="p">,</span>
            <span class="s">&quot;http_accept&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;*/*&quot;</span><span class="p">,</span>
         <span class="s">&quot;content_length&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;110&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">You</span> <span class="n">can</span> <span class="n">see</span> <span class="n">that</span> <span class="k">in</span> <span class="n">the</span> <span class="n">second</span> <span class="n">request</span><span class="p">,</span> <span class="n">since</span> <span class="n">the</span> <span class="n">content</span><span class="o">-</span><span class="n">type</span> <span class="n">was</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span><span class="p">,</span> <span class="n">the</span> <span class="n">body</span> <span class="n">was</span> <span class="n">deserialized</span> 
<span class="n">and</span> <span class="n">expanded</span> <span class="n">to</span> <span class="n">the</span> <span class="n">event</span> <span class="n">root</span> <span class="p">(</span><span class="n">notice</span> <span class="n">the</span> <span class="n">fields</span> <span class="s">&quot;user&quot;</span><span class="p">,</span> <span class="s">&quot;post_date&quot;</span> <span class="n">and</span> <span class="s">&quot;message&quot;</span><span class="p">).</span>

<span class="n">Show</span> <span class="n">me</span> <span class="n">more</span> <span class="n">concrete</span> <span class="n">examples</span> <span class="n">of</span> <span class="n">how</span> <span class="n">to</span> <span class="n">use</span> <span class="n">it</span><span class="o">!</span>

<span class="n">Because</span><span class="p">,</span> <span class="n">real</span> <span class="n">world</span> <span class="n">examples</span> <span class="n">make</span> <span class="n">everything</span> <span class="n">clearer</span><span class="o">!</span>

<span class="n">Elastic</span> <span class="n">Watcher</span> <span class="n">Integration</span>
<span class="n">In</span> <span class="n">this</span> <span class="n">section</span><span class="p">,</span> <span class="n">we</span><span class="err">’</span><span class="n">ll</span> <span class="n">show</span> <span class="n">you</span> <span class="n">how</span> <span class="n">to</span> <span class="n">integrate</span> <span class="n">Elastic</span> <span class="n">Watcher</span> <span class="o">--</span> <span class="n">the</span> <span class="n">new</span> <span class="n">Elasticsearch</span> <span class="n">plugin</span> <span class="k">for</span> <span class="n">alerting</span>
 <span class="n">and</span> <span class="n">notification</span> <span class="o">--</span> <span class="n">with</span> <span class="n">Logstash</span><span class="p">.</span> <span class="n">Sending</span> <span class="n">notifications</span> <span class="n">to</span> <span class="n">Logstash</span> <span class="n">via</span> <span class="n">this</span> <span class="n">input</span> <span class="n">provides</span> <span class="n">you</span> <span class="n">a</span> <span class="n">powerful</span>
  <span class="n">toolset</span> <span class="n">to</span> <span class="n">further</span> <span class="n">transform</span> <span class="n">notifications</span> <span class="n">and</span> <span class="n">use</span> <span class="n">Logstash</span><span class="err">’</span><span class="n">s</span> <span class="n">rich</span> <span class="n">collection</span> <span class="n">of</span> <span class="n">outputs</span><span class="p">.</span>

<span class="n">Imagine</span> <span class="n">that</span> <span class="n">you</span> <span class="n">have</span> <span class="n">indices</span> <span class="n">with</span> <span class="n">Apache</span> <span class="n">logs</span><span class="p">,</span> <span class="n">and</span> <span class="n">now</span> <span class="n">we</span> <span class="n">want</span> <span class="n">to</span> <span class="n">get</span> <span class="n">a</span> <span class="n">periodic</span> <span class="n">update</span> <span class="n">of</span> <span class="n">how</span> <span class="n">many</span> <span class="n">requests</span>
 <span class="n">are</span> <span class="n">resulting</span> <span class="k">in</span> <span class="n">a</span> <span class="mi">404</span> <span class="p">(</span><span class="n">Not</span> <span class="n">Found</span><span class="p">)</span> <span class="n">response</span><span class="p">.</span>

<span class="n">The</span> <span class="n">required</span> <span class="n">steps</span> <span class="k">for</span> <span class="n">this</span> <span class="nl">are</span><span class="p">:</span>

<span class="n">Installing</span> <span class="n">Watcher</span>
<span class="n">Creating</span> <span class="n">a</span> <span class="n">new</span> <span class="n">notification</span> <span class="n">on</span> <span class="n">Watcher</span> <span class="n">that</span> <span class="n">every</span> <span class="n">minute</span> <span class="n">reports</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">events</span> <span class="n">that</span> <span class="n">have</span> <span class="n">a</span> <span class="mi">404</span> <span class="n">response</span> 
<span class="n">status</span>
<span class="n">Start</span> <span class="n">Logstash</span> <span class="n">with</span> <span class="n">the</span> <span class="n">HTTP</span> <span class="n">input</span>
<span class="n">Send</span> <span class="n">data</span> <span class="n">to</span> <span class="n">Elasticsearch</span> <span class="n">and</span> <span class="n">watch</span> <span class="n">updates</span> <span class="n">on</span> <span class="n">Logstash</span>
<span class="n">Here</span> <span class="n">we</span> <span class="n">go</span><span class="o">!</span>

<span class="mf">1.</span> <span class="n">Installing</span> <span class="n">Watcher</span>
<span class="n">cd</span> <span class="n">elasticsearch</span><span class="o">-</span><span class="mf">1.5.2</span>
<span class="n">bin</span><span class="o">/</span><span class="n">plugin</span> <span class="o">-</span><span class="n">i</span> <span class="n">elasticsearch</span><span class="o">/</span><span class="n">watcher</span><span class="o">/</span><span class="n">latest</span>
<span class="n">bin</span><span class="o">/</span><span class="n">plugin</span> <span class="o">-</span><span class="n">i</span> <span class="n">elasticsearch</span><span class="o">/</span><span class="n">license</span><span class="o">/</span><span class="n">latest</span>
<span class="n">bin</span><span class="o">/</span><span class="n">elasticsearch</span> <span class="err">#</span> <span class="n">restart</span> <span class="n">the</span> <span class="n">server</span>
<span class="mf">2.</span> <span class="n">Creating</span> <span class="n">a</span> <span class="n">watch</span>
<span class="n">The</span> <span class="n">Watcher</span> <span class="n">plugin</span> <span class="k">for</span> <span class="n">elasticsearch</span> <span class="n">provides</span> <span class="n">an</span> <span class="n">API</span> <span class="n">to</span> <span class="n">create</span> <span class="n">and</span> <span class="n">manipulate</span> <span class="n">scheduled</span> <span class="n">tasks</span><span class="p">,</span> <span class="n">or</span> <span class="s">&quot;watches&quot;</span><span class="p">.</span> 
<span class="n">A</span> <span class="n">Watch</span> <span class="n">will</span> <span class="n">query</span> <span class="n">the</span> <span class="n">data</span> <span class="k">in</span> <span class="n">the</span> <span class="n">elasticsearch</span> <span class="n">cluster</span> <span class="n">according</span> <span class="n">to</span> <span class="n">its</span> <span class="n">schedule</span><span class="p">,</span> <span class="n">look</span> <span class="k">for</span> <span class="n">certain</span> <span class="n">scenarios</span> 
<span class="p">(</span><span class="n">like</span> <span class="n">the</span> <span class="n">presence</span> <span class="n">of</span> <span class="n">an</span> <span class="n">error</span> <span class="n">event</span><span class="p">)</span> <span class="n">and</span> <span class="n">execute</span> <span class="n">actions</span><span class="p">.</span> <span class="n">Examples</span> <span class="n">of</span> <span class="n">actions</span> <span class="n">are</span> <span class="n">sending</span> <span class="n">an</span> <span class="n">email</span><span class="p">,</span> <span class="n">writing</span> <span class="n">a</span>
 <span class="n">document</span> <span class="n">to</span> <span class="n">an</span> <span class="n">index</span><span class="p">,</span> <span class="n">calling</span> <span class="n">an</span> <span class="n">outside</span> <span class="n">HTTP</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">and</span> <span class="n">more</span><span class="p">..</span>

<span class="n">For</span> <span class="n">this</span> <span class="n">test</span><span class="p">,</span> <span class="n">I</span> <span class="n">created</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">watch</span> <span class="nl">that</span><span class="p">:</span>

<span class="n">every</span> <span class="n">minute</span>
<span class="n">counts</span> <span class="n">number</span> <span class="n">of</span> <span class="n">HTTP</span> <span class="n">requests</span> <span class="n">that</span> <span class="n">resulted</span> <span class="k">in</span> <span class="n">a</span> <span class="mi">404</span>
<span class="n">posts</span> <span class="n">result</span> <span class="n">to</span> <span class="nl">http</span><span class="p">:</span><span class="c1">//localhost:8080</span>
<span class="n">This</span> <span class="n">is</span> <span class="n">the</span> <span class="n">resulting</span> <span class="n">JSON</span> <span class="n">document</span> <span class="n">I</span> <span class="n">need</span> <span class="n">to</span> <span class="n">send</span> <span class="n">to</span> <span class="nl">Watcher</span><span class="p">:</span>

<span class="p">{</span>
  <span class="s">&quot;trigger&quot;</span> <span class="o">:</span> <span class="p">{</span>
    <span class="s">&quot;schedule&quot;</span> <span class="o">:</span> <span class="p">{</span> <span class="s">&quot;cron&quot;</span> <span class="o">:</span> <span class="s">&quot;0 0/1 * * * ?&quot;</span> <span class="p">}</span>
  <span class="p">},</span>
  <span class="s">&quot;input&quot;</span> <span class="o">:</span> <span class="p">{</span>
    <span class="s">&quot;search&quot;</span> <span class="o">:</span> <span class="p">{</span>
      <span class="s">&quot;request&quot;</span> <span class="o">:</span> <span class="p">{</span>
        <span class="s">&quot;indices&quot;</span> <span class="o">:</span> <span class="p">[</span>
          <span class="s">&quot;logstash*&quot;</span>
          <span class="p">],</span>
        <span class="s">&quot;body&quot;</span> <span class="o">:</span> <span class="p">{</span>
          <span class="s">&quot;query&quot;</span> <span class="o">:</span> <span class="p">{</span>
            <span class="s">&quot;term&quot;</span><span class="o">:</span> <span class="p">{</span> <span class="s">&quot;response&quot;</span><span class="o">:</span> <span class="mi">404</span> <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s">&quot;actions&quot;</span> <span class="o">:</span> <span class="p">{</span>
    <span class="s">&quot;my_webhook&quot;</span> <span class="o">:</span> <span class="p">{</span>
      <span class="s">&quot;webhook&quot;</span> <span class="o">:</span> <span class="p">{</span>
        <span class="s">&quot;auth&quot;</span> <span class="o">:</span> <span class="p">{</span>
          <span class="s">&quot;basic&quot;</span> <span class="o">:</span> <span class="p">{</span>
            <span class="s">&quot;username&quot;</span> <span class="o">:</span> <span class="s">&quot;guest&quot;</span><span class="p">,</span>
            <span class="s">&quot;password&quot;</span> <span class="o">:</span> <span class="s">&quot;guest&quot;</span>
          <span class="p">}</span>
        <span class="p">},</span>
        <span class="s">&quot;method&quot;</span> <span class="o">:</span> <span class="s">&quot;POST&quot;</span><span class="p">,</span>
        <span class="s">&quot;host&quot;</span> <span class="o">:</span> <span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span>
        <span class="s">&quot;port&quot;</span> <span class="o">:</span> <span class="mi">8080</span><span class="p">,</span>
        <span class="s">&quot;path&quot;</span><span class="o">:</span> <span class="s">&quot;/{{ctx.watch_id}}&quot;</span><span class="p">,</span>
        <span class="s">&quot;body&quot;</span> <span class="o">:</span> <span class="s">&quot;{{ctx.payload.hits.total}}&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="n">To</span> <span class="n">install</span> <span class="n">this</span> <span class="n">watch</span> <span class="n">you</span> <span class="n">need</span> <span class="n">to</span> <span class="n">create</span> <span class="n">it</span> <span class="k">in</span> <span class="n">Elasticsearch</span> <span class="n">by</span> <span class="n">executing</span> <span class="n">a</span> <span class="n">PUT</span> <span class="nl">request</span><span class="p">:</span>

<span class="n">curl</span> <span class="o">-</span><span class="n">XPUT</span> <span class="err">&#39;</span><span class="nl">http</span><span class="p">:</span><span class="c1">//localhost:9200/_watcher/watch/my-watch&#39; -d @create_webhook.json</span>
<span class="mf">3.</span> <span class="n">Logstash</span> <span class="n">setup</span>
<span class="n">wget</span> <span class="nl">http</span><span class="p">:</span><span class="c1">//download.elastic.co/logstash/logstash/logstash-1.5.2.tar.gz</span>
<span class="n">tar</span> <span class="o">-</span><span class="n">zxf</span> <span class="n">logstash</span><span class="o">-</span><span class="mf">1.5.2</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
<span class="n">cd</span> <span class="n">logstash</span><span class="o">-</span><span class="mf">1.5.2</span>
<span class="n">bin</span><span class="o">/</span><span class="n">logstash</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;input { http { } } output { stdout { codec =&gt; rubydebug} }&quot;</span>
<span class="mf">4.</span> <span class="n">Results</span>
<span class="n">After</span> <span class="n">launching</span> <span class="n">an</span> <span class="n">ingestion</span> <span class="n">process</span> <span class="k">in</span> <span class="n">another</span> <span class="n">terminal</span><span class="p">,</span> <span class="n">Logstash</span> <span class="n">starts</span> <span class="n">receiving</span> <span class="mi">1</span> <span class="n">notification</span> <span class="n">per</span> 
<span class="n">minute</span> <span class="k">in</span> <span class="n">the</span> <span class="n">form</span> <span class="n">of</span> <span class="n">a</span> <span class="n">HTTP</span> <span class="nl">POST</span><span class="p">:</span>

<span class="o">%</span> <span class="n">bin</span><span class="o">/</span><span class="n">logstash</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;input { http { } } output { stdout { codec =&gt; rubydebug} }&quot;</span>    
<span class="n">Logstash</span> <span class="n">startup</span> <span class="n">completed</span>
<span class="p">{</span>
       <span class="s">&quot;message&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;330&quot;</span><span class="p">,</span>
      <span class="s">&quot;@version&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;1&quot;</span><span class="p">,</span>
    <span class="s">&quot;@timestamp&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;2015-06-02T12:53:00.037Z&quot;</span><span class="p">,</span>
       <span class="s">&quot;headers&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span>
               <span class="s">&quot;content_type&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;application/x-www-form-urlencoded&quot;</span><span class="p">,</span>
             <span class="s">&quot;request_method&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;POST&quot;</span><span class="p">,</span>
               <span class="s">&quot;request_path&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;/my-watch&quot;</span><span class="p">,</span>
                <span class="s">&quot;request_uri&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;/my-watch?&quot;</span><span class="p">,</span>
               <span class="s">&quot;http_version&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;HTTP/1.1&quot;</span><span class="p">,</span>
         <span class="s">&quot;http_authorization&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;Basic Z3Vlc3Q6Z3Vlc3Q=&quot;</span><span class="p">,</span>
        <span class="s">&quot;http_accept_charset&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;UTF-8&quot;</span><span class="p">,</span>
         <span class="s">&quot;http_cache_control&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;no-cache&quot;</span><span class="p">,</span>
                <span class="s">&quot;http_pragma&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;no-cache&quot;</span><span class="p">,</span>
            <span class="s">&quot;http_user_agent&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;Java/1.8.0_20&quot;</span><span class="p">,</span>
                  <span class="s">&quot;http_host&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;127.0.0.1:8080&quot;</span><span class="p">,</span>
                <span class="s">&quot;http_accept&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2&quot;</span><span class="p">,</span>
            <span class="s">&quot;http_connection&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;keep-alive&quot;</span><span class="p">,</span>
             <span class="s">&quot;content_length&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;12&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="p">{</span>
       <span class="s">&quot;message&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;3103&quot;</span><span class="p">,</span>
      <span class="s">&quot;@version&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;1&quot;</span><span class="p">,</span>
    <span class="s">&quot;@timestamp&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;2015-06-02T12:54:00.030Z&quot;</span><span class="p">,</span>
       <span class="s">&quot;headers&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span>
               <span class="s">&quot;content_type&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;application/x-www-form-urlencoded&quot;</span><span class="p">,</span>
             <span class="s">&quot;request_method&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;POST&quot;</span><span class="p">,</span>
               <span class="s">&quot;request_path&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;/my-watch&quot;</span><span class="p">,</span>
                <span class="s">&quot;request_uri&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;/my-watch?&quot;</span><span class="p">,</span>
               <span class="s">&quot;http_version&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;HTTP/1.1&quot;</span><span class="p">,</span>
         <span class="s">&quot;http_authorization&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;Basic Z3Vlc3Q6Z3Vlc3Q=&quot;</span><span class="p">,</span>
        <span class="s">&quot;http_accept_charset&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;UTF-8&quot;</span><span class="p">,</span>
         <span class="s">&quot;http_cache_control&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;no-cache&quot;</span><span class="p">,</span>
                <span class="s">&quot;http_pragma&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;no-cache&quot;</span><span class="p">,</span>
            <span class="s">&quot;http_user_agent&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;Java/1.8.0_20&quot;</span><span class="p">,</span>
                  <span class="s">&quot;http_host&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;127.0.0.1:8080&quot;</span><span class="p">,</span>
                <span class="s">&quot;http_accept&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2&quot;</span><span class="p">,</span>
            <span class="s">&quot;http_connection&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;keep-alive&quot;</span><span class="p">,</span>
             <span class="s">&quot;content_length&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;13&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="p">{</span>
       <span class="s">&quot;message&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;6071&quot;</span><span class="p">,</span>
      <span class="s">&quot;@version&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;1&quot;</span><span class="p">,</span>
    <span class="s">&quot;@timestamp&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;2015-06-02T12:55:00.031Z&quot;</span><span class="p">,</span>
       <span class="s">&quot;headers&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span>
               <span class="s">&quot;content_type&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;application/x-www-form-urlencoded&quot;</span><span class="p">,</span>
             <span class="s">&quot;request_method&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;POST&quot;</span><span class="p">,</span>
               <span class="s">&quot;request_path&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;/my-watch&quot;</span><span class="p">,</span>
                <span class="s">&quot;request_uri&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;/my-watch?&quot;</span><span class="p">,</span>
               <span class="s">&quot;http_version&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;HTTP/1.1&quot;</span><span class="p">,</span>
         <span class="s">&quot;http_authorization&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;Basic Z3Vlc3Q6Z3Vlc3Q=&quot;</span><span class="p">,</span>
        <span class="s">&quot;http_accept_charset&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;UTF-8&quot;</span><span class="p">,</span>
         <span class="s">&quot;http_cache_control&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;no-cache&quot;</span><span class="p">,</span>
                <span class="s">&quot;http_pragma&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;no-cache&quot;</span><span class="p">,</span>
            <span class="s">&quot;http_user_agent&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;Java/1.8.0_20&quot;</span><span class="p">,</span>
                  <span class="s">&quot;http_host&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;127.0.0.1:8080&quot;</span><span class="p">,</span>
                <span class="s">&quot;http_accept&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2&quot;</span><span class="p">,</span>
            <span class="s">&quot;http_connection&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;keep-alive&quot;</span><span class="p">,</span>
             <span class="s">&quot;content_length&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;13&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">A</span> <span class="n">more</span> <span class="n">complex</span> <span class="n">example</span>
<span class="n">Now</span> <span class="n">that</span> <span class="n">we</span> <span class="n">know</span> <span class="n">how</span> <span class="n">to</span> <span class="n">trigger</span> <span class="n">notification</span> <span class="n">events</span> <span class="n">from</span> <span class="n">Watcher</span><span class="p">,</span> <span class="n">we</span> <span class="n">can</span> <span class="n">leverage</span> <span class="n">the</span> <span class="n">plugin</span> <span class="n">ecosystem</span> <span class="k">in</span>
 <span class="n">Logstash</span> <span class="n">to</span> <span class="n">escalate</span> <span class="n">notifications</span> <span class="n">depending</span> <span class="k">in</span> <span class="n">a</span> <span class="n">certain</span> <span class="n">criteria</span><span class="p">.</span> <span class="n">This</span> <span class="n">following</span> <span class="n">config</span> <span class="nl">will</span><span class="p">:</span>

<span class="n">continuously</span> <span class="n">update</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="mi">404</span> <span class="n">requests</span> <span class="k">in</span> <span class="n">statsd</span>
<span class="k">if</span> <span class="n">the</span> <span class="n">count</span> <span class="n">reaches</span> <span class="mi">10000</span> <span class="n">then</span> <span class="n">send</span> <span class="n">a</span> <span class="n">message</span> <span class="n">to</span> <span class="n">HipChat</span><span class="p">,</span> <span class="n">or</span>
<span class="k">if</span> <span class="n">reaches</span> <span class="mi">40000</span><span class="p">,</span> <span class="n">notify</span> <span class="n">PagerDuty</span><span class="p">.</span>
<span class="n">input</span> <span class="p">{</span>
  <span class="n">http</span> <span class="p">{</span> <span class="p">}</span>
<span class="p">}</span>
<span class="n">filter</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">[</span><span class="n">headers</span><span class="p">][</span><span class="n">request_path</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;/my-watch&quot;</span> <span class="p">{</span>
    <span class="n">mutate</span> <span class="p">{</span> <span class="n">convert</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s">&quot;message&quot;</span><span class="p">,</span> <span class="s">&quot;integer&quot;</span> <span class="p">]</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="n">output</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">[</span><span class="n">headers</span><span class="p">][</span><span class="n">request_path</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;/my-watch&quot;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">[</span><span class="n">message</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">40000</span> <span class="p">{</span> <span class="err">#</span> <span class="n">way</span> <span class="n">too</span> <span class="n">many</span><span class="p">,</span> <span class="n">notify</span> <span class="n">pagerduty</span>
      <span class="n">pagerduty</span> <span class="p">{</span>
        <span class="n">description</span> <span class="o">=&gt;</span> <span class="s">&quot;%{host} - Apache: Very high number of 404&quot;</span>
        <span class="n">details</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="s">&quot;timestamp&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;%{@timestamp}&quot;</span>
          <span class="s">&quot;message&quot;</span> <span class="o">=&gt;</span> <span class="s">&quot;%{message}&quot;</span>
        <span class="p">}</span>
        <span class="n">service_key</span> <span class="o">=&gt;</span> <span class="s">&quot;apikeyforlogstashservice&quot;</span>
        <span class="n">incident_key</span> <span class="o">=&gt;</span> <span class="s">&quot;logstash/apacheservice&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">[</span><span class="n">message</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10000</span> <span class="p">{</span>    <span class="err">#</span> <span class="n">unusual</span> <span class="n">amount</span><span class="p">,</span> <span class="n">notify</span> <span class="n">devs</span> <span class="k">in</span> <span class="n">hipchat</span>
      <span class="n">hipchat</span> <span class="p">{</span>
         <span class="n">from</span> <span class="o">=&gt;</span> <span class="s">&quot;logstash&quot;</span>
         <span class="n">room_id</span> <span class="o">=&gt;</span> <span class="s">&quot;dev&quot;</span>
         <span class="n">token</span> <span class="o">=&gt;</span> <span class="s">&quot;[api key]&quot;</span>
         <span class="n">format</span> <span class="o">=&gt;</span> <span class="s">&quot;Very high number of 404 requests: %{message}&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="cp"># always update count of 404 in statsd</span>
    <span class="n">statsd</span> <span class="p">{</span> <span class="n">gauge</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="s">&quot;http.status.404&quot;</span><span class="p">,</span> <span class="s">&quot;%{message}&quot;</span> <span class="p">]</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h2 id="geoip">geoip</h2>
<div class="codehilite"><pre><span></span><span class="n">wget</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">geolite</span><span class="p">.</span><span class="n">maxmind</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">download</span><span class="o">/</span><span class="n">geoip</span><span class="o">/</span><span class="k">database</span><span class="o">/</span><span class="n">GeoLiteCountry</span><span class="o">/</span><span class="n">GeoIP</span><span class="p">.</span><span class="n">dat</span><span class="p">.</span><span class="n">gz</span>
<span class="n">wget</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">geolite</span><span class="p">.</span><span class="n">maxmind</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">download</span><span class="o">/</span><span class="n">geoip</span><span class="o">/</span><span class="k">database</span><span class="o">/</span><span class="n">GeoLiteCity</span><span class="p">.</span><span class="n">dat</span><span class="p">.</span><span class="n">gz</span>
</pre></div>


<h2 id="elasticsearch">elasticsearch</h2>
<div class="codehilite"><pre><span></span><span class="err">所有索引</span> <span class="n">curl</span> <span class="o">-</span><span class="n">XGET</span> <span class="s1">&#39;http://localhost:9200/_cat/indices/*?v&#39;</span>
<span class="err">删除索引</span> <span class="n">curl</span> <span class="o">-</span><span class="n">XDELETE</span> <span class="s1">&#39;http://127.0.0.1:9200/winlogbeat-2016*&#39;</span>
        <span class="n">curl</span> <span class="o">-</span><span class="n">XDELETE</span> <span class="s1">&#39;http://127.0.0.1:9200/winlogbeat-2017.07.20&#39;</span>

<span class="err">查看线程资源</span>  <span class="n">curl</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_nodes</span><span class="o">/</span><span class="n">hot_threads</span>
<span class="err">集群状态</span>      <span class="n">curl</span> <span class="o">-</span><span class="n">XGET</span> <span class="s1">&#39;http://localhost:9200/_cluster/stats?human&amp;pretty&#39;</span>
<span class="err">进程状态</span>      <span class="n">curl</span> <span class="o">-</span><span class="n">XGET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_nodes</span><span class="o">/</span><span class="n">stats</span><span class="o">/</span><span class="n">thread_pool</span><span class="o">?</span><span class="n">pretty</span>
<span class="err">集群参数</span>      <span class="n">curl</span> <span class="o">-</span><span class="n">XGET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_cluster</span><span class="o">/</span><span class="n">settings</span>
<span class="err">索引参数</span>      <span class="n">curl</span> <span class="o">-</span><span class="n">XGET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">logstash</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="k">access</span><span class="o">-</span><span class="mi">2017</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">26</span><span class="o">/</span><span class="n">_settings</span>

<span class="err">集群配置</span>
<span class="n">egrep</span> <span class="o">-</span><span class="n">v</span> <span class="ss">&quot;^#|^$&quot;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">elasticsearch</span><span class="p">.</span><span class="n">yml</span> 
<span class="k">cluster</span><span class="p">.</span><span class="n">name</span><span class="p">:</span> <span class="n">es1</span> <span class="o">#</span><span class="err">集群名字</span> <span class="err">要一致</span>
<span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">:</span> <span class="n">node</span><span class="o">-</span><span class="mi">1</span>  <span class="o">#</span> <span class="err">节点名字，不能重复</span>
<span class="n">network</span><span class="p">.</span><span class="k">host</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span>
<span class="n">path</span><span class="p">.</span><span class="k">data</span><span class="p">:</span> <span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span>
<span class="n">http</span><span class="p">.</span><span class="n">port</span><span class="p">:</span> <span class="mi">9200</span>
<span class="n">discovery</span><span class="p">.</span><span class="n">zen</span><span class="p">.</span><span class="n">ping</span><span class="p">.</span><span class="n">multicast</span><span class="p">.</span><span class="n">enabled</span><span class="p">:</span> <span class="k">false</span>  <span class="o">##</span><span class="err">关闭组播</span>
<span class="n">discovery</span><span class="p">.</span><span class="n">zen</span><span class="p">.</span><span class="n">ping</span><span class="p">.</span><span class="n">unicast</span><span class="p">.</span><span class="n">hosts</span><span class="p">:</span> <span class="p">[</span><span class="ss">&quot;10.51.48.109&quot;</span><span class="p">,</span> <span class="ss">&quot;10.171.32.72&quot;</span><span class="p">]</span> <span class="o">#</span> <span class="o">#</span><span class="err">单播发现地址</span> <span class="err">自己的和其他节点的</span>
</pre></div>


<h2 id="logstash-grop">logstash grop正则</h2>
<p>grok匹配测试 <a href="http://grokdebug.herokuapp.com/">http://grokdebug.herokuapp.com/</a></p>
<p>Example</p>
<p>下面是日志的样子</p>
<p>55.3.244.1 GET /index.html 15824 0.043</p>
<p>正则的例子</p>
<p>%{IP:client} %{WORD:method} %{URIPATHPARAM:request} %{NUMBER:bytes} %{NUMBER:duration}</p>
<p>配置文件里是怎么写得？</p>
<p>input {</p>
<p>file {</p>
<p>path =&gt; “/var/log/http.log”</p>
<p>}</p>
<p>}</p>
<p>filter {</p>
<p>grok {</p>
<p>match =&gt; [ "message", "%{IP:client} %{WORD:method} %{URIPATHPARAM:request} %{NUMBER:bytes} %{NUMBER:duration}" ]</p>
<p>}</p>
<p>}</p>
<p>解析后，是个什么样子？</p>
<p>client: 55.3.244.1</p>
<p>method: GET</p>
<p>request: /index.html</p>
<p>bytes: 15824</p>
<p>duration: 0.043</p>
<p>自定义正则</p>
<p>(?&lt;field_name&gt;the pattern here)</p>
<p>(?&lt;queue_id&gt;[0-9A-F]{10,11})</p>
<p>当然你也可以把众多的正则，放在一个集中文件里面。</p>
<p># in ./patterns/postfix</p>
<p>POSTFIX_QUEUEID [0-9A-F]{10,11}</p>
<p>filter {</p>
<p>grok {</p>
<p>patterns_dir =&gt; “./patterns”</p>
<p>match =&gt; [ "message", "%{SYSLOGBASE} %{POSTFIX_QUEUEID:queue_id}: %{GREEDYDATA:syslog_message}" ]</p>
<p>}</p>
<p>}</p>
<p>############</p>
<p>logstash已经自带了不少的正则，如果想偷懒的话，可以在内置正则里借用下。</p>
<p>USERNAME [a-zA-Z0-9._-]+</p>
<p>USER %{USERNAME}</p>
<p>INT (?:[+-]?(?:[0-9]+))</p>
<p>BASE10NUM (?&lt;![0-9.+-])(?&gt;[+-]?(?:(?:[0-9]+(?:.[0-9]+)?)|(?:.[0-9]+)))</p>
<p>NUMBER (?:%{BASE10NUM})</p>
<p>BASE16NUM (?&lt;![0-9A-Fa-f])(?:[+-]?(?:0x)?(?:[0-9A-Fa-f]+))</p>
<p>BASE16FLOAT \b(?&lt;![0-9A-Fa-f.])(?:[+-]?(?:0x)?(?:(?:[0-9A-Fa-f]+(?:.[0-9A-Fa-f]*)?)|(?:.[0-9A-Fa-f]+)))\b</p>
<p>POSINT \b(?:[1-9][0-9]*)\b</p>
<p>NONNEGINT \b(?:[0-9]+)\b</p>
<p>WORD \b\w+\b</p>
<p>NOTSPACE \S+</p>
<p>SPACE \s*</p>
<p>DATA .*?</p>
<p>GREEDYDATA .*</p>
<p>QUOTEDSTRING (?&gt;(?&lt;!\)(?&gt;”(?&gt;.|[^\"]+)+”|”"|(?&gt;’(?&gt;.|[^\']+)+’)|”|(?&gt;(?&gt;.|[^\]+)+)|`))</p>
<p>UUID [A-Fa-f0-9]{8}-(?:[A-Fa-f0-9]{4}-){3}[A-Fa-f0-9]{12}</p>
<p># Networking</p>
<p>MAC (?:%{CISCOMAC}|%{WINDOWSMAC}|%{COMMONMAC})</p>
<p>CISCOMAC (?:(?:[A-Fa-f0-9]{4}.){2}[A-Fa-f0-9]{4})</p>
<p>WINDOWSMAC (?:(?:[A-Fa-f0-9]{2}-){5}[A-Fa-f0-9]{2})</p>
<p>COMMONMAC (?:(?:[A-Fa-f0-9]{2}:){5}[A-Fa-f0-9]{2})</p>
<p>IPV6 ((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(%.+)?</p>
<p>IPV4 (?&lt;![0-9])(?:(?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{1,2})[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{1,2})[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{1,2})[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{1,2}))(?![0-9])</p>
<p>IP (?:%{IPV6}|%{IPV4})</p>
<p>HOSTNAME \b(?:[0-9A-Za-z][0-9A-Za-z-]{0,62})(?:.(?:[0-9A-Za-z][0-9A-Za-z-]{0,62}))*(.?|\b)</p>
<p>HOST %{HOSTNAME}</p>
<p>IPORHOST (?:%{HOSTNAME}|%{IP})</p>
<p>HOSTPORT (?:%{IPORHOST=~/./}:%{POSINT})</p>
<p># paths</p>
<p>PATH (?:%{UNIXPATH}|%{WINPATH})</p>
<p>UNIXPATH (?&gt;/(?&gt;[\w_%!$@:.,-]+|.)*)+</p>
<p>TTY (?:/dev/(pts|tty([pq])?)(\w+)?/?(?:[0-9]+))</p>
<p>WINPATH (?&gt;[A-Za-z]+:|\)(?:\[^\?*]*)+</p>
<p>URIPROTO [A-Za-z]+(+[A-Za-z+]+)?</p>
<p>URIHOST %{IPORHOST}(?::%{POSINT:port})?</p>
<p># uripath comes loosely from RFC1738, but mostly from what Firefox</p>
<p># doesn’t turn into %XX</p>
<p>URIPATH (?:/[A-Za-z0-9$.+!*'(){},~:;=@#%_-]*)+</p>
<p>#URIPARAM \?(?:[A-Za-z0-9]+(?:=(?:[^&amp;]*))?(?:&amp;(?:[A-Za-z0-9]+(?:=(?:[^&amp;]*))?)?)*)?</p>
<p>URIPARAM \?[A-Za-z0-9$.+!*’|(){},~@#%&amp;/=:;_?-\[\]]*</p>
<p>URIPATHPARAM %{URIPATH}(?:%{URIPARAM})?</p>
<p>URI %{URIPROTO}://(?:%{USER}(?::[^@]*)?@)?(?:%{URIHOST})?(?:%{URIPATHPARAM})?</p>
<p># Months: January, Feb, 3, 03, 12, December</p>
<p>MONTH \b(?:Jan(?:uary)?|Feb(?:ruary)?|Mar(?:ch)?|Apr(?:il)?|May|Jun(?:e)?|Jul(?:y)?|Aug(?:ust)?|Sep(?:tember)?|Oct(?:ober)?|Nov(?:ember)?|Dec(?:ember)?)\b</p>
<p>MONTHNUM (?:0?[1-9]|1[0-2])</p>
<p>MONTHDAY (?:(?:0[1-9])|(?:[12][0-9])|(?:3[01])|[1-9])</p>
<p># Days: Monday, Tue, Thu, etc…</p>
<p>DAY (?:Mon(?:day)?|Tue(?:sday)?|Wed(?:nesday)?|Thu(?:rsday)?|Fri(?:day)?|Sat(?:urday)?|Sun(?:day)?)</p>
<p># Years?</p>
<p>YEAR (?&gt;\d\d){1,2}</p>
<p>HOUR (?:2[0123]|[01]?[0-9])</p>
<p>MINUTE (?:[0-5][0-9])</p>
<p># ’60′ is a leap second in most time standards and thus is valid.</p>
<p>SECOND (?:(?:[0-5][0-9]|60)(?:[:.,][0-9]+)?)</p>
<p>TIME (?!&lt;[0-9])%{HOUR}:%{MINUTE}(?::%{SECOND})(?![0-9])</p>
<p># datestamp is YYYY/MM/DD-HH:MM:SS.UUUU (or something like it)</p>
<p>DATE_US %{MONTHNUM}[/-]%{MONTHDAY}[/-]%{YEAR}</p>
<p>DATE_EU %{MONTHDAY}[./-]%{MONTHNUM}[./-]%{YEAR}</p>
<p>ISO8601_TIMEZONE (?:Z|[+-]%{HOUR}(?::?%{MINUTE}))</p>
<p>ISO8601_SECOND (?:%{SECOND}|60)</p>
<p>TIMESTAMP_ISO8601 %{YEAR}-%{MONTHNUM}-%{MONTHDAY}[T ]%{HOUR}:?%{MINUTE}(?::?%{SECOND})?%{ISO8601_TIMEZONE}?</p>
<p>DATE %{DATE_US}|%{DATE_EU}</p>
<p>DATESTAMP %{DATE}[- ]%{TIME}</p>
<p>TZ (?:[PMCE][SD]T|UTC)</p>
<p>DATESTAMP_RFC822 %{DAY} %{MONTH} %{MONTHDAY} %{YEAR} %{TIME} %{TZ}</p>
<p>DATESTAMP_OTHER %{DAY} %{MONTH} %{MONTHDAY} %{TIME} %{TZ} %{YEAR}</p>
<p># Syslog Dates: Month Day HH:MM:SS</p>
<p>SYSLOGTIMESTAMP %{MONTH} +%{MONTHDAY} %{TIME}</p>
<p>PROG (?:[\w._/%-]+)</p>
<p>SYSLOGPROG %{PROG:program}(?:\[%{POSINT:pid}\])?</p>
<p>SYSLOGHOST %{IPORHOST}</p>
<p>SYSLOGFACILITY &lt;%{NONNEGINT:facility}.%{NONNEGINT:priority}&gt;</p>
<p>HTTPDATE %{MONTHDAY}/%{MONTH}/%{YEAR}:%{TIME} %{INT}</p>
<p># Shortcuts</p>
<p>QS %{QUOTEDSTRING}</p>
<p># Log formats</p>
<p>SYSLOGBASE %{SYSLOGTIMESTAMP:timestamp} (?:%{SYSLOGFACILITY} )?%{SYSLOGHOST:logsource} %{SYSLOGPROG}:</p>
<p>COMMONAPACHELOG %{IPORHOST:clientip} %{USER:ident} %{USER:auth} \[%{HTTPDATE:timestamp}\] “(?:%{WORD:verb} %{NOTSPACE:request}(?: HTTP/%{NUMBER:httpversion})?|%{DATA:rawrequest})” %{NUMBER:response} (?:%{NUMBER:bytes}|-)</p>
<p>COMBINEDAPACHELOG %{COMMONAPACHELOG} %{QS:referrer} %{QS:agent}</p>
<p># Log Levels</p>
<p>LOGLEVEL ([A-a]lert|ALERT|[T|t]race|TRACE|[D|d]ebug|DEBUG|[N|n]otice|NOTICE|[I|i]nfo|INFO|[W|w]arn?(?:ing)?|WARN?(?:ING)?|[E|e]rr?(?:or)?|ERR?(?:OR)?|[C|c]rit?(?:ical)?|CRIT?(?:ICAL)?|[F|f]atal|FATAL|[S|s]evere|SEVERE|EMERG(?:ENCY)?|[Ee]merg(?:ency)?)</p>
<h2 id="awstats">awstats</h2>
<div class="codehilite"><pre><span></span><span class="nl">http</span><span class="p">:</span><span class="c1">//blog.csdn.net/wanglipo/article/details/18080819</span>
<span class="n">wget</span> <span class="nl">https</span><span class="p">:</span><span class="c1">//prdownloads.sourceforge.net/awstats/awstats-7.5.tar.gz</span>
<span class="n">tar</span> <span class="o">-</span><span class="n">zxf</span> <span class="n">awstats</span><span class="o">-</span><span class="mf">7.5</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span> 
<span class="n">mv</span> <span class="n">awstats</span><span class="o">-</span><span class="mf">7.5</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">awstats</span>
<span class="n">cd</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">awstats</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span>
<span class="n">mkdir</span> <span class="o">-</span><span class="n">pv</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">awstats</span>
<span class="n">chmod</span> <span class="mi">777</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">awstats</span>
<span class="n">perl</span> <span class="n">awstats_configure</span><span class="p">.</span><span class="n">pl</span>
<span class="o">-----</span> <span class="n">AWStats</span> <span class="n">awstats_configure</span> <span class="mf">1.0</span> <span class="p">(</span><span class="n">build</span> <span class="mf">1.9</span><span class="p">)</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="n">Laurent</span> <span class="n">Destailleur</span> <span class="o">-----</span>
<span class="n">This</span> <span class="n">tool</span> <span class="n">will</span> <span class="n">help</span> <span class="n">you</span> <span class="n">to</span> <span class="n">configure</span> <span class="n">AWStats</span> <span class="n">to</span> <span class="n">analyze</span> <span class="n">statistics</span> <span class="k">for</span>
<span class="n">one</span> <span class="n">web</span> <span class="n">server</span><span class="p">.</span> <span class="n">You</span> <span class="n">can</span> <span class="k">try</span> <span class="n">to</span> <span class="n">use</span> <span class="n">it</span> <span class="n">to</span> <span class="n">let</span> <span class="n">it</span> <span class="k">do</span> <span class="n">all</span> <span class="n">that</span> <span class="n">is</span> <span class="n">possible</span>
<span class="n">in</span> <span class="n">AWStats</span> <span class="n">setup</span><span class="p">,</span> <span class="n">however</span> <span class="n">following</span> <span class="n">the</span> <span class="n">step</span> <span class="n">by</span> <span class="n">step</span> <span class="n">manual</span> <span class="n">setup</span>
<span class="n">documentation</span> <span class="p">(</span><span class="n">docs</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">html</span><span class="p">)</span> <span class="n">is</span> <span class="n">often</span> <span class="n">a</span> <span class="n">better</span> <span class="n">idea</span><span class="p">.</span> <span class="n">Above</span> <span class="n">all</span> <span class="k">if</span><span class="o">:</span>
<span class="o">-</span> <span class="n">You</span> <span class="n">are</span> <span class="n">not</span> <span class="n">an</span> <span class="n">administrator</span> <span class="n">user</span><span class="p">,</span>
<span class="o">-</span> <span class="n">You</span> <span class="n">want</span> <span class="n">to</span> <span class="n">analyze</span> <span class="n">downloaded</span> <span class="n">log</span> <span class="n">files</span> <span class="n">without</span> <span class="n">web</span> <span class="n">server</span><span class="p">,</span>
<span class="o">-</span> <span class="n">You</span> <span class="n">want</span> <span class="n">to</span> <span class="n">analyze</span> <span class="n">mail</span> <span class="n">or</span> <span class="n">ftp</span> <span class="n">log</span> <span class="n">files</span> <span class="n">instead</span> <span class="n">of</span> <span class="n">web</span> <span class="n">log</span> <span class="n">files</span><span class="p">,</span>
<span class="o">-</span> <span class="n">You</span> <span class="n">need</span> <span class="n">to</span> <span class="n">analyze</span> <span class="n">load</span> <span class="n">balanced</span> <span class="n">servers</span> <span class="n">log</span> <span class="n">files</span><span class="p">,</span>
<span class="o">-</span> <span class="n">You</span> <span class="n">want</span> <span class="n">to</span> <span class="err">&#39;</span><span class="n">understand</span><span class="err">&#39;</span> <span class="n">all</span> <span class="n">possible</span> <span class="n">ways</span> <span class="n">to</span> <span class="n">use</span> <span class="n">AWStats</span><span class="p">...</span>
<span class="n">Read</span> <span class="n">the</span> <span class="n">AWStats</span> <span class="n">documentation</span> <span class="p">(</span><span class="n">docs</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">html</span><span class="p">).</span>

<span class="o">-----&gt;</span> <span class="n">Running</span> <span class="n">OS</span> <span class="nl">detected</span><span class="p">:</span> <span class="n">Linux</span><span class="p">,</span> <span class="n">BSD</span> <span class="n">or</span> <span class="n">Unix</span>

<span class="o">-----&gt;</span> <span class="n">Check</span> <span class="k">for</span> <span class="n">web</span> <span class="n">server</span> <span class="n">install</span>

<span class="n">Enter</span> <span class="n">full</span> <span class="n">config</span> <span class="n">file</span> <span class="n">path</span> <span class="n">of</span> <span class="n">your</span> <span class="n">Web</span> <span class="n">server</span><span class="p">.</span>
<span class="nl">Example</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">httpd</span><span class="p">.</span><span class="n">conf</span>
<span class="nl">Example</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">apache2</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">httpd</span><span class="p">.</span><span class="n">conf</span>
<span class="nl">Example</span><span class="p">:</span><span class="nl">c</span><span class="p">:</span><span class="err">\</span><span class="n">Programfiles</span><span class="err">\</span><span class="n">apachegroup</span><span class="err">\</span><span class="n">apache</span><span class="err">\</span><span class="n">conf</span><span class="err">\</span><span class="n">httpd</span><span class="p">.</span><span class="n">conf</span>
<span class="n">Config</span> <span class="n">file</span> <span class="n">path</span> <span class="p">(</span><span class="err">&#39;</span><span class="n">none</span><span class="err">&#39;</span> <span class="n">to</span> <span class="n">skip</span> <span class="n">web</span> <span class="n">server</span> <span class="n">setup</span><span class="p">)</span><span class="o">:</span>
<span class="o">&gt;/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">httpd</span><span class="p">.</span><span class="n">conf</span>  <span class="err">根据自己的</span><span class="n">httpd</span><span class="err">服务安装的具体路径填写</span>
<span class="o">-----&gt;</span> <span class="n">Check</span> <span class="n">and</span> <span class="n">complete</span> <span class="n">web</span> <span class="n">server</span> <span class="n">config</span> <span class="n">file</span>
<span class="err">&#39;</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">httpd</span><span class="p">.</span><span class="n">conf</span><span class="err">&#39;</span>
 <span class="n">Add</span> <span class="err">&#39;</span><span class="n">Alias</span> <span class="o">/</span><span class="n">awstatsclasses</span> <span class="s">&quot;/usr/local/awstats/wwwroot/classes/&quot;</span><span class="err">&#39;</span>
 <span class="n">Add</span> <span class="err">&#39;</span><span class="n">Alias</span> <span class="o">/</span><span class="n">awstatscss</span>
<span class="s">&quot;/usr/local/awstats/wwwroot/css/&quot;</span><span class="err">&#39;</span>
 <span class="n">Add</span> <span class="err">&#39;</span><span class="n">Alias</span> <span class="o">/</span><span class="n">awstatsicons</span>
<span class="s">&quot;/usr/local/awstats/wwwroot/icon/&quot;</span><span class="err">&#39;</span>
 <span class="n">Add</span> <span class="err">&#39;</span><span class="n">ScriptAlias</span> <span class="o">/</span><span class="n">awstats</span><span class="o">/</span> <span class="s">&quot;/usr/local/awstats/wwwroot/cgi-bin/&quot;</span><span class="err">&#39;</span>
 <span class="n">Add</span> <span class="err">&#39;</span><span class="o">&lt;</span><span class="n">Directory</span><span class="o">&gt;</span><span class="err">&#39;</span> <span class="n">directive</span>
 <span class="n">AWStats</span> <span class="n">directives</span> <span class="n">added</span> <span class="n">to</span> <span class="n">Apache</span> <span class="n">config</span> <span class="n">file</span><span class="p">.</span>

<span class="o">-----&gt;</span> <span class="n">Update</span> <span class="n">model</span> <span class="n">config</span> <span class="n">file</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">awstats</span><span class="o">/</span><span class="n">wwwroot</span><span class="o">/</span><span class="n">cgi</span><span class="o">-</span><span class="n">bin</span><span class="o">/</span><span class="n">awstats</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">conf</span><span class="err">&#39;</span>
 <span class="n">File</span> <span class="n">awstats</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">conf</span> <span class="n">updated</span><span class="p">.</span>

<span class="o">-----&gt;</span> <span class="n">Need</span> <span class="n">to</span> <span class="n">create</span> <span class="n">a</span> <span class="k">new</span> <span class="n">config</span> <span class="n">file</span> <span class="o">?</span>
<span class="n">Do</span> <span class="n">you</span> <span class="n">want</span> <span class="n">me</span> <span class="n">to</span> <span class="n">build</span> <span class="n">a</span> <span class="k">new</span> <span class="n">AWStats</span> <span class="n">config</span><span class="o">/</span><span class="n">profile</span>
<span class="n">file</span> <span class="p">(</span><span class="n">required</span> <span class="k">if</span> <span class="n">first</span> <span class="n">install</span><span class="p">)</span> <span class="p">[</span><span class="n">y</span><span class="o">/</span><span class="n">N</span><span class="p">]</span> <span class="o">?</span><span class="n">y</span>

<span class="o">-----&gt;</span> <span class="n">Define</span> <span class="n">config</span> <span class="n">file</span> <span class="n">name</span> <span class="n">to</span> <span class="n">create</span>
<span class="n">What</span> <span class="n">is</span> <span class="n">the</span> <span class="n">name</span> <span class="n">of</span> <span class="n">your</span> <span class="n">web</span> <span class="n">site</span> <span class="n">or</span> <span class="n">profile</span> <span class="n">analysis</span> <span class="o">?</span>
<span class="nl">Example</span><span class="p">:</span> <span class="n">www</span><span class="p">.</span><span class="n">mysite</span><span class="p">.</span><span class="n">com</span>
<span class="nl">Example</span><span class="p">:</span> <span class="n">demo</span>
<span class="n">Your</span> <span class="n">web</span> <span class="n">site</span><span class="p">,</span> <span class="k">virtual</span> <span class="n">server</span> <span class="n">or</span> <span class="n">profile</span> <span class="nl">name</span><span class="p">:</span>
<span class="o">&gt;</span><span class="n">lingling</span> <span class="err">可以是任意的名字，也可以是完整的域名格式，只是为了区分你要分析的那份日志的来源的网站，自己注意不要混淆就好。</span>

<span class="o">-----&gt;</span> <span class="n">Define</span> <span class="n">config</span> <span class="n">file</span> <span class="n">path</span>
<span class="n">In</span> <span class="n">which</span> <span class="n">directory</span> <span class="k">do</span> <span class="n">you</span> <span class="n">plan</span> <span class="n">to</span> <span class="n">store</span> <span class="n">your</span> <span class="n">config</span> <span class="n">file</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">?</span>
<span class="nl">Default</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">awstats</span>
<span class="n">Directory</span> <span class="n">path</span> <span class="n">to</span> <span class="n">store</span> <span class="n">config</span> <span class="n">file</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">(</span><span class="n">Enter</span> <span class="k">for</span> <span class="k">default</span><span class="p">)</span><span class="o">:</span>
<span class="o">&gt;</span>
<span class="err">默认的</span><span class="n">awstats</span><span class="err">生成的配置文件目录，根据喜好可以更改。</span>
<span class="o">-----&gt;</span> <span class="n">Create</span> <span class="n">config</span> <span class="n">file</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">awstats</span><span class="o">/</span><span class="n">awstats</span><span class="p">.</span><span class="n">lingling</span><span class="p">.</span><span class="n">conf</span><span class="err">&#39;</span>
 <span class="n">Config</span> <span class="n">file</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">awstats</span><span class="o">/</span><span class="n">awstats</span><span class="p">.</span><span class="n">lingling</span><span class="p">.</span><span class="n">conf</span> <span class="n">created</span><span class="p">.</span>

<span class="o">-----&gt;</span> <span class="n">Restart</span> <span class="n">Web</span> <span class="n">server</span> <span class="n">with</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">service</span> <span class="n">httpd</span> <span class="n">restart</span><span class="err">&#39;</span>
<span class="n">Stopping</span> <span class="nl">httpd</span><span class="p">:</span>                                     <span class="p">[</span><span class="n">OK</span><span class="p">]</span>
<span class="n">Starting</span> <span class="nl">httpd</span><span class="p">:</span>                                       <span class="p">[</span><span class="n">OK</span><span class="p">]</span>

<span class="o">-----&gt;</span> <span class="n">Add</span> <span class="n">update</span> <span class="n">process</span> <span class="n">inside</span> <span class="n">a</span> <span class="n">scheduler</span>
<span class="n">Sorry</span><span class="p">,</span> <span class="n">configure</span><span class="p">.</span><span class="n">pl</span> <span class="n">does</span> <span class="n">not</span> <span class="n">support</span> <span class="n">automatic</span> <span class="n">add</span> <span class="n">to</span> <span class="n">cron</span> <span class="n">yet</span><span class="p">.</span>
<span class="n">You</span> <span class="n">can</span> <span class="k">do</span> <span class="n">it</span> <span class="n">manually</span> <span class="n">by</span> <span class="n">adding</span> <span class="n">the</span> <span class="n">following</span> <span class="n">command</span> <span class="n">to</span> <span class="n">your</span> <span class="nl">cron</span><span class="p">:</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">awstats</span><span class="o">/</span><span class="n">wwwroot</span><span class="o">/</span><span class="n">cgi</span><span class="o">-</span><span class="n">bin</span><span class="o">/</span><span class="n">awstats</span><span class="p">.</span><span class="n">pl</span> <span class="o">-</span><span class="n">update</span> <span class="o">-</span><span class="n">config</span><span class="o">=</span><span class="n">lingling</span>
<span class="n">Or</span> <span class="k">if</span> <span class="n">you</span> <span class="n">have</span> <span class="n">several</span> <span class="n">config</span> <span class="n">files</span> <span class="n">and</span> <span class="n">prefer</span> <span class="n">having</span> <span class="n">only</span> <span class="n">one</span> <span class="nl">command</span><span class="p">:</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">awstats</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">awstats_updateall</span><span class="p">.</span><span class="n">pl</span> <span class="n">now</span>
<span class="n">Press</span> <span class="n">ENTER</span> <span class="n">to</span> <span class="k">continue</span><span class="p">...</span>

<span class="n">A</span> <span class="n">SIMPLE</span> <span class="n">config</span> <span class="n">file</span> <span class="n">has</span> <span class="n">been</span> <span class="nl">created</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">awstats</span><span class="o">/</span><span class="n">awstats</span><span class="p">.</span><span class="n">lingling</span><span class="p">.</span><span class="n">conf</span>
<span class="n">You</span> <span class="n">should</span> <span class="n">have</span> <span class="n">a</span> <span class="n">look</span> <span class="n">inside</span> <span class="n">to</span> <span class="n">check</span> <span class="n">and</span> <span class="n">change</span> <span class="n">manually</span> <span class="n">main</span> <span class="n">parameters</span><span class="p">.</span>
<span class="n">You</span> <span class="n">can</span> <span class="n">then</span> <span class="n">manually</span> <span class="n">update</span> <span class="n">your</span> <span class="n">statistics</span> <span class="k">for</span> <span class="err">&#39;</span><span class="n">lingling</span><span class="err">&#39;</span> <span class="n">with</span> <span class="nl">command</span><span class="p">:</span>
<span class="o">&gt;</span> <span class="n">perl</span> <span class="n">awstats</span><span class="p">.</span><span class="n">pl</span> <span class="o">-</span><span class="n">update</span> <span class="o">-</span><span class="n">config</span><span class="o">=</span><span class="n">lingling</span>
<span class="n">You</span> <span class="n">can</span> <span class="n">also</span> <span class="n">read</span> <span class="n">your</span> <span class="n">statistics</span> <span class="k">for</span> <span class="err">&#39;</span><span class="n">lingling</span><span class="err">&#39;</span> <span class="n">with</span> <span class="nl">URL</span><span class="p">:</span>
<span class="o">&gt;</span> <span class="nl">http</span><span class="p">:</span><span class="c1">//localhost/awstats/awstats.pl?config=lingling</span>

<span class="n">Press</span> <span class="n">ENTER</span> <span class="n">to</span> <span class="n">finish</span><span class="p">...</span>


<span class="mi">1</span><span class="err">、由于</span><span class="n">httpd</span><span class="err">的</span><span class="n">log</span><span class="err">文件默认是</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">access</span><span class="p">.</span><span class="n">log</span><span class="err">，</span>
<span class="err">所以要修改</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">awstats</span><span class="o">/</span><span class="n">awstats</span><span class="p">.</span><span class="n">lingling</span><span class="p">.</span><span class="n">conf</span><span class="err">文件里的</span><span class="n">LogFile</span><span class="err">：</span>
<span class="err">把</span><span class="n">LogFile</span><span class="o">=</span><span class="s">&quot;/var/log/httpd/mylog.log&quot;</span><span class="err">改为</span><span class="n">LogFile</span><span class="o">=</span><span class="s">&quot;/var/log/httpd/access_log&quot;</span>
<span class="err">或者</span><span class="n">LogFile</span><span class="o">=</span><span class="s">&quot;var/log/access_log.%YYYY-0%MM-0%DD-0.log&quot;</span>
<span class="mi">2</span><span class="err">、然后，手动更新一下：</span>
<span class="cp"># cd /usr/local/awstats/wwwroot/cgi-bin/</span>
<span class="cp"># perl awstats.pl –update –config=lingling</span>
<span class="mi">3</span><span class="err">、打开浏览器，用</span><span class="n">awstats</span><span class="err">分析日志：</span>
<span class="nl">http</span><span class="p">:</span><span class="c1">//10.100.10.11/awstats/awstats.pl?config=lingling</span>

<span class="mi">4</span><span class="err">、可以将更新的命令作为执行计划，使其每天执行一次，方便分析前一天的日。</span>
<span class="cp"># crontab –e</span>
<span class="mi">10</span> <span class="mi">1</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">awstats</span><span class="o">/</span><span class="n">wwwroot</span><span class="o">/</span><span class="n">cgi</span><span class="o">-</span><span class="n">bin</span><span class="o">/</span><span class="n">awstats</span><span class="p">.</span><span class="n">pl</span> <span class="o">-</span><span class="n">update</span> <span class="o">-</span><span class="n">config</span><span class="o">=</span><span class="n">lingling</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&amp;&gt;</span><span class="mi">1</span>

<span class="err">三、用</span><span class="n">awstats</span><span class="err">分析</span><span class="n">tomcat</span><span class="err">的访问日志</span>
<span class="mi">1</span><span class="err">、要分析</span><span class="n">tomcat</span><span class="err">的日志，就要首先了解其日志格式。</span>
<span class="err">并比较与</span><span class="n">httpd</span><span class="err">的访问日志格式有什么不同之处，然后就可以参照</span><span class="n">awstats</span><span class="err">分析</span><span class="n">httpd</span><span class="err">日志的格式来定义</span><span class="n">awstats</span><span class="err">分析</span><span class="n">tomcat</span><span class="err">的日志。</span>
<span class="err">我的</span><span class="n">tomcat</span><span class="err">服务器上定义的访问日志格式如下：</span>
<span class="o">&lt;</span><span class="n">Valve</span> <span class="n">className</span><span class="o">=</span><span class="s">&quot;org.apache.catalina.valves.</span>
<span class="n">AccessLogValve</span><span class="s">&quot; directory=&quot;</span><span class="n">logs</span><span class="s">&quot;</span>
<span class="n">prefix</span><span class="o">=</span><span class="s">&quot;localhost_access_log.&quot;</span> <span class="n">suffix</span><span class="o">=</span><span class="s">&quot;.txt&quot;</span>
       <span class="n">pattern</span><span class="o">=</span><span class="s">&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</span> <span class="o">/&gt;</span>
<span class="o">%</span><span class="p">...</span><span class="nl">a</span><span class="p">:</span> <span class="err">远程</span><span class="n">IP</span><span class="err">地址</span>  
<span class="o">%</span><span class="p">...</span><span class="nl">A</span><span class="p">:</span> <span class="err">本地</span><span class="n">IP</span><span class="err">地址</span>  
<span class="o">%</span><span class="p">...</span><span class="nl">B</span><span class="p">:</span> <span class="err">已发送的字节数，不包含</span><span class="n">HTTP</span><span class="err">头</span>  
<span class="o">%</span><span class="p">...</span><span class="nl">b</span><span class="p">:</span> <span class="n">CLF</span><span class="err">格式的已发送字节数量，不包含</span><span class="n">HTTP</span><span class="err">头。</span>  
<span class="err">例如当没有发送数据时，写入‘</span><span class="o">-</span><span class="err">’而不是</span><span class="mi">0</span><span class="err">。</span>  
<span class="nf">%e</span><span class="o">:</span> <span class="err">环境变量</span><span class="n">FOOBAR</span><span class="err">的内容</span>  
<span class="o">%</span><span class="p">...</span><span class="nl">f</span><span class="p">:</span> <span class="err">文件名字</span>  
<span class="o">%</span><span class="p">...</span><span class="nl">h</span><span class="p">:</span> <span class="err">远程主机</span>  
<span class="o">%</span><span class="p">...</span><span class="n">H</span> <span class="err">请求的协议</span>  
<span class="nf">%i</span><span class="o">:</span> <span class="n">Foobar</span><span class="err">的内容，发送给服务器的请求的标头行。</span>  
<span class="o">%</span><span class="p">...</span><span class="nl">l</span><span class="p">:</span> <span class="err">远程登录名字（来自</span><span class="n">identd</span><span class="err">，如提供的话）</span>  
<span class="o">%</span><span class="p">...</span><span class="n">m</span> <span class="err">请求的方法</span>  
<span class="nf">%n</span><span class="o">:</span> <span class="err">来自另外一个模块的注解“</span><span class="n">Foobar</span><span class="err">”的内容</span>  
<span class="nf">%o</span><span class="o">:</span> <span class="n">Foobar</span><span class="err">的内容，应答的标头行</span>  
<span class="o">%</span><span class="p">...</span><span class="nl">p</span><span class="p">:</span> <span class="err">服务器响应请求时使用的端口</span>  
<span class="o">%</span><span class="p">...</span><span class="nl">P</span><span class="p">:</span> <span class="err">响应请求的子进程</span><span class="n">ID</span><span class="err">。</span>  
<span class="o">%</span><span class="p">...</span><span class="n">q</span> <span class="err">查询字符串（如果存在查询字符串，则包含“</span><span class="o">?</span><span class="err">”后面的</span>  
<span class="err">部分；否则，它是一个空字符串。）</span>  
<span class="o">%</span><span class="p">...</span><span class="nl">r</span><span class="p">:</span> <span class="err">请求的第一行</span>  
<span class="o">%</span><span class="p">...</span><span class="nl">s</span><span class="p">:</span> <span class="err">状态。对于进行内部重定向的请求，这是指</span><span class="o">*</span><span class="err">原来</span><span class="o">*</span><span class="err">请求</span>  
<span class="err">的状态。如果用</span><span class="o">%</span><span class="p">...</span><span class="o">&gt;</span><span class="n">s</span><span class="err">，则是指后来的请求。</span>  
<span class="o">%</span><span class="p">...</span><span class="nl">t</span><span class="p">:</span> <span class="err">以公共日志时间格式表示的时间（或称为标准英文格式）</span>  
<span class="nf">%t</span><span class="o">:</span> <span class="err">以指定格式</span><span class="n">format</span><span class="err">表示的时间</span>  
<span class="o">%</span><span class="p">...</span><span class="nl">T</span><span class="p">:</span> <span class="err">为响应请求而耗费的时间，以秒计</span>  
<span class="o">%</span><span class="p">...</span><span class="nl">u</span><span class="p">:</span> <span class="err">远程用户（来自</span><span class="n">auth</span><span class="err">；如果返回状态（</span><span class="nf">%s</span><span class="err">）是</span><span class="mi">401</span><span class="err">则可能是伪造的）</span>  
<span class="o">%</span><span class="p">...</span><span class="nl">U</span><span class="p">:</span> <span class="err">用户所请求的</span><span class="n">URL</span><span class="err">路径</span>  
<span class="o">%</span><span class="p">...</span><span class="nl">v</span><span class="p">:</span> <span class="err">响应请求的服务器的</span><span class="n">ServerName</span>  
<span class="o">%</span><span class="p">...</span><span class="nl">V</span><span class="p">:</span> <span class="err">依照</span><span class="n">UseCanonicalName</span><span class="err">设置得到的服务器名字</span>  
<span class="err">最后的</span><span class="n">tomcat</span><span class="err">的访问日志内容如下：</span>
<span class="mf">203.156.200.162</span> <span class="o">-</span> <span class="o">-</span> <span class="p">[</span><span class="mi">29</span><span class="o">/</span><span class="n">Aug</span><span class="o">/</span><span class="mi">2012</span><span class="o">:</span><span class="mi">11</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">58</span> <span class="o">+</span><span class="mi">0800</span><span class="p">]</span> <span class="s">&quot;GET /front/magazine/getContent.htm?contentId=124504 HTTP/1.1&quot;</span> 
<span class="mi">200</span> <span class="mi">20001</span>
<span class="mi">2</span><span class="err">、由于我的</span><span class="n">tomcat</span><span class="err">服务器是在其他机器上，所以我将</span><span class="n">tomcat</span><span class="err">的服务日志</span><span class="n">copy</span><span class="err">到本机的</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="err">下即可。</span>
<span class="err">如</span><span class="n">copy</span><span class="err">的文件是：</span><span class="n">localhost_access_log</span><span class="mf">.2012</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mf">29.</span><span class="n">txt</span>
<span class="mi">3</span><span class="err">、配置</span><span class="n">awstats</span><span class="err">分析此日志</span><span class="p">(</span><span class="n">tomcat</span> <span class="err">的域名并不是</span><span class="n">httpd</span><span class="err">的虚拟主机，所以没有写进</span><span class="n">httpd</span><span class="p">.</span><span class="n">conf</span><span class="err">文件里面</span><span class="p">)</span>
<span class="cp"># cd /usr/local/awstats/tools</span>
<span class="cp"># perl awstats_configure.pl</span>
<span class="o">-----</span> <span class="n">AWStats</span> <span class="n">awstats_configure</span> <span class="mf">1.0</span> <span class="p">(</span><span class="n">build</span> <span class="mf">1.9</span><span class="p">)</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="n">Laurent</span> <span class="n">Destailleur</span> <span class="o">-----</span>
<span class="n">This</span> <span class="n">tool</span> <span class="n">will</span> <span class="n">help</span> <span class="n">you</span> <span class="n">to</span> <span class="n">configure</span> <span class="n">AWStats</span> <span class="n">to</span> <span class="n">analyze</span> <span class="n">statistics</span> <span class="k">for</span>
<span class="n">one</span> <span class="n">web</span> <span class="n">server</span><span class="p">.</span> <span class="n">You</span> <span class="n">can</span> <span class="k">try</span> <span class="n">to</span> <span class="n">use</span> <span class="n">it</span> <span class="n">to</span> <span class="n">let</span> <span class="n">it</span> <span class="k">do</span> <span class="n">all</span> <span class="n">that</span> <span class="n">is</span> <span class="n">possible</span>
<span class="n">in</span> <span class="n">AWStats</span> <span class="n">setup</span><span class="p">,</span> <span class="n">however</span> <span class="n">following</span> <span class="n">the</span> <span class="n">step</span> <span class="n">by</span> <span class="n">step</span> <span class="n">manual</span> <span class="n">setup</span>
<span class="n">documentation</span> <span class="p">(</span><span class="n">docs</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">html</span><span class="p">)</span> <span class="n">is</span> <span class="n">often</span> <span class="n">a</span> <span class="n">better</span> <span class="n">idea</span><span class="p">.</span> <span class="n">Above</span> <span class="n">all</span> <span class="k">if</span><span class="o">:</span>
<span class="o">-</span> <span class="n">You</span> <span class="n">are</span> <span class="n">not</span> <span class="n">an</span> <span class="n">administrator</span> <span class="n">user</span><span class="p">,</span>
<span class="o">-</span> <span class="n">You</span> <span class="n">want</span> <span class="n">to</span> <span class="n">analyze</span> <span class="n">downloaded</span> <span class="n">log</span> <span class="n">files</span> <span class="n">without</span> <span class="n">web</span> <span class="n">server</span><span class="p">,</span>
<span class="o">-</span> <span class="n">You</span> <span class="n">want</span> <span class="n">to</span> <span class="n">analyze</span> <span class="n">mail</span> <span class="n">or</span> <span class="n">ftp</span> <span class="n">log</span> <span class="n">files</span> <span class="n">instead</span> <span class="n">of</span> <span class="n">web</span> <span class="n">log</span> <span class="n">files</span><span class="p">,</span>
<span class="o">-</span> <span class="n">You</span> <span class="n">need</span> <span class="n">to</span> <span class="n">analyze</span> <span class="n">load</span> <span class="n">balanced</span> <span class="n">servers</span> <span class="n">log</span> <span class="n">files</span><span class="p">,</span>
<span class="o">-</span> <span class="n">You</span> <span class="n">want</span> <span class="n">to</span> <span class="err">&#39;</span><span class="n">understand</span><span class="err">&#39;</span> <span class="n">all</span> <span class="n">possible</span> <span class="n">ways</span> <span class="n">to</span> <span class="n">use</span> <span class="n">AWStats</span><span class="p">...</span>
<span class="n">Read</span> <span class="n">the</span> <span class="n">AWStats</span> <span class="n">documentation</span> <span class="p">(</span><span class="n">docs</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">html</span><span class="p">).</span>

<span class="o">-----&gt;</span> <span class="n">Running</span> <span class="n">OS</span> <span class="nl">detected</span><span class="p">:</span> <span class="n">Linux</span><span class="p">,</span> <span class="n">BSD</span> <span class="n">or</span> <span class="n">Unix</span>

<span class="o">-----&gt;</span> <span class="n">Check</span> <span class="k">for</span> <span class="n">web</span> <span class="n">server</span> <span class="n">install</span>

<span class="n">Enter</span> <span class="n">full</span> <span class="n">config</span> <span class="n">file</span> <span class="n">path</span> <span class="n">of</span> <span class="n">your</span> <span class="n">Web</span> <span class="n">server</span><span class="p">.</span>
<span class="nl">Example</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">httpd</span><span class="p">.</span><span class="n">conf</span>
<span class="nl">Example</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">apache2</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">httpd</span><span class="p">.</span><span class="n">conf</span>
<span class="nl">Example</span><span class="p">:</span> <span class="nl">c</span><span class="p">:</span><span class="err">\</span><span class="n">Program</span> <span class="n">files</span><span class="err">\</span><span class="n">apache</span> <span class="n">group</span><span class="err">\</span><span class="n">apache</span><span class="err">\</span><span class="n">conf</span><span class="err">\</span><span class="n">httpd</span><span class="p">.</span><span class="n">conf</span>
<span class="n">Config</span> <span class="n">file</span> <span class="n">path</span> <span class="p">(</span><span class="err">&#39;</span><span class="n">none</span><span class="err">&#39;</span> <span class="n">to</span> <span class="n">skip</span> <span class="n">web</span> <span class="n">server</span> <span class="n">setup</span><span class="p">)</span><span class="o">:</span>
<span class="o">&gt;</span><span class="n">none</span>
<span class="n">Your</span> <span class="n">web</span> <span class="n">server</span> <span class="n">config</span> <span class="n">file</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">could</span> <span class="n">not</span> <span class="n">be</span> <span class="n">found</span><span class="p">.</span>
<span class="n">You</span> <span class="n">will</span> <span class="n">need</span> <span class="n">to</span> <span class="n">setup</span> <span class="n">your</span> <span class="n">web</span> <span class="n">server</span> <span class="n">manually</span> <span class="n">to</span> <span class="n">declare</span> <span class="n">AWStats</span>
<span class="n">script</span> <span class="n">as</span> <span class="n">a</span> <span class="n">CGI</span><span class="p">,</span> <span class="k">if</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">build</span> <span class="n">reports</span> <span class="n">dynamically</span><span class="p">.</span>
<span class="n">See</span> <span class="n">AWStats</span> <span class="n">setup</span> <span class="n">documentation</span> <span class="p">(</span><span class="n">file</span> <span class="n">docs</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">html</span><span class="p">)</span>

<span class="o">-----&gt;</span> <span class="n">Update</span> <span class="n">model</span> <span class="n">config</span> <span class="n">file</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">awstats</span><span class="o">/</span><span class="n">wwwroot</span><span class="o">/</span><span class="n">cgi</span><span class="o">-</span><span class="n">bin</span><span class="o">/</span><span class="n">awstats</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">conf</span><span class="err">&#39;</span>
 <span class="n">File</span> <span class="n">awstats</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">conf</span> <span class="n">updated</span><span class="p">.</span>

<span class="o">-----&gt;</span> <span class="n">Need</span> <span class="n">to</span> <span class="n">create</span> <span class="n">a</span> <span class="k">new</span> <span class="n">config</span> <span class="n">file</span> <span class="o">?</span>
<span class="n">Do</span> <span class="n">you</span> <span class="n">want</span> <span class="n">me</span> <span class="n">to</span> <span class="n">build</span> <span class="n">a</span> <span class="k">new</span> <span class="n">AWStats</span> <span class="n">config</span><span class="o">/</span><span class="n">profile</span>
<span class="n">file</span> <span class="p">(</span><span class="n">required</span> <span class="k">if</span> <span class="n">first</span> <span class="n">install</span><span class="p">)</span> <span class="p">[</span><span class="n">y</span><span class="o">/</span><span class="n">N</span><span class="p">]</span> <span class="o">?</span> <span class="n">y</span>

<span class="o">-----&gt;</span> <span class="n">Define</span> <span class="n">config</span> <span class="n">file</span> <span class="n">name</span> <span class="n">to</span> <span class="n">create</span>
<span class="n">What</span> <span class="n">is</span> <span class="n">the</span> <span class="n">name</span> <span class="n">of</span> <span class="n">your</span> <span class="n">web</span> <span class="n">site</span> <span class="n">or</span> <span class="n">profile</span> <span class="n">analysis</span> <span class="o">?</span>
<span class="nl">Example</span><span class="p">:</span> <span class="n">www</span><span class="p">.</span><span class="n">mysite</span><span class="p">.</span><span class="n">com</span>
<span class="nl">Example</span><span class="p">:</span> <span class="n">demo</span>
<span class="n">Your</span> <span class="n">web</span> <span class="n">site</span><span class="p">,</span> <span class="k">virtual</span> <span class="n">server</span> <span class="n">or</span> <span class="n">profile</span> <span class="nl">name</span><span class="p">:</span>
<span class="o">&gt;</span><span class="n">buoqu</span><span class="p">.</span><span class="n">com</span>
<span class="o">-----&gt;</span> <span class="n">Define</span> <span class="n">config</span> <span class="n">file</span> <span class="n">path</span>
<span class="n">In</span> <span class="n">which</span> <span class="n">directory</span> <span class="k">do</span> <span class="n">you</span> <span class="n">plan</span> <span class="n">to</span> <span class="n">store</span> <span class="n">your</span> <span class="n">config</span> <span class="n">file</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">?</span>
<span class="nl">Default</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">awstats</span>
<span class="n">Directory</span> <span class="n">path</span> <span class="n">to</span> <span class="n">store</span> <span class="n">config</span> <span class="n">file</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">(</span><span class="n">Enter</span> <span class="k">for</span> <span class="k">default</span><span class="p">)</span><span class="o">:</span>
<span class="o">&gt;</span>

<span class="o">-----&gt;</span> <span class="n">Create</span> <span class="n">config</span> <span class="n">file</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">awstats</span><span class="o">/</span><span class="n">awstats</span><span class="p">.</span><span class="n">buoqu</span><span class="p">.</span><span class="n">com</span><span class="p">.</span><span class="n">conf</span><span class="err">&#39;</span>
 <span class="n">Config</span> <span class="n">file</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">awstats</span><span class="o">/</span><span class="n">awstats</span><span class="p">.</span><span class="n">buoqu</span><span class="p">.</span><span class="n">com</span><span class="p">.</span><span class="n">conf</span> <span class="n">created</span><span class="p">.</span>

<span class="o">-----&gt;</span> <span class="n">Add</span> <span class="n">update</span> <span class="n">process</span> <span class="n">inside</span> <span class="n">a</span> <span class="n">scheduler</span>
<span class="n">Sorry</span><span class="p">,</span> <span class="n">configure</span><span class="p">.</span><span class="n">pl</span> <span class="n">does</span> <span class="n">not</span> <span class="n">support</span> <span class="n">automatic</span> <span class="n">add</span> <span class="n">to</span> <span class="n">cron</span> <span class="n">yet</span><span class="p">.</span>
<span class="n">You</span> <span class="n">can</span> <span class="k">do</span> <span class="n">it</span> <span class="n">manually</span> <span class="n">by</span> <span class="n">adding</span> <span class="n">the</span> <span class="n">following</span> <span class="n">command</span> <span class="n">to</span> <span class="n">your</span> <span class="nl">cron</span><span class="p">:</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">awstats</span><span class="o">/</span><span class="n">wwwroot</span><span class="o">/</span><span class="n">cgi</span><span class="o">-</span><span class="n">bin</span><span class="o">/</span><span class="n">awstats</span><span class="p">.</span><span class="n">pl</span> <span class="o">-</span><span class="n">update</span> <span class="o">-</span><span class="n">config</span><span class="o">=</span><span class="n">buoqu</span><span class="p">.</span><span class="n">com</span>
<span class="n">Or</span> <span class="k">if</span> <span class="n">you</span> <span class="n">have</span> <span class="n">several</span> <span class="n">config</span> <span class="n">files</span> <span class="n">and</span> <span class="n">prefer</span> <span class="n">having</span> <span class="n">only</span> <span class="n">one</span> <span class="nl">command</span><span class="p">:</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">awstats</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">awstats_updateall</span><span class="p">.</span><span class="n">pl</span> <span class="n">now</span>
<span class="n">Press</span> <span class="n">ENTER</span> <span class="n">to</span> <span class="k">continue</span><span class="p">...</span>


<span class="n">A</span> <span class="n">SIMPLE</span> <span class="n">config</span> <span class="n">file</span> <span class="n">has</span> <span class="n">been</span> <span class="nl">created</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">awstats</span><span class="o">/</span><span class="n">awstats</span><span class="p">.</span><span class="n">buoqu</span><span class="p">.</span><span class="n">com</span><span class="p">.</span><span class="n">conf</span>
<span class="n">You</span> <span class="n">should</span> <span class="n">have</span> <span class="n">a</span> <span class="n">look</span> <span class="n">inside</span> <span class="n">to</span> <span class="n">check</span> <span class="n">and</span> <span class="n">change</span> <span class="n">manually</span> <span class="n">main</span> <span class="n">parameters</span><span class="p">.</span>
<span class="n">You</span> <span class="n">can</span> <span class="n">then</span> <span class="n">manually</span> <span class="n">update</span> <span class="n">your</span> <span class="n">statistics</span> <span class="k">for</span> <span class="err">&#39;</span><span class="n">buoqu</span><span class="p">.</span><span class="n">com</span><span class="err">&#39;</span> <span class="n">with</span> <span class="nl">command</span><span class="p">:</span>
<span class="o">&gt;</span> <span class="n">perl</span> <span class="n">awstats</span><span class="p">.</span><span class="n">pl</span> <span class="o">-</span><span class="n">update</span> <span class="o">-</span><span class="n">config</span><span class="o">=</span><span class="n">buoqu</span><span class="p">.</span><span class="n">com</span>
<span class="n">You</span> <span class="n">can</span> <span class="n">also</span> <span class="n">build</span> <span class="k">static</span> <span class="n">report</span> <span class="n">pages</span> <span class="k">for</span> <span class="err">&#39;</span><span class="n">buoqu</span><span class="p">.</span><span class="n">com</span><span class="err">&#39;</span> <span class="n">with</span> <span class="nl">command</span><span class="p">:</span>
<span class="o">&gt;</span> <span class="n">perl</span> <span class="n">awstats</span><span class="p">.</span><span class="n">pl</span> <span class="o">-</span><span class="n">output</span><span class="o">=</span><span class="n">pagetype</span> <span class="o">-</span><span class="n">config</span><span class="o">=</span><span class="n">buoqu</span><span class="p">.</span><span class="n">com</span>

<span class="n">Press</span> <span class="n">ENTER</span> <span class="n">to</span> <span class="n">finish</span><span class="p">...</span>
<span class="mi">4</span><span class="err">、修改要分析日志文件</span>
<span class="cp"># vim /etc/awstats/awstats.buoqu.com.conf</span>
<span class="err">将</span><span class="n">LogFile</span><span class="o">=</span><span class="s">&quot;/var/log/httpd/mylog.log&quot;</span>
<span class="err">改为</span>
<span class="n">LogFile</span><span class="o">=</span><span class="s">&quot;/usr/local/awstats/tools/logresolvemerge.pl /usr/local/awstats/flashlog/china/localhost_access_log.%</span>
<span class="n">YYYY</span><span class="o">-</span><span class="mi">24</span><span class="o">-%</span><span class="n">MM</span><span class="o">-</span><span class="mi">24</span><span class="o">-%</span><span class="n">DD</span><span class="o">-</span><span class="mf">24.</span><span class="n">txt</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">awstats</span><span class="o">/</span><span class="n">flashlog</span><span class="o">/</span><span class="n">usa</span><span class="o">/</span><span class="n">localhost_access_log</span><span class="p">.</span><span class="o">%</span><span class="n">YYYY</span><span class="o">-</span><span class="mi">24</span><span class="o">-%</span><span class="n">MM</span><span class="o">-</span><span class="mi">24</span><span class="o">-%</span><span class="n">DD</span><span class="o">-</span><span class="mf">24.</span><span class="n">txt</span> <span class="o">|</span><span class="s">&quot;</span>
<span class="mi">5</span><span class="err">、重启</span><span class="n">httpd</span><span class="err">服务，并分析日志</span>
<span class="cp"># service httpd restart</span>
<span class="cp"># cd /usr/local/awstats/wwwroot/cgi-bin</span>
<span class="cp"># perl awstats.pl -update -config=buoqu.com</span>

<span class="n">Setup</span> <span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">awstats</span><span class="o">/</span><span class="n">awstats</span><span class="p">.</span><span class="n">buoqu</span><span class="p">.</span><span class="n">com</span><span class="p">.</span><span class="n">conf</span><span class="err">&#39;</span> <span class="n">file</span><span class="p">,</span> <span class="n">web</span> <span class="n">server</span> <span class="n">or</span> <span class="n">permissions</span><span class="p">)</span> <span class="n">may</span> <span class="n">be</span> <span class="n">wrong</span><span class="p">.</span>
<span class="n">Check</span> <span class="n">config</span> <span class="n">file</span><span class="p">,</span> <span class="n">permissions</span> <span class="n">and</span> <span class="n">AWStats</span> <span class="n">documentation</span> <span class="p">(</span><span class="n">in</span> <span class="err">&#39;</span><span class="n">docs</span><span class="err">&#39;</span> <span class="n">directory</span><span class="p">).</span>
<span class="err">出错：日志格式不匹配。</span>
<span class="err">解决：这个时候，就知道我为什么要先了解怎么定义</span><span class="n">tomcat</span><span class="err">的日志格式了。</span>
<span class="err">修改文件</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">awstats</span><span class="o">/</span><span class="n">awstats</span><span class="p">.</span><span class="n">buoqu</span><span class="p">.</span><span class="n">com</span><span class="p">.</span><span class="n">conf</span>
<span class="cp"># vim /etc/awstats/awstats.buoqu.com.conf</span>
<span class="n">LogFormat</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">LogFormat</span> <span class="o">=</span><span class="s">&quot;%host %other %logname %time1 %methodurl %code %bytesd&quot;</span>   <span class="err">自定义格式</span>

<span class="cp"># perl awstats.pl -update -config=buoqu.com</span>
<span class="mi">6</span><span class="err">、打开网址查看分析结果：</span>

<span class="nl">http</span><span class="p">:</span><span class="c1">//10.100.10.11/awstats/awstats.pl?config=buoqu.com</span>


<span class="mi">7</span><span class="err">、手动执行命令可写入</span><span class="n">crontab</span><span class="err">。</span>
<span class="err">①、如果，想在分析页面上直接刷新，可以开启</span><span class="n">AllowToUpdateStatsFromBrowser</span><span class="o">=</span><span class="mi">1</span><span class="err">，默认情况下是关闭的。</span>
<span class="err">②、若是想每个页面上都直接有“立即更新”的按钮，而不想每次都手动的修改配置文件的话，可以再</span><span class="n">awstats</span><span class="err">的基本配置文件里修改。</span>
<span class="cp"># cd /usr/local/awstats/wwwroot/cgi-bin</span>
<span class="cp"># vim awstats.model.conf</span>
<span class="err">将</span><span class="n">AllowToUpdateStatsFromBrowser</span><span class="o">=</span><span class="mi">0</span><span class="err">改为</span><span class="n">AllowToUpdateStatsFromBrowser</span><span class="o">=</span><span class="mi">1</span><span class="err">即可。</span>
<span class="err">这样，以后的网页都可以直接点击刷新的。</span>
<span class="err">注意：每次修改配置文件后要重启</span><span class="n">httpd</span><span class="err">服务</span>
<span class="err">③、若是要在浏览器上直接刷新，那么</span><span class="n">apache</span><span class="err">用户就要有对数据文件操作的权限</span>
<span class="cp"># chown apache.apache –R /var/lib/awstats</span>
<span class="cp"># chmod 755 /var/log/httpd</span>
<span class="err">效果如图：</span>

<span class="err">四、添加一些插件，使</span><span class="n">awstats</span><span class="err">看起来更人性化和直观化。</span>
<span class="n">IP</span><span class="err">显示地区</span>
<span class="n">wget</span> <span class="nl">http</span><span class="p">:</span><span class="c1">//geolite.maxmind.com/download/geoip/database/GeoLiteCountry/GeoIP.dat.gz</span>
<span class="n">wget</span> <span class="nl">http</span><span class="p">:</span><span class="c1">//geolite.maxmind.com/download/geoip/database/GeoLiteCity.dat.gz</span>
<span class="n">gunzip</span> <span class="n">GeoIP</span><span class="p">.</span><span class="n">dat</span><span class="p">.</span><span class="n">gz</span>
<span class="n">gunzip</span> <span class="n">GeoLiteCity</span><span class="p">.</span><span class="n">dat</span><span class="p">.</span><span class="n">gz</span>
<span class="n">mv</span> <span class="o">*</span><span class="p">.</span><span class="n">dat</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span>
<span class="n">yum</span> <span class="n">install</span> <span class="n">GeoIP</span> <span class="n">perl</span><span class="o">-</span><span class="n">Geo</span><span class="o">-</span><span class="n">IP</span>
<span class="n">perl</span> <span class="o">-</span><span class="n">MCPAN</span> <span class="o">-</span><span class="n">e</span> <span class="s">&quot;install Geo::IP::PurePerl&quot;</span>

<span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">awstats</span><span class="o">/</span><span class="n">awstats</span><span class="p">.</span><span class="n">www</span><span class="p">.</span><span class="n">test</span><span class="p">.</span><span class="n">com</span><span class="p">.</span><span class="n">conf</span>
<span class="err">将以下语句的#注释去掉：</span>
<span class="cp">#LoadPlugin=&quot;tooltips&quot;      在html报告中增加一些提示信息</span>
<span class="cp">#LoadPlugin=&quot;decodeutfkeys&quot; 处理搜索引擎UTF8编码的关键字</span>

<span class="cp">#LoadPlugin=&quot;geoip GEOIP_STANDARD /pathto/GeoIP.dat&quot; #1429行</span>
<span class="cp">#LoadPlugin=&quot;geoip_city_maxmind GEOIP_STANDARD /pathto/GeoIPCity.dat&quot; #1438行</span>
<span class="err">修改为：</span>
<span class="n">LoadPlugin</span><span class="o">=</span><span class="s">&quot;geoip GEOIP_STANDARD /var/geoip/GeoIP.dat&quot;</span>
<span class="n">LoadPlugin</span><span class="o">=</span><span class="s">&quot;geoip_city_maxmind GEOIP_STANDARD /var/geoip/GeoLiteCity.dat&quot;</span>

 <span class="err">使用</span><span class="n">QQ</span><span class="err">纯真版</span><span class="n">IP</span>
<span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="err">在</span><span class="n">awstats</span><span class="err">的</span><span class="n">wwwroot</span><span class="err">下的</span><span class="n">plugin</span><span class="err">目录里下载</span>
<span class="n">cd</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">awstats</span><span class="o">/</span><span class="n">wwwroot</span><span class="o">/</span><span class="n">cgi</span><span class="o">-</span><span class="n">bin</span><span class="o">/</span><span class="n">plugins</span>
<span class="cp"># yum安装时目录为：/usr/share/awstats/wwwroot/cgi-bin/plugins ，没有则建立</span>
<span class="n">wget</span> <span class="nl">http</span><span class="p">:</span><span class="c1">//www.haiyun.me/download/qqwry.pl</span>
<span class="n">wget</span> <span class="nl">http</span><span class="p">:</span><span class="c1">//www.haiyun.me/download/qqhostinfo.pm</span>
<span class="err">获取最新的</span><span class="n">IP</span><span class="err">信息的方式为：到</span><span class="n">update</span><span class="p">.</span><span class="n">cz88</span><span class="p">.</span><span class="n">net</span><span class="err">中下在</span><span class="n">windows</span><span class="err">安装版，之后在安装目录里有</span><span class="n">qqwry</span><span class="p">.</span><span class="n">dat</span><span class="err">，既是最新的数据。</span>
<span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="err">上传</span><span class="n">qqwry</span><span class="err">到</span><span class="n">awstats</span><span class="err">的</span><span class="n">wwwroot</span><span class="err">下的</span><span class="n">plugin</span><span class="err">目录里</span><span class="p">.</span>
<span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="err">修改插件配置</span>
<span class="cp">#修改qqwry.pl内IP数据目录：</span>
<span class="n">my</span> <span class="n">$ipfile</span><span class="o">=</span><span class="s">&quot;${DIR}/plugins/qqwry.dat&quot;</span><span class="p">;</span>
<span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="err">添加插件到</span><span class="n">awstats</span>
<span class="cp">#修改awstats配置加载扩展：</span>
<span class="n">LoadPlugin</span><span class="o">=</span><span class="s">&quot;qqhostinfo&quot;</span>
<span class="err">删除旧的统计数据库</span>  <span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">awstats</span><span class="cm">/*</span>
<span class="cm">重新生成一下数据库     /usr/local/awstats/wwwroot/cgi-bin/awstats.pl -update -config=</span>
<span class="cm">www.test.com</span>

<span class="cm">-------------------------------------------------</span>
<span class="cm">#!/usr/bin/env bash</span>
<span class="cm">rsync -avz /var/lib/awstats/ /usr/local/awstats/var-lib-awstats</span>
<span class="cm">find /usr/local/awstats/flashlog/ -mtime +1 -exec rm -f {} \;</span>

<span class="cm">Date=$(date +%Y-%m-%d -d &quot;1 day ago&quot;)</span>
<span class="cm">#101.200.131.163 flash china</span>
<span class="cm">rsync -avz &#39;-e ssh -p 27554&#39; 10.44.28.154:/usr/local/tomcat/logs/localhost_access_log.$Date.txt</span>
<span class="cm"> /usr/local/awstats/flashlog/china/</span>
<span class="cm">rsync -avz &#39;-e ssh -p 27554&#39; 47.88.7.159:/usr/local/tomcat/logs/localhost_access_log.$Date.txt </span>
<span class="cm"> /usr/local/awstats/flashlog/usa/</span>

<span class="cm">/usr/local/awstats/wwwroot/cgi-bin/awstats.pl -update -config=flash</span>
<span class="cm"># http://monitor.3mang.com/awstats/awstats.pl?config=flash</span>

<span class="cm">-----------------------------------------------------------</span>
<span class="cm">#awstats log   定时任务</span>
<span class="cm">0 1 * * * /bin/bash /usr/local/awstats/scplog.sh &gt; /usr/local/awstats/scplog.log 2&amp;&gt;1</span>

<span class="cm">awstats分析多个日志</span>
<span class="cm">分析单个日志：</span>
<span class="cm">LogFile=&quot;/usr/local/nginx/logs/host.access.log&quot;</span>
<span class="cm">分析多个日志：</span>
<span class="cm">1）分开写</span>
<span class="cm">LogFile=&quot;/usr/local/awstats/tools/logresolvemerge.pl /usr/local/nginx/logs/231.pcstars_access.log </span>
<span class="cm">/usr/local/nginx/logs/232.pcstars_access.log /usr/local/nginx/logs/233.pcstars_access.log</span>
<span class="cm"> /usr/local/nginx/logs/234.pcstars_access.log /usr/local/nginx/logs/mg.pcstars_access.log|&quot;</span>
<span class="cm">2)以匹配模式:</span>
<span class="cm">LogFile=&quot;/usr/local/awstats/tools/logresolvemerge.pl /usr/local/nginx/logs/*.pcstars_access.log|&quot;</span>
<span class="cm">说明：使用 awstats 内建的工具logresolvemerge.pl 来合并日志，记的后面加一个&quot;|&quot;，表示匹配你要一起合并分析的日志</span>
<span class="cm">完成awstats配置文件的设置之后，需要更新记录：</span>
<span class="cm"> /usr/local/awstats/tools/awstats_updateall.pl now</span>
<span class="cm"> 或</span>
<span class="cm"> /usr/local/awstats/wwwroot/cgi-bin/awstats.pl -update -config=www.nginx.log -configdir=&quot;/etc/awstats&quot;</span>
</pre></div>


<h2 id="_1">访问分析</h2>
<div class="codehilite"><pre><span></span><span class="n">PIWIK</span>
<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">piwik</span><span class="p">.</span><span class="n">org</span><span class="o">/</span>


<span class="n">Google</span> <span class="n">Analytics</span>
<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">developers</span><span class="p">.</span><span class="n">google</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">analytics</span><span class="o">/?</span><span class="n">hl</span><span class="o">=</span><span class="n">zh</span><span class="o">-</span><span class="n">cn</span>
</pre></div>


<h2 id="es_date">es_date</h2>
<p>elasticsearch原生支持date类型，结合该类型和Kibana可以做出漂亮有用的图表。这里简单记录下使用的方法。</p>
<p>使用date类型可以用如下两种方式：</p>
<p>使用毫秒的时间戳，直接将毫秒值传入即可。</p>
<p>传入格式化的字符串，默认是ISO 8601标准，例如2015-02-27T00:07Z(零时区)、2015-02-27T08:07+08:00(东八区),这两个时间实际是同一个，只是时区不同，关于时间戳，可以参见我之前的文章。另外还可以自定义时间格式，参见es的文档。但个人不建议使用自定义格式，设置不当容易遇到时区问题。在php中获取ISO 8601标准的时间很简单，date('c',time()）即可。</p>
<p>elasticsearch默认会自动识别date类型，如果想关闭该功能，修改mapping的设置'date_detection' =&gt; false即可 。</p>
<p>elasticsearch原生支持date类型，json格式通过字符来表示date类型。所以在用json提交日期至elasticsearch的时候，es会隐式转换，把es认为是date类型的字符串直接转为date类型。至于什么样的字符串es会认为可以转换成date类型，参考elasticsearch官网介绍https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-date-format.html。</p>
<p>date类型是包含时区信息的，如果我们没有在json代表日期的字符串中显式指定时区，对es来说没什么问题，但是如果通过kibana显示es里的数据时，就会出现问题，数据的时间会晚8个小时。因为kibana从es里读取的date类型数据，没有时区信息，kibana会默认当作0时区来解析，但是kibana在通过浏览器展示的时候，会通过js获取当前客户端机器所在的时区，也就是东八区，所以kibana会把从es得到的日期数据减去8小时。这里就会导致kibana经常遇到的“数据时间延迟8小时”的问题。</p>
<p>所以最佳实践方案就是：我们在往es提交日期数据的时候，直接提交带有时区信息的日期字符串，如：“2016-07-15T12:58:17.136+0800”。</p>
<h2 id="logstash">logstash区分数据</h2>
<div class="codehilite"><pre><span></span>场景，<span class="nv">logstash</span>采集<span class="mi">2</span>个数据源<span class="nv">A</span>和<span class="nv">B</span>，<span class="nv">A</span>数据源的入<span class="nv">kafka</span>，<span class="nv">B</span>数据源的都入<span class="nv">es</span>。

语法

<span class="nv">Input</span>{ 
  <span class="nv">file</span> { <span class="nv">path</span> <span class="o">=&gt;</span> <span class="nv">a</span>  <span class="nv">type</span> <span class="o">=&gt;</span> <span class="nv">A</span> }
  <span class="nv">file</span> { <span class="nv">path</span> <span class="o">=&gt;</span> <span class="nv">b</span>  <span class="nv">type</span> <span class="o">=&gt;</span> <span class="nv">B</span> }
}

<span class="nv">output</span> {
  <span class="k">if</span> [<span class="nv">type</span>] <span class="o">==</span> <span class="s2">&quot;</span><span class="s">A</span><span class="s2">&quot;</span> {
    <span class="nv">kafka</span> {...}
  }
  <span class="k">if</span> [<span class="nv">type</span>] <span class="o">==</span> <span class="s2">&quot;</span><span class="s">B</span><span class="s2">&quot;</span> {
    <span class="nv">es</span> {...}
  }
}
我的实现的场景：

<span class="nv">bin</span><span class="o">/</span><span class="nv">logstash</span> <span class="o">-</span><span class="nv">e</span> <span class="s1">&#39;</span><span class="s">input{</span>
   <span class="nv">file</span>{
    <span class="nv">type</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="s">normal</span><span class="s2">&quot;</span>
    <span class="nv">path</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="s">/data/log/test/abc*.log</span><span class="s2">&quot;</span>
    <span class="nv">start_position</span> <span class="o">=&gt;</span> <span class="nv">beginning</span>
    <span class="nv">exclude</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="s">*abc*.log</span><span class="s2">&quot;</span>
  }

  <span class="nv">file</span>{
    <span class="nv">type</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="s">error</span><span class="s2">&quot;</span>
    <span class="nv">path</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="s">/data/log/test/*error*.log</span><span class="s2">&quot;</span>
    <span class="nv">start_position</span> <span class="o">=&gt;</span> <span class="nv">beginning</span>
  }
}
<span class="nv">output</span>{
<span class="k">if</span> [<span class="nv">type</span>] <span class="o">==</span> <span class="s2">&quot;</span><span class="s">error</span><span class="s2">&quot;</span> {
    <span class="nv">kafka</span>{
       <span class="nv">bootstrap_servers</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="s">127.0.0.1:9092,127.0.0.1:9092</span><span class="s2">&quot;</span>
       <span class="nv">topic_id</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="s">loga</span><span class="s2">&quot;</span>
      }
}
    <span class="nv">stdout</span>{<span class="nv">codec</span><span class="o">=&gt;</span><span class="nv">rubydebug</span>}
}<span class="s1">&#39;</span>
</pre></div>


<h2 id="winlogbeat">winlogbeat</h2>
<p>配置 winlogbeat.yml   配置ignore_older，否则会导入系统里很久之前的数据</p>
<div class="codehilite"><pre><span></span><span class="n">winlogbeat</span><span class="p">.</span><span class="n">event_logs</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Application</span>
      <span class="n">ignore_older</span><span class="p">:</span> <span class="mi">48</span><span class="n">h</span>
      <span class="n">provider</span><span class="p">:</span>
          <span class="o">-</span> <span class="n">Application</span> <span class="n">Error</span>
          <span class="o">-</span> <span class="n">Application</span> <span class="n">Hang</span>
          <span class="o">-</span> <span class="n">Windows</span> <span class="n">Error</span> <span class="n">Reporting</span>
          <span class="o">-</span> <span class="n">EMET</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="k">Security</span>
      <span class="k">level</span><span class="p">:</span> <span class="n">critical</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">warning</span>
      <span class="n">event_id</span><span class="p">:</span> <span class="mi">4624</span><span class="p">,</span> <span class="mi">4625</span><span class="p">,</span> <span class="mi">4700</span><span class="o">-</span><span class="mi">4800</span><span class="p">,</span> <span class="o">-</span><span class="mi">4735</span>
      <span class="n">ignore_older</span><span class="p">:</span> <span class="mi">48</span><span class="n">h</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="k">System</span>
      <span class="k">level</span><span class="p">:</span> <span class="n">critical</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">warning</span>
      <span class="n">ignore_older</span><span class="p">:</span> <span class="mi">48</span><span class="n">h</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Microsoft</span><span class="o">-</span><span class="n">Windows</span><span class="o">-</span><span class="n">Windows</span> <span class="n">Defender</span><span class="o">/</span><span class="n">Operational</span>
      <span class="n">include_xml</span><span class="p">:</span> <span class="k">true</span>
      <span class="n">ignore_older</span><span class="p">:</span> <span class="mi">48</span><span class="n">h</span>
</pre></div>


<p><strong>导入es模板</strong> scripts\import_dashboards.exe -es <a href="http://192.168.33.60:9200">http://192.168.33.60:9200</a></p>
<p><strong>安装服务</strong></p>
<p>powershell管理员运行 .\install-service-winlogbeat.ps1</p>
<p>执行报错scripts is disabled on this system 需要先执行  Set-ExecutionPolicy RemoteSigned解除限制</p>
<p>net start/stop winlogbeat</p>
<p><strong>命令行运行</strong>  .\winlogbeat.exe -c .\winlogbeat.yml</p>
<h2 id="filebeat">filebeat例子</h2>
<p>https://www.elastic.co/guide/en/logstash/current/logstash-config-for-filebeat-modules.html#parsing-system</p>
<p>Apache 2 Logs</p>
<p>MySQL Logs</p>
<p>Nginx Logs</p>
<p>System Logs</p>
<p>Apache 2 Access Logsedit</p>
<p>Example Filebeat config:</p>
<p>filebeat.prospectors:</p>
<ul>
<li>input_type: log</li>
</ul>
<p>paths:</p>
<ul>
<li>
<p>/var/log/apache2/access.log*</p>
</li>
<li>
<p>/var/log/apache2/other_vhosts_access.log*</p>
</li>
</ul>
<p>exclude_files: [".gz$"]</p>
<p>output.logstash:</p>
<p>hosts: ["localhost:5044"]</p>
<p>Example Logstash pipeline config:</p>
<p>input {</p>
<p>beats {</p>
<p># The port to listen on for filebeat connections.</p>
<p>port =&gt; 5044</p>
<p># The IP address to listen for filebeat connections.</p>
<p>host =&gt; "0.0.0.0"</p>
<p>}</p>
<p>}</p>
<p>filter {</p>
<p>grok {</p>
<p>match =&gt; { "message" =&gt; ["%{IPORHOST:[apache2][access][remote_ip]} - %{DATA:[apache2][access][user_name]} \[%{HTTPDATE:[apache2][access][time]}\] \"%{WORD:[apache2][access][method]} %{DATA:[apache2][access][url]} HTTP/%{NUMBER:[apache2][access][http_version]}\" %{NUMBER:[apache2][access][response_code]} %{NUMBER:[apache2][access][body_sent][bytes]}( \"%{DATA:[apache2][access][referrer]}\")?( \"%{DATA:[apache2][access][agent]}\")?",</p>
<p>"%{IPORHOST:[apache2][access][remote_ip]} - %{DATA:[apache2][access][user_name]} \[%{HTTPDATE:[apache2][access][time]}\] \"-\" %{NUMBER:[apache2][access][response_code]} -" ] }</p>
<p>remove_field =&gt; "message"</p>
<p>}</p>
<p>mutate {</p>
<p>add_field =&gt; { "read_timestamp" =&gt; "%{@timestamp}" }</p>
<p>}</p>
<p>date {</p>
<p>match =&gt; [ "[apache2][access][time]", "dd/MMM/YYYY:H:m:s Z" ]</p>
<p>remove_field =&gt; "[apache2][access][time]"</p>
<p>}</p>
<p>useragent {</p>
<p>source =&gt; "[apache2][access][agent]"</p>
<p>target =&gt; "[apache2][access][user_agent]"</p>
<p>remove_field =&gt; "[apache2][access][agent]"</p>
<p>}</p>
<p>geoip {</p>
<p>source =&gt; "[apache2][access][remote_ip]"</p>
<p>target =&gt; "[apache2][access][geoip]"</p>
<p>}</p>
<p>}</p>
<p>output {</p>
<p>elasticsearch {</p>
<p>hosts =&gt; localhost</p>
<p>manage_template =&gt; false</p>
<p>index =&gt; "%{[@metadata][beat]}-%{+YYYY.MM.dd}"</p>
<p>document_type =&gt; "%{[@metadata][type]}"</p>
<p>}</p>
<p>}</p>
<p>Apache 2 Error Logsedit</p>
<p>Example Filebeat config:</p>
<p>filebeat.prospectors:</p>
<ul>
<li>input_type: log</li>
</ul>
<p>paths:</p>
<ul>
<li>/var/log/apache2/error.log*</li>
</ul>
<p>exclude_files: [".gz$"]</p>
<p>output.logstash:</p>
<p>hosts: ["localhost:5044"]</p>
<p>Example Logstash pipeline config:</p>
<p>input {</p>
<p>beats {</p>
<p># The port to listen on for filebeat connections.</p>
<p>port =&gt; 5044</p>
<p># The IP address to listen for filebeat connections.</p>
<p>host =&gt; "0.0.0.0"</p>
<p>}</p>
<p>}</p>
<p>filter {</p>
<p>grok {</p>
<p>match =&gt; { "message" =&gt; ["\[%{APACHE_TIME:[apache2][error][timestamp]}\] \[%{LOGLEVEL:[apache2][error][level]}\]( \[client %{IPORHOST:[apache2][error][client]}\])? %{GREEDYDATA:[apache2][error][message]}",</p>
<p>"\[%{APACHE_TIME:[apache2][error][timestamp]}\] \[%{DATA:[apache2][error][module]}:%{LOGLEVEL:[apache2][error][level]}\] \[pid %{NUMBER:[apache2][error][pid]}(:tid %{NUMBER:[apache2][error][tid]})?\]( \[client %{IPORHOST:[apache2][error][client]}\])? %{GREEDYDATA:[apache2][error][message1]}" ] }</p>
<p>pattern_definitions =&gt; {</p>
<p>"APACHE_TIME" =&gt; "%{DAY} %{MONTH} %{MONTHDAY} %{TIME} %{YEAR}"</p>
<p>}</p>
<p>remove_field =&gt; "message"</p>
<p>}</p>
<p>mutate {</p>
<p>rename =&gt; { "[apache2][error][message1]" =&gt; "[apache2][error][message]" }</p>
<p>}</p>
<p>date {</p>
<p>match =&gt; [ "[apache2][error][timestamp]", "EEE MMM dd H:m:s YYYY", "EEE MMM dd H:m:s.SSSSSS YYYY" ]</p>
<p>remove_field =&gt; "[apache2][error][timestamp]"</p>
<p>}</p>
<p>}</p>
<p>output {</p>
<p>elasticsearch {</p>
<p>hosts =&gt; localhost</p>
<p>manage_template =&gt; false</p>
<p>index =&gt; "%{[@metadata][beat]}-%{+YYYY.MM.dd}"</p>
<p>document_type =&gt; "%{[@metadata][type]}"</p>
<p>}</p>
<p>}</p>
<p>MySQL Logsedit</p>
<p>Here are some configuration examples for shipping and parsing MySQL error and slowlog logs.</p>
<p>MySQL Error Logsedit</p>
<p>Example Filebeat config:</p>
<p>filebeat.prospectors:</p>
<ul>
<li>input_type: log</li>
</ul>
<p>paths:</p>
<ul>
<li>
<p>/var/log/mysql/error.log*</p>
</li>
<li>
<p>/var/log/mysqld.log*</p>
</li>
</ul>
<p>exclude_files: [".gz$"]</p>
<p>output.logstash:</p>
<p>hosts: ["localhost:5044"]</p>
<p>Example Logstash pipeline config:</p>
<p>input {</p>
<p>beats {</p>
<p># The port to listen on for filebeat connections.</p>
<p>port =&gt; 5044</p>
<p># The IP address to listen for filebeat connections.</p>
<p>host =&gt; "0.0.0.0"</p>
<p>}</p>
<p>}</p>
<p>filter {</p>
<p>grok {</p>
<p>match =&gt; { "message" =&gt; ["%{LOCALDATETIME:[mysql][error][timestamp]} (\[%{DATA:[mysql][error][level]}\] )?%{GREEDYDATA:[mysql][error][message]}",</p>
<p>"%{TIMESTAMP_ISO8601:[mysql][error][timestamp]} %{NUMBER:[mysql][error][thread_id]} \[%{DATA:[mysql][error][level]}\] %{GREEDYDATA:[mysql][error][message1]}",</p>
<p>"%{GREEDYDATA:[mysql][error][message2]}"] }</p>
<p>pattern_definitions =&gt; {</p>
<p>"LOCALDATETIME" =&gt; "[0-9]+ %{TIME}"</p>
<p>}</p>
<p>remove_field =&gt; "message"</p>
<p>}</p>
<p>mutate {</p>
<p>rename =&gt; { "[mysql][error][message1]" =&gt; "[mysql][error][message]" }</p>
<p>}</p>
<p>mutate {</p>
<p>rename =&gt; { "[mysql][error][message2]" =&gt; "[mysql][error][message]" }</p>
<p>}</p>
<p>date {</p>
<p>match =&gt; [ "[mysql][error][timestamp]", "ISO8601", "YYMMdd H:m:s" ]</p>
<p>remove_field =&gt; "[apache2][access][time]"</p>
<p>}</p>
<p>}</p>
<p>output {</p>
<p>elasticsearch {</p>
<p>hosts =&gt; localhost</p>
<p>manage_template =&gt; false</p>
<p>index =&gt; "%{[@metadata][beat]}-%{+YYYY.MM.dd}"</p>
<p>document_type =&gt; "%{[@metadata][type]}"</p>
<p>}</p>
<p>}</p>
<p>MySQL Slowlogedit</p>
<p>Example Filebeat config:</p>
<p>filebeat.prospectors:</p>
<ul>
<li>input_type: log</li>
</ul>
<p>paths:</p>
<ul>
<li>
<p>/var/log/mysql/mysql-slow.log*</p>
</li>
<li>
<p>/var/lib/mysql/hostname-slow.log</p>
</li>
</ul>
<p>exclude_files: [".gz$"]</p>
<p>multiline:</p>
<p>pattern: "^# User@Host: "</p>
<p>negate: true</p>
<p>match: after</p>
<p>output.logstash:</p>
<p>hosts: ["localhost:5044"]</p>
<p>Example Logstash pipeline config:</p>
<p>input {</p>
<p>beats {</p>
<p># The port to listen on for filebeat connections.</p>
<p>port =&gt; 5044</p>
<p># The IP address to listen for filebeat connections.</p>
<p>host =&gt; "0.0.0.0"</p>
<p>}</p>
<p>}</p>
<p>filter {</p>
<p>grok {</p>
<p>match =&gt; { "message" =&gt; ["^# User@Host: %{USER:[mysql][slowlog][user]}(\[[^\]]+\])? @ %{HOSTNAME:[mysql][slowlog][host]} \[(IP:[mysql][slowlog][ip])?\](\s*Id:\s* %{NUMBER:[mysql][slowlog][id]})?\n# Query_time: %{NUMBER:[mysql][slowlog][query_time][sec]}\s* Lock_time: %{NUMBER:[mysql][slowlog][lock_time][sec]}\s* Rows_sent: %{NUMBER:[mysql][slowlog][rows_sent]}\s* Rows_examined: %{NUMBER:[mysql][slowlog][rows_examined]}\n(SET timestamp=%{NUMBER:[mysql][slowlog][timestamp]};\n)?%{GREEDYMULTILINE:[mysql][slowlog][query]}"] }</p>
<p>pattern_definitions =&gt; {</p>
<p>"GREEDYMULTILINE" =&gt; "(.|\n)*"</p>
<p>}</p>
<p>remove_field =&gt; "message"</p>
<p>}</p>
<p>date {</p>
<p>match =&gt; [ "[mysql][slowlog][timestamp]", "UNIX" ]</p>
<p>}</p>
<p>mutate {</p>
<p>gsub =&gt; ["[mysql][slowlog][query]", "\n# Time: [0-9]+ [0-9][0-9]:[0-9][0-9]:[0-9][0-9](.[0-9]+)?$", ""]</p>
<p>}</p>
<p>}</p>
<p>output {</p>
<p>elasticsearch {</p>
<p>hosts =&gt; localhost</p>
<p>manage_template =&gt; false</p>
<p>index =&gt; "%{[@metadata][beat]}-%{+YYYY.MM.dd}"</p>
<p>document_type =&gt; "%{[@metadata][type]}"</p>
<p>}</p>
<p>}</p>
<p>Nginx Logsedit</p>
<p>Here are some configuration examples for shipping and parsing Nginx access and error logs.</p>
<p>Nginx Access Logsedit</p>
<p>Example Filebeat config:</p>
<p>filebeat.prospectors:</p>
<ul>
<li>input_type: log</li>
</ul>
<p>paths:</p>
<ul>
<li>/var/log/nginx/access.log*</li>
</ul>
<p>exclude_files: [".gz$"]</p>
<p>output.logstash:</p>
<p>hosts: ["localhost:5044"]</p>
<p>Example Logstash pipeline config:</p>
<p>input {</p>
<p>beats {</p>
<p># The port to listen on for filebeat connections.</p>
<p>port =&gt; 5044</p>
<p># The IP address to listen for filebeat connections.</p>
<p>host =&gt; "0.0.0.0"</p>
<p>}</p>
<p>}</p>
<p>filter {</p>
<p>grok {</p>
<p>match =&gt; { "message" =&gt; ["%{IPORHOST:[nginx][access][remote_ip]} - %{DATA:[nginx][access][user_name]} \[%{HTTPDATE:[nginx][access][time]}\] \"%{WORD:[nginx][access][method]} %{DATA:[nginx][access][url]} HTTP/%{NUMBER:[nginx][access][http_version]}\" %{NUMBER:[nginx][access][response_code]} %{NUMBER:[nginx][access][body_sent][bytes]} \"%{DATA:[nginx][access][referrer]}\" \"%{DATA:[nginx][access][agent]}\""] }</p>
<p>remove_field =&gt; "message"</p>
<p>}</p>
<p>mutate {</p>
<p>rename =&gt; { "@timestamp" =&gt; "read_timestamp" }</p>
<p>}</p>
<p>date {</p>
<p>match =&gt; [ "[nginx][access][time]", "dd/MMM/YYYY:H:m:s Z" ]</p>
<p>remove_field =&gt; "[nginx][access][time]"</p>
<p>}</p>
<p>useragent {</p>
<p>source =&gt; "[nginx][access][agent]"</p>
<p>target =&gt; "[nginx][access][user_agent]"</p>
<p>remove_field =&gt; "[nginx][access][agent]"</p>
<p>}</p>
<p>geoip {</p>
<p>source =&gt; "[nginx][access][remote_ip]"</p>
<p>target =&gt; "[nginx][access][geoip]"</p>
<p>}</p>
<p>}</p>
<p>output {</p>
<p>elasticsearch {</p>
<p>hosts =&gt; localhost</p>
<p>manage_template =&gt; false</p>
<p>index =&gt; "%{[@metadata][beat]}-%{+YYYY.MM.dd}"</p>
<p>document_type =&gt; "%{[@metadata][type]}"</p>
<p>}</p>
<p>}</p>
<p>Nginx Error Logsedit</p>
<p>Example Filebeat config:</p>
<p>filebeat.prospectors:</p>
<ul>
<li>input_type: log</li>
</ul>
<p>paths:</p>
<ul>
<li>/var/log/nginx/error.log*</li>
</ul>
<p>exclude_files: [".gz$"]</p>
<p>output.logstash:</p>
<p>hosts: ["localhost:5044"]</p>
<p>Example Logstash pipeline config:</p>
<p>input {</p>
<p>beats {</p>
<p># The port to listen on for filebeat connections.</p>
<p>port =&gt; 5044</p>
<p># The IP address to listen for filebeat connections.</p>
<p>host =&gt; "0.0.0.0"</p>
<p>}</p>
<p>}</p>
<p>filter {</p>
<p>grok {</p>
<p>match =&gt; { "message" =&gt; ["%{DATA:[nginx][error][time]} \[%{DATA:[nginx][error][level]}\] %{NUMBER:[nginx][error][pid]}#%{NUMBER:[nginx][error][tid]}: (\*%{NUMBER:[nginx][error][connection_id]} )?%{GREEDYDATA:[nginx][error][message]}"] }</p>
<p>remove_field =&gt; "message"</p>
<p>}</p>
<p>mutate {</p>
<p>rename =&gt; { "@timestamp" =&gt; "read_timestamp" }</p>
<p>}</p>
<p>date {</p>
<p>match =&gt; [ "[nginx][error][time]", "YYYY/MM/dd H:m:s" ]</p>
<p>remove_field =&gt; "[nginx][error][time]"</p>
<p>}</p>
<p>}</p>
<p>output {</p>
<p>elasticsearch {</p>
<p>hosts =&gt; localhost</p>
<p>manage_template =&gt; false</p>
<p>index =&gt; "%{[@metadata][beat]}-%{+YYYY.MM.dd}"</p>
<p>document_type =&gt; "%{[@metadata][type]}"</p>
<p>}</p>
<p>}</p>
<p>System Logsedit</p>
<p>Here are some configuration examples for shipping and parsing system logs.</p>
<p>System Authorization Logsedit</p>
<p>Example Filebeat config:</p>
<p>filebeat.prospectors:</p>
<ul>
<li>input_type: log</li>
</ul>
<p>paths:</p>
<ul>
<li>
<p>/var/log/auth.log*</p>
</li>
<li>
<p>/var/log/secure*</p>
</li>
</ul>
<p>exclude_files: [".gz$"]</p>
<p>multiline:</p>
<p>pattern: "^\s"</p>
<p>match: after</p>
<p>output.logstash:</p>
<p>hosts: ["localhost:5044"]</p>
<p>Example Logstash pipeline config:</p>
<p>input {</p>
<p>beats {</p>
<p># The port to listen on for filebeat connections.</p>
<p>port =&gt; 5044</p>
<p># The IP address to listen for filebeat connections.</p>
<p>host =&gt; "0.0.0.0"</p>
<p>}</p>
<p>}</p>
<p>filter {</p>
<p>grok {</p>
<p>match =&gt; { "message" =&gt; ["%{SYSLOGTIMESTAMP:[system][auth][timestamp]} %{SYSLOGHOST:[system][auth][hostname]} sshd(?:\[%{POSINT:[system][auth][pid]}\])?: %{DATA:[system][auth][ssh][event]} %{DATA:[system][auth][ssh][method]} for (invalid user )?%{DATA:[system][auth][user]} from %{IPORHOST:[system][auth][ssh][ip]} port %{NUMBER:[system][auth][ssh][port]} ssh2(: %{GREEDYDATA:[system][auth][ssh][signature]})?",</p>
<p>"%{SYSLOGTIMESTAMP:[system][auth][timestamp]} %{SYSLOGHOST:[system][auth][hostname]} sshd(?:\[%{POSINT:[system][auth][pid]}\])?: %{DATA:[system][auth][ssh][event]} user %{DATA:[system][auth][user]} from %{IPORHOST:[system][auth][ssh][ip]}",</p>
<p>"%{SYSLOGTIMESTAMP:[system][auth][timestamp]} %{SYSLOGHOST:[system][auth][hostname]} sshd(?:\[%{POSINT:[system][auth][pid]}\])?: Did not receive identification string from %{IPORHOST:[system][auth][ssh][dropped_ip]}",</p>
<p>"%{SYSLOGTIMESTAMP:[system][auth][timestamp]} %{SYSLOGHOST:[system][auth][hostname]} sudo(?:\[%{POSINT:[system][auth][pid]}\])?: \s*%{DATA:[system][auth][user]} :( %{DATA:[system][auth][sudo][error]} ;)? TTY=%{DATA:[system][auth][sudo][tty]} ; PWD=%{DATA:[system][auth][sudo][pwd]} ; USER=%{DATA:[system][auth][sudo][user]} ; COMMAND=%{GREEDYDATA:[system][auth][sudo][command]}",</p>
<p>"%{SYSLOGTIMESTAMP:[system][auth][timestamp]} %{SYSLOGHOST:[system][auth][hostname]} groupadd(?:\[%{POSINT:[system][auth][pid]}\])?: new group: name=%{DATA:system.auth.groupadd.name}, GID=%{NUMBER:system.auth.groupadd.gid}",</p>
<p>"%{SYSLOGTIMESTAMP:[system][auth][timestamp]} %{SYSLOGHOST:[system][auth][hostname]} useradd(?:\[%{POSINT:[system][auth][pid]}\])?: new user: name=%{DATA:[system][auth][user][add][name]}, UID=%{NUMBER:[system][auth][user][add][uid]}, GID=%{NUMBER:[system][auth][user][add][gid]}, home=%{DATA:[system][auth][user][add][home]}, shell=%{DATA:[system][auth][user][add][shell]}$",</p>
<p>"%{SYSLOGTIMESTAMP:[system][auth][timestamp]} %{SYSLOGHOST:[system][auth][hostname]} %{DATA:[system][auth][program]}(?:\[%{POSINT:[system][auth][pid]}\])?: %{GREEDYMULTILINE:[system][auth][message]}"] }</p>
<p>pattern_definitions =&gt; {</p>
<p>"GREEDYMULTILINE"=&gt; "(.|\n)*"</p>
<p>}</p>
<p>remove_field =&gt; "message"</p>
<p>}</p>
<p>date {</p>
<p>match =&gt; [ "[system][auth][timestamp]", "MMM d HH:mm:ss", "MMM dd HH:mm:ss" ]</p>
<p>}</p>
<p>geoip {</p>
<p>source =&gt; "[system][auth][ssh][ip]"</p>
<p>target =&gt; "[system][auth][ssh][geoip]"</p>
<p>}</p>
<p>}</p>
<p>output {</p>
<p>elasticsearch {</p>
<p>hosts =&gt; localhost</p>
<p>manage_template =&gt; false</p>
<p>index =&gt; "%{[@metadata][beat]}-%{+YYYY.MM.dd}"</p>
<p>document_type =&gt; "%{[@metadata][type]}"</p>
<p>}</p>
<p>}</p>
<p>Syslogedit</p>
<p>Example Filebeat config:</p>
<p>filebeat.prospectors:</p>
<ul>
<li>input_type: log</li>
</ul>
<p>paths:</p>
<ul>
<li>
<p>/var/log/messages*</p>
</li>
<li>
<p>/var/log/syslog*</p>
</li>
</ul>
<p>exclude_files: [".gz$"]</p>
<p>multiline:</p>
<p>pattern: "^\s"</p>
<p>match: after</p>
<p>output.logstash:</p>
<p>hosts: ["localhost:5044"]</p>
<p>Example Logstash pipeline config:</p>
<p>input {</p>
<p>beats {</p>
<p># The port to listen on for filebeat connections.</p>
<p>port =&gt; 5044</p>
<p># The IP address to listen for filebeat connections.</p>
<p>host =&gt; "0.0.0.0"</p>
<p>}</p>
<p>}</p>
<p>filter {</p>
<p>grok {</p>
<p>match =&gt; { "message" =&gt; ["%{SYSLOGTIMESTAMP:[system][syslog][timestamp]} %{SYSLOGHOST:[system][syslog][hostname]} %{DATA:[system][syslog][program]}(?:\[%{POSINT:[system][syslog][pid]}\])?: %{GREEDYMULTILINE:[system][syslog][message]}"] }</p>
<p>pattern_definitions =&gt; { "GREEDYMULTILINE" =&gt; "(.|\n)*" }</p>
<p>remove_field =&gt; "message"</p>
<p>}</p>
<p>date {</p>
<p>match =&gt; [ "[system][syslog][timestamp]", "MMM d HH:mm:ss", "MMM dd HH:mm:ss" ]</p>
<p>}</p>
<p>}</p>
<p>output {</p>
<p>elasticsearch {</p>
<p>hosts =&gt; localhost</p>
<p>manage_template =&gt; false</p>
<p>index =&gt; "%{[@metadata][beat]}-%{+YYYY.MM.dd}"</p>
<p>document_type =&gt; "%{[@metadata][type]}"</p>
<p>}</p>
<p>}</p>
<h2 id="elk_1">elk优化</h2>
<div class="codehilite"><pre><span></span><span class="nv">refresh_interval</span> <span class="k">for</span> <span class="nv">indexing</span>
<span class="nv">Elasticsearch</span> 是一个近实时搜索引擎。它实际上是每 <span class="mi">1</span> 秒钟刷新一次数据。对于日志分析应用，我们用不着这么实时，
所以 <span class="nv">logstash</span> 自带的模板修改成了 <span class="mi">5</span> 秒钟。你还可以根据需要继续放大这个刷新间隔以提高数据写入性能。
修改 <span class="nv">refresh_interval</span> ，那么只需要新写一个<span class="nv">tmpl</span>.<span class="nv">json</span>：
{
  <span class="s2">&quot;</span><span class="s">order</span><span class="s2">&quot;</span> : <span class="mi">1</span>,
  <span class="s2">&quot;</span><span class="s">template</span><span class="s2">&quot;</span> : <span class="s2">&quot;</span><span class="s">logstash-*</span><span class="s2">&quot;</span>,
  <span class="s2">&quot;</span><span class="s">settings</span><span class="s2">&quot;</span> : {
    <span class="s2">&quot;</span><span class="s">index.refresh_interval</span><span class="s2">&quot;</span> : <span class="s2">&quot;</span><span class="s">30s</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">index.number_of_replicas</span><span class="s2">&quot;</span> : <span class="mi">0</span>     #关闭副本
  }
}
然后运行 <span class="nv">curl</span> <span class="o">-</span><span class="nv">XPUT</span> <span class="nv">http</span>:<span class="o">//</span><span class="nv">localhost</span>:<span class="mi">9200</span><span class="o">/</span><span class="nv">_template</span><span class="o">/</span><span class="nv">template_newid</span> <span class="o">-</span><span class="nv">d</span> <span class="s1">&#39;</span><span class="s">@/root/tmpl.json</span><span class="s1">&#39;</span> 即可。
<span class="nv">logstash</span> 默认的模板， <span class="nv">order</span> 是 <span class="mi">0</span>，<span class="nv">id</span> 是 <span class="nv">logstash</span>，通过 <span class="nv">logstash</span><span class="o">/</span><span class="nv">outputs</span><span class="o">/</span><span class="nv">elasticsearch</span> 的配置选项 <span class="nv">template_name</span> 修改。
新模板要比<span class="nv">order</span>大
</pre></div>


<h2 id="logstash5-root">logstash5 root启动</h2>
<p>vim  /etc/logstash/startup.options </p>
<p>LS_USER=root</p>
<p>/usr/share/logstash/bin/system-install 重新生成启动脚本</p>
<p>重启logstash</p>
<h2 id="es">es集群重启</h2>
<div class="codehilite"><pre><span></span><span class="n">elasticsearch</span><span class="err">集群，有时候可能需要修改配置，增加硬盘，扩展内存等操作，需要对节点进行维护升级。但是业务不能停，</span>
<span class="err">如果直接</span><span class="n">kill</span><span class="err">掉节点，可能导致数据丢失。而且集群会认为该节点挂掉了，就开始转移数据，当重启之后，它又会恢复数据，</span>
<span class="err">如果你当前的数据量已经很大了，这是很耗费机器和网络资源的。</span>

<span class="err">官方提供的安全重启集群节点的方法：</span>

<span class="err">第一步：先暂停集群的</span><span class="n">shard</span><span class="err">自动均衡。</span>

<span class="n">curl</span> <span class="o">-</span><span class="n">XPUT</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_cluster</span><span class="o">/</span><span class="n">settings</span> <span class="o">-</span><span class="n">d</span><span class="s1">&#39;</span>
<span class="s1">{</span>
<span class="s1">&quot;transient&quot; : {</span>
<span class="s1">&quot;cluster.routing.allocation.enable&quot; : &quot;none&quot;</span>
<span class="s1">}</span>
<span class="s1">}&#39;</span>
<span class="err">第二步：</span><span class="n">shutdown</span><span class="err">你要升级的节点</span>

<span class="n">curl</span> <span class="o">-</span><span class="n">XPOST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_cluster</span><span class="o">/</span><span class="n">nodes</span><span class="o">/</span><span class="n">_local</span><span class="o">/</span><span class="n">_shutdown</span>
<span class="n">elasticsearch</span> <span class="err">在</span> <span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="err">版本之后移除了</span><span class="n">shutdown</span><span class="err">接口，所以用</span><span class="n">pid</span><span class="err">直接停止即可。</span>

<span class="err">第三步：升级重启该节点，并确认该节点重新加入到了集群中</span>

<span class="err">第四步：重复</span><span class="mi">2</span><span class="o">-</span><span class="mi">3</span><span class="err">步，升级重启其它要升级的节点。</span>

<span class="err">第五步：重启启动集群的</span><span class="n">shard</span><span class="err">均衡</span>

<span class="n">curl</span> <span class="o">-</span><span class="n">XPUT</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_cluster</span><span class="o">/</span><span class="n">settings</span> <span class="o">-</span><span class="n">d</span><span class="s1">&#39;</span>
<span class="s1">{</span>
<span class="s1">&quot;transient&quot; : {</span>
<span class="s1">&quot;cluster.routing.allocation.enable&quot; : &quot;all&quot;</span>
<span class="s1">}</span>
<span class="s1">}&#39;</span>
<span class="err">到此整个集群安全升级并且重启结束。</span>
</pre></div>


<h2 id="logio">logio</h2>
<div class="codehilite"><pre><span></span><span class="nt">yum</span> <span class="nt">install</span> <span class="nt">npm</span> <span class="nt">-y</span>
<span class="nt">npm</span> <span class="nt">install</span> <span class="nt">-g</span> <span class="nt">log</span><span class="p">.</span><span class="nc">io</span>  <span class="err">安装</span>

<span class="nt">cd</span> <span class="o">/</span><span class="nt">root</span><span class="o">/</span><span class="p">.</span><span class="nc">log</span><span class="p">.</span><span class="nc">io</span>
<span class="nt">cat</span> <span class="nt">log_server</span><span class="p">.</span><span class="nc">conf</span>  <span class="err">模板文件</span>  <span class="nt">web_server</span><span class="p">.</span><span class="nc">conf</span><span class="err">（当前目录下）</span>
<span class="nt">exports</span><span class="p">.</span><span class="nc">config</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">host</span><span class="p">:</span> <span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span>
  <span class="n">port</span><span class="o">:</span> <span class="mi">28777</span><span class="p">,</span>
  <span class="n">auth</span><span class="o">:</span> <span class="err">{</span>
    <span class="n">user</span><span class="o">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
    <span class="n">pass</span><span class="o">:</span> <span class="s2">&quot;xxxx&quot;</span>
  <span class="p">}</span>
<span class="err">}</span>

<span class="nt">cat</span> <span class="nt">harvester</span><span class="p">.</span><span class="nc">conf</span>
<span class="nt">exports</span><span class="p">.</span><span class="nc">config</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">nodeName</span><span class="p">:</span> <span class="s2">&quot;application_server&quot;</span><span class="p">,</span>
  <span class="n">logStreams</span><span class="o">:</span> <span class="err">{</span>
    <span class="n">tomcat_pingtai</span><span class="o">:</span> <span class="cp">[</span>
      <span class="s2">&quot;/usr/local/tomcat_pingtai/logs/catalina.out&quot;</span><span class="p">,</span>
    <span class="cp">]</span><span class="p">,</span>
    <span class="n">tomcat_pingtaitest</span><span class="o">:</span> <span class="cp">[</span>
      <span class="s2">&quot;/usr/local/tomcat_pingtaitest/logs/catalina.out&quot;</span><span class="p">,</span>
    <span class="cp">]</span><span class="p">,</span>
    <span class="n">tomcat_cuishou</span><span class="o">:</span> <span class="cp">[</span>
      <span class="s2">&quot;/usr/local/tomcat_cuishou/logs/catalina.out&quot;</span><span class="p">,</span>
    <span class="cp">]</span><span class="p">,</span>
    <span class="n">tomcat_cuishoutest</span><span class="o">:</span> <span class="cp">[</span>
      <span class="s2">&quot;/usr/local/tomcat_cuishoutest/logs/catalina.out&quot;</span><span class="p">,</span>
    <span class="cp">]</span><span class="p">,</span>
    <span class="n">tomcat_blacklist</span><span class="o">:</span> <span class="cp">[</span>
      <span class="s2">&quot;/usr/local/tomcat_blacklist/logs/catalina.out&quot;</span><span class="p">,</span>
    <span class="cp">]</span>
  <span class="p">}</span><span class="o">,</span>
  <span class="nt">server</span><span class="o">:</span> <span class="p">{</span>
    <span class="n">host</span><span class="p">:</span> <span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span>
    <span class="n">port</span><span class="o">:</span> <span class="mi">28777</span>
  <span class="p">}</span>
<span class="err">}</span>


<span class="nt">nohup</span> <span class="nt">log</span><span class="p">.</span><span class="nc">io-server</span>  <span class="o">&amp;</span> <span class="nt">Launch</span> <span class="nt">server</span>
<span class="nt">nohup</span> <span class="nt">log</span><span class="p">.</span><span class="nc">io-harvester</span>  <span class="o">&amp;</span> <span class="nt">Start</span> <span class="nt">log</span> <span class="nt">harvester</span> 

<span class="err">浏览器打开</span> <span class="nt">http</span><span class="o">://</span><span class="nt">localhost</span><span class="p">:</span><span class="nd">28778</span>

<span class="nt">nginx</span> <span class="err">代理</span>
<span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">nginx</span><span class="o">/</span><span class="nt">conf</span><span class="p">.</span><span class="nc">d</span><span class="o">/</span><span class="nt">default</span><span class="p">.</span><span class="nc">conf</span> 
<span class="nt">location</span> <span class="o">/</span><span class="nt">logio</span> <span class="p">{</span>
        <span class="err">proxy_pass</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168.1.2</span><span class="o">:</span><span class="mi">28778</span><span class="o">/</span><span class="p">;</span>
        <span class="err">auth_basic</span> <span class="err">&quot;secret&quot;</span><span class="p">;</span>
        <span class="err">auth_basic_user_file</span> <span class="err">/etc/nginx/passwd.db</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">location</span> <span class="o">/</span><span class="nt">socket</span><span class="p">.</span><span class="nc">io</span> <span class="p">{</span>
        <span class="err">proxy_pass</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168.1.2</span><span class="o">:</span><span class="mi">28778</span><span class="o">/</span><span class="n">socket</span><span class="o">.</span><span class="n">io</span><span class="p">;</span>
        <span class="err">proxy_http_version</span> <span class="err">1.1</span><span class="p">;</span>
        <span class="err">proxy_set_header</span> <span class="err">Upgrade</span> <span class="err">$http_upgrade</span><span class="p">;</span>
        <span class="err">proxy_set_header</span> <span class="err">Connection</span> <span class="err">&quot;upgrade&quot;</span><span class="p">;</span>
    <span class="p">}</span>

<span class="nt">htpasswd</span> <span class="nt">-c</span> <span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">nginx</span><span class="o">/</span><span class="nt">passwd</span><span class="p">.</span><span class="nc">db</span> <span class="nt">admin</span>
<span class="nt">chmod</span> <span class="nt">400</span> <span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">nginx</span><span class="o">/</span><span class="nt">passwd</span><span class="p">.</span><span class="nc">db</span>
<span class="nt">chown</span> <span class="nt">nginx</span><span class="p">.</span><span class="nc">nginx</span> <span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">nginx</span><span class="o">/</span><span class="nt">passwd</span><span class="p">.</span><span class="nc">db</span>

<span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">init</span><span class="p">.</span><span class="nc">d</span><span class="o">/</span><span class="nt">nginx</span> <span class="nt">reload</span>
</pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../lvs/" title="lvs" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                lvs
              </span>
            </div>
          </a>
        
        
          <a href="../mysql/" title="mysql" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                mysql
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>