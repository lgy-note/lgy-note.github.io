



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>disk - mkdocs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.30686662.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#fdisk" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="mkdocs" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              mkdocs
            </span>
            <span class="md-header-nav__topic">
              
                disk
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href=".." class="md-tabs__link">
        home
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../python-base/" class="md-tabs__link">
          python
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../nginx/" class="md-tabs__link">
          service
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../mysql/" class="md-tabs__link">
          database
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../open-falcon/" class="md-tabs__link">
          monitor
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../tcp-issue/" class="md-tabs__link md-tabs__link--active">
          basis
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="mkdocs" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    mkdocs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="home" class="md-nav__link">
      home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      python
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        python
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../python-base/" title="python-base" class="md-nav__link">
      python-base
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-lib/" title="python-lib" class="md-nav__link">
      python-lib
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-lib2/" title="python-lib2" class="md-nav__link">
      python-lib2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-web/" title="python-web" class="md-nav__link">
      python-web
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-other/" title="python-other" class="md-nav__link">
      python-other
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      service
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        service
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../nginx/" title="nginx" class="md-nav__link">
      nginx
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../nginx2/" title="nginx2" class="md-nav__link">
      nginx2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../apache/" title="apache" class="md-nav__link">
      apache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../saltstack/" title="saltstack" class="md-nav__link">
      saltstack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tomcat/" title="tomcat" class="md-nav__link">
      tomcat
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ansible/" title="ansible" class="md-nav__link">
      ansible
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../trafficserver/" title="trafficserver" class="md-nav__link">
      trafficserver
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../haproxy/" title="haproxy" class="md-nav__link">
      haproxy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../docker/" title="docker" class="md-nav__link">
      docker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../varnish/" title="varnish" class="md-nav__link">
      varnish
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../bind/" title="bind" class="md-nav__link">
      bind
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lvs/" title="lvs" class="md-nav__link">
      lvs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../log-analysis/" title="log-analysis" class="md-nav__link">
      log-analysis
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      database
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        database
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../mysql/" title="mysql" class="md-nav__link">
      mysql
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mysql2/" title="mysql2" class="md-nav__link">
      mysql2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../memcached/" title="memcached" class="md-nav__link">
      memcached
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../redis/" title="redis" class="md-nav__link">
      redis
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mongodb/" title="mongodb" class="md-nav__link">
      mongodb
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../hadoop/" title="hadoop" class="md-nav__link">
      hadoop
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../postgresql/" title="postgresql" class="md-nav__link">
      postgresql
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      monitor
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        monitor
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../open-falcon/" title="open-falcon" class="md-nav__link">
      open-falcon
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zabbix/" title="zabbix" class="md-nav__link">
      zabbix
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zabbix2/" title="zabbix2" class="md-nav__link">
      zabbix2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../netdata/" title="netdata" class="md-nav__link">
      netdata
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6" checked>
    
    <label class="md-nav__link" for="nav-6">
      basis
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        basis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../tcp-issue/" title="tcp-issue" class="md-nav__link">
      tcp-issue
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../git-svn/" title="git-svn" class="md-nav__link">
      git-svn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../vpn/" title="vpn" class="md-nav__link">
      vpn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../shell/" title="shell" class="md-nav__link">
      shell
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        disk
      </label>
    
    <a href="./" title="disk" class="md-nav__link md-nav__link--active">
      disk
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#fdisk" class="md-nav__link">
    fdisk
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parted" class="md-nav__link">
    parted
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#megacli" class="md-nav__link">
    MegaCli
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    内网云盘
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lvm" class="md-nav__link">
    lvm
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#samba" class="md-nav__link">
    samba
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nfs" class="md-nav__link">
    nfs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iozone" class="md-nav__link">
    iozone
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fio" class="md-nav__link">
    fio测试磁盘
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vsftp" class="md-nav__link">
    vsftp
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vsftpd-mysql" class="md-nav__link">
    vsftpd-mysql结合
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lsyncd" class="md-nav__link">
    实时同步lsyncd
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inotify_sync" class="md-nav__link">
    inotify_sync
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../filesystem/" title="filesystem" class="md-nav__link">
      filesystem
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../source/" title="source" class="md-nav__link">
      source
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../command/" title="command" class="md-nav__link">
      command
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../linux-base/" title="linux-base" class="md-nav__link">
      linux-base
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../linux-soft/" title="linux-soft" class="md-nav__link">
      linux-soft
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../other/" title="other" class="md-nav__link">
      other
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#fdisk" class="md-nav__link">
    fdisk
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parted" class="md-nav__link">
    parted
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#megacli" class="md-nav__link">
    MegaCli
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    内网云盘
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lvm" class="md-nav__link">
    lvm
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#samba" class="md-nav__link">
    samba
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nfs" class="md-nav__link">
    nfs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iozone" class="md-nav__link">
    iozone
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fio" class="md-nav__link">
    fio测试磁盘
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vsftp" class="md-nav__link">
    vsftp
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vsftpd-mysql" class="md-nav__link">
    vsftpd-mysql结合
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lsyncd" class="md-nav__link">
    实时同步lsyncd
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inotify_sync" class="md-nav__link">
    inotify_sync
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>disk</h1>
                
                <h2 id="fdisk">fdisk</h2>
<div class="codehilite"><pre><span></span><span class="nv">fdisk</span> <span class="o">-</span><span class="nv">l</span> 列出分区
<span class="nv">fdisk</span> <span class="o">/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">sda</span>
<span class="nv">p</span>查看    <span class="nv">n</span>添加    <span class="nv">w</span>保存    <span class="nv">d</span>删除    <span class="nv">t</span>更改分区标识

更改分区表 <span class="nv">partprode</span> 或者重启

测试<span class="nv">hdparm</span> <span class="o">-</span><span class="nv">Tt</span>

添加<span class="nv">swap</span>
<span class="mi">1</span>、<span class="nv">fdisk</span> 添加<span class="nv">swap</span>   <span class="nv">mkswap</span> <span class="o">/</span><span class="nv">xx</span><span class="o">/</span><span class="nv">xx</span> 
<span class="mi">2</span>、<span class="nv">dd</span> <span class="k">if</span><span class="o">=/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">zero</span> <span class="nv">of</span><span class="o">=/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">swap</span> <span class="nv">bs</span><span class="o">=</span>大小 <span class="nv">count</span><span class="o">=</span>次数
        写入<span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">fstab</span>
<span class="nv">swapon</span> <span class="o">/</span><span class="nv">xx</span><span class="o">/</span><span class="nv">xx</span>  启用<span class="nv">swap</span>   <span class="nv">swapoff</span>  停用<span class="nv">swap</span>    <span class="nv">swapon</span> <span class="o">-</span><span class="nv">s</span> 检查
<span class="nv">fsck</span> 手动检查磁盘（不能操作已挂载的磁盘）
</pre></div>


<h2 id="parted">parted</h2>
<div class="codehilite"><pre><span></span>针对大于<span class="mi">2</span><span class="nv">T</span>的磁盘
新增存储用<span class="nv">Parted</span>分区并建<span class="nv">LVM</span>卷

一，<span class="nv">Parted</span>分区
<span class="mi">1</span>，<span class="nv">parted</span>分区  <span class="nv">www</span>.<span class="mi">2</span><span class="nv">cto</span>.<span class="nv">com</span>  
# <span class="nv">parted</span> <span class="o">/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">sda</span>
<span class="nv">GNU</span> <span class="nv">Parted</span> <span class="mi">2</span>.<span class="mi">1</span>
使用 <span class="o">/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">sda</span>
<span class="nv">Welcome</span> <span class="nv">to</span> <span class="nv">GNU</span> <span class="nv">Parted</span><span class="o">!</span> <span class="nv">Type</span> <span class="s1">&#39;</span><span class="s">help</span><span class="s1">&#39;</span> <span class="nv">to</span> <span class="nv">view</span> <span class="nv">a</span> <span class="nv">list</span> <span class="nv">of</span> <span class="nv">commands</span>.
<span class="ss">(</span><span class="nv">parted</span><span class="ss">)</span> <span class="nv">help</span>                               首先看看帮助熟悉下                              

<span class="ss">(</span><span class="nv">parted</span><span class="ss">)</span> <span class="nv">mktable</span>                                                         
新的磁盘标签类型？ <span class="nv">gpt</span>                     <span class="nv">GPT</span>就是<span class="nv">GRUB</span>分区表，如果是<span class="nv">MBR</span>，最大支持<span class="mi">2</span><span class="nv">T</span>分区                           
<span class="ss">(</span><span class="nv">parted</span><span class="ss">)</span> <span class="nv">p</span>                                 打印一下信息这里的<span class="mi">4398</span><span class="nv">GB</span>是磁盘容量                                 
<span class="nv">Model</span>: <span class="nv">DELL</span> <span class="nv">MD32xx</span> <span class="ss">(</span><span class="nv">scsi</span><span class="ss">)</span>
<span class="nv">Disk</span> <span class="o">/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">sda</span>: <span class="mi">4398</span><span class="nv">GB</span>
<span class="nv">Sector</span> <span class="nv">size</span> <span class="ss">(</span><span class="nv">logical</span><span class="o">/</span><span class="nv">physical</span><span class="ss">)</span>: <span class="mi">512</span><span class="nv">B</span><span class="o">/</span><span class="mi">512</span><span class="nv">B</span>
<span class="nv">Partition</span> <span class="nv">Table</span>: <span class="nv">gpt</span>


<span class="nv">Number</span>  <span class="nv">Start</span>  <span class="k">End</span>  <span class="nv">Size</span>  <span class="nv">File</span> <span class="nv">system</span>  <span class="nv">Name</span>  标志


<span class="ss">(</span><span class="nv">parted</span><span class="ss">)</span> <span class="nv">mkpart</span>                            #新建分区                               
分区名称？  []?                            #默认                               
文件系统类型？  [<span class="nv">ext2</span>]?                    #默认                               
起始点？ <span class="mi">0</span><span class="nv">G</span>   #起点
结束点？ <span class="mi">4398</span><span class="nv">G</span>                             #终点                            
<span class="ss">(</span><span class="nv">parted</span><span class="ss">)</span> <span class="nv">p</span>                                                                
<span class="nv">Model</span>: <span class="nv">DELL</span> <span class="nv">MD32xx</span> <span class="ss">(</span><span class="nv">scsi</span><span class="ss">)</span>
<span class="nv">Disk</span> <span class="o">/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">sda</span>: <span class="mi">4398</span><span class="nv">GB</span>
<span class="nv">Sector</span> <span class="nv">size</span> <span class="ss">(</span><span class="nv">logical</span><span class="o">/</span><span class="nv">physical</span><span class="ss">)</span>: <span class="mi">512</span><span class="nv">B</span><span class="o">/</span><span class="mi">512</span><span class="nv">B</span>
<span class="nv">Partition</span> <span class="nv">Table</span>: <span class="nv">gpt</span>


<span class="nv">Number</span>  <span class="nv">Start</span>   <span class="k">End</span>     <span class="nv">Size</span>    <span class="nv">File</span> <span class="nv">system</span>  <span class="nv">Name</span>  标志
 <span class="mi">1</span>      <span class="mi">1049</span><span class="nv">kB</span>  <span class="mi">4398</span><span class="nv">GB</span>  <span class="mi">4398</span><span class="nv">GB</span>


<span class="ss">(</span><span class="nv">parted</span><span class="ss">)</span> <span class="nv">toggle</span> <span class="mi">1</span> <span class="nv">lvm</span>                      #标记成<span class="nv">lvm</span>                                   
<span class="ss">(</span><span class="nv">parted</span><span class="ss">)</span> <span class="nv">p</span>                                                                
<span class="nv">Model</span>: <span class="nv">DELL</span> <span class="nv">MD32xx</span> <span class="ss">(</span><span class="nv">scsi</span><span class="ss">)</span>
<span class="nv">Disk</span> <span class="o">/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">sda</span>: <span class="mi">4398</span><span class="nv">GB</span>
<span class="nv">Sector</span> <span class="nv">size</span> <span class="ss">(</span><span class="nv">logical</span><span class="o">/</span><span class="nv">physical</span><span class="ss">)</span>: <span class="mi">512</span><span class="nv">B</span><span class="o">/</span><span class="mi">512</span><span class="nv">B</span>
<span class="nv">Partition</span> <span class="nv">Table</span>: <span class="nv">gpt</span>


<span class="nv">Number</span>  <span class="nv">Start</span>   <span class="k">End</span>     <span class="nv">Size</span>    <span class="nv">File</span> <span class="nv">system</span>  <span class="nv">Name</span>  标志
 <span class="mi">1</span>      <span class="mi">1049</span><span class="nv">kB</span>  <span class="mi">4398</span><span class="nv">GB</span>  <span class="mi">4398</span><span class="nv">GB</span>                     <span class="nv">lvm</span>


<span class="ss">(</span><span class="nv">parted</span><span class="ss">)</span> <span class="nv">quit</span>                                                             
信息: <span class="nv">You</span> <span class="nv">may</span> <span class="nv">need</span> <span class="nv">to</span> <span class="nv">update</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">fstab</span>.
<span class="mi">2</span>，同样的方法对<span class="nv">sdb</span>,<span class="nv">sdc</span>,<span class="nv">sdd</span> 分区                                  
二，创建<span class="nv">LVM</span>，分三大步，分别建<span class="nv">PV</span>,<span class="nv">VG</span>,<span class="nv">LVM</span>
<span class="mi">1</span>，建<span class="nv">PV</span>
# <span class="nv">pvcreate</span> <span class="o">/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">sda1</span> <span class="o">/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">sdb1</span> <span class="o">/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">sdc1</span> <span class="o">/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">sdd1</span>
  <span class="nv">Writing</span> <span class="nv">physical</span> <span class="nv">volume</span> <span class="nv">data</span> <span class="nv">to</span> <span class="nv">disk</span> <span class="s2">&quot;</span><span class="s">/dev/sda1</span><span class="s2">&quot;</span>
  <span class="nv">Physical</span> <span class="nv">volume</span> <span class="s2">&quot;</span><span class="s">/dev/sda1</span><span class="s2">&quot;</span> <span class="nv">successfully</span> <span class="nv">created</span>
  <span class="nv">Writing</span> <span class="nv">physical</span> <span class="nv">volume</span> <span class="nv">data</span> <span class="nv">to</span> <span class="nv">disk</span> <span class="s2">&quot;</span><span class="s">/dev/sdb1</span><span class="s2">&quot;</span>
  <span class="nv">Physical</span> <span class="nv">volume</span> <span class="s2">&quot;</span><span class="s">/dev/sdb1</span><span class="s2">&quot;</span> <span class="nv">successfully</span> <span class="nv">created</span>
  <span class="nv">Writing</span> <span class="nv">physical</span> <span class="nv">volume</span> <span class="nv">data</span> <span class="nv">to</span> <span class="nv">disk</span> <span class="s2">&quot;</span><span class="s">/dev/sdc1</span><span class="s2">&quot;</span>
  <span class="nv">Physical</span> <span class="nv">volume</span> <span class="s2">&quot;</span><span class="s">/dev/sdc1</span><span class="s2">&quot;</span> <span class="nv">successfully</span> <span class="nv">created</span>
  <span class="nv">Writing</span> <span class="nv">physical</span> <span class="nv">volume</span> <span class="nv">data</span> <span class="nv">to</span> <span class="nv">disk</span> <span class="s2">&quot;</span><span class="s">/dev/sdd1</span><span class="s2">&quot;</span>
  <span class="nv">Physical</span> <span class="nv">volume</span> <span class="s2">&quot;</span><span class="s">/dev/sdd1</span><span class="s2">&quot;</span> <span class="nv">successfully</span> <span class="nv">created</span>
<span class="mi">2</span>,建<span class="nv">VG</span>
# <span class="nv">vgcreate</span> <span class="nv">md3200</span> <span class="o">/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">sda1</span> <span class="o">/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">sdb1</span> <span class="o">/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">sdc1</span> <span class="o">/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">sdd1</span>
  <span class="nv">Volume</span> <span class="nv">group</span> <span class="s2">&quot;</span><span class="s">md3200</span><span class="s2">&quot;</span> <span class="nv">successfully</span> <span class="nv">created</span>
# <span class="nv">lvcreate</span> <span class="o">-</span><span class="nv">n</span> <span class="nv">md3200lv1</span> <span class="o">-</span><span class="nv">L</span> <span class="mi">8</span><span class="nv">T</span> <span class="nv">md3200</span>
  <span class="nv">Logical</span> <span class="nv">volume</span> <span class="s2">&quot;</span><span class="s">md3200lv1</span><span class="s2">&quot;</span> <span class="nv">created</span>
<span class="nv">You</span> <span class="nv">have</span> <span class="nv">new</span> <span class="nv">mail</span> <span class="nv">in</span> <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">spool</span><span class="o">/</span><span class="nv">mail</span><span class="o">/</span><span class="nv">root</span>
<span class="mi">3</span>,建<span class="nv">LVM</span>
#<span class="nv">lvcreate</span> <span class="o">-</span><span class="nv">n</span> <span class="nv">md3200lv1</span> <span class="o">-</span><span class="nv">L</span> <span class="mi">8</span><span class="nv">T</span> <span class="nv">md3200</span>
  <span class="nv">Logical</span> <span class="nv">volume</span> <span class="s2">&quot;</span><span class="s">md3200lv1</span><span class="s2">&quot;</span> <span class="nv">created</span>
#<span class="nv">lvcreate</span> <span class="o">-</span><span class="nv">n</span> <span class="nv">md3200lv2</span> <span class="o">-</span><span class="nv">L</span> <span class="mi">8</span><span class="nv">T</span> <span class="nv">md3200</span>
 <span class="nv">Logical</span> <span class="nv">volume</span> <span class="s2">&quot;</span><span class="s">md3200lv2</span><span class="s2">&quot;</span> <span class="nv">created</span>
三，格式化文件系统
# <span class="nv">mkfs</span>.<span class="nv">ext4</span> <span class="o">/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">md3200</span><span class="o">/</span><span class="nv">md3200lv1</span> 
<span class="nv">mke2fs</span> <span class="mi">1</span>.<span class="mi">41</span>.<span class="mi">12</span> <span class="ss">(</span><span class="mi">17</span><span class="o">-</span><span class="nv">May</span><span class="o">-</span><span class="mi">2010</span><span class="ss">)</span>
文件系统标签<span class="o">=</span>
操作系统:<span class="nv">Linux</span>
块大小<span class="o">=</span><span class="mi">4096</span> <span class="ss">(</span><span class="nv">log</span><span class="o">=</span><span class="mi">2</span><span class="ss">)</span>
分块大小<span class="o">=</span><span class="mi">4096</span> <span class="ss">(</span><span class="nv">log</span><span class="o">=</span><span class="mi">2</span><span class="ss">)</span>
<span class="nv">Stride</span><span class="o">=</span><span class="mi">0</span> <span class="nv">blocks</span>, <span class="nv">Stripe</span> <span class="nv">width</span><span class="o">=</span><span class="mi">0</span> <span class="nv">blocks</span>
<span class="mi">536870912</span> <span class="nv">inodes</span>, <span class="mi">2147483648</span> <span class="nv">blocks</span>
<span class="mi">107374182</span> <span class="nv">blocks</span> <span class="ss">(</span><span class="mi">5</span>.<span class="mi">00</span><span class="o">%</span><span class="ss">)</span> <span class="nv">reserved</span> <span class="k">for</span> <span class="nv">the</span> <span class="nv">super</span> <span class="nv">user</span>
第一个数据块<span class="o">=</span><span class="mi">0</span>
<span class="nv">Maximum</span> <span class="nv">filesystem</span> <span class="nv">blocks</span><span class="o">=</span><span class="mi">4294967296</span>
<span class="mi">65536</span> <span class="nv">block</span> <span class="nv">groups</span>
<span class="mi">32768</span> <span class="nv">blocks</span> <span class="nv">per</span> <span class="nv">group</span>, <span class="mi">32768</span> <span class="nv">fragments</span> <span class="nv">per</span> <span class="nv">group</span>
<span class="mi">8192</span> <span class="nv">inodes</span> <span class="nv">per</span> <span class="nv">group</span>
<span class="nv">Superblock</span> <span class="nv">backups</span> <span class="nv">stored</span> <span class="nv">on</span> <span class="nv">blocks</span>: 
        <span class="mi">32768</span>, <span class="mi">98304</span>, <span class="mi">163840</span>, <span class="mi">229376</span>, <span class="mi">294912</span>, <span class="mi">819200</span>, <span class="mi">884736</span>, <span class="mi">1605632</span>, <span class="mi">2654208</span>, 
        <span class="mi">4096000</span>, <span class="mi">7962624</span>, <span class="mi">11239424</span>, <span class="mi">20480000</span>, <span class="mi">23887872</span>, <span class="mi">71663616</span>, <span class="mi">78675968</span>, 
        <span class="mi">102400000</span>, <span class="mi">214990848</span>, <span class="mi">512000000</span>, <span class="mi">550731776</span>, <span class="mi">644972544</span>, <span class="mi">1934917632</span>


正在写入<span class="nv">inode</span>表: 完成                            
<span class="nv">Creating</span> <span class="nv">journal</span> <span class="ss">(</span><span class="mi">32768</span> <span class="nv">blocks</span><span class="ss">)</span>: 完成
<span class="nv">Writing</span> <span class="nv">superblocks</span> <span class="nv">and</span> <span class="nv">filesystem</span> <span class="nv">accounting</span> <span class="nv">information</span>: 完成


<span class="nv">This</span> <span class="nv">filesystem</span> <span class="nv">will</span> <span class="nv">be</span> <span class="nv">automatically</span> <span class="nv">checked</span> <span class="nv">every</span> <span class="mi">33</span> <span class="nv">mounts</span> <span class="nv">or</span>
<span class="mi">180</span> <span class="nv">days</span>, <span class="nv">whichever</span> <span class="nv">comes</span> <span class="nv">first</span>.  <span class="nv">Use</span> <span class="nv">tune2fs</span> <span class="o">-</span><span class="nv">c</span> <span class="nv">or</span> <span class="o">-</span><span class="nv">i</span> <span class="nv">to</span> <span class="nv">override</span>.
四，设置开机自动挂载
# <span class="nv">mkdir</span> <span class="nv">md3200lv1</span>  <span class="nv">md3200lv2</span>
# <span class="nv">mount</span> <span class="o">/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">md3200</span><span class="o">/</span><span class="nv">md3200lv1</span> <span class="o">/</span><span class="nv">md3200lv1</span><span class="o">/</span>
# <span class="nv">ls</span> <span class="o">/</span><span class="nv">md3200lv1</span><span class="o">/</span>
<span class="nv">lost</span><span class="o">+</span><span class="nv">found</span>
#<span class="nv">tail</span> <span class="o">-</span><span class="nv">n</span> <span class="mi">2</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">fstab</span>
<span class="o">/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">md3200</span><span class="o">/</span><span class="nv">md3200lv1</span> <span class="o">/</span><span class="nv">md3200lv1</span>                <span class="nv">ext4</span>    <span class="nv">defaults</span>                <span class="mi">1</span> <span class="mi">2</span>
<span class="o">/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">md3200</span><span class="o">/</span><span class="nv">md3200lv2</span> <span class="o">/</span><span class="nv">md3200lv2</span>                <span class="nv">ext4</span>    <span class="nv">defaults</span>                <span class="mi">1</span> <span class="mi">2</span>
五，重启验证
#<span class="nv">reboot</span>
# <span class="nv">df</span> <span class="o">-</span><span class="nv">hl</span>
文件系统              容量  已用  可用 已用<span class="o">%%</span> 挂载点
<span class="o">/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">mapper</span><span class="o">/</span><span class="nv">md3200</span><span class="o">-</span><span class="nv">md3200lv1</span>
                      <span class="mi">7</span>.<span class="mi">9</span><span class="nv">T</span>  <span class="mi">175</span><span class="nv">M</span>  <span class="mi">7</span>.<span class="mi">5</span><span class="nv">T</span>   <span class="mi">1</span><span class="o">%</span> <span class="o">/</span><span class="nv">md3200lv1</span>
<span class="o">/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">mapper</span><span class="o">/</span><span class="nv">md3200</span><span class="o">-</span><span class="nv">md3200lv2</span>
                      <span class="mi">7</span>.<span class="mi">9</span><span class="nv">T</span>  <span class="mi">175</span><span class="nv">M</span>  <span class="mi">7</span>.<span class="mi">5</span><span class="nv">T</span>   <span class="mi">1</span><span class="o">%</span> <span class="o">/</span><span class="nv">md3200lv2</span>
六，最后顺便测试一下存储的读写速度
# <span class="nv">dd</span> <span class="k">if</span><span class="o">=/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">zero</span> <span class="nv">of</span><span class="o">=</span>.<span class="o">/</span><span class="nv">test</span> <span class="nv">bs</span><span class="o">=</span><span class="mi">10</span><span class="nv">M</span> <span class="nv">count</span><span class="o">=</span><span class="mi">1000</span>
记录了<span class="mi">1000</span><span class="o">+</span><span class="mi">0</span> 的读入
记录了<span class="mi">1000</span><span class="o">+</span><span class="mi">0</span> 的写出
<span class="mi">10485760000</span>字节<span class="ss">(</span><span class="mi">10</span> <span class="nv">GB</span><span class="ss">)</span>已复制，<span class="mi">8</span>.<span class="mi">83453</span> 秒，<span class="mi">1</span>.<span class="mi">2</span> <span class="nv">GB</span><span class="o">/</span>秒
# <span class="nv">free</span> <span class="o">-</span><span class="nv">g</span>
             <span class="nv">total</span>       <span class="nv">used</span>       <span class="nv">free</span>     <span class="nv">shared</span>    <span class="nv">buffers</span>     <span class="nv">cached</span>
<span class="nv">Mem</span>:            <span class="mi">62</span>         <span class="mi">11</span>         <span class="mi">51</span>          <span class="mi">0</span>          <span class="mi">0</span>          <span class="mi">9</span>
<span class="o">-/+</span> <span class="nv">buffers</span><span class="o">/</span><span class="nv">cache</span>:          <span class="mi">1</span>         <span class="mi">61</span>
<span class="nv">Swap</span>:            <span class="mi">7</span>          <span class="mi">0</span>          <span class="mi">7</span>
# <span class="nv">dd</span> <span class="k">if</span><span class="o">=</span>.<span class="o">/</span><span class="nv">test</span> <span class="nv">of</span><span class="o">=</span>.<span class="o">/</span><span class="nv">test1</span>  <span class="nv">bs</span><span class="o">=</span><span class="mi">10</span><span class="nv">M</span> <span class="nv">count</span><span class="o">=</span><span class="mi">1000</span>
记录了<span class="mi">1000</span><span class="o">+</span><span class="mi">0</span> 的读入
记录了<span class="mi">1000</span><span class="o">+</span><span class="mi">0</span> 的写出
<span class="mi">10485760000</span>字节<span class="ss">(</span><span class="mi">10</span> <span class="nv">GB</span><span class="ss">)</span>已复制，<span class="mi">12</span>.<span class="mi">3038</span> 秒，<span class="mi">852</span> <span class="nv">MB</span><span class="o">/</span>秒
# <span class="nv">dd</span> <span class="k">if</span><span class="o">=</span>.<span class="o">/</span><span class="nv">test1</span> <span class="nv">of</span><span class="o">=</span>.<span class="o">/</span><span class="nv">test2</span>  <span class="nv">bs</span><span class="o">=</span><span class="mi">10</span><span class="nv">M</span> <span class="nv">count</span><span class="o">=</span><span class="mi">1000</span>
记录了<span class="mi">1000</span><span class="o">+</span><span class="mi">0</span> 的读入
记录了<span class="mi">1000</span><span class="o">+</span><span class="mi">0</span> 的写出
<span class="mi">10485760000</span>字节<span class="ss">(</span><span class="mi">10</span> <span class="nv">GB</span><span class="ss">)</span>已复制，<span class="mi">19</span>.<span class="mi">0357</span> 秒，<span class="mi">551</span> <span class="nv">MB</span><span class="o">/</span>秒
# <span class="nv">dd</span> <span class="k">if</span><span class="o">=</span>.<span class="o">/</span><span class="nv">test2</span> <span class="nv">of</span><span class="o">=</span>.<span class="o">/</span><span class="nv">test3</span> <span class="nv">bs</span><span class="o">=</span><span class="mi">10</span><span class="nv">M</span> <span class="nv">count</span><span class="o">=</span><span class="mi">1000</span>
记录了<span class="mi">1000</span><span class="o">+</span><span class="mi">0</span> 的读入
记录了<span class="mi">1000</span><span class="o">+</span><span class="mi">0</span> 的写出
<span class="mi">10485760000</span>字节<span class="ss">(</span><span class="mi">10</span> <span class="nv">GB</span><span class="ss">)</span>已复制，<span class="mi">18</span>.<span class="mi">641</span> 秒，<span class="mi">563</span> <span class="nv">MB</span><span class="o">/</span>秒
# <span class="nv">free</span> <span class="o">-</span><span class="nv">g</span>
             <span class="nv">total</span>       <span class="nv">used</span>       <span class="nv">free</span>     <span class="nv">shared</span>    <span class="nv">buffers</span>     <span class="nv">cached</span>
<span class="nv">Mem</span>:            <span class="mi">62</span>         <span class="mi">41</span>         <span class="mi">21</span>          <span class="mi">0</span>          <span class="mi">0</span>         <span class="mi">39</span>
<span class="o">-/+</span> <span class="nv">buffers</span><span class="o">/</span><span class="nv">cache</span>:          <span class="mi">2</span>         <span class="mi">60</span>
<span class="nv">Swap</span>:            <span class="mi">7</span>          <span class="mi">0</span>          <span class="mi">7</span>
# <span class="nv">dd</span> <span class="k">if</span><span class="o">=</span>.<span class="o">/</span><span class="nv">test3</span> <span class="nv">of</span><span class="o">=</span>.<span class="o">/</span><span class="nv">test4</span> <span class="nv">bs</span><span class="o">=</span><span class="mi">10</span><span class="nv">M</span> <span class="nv">count</span><span class="o">=</span><span class="mi">1000</span>
记录了<span class="mi">1000</span><span class="o">+</span><span class="mi">0</span> 的读入
记录了<span class="mi">1000</span><span class="o">+</span><span class="mi">0</span> 的写出
<span class="mi">10485760000</span>字节<span class="ss">(</span><span class="mi">10</span> <span class="nv">GB</span><span class="ss">)</span>已复制，<span class="mi">17</span>.<span class="mi">3797</span> 秒，<span class="mi">603</span> <span class="nv">MB</span><span class="o">/</span>秒
# <span class="nv">dd</span> <span class="k">if</span><span class="o">=</span>.<span class="o">/</span><span class="nv">test4</span> <span class="nv">of</span><span class="o">=</span>.<span class="o">/</span><span class="nv">test5</span> <span class="nv">bs</span><span class="o">=</span><span class="mi">10</span><span class="nv">M</span> <span class="nv">count</span><span class="o">=</span><span class="mi">1000</span>
记录了<span class="mi">1000</span><span class="o">+</span><span class="mi">0</span> 的读入
记录了<span class="mi">1000</span><span class="o">+</span><span class="mi">0</span> 的写出
<span class="mi">10485760000</span>字节<span class="ss">(</span><span class="mi">10</span> <span class="nv">GB</span><span class="ss">)</span>已复制，<span class="mi">22</span>.<span class="mi">8714</span> 秒，<span class="mi">458</span> <span class="nv">MB</span><span class="o">/</span>秒
# <span class="nv">dd</span> <span class="k">if</span><span class="o">=</span>.<span class="o">/</span><span class="nv">test5</span> <span class="nv">of</span><span class="o">=</span>.<span class="o">/</span><span class="nv">test6</span> <span class="nv">bs</span><span class="o">=</span><span class="mi">10</span><span class="nv">M</span> <span class="nv">count</span><span class="o">=</span><span class="mi">1000</span>
记录了<span class="mi">1000</span><span class="o">+</span><span class="mi">0</span> 的读入
记录了<span class="mi">1000</span><span class="o">+</span><span class="mi">0</span> 的写出
<span class="mi">10485760000</span>字节<span class="ss">(</span><span class="mi">10</span> <span class="nv">GB</span><span class="ss">)</span>已复制，<span class="mi">100</span>.<span class="mi">246</span> 秒，<span class="mi">105</span> <span class="nv">MB</span><span class="o">/</span>秒

因为内存是<span class="mi">64</span><span class="nv">G</span>，故前面测试有缓存，最后<span class="mi">105</span>为实际读写速度。

来源： <span class="nv">http</span>:<span class="o">//</span><span class="nv">www</span>.<span class="mi">2</span><span class="nv">cto</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">os</span><span class="o">/</span><span class="mi">201303</span><span class="o">/</span><span class="mi">195308</span>.<span class="nv">html</span>
</pre></div>


<h2 id="megacli">MegaCli</h2>
<div class="codehilite"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="p">.</span><span class="n">avagotech</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">docs</span><span class="o">-</span><span class="k">and</span><span class="o">-</span><span class="n">downloads</span><span class="o">/</span><span class="n">raid</span><span class="o">-</span><span class="n">controllers</span><span class="o">/</span><span class="n">raid</span><span class="o">-</span><span class="n">controllers</span><span class="o">-</span><span class="n">common</span><span class="o">-</span><span class="n">files</span><span class="o">/</span><span class="mi">8</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">14</span><span class="n">_MegaCLI</span><span class="p">.</span><span class="n">zip</span>

<span class="err">首先介绍下</span><span class="n">Linux</span><span class="err">系统本身查看</span>

<span class="err">软件</span><span class="n">raid</span><span class="err">：查看</span><span class="n">raid</span><span class="err">级别，状态等信息</span>

<span class="o">#</span><span class="n">cat</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">mdstat</span>

<span class="err">硬件</span><span class="n">raid</span><span class="err">：查看</span><span class="n">raid</span><span class="err">的厂商，型号，级别</span>

<span class="o">#</span><span class="n">dmesg</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">i</span> <span class="n">raid</span>

<span class="o">#</span><span class="n">cat</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">scsi</span><span class="o">/</span><span class="n">scsi</span>

<span class="mi">2</span><span class="p">.</span><span class="err">硬件</span><span class="n">raid</span><span class="err">最佳的办法是通过已安装的</span><span class="n">raid</span><span class="err">厂商的管理工具来查看</span><span class="p">,</span><span class="err">下面安装</span><span class="n">MegaCLI</span><span class="err">工具查看</span>

<span class="err">首先下载</span><span class="n">MegaCli</span><span class="err">，解压缩。</span><span class="o">#</span><span class="n">rpm</span> <span class="o">-</span><span class="n">ivh</span> <span class="n">MegaCli</span><span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="mi">01</span><span class="p">.</span><span class="mi">24</span><span class="o">-</span><span class="mi">0</span><span class="p">.</span><span class="n">i386</span><span class="p">.</span><span class="n">rpm</span>  <span class="err">安装在</span><span class="o">/</span><span class="n">opt</span><span class="err">下，所以执行命令都是</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="err">哦。</span>

<span class="err">命令使用：</span>

<span class="o">#</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaRAID</span><span class="o">/</span><span class="n">MegaCli</span><span class="o">/</span><span class="n">MegaCli64</span> <span class="o">-</span><span class="n">CfgForeign</span> <span class="o">-</span><span class="n">Clear</span> <span class="o">-</span><span class="n">a0</span> <span class="err">清除</span><span class="k">Foreign</span><span class="err">状态</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span>  <span class="o">-</span><span class="n">LDInfo</span> <span class="o">-</span><span class="n">Lall</span> <span class="o">-</span><span class="n">aALL</span> <span class="err">查</span><span class="n">raid</span><span class="err">级别</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">AdpAllInfo</span> <span class="o">-</span><span class="n">aALL</span> <span class="err">查</span><span class="n">raid</span><span class="err">卡信息</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">PDList</span> <span class="o">-</span><span class="n">aALL</span> <span class="err">查看硬盘信息</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">AdpBbuCmd</span> <span class="o">-</span><span class="n">aAll</span> <span class="err">查看电池信息</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">FwTermLog</span> <span class="o">-</span><span class="n">Dsply</span> <span class="o">-</span><span class="n">aALL</span> <span class="err">查看</span><span class="n">raid</span><span class="err">卡日志</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">adpCount</span> <span class="err">【显示适配器个数】</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">AdpGetTime</span> <span class="err">–</span><span class="n">aALL</span> <span class="err">【显示适配器时间】</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">AdpAllInfo</span> <span class="o">-</span><span class="n">aAll</span>    <span class="err">【显示所有适配器信息】</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">LDInfo</span> <span class="o">-</span><span class="n">LALL</span> <span class="o">-</span><span class="n">aAll</span>    <span class="err">【显示所有逻辑磁盘组信息】</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">PDList</span> <span class="o">-</span><span class="n">aAll</span>    <span class="err">【显示所有的物理信息】</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">AdpBbuCmd</span> <span class="o">-</span><span class="n">GetBbuStatus</span> <span class="o">-</span><span class="n">aALL</span> <span class="o">|</span><span class="n">grep</span> <span class="err">‘</span><span class="n">Charger</span> <span class="n">Status</span><span class="err">’</span> <span class="err">【查看充电状态】</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">AdpBbuCmd</span> <span class="o">-</span><span class="n">GetBbuStatus</span> <span class="o">-</span><span class="n">aALL</span><span class="err">【显示</span><span class="n">BBU</span><span class="err">状态信息】</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">AdpBbuCmd</span> <span class="o">-</span><span class="n">GetBbuCapacityInfo</span> <span class="o">-</span><span class="n">aALL</span><span class="err">【显示</span><span class="n">BBU</span><span class="err">容量信息】</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">AdpBbuCmd</span> <span class="o">-</span><span class="n">GetBbuDesignInfo</span> <span class="o">-</span><span class="n">aALL</span>    <span class="err">【显示</span><span class="n">BBU</span><span class="err">设计参数】</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">AdpBbuCmd</span> <span class="o">-</span><span class="n">GetBbuProperties</span> <span class="o">-</span><span class="n">aALL</span>    <span class="err">【显示当前</span><span class="n">BBU</span><span class="err">属性】</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">cfgdsply</span> <span class="o">-</span><span class="n">aALL</span>    <span class="err">【显示</span><span class="n">Raid</span><span class="err">卡型号，</span><span class="n">Raid</span><span class="err">设置，</span><span class="n">Disk</span><span class="err">相关信息】</span>

<span class="mi">3</span><span class="p">.</span><span class="err">磁带状态的变化，从拔盘，到插盘的过程中。</span>

<span class="n">Device</span>        <span class="o">|</span><span class="n">Normal</span><span class="o">|</span><span class="n">Damage</span><span class="o">|</span><span class="n">Rebuild</span><span class="o">|</span><span class="n">Normal</span>

<span class="n">Virtual</span> <span class="n">Drive</span>    <span class="o">|</span><span class="n">Optimal</span><span class="o">|</span><span class="n">Degraded</span><span class="o">|</span><span class="n">Degraded</span><span class="o">|</span><span class="n">Optimal</span>

<span class="n">Physical</span> <span class="n">Drive</span>    <span class="o">|</span><span class="n">Online</span><span class="o">|</span><span class="n">Failed</span> <span class="err">–</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">Unconfigured</span><span class="o">|</span><span class="n">Rebuild</span><span class="o">|</span><span class="n">Online</span>

<span class="mi">4</span><span class="p">.</span><span class="err">查看磁盘缓存策略</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">LDGetProp</span> <span class="o">-</span><span class="k">Cache</span> <span class="o">-</span><span class="n">L0</span> <span class="o">-</span><span class="n">a0</span>

<span class="k">or</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">LDGetProp</span> <span class="o">-</span><span class="k">Cache</span> <span class="o">-</span><span class="n">L1</span> <span class="o">-</span><span class="n">a0</span>

<span class="k">or</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">LDGetProp</span> <span class="o">-</span><span class="k">Cache</span> <span class="o">-</span><span class="n">LALL</span> <span class="o">-</span><span class="n">a0</span>

<span class="n">ro</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">LDGetProp</span> <span class="o">-</span><span class="k">Cache</span> <span class="o">-</span><span class="n">LALL</span> <span class="o">-</span><span class="n">aALL</span>

<span class="n">ro</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">LDGetProp</span> <span class="o">-</span><span class="n">DskCache</span> <span class="o">-</span><span class="n">LALL</span> <span class="o">-</span><span class="n">aALL</span>

<span class="mi">5</span><span class="p">.</span><span class="err">设置磁盘缓存策略</span>

<span class="err">缓存策略解释：</span>

<span class="n">WT</span>    <span class="p">(</span><span class="k">Write</span> <span class="n">through</span>

<span class="n">WB</span>    <span class="p">(</span><span class="k">Write</span> <span class="n">back</span><span class="p">)</span>

<span class="n">NORA</span>  <span class="p">(</span><span class="k">No</span> <span class="k">read</span> <span class="n">ahead</span><span class="p">)</span>

<span class="n">RA</span>    <span class="p">(</span><span class="k">Read</span> <span class="n">ahead</span><span class="p">)</span>

<span class="n">ADRA</span>  <span class="p">(</span><span class="n">Adaptive</span> <span class="k">read</span> <span class="n">ahead</span><span class="p">)</span>

<span class="n">Cached</span>

<span class="n">Direct</span>

<span class="err">例子：</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">LDSetProp</span> <span class="n">WT</span><span class="o">|</span><span class="n">WB</span><span class="o">|</span><span class="n">NORA</span><span class="o">|</span><span class="n">RA</span><span class="o">|</span><span class="n">ADRA</span> <span class="o">-</span><span class="n">L0</span> <span class="o">-</span><span class="n">a0</span>

<span class="k">or</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">LDSetProp</span> <span class="o">-</span><span class="n">Cached</span><span class="o">|-</span><span class="n">Direct</span> <span class="o">-</span><span class="n">L0</span> <span class="o">-</span><span class="n">a0</span>

<span class="k">or</span>

<span class="n">enable</span> <span class="o">/</span> <span class="n">disable</span> <span class="n">disk</span> <span class="k">cache</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">LDSetProp</span> <span class="o">-</span><span class="n">EnDskCache</span><span class="o">|-</span><span class="n">DisDskCache</span> <span class="o">-</span><span class="n">L0</span> <span class="o">-</span><span class="n">a0</span>

<span class="mi">6</span><span class="p">.</span><span class="err">创建一个</span> <span class="n">raid5</span> <span class="err">阵列，由物理盘</span> <span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span> <span class="err">构成，该阵列的热备盘是物理盘</span> <span class="mi">5</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">CfgLdAdd</span> <span class="o">-</span><span class="n">r5</span> <span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="n">WB</span> <span class="n">Direct</span> <span class="o">-</span><span class="n">Hsp</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span><span class="n">a0</span>

<span class="mi">7</span><span class="p">.</span><span class="err">创建阵列，不指定热备</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">CfgLdAdd</span> <span class="o">-</span><span class="n">r5</span> <span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="n">WB</span> <span class="n">Direct</span> <span class="o">-</span><span class="n">a0</span>

<span class="mi">8</span><span class="p">.</span><span class="err">删除阵列</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">CfgLdDel</span> <span class="o">-</span><span class="n">L1</span> <span class="o">-</span><span class="n">a0</span>

<span class="mi">9</span><span class="p">.</span><span class="err">在线添加磁盘</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">LDRecon</span> <span class="o">-</span><span class="k">Start</span> <span class="o">-</span><span class="n">r5</span> <span class="o">-</span><span class="k">Add</span> <span class="o">-</span><span class="n">PhysDrv</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span><span class="n">L1</span> <span class="o">-</span><span class="n">a0</span>

<span class="mi">10</span><span class="p">.</span><span class="err">阵列创建完后，会有一个初始化同步块的过程，可以看看其进度。</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">LDInit</span> <span class="o">-</span><span class="n">ShowProg</span> <span class="o">-</span><span class="n">LALL</span> <span class="o">-</span><span class="n">aALL</span>

<span class="err">或者以动态可视化文字界面显示</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">LDInit</span> <span class="o">-</span><span class="n">ProgDsply</span> <span class="o">-</span><span class="n">LALL</span> <span class="o">-</span><span class="n">aALL</span>

<span class="mi">11</span><span class="p">.</span><span class="err">查看阵列后台初始化进度</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">LDBI</span> <span class="o">-</span><span class="n">ShowProg</span> <span class="o">-</span><span class="n">LALL</span> <span class="o">-</span><span class="n">aALL</span>

<span class="err">或者以动态可视化文字界面显示</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">LDBI</span> <span class="o">-</span><span class="n">ProgDsply</span> <span class="o">-</span><span class="n">LALL</span> <span class="o">-</span><span class="n">aALL</span>

<span class="mi">12</span><span class="p">.</span><span class="err">指定第</span> <span class="mi">5</span> <span class="err">块盘作为全局热备</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">PDHSP</span> <span class="o">-</span><span class="k">Set</span> <span class="p">[</span><span class="o">-</span><span class="n">EnclAffinity</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">nonRevertible</span><span class="p">]</span> <span class="o">-</span><span class="n">PhysDrv</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span><span class="n">a0</span>

<span class="mi">13</span><span class="p">.</span><span class="err">指定为某个阵列的专用热备</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">PDHSP</span> <span class="o">-</span><span class="k">Set</span> <span class="p">[</span><span class="o">-</span><span class="n">Dedicated</span> <span class="p">[</span><span class="o">-</span><span class="n">Array1</span><span class="p">]]</span> <span class="p">[</span><span class="o">-</span><span class="n">EnclAffinity</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">nonRevertible</span><span class="p">]</span> <span class="o">-</span><span class="n">PhysDrv</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span><span class="n">a0</span>

<span class="mi">14</span><span class="p">.</span><span class="err">删除全局热备</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">PDHSP</span> <span class="o">-</span><span class="n">Rmv</span> <span class="o">-</span><span class="n">PhysDrv</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span><span class="n">a0</span>

<span class="mi">15</span><span class="p">.</span><span class="err">将某块物理盘下线</span><span class="o">/</span><span class="err">上线</span>
<span class="n">MegaCli64</span> <span class="o">-</span><span class="n">PDList</span> <span class="o">-</span><span class="n">aALL</span> <span class="err">确认</span>    <span class="p">[</span><span class="n">Enclosure</span> <span class="n">Device</span> <span class="n">ID</span> <span class="p">:</span> <span class="n">Slot</span> <span class="nb">Number</span><span class="p">]</span> 
                                <span class="p">[</span><span class="mi">1</span>  <span class="p">:</span>   <span class="mi">4</span><span class="p">]</span>


<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">PDOffline</span> <span class="o">-</span><span class="n">PhysDrv</span> <span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span><span class="n">a0</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">PDOnline</span> <span class="o">-</span><span class="n">PhysDrv</span> <span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span><span class="n">a0</span>

<span class="mi">16</span><span class="p">.</span><span class="err">查看物理磁盘重建进度</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">PDRbld</span> <span class="o">-</span><span class="n">ShowProg</span> <span class="o">-</span><span class="n">PhysDrv</span> <span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span><span class="n">a0</span>

<span class="err">或者以动态可视化文字界面显示</span>

<span class="o">#/</span><span class="n">opt</span><span class="o">/</span><span class="n">MegaCli</span> <span class="o">-</span><span class="n">PDRbld</span> <span class="o">-</span><span class="n">ProgDsply</span> <span class="o">-</span><span class="n">PhysDrv</span> <span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span><span class="n">a0</span>
</pre></div>


<h2 id="_1">内网云盘</h2>
<div class="codehilite"><pre><span></span><span class="n">owncloud</span>   <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">owncloud</span><span class="p">.</span><span class="n">org</span><span class="o">/</span>

<span class="n">seafile</span>     <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="p">.</span><span class="n">seafile</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">home</span><span class="o">/</span>
</pre></div>


<h2 id="lvm">lvm</h2>
<div class="codehilite"><pre><span></span><span class="n">lvm</span><span class="err">建立</span><span class="n">pv</span><span class="err">，</span><span class="n">vg</span><span class="err">不要格式化</span>
<span class="err">建立：</span>
<span class="n">pvcreate</span>  <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">xxx</span>
<span class="n">vgcreate</span>  <span class="n">vg0</span>  <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">xx</span>
<span class="n">lvcreate</span>  <span class="o">-</span><span class="n">L</span> <span class="mi">512</span><span class="n">M</span> <span class="o">-</span><span class="n">n</span> <span class="n">lv0</span> <span class="n">vg0</span>
<span class="n">mkfs</span><span class="p">.</span><span class="n">ext3</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vg1</span><span class="o">/</span><span class="n">lv0</span>
<span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vg1</span><span class="o">/</span><span class="n">lv0</span> <span class="o">/</span><span class="k">data</span><span class="o">/</span>
<span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fatab</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mapper</span><span class="o">/</span><span class="n">vg1</span><span class="o">-</span><span class="n">lvdata</span>   <span class="o">/</span><span class="k">data</span>                  <span class="n">ext3</span>    <span class="k">defaults</span>        <span class="mi">1</span> <span class="mi">2</span>

<span class="err">查看</span>
<span class="n">pvdisplay</span>   <span class="k">or</span>  <span class="n">pvscan</span>
<span class="n">vgdisplay</span>   <span class="k">or</span>   <span class="n">vgscan</span>
<span class="n">lvdisplay</span>    <span class="k">or</span>    <span class="n">lvscan</span>

<span class="n">lvm</span><span class="err">扩容</span>
<span class="err">创建一块新的分区：</span>
<span class="n">fdisk</span>  <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">hda</span>

<span class="n">n</span>

<span class="n">p</span>        <span class="o">#</span><span class="err">选择逻辑分区，如果没有，则首先创建扩展分区，然后再添加逻辑分区（硬盘：最多四个分区</span><span class="n">P</span><span class="o">-</span><span class="n">P</span><span class="o">-</span><span class="n">P</span><span class="o">-</span><span class="n">P</span><span class="err">或</span><span class="n">P</span><span class="o">-</span><span class="n">P</span><span class="o">-</span><span class="n">P</span><span class="o">-</span><span class="n">E</span><span class="err">）</span>

<span class="mi">1</span>        <span class="o">#</span><span class="err">分区号，</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">hda6</span>

<span class="n">t</span>      <span class="mi">8</span><span class="n">e</span>   <span class="o">#</span><span class="err">分区类型</span><span class="mi">8</span><span class="n">e</span><span class="err">表示</span><span class="n">LVM</span><span class="err">分区</span>

<span class="n">w</span>        <span class="o">#</span><span class="err">写入分区表</span>

<span class="n">partprobe</span>   <span class="o">#</span><span class="err">重读分区表</span>

<span class="n">partx</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">hda</span> <span class="o">#</span><span class="err">查看当前硬盘的分区表及使用情况</span>


<span class="err">创建</span><span class="n">PV</span><span class="err">，扩容</span><span class="n">VG</span><span class="err">，</span><span class="n">LV</span>

<span class="n">pvcreate</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">hda1</span>

<span class="n">vgdisplay</span> <span class="o">#</span><span class="err">查看当前已经存在的</span><span class="n">VG</span><span class="err">信息，以存在</span><span class="n">VG</span><span class="err">：</span><span class="n">VolGroup00</span><span class="err">为例</span>

<span class="n">vgextend</span> <span class="n">VolGroup00</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">hda1</span>   <span class="o">#</span><span class="err">扩展</span><span class="n">VolGroup00</span>

<span class="n">lvdisplay</span> <span class="o">#</span><span class="err">查看已经存在的</span><span class="n">LV</span><span class="err">信息，以存在</span><span class="n">LV</span><span class="err">：</span><span class="n">LogVol01</span><span class="err">为例</span>

<span class="n">lvextend</span> <span class="err">–</span><span class="n">L</span> <span class="mi">1</span><span class="k">G</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">VolGroup00</span><span class="o">/</span><span class="n">LogVol01</span> <span class="o">#</span><span class="err">扩展</span><span class="n">LV</span>

              <span class="o">-</span><span class="n">l</span> <span class="o">+</span><span class="mi">100</span><span class="o">%</span><span class="k">FREE</span>    <span class="err">全部剩余空间</span>

<span class="n">ext3</span> <span class="n">ext4</span><span class="err">文件系统</span>   
<span class="n">resize2fs</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">VolGroup00</span><span class="o">/</span><span class="n">LogVol01</span> <span class="o">#</span><span class="err">执行该重设大小，对于当前正在使用的</span><span class="n">LogVol01</span><span class="err">有效</span>

<span class="n">xfs</span><span class="err">文件系统</span>
<span class="n">xfs_growfs</span>  <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">centos</span><span class="o">/</span><span class="n">root</span> <span class="o">#</span><span class="err">执行该重设大小，对于当前正在使用的</span><span class="n">LogVol01</span><span class="err">有效</span>

<span class="n">df</span> <span class="err">–</span><span class="n">h</span> <span class="o">#</span><span class="err">查看挂载情况，已经扩容</span>
</pre></div>


<h2 id="samba">samba</h2>
<div class="codehilite"><pre><span></span><span class="n">yum</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">samba</span><span class="w"> </span><span class="n">samba</span><span class="o">-</span><span class="n">client</span><span class="w">  </span><span class="n">samba</span><span class="o">-</span><span class="n">common</span><span class="w">  </span><span class="n">samba</span><span class="o">-</span><span class="n">swat</span><span class="w"></span>
<span class="w">                   </span><span class="n">服务端</span><span class="w">    </span><span class="n">客户端</span><span class="w">            </span><span class="n">通用工具</span><span class="w">          </span><span class="n">wab管理</span><span class="w"></span>
<span class="n">systemctl</span><span class="w"> </span><span class="n">restart</span><span class="w"> </span><span class="n">smb</span><span class="w"></span>

<span class="n">vim</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">samba</span><span class="o">/</span><span class="n">smb</span><span class="p">.</span><span class="n">conf</span><span class="w"></span>
<span class="n">security</span><span class="o">=</span><span class="n">share</span><span class="o">/</span><span class="k">user</span><span class="w"></span>
<span class="n">若用户验证使用user</span><span class="err">，</span><span class="n">添加</span><span class="err">：</span><span class="w"></span>
<span class="n">passdb</span><span class="w"> </span><span class="n">backend</span><span class="o">=</span><span class="n">tdbsam</span><span class="w"></span>
<span class="n">username</span><span class="w"> </span><span class="k">map</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">samba</span><span class="o">/</span><span class="n">smbusers</span><span class="w"></span>
<span class="n">vim</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">samba</span><span class="o">/</span><span class="n">smbusers</span><span class="w"></span>
<span class="n">系统用户</span><span class="o">=</span><span class="n">samba用户1</span><span class="o">[</span><span class="n">空格</span><span class="o">]</span><span class="n">samba用户2</span><span class="w"></span>
<span class="n">smbpasswd</span><span class="w"> </span><span class="o">-</span><span class="n">a</span><span class="w"> </span><span class="n">系统用户</span><span class="w"></span>

<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">samba</span><span class="o">/</span><span class="n">smb</span><span class="p">.</span><span class="n">conf</span><span class="w">  </span>
<span class="o">[</span><span class="n">homes</span><span class="o">]</span><span class="w">  </span><span class="n">共享名</span><span class="w"></span>
<span class="n">comment</span><span class="o">=</span><span class="n">xxxx</span><span class="w">  </span><span class="n">描述</span><span class="w"></span>
<span class="k">path</span><span class="o">=/</span><span class="n">tmp</span><span class="o">/</span><span class="n">samba</span><span class="w">                     </span><span class="n">chmod</span><span class="w"> </span><span class="n">o</span><span class="o">+</span><span class="n">w</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">samba</span><span class="w"> </span>
<span class="k">public</span><span class="o">=</span><span class="n">yes</span><span class="w">  </span><span class="n">允许匿名访问</span><span class="w"></span>
<span class="n">guesk</span><span class="w"> </span><span class="n">ok</span><span class="o">=</span><span class="n">yes</span><span class="w"></span>
<span class="n">browseable</span><span class="o">=</span><span class="n">yes</span><span class="w">  </span><span class="n">共享可见</span><span class="err">，</span><span class="n">默认yes</span><span class="w"> </span>
<span class="n">writable</span><span class="o">=</span><span class="n">yes</span><span class="w">   </span><span class="n">共享可写</span><span class="w"></span>
<span class="k">write</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">可写用户列表</span><span class="err">，</span><span class="n">系统用户</span><span class="w"></span>
<span class="k">read</span><span class="w"> </span><span class="k">only</span><span class="o">=</span><span class="n">yes</span><span class="w">  </span><span class="n">共享只读</span><span class="w"></span>
<span class="k">read</span><span class="w"> </span><span class="n">list</span><span class="o">=</span><span class="n">只读用户列表</span><span class="err">，</span><span class="n">系统用户</span><span class="w">   </span><span class="n">多个</span><span class="err">，</span><span class="n">分开</span><span class="w"></span>
<span class="n">valid</span><span class="w"> </span><span class="n">users</span><span class="o">=</span><span class="w"> </span><span class="n">允许用户列表</span><span class="err">，</span><span class="n">系统用户</span><span class="w"></span>
<span class="n">invalid</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">禁止用户列表</span><span class="err">，</span><span class="n">系统用户</span><span class="w"></span>

<span class="n">例</span><span class="err">：</span><span class="w">   </span><span class="n">账号认证</span><span class="err">，</span><span class="n">匿名不能访问</span><span class="w"></span>
<span class="o">[</span><span class="n">work</span><span class="o">]</span><span class="w"></span>
<span class="w">    </span><span class="n">comment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">All</span><span class="w"></span>
<span class="w">    </span><span class="k">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">/</span><span class="k">data</span><span class="w"></span>
<span class="w">        </span><span class="n">#public</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">no</span><span class="w"></span>
<span class="w">    </span><span class="n">browseable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yes</span><span class="w"></span>
<span class="w">    </span><span class="n">#guest</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yes</span><span class="w"></span>
<span class="w">    </span><span class="n">writable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yes</span><span class="w"></span>
<span class="w">    </span><span class="k">read</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">no</span><span class="w"></span>
<span class="w">        </span><span class="k">write</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftp</span><span class="p">,</span><span class="w"> </span><span class="k">work</span><span class="w"></span>
<span class="w">    </span><span class="n">valid</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftp</span><span class="p">,</span><span class="w"> </span><span class="k">work</span><span class="w"></span>




<span class="n">客户端</span><span class="w"></span>
<span class="n">smbclient</span><span class="w"> </span><span class="o">-</span><span class="n">L</span><span class="w"> </span><span class="n">ip</span><span class="w"> </span><span class="n">查看共享列表</span><span class="w"></span>
<span class="n">smbclient</span><span class="w"> </span><span class="o">//</span><span class="n">ip</span><span class="o">/</span><span class="n">共享名</span><span class="w"> </span><span class="o">-</span><span class="n">U</span><span class="w"> </span><span class="n">用户名</span><span class="w"></span>
<span class="n">mount</span><span class="w"> </span><span class="o">-</span><span class="n">t</span><span class="w"> </span><span class="n">cifs</span><span class="w"> </span><span class="o">//</span><span class="n">ip</span><span class="o">/</span><span class="n">共享名</span><span class="w">  </span><span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">abc</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="n">username</span><span class="o">=</span><span class="n">test</span><span class="p">,</span><span class="n">passwd</span><span class="o">=</span><span class="w"></span>

<span class="n">windows直接运行</span><span class="err">\\</span><span class="n">ip</span><span class="w"></span>
</pre></div>


<h2 id="nfs">nfs</h2>
<div class="codehilite"><pre><span></span><span class="err">一、</span><span class="n">NFS</span><span class="err">服务简介</span>

<span class="err">　　</span><span class="n">NFS</span> <span class="err">是</span><span class="n">Network</span> <span class="n">File</span> <span class="k">System</span><span class="err">的缩写，即网络文件系统。一种使用于分散式文件系统的协定，由</span><span class="n">Sun</span><span class="err">公司开发，于</span><span class="mi">1984</span><span class="err">年向外公布。</span>
<span class="err">功能是通过网络让不同的机器、不同的操作系统能够彼此分享个别的数据，让应用程序在客户端通过网络访问位于服务器磁盘中的数据，</span>
<span class="err">是在类</span><span class="n">Unix</span><span class="err">系统间实现磁盘文件共享的一种方法。</span>

<span class="err">　　</span><span class="n">NFS</span> <span class="err">的基本原则是“容许不同的客户端及服务端通过一组</span><span class="n">RPC</span><span class="err">分享相同的文件系统”，它是独立于操作系统，容许不同硬件及操作系统的系统</span>
<span class="err">共同进行文件的分享。</span>

<span class="err">　　</span><span class="n">NFS</span><span class="err">在文件传送或信息传送过程中依赖于</span><span class="n">RPC</span><span class="err">协议。</span><span class="n">RPC</span><span class="err">，远程过程调用</span> <span class="p">(</span><span class="n">Remote</span> <span class="k">Procedure</span> <span class="k">Call</span><span class="p">)</span> <span class="err">是能使客户端执行其他系统中程序的</span>
<span class="err">一种机制。</span><span class="n">NFS</span><span class="err">本身是没有提供信息传输的协议和功能的，但</span><span class="n">NFS</span><span class="err">却能让我们通过网络进行资料的分享，这是因为</span><span class="n">NFS</span><span class="err">使用了一些其它的</span>
<span class="err">传输协议。而这些传输协议用到这个</span><span class="n">RPC</span><span class="err">功能的。可以说</span><span class="n">NFS</span><span class="err">本身就是使用</span><span class="n">RPC</span><span class="err">的一个程序。或者说</span><span class="n">NFS</span><span class="err">也是一个</span><span class="n">RPC</span> <span class="n">SERVER</span><span class="err">。所以只要用到</span><span class="n">NFS</span><span class="err">的地方</span>
<span class="err">都要启动</span><span class="n">RPC</span><span class="err">服务，不论是</span><span class="n">NFS</span> <span class="n">SERVER</span><span class="err">或者</span><span class="n">NFS</span> <span class="n">CLIENT</span><span class="err">。这样</span><span class="n">SERVER</span><span class="err">和</span><span class="n">CLIENT</span><span class="err">才能通过</span><span class="n">RPC</span><span class="err">来实现</span><span class="n">PROGRAM</span> <span class="n">PORT</span><span class="err">的对应。可以这么理解</span><span class="n">RPC</span><span class="err">和</span><span class="n">NFS</span><span class="err">的</span>
<span class="err">关系：</span><span class="n">NFS</span><span class="err">是一个文件系统，而</span><span class="n">RPC</span><span class="err">是负责负责信息的传输。</span>

<span class="err">二、系统环境</span>

<span class="err">系统平台：</span><span class="n">CentOS</span> <span class="n">release</span> <span class="mi">5</span><span class="p">.</span><span class="mi">6</span> <span class="p">(</span><span class="k">Final</span><span class="p">)</span>

<span class="n">NFS</span> <span class="n">Server</span> <span class="n">IP</span><span class="err">：</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">108</span>

<span class="err">防火墙已关闭</span><span class="o">/</span><span class="n">iptables</span><span class="p">:</span> <span class="n">Firewall</span> <span class="k">is</span> <span class="k">not</span> <span class="n">running</span><span class="p">.</span>

<span class="n">SELINUX</span><span class="o">=</span><span class="n">disabled</span>

<span class="err">三、安装</span><span class="n">NFS</span><span class="err">服务</span>

<span class="n">NFS</span><span class="err">的安装是非常简单的，只需要两个软件包即可，而且在通常情况下，是作为系统的默认包安装的。</span>

<span class="n">nfs</span><span class="o">-</span><span class="n">utils</span><span class="o">-*</span> <span class="err">：包括基本的</span><span class="n">NFS</span><span class="err">命令与监控程序</span> 
<span class="n">portmap</span><span class="o">-*</span> <span class="err">：支持安全</span><span class="n">NFS</span> <span class="n">RPC</span><span class="err">服务的连接，新的叫</span><span class="n">rpcbind</span>
<span class="err">查看系统是否已安装</span><span class="n">NFS</span>



<span class="err">系统默认已安装了</span><span class="n">nfs</span><span class="o">-</span><span class="n">utils</span> <span class="n">portmap</span> <span class="err">两个软件包。</span>

<span class="err">四、</span><span class="n">NFS</span><span class="err">系统守护进程</span>

<span class="n">nfsd</span><span class="err">：它是基本的</span><span class="n">NFS</span><span class="err">守护进程，主要功能是管理客户端是否能够登录服务器；</span>
<span class="n">mountd</span><span class="err">：它是</span><span class="n">RPC</span><span class="err">安装守护进程，主要功能是管理</span><span class="n">NFS</span><span class="err">的文件系统。当客户端顺利通过</span><span class="n">nfsd</span><span class="err">登录</span><span class="n">NFS</span><span class="err">服务器后，在使用</span><span class="n">NFS</span><span class="err">服务所提供的文件前，</span>
<span class="err">还必须通过文件使用权限的验证。它会读取</span><span class="n">NFS</span><span class="err">的配置文件</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">exports</span><span class="err">来对比客户端权限。</span>
<span class="n">portmap</span><span class="err">：主要功能是进行端口映射工作。当客户端尝试连接并使用</span><span class="n">RPC</span><span class="err">服务器提供的服务（如</span><span class="n">NFS</span><span class="err">服务）时，</span><span class="n">portmap</span><span class="err">会将所管理的与服务</span>
<span class="err">对应的端口提供给客户端，从而使客户可以通过该端口向服务器请求服务。</span>
<span class="err">五、</span><span class="n">NFS</span><span class="err">服务器的配置</span>

<span class="n">NFS</span><span class="err">服务器的配置相对比较简单，只需要在相应的配置文件中进行设置，然后启动</span><span class="n">NFS</span><span class="err">服务器即可。</span>

<span class="n">NFS</span><span class="err">的常用目录</span>

<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">exports</span>                           <span class="n">NFS</span><span class="err">服务的主要配置文件</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">exportfs</span>                   <span class="n">NFS</span><span class="err">服务的管理命令</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">showmount</span>              <span class="err">客户端的查看命令</span>
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">nfs</span><span class="o">/</span><span class="n">etab</span>                      <span class="err">记录</span><span class="n">NFS</span><span class="err">分享出来的目录的完整权限设定值</span>
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">nfs</span><span class="o">/</span><span class="n">xtab</span>                      <span class="err">记录曾经登录过的客户端信息</span>
<span class="n">NFS</span><span class="err">服务的配置文件为</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">exports</span><span class="err">，这个文件是</span><span class="n">NFS</span><span class="err">的主要配置文件，不过系统并没有默认值，所以这个文件不一定会存在，可能要使用</span>
<span class="n">vim</span><span class="err">手动建立，然后在文件里面写入配置内容。</span>

<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">exports</span><span class="err">文件内容格式：</span>

<span class="o">&lt;</span><span class="err">输出目录</span><span class="o">&gt;</span> <span class="p">[</span><span class="err">客户端</span><span class="mi">1</span> <span class="err">选项（访问权限</span><span class="p">,</span><span class="err">用户映射</span><span class="p">,</span><span class="err">其他）</span><span class="p">]</span> <span class="p">[</span><span class="err">客户端</span><span class="mi">2</span> <span class="err">选项（访问权限</span><span class="p">,</span><span class="err">用户映射</span><span class="p">,</span><span class="err">其他）</span><span class="p">]</span>
<span class="n">a</span><span class="p">.</span> <span class="err">输出目录：</span>

<span class="err">输出目录是指</span><span class="n">NFS</span><span class="err">系统中需要共享给客户机使用的目录；</span>

<span class="n">b</span><span class="p">.</span> <span class="err">客户端：</span>

<span class="err">客户端是指网络中可以访问这个</span><span class="n">NFS</span><span class="err">输出目录的计算机</span>

<span class="err">客户端常用的指定方式</span>

<span class="err">指定</span><span class="n">ip</span><span class="err">地址的主机：</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">200</span>
<span class="err">指定子网中的所有主机：</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">24</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">255</span><span class="p">.</span><span class="mi">255</span><span class="p">.</span><span class="mi">255</span><span class="p">.</span><span class="mi">0</span>
<span class="err">指定域名的主机：</span><span class="n">david</span><span class="p">.</span><span class="n">bsmart</span><span class="p">.</span><span class="n">cn</span>
<span class="err">指定域中的所有主机：</span><span class="o">*</span><span class="p">.</span><span class="n">bsmart</span><span class="p">.</span><span class="n">cn</span>
<span class="err">所有主机：</span><span class="o">*</span>
<span class="k">c</span><span class="p">.</span> <span class="err">选项：</span>

<span class="err">选项用来设置输出目录的访问权限、用户映射等。</span>

<span class="n">NFS</span><span class="err">主要有</span><span class="mi">3</span><span class="err">类选项：</span>

<span class="err">访问权限选项</span>

<span class="err">设置输出目录只读：</span><span class="n">ro</span>
<span class="err">设置输出目录读写：</span><span class="n">rw</span>
<span class="err">用户映射选项</span>

<span class="n">all_squash</span><span class="err">：将远程访问的所有普通用户及所属组都映射为匿名用户或用户组（</span><span class="n">nfsnobody</span><span class="err">）；</span>
<span class="n">no_all_squash</span><span class="err">：与</span><span class="n">all_squash</span><span class="err">取反（默认设置）；</span>
<span class="n">root_squash</span><span class="err">：将</span><span class="n">root</span><span class="err">用户及所属组都映射为匿名用户或用户组（默认设置）；</span>
<span class="n">no_root_squash</span><span class="err">：与</span><span class="n">rootsquash</span><span class="err">取反；</span>
<span class="n">anonuid</span><span class="o">=</span><span class="n">xxx</span><span class="err">：将远程访问的所有用户都映射为匿名用户，并指定该用户为本地用户（</span><span class="n">UID</span><span class="o">=</span><span class="n">xxx</span><span class="err">）；</span>
<span class="n">anongid</span><span class="o">=</span><span class="n">xxx</span><span class="err">：将远程访问的所有用户组都映射为匿名用户组账户，并指定该匿名用户组账户为本地用户组账户（</span><span class="n">GID</span><span class="o">=</span><span class="n">xxx</span><span class="err">）；</span>
<span class="err">其它选项</span>

<span class="n">secure</span><span class="err">：限制客户端只能从小于</span><span class="mi">1024</span><span class="err">的</span><span class="n">tcp</span><span class="o">/</span><span class="n">ip</span><span class="err">端口连接</span><span class="n">nfs</span><span class="err">服务器（默认设置）；</span>
<span class="n">insecure</span><span class="err">：允许客户端从大于</span><span class="mi">1024</span><span class="err">的</span><span class="n">tcp</span><span class="o">/</span><span class="n">ip</span><span class="err">端口连接服务器；</span>
<span class="n">sync</span><span class="err">：将数据同步写入内存缓冲区与磁盘中，效率低，但可以保证数据的一致性；</span>
<span class="n">async</span><span class="err">：将数据先保存在内存缓冲区中，必要时才写入磁盘；</span>
<span class="n">wdelay</span><span class="err">：检查是否有相关的写操作，如果有则将这些写操作一起执行，这样可以提高效率（默认设置）；</span>
<span class="n">no_wdelay</span><span class="err">：若有写操作则立即执行，应与</span><span class="n">sync</span><span class="err">配合使用；</span>
<span class="n">subtree</span><span class="err">：若输出目录是一个子目录，则</span><span class="n">nfs</span><span class="err">服务器将检查其父目录的权限</span><span class="p">(</span><span class="err">默认设置</span><span class="p">)</span><span class="err">；</span>
<span class="n">no_subtree</span><span class="err">：即使输出目录是一个子目录，</span><span class="n">nfs</span><span class="err">服务器也不检查其父目录的权限，这样可以提高效率；</span>
<span class="err">六、</span><span class="n">NFS</span><span class="err">服务器的启动与停止</span>

<span class="err">在对</span><span class="n">exports</span><span class="err">文件进行了正确的配置后，就可以启动</span><span class="n">NFS</span><span class="err">服务器了。</span>

<span class="mi">1</span><span class="err">、启动</span><span class="n">NFS</span><span class="err">服务器</span>

<span class="err">为了使</span><span class="n">NFS</span><span class="err">服务器能正常工作，需要启动</span><span class="n">portmap</span><span class="err">和</span><span class="n">nfs</span><span class="err">两个服务，并且</span><span class="n">portmap</span><span class="err">一定要先于</span><span class="n">nfs</span><span class="err">启动。</span>

<span class="o">#</span> <span class="n">service</span> <span class="n">portmap</span> <span class="k">start</span>
<span class="o">#</span> <span class="n">service</span> <span class="n">nfs</span> <span class="k">start</span>


<span class="mi">2</span><span class="err">、查询</span><span class="n">NFS</span><span class="err">服务器状态</span>

<span class="o">#</span> <span class="n">service</span> <span class="n">portmap</span> <span class="n">status</span>
<span class="o">#</span> <span class="n">service</span> <span class="n">nfs</span> <span class="n">status</span>


<span class="mi">3</span><span class="err">、停止</span><span class="n">NFS</span><span class="err">服务器</span>

<span class="err">要停止</span><span class="n">NFS</span><span class="err">运行时，需要先停止</span><span class="n">nfs</span><span class="err">服务再停止</span><span class="n">portmap</span><span class="err">服务，对于系统中有其他服务</span><span class="p">(</span><span class="err">如</span><span class="n">NIS</span><span class="p">)</span><span class="err">需要使用时，不需要停止</span><span class="n">portmap</span><span class="err">服务</span>

<span class="o">#</span> <span class="n">service</span> <span class="n">nfs</span> <span class="n">stop</span>
<span class="o">#</span> <span class="n">service</span> <span class="n">portmap</span> <span class="n">stop</span>
<span class="mi">4</span><span class="err">、设置</span><span class="n">NFS</span><span class="err">服务器的自动启动状态</span>

<span class="err">对于实际的应用系统，每次启动</span><span class="n">LINUX</span><span class="err">系统后都手工启动</span><span class="n">nfs</span><span class="err">服务器是不现实的，需要设置系统在指定的运行级别自动启动</span><span class="n">portmap</span><span class="err">和</span><span class="n">nfs</span><span class="err">服务。</span>

<span class="o">#</span> <span class="n">chkconfig</span> <span class="c1">--list portmap</span>
<span class="o">#</span> <span class="n">chkconfig</span> <span class="c1">--list nfs</span>


<span class="err">设置</span><span class="n">portmap</span><span class="err">和</span><span class="n">nfs</span><span class="err">服务在系统运行级别</span><span class="mi">3</span><span class="err">和</span><span class="mi">5</span><span class="err">自动启动。</span>

<span class="o">#</span> <span class="n">chkconfig</span> <span class="c1">--level 35 portmap on</span>
<span class="o">#</span> <span class="n">chkconfig</span> <span class="c1">--level 35 nfs on</span>


<span class="err">七、实例</span>

<span class="mi">1</span><span class="err">、将</span><span class="n">NFS</span> <span class="n">Server</span> <span class="err">的</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">david</span><span class="o">/</span> <span class="err">共享给</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">24</span><span class="err">网段，权限读写。</span>

<span class="o">#</span> <span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">exports</span>

<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">david</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">24</span><span class="p">(</span><span class="n">rw</span><span class="p">)</span>
<span class="mi">2</span><span class="err">、重启</span><span class="n">portmap</span> <span class="err">和</span><span class="n">nfs</span> <span class="err">服务</span>

<span class="o">#</span> <span class="n">service</span> <span class="n">portmap</span> <span class="k">restart</span>
<span class="o">#</span> <span class="n">service</span> <span class="n">nfs</span> <span class="k">restart</span>
<span class="o">#</span> <span class="n">exportfs</span>


<span class="mi">3</span><span class="err">、服务器端使用</span><span class="n">showmount</span><span class="err">命令查询</span><span class="n">NFS</span><span class="err">的共享状态</span>

<span class="o">#</span> <span class="n">showmount</span> <span class="o">-</span><span class="n">e</span><span class="err">　　　　</span><span class="o">//</span><span class="err">默认查看自己共享的服务，前提是要</span><span class="n">DNS</span><span class="err">能解析自己，不然容易报错</span>



<span class="o">#</span> <span class="n">showmount</span> <span class="o">-</span><span class="n">a</span><span class="err">　　　　</span><span class="o">//</span><span class="err">显示已经与客户端连接上的目录信息</span>



<span class="mi">4</span><span class="err">、客户端使用</span><span class="n">showmount</span><span class="err">命令查询</span><span class="n">NFS</span><span class="err">的共享状态</span>

<span class="o">#</span> <span class="n">showmount</span> <span class="o">-</span><span class="n">e</span> <span class="n">NFS</span><span class="err">服务器</span><span class="n">IP</span>



<span class="mi">5</span><span class="err">、客户端挂载</span><span class="n">NFS</span><span class="err">服务器中的共享目录</span>

<span class="err">命令格式</span>

<span class="o">#</span> <span class="n">mount</span> <span class="n">NFS</span><span class="err">服务器</span><span class="n">IP</span><span class="p">:</span><span class="err">共享目录</span> <span class="err">本地挂载点目录</span>
<span class="o">#</span> <span class="n">mount</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">108</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">david</span><span class="o">/</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">david</span><span class="o">/</span>

<span class="o">#</span> <span class="n">mount</span> <span class="o">|</span><span class="n">grep</span> <span class="n">nfs</span>



<span class="err">挂载成功。</span>

<span class="err">查看文件是否和服务器端一致。</span>



<span class="mi">6</span><span class="err">、</span><span class="n">NFS</span><span class="err">的共享权限和访问控制</span>

<span class="err">现在我们在</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">david</span><span class="o">/</span> <span class="err">里面建立一个文件，看看权限是什么</span>

<span class="o">#</span> <span class="n">touch</span> <span class="mi">20130103</span>



<span class="err">这里出现</span><span class="n">Permission</span> <span class="n">denied</span><span class="err">，是因为</span><span class="n">NFS</span> <span class="err">服务器端共享的目录本身的写权限没有开放给其他用户，在服务器端打开该权限。</span>

<span class="o">#</span> <span class="n">chmod</span> <span class="mi">777</span> <span class="o">-</span><span class="n">R</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">david</span><span class="o">/</span>



<span class="err">再次在客户端</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">david</span><span class="o">/</span> <span class="err">里面建立一个文件</span>



<span class="err">我用</span><span class="n">root</span> <span class="err">用户建立的文件，变成了</span><span class="n">nfsnobody</span> <span class="err">用户。</span>

<span class="n">NFS</span><span class="err">有很多默认的参数，打开</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">nfs</span><span class="o">/</span><span class="n">etab</span> <span class="err">查看分享出来的</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">david</span><span class="o">/</span> <span class="err">完整权限设定值。</span>

<span class="o">#</span> <span class="n">cat</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">nfs</span><span class="o">/</span><span class="n">etab</span>



<span class="err">默认就有</span><span class="n">sync</span><span class="err">，</span><span class="n">wdelay</span><span class="err">，</span><span class="n">hide</span> <span class="err">等等，</span><span class="n">no_root_squash</span> <span class="err">是让</span><span class="n">root</span><span class="err">保持权限，</span><span class="n">root_squash</span> <span class="err">是把</span><span class="n">root</span><span class="err">映射成</span><span class="n">nobody</span><span class="err">，</span><span class="n">no_all_squash</span> <span class="err">不让</span>
<span class="err">所有用户保持在挂载目录中的权限。所以，</span><span class="n">root</span><span class="err">建立的文件所有者是</span><span class="n">nfsnobody</span><span class="err">。</span>

<span class="err">下面我们使用普通用户挂载、写入文件测试。</span>

<span class="o">#</span> <span class="n">su</span> <span class="o">-</span> <span class="n">david</span>

<span class="err">$</span> <span class="n">cd</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">david</span><span class="o">/</span>

<span class="err">$</span> <span class="n">touch</span> <span class="mi">2013</span><span class="n">david</span>



<span class="err">普通用户写入文件时就是自己的名字，这也就保证了服务器的安全性。</span>
<span class="err">　　关于权限的分析</span>

<span class="err">　　</span><span class="mi">1</span><span class="p">.</span> <span class="err">客户端连接时候，对普通用户的检查</span>

<span class="err">　　　　</span><span class="n">a</span><span class="p">.</span> <span class="err">如果明确设定了普通用户被压缩的身份，那么此时客户端用户的身份转换为指定用户；</span>

<span class="err">　　　　</span><span class="n">b</span><span class="p">.</span> <span class="err">如果</span><span class="n">NFS</span> <span class="n">server</span><span class="err">上面有同名用户，那么此时客户端登录账户的身份转换为</span><span class="n">NFS</span> <span class="n">server</span><span class="err">上面的同名用户；</span>

<span class="err">　　　　</span><span class="k">c</span><span class="p">.</span> <span class="err">如果没有明确指定，也没有同名用户，那么此时</span> <span class="err">用户身份被压缩成</span><span class="n">nfsnobody</span><span class="err">；</span>

<span class="err">　　</span><span class="mi">2</span><span class="p">.</span> <span class="err">客户端连接的时候，对</span><span class="n">root</span><span class="err">的检查</span>

<span class="err">　　　　</span><span class="n">a</span><span class="p">.</span> <span class="err">如果设置</span><span class="n">no_root_squash</span><span class="err">，那么此时</span><span class="n">root</span><span class="err">用户的身份被压缩为</span><span class="n">NFS</span> <span class="n">server</span><span class="err">上面的</span><span class="n">root</span><span class="err">；</span>

<span class="err">　　　　</span><span class="n">b</span><span class="p">.</span> <span class="err">如果设置了</span><span class="n">all_squash</span><span class="err">、</span><span class="n">anonuid</span><span class="err">、</span><span class="n">anongid</span><span class="err">，此时</span><span class="n">root</span> <span class="err">身份被压缩为指定用户；</span>

<span class="err">　　　　</span><span class="k">c</span><span class="p">.</span> <span class="err">如果没有明确指定，此时</span><span class="n">root</span><span class="err">用户被压缩为</span><span class="n">nfsnobody</span><span class="err">；</span>

<span class="err">　　　　</span><span class="n">d</span><span class="p">.</span> <span class="err">如果同时指定</span><span class="n">no_root_squash</span><span class="err">与</span><span class="n">all_squash</span> <span class="err">用户将被压缩为</span> <span class="n">nfsnobody</span><span class="err">，如果设置了</span><span class="n">anonuid</span><span class="err">、</span><span class="n">anongid</span><span class="err">将被压缩到所指定的</span>
<span class="err">用户与组；</span>

<span class="mi">7</span><span class="err">、卸载已挂载的</span><span class="n">NFS</span><span class="err">共享目录</span>

<span class="o">#</span> <span class="n">umount</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">david</span><span class="o">/</span>



<span class="err">八、启动自动挂载</span><span class="n">nfs</span><span class="err">文件系统</span>

<span class="err">格式：</span>

<span class="o">&lt;</span><span class="n">server</span><span class="o">&gt;</span><span class="p">:</span><span class="o">&lt;/</span><span class="n">remote</span><span class="o">/</span><span class="n">export</span><span class="o">&gt;</span> <span class="o">&lt;/</span><span class="k">local</span><span class="o">/</span><span class="n">directory</span><span class="o">&gt;</span> <span class="n">nfs</span> <span class="o">&lt;</span> <span class="k">options</span><span class="o">&gt;</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="o">#</span> <span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fstab</span>



<span class="err">保存退出，重启系统。</span>

<span class="err">查看</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">david</span> <span class="err">有没有自动挂载。</span>



<span class="err">自动挂载成功。</span>

<span class="err">九、相关命令</span>

<span class="mi">1</span><span class="err">、</span><span class="n">exportfs</span>

<span class="err">如果我们在启动了</span><span class="n">NFS</span><span class="err">之后又修改了</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">exports</span><span class="err">，是不是还要重新启动</span><span class="n">nfs</span><span class="err">呢？这个时候我们就可以用</span><span class="n">exportfs</span> <span class="err">命令来使改动立刻生效，</span>
<span class="err">该命令格式如下：</span>

<span class="err">　　</span><span class="o">#</span> <span class="n">exportfs</span> <span class="p">[</span><span class="o">-</span><span class="n">aruv</span><span class="p">]</span>

<span class="err">　　</span><span class="o">-</span><span class="n">a</span> <span class="err">全部挂载或卸载</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">exports</span><span class="err">中的内容</span> 
<span class="err">　　</span><span class="o">-</span><span class="n">r</span> <span class="err">重新读取</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">exports</span> <span class="err">中的信息</span> <span class="err">，并同步更新</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">exports</span><span class="err">、</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">nfs</span><span class="o">/</span><span class="n">xtab</span>
<span class="err">　　</span><span class="o">-</span><span class="n">u</span> <span class="err">卸载单一目录（和</span><span class="o">-</span><span class="n">a</span><span class="err">一起使用为卸载所有</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">exports</span><span class="err">文件中的目录）</span>
<span class="err">　　</span><span class="o">-</span><span class="n">v</span> <span class="err">在</span><span class="n">export</span><span class="err">的时候，将详细的信息输出到屏幕上。</span>

<span class="err">具体例子：</span> 
<span class="err">　　</span><span class="o">#</span> <span class="n">exportfs</span> <span class="o">-</span><span class="n">au</span> <span class="err">卸载所有共享目录</span>
<span class="err">　　</span><span class="o">#</span> <span class="n">exportfs</span> <span class="o">-</span><span class="n">rv</span> <span class="err">重新共享所有目录并输出详细信息</span>

<span class="mi">2</span><span class="err">、</span><span class="n">nfsstat</span>

<span class="err">查看</span><span class="n">NFS</span><span class="err">的运行状态，对于调整</span><span class="n">NFS</span><span class="err">的运行有很大帮助。</span>

<span class="mi">3</span><span class="err">、</span><span class="n">rpcinfo</span>

<span class="err">查看</span><span class="n">rpc</span><span class="err">执行信息，可以用于检测</span><span class="n">rpc</span><span class="err">运行情况的工具，利用</span><span class="n">rpcinfo</span> <span class="o">-</span><span class="n">p</span> <span class="err">可以查看出</span><span class="n">RPC</span><span class="err">开启的端口所提供的程序有哪些。</span>

<span class="mi">4</span><span class="err">、</span><span class="n">showmount</span>

<span class="err">　　</span><span class="o">-</span><span class="n">a</span> <span class="err">显示已经于客户端连接上的目录信息</span>
<span class="err">　　</span><span class="o">-</span><span class="n">e</span> <span class="n">IP</span><span class="err">或者</span><span class="n">hostname</span> <span class="err">显示此</span><span class="n">IP</span><span class="err">地址分享出来的目录</span>

<span class="mi">5</span><span class="err">、</span><span class="n">netstat</span>

<span class="err">可以查看出</span><span class="n">nfs</span><span class="err">服务开启的端口，其中</span><span class="n">nfs</span> <span class="err">开启的是</span><span class="mi">2049</span><span class="err">，</span><span class="n">portmap</span> <span class="err">开启的是</span><span class="mi">111</span><span class="err">，其余则是</span><span class="n">rpc</span><span class="err">开启的。</span>

<span class="err">最后注意两点，虽然通过权限设置可以让普通用户访问，但是挂载的时候默认情况下只有</span><span class="n">root</span><span class="err">可以去挂载，普通用户可以执行</span><span class="n">sudo</span><span class="err">。</span>

<span class="n">NFS</span> <span class="n">server</span> <span class="err">关机的时候一点要确保</span><span class="n">NFS</span><span class="err">服务关闭，没有客户端处于连接状态！通过</span><span class="n">showmount</span> <span class="o">-</span><span class="n">a</span> <span class="err">可以查看，如果有的话用</span><span class="n">kill</span> <span class="n">killall</span> <span class="n">pkill</span>
 <span class="err">来结束，（</span><span class="o">-</span><span class="mi">9</span> <span class="err">强制结束）</span>
</pre></div>


<h2 id="iozone">iozone</h2>
<div class="codehilite"><pre><span></span><span class="nv">http</span>:<span class="o">//</span><span class="nv">www</span>.<span class="nv">iozone</span>.<span class="nv">org</span>

<span class="nv">wget</span> <span class="nv">http</span>:<span class="o">//</span><span class="nv">www</span>.<span class="nv">iozone</span>.<span class="nv">org</span><span class="o">/</span><span class="nv">src</span><span class="o">/</span><span class="nv">current</span><span class="o">/</span><span class="nv">iozone3_465</span>.<span class="nv">tar</span>
<span class="nv">tar</span> <span class="o">-</span><span class="nv">xf</span> <span class="nv">iozone3_465</span>.<span class="nv">tar</span>
<span class="nv">cd</span> <span class="nv">iozone3_465</span><span class="o">/</span><span class="nv">src</span><span class="o">/</span><span class="nv">current</span><span class="o">/</span>
<span class="nv">make</span> <span class="nv">linux</span>

 测试的时候请注意，设置的测试文件的大小一定要大过你的内存（最佳为内存的两倍大小），不然<span class="nv">linux</span>会给你的读写的内容进行缓存。
 会使数值非常不真实。

测试命令是 
.<span class="o">/</span><span class="nv">iozone</span> <span class="o">-</span><span class="nv">s</span> <span class="mi">5</span><span class="nv">g</span> <span class="o">-</span><span class="nv">i0</span> <span class="o">-</span><span class="nv">i1</span> <span class="o">-</span><span class="nv">i2</span> <span class="o">-</span><span class="nv">Rb</span> <span class="nv">ioperf</span>.<span class="nv">xls</span> <span class="o">-</span><span class="nv">I</span>    数据更真实， <span class="o">-</span><span class="nv">I</span>  <span class="nv">direct</span> <span class="nv">io</span> 不过读写速度结果更低
.<span class="o">/</span><span class="nv">iozone</span> <span class="o">-</span><span class="nv">Rab</span>  <span class="nv">ioperf</span>.<span class="nv">xls</span>  <span class="o">-</span><span class="nv">s</span> <span class="mi">64</span><span class="nv">G</span> <span class="o">-</span><span class="nv">i</span> <span class="mi">0</span> <span class="o">-</span><span class="nv">i</span> <span class="mi">1</span> <span class="o">-</span><span class="nv">i</span> <span class="mi">2</span> <span class="o">-</span><span class="nv">y</span> <span class="mi">4</span><span class="nv">k</span> <span class="o">-</span><span class="nv">q</span> <span class="mi">16</span><span class="nv">k</span>  测试更大的文件更接近

常用参数解释:
<span class="o">-</span><span class="nv">a</span>  <span class="nv">auto</span> <span class="nv">mode</span>产生文件大小<span class="mi">16</span><span class="nv">K</span><span class="o">-</span><span class="mi">512</span><span class="nv">M</span>,记录大小<span class="mi">4</span><span class="nv">K</span><span class="o">-</span><span class="mi">16</span><span class="nv">M</span>的输出结果；
<span class="o">-</span><span class="nv">e</span>  计算时间时算上<span class="nv">fflush</span>，<span class="nv">fsync</span>的时间；
<span class="o">-</span><span class="nv">f</span>  指定临时测试文件 可以测试不同分区会磁盘；
<span class="o">-</span><span class="nv">R</span> 产生<span class="nv">excel</span>格式的输出（仅显示在屏幕上,不会产生<span class="nv">excel</span>文件）
<span class="o">-</span><span class="nv">b</span> 产生<span class="nv">excel</span>格式的文件
<span class="o">-</span><span class="nv">s</span>  指定测试文件大小  支持<span class="o">-</span><span class="nv">k</span> <span class="o">-</span><span class="nv">m</span> <span class="o">-</span><span class="nv">g</span>； 
<span class="o">-</span><span class="nv">r</span>  指定测试记录大小；
<span class="o">-</span><span class="nv">g</span> <span class="o">-</span><span class="nv">n</span> 指定<span class="nv">auto</span>模式下，最大<span class="o">/</span>小测试文件大小；
<span class="o">-</span><span class="nv">q</span> <span class="o">-</span><span class="nv">y</span> 指定<span class="nv">auto</span>模式下，最大<span class="o">/</span>小测试记录大小；
<span class="o">-</span><span class="nv">i</span>  指定特定的测试操作：
     <span class="ss">(</span><span class="mi">0</span><span class="o">=</span><span class="nv">write</span><span class="o">/</span><span class="nv">rewrite</span>, <span class="mi">1</span><span class="o">=</span><span class="nv">read</span><span class="o">/</span><span class="nv">re</span><span class="o">-</span><span class="nv">read</span>, <span class="mi">2</span><span class="o">=</span><span class="k">random</span><span class="o">-</span><span class="nv">read</span><span class="o">/</span><span class="nv">write</span>
<span class="mi">3</span><span class="o">=</span><span class="nv">Read</span><span class="o">-</span><span class="nv">backwards</span>, <span class="mi">4</span><span class="o">=</span><span class="nv">Re</span><span class="o">-</span><span class="nv">write</span><span class="o">-</span><span class="nv">record</span>, <span class="mi">5</span><span class="o">=</span><span class="nv">stride</span><span class="o">-</span><span class="nv">read</span>, <span class="mi">6</span><span class="o">=</span><span class="nv">fwrite</span><span class="o">/</span><span class="nv">re</span><span class="o">-</span><span class="nv">fwrite</span>, <span class="mi">7</span><span class="o">=</span><span class="nv">fread</span><span class="o">/</span><span class="nv">Re</span><span class="o">-</span><span class="nv">fread</span>,
<span class="mi">8</span><span class="o">=</span><span class="k">random</span> <span class="nv">mix</span>, <span class="mi">9</span><span class="o">=</span><span class="nv">pwrite</span><span class="o">/</span><span class="nv">Re</span><span class="o">-</span><span class="nv">pwrite</span>, <span class="mi">10</span><span class="o">=</span><span class="nv">pread</span><span class="o">/</span><span class="nv">Re</span><span class="o">-</span><span class="nv">pread</span>, <span class="mi">11</span><span class="o">=</span><span class="nv">pwritev</span><span class="o">/</span><span class="nv">Re</span><span class="o">-</span><span class="nv">pwritev</span>, <span class="mi">12</span><span class="o">=</span><span class="nv">preadv</span><span class="o">/</span><span class="nv">Repreadv</span>）
<span class="o">-</span><span class="nv">I</span>  指定<span class="nv">direct</span> <span class="nv">io</span>操作；
<span class="o">-</span><span class="nv">p</span>  清除<span class="nv">cpu</span> <span class="nv">cache</span>影响；
<span class="o">-</span><span class="nv">t</span>  并发数
<span class="o">-</span><span class="nv">O</span>  输出<span class="nv">IOPS</span>值；
<span class="o">-</span><span class="nv">R</span>  生成<span class="nv">excel</span>报告文件；
<span class="o">-</span><span class="nv">W</span>  读写之前锁定文件；

测试生成的<span class="nv">ioperf1</span>.<span class="nv">xls</span>是操作系统中<span class="nv">read</span>，<span class="nv">write</span>速率，以下表为例，该表是是关于<span class="nv">write</span>的测试结果，左侧一列是测试文件大小（<span class="nv">Kbytes</span><span class="ss">)</span>,
最上边一行是记录大小，中间数据是测试的传输速度。举例说明，比如表中的“<span class="mi">19918</span>”，意思是测试文件大小为<span class="mi">64</span><span class="nv">K</span>，以记录大小为<span class="mi">4</span><span class="nv">K</span>来进行传输，
它的传输速度为<span class="mi">19918</span><span class="nv">Kbytes</span><span class="o">/</span><span class="nv">s</span>。


<span class="o">-</span><span class="nv">i</span>的取值说明如下：

<span class="mi">0</span><span class="o">=</span><span class="nv">write</span><span class="o">/</span><span class="nv">rewrite</span>
<span class="mi">1</span><span class="o">=</span><span class="nv">read</span><span class="o">/</span><span class="nv">re</span><span class="o">-</span><span class="nv">read</span>
<span class="mi">2</span><span class="o">=</span><span class="k">random</span><span class="o">-</span><span class="nv">read</span><span class="o">/</span><span class="nv">write</span>
<span class="mi">3</span><span class="o">=</span><span class="nv">Read</span><span class="o">-</span><span class="nv">backwards</span>
<span class="mi">4</span><span class="o">=</span><span class="nv">Re</span><span class="o">-</span><span class="nv">write</span><span class="o">-</span><span class="nv">record</span>
<span class="mi">5</span><span class="o">=</span><span class="nv">stride</span><span class="o">-</span><span class="nv">read</span>
<span class="mi">6</span><span class="o">=</span><span class="nv">fwrite</span><span class="o">/</span><span class="nv">re</span><span class="o">-</span><span class="nv">fwrite</span>
<span class="mi">7</span><span class="o">=</span><span class="nv">fread</span><span class="o">/</span><span class="nv">Re</span><span class="o">-</span><span class="nv">fread</span>
<span class="mi">8</span><span class="o">=</span><span class="k">random</span> <span class="nv">mix</span>
<span class="mi">9</span><span class="o">=</span><span class="nv">pwrite</span><span class="o">/</span><span class="nv">Re</span><span class="o">-</span><span class="nv">pwrite</span>
<span class="mi">10</span><span class="o">=</span><span class="nv">pread</span><span class="o">/</span><span class="nv">Re</span><span class="o">-</span><span class="nv">pread</span>
<span class="mi">11</span><span class="o">=</span><span class="nv">pwritev</span><span class="o">/</span><span class="nv">Re</span><span class="o">-</span><span class="nv">pwritev</span>
<span class="mi">12</span><span class="o">=</span><span class="nv">preadv</span><span class="o">/</span><span class="nv">Re</span><span class="o">-</span><span class="nv">preadv</span>


<span class="nv">Write</span>:测试向一个新文件写入的性能。当一个新文件被写入时，不仅仅是那些文件中的数据需要被存储，还包括那些用于定位数据存储在存储介质的
具体位置的额外信息。这些额外信息被称作“元数据”。它包括目录信息，所分配的空间和一些与该文件有关但又并非该文件所含数据的其他数据。
拜这些额外信息所赐，<span class="nv">Write</span>的性能通常会比<span class="nv">Re</span><span class="o">-</span><span class="nv">write</span>的性能低。

<span class="nv">Re</span><span class="o">-</span><span class="nv">write</span>:测试向一个已存在的文件写入的性能。当一个已存在的文件被写入时，所需工作量较少，因为此时元数据已经存在。<span class="nv">Re</span><span class="o">-</span><span class="nv">write</span>的性能通常
比<span class="nv">Write</span>的性能高。
<span class="nv">Read</span>: 测试读一个已存在的文件的性能。
<span class="nv">Re</span><span class="o">-</span><span class="nv">Read</span>:测试读一个最近读过的文件的性能。<span class="nv">Re</span><span class="o">-</span><span class="nv">Read</span>性能会高些，因为操作系统通常会缓存最近读过的文件数据。这个缓存可以被用于读以提高性能。
<span class="k">Random</span> <span class="nv">Read</span>:测试读一个文件中的随机偏移量的性能。许多因素可能影响这种情况下的系统性能，例如：操作系统缓存的大小，磁盘数量，寻道延迟
和其他。
<span class="k">Random</span> <span class="nv">Write</span>:测试写一个文件中的随机偏移量的性能。同样，许多因素可能影响这种情况下的系统性能，例如：操作系统缓存的大小，磁盘数量，
寻道延迟和其他。
<span class="k">Random</span> <span class="nv">Mix</span>:测试读写一个文件中的随机偏移量的性能。同样，许多因素可能影响这种情况下的系统性能，例如：操作系统缓存的大小，磁盘数量，
寻道延迟和其他。这个测试只有在吞吐量测试模式下才能进行。每个线程<span class="o">/</span>进程运行读或写测试。这种分布式读<span class="o">/</span>写测试是基于<span class="nv">roundrobin</span> 模式的。
最好使用多于一个线程<span class="o">/</span>进程执行此测试。
<span class="nv">Backwards</span> <span class="nv">Read</span>:测试使用倒序读一个文件的性能。这种读文件方法可能看起来很可笑，事实上，有些应用确实这么干。<span class="nv">MSCNastran</span>是一个使用
倒序读文件的应用程序的一个例子。它所读的文件都十分大（大小从<span class="nv">G</span>级别到<span class="nv">T</span>级别）。尽管许多操作系统使用一些特殊实现来优化顺序读文件的速度，
很少有操作系统注意到并增强倒序读文件的性能。
<span class="nv">Record</span> <span class="nv">Rewrite</span>:测试写与覆盖写一个文件中的特定块的性能。这个块可能会发生一些很有趣的事。如果这个块足够小（比<span class="nv">CPU</span>数据缓存小），
测出来的性能将会非常高。如果比<span class="nv">CPU</span>数据缓存大而比<span class="nv">TLB</span>小，测出来的是另一个阶段的性能。如果比此二者都大，但比操作系统缓存小，得到的性能
又是一个阶段。若大到超过操作系统缓存，又是另一番结果。
<span class="nv">Strided</span> <span class="nv">Read</span>:测试跳跃读一个文件的性能。举例如下：在<span class="mi">0</span>偏移量处读<span class="mi">4</span><span class="nv">Kbytes</span>，然后间隔<span class="mi">200</span><span class="nv">Kbytes</span>,读<span class="mi">4</span><span class="nv">Kbytes</span>，再间隔<span class="mi">200</span><span class="nv">Kbytes</span>，如此反复。
此时的模式是读<span class="mi">4</span><span class="nv">Kbytes</span>，间隔<span class="mi">200</span><span class="nv">Kbytes</span>并重复这个模式。这又是一个典型的应用行为，文件中使用了数据结构并且访问这个数据结构的特定区域的
应用程序常常这样做。
许多操作系统并没注意到这种行为或者针对这种类型的访问做一些优化。同样，这种访问行为也可能导致一些有趣的性能异常。一个例子是在一个
数据片化的文件系统里，应用程序的跳跃导致某一个特定的磁盘成为性能瓶颈。
<span class="nv">Fwrite</span>:测试调用库函数<span class="nv">fwrite</span><span class="ss">()</span>来写文件的性能。这是一个执行缓存与阻塞写操作的库例程。缓存在用户空间之内。如果一个应用程序想要写
很小的传输块，<span class="nv">fwrite</span><span class="ss">()</span>函数中的缓存与阻塞<span class="nv">I</span><span class="o">/</span><span class="nv">O</span>功能能通过减少实际操作系统调用并在操作系统调用时增加传输块的大小来增强应用程序的性能。
这个测试是写一个新文件，所以元数据的写入也是要的。
<span class="nv">Frewrite</span>:测试调用库函数<span class="nv">fwrite</span><span class="ss">()</span>来写文件的性能。这是一个执行缓存与阻塞写操作的库例程。缓存在用户空间之内。如果一个应用程序想要写
很小的传输块，<span class="nv">fwrite</span><span class="ss">()</span>函数中的缓存与阻塞<span class="nv">I</span><span class="o">/</span><span class="nv">O</span>功能能通过减少实际操作系统调用并在操作系统调用时增加传输块的大小来增强应用程序的性能。
这个测试是写入一个已存在的文件，由于无元数据操作，测试的性能会高些。
<span class="nv">Fread</span>:测试调用库函数<span class="nv">fread</span><span class="ss">()</span>来读文件的性能。这是一个执行缓存与阻塞读操作的库例程。缓存在用户空间之内。如果一个应用程序想要读很小的
传输块，<span class="nv">fwrite</span><span class="ss">()</span>函数中的缓存与阻塞<span class="nv">I</span><span class="o">/</span><span class="nv">O</span>功能能通过减少实际操作系统调用并在操作系统调用时增加传输块的大小来增强应用程序的性能。
<span class="nv">Freread</span>: 这个测试与上面的<span class="nv">fread</span> 类似
</pre></div>


<h2 id="fio">fio测试磁盘</h2>
<div class="codehilite"><pre><span></span><span class="n">注</span><span class="w"></span>
<span class="n">意</span><span class="err">：</span><span class="n">不要对有数据的磁盘或者分区做测试</span><span class="err">，</span><span class="n">会破坏已存在的数据</span><span class="w"></span>
<span class="n">慎用</span><span class="err">！！！</span><span class="w"></span>

<span class="n">FIO安装</span><span class="w"></span>
<span class="n">wget</span><span class="w"> </span><span class="nl">http</span><span class="p">:</span><span class="o">//</span><span class="n">brick</span><span class="p">.</span><span class="n">kernel</span><span class="p">.</span><span class="n">dk</span><span class="o">/</span><span class="n">snaps</span><span class="o">/</span><span class="n">fio</span><span class="o">-</span><span class="mf">2.2.5</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span><span class="w"></span>
<span class="n">yum</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">libaio</span><span class="o">-</span><span class="n">devel</span><span class="w"></span>
<span class="n">tar</span><span class="w"> </span><span class="o">-</span><span class="n">zxvf</span><span class="w"> </span><span class="n">fio</span><span class="o">-</span><span class="mf">2.2.5</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span><span class="w"></span>
<span class="n">cd</span><span class="w"> </span><span class="n">fio</span><span class="o">-</span><span class="mf">2.2.5</span><span class="w"></span>
<span class="n">make</span><span class="w"></span>
<span class="n">make</span><span class="w"> </span><span class="n">install</span><span class="w"></span>
<span class="n">二</span><span class="err">、</span><span class="n">FIO用法</span><span class="err">：</span><span class="w"></span>
<span class="n">随机读</span><span class="err">：</span><span class="p">(</span><span class="n">可直接用</span><span class="err">，</span><span class="n">向磁盘写一个2G文件</span><span class="err">，</span><span class="mi">10</span><span class="n">线程</span><span class="err">，</span><span class="n">随机读1分钟</span><span class="err">，</span><span class="n">给出结果</span><span class="p">)</span><span class="w"></span>

<span class="n">fio</span><span class="w"> </span><span class="o">-</span><span class="n">filename</span><span class="o">=/</span><span class="n">tmp</span><span class="o">/</span><span class="n">test_randread</span><span class="w"> </span><span class="o">-</span><span class="n">direct</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="n">iodepth</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="n">thread</span><span class="w"> </span><span class="o">-</span><span class="n">rw</span><span class="o">=</span><span class="n">randread</span><span class="w"> </span><span class="o">-</span><span class="n">ioengine</span><span class="o">=</span><span class="n">psync</span><span class="w"> </span><span class="o">-</span><span class="n">bs</span><span class="o">=</span><span class="mi">16</span><span class="n">k</span><span class="w"> </span><span class="o">-</span><span class="k">size</span><span class="o">=</span><span class="mi">2</span><span class="n">G</span><span class="w"></span>
<span class="o">-</span><span class="n">numjobs</span><span class="o">=</span><span class="mi">10</span><span class="w"> </span><span class="o">-</span><span class="n">runtime</span><span class="o">=</span><span class="mi">60</span><span class="w"> </span><span class="o">-</span><span class="n">group_reporting</span><span class="w"> </span><span class="o">-</span><span class="n">name</span><span class="o">=</span><span class="n">mytest</span><span class="w"></span>
<span class="n">说明</span><span class="err">：</span><span class="w"></span>
<span class="n">filename</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdb1</span><span class="w"> </span><span class="n">测试文件名称</span><span class="err">，</span><span class="n">通常选择需要测试的盘的data目录</span><span class="err">。</span><span class="w"></span>
<span class="n">direct</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="n">测试过程绕过机器自带的buffer</span><span class="err">。</span><span class="n">使测试结果更真实</span><span class="err">。</span><span class="w"></span>
<span class="n">rw</span><span class="o">=</span><span class="n">randwrite</span><span class="w"> </span><span class="n">测试随机写的I</span><span class="o">/</span><span class="n">O</span><span class="w"></span>
<span class="n">rw</span><span class="o">=</span><span class="n">randrw</span><span class="w"> </span><span class="n">测试随机写和读的I</span><span class="o">/</span><span class="n">O</span><span class="w"></span>
<span class="n">bs</span><span class="o">=</span><span class="mi">16</span><span class="n">k</span><span class="w"> </span><span class="n">单次io的块文件大小为16k</span><span class="w"></span>
<span class="n">bsrange</span><span class="o">=</span><span class="mi">512</span><span class="o">-</span><span class="mi">2048</span><span class="w"> </span><span class="n">同上</span><span class="err">，</span><span class="n">提定数据块的大小范围</span><span class="w"></span>
<span class="k">size</span><span class="o">=</span><span class="mi">5</span><span class="n">g</span><span class="w"> </span><span class="n">本次的测试文件大小为5g</span><span class="err">，</span><span class="n">以每次4k的io进行测试</span><span class="err">。</span><span class="w"></span>
<span class="n">numjobs</span><span class="o">=</span><span class="mi">30</span><span class="w"> </span><span class="n">本次的测试线程为30</span><span class="p">.</span><span class="w"></span>
<span class="n">runtime</span><span class="o">=</span><span class="mi">1000</span><span class="w"> </span><span class="n">测试时间为1000秒</span><span class="err">，</span><span class="n">如果不写则一直将5g文件分4k每次写完为止</span><span class="err">。</span><span class="w"></span>
<span class="n">ioengine</span><span class="o">=</span><span class="n">psync</span><span class="w"> </span><span class="n">io引擎使用pync方式</span><span class="w"></span>
<span class="n">rwmixwrite</span><span class="o">=</span><span class="mi">30</span><span class="w"> </span><span class="n">在混合读写的模式下</span><span class="err">，</span><span class="n">写占30</span><span class="o">%</span><span class="w"></span>
<span class="n">group_reporting</span><span class="w"> </span><span class="n">关于显示结果的</span><span class="err">，</span><span class="n">汇总每个进程的信息</span><span class="err">。</span><span class="w"></span>

<span class="n">此外</span><span class="w"></span>
<span class="n">lockmem</span><span class="o">=</span><span class="mi">1</span><span class="n">g</span><span class="w"> </span><span class="n">只使用1g内存进行测试</span><span class="err">。</span><span class="w"></span>
<span class="n">zero_buffers</span><span class="w"> </span><span class="n">用0初始化系统buffer</span><span class="err">。</span><span class="w"></span>
<span class="n">nrfiles</span><span class="o">=</span><span class="mi">8</span><span class="w"> </span><span class="n">每个进程生成文件的数量</span><span class="err">。</span><span class="w"></span>

<span class="k">read</span><span class="w"> </span><span class="n">顺序读</span><span class="w"></span>
<span class="k">write</span><span class="w"> </span><span class="n">顺序写</span><span class="w"></span>
<span class="n">rw</span><span class="p">,</span><span class="n">readwrite</span><span class="w"> </span><span class="n">顺序混合读写</span><span class="w"></span>

<span class="n">randwrite</span><span class="w"> </span><span class="n">随机写</span><span class="w"></span>
<span class="n">randread</span><span class="w"> </span><span class="n">随机读</span><span class="w"></span>
<span class="n">randrw</span><span class="w"> </span><span class="n">随机混合读写</span><span class="w"></span>

<span class="n">io总的输入输出量</span><span class="w"></span>
<span class="n">bw</span><span class="err">：</span><span class="n">带宽</span><span class="w"> </span><span class="n">KB</span><span class="o">/</span><span class="n">s</span><span class="w"></span>
<span class="n">iops</span><span class="err">：</span><span class="n">每秒钟的IO数</span><span class="w"></span>
<span class="n">runt</span><span class="err">：</span><span class="n">总运行时间</span><span class="w"></span>
<span class="n">lat</span><span class="w"> </span><span class="p">(</span><span class="n">msec</span><span class="p">)</span><span class="err">：</span><span class="n">延迟</span><span class="p">(</span><span class="n">毫秒</span><span class="p">)</span><span class="w"></span>
<span class="n">msec</span><span class="err">：</span><span class="w"> </span><span class="n">毫秒</span><span class="w"></span>

<span class="n">usec</span><span class="err">：</span><span class="w"> </span><span class="n">微秒</span><span class="w"></span>

<span class="n">顺序读</span><span class="err">：</span><span class="w"></span>

<span class="n">fio</span><span class="w"> </span><span class="o">-</span><span class="n">filename</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdb1</span><span class="w"> </span><span class="o">-</span><span class="n">direct</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="n">iodepth</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="n">thread</span><span class="w"> </span><span class="o">-</span><span class="n">rw</span><span class="o">=</span><span class="k">read</span><span class="w"> </span><span class="o">-</span><span class="n">ioengine</span><span class="o">=</span><span class="n">psync</span><span class="w"> </span><span class="o">-</span><span class="n">bs</span><span class="o">=</span><span class="mi">16</span><span class="n">k</span><span class="w"> </span><span class="o">-</span><span class="k">size</span><span class="o">=</span><span class="mi">2</span><span class="n">G</span><span class="w"> </span><span class="o">-</span><span class="n">numjobs</span><span class="o">=</span><span class="mi">10</span><span class="w"></span>
<span class="o">-</span><span class="n">runtime</span><span class="o">=</span><span class="mi">60</span><span class="w"> </span><span class="o">-</span><span class="n">group_reporting</span><span class="w"> </span><span class="o">-</span><span class="n">name</span><span class="o">=</span><span class="n">mytest</span><span class="w"></span>
<span class="n">随机写</span><span class="err">：</span><span class="w"></span>

<span class="n">fio</span><span class="w"> </span><span class="o">-</span><span class="n">filename</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdb1</span><span class="w"> </span><span class="o">-</span><span class="n">direct</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="n">iodepth</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="n">thread</span><span class="w"> </span><span class="o">-</span><span class="n">rw</span><span class="o">=</span><span class="n">randwrite</span><span class="w"> </span><span class="o">-</span><span class="n">ioengine</span><span class="o">=</span><span class="n">psync</span><span class="w"> </span><span class="o">-</span><span class="n">bs</span><span class="o">=</span><span class="mi">16</span><span class="n">k</span><span class="w"> </span><span class="o">-</span><span class="k">size</span><span class="o">=</span><span class="mi">2</span><span class="n">G</span><span class="w"> </span><span class="o">-</span><span class="n">numjobs</span><span class="o">=</span><span class="mi">10</span><span class="w"></span>
<span class="o">-</span><span class="n">runtime</span><span class="o">=</span><span class="mi">60</span><span class="w"> </span><span class="o">-</span><span class="n">group_reporting</span><span class="w"> </span><span class="o">-</span><span class="n">name</span><span class="o">=</span><span class="n">mytest</span><span class="w"></span>
<span class="n">顺序写</span><span class="err">：</span><span class="w"></span>

<span class="n">fio</span><span class="w"> </span><span class="o">-</span><span class="n">filename</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdb1</span><span class="w"> </span><span class="o">-</span><span class="n">direct</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="n">iodepth</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="n">thread</span><span class="w"> </span><span class="o">-</span><span class="n">rw</span><span class="o">=</span><span class="k">write</span><span class="w"> </span><span class="o">-</span><span class="n">ioengine</span><span class="o">=</span><span class="n">psync</span><span class="w"> </span><span class="o">-</span><span class="n">bs</span><span class="o">=</span><span class="mi">16</span><span class="n">k</span><span class="w"> </span><span class="o">-</span><span class="k">size</span><span class="o">=</span><span class="mi">2</span><span class="n">G</span><span class="w"> </span><span class="o">-</span><span class="n">numjobs</span><span class="o">=</span><span class="mi">10</span><span class="w"></span>
<span class="o">-</span><span class="n">runtime</span><span class="o">=</span><span class="mi">60</span><span class="w"> </span><span class="o">-</span><span class="n">group_reporting</span><span class="w"> </span><span class="o">-</span><span class="n">name</span><span class="o">=</span><span class="n">mytest</span><span class="w"></span>
<span class="n">混合随机读写</span><span class="err">：</span><span class="w"></span>

<span class="n">fio</span><span class="w"> </span><span class="o">-</span><span class="n">filename</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdb1</span><span class="w"> </span><span class="o">-</span><span class="n">direct</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="n">iodepth</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="n">thread</span><span class="w"> </span><span class="o">-</span><span class="n">rw</span><span class="o">=</span><span class="n">randrw</span><span class="w"> </span><span class="o">-</span><span class="n">rwmixread</span><span class="o">=</span><span class="mi">70</span><span class="w"> </span><span class="o">-</span><span class="n">ioengine</span><span class="o">=</span><span class="n">psync</span><span class="w"> </span><span class="o">-</span><span class="n">bs</span><span class="o">=</span><span class="mi">16</span><span class="n">k</span><span class="w"> </span><span class="o">-</span><span class="k">size</span><span class="o">=</span><span class="mi">2</span><span class="n">G</span><span class="w"></span>
<span class="o">-</span><span class="n">numjobs</span><span class="o">=</span><span class="mi">10</span><span class="w"> </span><span class="o">-</span><span class="n">runtime</span><span class="o">=</span><span class="mi">60</span><span class="w"> </span><span class="o">-</span><span class="n">group_reporting</span><span class="w"> </span><span class="o">-</span><span class="n">name</span><span class="o">=</span><span class="n">mytest</span><span class="w"> </span><span class="o">-</span><span class="n">ioscheduler</span><span class="o">=</span><span class="n">noop</span><span class="w"></span>
<span class="n">三</span><span class="err">，</span><span class="n">实际测试范例</span><span class="err">：</span><span class="w"></span>

<span class="o">[</span><span class="n">root@localhost ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">fio</span><span class="w"> </span><span class="o">-</span><span class="n">filename</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdb1</span><span class="w"> </span><span class="o">-</span><span class="n">direct</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="n">iodepth</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="n">thread</span><span class="w"> </span><span class="o">-</span><span class="n">rw</span><span class="o">=</span><span class="n">randrw</span><span class="w"> </span><span class="o">-</span><span class="n">rwmixread</span><span class="o">=</span><span class="mi">70</span><span class="w"> </span><span class="o">-</span><span class="n">ioengine</span><span class="o">=</span><span class="n">psync</span><span class="w"> </span>
<span class="o">-</span><span class="n">bs</span><span class="o">=</span><span class="mi">16</span><span class="n">k</span><span class="w"> </span><span class="o">-</span><span class="k">size</span><span class="o">=</span><span class="mi">200</span><span class="n">G</span><span class="w"> </span><span class="o">-</span><span class="n">numjobs</span><span class="o">=</span><span class="mi">30</span><span class="w"> </span><span class="o">-</span><span class="n">runtime</span><span class="o">=</span><span class="mi">100</span><span class="w"> </span><span class="o">-</span><span class="n">group_reporting</span><span class="w"> </span><span class="o">-</span><span class="n">name</span><span class="o">=</span><span class="n">mytest1</span><span class="w"></span>
<span class="nl">mytest1</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">g</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="err">:</span><span class="w"> </span><span class="n">rw</span><span class="o">=</span><span class="n">randrw</span><span class="p">,</span><span class="w"> </span><span class="n">bs</span><span class="o">=</span><span class="mi">16</span><span class="n">K</span><span class="o">-</span><span class="mi">16</span><span class="n">K</span><span class="o">/</span><span class="mi">16</span><span class="n">K</span><span class="o">-</span><span class="mi">16</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">ioengine</span><span class="o">=</span><span class="n">psync</span><span class="p">,</span><span class="w"> </span><span class="n">iodepth</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="err">…</span><span class="w"></span>
<span class="nl">mytest1</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">g</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="err">:</span><span class="w"> </span><span class="n">rw</span><span class="o">=</span><span class="n">randrw</span><span class="p">,</span><span class="w"> </span><span class="n">bs</span><span class="o">=</span><span class="mi">16</span><span class="n">K</span><span class="o">-</span><span class="mi">16</span><span class="n">K</span><span class="o">/</span><span class="mi">16</span><span class="n">K</span><span class="o">-</span><span class="mi">16</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">ioengine</span><span class="o">=</span><span class="n">psync</span><span class="p">,</span><span class="w"> </span><span class="n">iodepth</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="n">fio</span><span class="w"> </span><span class="mf">2.0.7</span><span class="w"></span>
<span class="n">Starting</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="n">threads</span><span class="w"></span>
<span class="nl">Jobs</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="err">:</span><span class="w"> </span><span class="o">[</span><span class="n">________________m_____________</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">3.5% done</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">6935K/3116K /s</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">423 /190 iops</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">eta 48m:20s</span><span class="o">]</span><span class="w"> </span><span class="n">s</span><span class="err">]</span><span class="w"></span>
<span class="nl">mytest1</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">groupid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">jobs</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span><span class="err">:</span><span class="w"> </span><span class="n">err</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="err">:</span><span class="w"> </span><span class="n">pid</span><span class="o">=</span><span class="mi">23802</span><span class="w"></span>
<span class="k">read</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="n">io</span><span class="o">=</span><span class="mf">1853.4</span><span class="n">MB</span><span class="p">,</span><span class="w"> </span><span class="n">bw</span><span class="o">=</span><span class="mi">18967</span><span class="n">KB</span><span class="o">/</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">iops</span><span class="o">=</span><span class="mi">1185</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">runt</span><span class="o">=</span><span class="mi">100058</span><span class="n">msec</span><span class="w"></span>
<span class="n">clat</span><span class="w"> </span><span class="p">(</span><span class="n">usec</span><span class="p">)</span><span class="err">:</span><span class="w"> </span><span class="nf">min</span><span class="o">=</span><span class="mi">60</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nf">max</span><span class="o">=</span><span class="mi">871116</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nf">avg</span><span class="o">=</span><span class="mf">25227.91</span><span class="p">,</span><span class="w"> </span><span class="nf">stdev</span><span class="o">=</span><span class="mf">31653.46</span><span class="w"></span>
<span class="n">lat</span><span class="w"> </span><span class="p">(</span><span class="n">usec</span><span class="p">)</span><span class="err">:</span><span class="w"> </span><span class="nf">min</span><span class="o">=</span><span class="mi">60</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nf">max</span><span class="o">=</span><span class="mi">871117</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nf">avg</span><span class="o">=</span><span class="mf">25228.08</span><span class="p">,</span><span class="w"> </span><span class="nf">stdev</span><span class="o">=</span><span class="mf">31653.46</span><span class="w"></span>
<span class="n">clat</span><span class="w"> </span><span class="n">percentiles</span><span class="w"> </span><span class="p">(</span><span class="n">msec</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="mf">1.00</span><span class="n">th</span><span class="o">=[</span><span class="n"> 3</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="mf">5.00</span><span class="n">th</span><span class="o">=[</span><span class="n"> 5</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="mf">10.00</span><span class="n">th</span><span class="o">=[</span><span class="n"> 6</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="mf">20.00</span><span class="n">th</span><span class="o">=[</span><span class="n"> 8</span><span class="o">]</span><span class="p">,</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="mf">30.00</span><span class="n">th</span><span class="o">=[</span><span class="n"> 10</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="mf">40.00</span><span class="n">th</span><span class="o">=[</span><span class="n"> 12</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="mf">50.00</span><span class="n">th</span><span class="o">=[</span><span class="n"> 15</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="mf">60.00</span><span class="n">th</span><span class="o">=[</span><span class="n"> 19</span><span class="o">]</span><span class="p">,</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="mf">70.00</span><span class="n">th</span><span class="o">=[</span><span class="n"> 26</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="mf">80.00</span><span class="n">th</span><span class="o">=[</span><span class="n"> 37</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="mf">90.00</span><span class="n">th</span><span class="o">=[</span><span class="n"> 57</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="mf">95.00</span><span class="n">th</span><span class="o">=[</span><span class="n"> 79</span><span class="o">]</span><span class="p">,</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="mf">99.00</span><span class="n">th</span><span class="o">=[</span><span class="n"> 151</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="mf">99.50</span><span class="n">th</span><span class="o">=[</span><span class="n"> 202</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="mf">99.90</span><span class="n">th</span><span class="o">=[</span><span class="n"> 338</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="mf">99.95</span><span class="n">th</span><span class="o">=[</span><span class="n"> 383</span><span class="o">]</span><span class="p">,</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="mf">99.99</span><span class="n">th</span><span class="o">=[</span><span class="n"> 523</span><span class="o">]</span><span class="w"></span>
<span class="n">bw</span><span class="w"> </span><span class="p">(</span><span class="n">KB</span><span class="o">/</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="nf">min</span><span class="o">=</span><span class="w"> </span><span class="mi">26</span><span class="p">,</span><span class="w"> </span><span class="nf">max</span><span class="o">=</span><span class="w"> </span><span class="mi">1944</span><span class="p">,</span><span class="w"> </span><span class="n">per</span><span class="o">=</span><span class="mf">3.36</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="nf">avg</span><span class="o">=</span><span class="mf">636.84</span><span class="p">,</span><span class="w"> </span><span class="nf">stdev</span><span class="o">=</span><span class="mf">189.15</span><span class="w"></span>
<span class="k">write</span><span class="err">:</span><span class="w"> </span><span class="n">io</span><span class="o">=</span><span class="mi">803600</span><span class="n">KB</span><span class="p">,</span><span class="w"> </span><span class="n">bw</span><span class="o">=</span><span class="mf">8031.4</span><span class="n">KB</span><span class="o">/</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">iops</span><span class="o">=</span><span class="mi">501</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">runt</span><span class="o">=</span><span class="mi">100058</span><span class="n">msec</span><span class="w"></span>
<span class="n">clat</span><span class="w"> </span><span class="p">(</span><span class="n">usec</span><span class="p">)</span><span class="err">:</span><span class="w"> </span><span class="nf">min</span><span class="o">=</span><span class="mi">52</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nf">max</span><span class="o">=</span><span class="mi">9302</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nf">avg</span><span class="o">=</span><span class="mf">146.25</span><span class="p">,</span><span class="w"> </span><span class="nf">stdev</span><span class="o">=</span><span class="mf">299.17</span><span class="w"></span>
<span class="n">lat</span><span class="w"> </span><span class="p">(</span><span class="n">usec</span><span class="p">)</span><span class="err">:</span><span class="w"> </span><span class="nf">min</span><span class="o">=</span><span class="mi">52</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nf">max</span><span class="o">=</span><span class="mi">9303</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nf">avg</span><span class="o">=</span><span class="mf">147.19</span><span class="p">,</span><span class="w"> </span><span class="nf">stdev</span><span class="o">=</span><span class="mf">299.17</span><span class="w"></span>
<span class="n">clat</span><span class="w"> </span><span class="n">percentiles</span><span class="w"> </span><span class="p">(</span><span class="n">usec</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="mf">1.00</span><span class="n">th</span><span class="o">=[</span><span class="n"> 62</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="mf">5.00</span><span class="n">th</span><span class="o">=[</span><span class="n"> 65</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="mf">10.00</span><span class="n">th</span><span class="o">=[</span><span class="n"> 68</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="mf">20.00</span><span class="n">th</span><span class="o">=[</span><span class="n"> 74</span><span class="o">]</span><span class="p">,</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="mf">30.00</span><span class="n">th</span><span class="o">=[</span><span class="n"> 84</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="mf">40.00</span><span class="n">th</span><span class="o">=[</span><span class="n"> 87</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="mf">50.00</span><span class="n">th</span><span class="o">=[</span><span class="n"> 89</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="mf">60.00</span><span class="n">th</span><span class="o">=[</span><span class="n"> 90</span><span class="o">]</span><span class="p">,</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="mf">70.00</span><span class="n">th</span><span class="o">=[</span><span class="n"> 92</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="mf">80.00</span><span class="n">th</span><span class="o">=[</span><span class="n"> 97</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="mf">90.00</span><span class="n">th</span><span class="o">=[</span><span class="n"> 120</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="mf">95.00</span><span class="n">th</span><span class="o">=[</span><span class="n"> 370</span><span class="o">]</span><span class="p">,</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="mf">99.00</span><span class="n">th</span><span class="o">=[</span><span class="n"> 1688</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="mf">99.50</span><span class="n">th</span><span class="o">=[</span><span class="n"> 2128</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="mf">99.90</span><span class="n">th</span><span class="o">=[</span><span class="n"> 3088</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="mf">99.95</span><span class="n">th</span><span class="o">=[</span><span class="n"> 3696</span><span class="o">]</span><span class="p">,</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="mf">99.99</span><span class="n">th</span><span class="o">=[</span><span class="n"> 5216</span><span class="o">]</span><span class="w"></span>
<span class="n">bw</span><span class="w"> </span><span class="p">(</span><span class="n">KB</span><span class="o">/</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="nf">min</span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="nf">max</span><span class="o">=</span><span class="w"> </span><span class="mi">1117</span><span class="p">,</span><span class="w"> </span><span class="n">per</span><span class="o">=</span><span class="mf">3.37</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="nf">avg</span><span class="o">=</span><span class="mf">270.27</span><span class="p">,</span><span class="w"> </span><span class="nf">stdev</span><span class="o">=</span><span class="mf">133.27</span><span class="w"></span>
<span class="n">lat</span><span class="w"> </span><span class="p">(</span><span class="n">usec</span><span class="p">)</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="mi">100</span><span class="o">=</span><span class="mf">24.32</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="mi">250</span><span class="o">=</span><span class="mf">3.83</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="mi">500</span><span class="o">=</span><span class="mf">0.33</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="mi">750</span><span class="o">=</span><span class="mf">0.28</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="o">=</span><span class="mf">0.27</span><span class="o">%</span><span class="w"></span>
<span class="n">lat</span><span class="w"> </span><span class="p">(</span><span class="n">msec</span><span class="p">)</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="mi">2</span><span class="o">=</span><span class="mf">0.64</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="o">=</span><span class="mf">3.08</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="o">=</span><span class="mf">20.67</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="o">=</span><span class="mf">19.90</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="o">=</span><span class="mf">17.91</span><span class="o">%</span><span class="w"></span>
<span class="n">lat</span><span class="w"> </span><span class="p">(</span><span class="n">msec</span><span class="p">)</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="mi">100</span><span class="o">=</span><span class="mf">6.87</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="mi">250</span><span class="o">=</span><span class="mf">1.70</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="mi">500</span><span class="o">=</span><span class="mf">0.19</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="mi">750</span><span class="o">=</span><span class="mf">0.01</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="o">=</span><span class="mf">0.01</span><span class="o">%</span><span class="w"></span>
<span class="n">cpu</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="n">usr</span><span class="o">=</span><span class="mf">1.70</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="n">sys</span><span class="o">=</span><span class="mf">2.41</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="o">=</span><span class="mi">5237835</span><span class="p">,</span><span class="w"> </span><span class="n">majf</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">minf</span><span class="o">=</span><span class="mi">6344162</span><span class="w"></span>
<span class="n">IO</span><span class="w"> </span><span class="n">depths</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="mi">1</span><span class="o">=</span><span class="mf">100.0</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">=</span><span class="mf">0.0</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="o">=</span><span class="mf">0.0</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">=</span><span class="mf">0.0</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="o">=</span><span class="mf">0.0</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="o">=</span><span class="mf">0.0</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="o">&gt;=</span><span class="mi">64</span><span class="o">=</span><span class="mf">0.0</span><span class="o">%</span><span class="w"></span>
<span class="n">submit</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="mi">0</span><span class="o">=</span><span class="mf">0.0</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="o">=</span><span class="mf">100.0</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">=</span><span class="mf">0.0</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="o">=</span><span class="mf">0.0</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="o">=</span><span class="mf">0.0</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="o">=</span><span class="mf">0.0</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="o">&gt;=</span><span class="mi">64</span><span class="o">=</span><span class="mf">0.0</span><span class="o">%</span><span class="w"></span>
<span class="n">complete</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="mi">0</span><span class="o">=</span><span class="mf">0.0</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="o">=</span><span class="mf">100.0</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">=</span><span class="mf">0.0</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="o">=</span><span class="mf">0.0</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="o">=</span><span class="mf">0.0</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="o">=</span><span class="mf">0.0</span><span class="o">%</span><span class="p">,</span><span class="w"> </span><span class="o">&gt;=</span><span class="mi">64</span><span class="o">=</span><span class="mf">0.0</span><span class="o">%</span><span class="w"></span>
<span class="n">issued</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="n">total</span><span class="o">=</span><span class="n">r</span><span class="o">=</span><span class="mi">118612</span><span class="o">/</span><span class="n">w</span><span class="o">=</span><span class="mi">50225</span><span class="o">/</span><span class="n">d</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">short</span><span class="o">=</span><span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="o">/</span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="o">/</span><span class="n">d</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="n">Run</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="ow">all</span><span class="w"> </span><span class="n">jobs</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="k">READ</span><span class="err">:</span><span class="w"> </span><span class="n">io</span><span class="o">=</span><span class="mf">1853.4</span><span class="n">MB</span><span class="p">,</span><span class="w"> </span><span class="n">aggrb</span><span class="o">=</span><span class="mi">18966</span><span class="n">KB</span><span class="o">/</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">minb</span><span class="o">=</span><span class="mi">18966</span><span class="n">KB</span><span class="o">/</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">maxb</span><span class="o">=</span><span class="mi">18966</span><span class="n">KB</span><span class="o">/</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">mint</span><span class="o">=</span><span class="mi">100058</span><span class="n">msec</span><span class="p">,</span><span class="w"> </span><span class="n">maxt</span><span class="o">=</span><span class="mi">100058</span><span class="n">msec</span><span class="w"></span>
<span class="k">WRITE</span><span class="err">:</span><span class="w"> </span><span class="n">io</span><span class="o">=</span><span class="mi">803600</span><span class="n">KB</span><span class="p">,</span><span class="w"> </span><span class="n">aggrb</span><span class="o">=</span><span class="mi">8031</span><span class="n">KB</span><span class="o">/</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">minb</span><span class="o">=</span><span class="mi">8031</span><span class="n">KB</span><span class="o">/</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">maxb</span><span class="o">=</span><span class="mi">8031</span><span class="n">KB</span><span class="o">/</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">mint</span><span class="o">=</span><span class="mi">100058</span><span class="n">msec</span><span class="p">,</span><span class="w"> </span><span class="n">maxt</span><span class="o">=</span><span class="mi">100058</span><span class="n">msec</span><span class="w"></span>
<span class="k">Disk</span><span class="w"> </span><span class="n">stats</span><span class="w"> </span><span class="p">(</span><span class="k">read</span><span class="o">/</span><span class="k">write</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="nl">sdb</span><span class="p">:</span><span class="w"> </span><span class="n">ios</span><span class="o">=</span><span class="mi">118610</span><span class="o">/</span><span class="mi">50224</span><span class="p">,</span><span class="w"> </span><span class="k">merge</span><span class="o">=</span><span class="mi">0</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ticks</span><span class="o">=</span><span class="mi">2991317</span><span class="o">/</span><span class="mi">6860</span><span class="p">,</span><span class="w"> </span><span class="n">in_queue</span><span class="o">=</span><span class="mi">2998169</span><span class="p">,</span><span class="w"> </span><span class="n">util</span><span class="o">=</span><span class="mf">99.77</span><span class="o">%</span><span class="w"></span>
<span class="n">主要查看以上红色字体部分的iop</span><span class="w"></span>
</pre></div>


<h2 id="vsftp">vsftp</h2>
<div class="codehilite"><pre><span></span><span class="n">目录权限不能为777</span><span class="err">，</span><span class="n">否则无法登录</span><span class="err">，</span><span class="n">配置文件每行末尾不要又空格</span><span class="w"></span>

<span class="n">默认兼容主动和被动模式</span><span class="err">，</span><span class="n">添加配置限制被动模式端口</span><span class="w">   </span><span class="n">FlashFXP可以看到被动模式端口</span><span class="w"></span>
<span class="n">#connect_from_port_20</span><span class="o">=</span><span class="n">YES</span><span class="w"> </span><span class="n">注释这行</span><span class="w"></span>
<span class="n">pasv_enable</span><span class="o">=</span><span class="n">YES</span><span class="w"></span>
<span class="n">pasv_promiscuous</span><span class="o">=</span><span class="n">YES</span><span class="w"></span>
<span class="n">pasv_min_port</span><span class="o">=</span><span class="mi">3000</span><span class="w"></span>
<span class="n">pasv_max_port</span><span class="o">=</span><span class="mi">3500</span><span class="w"></span>


<span class="n">从2</span><span class="mf">.3.5</span><span class="n">之后</span><span class="err">，</span><span class="n">vsftpd增强了安全检查</span><span class="err">，</span><span class="n">如果用户被限定在了其主目录下</span><span class="err">，</span><span class="n">则该用户的主目录不能再具有写权限了</span><span class="w"> </span><span class="n">allow_writeable_chroot</span><span class="o">=</span><span class="n">YES</span><span class="w"> </span><span class="n">可以取消这个限制</span><span class="w"></span>
<span class="n">通过如下命令行可以解决</span><span class="w">  </span><span class="n">chmod</span><span class="w"> </span><span class="n">a</span><span class="o">-</span><span class="n">w</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="k">user</span><span class="w"></span>
<span class="n">chroot_local_user</span><span class="o">=</span><span class="n">YES</span><span class="w">   </span><span class="n">限定在主目录</span><span class="w"></span>
<span class="n">chroot_list_enable</span><span class="o">=</span><span class="n">YES</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="p">(</span><span class="k">default</span><span class="w"> </span><span class="n">follows</span><span class="p">)</span><span class="w"></span>
<span class="n">#chroot_list_file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">vsftpd</span><span class="o">/</span><span class="n">chroot_list</span><span class="w">    </span><span class="n">这些用户作为</span><span class="err">“</span><span class="n">例外</span><span class="err">”，</span><span class="n">不受限制</span><span class="w"></span>


<span class="n">yum</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">vsftpd</span><span class="w"> </span><span class="n">curlftpfs</span><span class="w"></span>
<span class="n">ftp的配置文件主要有三个</span><span class="err">，</span><span class="n">位于</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">vsftpd</span><span class="o">/</span><span class="n">目录下</span><span class="err">，</span><span class="n">分别是</span><span class="err">：</span><span class="w"></span>
<span class="n">ftpusers</span><span class="w">    </span><span class="n">该文件用来指定那些用户不能访问ftp服务器</span><span class="err">。</span><span class="w"></span>
<span class="n">user_list</span><span class="w">   </span><span class="n">该文件用来指示的默认账户在默认情况下也不能访问ftp</span><span class="p">.</span><span class="w"></span>
<span class="n">vsftpd</span><span class="p">.</span><span class="n">conf</span><span class="w">   </span><span class="n">vsftpd的主配置文件</span><span class="p">.</span><span class="w"></span>
<span class="n">ftpusers和user_list用来控制登录用户</span><span class="err">。</span><span class="w"></span>
<span class="n">ftpusers文件中的内容不受任何配制项的影响</span><span class="err">，</span><span class="n">总是有效</span><span class="err">，</span><span class="n">是一个黑名单</span><span class="err">！</span><span class="w"></span>

<span class="n">更新虚拟用户数据</span><span class="w"></span>
<span class="n">db_load</span><span class="w"> </span><span class="o">-</span><span class="n">T</span><span class="w"> </span><span class="o">-</span><span class="n">t</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">vsftpd</span><span class="o">/</span><span class="n">vftpuser</span><span class="p">.</span><span class="n">txt</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">vsftpd</span><span class="o">/</span><span class="n">vu_list</span><span class="p">.</span><span class="n">db</span><span class="w"> </span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">vsftpd</span><span class="w"> </span><span class="n">restart</span><span class="w"></span>


<span class="n">vsftpd</span><span class="p">.</span><span class="n">conf中常用的配置内容</span><span class="err">：</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span><span class="err">、</span><span class="n">匿名用户能否上传和写文件</span><span class="err">，</span><span class="n">一般配置为NO</span><span class="w"></span>
<span class="w">    </span><span class="n">anon_upload_enable</span><span class="o">=</span><span class="k">NO</span><span class="w"></span>
<span class="w">    </span><span class="n">anon_mkdir_write_enable</span><span class="o">=</span><span class="k">NO</span><span class="w"></span>
<span class="w">    </span><span class="n">匿名用户能否登录</span><span class="err">，</span><span class="n">视情况而定</span><span class="err">，</span><span class="n">看是否是专有用户使用</span><span class="err">。</span><span class="w"></span>
<span class="w">    </span><span class="n">anonymous_enable</span><span class="o">=</span><span class="k">NO</span><span class="w"></span>
<span class="w">    </span><span class="mi">2</span><span class="err">、</span><span class="n">端口设定</span><span class="w"></span>
<span class="w">    </span><span class="n">port_enable</span><span class="o">=</span><span class="n">YES</span><span class="err">，</span><span class="n">即默认情况下</span><span class="err">，</span><span class="n">FTP</span><span class="w">  </span><span class="n">PORT主动模式被启用</span><span class="w"></span>
<span class="w">    </span><span class="n">connect_from_port_20</span><span class="o">=</span><span class="n">YES</span><span class="err">，</span><span class="n">即默认情况下</span><span class="err">，</span><span class="n">FTP</span><span class="w"> </span><span class="n">PORT主动模式进行数据传输时使用20端口</span><span class="p">(</span><span class="n">ftp</span><span class="o">-</span><span class="k">data</span><span class="p">)</span><span class="err">。</span><span class="n">YES使用</span><span class="err">，</span><span class="n">NO不使用</span><span class="err">。</span><span class="w"></span>
<span class="w">    </span><span class="n">ftp_data_port</span><span class="o">=</span><span class="n">port</span><span class="w"> </span><span class="n">number</span><span class="err">，</span><span class="n">设定ftp数据传输端口</span><span class="p">(</span><span class="n">ftp</span><span class="o">-</span><span class="k">data</span><span class="p">)</span><span class="n">值</span><span class="err">。</span><span class="n">默认值为20</span><span class="err">。</span><span class="n">此参数用于PORT</span><span class="w"> </span><span class="n">FTP模式</span><span class="err">。</span><span class="w"></span>
<span class="w">    </span><span class="mi">3</span><span class="err">、</span><span class="n">通信编码模式</span><span class="w"></span>
<span class="w">    </span><span class="n">默认情况下可以通过ascii模式传输</span><span class="err">。</span><span class="n">将配置改为NO后</span><span class="err">，</span><span class="n">只能通过binary形式传输</span><span class="err">。</span><span class="w"></span>
<span class="w">    </span><span class="n">ascii_upload_enable</span><span class="o">=</span><span class="n">YES</span><span class="w"></span>
<span class="w">    </span><span class="n">ascii_download_enable</span><span class="o">=</span><span class="n">YES</span><span class="w"></span>



<span class="n">匿名</span><span class="w"></span>
<span class="n">默认匿名共享目录</span><span class="w"> </span><span class="o">/</span><span class="nf">var</span><span class="o">/</span><span class="n">ftp</span><span class="w"></span>
<span class="n">指定匿名共享目录</span><span class="w"> </span><span class="n">anon_root</span><span class="o">=/</span><span class="k">data</span><span class="o">/</span><span class="mi">3</span><span class="n">mang_apps</span><span class="err">（</span><span class="n">目录权限不能为777</span><span class="err">，</span><span class="n">否则无法登录</span><span class="err">）</span><span class="w"></span>

<span class="n">vim</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">vsftpd</span><span class="o">/</span><span class="n">vsftpd</span><span class="p">.</span><span class="n">conf</span><span class="w"></span>
<span class="n">anonymous_enable</span><span class="o">=</span><span class="n">YES</span><span class="w">    </span><span class="n">允许匿名用户</span><span class="w"></span>
<span class="n">local_enable</span><span class="o">=</span><span class="n">YES</span><span class="w">                </span><span class="n">允许本地用户登陆</span><span class="w"></span>
<span class="n">anon_world_readable_only</span><span class="o">=</span><span class="n">YES</span><span class="w">  </span><span class="n">匿名只读</span><span class="w"></span>
<span class="n">或</span><span class="w"></span>
<span class="n">anon_other_write_enable</span><span class="o">=</span><span class="n">YES</span><span class="w">  </span><span class="n">匿名可写</span><span class="w"></span>
<span class="n">anon_upload_enable</span><span class="o">=</span><span class="n">YES</span><span class="w">            </span><span class="n">匿名可上传</span><span class="w"></span>
<span class="n">anon_mkdir_write_enable</span><span class="o">=</span><span class="n">YES</span><span class="w">    </span><span class="n">匿名可以创建目录</span><span class="w"></span>
<span class="n">local_max_rate</span><span class="o">=</span><span class="mi">1000000</span><span class="c1">--------------1M    限制上传下载的速度</span>

<span class="n">日志相关</span><span class="w"></span>
<span class="n">xferlog_enable</span><span class="o">=</span><span class="n">YES</span><span class="w"></span>
<span class="n">xferlog_std_format</span><span class="o">=</span><span class="n">YES</span><span class="w"></span>
<span class="n">xferlog_file</span><span class="o">=/</span><span class="nf">var</span><span class="o">/</span><span class="nf">log</span><span class="o">/</span><span class="n">xferlog</span><span class="w">  </span>
<span class="n">dual_log_enable</span><span class="o">=</span><span class="n">YES</span><span class="w"></span>
<span class="n">vsftpd_log_file</span><span class="o">=/</span><span class="nf">var</span><span class="o">/</span><span class="nf">log</span><span class="o">/</span><span class="n">vsftpd</span><span class="p">.</span><span class="nf">log</span><span class="w"></span>

<span class="n">挂载</span><span class="w"></span>
<span class="n">curlftpfs</span><span class="w"> </span><span class="nl">ftp</span><span class="p">:</span><span class="o">//</span><span class="err">$</span><span class="n">IP</span><span class="w"> </span><span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="w"></span>

<span class="n">用户</span><span class="w"></span>
<span class="n">将配置文件中</span><span class="err">”</span><span class="n">anonymous_enable</span><span class="o">=</span><span class="n">YES</span><span class="w"> </span><span class="err">“</span><span class="n">改为</span><span class="w"> </span><span class="err">“</span><span class="n">anonymous_enable</span><span class="o">=</span><span class="k">NO</span><span class="err">”</span><span class="w"></span>
<span class="n">添加chroot_list_enable</span><span class="o">=</span><span class="n">YES</span><span class="w"></span>
<span class="w">        </span><span class="n">chroot_list_file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">vsftpd</span><span class="o">/</span><span class="n">chroot_list</span><span class="w"></span>
<span class="n">useradd</span><span class="w"> </span><span class="n">ftpadmin</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ftpadmin</span><span class="w">        </span><span class="n">用户目录权限755</span><span class="err">，</span><span class="mi">777</span><span class="n">会无法使用</span><span class="p">(</span><span class="n">如果是两级目录</span><span class="err">，</span><span class="n">上级需要777</span><span class="p">)</span><span class="w"></span>
<span class="n">passwd</span><span class="w"> </span><span class="n">ftpadmin</span><span class="w"> </span><span class="n">修改密码</span><span class="w"></span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">vsftpd</span><span class="o">/</span><span class="n">chroot_list</span><span class="w"> </span><span class="n">添加ftpadmin</span><span class="w">   </span><span class="n">用户的登录控制还可以参照上文中user_list进行设定</span><span class="err">。</span><span class="w"></span>


<span class="n">虚拟目录</span><span class="w"></span>
<span class="n">比如我的ftp的默认目录是</span><span class="o">/</span><span class="nf">var</span><span class="o">/</span><span class="n">ftp</span><span class="err">，</span><span class="n">我想把</span><span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">soft文件夹</span><span class="err">，</span><span class="n">映射到</span><span class="o">/</span><span class="nf">var</span><span class="o">/</span><span class="n">ftp</span><span class="o">/</span><span class="n">a目录中</span><span class="err">，</span><span class="n">我就如下操作</span><span class="w"></span>
<span class="n">我们要先在</span><span class="o">/</span><span class="nf">var</span><span class="o">/</span><span class="n">ftp目录中建一个目录</span><span class="w"></span>
<span class="o">[</span><span class="n">root@localhost ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">mkdir</span><span class="w"> </span><span class="o">/</span><span class="nf">var</span><span class="o">/</span><span class="n">ftp</span><span class="o">/</span><span class="n">a</span><span class="w">                               </span><span class="n">然后执行mount命令</span><span class="w"></span>
<span class="o">[</span><span class="n">root@localhost ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">mount</span><span class="w"> </span><span class="c1">--bind /mnt/soft /var/ftp/a    这样就OK了。</span>
<span class="o">[</span><span class="n">root@localhost etc</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">vi</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fstab</span><span class="w"></span>
<span class="n">将</span><span class="w"> </span><span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">soft</span><span class="w">   </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="k">public</span><span class="w">  </span><span class="n">auto</span><span class="w"> </span><span class="n">bind</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w">                         </span><span class="n">添加到</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fstab文件的末尾</span><span class="w"></span>


<span class="n">虚拟用户</span><span class="w"></span>
<span class="n">vim</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">vsftpd</span><span class="o">/</span><span class="n">vftpuser</span><span class="p">.</span><span class="n">txt</span><span class="w"></span>
<span class="k">user</span><span class="w"></span>
<span class="n">passwd</span><span class="w"></span>
<span class="n">user2</span><span class="w"></span>
<span class="n">passwd2</span><span class="w"></span>

<span class="n">db_load</span><span class="w"> </span><span class="o">-</span><span class="n">T</span><span class="w"> </span><span class="o">-</span><span class="n">t</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">vsftpd</span><span class="o">/</span><span class="n">vftpuser</span><span class="p">.</span><span class="n">txt</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">vsftpd</span><span class="o">/</span><span class="n">vu_list</span><span class="p">.</span><span class="n">db</span><span class="w"></span>
<span class="n">chmod</span><span class="w"> </span><span class="mi">600</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">vsftpd</span><span class="o">/</span><span class="n">vu_list</span><span class="p">.</span><span class="n">db</span><span class="w"></span>

<span class="n">vi</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pam</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">vsftp</span><span class="p">.</span><span class="n">vu</span><span class="w">  </span><span class="n">新建一个虚拟用户的PAM文件</span><span class="w">   </span>
<span class="n">auth</span><span class="w"> </span><span class="n">required</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">security</span><span class="o">/</span><span class="n">pam_userdb</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">db</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">vsftpd</span><span class="o">/</span><span class="n">vu_list</span><span class="w"></span>
<span class="n">account</span><span class="w"> </span><span class="n">required</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">security</span><span class="o">/</span><span class="n">pam_userdb</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">db</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">vsftpd</span><span class="o">/</span><span class="n">vu_list</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="n">pam_userdb</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">需要find</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="o">-</span><span class="n">name</span><span class="w"> </span><span class="n">pam_userdb</span><span class="p">.</span><span class="n">so确认下</span><span class="err">，</span><span class="n">不同系统位置可能不同</span><span class="w"></span>

<span class="n">useradd</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ftpsite</span><span class="w"> </span><span class="n">virtual_user</span><span class="w"> </span><span class="n">建立虚拟用户</span><span class="w"></span>
<span class="n">chmod</span><span class="w"> </span><span class="mi">700</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ftpsite</span><span class="w"></span>

<span class="n">编辑</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">vsftpd</span><span class="o">/</span><span class="n">vsftpd</span><span class="p">.</span><span class="n">conf文件</span><span class="err">，</span><span class="n">使其整个文件内容如下所示</span><span class="err">（</span><span class="n">去掉了注释内容</span><span class="err">）：</span><span class="w"></span>
<span class="n">anonymous_enable</span><span class="o">=</span><span class="k">NO</span><span class="w"></span>
<span class="n">local_enable</span><span class="o">=</span><span class="n">YES</span><span class="w"></span>
<span class="n">local_umask</span><span class="o">=</span><span class="mi">022</span><span class="w"></span>
<span class="n">xferlog_enable</span><span class="o">=</span><span class="n">YES</span><span class="w"></span>
<span class="n">connect_from_port_20</span><span class="o">=</span><span class="n">YES</span><span class="w"></span>
<span class="n">xferlog_std_format</span><span class="o">=</span><span class="n">YES</span><span class="w"></span>
<span class="n">listen</span><span class="o">=</span><span class="n">YES</span><span class="w"></span>
<span class="n">write_enable</span><span class="o">=</span><span class="n">YES</span><span class="w"></span>
<span class="n">anon_upload_enable</span><span class="o">=</span><span class="n">YES</span><span class="w"></span>
<span class="n">anon_mkdir_write_enable</span><span class="o">=</span><span class="n">YES</span><span class="w"></span>
<span class="n">anon_other_write_enable</span><span class="o">=</span><span class="n">YES</span><span class="w"></span>
<span class="n">anon_umask</span><span class="o">=</span><span class="mi">022</span><span class="w"></span>
<span class="n">one_process_model</span><span class="o">=</span><span class="k">NO</span><span class="w"></span>
<span class="n">chroot_local_user</span><span class="o">=</span><span class="n">YES</span><span class="w"></span>
<span class="n">allow_writeable_chroot</span><span class="o">=</span><span class="n">YES</span><span class="w"></span>
<span class="n">ftpd_banner</span><span class="o">=</span><span class="n">Welcom</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">my</span><span class="w"> </span><span class="n">FTP</span><span class="w"> </span><span class="n">server</span><span class="p">.</span><span class="w"></span>
<span class="n">anon_world_readable_only</span><span class="o">=</span><span class="k">NO</span><span class="w"></span>
<span class="n">guest_enable</span><span class="o">=</span><span class="n">YES</span><span class="w"></span>
<span class="n">guest_username</span><span class="o">=</span><span class="n">virtual_user</span><span class="w"></span>
<span class="n">pam_service_name</span><span class="o">=</span><span class="n">vsftp</span><span class="p">.</span><span class="n">vu</span><span class="w"></span>

<span class="n">上面代码中</span><span class="err">，</span><span class="n">guest_enable</span><span class="o">=</span><span class="n">YES表示启用虚拟用户</span><span class="err">；</span><span class="w"></span>
<span class="w">           </span><span class="n">guest_username</span><span class="o">=</span><span class="n">virtual_user则是将虚拟用户映射为本地用户</span><span class="err">，</span><span class="n">这样虚拟用户登录后权限和virtual_user一样</span><span class="err">；</span><span class="w"></span>
<span class="w">           </span><span class="n">pam_service_name</span><span class="o">=</span><span class="n">vsftp</span><span class="p">.</span><span class="n">vu</span><span class="w"> </span><span class="n">指定PAM的配置文件为</span><span class="w"> </span><span class="n">vsftp</span><span class="p">.</span><span class="n">vu</span><span class="w"></span>


<span class="n">在虚拟FTP服务器中</span><span class="err">，</span><span class="n">也可以对各个用户的权限进行设置</span><span class="err">。</span><span class="n">方法是在</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">vsftpd</span><span class="p">.</span><span class="n">conf文件中添加如下一行</span><span class="err">：</span><span class="w"></span>
<span class="n">user_config_dir</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">vsftpd</span><span class="o">/</span><span class="n">vsftpd_user_conf</span><span class="w">  </span><span class="n">用户配置文件目录</span><span class="w"></span>

<span class="n">然后在用户配置文件目录下创建相应的用户配置文件</span><span class="err">，</span><span class="n">比如为上述名为gou的用户创建一个配置文件</span><span class="err">：</span><span class="w"></span>
<span class="n">#vi</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">vsftpd</span><span class="o">/</span><span class="n">vsftpd_user_conf</span><span class="o">/</span><span class="n">gou</span><span class="w"></span>
<span class="n">write_enable</span><span class="o">=</span><span class="n">YES</span><span class="w"></span>
<span class="n">local_root</span><span class="o">=</span><span class="n">家目录</span><span class="w">   </span><span class="n">将权限设为virtual_user</span><span class="w"></span>

<span class="mf">9.</span><span class="n">添加FTP用户的步骤</span><span class="w"></span>
<span class="w">      </span><span class="mf">1.</span><span class="n">在vftpuser</span><span class="p">.</span><span class="n">txt中添加用户名和密码</span><span class="w"></span>
<span class="w">      </span><span class="mf">2.</span><span class="n">运行如下命令</span><span class="p">,</span><span class="n">将用户名和密码添加到数据库中</span><span class="w"></span>
<span class="w">        </span><span class="n">db_load</span><span class="w"> </span><span class="o">-</span><span class="n">T</span><span class="w"> </span><span class="o">-</span><span class="n">t</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">vsftpd</span><span class="o">/</span><span class="n">vftpuser</span><span class="p">.</span><span class="n">txt</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">vsftpd</span><span class="o">/</span><span class="n">vu_list</span><span class="p">.</span><span class="n">db</span><span class="w"></span>
<span class="w">      </span><span class="mi">3</span><span class="w"> </span><span class="n">在etc</span><span class="o">/</span><span class="n">vsftpd</span><span class="o">/</span><span class="n">vsftpd_user_conf文件夹下新建和用户名相同的文件</span><span class="p">,</span><span class="n">并在其中加入</span><span class="w"></span>
<span class="w">       </span><span class="n">local_root</span><span class="o">=</span><span class="n">家目录</span><span class="w"></span>
<span class="w">      </span><span class="mi">4</span><span class="w"> </span><span class="n">重启ftp</span><span class="w">   </span><span class="n">systemctl</span><span class="w"> </span><span class="n">restart</span><span class="w"> </span><span class="n">vsftpd</span><span class="w"></span>



<span class="n">四</span><span class="err">、</span><span class="n">FTP</span><span class="w"> </span><span class="n">的主动与被动模式</span><span class="w"></span>
<span class="w">    </span><span class="n">FTP是基于TCP的服务</span><span class="err">，</span><span class="n">在实际应用中有两个接口</span><span class="err">：</span><span class="n">一个数据接口</span><span class="err">，</span><span class="n">一个控制接口</span><span class="err">。</span><span class="n">默认情况下这两个端口是21</span><span class="err">（</span><span class="n">控制端口</span><span class="err">）</span><span class="n">和20</span><span class="err">（</span><span class="n">数据端口</span><span class="err">）。</span><span class="w"></span>
<span class="w">    </span><span class="n">主动方式的FTP是</span><span class="err">：</span><span class="n">客户端从一个任意的非特权端口N</span><span class="err">（</span><span class="n">N</span><span class="o">&gt;</span><span class="mi">1024</span><span class="err">）</span><span class="n">连接到FTP服务器的命令端口</span><span class="err">，</span><span class="n">也就是21端口</span><span class="err">。</span><span class="n">然后客户端开始监听端口N</span><span class="o">+</span><span class="mi">1</span><span class="err">，</span><span class="w"></span>
<span class="w">    </span><span class="n">并发送FTP命令</span><span class="err">“</span><span class="n">port</span><span class="w"> </span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="err">”</span><span class="n">到FTP服务器</span><span class="err">。</span><span class="n">接着服务器会从它自己的数据端口</span><span class="err">（</span><span class="mi">20</span><span class="err">）</span><span class="n">连接到客户端指定的数据端口</span><span class="err">（</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="err">）。</span><span class="w"></span>
<span class="w">    </span><span class="n">被动方式</span><span class="err">，</span><span class="n">或者叫做PASV</span><span class="err">，</span><span class="n">当客户端通知服务器它处于被动模式时才启用</span><span class="err">。</span><span class="n">在被动方式FTP中</span><span class="err">，</span><span class="n">命令连接和数据连接都由客户端发起</span><span class="p">.</span><span class="w"></span>
<span class="w">    </span><span class="n">当开启一个</span><span class="w"> </span><span class="n">FTP连接时</span><span class="err">，</span><span class="n">客户端打开两个任意的非特权本地端口</span><span class="err">（</span><span class="n">N</span><span class="o">&gt;</span><span class="mi">1024</span><span class="n">和N</span><span class="o">+</span><span class="mi">1</span><span class="err">）。</span><span class="n">第一个端口连接服务器的21端口</span><span class="err">，</span><span class="n">但与主动方式的FTP不同</span><span class="err">，</span><span class="w"></span>
<span class="w">    </span><span class="n">客户端不会提交PORT命令并允许服务器来回连它的数据端口</span><span class="err">，</span><span class="n">而是提交</span><span class="w"> </span><span class="n">PASV命令</span><span class="err">。</span><span class="n">这样做的结果是服务器会开启一个任意的非特权端口</span><span class="w"></span>
<span class="w">    </span><span class="err">（</span><span class="n">P</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1024</span><span class="err">），</span><span class="n">并发送PORT</span><span class="w"> </span><span class="n">P命令给客户端</span><span class="err">。</span><span class="n">然后客户端发起从本地端口N</span><span class="o">+</span><span class="mi">1</span><span class="n">到服务器的端口P的连接用来传送数据</span><span class="err">。</span><span class="w"> </span>
<span class="w">    </span><span class="n">简单的来说</span><span class="err">，</span><span class="n">可以认为两者的区别主要在于客户端和服务器端到底是由谁来确定非特权端口</span><span class="err">，</span><span class="n">也就是这一对TCP通信组合的通道</span><span class="err">。</span><span class="w"></span>
<span class="w">    </span><span class="n">如果是客户端先确定非特权端口就是主动模式</span><span class="err">，</span><span class="n">服务器端先确定非特权端口就是被动模式</span><span class="err">。（</span><span class="n">但实质上通信过程是不一样的</span><span class="err">，</span><span class="w"></span>
<span class="w">    </span><span class="n">这种说法只可以做简单区分用</span><span class="err">）</span><span class="w"></span>
<span class="n">五</span><span class="err">、</span><span class="n">FTP相关的防火墙设定</span><span class="w"></span>
<span class="w">    </span><span class="n">当Linux系统启动了防火墙后</span><span class="err">，</span><span class="n">需要相应的对防火墙进行设定</span><span class="err">，</span><span class="n">防止防火墙阻断FTP通信</span><span class="err">。</span><span class="w"></span>
<span class="w"> </span><span class="n">支持主动方式FTP</span><span class="err">，</span><span class="n">防火墙设定</span><span class="err">：</span><span class="w">    </span>
<span class="mf">1.</span><span class="w"> </span><span class="n">任何大于1024的端口到FTP服务器的21端口</span><span class="err">。（</span><span class="n">客户端初始化的连接</span><span class="err">）</span><span class="w"> </span>
<span class="mf">2.</span><span class="w"> </span><span class="n">FTP服务器的21端口到大于1024的端口</span><span class="err">。</span><span class="w"> </span><span class="err">（</span><span class="n">服务器响应客户端的控制端口</span><span class="err">）</span><span class="w"></span>
<span class="mf">3.</span><span class="w"> </span><span class="n">FTP服务器的20端口到大于1024的端口</span><span class="err">。（</span><span class="n">服务器端初始化数据连接到客户端的数据端口</span><span class="err">）</span><span class="w"></span>
<span class="w"> </span><span class="mf">4.</span><span class="w"> </span><span class="n">大于1024端口到FTP服务器的20端口</span><span class="err">（</span><span class="n">客户端发送ACK响应到服务器的数据端口</span><span class="err">）</span><span class="w"></span>
<span class="n">支持被动方式的FTP</span><span class="err">，</span><span class="nl">防火墙设定</span><span class="p">:</span><span class="w">  </span>
<span class="mf">1.</span><span class="w"> </span><span class="n">从任何大于1024的端口到服务器的21端口</span><span class="err">（</span><span class="n">客户端初始化的连接</span><span class="err">）</span><span class="w"> </span>
<span class="mf">2.</span><span class="w"> </span><span class="n">服务器的21端口到任何大于1024的端口</span><span class="err">（</span><span class="n">服务器响应到客户端的控制端口的连接</span><span class="err">）</span><span class="w"></span>
<span class="mf">3.</span><span class="w"> </span><span class="n">从任何大于1024端口到服务器的大于1024端口</span><span class="err">（</span><span class="n">客户端初始化数据连接到服务器指定的任意端口</span><span class="err">）</span><span class="w"></span>
<span class="mf">4.</span><span class="w"> </span><span class="n">服务器的大于1024端口到远程的大于1024的端口</span><span class="err">（</span><span class="n">服务器发送ACK响应和数据到客户端的数据端口</span><span class="err">）</span><span class="w"></span>
<span class="n">下面以被动模式的防火墙为例给出示范</span><span class="err">：</span><span class="w"></span>
<span class="w">    </span><span class="n">首先vi</span><span class="w">  </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">vsftpd</span><span class="o">/</span><span class="n">vsftpd</span><span class="p">.</span><span class="n">conf文件中配置开启pasv被动模式</span><span class="err">：</span><span class="w"></span>
<span class="w">    </span><span class="n">pasv_enable</span><span class="o">=</span><span class="n">YES</span><span class="w"></span>
<span class="w">    </span><span class="n">设定非特权端口的通信范围</span><span class="err">（</span><span class="n">示例只做参考</span><span class="err">）：</span><span class="w"></span>
<span class="w">    </span><span class="n">最小值pasv_min_port</span><span class="o">=</span><span class="mi">10020</span><span class="w"></span>
<span class="w">    </span><span class="n">最大值pasv_max_port</span><span class="o">=</span><span class="mi">11020</span><span class="w"></span>
<span class="w">    </span><span class="n">保存后注意配置后重启vsftpd服务</span><span class="err">。</span><span class="w"></span>
<span class="w">    </span><span class="n">然后vi</span><span class="w">  </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysconfig</span><span class="o">/</span><span class="n">iptables</span><span class="err">，</span><span class="n">配置系统防火墙</span><span class="err">：</span><span class="w"></span>
<span class="w">    </span><span class="o">-</span><span class="n">A</span><span class="w"> </span><span class="k">INPUT</span><span class="w"> </span><span class="o">-</span><span class="n">m</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="c1">--state RELATED,ESTABLISHED -j ACCEPT</span>
<span class="w">    </span><span class="o">-</span><span class="n">A</span><span class="w"> </span><span class="k">INPUT</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="o">-</span><span class="n">j</span><span class="w"> </span><span class="n">ACCEPT</span><span class="w"></span>
<span class="w">    </span><span class="o">-</span><span class="n">A</span><span class="w"> </span><span class="k">INPUT</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="n">lo</span><span class="w"> </span><span class="o">-</span><span class="n">j</span><span class="w"> </span><span class="n">ACCEPT</span><span class="w"></span>
<span class="w">    </span><span class="o">-</span><span class="n">A</span><span class="w"> </span><span class="k">INPUT</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">tcp</span><span class="w"> </span><span class="o">-</span><span class="n">m</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="c1">--state NEW -m tcp --dport 10020:11020 -j ACCEPT</span>
<span class="w">    </span><span class="o">-</span><span class="n">A</span><span class="w"> </span><span class="k">INPUT</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">tcp</span><span class="w"> </span><span class="o">-</span><span class="n">m</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="c1">--state NEW -m tcp --dport 20 -j ACCEPT</span>
<span class="w">    </span><span class="o">-</span><span class="n">A</span><span class="w"> </span><span class="k">INPUT</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">tcp</span><span class="w"> </span><span class="o">-</span><span class="n">m</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="c1">--state NEW -m tcp --dport 21 -j ACCEPT</span>
<span class="w">    </span><span class="n">保存后注意重启iptables服务</span><span class="err">。</span><span class="w"></span>

<span class="w">    </span><span class="n">如果FTP服务器为云服务器或者有局域网路由控制</span><span class="err">，</span><span class="n">除了单独设定路由端口映射规则并在云服务器安全规则中添加例外</span><span class="err">，</span><span class="n">还要在</span><span class="w"></span>
<span class="w">    </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">vsftpd</span><span class="o">/</span><span class="n">vsftpd</span><span class="p">.</span><span class="n">conf中声明被动模式的公网地址</span><span class="err">，</span><span class="n">以防端口映射出现问题</span><span class="err">：</span><span class="w"></span>
<span class="w">    </span><span class="n">pasv_address</span><span class="o">=</span><span class="mf">111.111.111.111</span><span class="err">（</span><span class="n">示例</span><span class="err">）</span><span class="w"></span>
<span class="w">    </span><span class="n">pasv_addr_resolve</span><span class="o">=</span><span class="n">yes</span><span class="w"></span>
<span class="w">    </span><span class="n">pasv_promiscuous</span><span class="o">=</span><span class="n">yes</span><span class="w"></span>

<span class="n">注</span><span class="err">：</span><span class="n">如果连接过程中出现200</span><span class="w"> </span><span class="n">PORT</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="n">successful</span><span class="p">.</span><span class="w"> </span><span class="n">Consider</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">PASV</span><span class="p">.</span><span class="n">这条错误信息</span><span class="err">，</span><span class="n">不要轻易按照网上建议最多的</span><span class="w"></span>
<span class="n">关闭PASV模式</span><span class="err">，</span><span class="n">只采用主动模式</span><span class="err">。</span><span class="n">因为在很多情况下客户端处于VLAN等网络环境下</span><span class="err">，</span><span class="n">很难主动给出链接端口</span><span class="err">，</span><span class="n">不得不采用被动模式</span><span class="err">，</span><span class="w"></span>
<span class="n">出现这个错误并不能通过关闭PASV模式解决</span><span class="err">，</span><span class="n">而应该寻找PASV各方面的位置</span><span class="err">，</span><span class="n">找到配置中存在的问题进行解决</span><span class="err">。</span><span class="w"></span>
</pre></div>


<h2 id="vsftpd-mysql">vsftpd-mysql结合</h2>
<div class="codehilite"><pre><span></span><span class="err">一、安装所需要程序</span>

<span class="mi">1</span><span class="err">、事先安装好开发环境和</span><span class="n">mysql</span><span class="err">数据库</span><span class="p">;</span>

<span class="cp"># yum -y install mysql-server mysql-devel</span>
<span class="cp"># yum -y groupinstall &quot;Development Tools&quot; &quot;Development Libraries&quot;</span>

<span class="mf">2.</span><span class="err">安装</span><span class="n">pam_mysql</span><span class="o">-</span><span class="mf">0.7</span><span class="n">RC1</span>

<span class="cp"># tar zxvf  pam_mysql-0.7RC1.tar.gz</span>
<span class="cp"># cd  pam_mysql-0.7RC1</span>
<span class="cp"># ./configure --with-mysql=/usr --with-openssl</span>
<span class="cp"># make</span>
<span class="cp"># make install</span>

<span class="mf">3.</span><span class="err">安装</span><span class="n">vsftpd</span>

<span class="cp"># yum -y install vsftpd</span>


<span class="err">二、创建虚拟用户账号</span>

<span class="mf">1.</span><span class="err">准备数据库及相关表</span>

<span class="err">首先请确保</span><span class="n">mysql</span><span class="err">服务已经正常启动。而后，按需要建立存储虚拟用户的数据库即可，这里将其创建为</span><span class="n">vsftpd</span><span class="err">数据库。</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">create</span> <span class="n">database</span> <span class="n">vsftpd</span><span class="p">;</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">grant</span> <span class="n">select</span> <span class="n">on</span> <span class="n">vsftpd</span><span class="p">.</span><span class="o">*</span> <span class="n">to</span> <span class="n">vsftpd</span><span class="p">@</span><span class="n">localhost</span> <span class="n">identified</span> <span class="n">by</span> <span class="err">&#39;</span><span class="n">www</span><span class="p">.</span><span class="n">magedu</span><span class="p">.</span><span class="n">com</span><span class="err">&#39;</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">grant</span> <span class="n">select</span> <span class="n">on</span> <span class="n">vsftpd</span><span class="p">.</span><span class="o">*</span> <span class="n">to</span> <span class="n">vsftpd</span><span class="mf">@127.0.0.1</span> <span class="n">identified</span> <span class="n">by</span> <span class="err">&#39;</span><span class="n">www</span><span class="p">.</span><span class="n">magedu</span><span class="p">.</span><span class="n">com</span><span class="err">&#39;</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">flush</span> <span class="n">privileges</span><span class="p">;</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">use</span> <span class="n">vsftpd</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">create</span> <span class="n">table</span> <span class="n">users</span> <span class="p">(</span>
    <span class="o">-&gt;</span> <span class="kt">id</span> <span class="kt">int</span> <span class="n">AUTO_INCREMENT</span> <span class="n">NOT</span> <span class="nb">NULL</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="n">name</span> <span class="kt">char</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="n">binary</span> <span class="n">NOT</span> <span class="nb">NULL</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="n">password</span> <span class="kt">char</span><span class="p">(</span><span class="mi">48</span><span class="p">)</span> <span class="n">binary</span> <span class="n">NOT</span> <span class="nb">NULL</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="n">primary</span> <span class="n">key</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span>
    <span class="o">-&gt;</span> <span class="p">);</span>

<span class="mi">2</span><span class="err">、添加测试的虚拟用户</span>

<span class="err">根据需要添加所需要的用户，需要说明的是，这里将其密码采用明文格式存储，原因是</span><span class="n">pam_mysql</span><span class="err">的</span><span class="n">password</span><span class="p">()</span><span class="err">函数与</span><span class="n">MySQL</span><span class="err">的</span><span class="n">password</span><span class="p">()</span><span class="err">函数</span>
<span class="err">可能会有所不同。</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">insert</span> <span class="n">into</span> <span class="n">users</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">password</span><span class="p">)</span> <span class="n">values</span><span class="p">(</span><span class="err">&#39;</span><span class="n">tom</span><span class="sc">&#39;,&#39;</span><span class="n">magedu</span><span class="err">&#39;</span><span class="p">);</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">insert</span> <span class="n">into</span> <span class="n">users</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">password</span><span class="p">)</span> <span class="n">values</span><span class="p">(</span><span class="err">&#39;</span><span class="n">jerry</span><span class="sc">&#39;,&#39;</span><span class="n">magedu</span><span class="err">&#39;</span><span class="p">);</span>


<span class="err">三、配置</span><span class="n">vsftpd</span>

<span class="mf">1.</span><span class="err">建立</span><span class="n">pam</span><span class="err">认证所需文件</span>

<span class="cp">#vi /etc/pam.d/vsftpd.mysql</span>
<span class="err">添加如下两行</span>
<span class="n">auth</span> <span class="n">required</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">security</span><span class="o">/</span><span class="n">pam_mysql</span><span class="p">.</span><span class="n">so</span> <span class="n">user</span><span class="o">=</span><span class="n">vsftpd</span> <span class="n">passwd</span><span class="o">=</span><span class="n">www</span><span class="p">.</span><span class="n">magedu</span><span class="p">.</span><span class="n">com</span> <span class="n">host</span><span class="o">=</span><span class="n">localhost</span> <span class="n">db</span><span class="o">=</span><span class="n">vsftpd</span> <span class="n">table</span><span class="o">=</span><span class="n">users</span> 
<span class="err">接上行</span> <span class="n">usercolumn</span><span class="o">=</span><span class="n">name</span> <span class="n">passwdcolumn</span><span class="o">=</span><span class="n">password</span> <span class="n">crypt</span><span class="o">=</span><span class="mi">0</span>
<span class="n">account</span> <span class="n">required</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">security</span><span class="o">/</span><span class="n">pam_mysql</span><span class="p">.</span><span class="n">so</span> <span class="n">user</span><span class="o">=</span><span class="n">vsftpd</span> <span class="n">passwd</span><span class="o">=</span><span class="n">www</span><span class="p">.</span><span class="n">magedu</span><span class="p">.</span><span class="n">com</span> <span class="n">host</span><span class="o">=</span><span class="n">localhost</span> <span class="n">db</span><span class="o">=</span><span class="n">vsftpd</span> <span class="n">table</span><span class="o">=</span><span class="n">users</span> 
<span class="err">接上行</span> <span class="n">usercolumn</span><span class="o">=</span><span class="n">name</span> <span class="n">passwdcolumn</span><span class="o">=</span><span class="n">password</span> <span class="n">crypt</span><span class="o">=</span><span class="mi">0</span>

<span class="mf">2.</span><span class="err">修改</span><span class="n">vsftpd</span><span class="err">的配置文件，使其适应</span><span class="n">mysql</span><span class="err">认证</span>

<span class="err">建立虚拟用户映射的系统用户及对应的目录</span>
<span class="cp">#useradd -s /sbin/nologin -d /var/ftproot vuser</span>
<span class="cp">#chmod go+rx /var/ftproot</span>

<span class="err">请确保</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">vsftpd</span><span class="p">.</span><span class="n">conf</span><span class="err">中已经启用了以下选项</span>
<span class="n">anonymous_enable</span><span class="o">=</span><span class="nb">YES</span>
<span class="n">local_enable</span><span class="o">=</span><span class="nb">YES</span>
<span class="n">write_enable</span><span class="o">=</span><span class="nb">YES</span>
<span class="n">anon_upload_enable</span><span class="o">=</span><span class="nb">NO</span>
<span class="n">anon_mkdir_write_enable</span><span class="o">=</span><span class="nb">NO</span>
<span class="n">chroot_local_user</span><span class="o">=</span><span class="nb">YES</span>

<span class="err">而后添加以下选项</span>
<span class="n">guest_enable</span><span class="o">=</span><span class="nb">YES</span>
<span class="n">guest_username</span><span class="o">=</span><span class="n">vuser</span>

<span class="err">并确保</span><span class="n">pam_service_name</span><span class="err">选项的值如下所示</span>
<span class="n">pam_service_name</span><span class="o">=</span><span class="n">vsftpd</span><span class="p">.</span><span class="n">mysql</span>


<span class="err">四、启动</span><span class="n">vsftpd</span><span class="err">服务</span>

<span class="cp"># service vsftpd start</span>
<span class="cp"># chkconfig vsftpd on</span>

<span class="err">查看端口开启情况</span>

<span class="cp"># netstat -tnlp |grep :21</span>
<span class="n">tcp</span>        <span class="mi">0</span>      <span class="mi">0</span> <span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">21</span>              <span class="mf">0.0.0.0</span><span class="o">:*</span>               <span class="n">LISTEN</span>      <span class="mi">23286</span><span class="o">/</span><span class="n">vsftpd</span> 

<span class="err">使用虚拟用户登录</span><span class="p">,</span><span class="err">验正配置结果，以下为本机的命令方式测试，你也可以在其它</span><span class="n">Win</span> <span class="n">Box</span><span class="err">上用</span><span class="n">IE</span><span class="err">或者</span><span class="n">FTP</span><span class="err">客户端工具登录验正</span>
<span class="cp"># ftp localhost</span>



<span class="err">五、配置虚拟用户具有不同的访问权限</span>

<span class="n">vsftpd</span><span class="err">可以在配置文件目录中为每个用户提供单独的配置文件以定义其</span><span class="n">ftp</span><span class="err">服务访问权限，每个虚拟用户的配置文件名同虚拟用户的用户名。</span>
<span class="err">配置文件目录可以是任意未使用目录，只需要在</span><span class="n">vsftpd</span><span class="p">.</span><span class="n">conf</span><span class="err">指定其路径及名称即可。</span>

<span class="mi">1</span><span class="err">、配置</span><span class="n">vsftpd</span><span class="err">为虚拟用户使用配置文件目录</span>

<span class="cp"># vim vsftpd.conf</span>
<span class="err">添加如下选项</span>
<span class="n">user_config_dir</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">vsftpd</span><span class="o">/</span><span class="n">vusers_dir</span> 

<span class="mi">2</span><span class="err">、创建所需要目录，并为虚拟用户提供配置文件</span>

<span class="cp"># mkdir /etc/vsftpd/vusers_dir/</span>
<span class="cp"># cd /etc/vsftpd/vusers_dir/</span>
<span class="cp"># touch tom jerry</span>

<span class="mi">3</span><span class="err">、配置虚拟用户的访问权限</span>

<span class="err">虚拟用户对</span><span class="n">vsftpd</span><span class="err">服务的访问权限是通过匿名用户的相关指令进行的。比如，如果需要让</span><span class="n">tom</span><span class="err">用户具有上传文件的权限，可以修改</span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">vsftpd</span><span class="o">/</span><span class="n">vusers</span><span class="o">/</span><span class="n">tom</span><span class="err">文件，在里面添加如下选项即可。</span>
<span class="n">anon_upload_enable</span><span class="o">=</span><span class="nb">YES</span>
</pre></div>


<h2 id="lsyncd">实时同步lsyncd</h2>
<div class="codehilite"><pre><span></span><span class="mf">1.1</span> <span class="n">inotify</span> <span class="o">+</span> <span class="n">rsync</span>
<span class="err">最近一直在寻求生产服务服务器上的同步替代方案，原先使用的是</span><span class="n">inotify</span> <span class="o">+</span> <span class="n">rsync</span><span class="err">，但随着文件数量的增大到</span><span class="mi">100</span><span class="n">W</span><span class="o">+</span><span class="err">，目录下的文件列表就达</span><span class="mi">20</span><span class="n">M</span><span class="err">，</span>
<span class="err">在网络状况不佳或者限速的情况下，变更的文件可能</span><span class="mi">10</span><span class="err">来个才几</span><span class="n">M</span><span class="err">，却因此要发送的文件列表就达</span><span class="mi">20</span><span class="n">M</span><span class="err">，严重减低的带宽的使用效率以及同步效率；</span>
<span class="err">更为要紧的是，加入</span><span class="n">inotifywait</span><span class="err">在</span><span class="mi">5</span><span class="n">s</span><span class="err">内监控到</span><span class="mi">10</span><span class="err">个小文件发生变化，便会触发</span><span class="mi">10</span><span class="err">个</span><span class="n">rsync</span><span class="err">同步操作，结果就是真正需要传输的才</span><span class="mi">2</span><span class="o">-</span><span class="mi">3</span><span class="n">M</span><span class="err">的文件，</span>
<span class="err">比对的文件列表就达</span><span class="mi">200</span><span class="n">M</span><span class="err">。使用这两个组合的好处在于，它们都是最基本的软件，可以通过不同选项做到很精确的控制，比如排除同步的目录，</span>
<span class="err">同步多个模块或同步到多个主机。</span>

<span class="err">搭建过程参考</span> <span class="n">Linux</span><span class="err">下同步工具</span><span class="n">inotify</span><span class="o">+</span><span class="n">rsync</span><span class="err">使用详解</span> <span class="err">或这里。</span>

<span class="mf">1.2</span> <span class="n">sersync</span>
<span class="err">后来听同事说</span> <span class="n">sersync</span> <span class="err">这么个工具可以提高同步的性能，也解决了同步大文件时出现异常的问题，所以就尝试了一下。</span><span class="n">sersync</span><span class="err">是国内的一个</span>
<span class="err">开发者开源出来的，使用</span><span class="n">c</span><span class="o">++</span><span class="err">编写，采用多线程的方式进行同步，失败后还有重传机制，对临时文件过滤，自带</span><span class="n">crontab</span><span class="err">定时同步功能。网上看到</span>
<span class="err">有人说性能还不错，说一下我的观点：</span>

<span class="err">国产开源，文档不是很全，在</span><span class="mi">2011</span><span class="err">年之后就没更新了（</span><span class="n">googlecode</span><span class="err">都要快关闭了，其实可以转交其他人维护），网上关于它的使用和讨论都止于</span>
<span class="mi">10</span><span class="err">年了采用</span><span class="n">xml</span><span class="err">配置文件的方式，可读性比较好，但是有些原生的有些功能没有实现就没法使用了</span>
<span class="err">无法实现多目录同步，只能通过多个配置文件启动多个进程</span>
<span class="err">文件排除功能太弱。这个要看需求，不是每个人都需要排除子目录。而对于我的环境中，这个功能很重要，而且排除的规则较多</span>
<span class="err">虽然提供插件的功能，但很鸡肋，因为软件本身没有持续更新，也没有看到贡献有其它插件出现（可能是我知识面不够，</span>
<span class="err">还用不到里面的</span><span class="n">refreshCDN</span> <span class="n">plugin</span><span class="err">）。</span>
<span class="err">虽然不懂</span><span class="n">c</span><span class="o">++</span><span class="err">，但大致看了下源码</span> <span class="n">FileSynchronize</span><span class="err">，拼接</span><span class="n">rsync</span><span class="err">命令大概在</span><span class="mi">273</span><span class="err">行左右，最后一个函数就是排除选项，</span>
<span class="err">简单一点可以将</span><span class="o">--</span><span class="n">exclude</span><span class="o">=</span><span class="err">改成</span><span class="o">--</span><span class="n">eclude</span><span class="o">-</span><span class="n">from</span><span class="err">来灵活控制。有机会再改吧。</span>

<span class="err">另外，在作者的文章</span> <span class="n">Sersync</span><span class="err">服务器同步程序</span> <span class="err">项目简介与设计框架</span> <span class="err">评论中，说能解决上面</span> <span class="n">rsync</span> <span class="o">+</span> <span class="n">inotify</span><span class="err">中所描述的问题。</span>
<span class="err">阅读了下源码，这个应该是没有解决，因为在拼接</span><span class="n">rsync</span><span class="err">命令时，后面的目的地址始终是针对</span><span class="n">module</span><span class="err">的，只要执行</span><span class="n">rsync</span><span class="err">命令，</span>
<span class="err">就会对整个目录进行遍历，发送要比对的文件列表，然后再发送变化的文件。</span><span class="n">sersync</span><span class="err">只是减少了监听的事件，减少了</span><span class="n">rsync</span>
<span class="err">的次数——这已经是很大的改进，但每次</span><span class="n">rsync</span><span class="err">没办法改变。（如有其它看法可与我讨论）</span>

<span class="err">其实我们也不能要求每一个软件功能都十分健全，关键是看能否满足我们当下的特定的需求。所谓好的架构不是设计出来的，而是进化来的。</span>
<span class="err">目前使用</span><span class="n">sersync2</span><span class="err">没什么问题，而且看了它的设计思路应该是比较科学的，特别是过滤队列的设计。双向同步看起来也是可以实现。</span>

<span class="mf">1.3</span> <span class="n">lsyncd</span>
<span class="err">废话说这么多，本文就是介绍它了。有些博客说</span><span class="n">lsyncd</span><span class="err">是谷歌开源的，实际不是了，只是托管在了</span><span class="n">googlecode</span><span class="err">上而已，</span>
<span class="err">幸运的是已经迁移到</span><span class="n">github</span><span class="err">了：</span><span class="nl">https</span><span class="p">:</span><span class="c1">//github.com/axkibe/lsyncd 。</span>

<span class="n">Lysncd</span> <span class="err">实际上是</span><span class="n">lua</span><span class="err">语言封装了</span> <span class="n">inotify</span> <span class="err">和</span> <span class="n">rsync</span> <span class="err">工具，采用了</span> <span class="n">Linux</span> <span class="err">内核（</span><span class="mf">2.6.13</span> <span class="err">及以后）里的</span> <span class="n">inotify</span> <span class="err">触发机制，</span>
<span class="err">然后通过</span><span class="n">rsync</span><span class="err">去差异同步，达到实时的效果。我认为它最令人称道的特性是，完美解决了</span> <span class="n">inotify</span> <span class="o">+</span> <span class="n">rsync</span><span class="err">海量文件同步带来的</span>
<span class="err">文件频繁发送文件列表的问题</span> <span class="err">——</span> <span class="err">通过时间延迟或累计触发事件次数实现。另外，它的配置方式很简单，</span><span class="n">lua</span><span class="err">本身就是一种配置语言，</span>
<span class="err">可读性非常强。</span><span class="n">lsyncd</span><span class="err">也有多种工作模式可以选择，本地目录</span><span class="n">cp</span><span class="err">，本地目录</span><span class="n">rsync</span><span class="err">，远程目录</span><span class="n">rsyncssh</span><span class="err">。</span>

<span class="err">实现简单高效的本地目录同步备份（网络存储挂载也当作本地目录），一个命令搞定。</span>

<span class="mf">2.</span> <span class="err">使用</span> <span class="n">lsyncd</span> <span class="err">本地目录实时备份</span>
<span class="err">这一节实现的功能是，本地目录</span><span class="n">source</span><span class="err">实时同步到另一个目录</span><span class="n">target</span><span class="err">，而在</span><span class="n">source</span><span class="err">下有大量的文件，并且有部分目录和临时文件不需要同步。</span>

<span class="mf">2.1</span> <span class="err">安装</span><span class="n">lsyncd</span>
<span class="err">安装</span><span class="n">lsyncd</span><span class="err">极为简单，已经收录在</span><span class="n">ubuntu</span><span class="err">的官方镜像源里，直接通过</span><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">lsyncd</span><span class="err">就可以。</span>
<span class="err">在</span><span class="n">Redhat</span><span class="err">系（我的环境是</span><span class="n">CentOS</span> <span class="mf">6.2</span> <span class="n">x86_64</span> <span class="err">），可以手动去下载</span> <span class="n">lsyncd</span><span class="o">-</span><span class="mf">2.1.5</span><span class="o">-</span><span class="mf">6.f</span><span class="n">c21</span><span class="p">.</span><span class="n">x86_64</span><span class="p">.</span><span class="n">rpm</span><span class="err">，但首先你得安装两个依赖</span>
<span class="n">yum</span> <span class="n">install</span> <span class="n">lua</span> <span class="n">lua</span><span class="o">-</span><span class="n">devel</span><span class="err">。也可以通过在线安装，需要</span><span class="n">epel</span><span class="o">-</span><span class="k">release</span><span class="err">扩展包：</span>

<span class="cp"># rpm -ivh http:</span><span class="c1">//dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm# yum install lsyncd</span>
<span class="err">源码编译安装</span>
<span class="err">从源码编译安装可以使用最新版的</span><span class="n">lsyncd</span><span class="err">程序，但必须要相应的依赖库文件和编译工具：</span><span class="n">yum</span> <span class="n">install</span> <span class="n">lua</span> <span class="n">lua</span><span class="o">-</span><span class="n">devel</span> <span class="n">asciidoc</span> <span class="n">cmake</span><span class="err">。</span>

<span class="err">从</span> <span class="n">googlecode</span> <span class="n">lsyncd</span> <span class="err">上下载的</span><span class="n">lsyncd</span><span class="o">-</span><span class="mf">2.1.5</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span><span class="err">，直接</span><span class="p">.</span><span class="o">/</span><span class="n">configure</span><span class="err">、</span><span class="n">make</span> <span class="o">&amp;&amp;</span> <span class="n">make</span> <span class="n">install</span><span class="err">就可以了。</span>

<span class="err">从</span><span class="n">github</span><span class="err">上下载</span><span class="n">lsyncd</span><span class="o">-</span><span class="n">master</span><span class="p">.</span><span class="n">zip</span> <span class="err">的</span><span class="mf">2.1.5</span><span class="err">版本使用的是</span> <span class="n">cmake</span> <span class="err">编译工具，无法</span><span class="p">.</span><span class="o">/</span><span class="n">configure</span><span class="err">：</span>

<span class="cp"># uzip lsyncd-master.zip# cd lsyncd-master# cmake -DCMAKE_INSTALL_PREFIX=/usr/local/lsyncd-2.1.5# make &amp;&amp; make install</span>
<span class="err">我这个版本编译时有个小</span><span class="n">bug</span><span class="err">，如果按照</span><span class="n">INSTALL</span><span class="err">在</span><span class="n">build</span><span class="err">目录中</span><span class="n">make</span><span class="err">，会提示：</span>

<span class="p">[</span><span class="mi">100</span><span class="o">%</span><span class="p">]</span> <span class="n">Generating</span> <span class="n">doc</span><span class="o">/</span><span class="n">lsyncd</span><span class="mf">.1</span><span class="n">Updating</span> <span class="n">the</span> <span class="n">manpage</span>
<span class="nl">a2x</span><span class="p">:</span> <span class="nl">failed</span><span class="p">:</span> <span class="n">source</span> <span class="n">file</span> <span class="n">not</span> <span class="nl">found</span><span class="p">:</span> <span class="n">doc</span><span class="o">/</span><span class="n">lsyncd</span><span class="mf">.1</span><span class="p">.</span><span class="n">txt</span>
<span class="n">make</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">:</span> <span class="o">***</span> <span class="p">[</span><span class="n">doc</span><span class="o">/</span><span class="n">lsyncd</span><span class="mf">.1</span><span class="p">]</span> <span class="n">Error</span> <span class="mi">1</span><span class="n">make</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">:</span> <span class="o">***</span> <span class="p">[</span><span class="n">CMakeFiles</span><span class="o">/</span><span class="n">manpage</span><span class="p">.</span><span class="n">dir</span><span class="o">/</span><span class="n">all</span><span class="p">]</span> <span class="n">Error</span> <span class="mi">2</span><span class="nl">make</span><span class="p">:</span> <span class="o">***</span> <span class="p">[</span><span class="n">all</span><span class="p">]</span> <span class="n">Error</span> <span class="mi">2</span>
<span class="err">解决办法是要么直接在解压目录下</span><span class="n">cmake</span><span class="err">，不要</span><span class="n">mkdir</span> <span class="n">build</span><span class="err">，要么在</span><span class="n">CMakeList</span><span class="p">.</span><span class="n">txt</span><span class="err">中搜索</span><span class="n">doc</span><span class="err">字符串，在前面加上$</span><span class="p">{</span><span class="n">PROJECT_SOURCE_DIR</span><span class="p">}</span><span class="err">。</span>

<span class="mf">2.2</span> <span class="n">lsyncd</span><span class="p">.</span><span class="n">conf</span>
<span class="err">下面都是在编译安装的情况下操作。</span>

<span class="n">echo</span> <span class="mi">8192000</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">inotify</span><span class="o">/</span><span class="n">max_user_watches</span>  <span class="err">执行并写入</span><span class="n">rc</span><span class="p">.</span><span class="n">local</span>

<span class="mf">2.2.1</span> <span class="n">lsyncd</span><span class="err">同步配置</span>
<span class="cp"># cd /usr/local/lsyncd-2.1.5# mkdir etc var# vi etc/lsyncd.confsettings {</span>
    <span class="n">logfile</span>      <span class="o">=</span><span class="s">&quot;/usr/local/lsyncd-2.1.5/var/lsyncd.log&quot;</span><span class="p">,</span>
    <span class="n">statusFile</span>   <span class="o">=</span><span class="s">&quot;/usr/local/lsyncd-2.1.5/var/lsyncd.status&quot;</span><span class="p">,</span>
    <span class="n">inotifyMode</span>  <span class="o">=</span> <span class="s">&quot;CloseWrite&quot;</span><span class="p">,</span>
    <span class="n">maxProcesses</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
    <span class="o">--</span> <span class="n">nodaemon</span> <span class="o">=</span><span class="nb">true</span><span class="p">,</span>
    <span class="p">}</span>

<span class="n">sync</span> <span class="p">{</span>    <span class="k">default</span><span class="p">.</span><span class="n">rsync</span><span class="p">,</span>
    <span class="n">source</span>    <span class="o">=</span> <span class="s">&quot;/tmp/src&quot;</span><span class="p">,</span>
    <span class="n">target</span>    <span class="o">=</span> <span class="s">&quot;/tmp/dest&quot;</span><span class="p">,</span>
    <span class="o">--</span> <span class="n">excludeFrom</span> <span class="o">=</span> <span class="s">&quot;/etc/rsyncd.d/rsync_exclude.lst&quot;</span><span class="p">,</span>
    <span class="n">rsync</span>     <span class="o">=</span> <span class="p">{</span>
        <span class="n">binary</span>    <span class="o">=</span> <span class="s">&quot;/usr/bin/rsync&quot;</span><span class="p">,</span>
        <span class="n">archive</span>   <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
        <span class="n">compress</span>  <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
        <span class="n">verbose</span>   <span class="o">=</span> <span class="nb">true</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="err">到这启动</span> <span class="n">lsycnd</span> <span class="err">就可以完成实时同步了，默认的许多参数可以满足绝大部分需求，非常简单。</span>

<span class="mf">2.2.2</span> <span class="n">lsyncd</span><span class="p">.</span><span class="n">conf</span><span class="err">配置选项说明</span>
<span class="n">settings</span>
<span class="err">里面是全局设置，</span><span class="o">--</span><span class="err">开头表示注释，下面是几个常用选项说明：</span>

<span class="n">logfile</span> <span class="err">定义日志文件</span>
<span class="n">stausFile</span> <span class="err">定义状态文件</span>
<span class="n">nodaemon</span><span class="o">=</span><span class="nb">true</span> <span class="err">表示不启用守护模式，默认</span>
<span class="n">statusInterval</span> <span class="err">将</span><span class="n">lsyncd</span><span class="err">的状态写入上面的</span><span class="n">statusFile</span><span class="err">的间隔，默认</span><span class="mi">10</span><span class="err">秒</span>
<span class="n">inotifyMode</span> <span class="err">指定</span><span class="n">inotify</span><span class="err">监控的事件，默认是</span><span class="n">CloseWrite</span><span class="err">，还可以是</span><span class="n">Modify</span><span class="err">或</span><span class="n">CloseWrite</span> <span class="n">or</span> <span class="n">Modify</span>
<span class="n">maxProcesses</span> <span class="err">同步进程的最大个数。假如同时有</span><span class="mi">20</span><span class="err">个文件需要同步，而</span><span class="n">maxProcesses</span> <span class="o">=</span> <span class="mi">8</span><span class="err">，则最大能看到有</span><span class="mi">8</span><span class="err">个</span><span class="n">rysnc</span><span class="err">进程</span>
<span class="n">maxDelays</span> <span class="err">累计到多少所监控的事件激活一次同步，即使后面的</span><span class="n">delay</span><span class="err">延迟时间还未到</span>
<span class="n">sync</span>
<span class="err">里面是定义同步参数，可以继续使用</span><span class="n">maxDelays</span><span class="err">来重写</span><span class="n">settings</span><span class="err">的全局变量。一般第一个参数指定</span><span class="n">lsyncd</span><span class="err">以什么模式运行：</span><span class="n">rsync</span><span class="err">、</span>
<span class="n">rsyncssh</span><span class="err">、</span><span class="n">direct</span><span class="err">三种模式：</span>

<span class="k">default</span><span class="p">.</span><span class="n">rsync</span> <span class="err">：本地目录间同步，使用</span><span class="n">rsync</span><span class="err">，也可以达到使用</span><span class="n">ssh</span><span class="err">形式的远程</span><span class="n">rsync</span><span class="err">效果，或</span><span class="n">daemon</span><span class="err">方式连接远程</span><span class="n">rsyncd</span><span class="err">进程；</span>
<span class="k">default</span><span class="p">.</span><span class="n">direct</span> <span class="err">：本地目录间同步，使用</span><span class="n">cp</span><span class="err">、</span><span class="n">rm</span><span class="err">等命令完成差异文件备份；</span>
<span class="k">default</span><span class="p">.</span><span class="n">rsyncssh</span> <span class="err">：同步到远程主机目录，</span><span class="n">rsync</span><span class="err">的</span><span class="n">ssh</span><span class="err">模式，需要使用</span><span class="n">key</span><span class="err">来认证</span>
<span class="n">source</span> <span class="err">同步的源目录，使用绝对路径。</span>
<span class="n">target</span> <span class="err">定义目的地址</span><span class="p">.</span><span class="err">对应不同的模式有几种写法：</span>
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">dest</span> <span class="err">：本地目录同步，可用于</span><span class="n">direct</span><span class="err">和</span><span class="n">rsync</span><span class="err">模式</span>
<span class="mf">172.29.88.223</span><span class="o">:/</span><span class="n">tmp</span><span class="o">/</span><span class="n">dest</span> <span class="err">：同步到远程服务器目录，可用于</span><span class="n">rsync</span><span class="err">和</span><span class="n">rsyncssh</span><span class="err">模式，拼接的命令类似于</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">rsync</span> <span class="o">-</span><span class="n">ltsd</span> <span class="o">--</span><span class="n">delete</span> 
<span class="o">--</span><span class="n">include</span><span class="o">-</span><span class="n">from</span><span class="o">=-</span> <span class="o">--</span><span class="n">exclude</span><span class="o">=*</span> <span class="n">SOURCE</span> <span class="n">TARGET</span><span class="err">，剩下的就是</span><span class="n">rsync</span><span class="err">的内容了，比如指定</span><span class="n">username</span><span class="err">，免密码同步</span>
<span class="mf">172.29.88.223</span><span class="o">::</span><span class="n">module</span> <span class="err">：同步到远程服务器目录，用于</span><span class="n">rsync</span><span class="err">模式</span>
<span class="err">三种模式的示例会在后面给出。</span>
<span class="n">init</span> <span class="err">这是一个优化选项，当</span><span class="n">init</span> <span class="o">=</span> <span class="nb">false</span><span class="err">，只同步进程启动以后发生改动事件的文件，原有的目录即使有差异也不会同步。默认是</span><span class="nb">true</span>
<span class="n">delay</span> <span class="err">累计事件，等待</span><span class="n">rsync</span><span class="err">同步延时时间，默认</span><span class="mi">15</span><span class="err">秒（最大累计到</span><span class="mi">1000</span><span class="err">个不可合并的事件）。也就是</span><span class="mi">15</span><span class="n">s</span><span class="err">内监控目录下发生的改动，会累积到一次</span>
<span class="n">rsync</span><span class="err">同步，避免过于频繁的同步。（可合并的意思是，</span><span class="mi">15</span><span class="n">s</span><span class="err">内两次修改了同一文件，最后只同步最新的文件）</span>
<span class="n">excludeFrom</span> <span class="err">排除选项，后面指定排除的列表文件，如</span><span class="n">excludeFrom</span> <span class="o">=</span> <span class="s">&quot;/etc/lsyncd.exclude&quot;</span><span class="err">，如果是简单的排除，可以使用</span><span class="n">exclude</span> <span class="o">=</span> <span class="n">LIST</span><span class="err">。</span>
<span class="err">这里的排除规则写法与原生</span><span class="n">rsync</span><span class="err">有点不同，更为简单：</span>
<span class="err">监控路径里的任何部分匹配到一个文本，都会被排除，例如</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">foo</span><span class="o">/</span><span class="n">bar</span><span class="err">可以匹配规则</span><span class="n">foo</span>
<span class="err">如果规则以斜线</span><span class="o">/</span><span class="err">开头，则从头开始要匹配全部</span>
<span class="err">如果规则以</span><span class="o">/</span><span class="err">结尾，则要匹配监控路径的末尾</span>
<span class="o">?</span><span class="err">匹配任何字符，但不包括</span><span class="o">/</span>
<span class="o">*</span><span class="err">匹配</span><span class="mi">0</span><span class="err">或多个字符，但不包括</span><span class="o">/</span>
<span class="o">**</span><span class="err">匹配</span><span class="mi">0</span><span class="err">或多个字符，可以是</span><span class="o">/</span>
<span class="n">delete</span> <span class="err">为了保持</span><span class="n">target</span><span class="err">与</span><span class="n">souce</span><span class="err">完全同步</span><span class="p">,</span><span class="err">双向同步时改为</span><span class="nb">false</span><span class="err">，</span><span class="n">Lsyncd</span><span class="err">默认会</span><span class="n">delete</span> <span class="o">=</span> <span class="nb">true</span><span class="err">来允许同步删除。它除了</span><span class="nb">false</span><span class="err">，还有</span><span class="n">startup</span>
<span class="err">、</span><span class="n">running</span><span class="err">值，请参考</span> <span class="n">Lsyncd</span> <span class="mf">2.1</span><span class="p">.</span><span class="n">x</span> <span class="err">‖</span> <span class="n">Layer</span> <span class="mi">4</span> <span class="n">Config</span> <span class="err">‖</span> <span class="n">Default</span> <span class="n">Behavior</span><span class="err">。</span>
<span class="n">rsync</span>
<span class="err">（提示一下，</span><span class="n">delete</span><span class="err">和</span><span class="n">exclude</span><span class="err">本来都是</span><span class="n">rsync</span><span class="err">的选项，上面是配置在</span><span class="n">sync</span><span class="err">中的，我想这样做的原因是为了减少</span><span class="n">rsync</span><span class="err">的开销）</span>

<span class="n">bwlimit</span> <span class="err">限速，单位</span><span class="n">kb</span><span class="o">/</span><span class="n">s</span><span class="err">，与</span><span class="n">rsync</span><span class="err">相同（这么重要的选项在文档里竟然没有标出）</span>
<span class="n">compress</span> <span class="err">压缩传输默认为</span><span class="nb">true</span><span class="err">。在带宽与</span><span class="n">cpu</span><span class="err">负载之间权衡，本地目录同步可以考虑把它设为</span><span class="nb">false</span>
<span class="n">perms</span> <span class="err">默认保留文件权限。</span>
<span class="err">其它</span><span class="n">rsync</span><span class="err">的选项</span>
<span class="err">其它还有</span><span class="n">rsyncssh</span><span class="err">模式独有的配置项，如</span><span class="n">host</span><span class="err">、</span><span class="n">targetdir</span><span class="err">、</span><span class="n">rsync_path</span><span class="err">、</span><span class="n">password_file</span><span class="err">，见后文示例。</span><span class="n">rsyncOps</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;-avz&quot;</span><span class="p">,</span><span class="s">&quot;--delete&quot;</span><span class="p">}</span>
<span class="err">这样的写法在</span><span class="mf">2.1</span><span class="p">.</span><span class="o">*</span><span class="err">版本已经不支持。</span>

<span class="n">lsyncd</span><span class="p">.</span><span class="n">conf</span><span class="err">可以有多个</span><span class="n">sync</span><span class="err">，各自的</span><span class="n">source</span><span class="err">，各自的</span><span class="n">target</span><span class="err">，各自的模式，互不影响。</span>

<span class="mf">2.3</span> <span class="err">启动</span><span class="n">lsyncd</span>
<span class="err">使用命令加载配置文件，启动守护进程，自动同步目录操作。</span>

<span class="n">lsyncd</span> <span class="o">-</span><span class="n">log</span> <span class="n">Exec</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lsyncd</span><span class="o">-</span><span class="mf">2.1.5</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">lsyncd</span><span class="p">.</span><span class="n">conf</span>
<span class="mf">2.4</span> <span class="n">lsyncd</span><span class="p">.</span><span class="n">conf</span><span class="err">其它模式示例</span>
<span class="err">以下配置本人都已经过验证可行，必须根据实际需要裁剪配置：</span>

<span class="n">settings</span> <span class="p">{</span>
    <span class="n">logfile</span> <span class="o">=</span><span class="s">&quot;/usr/local/lsyncd-2.1.5/var/lsyncd.log&quot;</span><span class="p">,</span>
    <span class="n">statusFile</span> <span class="o">=</span><span class="s">&quot;/usr/local/lsyncd-2.1.5/var/lsyncd.status&quot;</span><span class="p">,</span>
    <span class="n">inotifyMode</span> <span class="o">=</span> <span class="s">&quot;CloseWrite&quot;</span><span class="p">,</span>
    <span class="n">maxProcesses</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="p">}</span>


<span class="o">--</span> <span class="n">I</span><span class="p">.</span> <span class="err">本地目录同步，</span><span class="n">direct</span><span class="err">：</span><span class="n">cp</span><span class="o">/</span><span class="n">rm</span><span class="o">/</span><span class="n">mv</span><span class="err">。</span> <span class="err">适用：</span><span class="mi">500</span><span class="o">+</span><span class="err">万文件，变动不大</span>
<span class="n">sync</span> <span class="p">{</span>    <span class="k">default</span><span class="p">.</span><span class="n">direct</span><span class="p">,</span>
    <span class="n">source</span>    <span class="o">=</span> <span class="s">&quot;/tmp/src&quot;</span><span class="p">,</span>
    <span class="n">target</span>    <span class="o">=</span> <span class="s">&quot;/tmp/dest&quot;</span><span class="p">,</span>
    <span class="n">delay</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">maxProcesses</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="p">}</span>

<span class="o">--</span> <span class="n">II</span><span class="p">.</span> <span class="err">本地目录同步，</span><span class="n">rsync</span><span class="err">模式：</span><span class="n">rsync</span>
<span class="n">sync</span> <span class="p">{</span>    <span class="k">default</span><span class="p">.</span><span class="n">rsync</span><span class="p">,</span>
    <span class="n">source</span>    <span class="o">=</span> <span class="s">&quot;/tmp/src&quot;</span><span class="p">,</span>
    <span class="n">target</span>    <span class="o">=</span> <span class="s">&quot;/tmp/dest1&quot;</span><span class="p">,</span>
    <span class="n">excludeFrom</span> <span class="o">=</span> <span class="s">&quot;/etc/rsyncd.d/rsync_exclude.lst&quot;</span><span class="p">,</span>
    <span class="n">rsync</span>     <span class="o">=</span> <span class="p">{</span>
        <span class="n">binary</span> <span class="o">=</span> <span class="s">&quot;/usr/bin/rsync&quot;</span><span class="p">,</span>
        <span class="n">archive</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
        <span class="n">compress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
        <span class="n">bwlimit</span>   <span class="o">=</span> <span class="mi">2000</span>
        <span class="p">}</span> 
    <span class="p">}</span>

<span class="o">--</span> <span class="n">III</span><span class="p">.</span> <span class="err">远程目录同步，</span><span class="n">rsync</span><span class="err">模式</span> <span class="o">+</span> <span class="n">rsyncd</span> <span class="n">daemon</span>
<span class="n">sync</span> <span class="p">{</span>    <span class="k">default</span><span class="p">.</span><span class="n">rsync</span><span class="p">,</span>
    <span class="n">source</span>    <span class="o">=</span> <span class="s">&quot;/tmp/src&quot;</span><span class="p">,</span>
    <span class="n">target</span>    <span class="o">=</span> <span class="s">&quot;syncuser@172.29.88.223::module1&quot;</span><span class="p">,</span>    <span class="n">delete</span><span class="o">=</span><span class="s">&quot;running&quot;</span><span class="p">,</span>
    <span class="n">exclude</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;.*&quot;</span><span class="p">,</span> <span class="s">&quot;.tmp&quot;</span> <span class="p">},</span>
    <span class="n">delay</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
    <span class="n">init</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
    <span class="n">rsync</span>     <span class="o">=</span> <span class="p">{</span>
        <span class="n">binary</span> <span class="o">=</span> <span class="s">&quot;/usr/bin/rsync&quot;</span><span class="p">,</span>
        <span class="n">archive</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
        <span class="n">compress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
        <span class="n">verbose</span>   <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
        <span class="n">password_file</span> <span class="o">=</span> <span class="s">&quot;/etc/rsyncd.d/rsync.pwd&quot;</span><span class="p">,</span>
        <span class="n">_extra</span>    <span class="o">=</span> <span class="p">{</span><span class="s">&quot;--bwlimit=200&quot;</span><span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="o">--</span> <span class="n">IV</span><span class="p">.</span> <span class="err">远程目录同步，</span><span class="n">rsync</span><span class="err">模式</span> <span class="o">+</span> <span class="n">ssh</span> <span class="n">shell</span>
<span class="n">sync</span> <span class="p">{</span>    <span class="k">default</span><span class="p">.</span><span class="n">rsync</span><span class="p">,</span>
    <span class="n">source</span>    <span class="o">=</span> <span class="s">&quot;/tmp/src&quot;</span><span class="p">,</span>
    <span class="n">target</span>    <span class="o">=</span> <span class="s">&quot;172.29.88.223:/tmp/dest&quot;</span><span class="p">,</span>
    <span class="o">--</span> <span class="n">target</span>    <span class="o">=</span> <span class="s">&quot;root@172.29.88.223:/remote/dest&quot;</span><span class="p">,</span>
    <span class="o">--</span> <span class="err">上面</span><span class="n">target</span><span class="err">，注意如果是普通用户，必须拥有写权限</span>
    <span class="n">maxDelays</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">delay</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
    <span class="o">--</span> <span class="n">init</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
    <span class="n">rsync</span>     <span class="o">=</span> <span class="p">{</span>
        <span class="n">binary</span> <span class="o">=</span> <span class="s">&quot;/usr/bin/rsync&quot;</span><span class="p">,</span>
        <span class="n">archive</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
        <span class="n">compress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
        <span class="n">bwlimit</span>   <span class="o">=</span> <span class="mi">2000</span>
        <span class="o">--</span> <span class="n">rsh</span> <span class="o">=</span> <span class="s">&quot;/usr/bin/ssh -p 22 -o StrictHostKeyChecking=no&quot;</span>
        <span class="o">--</span> <span class="err">如果要指定其它端口，请用上面的</span><span class="n">rsh</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="o">--</span> <span class="n">V</span><span class="p">.</span> <span class="err">远程目录同步，</span><span class="n">rsync</span><span class="err">模式</span> <span class="o">+</span> <span class="n">rsyncssh</span><span class="err">，效果与上面相同</span>
<span class="n">sync</span> <span class="p">{</span>    <span class="k">default</span><span class="p">.</span><span class="n">rsyncssh</span><span class="p">,</span>
    <span class="n">source</span>    <span class="o">=</span> <span class="s">&quot;/tmp/src2&quot;</span><span class="p">,</span>
    <span class="n">host</span>      <span class="o">=</span> <span class="s">&quot;172.29.88.223&quot;</span><span class="p">,</span>
    <span class="n">targetdir</span> <span class="o">=</span> <span class="s">&quot;/remote/dir&quot;</span><span class="p">,</span>
    <span class="n">excludeFrom</span> <span class="o">=</span> <span class="s">&quot;/etc/rsyncd.d/rsync_exclude.lst&quot;</span><span class="p">,</span>
    <span class="o">--</span> <span class="n">maxDelays</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="o">--</span> <span class="n">init</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
    <span class="n">rsync</span>    <span class="o">=</span> <span class="p">{</span>
        <span class="n">binary</span> <span class="o">=</span> <span class="s">&quot;/usr/bin/rsync&quot;</span><span class="p">,</span>
        <span class="n">archive</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
        <span class="n">compress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
        <span class="n">verbose</span>   <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
        <span class="n">_extra</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;--bwlimit=2000&quot;</span><span class="p">},</span>
        <span class="p">},</span>
    <span class="n">ssh</span>      <span class="o">=</span> <span class="p">{</span>
        <span class="n">port</span>  <span class="o">=</span>  <span class="mi">1234</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="err">上面的内容几乎涵盖了所有同步的模式，其中第</span><span class="n">III</span><span class="err">个要求像</span><span class="n">rsync</span><span class="err">一样配置</span><span class="n">rsyncd</span><span class="err">服务端，见本文开头。第</span><span class="n">IV</span><span class="err">、</span><span class="n">V</span><span class="err">配置</span><span class="n">ssh</span><span class="err">方式同步，达到的效果</span>
<span class="err">相同，但实际同步时你会发现每次同步都会提示输入</span><span class="n">ssh</span><span class="err">的密码，可以通过以下方法解决：</span>

<span class="err">在远端被同步的服务器上开启</span><span class="n">ssh</span><span class="err">无密码登录，请注意用户身份：</span>

<span class="n">user</span><span class="err">$</span> <span class="n">ssh</span><span class="o">-</span><span class="n">keygen</span> <span class="o">-</span><span class="n">t</span> <span class="n">rsa</span>
<span class="err">一路回车</span><span class="p">...</span>
<span class="n">user</span><span class="err">$</span> <span class="n">cd</span> <span class="o">~/</span><span class="p">.</span><span class="n">ssh</span>
<span class="n">user</span><span class="err">$</span> <span class="n">cat</span> <span class="n">id_rsa</span><span class="p">.</span><span class="n">pub</span> <span class="o">&gt;&gt;</span> <span class="n">authorized_keys</span>
<span class="err">把</span><span class="n">id_rsa</span><span class="err">私钥拷贝到执行</span><span class="n">lsyncd</span><span class="err">的机器上</span>

<span class="n">user</span><span class="err">$</span> <span class="n">chmod</span> <span class="mi">600</span> <span class="o">~/</span><span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">id_rsa</span>
<span class="err">测试能否无密码登录</span>
<span class="n">user</span><span class="err">$</span> <span class="n">ssh</span> <span class="n">user</span><span class="mf">@172.29.88.223</span>
<span class="mf">3.</span> <span class="n">lsyncd</span><span class="err">的其它功能</span>
<span class="n">lsyncd</span><span class="err">的功能不仅仅是同步，官方手册</span> <span class="n">Lsyncd</span> <span class="mf">2.1</span><span class="p">.</span><span class="n">x</span> <span class="err">‖</span> <span class="n">Layer</span> <span class="mi">2</span> <span class="n">Config</span> <span class="err">‖</span> <span class="n">Advanced</span> <span class="n">onAction</span> <span class="err">高级功能提到，还可以监控某个目录下的</span>
<span class="err">文件，根据触发的事件自己定义要执行的命令，</span><span class="n">example</span><span class="err">是监控某个某个目录，只要是有</span><span class="n">jpg</span><span class="err">、</span><span class="n">gif</span><span class="err">、</span><span class="n">png</span><span class="err">格式的文件参数，就把它们转成</span><span class="n">pdf</span><span class="err">，</span>
<span class="err">然后同步到另一个目录。正好在我运维的一个项目中有这个需求，现在都是在</span><span class="n">java</span><span class="err">代码里转换，还容易出现异常，通过</span><span class="n">lsyncd</span><span class="err">可以代替这样的</span>
<span class="err">功能。但，门槛在于要会一点点</span><span class="n">lua</span><span class="err">语言（根据官方</span><span class="n">example</span><span class="err">还是可以写出来）。</span>

<span class="err">另外偶然想到个问题，同时设置了</span><span class="n">maxDelays</span><span class="err">和</span><span class="n">delay</span><span class="err">，当监控目录一直没有文件变化了，也会发生同步操作，虽然没有可</span><span class="n">rsync</span><span class="err">的文件。</span>

<span class="n">TO</span><span class="o">-</span><span class="n">DO</span><span class="err">：</span>

<span class="err">其它同步工具：</span><span class="n">csync2</span><span class="err">，</span><span class="n">clsync</span><span class="err">，</span><span class="n">btsync</span><span class="err">，</span><span class="n">drdb</span> <span class="err">。</span>
<span class="n">lsyncd</span><span class="err">双向同步：</span><span class="n">GlusterFS</span>
</pre></div>


<h2 id="inotify_sync">inotify_sync</h2>
<div class="codehilite"><pre><span></span><span class="err">当</span><span class="n">web</span><span class="err">文件越来越多</span><span class="p">(</span><span class="err">百万级数量</span><span class="n">html</span><span class="p">,</span><span class="n">jpg</span><span class="err">等小</span> <span class="err">文件</span><span class="p">)</span><span class="err">，同步就越来越慢，根本做不到实时，按照网上的调优方法都尝试过，问题根本没有解决。</span>
<span class="err">经过我一翻细致研究，终于把慢的核心问题研究明白，先总结一句</span> <span class="n">inotifywait</span><span class="err">响应不会有延迟，</span><span class="n">rsync</span><span class="err">也很快。大家同样有慢的烦恼，</span>
<span class="err">那是因为网上的</span><span class="n">inotify</span><span class="o">+</span><span class="n">rsync</span><span class="err">的教程都是坑。下面我们来分</span> <span class="err">析。</span>
<span class="n">inotifywait</span> <span class="err">单独分析</span>

<span class="mi">1</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">inotifywait</span> <span class="o">-</span><span class="n">mrq</span> <span class="o">--</span><span class="n">format</span> <span class="err">&#39;</span><span class="o">%</span><span class="n">Xe</span> <span class="o">%</span><span class="n">w</span><span class="o">%</span><span class="n">f</span><span class="err">&#39;</span> <span class="o">-</span><span class="n">e</span> <span class="n">modify</span><span class="p">,</span><span class="n">create</span><span class="p">,</span><span class="n">delete</span><span class="p">,</span><span class="n">attrib</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span>
<span class="err">执行上面命令，是让</span><span class="n">inotifywait</span><span class="err">监听</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="err">目录，当监听到有发生</span><span class="n">modify</span><span class="p">,</span><span class="n">create</span><span class="p">,</span><span class="n">delete</span><span class="p">,</span><span class="n">attrib</span><span class="err">等事件发生时，按</span><span class="o">%</span><span class="n">Xe</span> <span class="o">%</span><span class="n">w</span><span class="o">%</span><span class="n">f</span><span class="err">的格式输出。</span>
<span class="err">在</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="err">目录</span><span class="n">touch</span><span class="err">几个文件</span>

<span class="mi">1</span>
<span class="n">touch</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="p">{</span><span class="mf">1..5</span><span class="p">}</span>
<span class="err">观看</span><span class="n">inotify</span><span class="err">输出</span>


<span class="n">ATTRIB</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">1</span>           <span class="o">--</span> <span class="err">表示发生了</span><span class="n">ATTRIB</span><span class="err">事件</span> <span class="err">路径为</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">1</span>
<span class="n">ATTRIB</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">2</span>
<span class="n">ATTRIB</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">3</span>
<span class="n">ATTRIB</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">4</span>
<span class="n">ATTRIB</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="mi">5</span>
<span class="err">知道上面的输出效果之后</span> <span class="err">我们应该想得到，可以用</span><span class="n">rsync</span><span class="err">获取</span><span class="n">inotifywait</span><span class="err">监控到的文件列表来做指定的文件同步，而不是每次都由</span><span class="n">rsync</span>
<span class="err">做全目录扫描来判断文件是否存在差异。</span>
<span class="err">网上的</span><span class="n">inotify</span><span class="o">+</span><span class="n">rsync</span><span class="err">分析</span>
<span class="err">我们来看网上的教程，我加了注释。</span><span class="p">(</span><span class="err">网上所有的教程基本都一模一样，尽管写法不一样，致命点都是一样的</span><span class="p">)</span>


<span class="cp">#!/bin/bash </span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">inotifywait</span> <span class="o">-</span><span class="n">mrq</span> <span class="o">--</span><span class="n">format</span> <span class="err">&#39;</span><span class="o">%</span><span class="n">w</span><span class="o">%</span><span class="n">f</span><span class="err">&#39;</span><span class="o">-</span><span class="n">e</span> <span class="n">create</span><span class="p">,</span><span class="n">close_write</span><span class="p">,</span><span class="n">delete</span> <span class="o">/</span><span class="n">backup</span> <span class="o">|</span><span class="k">while</span> <span class="n">read</span> <span class="n">file</span>
<span class="cp">#把发生更改的文件列表都接收到file 然后循环，但有什么鬼用呢？下面的命令都没有引用这个$file 下面做的是全量rsync</span>
<span class="k">do</span> 
    <span class="n">cd</span> <span class="o">/</span><span class="n">backup</span> <span class="o">&amp;&amp;</span> <span class="n">rsync</span> <span class="o">-</span><span class="n">az</span> <span class="o">--</span><span class="n">delete</span> <span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="n">rsync_backup</span><span class="mf">@192.168.24.101</span><span class="o">::</span><span class="n">backup</span><span class="o">/--</span><span class="n">password</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsync</span><span class="p">.</span><span class="n">password</span> 
<span class="n">done</span>
<span class="cp">#注意看 这里的rsync 每次都是全量的同步(这就坑爹了)，而且 file列表是循环形式触发rsync ，等于有10个文件发生更改，就触发10次</span>
<span class="n">rsync</span><span class="err">全量同步</span><span class="p">(</span><span class="err">简直就是噩梦</span><span class="p">)</span><span class="err">，那还不如直接写个死循环的</span><span class="n">rsync</span><span class="err">全量同步得了。</span>
<span class="cp">#有很多人会说 日志输出那里明明只有差异文件的同步记录。其实这是rsync的功能，他本来就只会输出有差异需要同步的文件信息。</span>
<span class="err">不信你直接拿这句</span><span class="n">rsync</span><span class="err">来跑试试。</span>
<span class="cp">#这种在需要同步的源目录文件量很大的情况下，简直是不堪重负。不仅耗CPU还耗时，根本不可以做到实时同步。</span>
<span class="err">改良方法</span>
<span class="err">要做到实时，就必须要减少</span><span class="n">rsync</span><span class="err">对目录的递归扫描判断，尽可能的做到只同步</span><span class="n">inotify</span><span class="err">监控到已发生更改的文件。结合</span><span class="n">rsync</span><span class="err">的特性，</span>
<span class="err">所以这里要分开判断来实现一个目录的增删改查对应的操作。</span>
<span class="err">脚本如下</span>


<span class="cp">#!/bin/bash</span>
<span class="n">src</span><span class="o">=/</span><span class="n">data</span><span class="o">/</span>                          <span class="err">#</span> <span class="err">需要同步的源路径</span>
<span class="n">des</span><span class="o">=</span><span class="n">data</span>                             <span class="err">#</span> <span class="err">目标服务器上</span> <span class="n">rsync</span> <span class="o">--</span><span class="n">daemon</span> <span class="err">发布的名称，</span><span class="n">rsync</span> <span class="o">--</span><span class="n">daemon</span><span class="err">这里就不做介绍了，</span>
<span class="err">网上搜一下，比较简单。</span>
<span class="n">rsync_passwd_file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsyncd</span><span class="p">.</span><span class="n">passwd</span>            <span class="err">#</span> <span class="n">rsync</span><span class="err">验证的密码文件</span>
<span class="n">ip1</span><span class="o">=</span><span class="mf">192.168.0.18</span>                     <span class="err">#</span> <span class="err">目标服务器</span><span class="mi">1</span>
<span class="n">ip2</span><span class="o">=</span><span class="mf">192.168.0.19</span>                     <span class="err">#</span> <span class="err">目标服务器</span><span class="mi">2</span>
<span class="n">user</span><span class="o">=</span><span class="n">root</span>                            <span class="err">#</span> <span class="n">rsync</span> <span class="o">--</span><span class="n">daemon</span><span class="err">定义的验证用户名</span>
<span class="n">cd</span> <span class="err">$</span><span class="p">{</span><span class="n">src</span><span class="p">}</span>                            <span class="err">#</span> <span class="err">此方法中，由于</span><span class="n">rsync</span><span class="err">同步的特性，这里必须要先</span><span class="n">cd</span><span class="err">到源目录，</span><span class="n">inotify</span><span class="err">再监听</span> <span class="p">.</span><span class="o">/</span> 
<span class="err">才能</span><span class="n">rsync</span><span class="err">同步后目录结构一致，有兴趣的同学可以进行各种尝试观看其效果</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">inotifywait</span> <span class="o">-</span><span class="n">mrq</span> <span class="o">--</span><span class="n">format</span> <span class="err">&#39;</span><span class="o">%</span><span class="n">Xe</span> <span class="o">%</span><span class="n">w</span><span class="o">%</span><span class="n">f</span><span class="err">&#39;</span> <span class="o">-</span><span class="n">e</span> <span class="n">modify</span><span class="p">,</span><span class="n">create</span><span class="p">,</span><span class="n">delete</span><span class="p">,</span><span class="n">attrib</span> <span class="p">.</span><span class="o">/</span> <span class="o">|</span> <span class="k">while</span> <span class="n">read</span> <span class="n">file</span>         
<span class="cp"># 把监控到有发生更改的&quot;文件路径列表&quot;循环</span>
<span class="k">do</span>

<span class="n">INO_EVENT</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">echo</span> <span class="err">$</span><span class="n">file</span> <span class="o">|</span> <span class="n">awk</span> <span class="err">&#39;</span><span class="p">{</span><span class="n">print</span> <span class="err">$</span><span class="mi">1</span><span class="p">}</span><span class="err">&#39;</span><span class="p">)</span> <span class="err">#</span> <span class="err">把</span><span class="n">inotify</span><span class="err">输出切割</span> <span class="err">把事件类型赋值给</span><span class="n">INO_EVENT</span>

<span class="n">INO_FILE</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">echo</span> <span class="err">$</span><span class="n">file</span> <span class="o">|</span> <span class="n">awk</span> <span class="err">&#39;</span><span class="p">{</span><span class="n">print</span> <span class="err">$</span><span class="mi">2</span><span class="p">}</span><span class="err">&#39;</span><span class="p">)</span> <span class="err">#</span> <span class="err">把</span><span class="n">inotify</span><span class="err">输出切割</span> <span class="err">把文件路径赋值给</span><span class="n">INO_FILE</span>

<span class="n">echo</span> <span class="err">&#39;</span><span class="o">------------------------------------</span><span class="err">&#39;</span>

<span class="n">echo</span> <span class="err">$</span><span class="n">file</span>

<span class="cp">#增加、修改事件</span>

<span class="cp">#增、改放在同一个判断，因为他们都肯定是针对文件的操作，即使是新建目录，要同步的也只是一个空目录，不会影响速度。</span>
<span class="k">if</span> <span class="p">[[</span> <span class="err">$</span><span class="n">INO_EVENT</span> <span class="o">=~</span> <span class="err">&#39;</span><span class="n">CREATE</span><span class="err">&#39;</span> <span class="p">]]</span> <span class="o">||</span> <span class="p">[[</span> <span class="err">$</span><span class="n">INO_EVENT</span> <span class="o">=~</span> <span class="err">&#39;</span><span class="n">MODIFY</span><span class="err">&#39;</span> <span class="p">]]</span> <span class="err">#</span> <span class="err">判断事件类型</span>
<span class="n">then</span>
<span class="n">echo</span> <span class="err">&#39;</span><span class="n">CREATE</span> <span class="n">or</span> <span class="n">MODIFY</span><span class="err">&#39;</span>
<span class="n">rsync</span> <span class="o">-</span><span class="n">avzR</span> <span class="o">--</span><span class="n">password</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsync</span><span class="o">-</span> <span class="n">client</span><span class="p">.</span><span class="n">pass</span> <span class="err">$</span><span class="p">{</span><span class="n">INO_FILE</span><span class="p">}</span> <span class="err">$</span><span class="p">{</span><span class="n">user</span><span class="p">}@</span><span class="err">$</span><span class="p">{</span><span class="n">ip1</span><span class="p">}</span><span class="o">::</span><span class="err">$</span><span class="p">{</span><span class="n">des</span><span class="p">}</span> <span class="o">&amp;&amp;</span><span class="err">#</span> <span class="n">INO_FILE</span> <span class="err">变量代表路径哦</span>
<span class="n">rsync</span> <span class="o">-</span><span class="n">avzR</span> <span class="o">--</span><span class="n">password</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsync</span><span class="o">-</span><span class="n">client</span><span class="p">.</span><span class="n">pass</span> <span class="err">$</span><span class="p">{</span><span class="n">INO_FILE</span><span class="p">}</span> <span class="err">$</span><span class="p">{</span><span class="n">user</span><span class="p">}@</span><span class="err">$</span><span class="p">{</span><span class="n">ip2</span><span class="p">}</span><span class="o">::</span><span class="err">$</span><span class="p">{</span><span class="n">des</span><span class="p">}</span>
<span class="cp">#仔细看 上面的rsync同步命令 源是用了${INO_FILE}变量 即每次只针对性的同步发生改变的文件 然后用-R参数把源的目录结构递归到目标</span>
<span class="err">后面</span> <span class="err">保证目录结构一致性</span>

<span class="n">fi</span>

<span class="cp">#删除事件</span>

<span class="k">if</span> <span class="p">[[</span> <span class="err">$</span><span class="n">INO_EVENT</span> <span class="o">=~</span> <span class="err">&#39;</span><span class="n">DELETE</span><span class="err">&#39;</span> <span class="p">]]</span>

<span class="n">then</span>

<span class="n">echo</span> <span class="err">&#39;</span><span class="n">DELETE</span><span class="err">&#39;</span>

<span class="n">rsync</span> <span class="o">-</span><span class="n">avzR</span> <span class="o">--</span><span class="n">delete</span> <span class="o">--</span><span class="n">password</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsync</span><span class="o">-</span><span class="n">client</span><span class="p">.</span><span class="n">pass</span> <span class="err">$</span><span class="p">(</span><span class="n">dirname</span> <span class="err">$</span><span class="p">{</span><span class="n">INO_FILE</span><span class="p">})</span> <span class="err">$</span><span class="p">{</span><span class="n">user</span><span class="p">}@</span><span class="err">$</span><span class="p">{</span><span class="n">ip1</span><span class="p">}</span><span class="o">::</span><span class="err">$</span><span class="p">{</span><span class="n">des</span><span class="p">}</span> <span class="o">&amp;&amp;</span>

<span class="n">rsync</span> <span class="o">-</span><span class="n">avzR</span> <span class="o">--</span><span class="n">delete</span> <span class="o">--</span><span class="n">password</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsync</span><span class="o">-</span><span class="n">client</span><span class="p">.</span><span class="n">pass</span> <span class="err">$</span><span class="p">(</span><span class="n">dirname</span> <span class="err">$</span><span class="p">{</span><span class="n">INO_FILE</span><span class="p">})</span> <span class="err">$</span><span class="p">{</span><span class="n">user</span><span class="p">}@</span><span class="err">$</span><span class="p">{</span><span class="n">ip2</span><span class="p">}</span><span class="o">::</span><span class="err">$</span><span class="p">{</span><span class="n">des</span><span class="p">}</span>

<span class="cp">#看rsync命令 如果直接同步已删除的路径${INO_FILE}会报no such or directory错误 所以这里同步的源是被删文件或目录的上一级路径，</span>
<span class="err">并加上</span><span class="o">--</span><span class="n">delete</span><span class="err">来删除目标上有而源中没有的文件，这里不能做到指定文件删除，如果删除的路径越靠</span> <span class="err">近根，则同步的目录月多，同步删除的</span>
<span class="err">操作就越花时间。这里有更好方法的同学，欢迎交流。</span>

<span class="n">fi</span>

<span class="cp">#修改属性事件 指 touch chgrp chmod chown等操作</span>

<span class="k">if</span> <span class="p">[[</span> <span class="err">$</span><span class="n">INO_EVENT</span> <span class="o">=~</span> <span class="err">&#39;</span><span class="n">ATTRIB</span><span class="err">&#39;</span> <span class="p">]]</span>

<span class="n">then</span>

<span class="n">echo</span> <span class="err">&#39;</span><span class="n">ATTRIB</span><span class="err">&#39;</span>

<span class="k">if</span> <span class="p">[</span> <span class="o">!</span> <span class="o">-</span><span class="n">d</span> <span class="s">&quot;$INO_FILE&quot;</span> <span class="p">]</span> <span class="err">#</span> <span class="err">如果修改属性的是目录</span> <span class="err">则不同步，因为同步目录会发生递归扫描，等此目录下的文件发生同步时，</span><span class="n">rsync</span><span class="err">会</span>
<span class="err">顺带更新此目录。</span>

<span class="n">then</span>

<span class="n">rsync</span> <span class="o">-</span><span class="n">avzR</span> <span class="o">--</span><span class="n">password</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsync</span><span class="o">-</span><span class="n">client</span><span class="p">.</span><span class="n">pass</span> <span class="err">$</span><span class="p">{</span><span class="n">INO_FILE</span><span class="p">}</span> <span class="err">$</span><span class="p">{</span><span class="n">user</span><span class="p">}@</span><span class="err">$</span><span class="p">{</span><span class="n">ip1</span><span class="p">}</span><span class="o">::</span><span class="err">$</span><span class="p">{</span><span class="n">des</span><span class="p">}</span> <span class="o">&amp;&amp;</span>

<span class="n">rsync</span> <span class="o">-</span><span class="n">avzR</span> <span class="o">--</span><span class="n">password</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsync</span><span class="o">-</span><span class="n">client</span><span class="p">.</span><span class="n">pass</span> <span class="err">$</span><span class="p">{</span><span class="n">INO_FILE</span><span class="p">}</span> <span class="err">$</span><span class="p">{</span><span class="n">user</span><span class="p">}@</span><span class="err">$</span><span class="p">{</span><span class="n">ip2</span><span class="p">}</span><span class="o">::</span><span class="err">$</span><span class="p">{</span><span class="n">des</span><span class="p">}</span>

<span class="n">fi</span>

<span class="n">fi</span>
<span class="n">done</span>
<span class="err">每两小时做</span><span class="mi">1</span><span class="err">次全量同步</span>
<span class="err">因为</span><span class="n">inotify</span><span class="err">只在启动时会监控目录，他没有启动期间的文件发生更改，他是不知道的，所以这里每</span><span class="mi">2</span><span class="err">个小时做</span><span class="mi">1</span><span class="err">次全量同步，防止各种意外遗漏</span>
<span class="err">，保证目录一致。</span>

<span class="mi">1</span>
<span class="mi">2</span>
<span class="n">crontab</span> <span class="o">-</span><span class="n">e</span>
<span class="o">*</span> <span class="err">*/</span><span class="mi">2</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="n">rsync</span> <span class="o">-</span><span class="n">avz</span> <span class="o">--</span><span class="n">password</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsync</span><span class="o">-</span><span class="n">client</span><span class="p">.</span><span class="n">pass</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span> <span class="n">root</span><span class="mf">@192.168.0.18</span><span class="o">::</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="n">rsync</span> <span class="o">-</span><span class="n">avz</span> 
<span class="o">--</span><span class="n">password</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsync</span><span class="o">-</span><span class="n">client</span><span class="p">.</span><span class="n">pass</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span> <span class="n">root</span><span class="mf">@192.168.0.19</span><span class="o">::</span><span class="n">data</span>
<span class="err">改良后我们公司这种百万级小文件也能做到实施同步了。</span>
<span class="err">下面附上</span><span class="n">inotify</span><span class="err">的参数说明</span>
<span class="n">inotify</span><span class="err">介绍</span><span class="o">--</span> <span class="err">是一种强大的、细颗粒的、异步的文件系统监控机制，</span><span class="o">*&amp;</span><span class="err">####</span><span class="o">&amp;*</span><span class="n">_0_</span><span class="o">*&amp;</span><span class="err">####</span><span class="o">&amp;*</span><span class="err">内核从</span><span class="mf">2.6.13</span><span class="err">起，加入</span><span class="n">Inotify</span><span class="err">可以监控</span>
<span class="err">文件系统中添加、删除、修改移动等各种事件，利用这个内核接口，就可以监控文件系统下文件的各种变化情况。</span>
<span class="n">inotifywait</span> <span class="err">参数说明</span>
<span class="err">参数名称</span>    <span class="err">参数说明</span>
<span class="o">-</span><span class="n">m</span><span class="p">,</span><span class="err">–</span><span class="n">monitor</span>    <span class="err">始终保持事件监听状态</span>
<span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="err">–</span><span class="n">recursive</span>    <span class="err">递归查询目录</span>
<span class="o">-</span><span class="n">q</span><span class="p">,</span><span class="err">–</span><span class="n">quiet</span>    <span class="err">只打印监控事件的信息</span>
<span class="err">–</span><span class="n">excludei</span>    <span class="err">排除文件或目录时，不区分大小写</span>
<span class="o">-</span><span class="n">t</span><span class="p">,</span><span class="err">–</span><span class="n">timeout</span>    <span class="err">超时时间</span>
<span class="err">–</span><span class="n">timefmt</span>    <span class="err">指定时间输出格式</span>
<span class="err">–</span><span class="n">format</span>    <span class="err">指定时间输出格式</span>
<span class="o">-</span><span class="n">e</span><span class="p">,</span><span class="err">–</span><span class="n">event</span>    <span class="err">后面指定删、增、改等事件</span>
<span class="n">inotifywait</span> <span class="n">events</span><span class="err">事件说明</span>
<span class="err">事件名称</span>    <span class="err">事件说明</span>
<span class="n">access</span>    <span class="err">读取文件或目录内容</span>
<span class="n">modify</span>    <span class="err">修改文件或目录内容</span>
<span class="n">attrib</span>    <span class="err">文件或目录的属性改变</span>
<span class="n">close_write</span>    <span class="err">修改真实文件内容</span>
<span class="n">close_nowrite</span>    
<span class="n">close</span>    
<span class="n">open</span>    <span class="err">文件或目录被打开</span>
<span class="n">moved_to</span>    <span class="err">文件或目录移动到</span>
<span class="n">moved_from</span>    <span class="err">文件或目录从移动</span>
<span class="n">move</span>    <span class="err">移动文件或目录移动到监视目录</span>
<span class="n">create</span>    <span class="err">在监视目录下创建文件或目录</span>
<span class="n">delete</span>    <span class="err">删除监视目录下的文件或目录</span>
<span class="n">delete_self</span>    
<span class="n">unmount</span>    <span class="err">卸载文件系统</span>
<span class="err">优化</span> <span class="n">Inotify</span>
<span class="cp"># 在/proc/sys/fs/inotify目录下有三个文件，对inotify机制有一定的限制</span>


<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">web</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">ll</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">inotify</span><span class="o">/</span>
<span class="err">总用量</span><span class="mi">0</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span><span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">09</span><span class="err">月</span><span class="mi">923</span><span class="o">:</span><span class="mi">36</span> <span class="n">max_queued_events</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span><span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">09</span><span class="err">月</span><span class="mi">923</span><span class="o">:</span><span class="mi">36</span> <span class="n">max_user_instances</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span><span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">09</span><span class="err">月</span><span class="mi">923</span><span class="o">:</span><span class="mi">36</span> <span class="n">max_user_watches</span>
<span class="o">-----------------------------</span>
<span class="n">max_user_watches</span> <span class="err">#设置</span><span class="n">inotifywait</span><span class="err">或</span><span class="n">inotifywatch</span><span class="err">命令可以监视的文件数量</span><span class="p">(</span><span class="err">单进程</span><span class="p">)</span>
<span class="n">max_user_instances</span> <span class="err">#设置每个用户可以运行的</span><span class="n">inotifywait</span><span class="err">或</span><span class="n">inotifywatch</span><span class="err">命令的进程数</span>
<span class="n">max_queued_events</span> <span class="err">#设置</span><span class="n">inotify</span><span class="err">实例事件</span><span class="p">(</span><span class="n">event</span><span class="p">)</span><span class="err">队列可容纳的事件数量</span>
<span class="o">----------------------------</span>

<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">web</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">echo</span> <span class="mi">50000000</span><span class="o">&gt;/</span><span class="n">proc</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">inotify</span><span class="o">/</span><span class="n">max_user_watches</span> <span class="o">--</span> <span class="err">把他加入</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc</span><span class="p">.</span><span class="n">local</span><span class="err">就可以实现每次重启都生效</span>
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">web</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">echo</span> <span class="mi">50000000</span><span class="o">&gt;/</span><span class="n">proc</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">inotify</span><span class="o">/</span><span class="n">max_queued_events</span>
</pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../shell/" title="shell" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                shell
              </span>
            </div>
          </a>
        
        
          <a href="../filesystem/" title="filesystem" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                filesystem
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>