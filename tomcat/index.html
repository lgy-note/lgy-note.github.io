



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>tomcat - mkdocs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.30686662.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#java" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="mkdocs" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              mkdocs
            </span>
            <span class="md-header-nav__topic">
              
                tomcat
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href=".." class="md-tabs__link">
        home
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../python-base/" class="md-tabs__link">
          python
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../nginx/" class="md-tabs__link md-tabs__link--active">
          service
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../mysql/" class="md-tabs__link">
          database
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../open-falcon/" class="md-tabs__link">
          monitor
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../tcp-issue/" class="md-tabs__link">
          basis
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="mkdocs" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    mkdocs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="home" class="md-nav__link">
      home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      python
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        python
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../python-base/" title="python-base" class="md-nav__link">
      python-base
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-lib/" title="python-lib" class="md-nav__link">
      python-lib
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-lib2/" title="python-lib2" class="md-nav__link">
      python-lib2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-web/" title="python-web" class="md-nav__link">
      python-web
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-other/" title="python-other" class="md-nav__link">
      python-other
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      service
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        service
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../nginx/" title="nginx" class="md-nav__link">
      nginx
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../nginx2/" title="nginx2" class="md-nav__link">
      nginx2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../apache/" title="apache" class="md-nav__link">
      apache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../saltstack/" title="saltstack" class="md-nav__link">
      saltstack
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        tomcat
      </label>
    
    <a href="./" title="tomcat" class="md-nav__link md-nav__link--active">
      tomcat
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#java" class="md-nav__link">
    java字体和验证码问题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tomcat" class="md-nav__link">
    tomcat优化
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#java_1" class="md-nav__link">
    java项目监控
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#java_2" class="md-nav__link">
    java时间不一致
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#redis-session" class="md-nav__link">
    redis session共享
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#javacpu" class="md-nav__link">
    java进程使用cpu过高
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    日志切割
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#oracle-jdk" class="md-nav__link">
    oracle jdk
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tomcat_1" class="md-nav__link">
    多tomcat管理脚本
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tomcat_2" class="md-nav__link">
    tomcat跳转
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginxtomat-ssl" class="md-nav__link">
    nginx+tomat ssl
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tomcat_3" class="md-nav__link">
    tomcat内存溢出
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#java_3" class="md-nav__link">
    多java版本
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ansible/" title="ansible" class="md-nav__link">
      ansible
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../trafficserver/" title="trafficserver" class="md-nav__link">
      trafficserver
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../haproxy/" title="haproxy" class="md-nav__link">
      haproxy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../docker/" title="docker" class="md-nav__link">
      docker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../varnish/" title="varnish" class="md-nav__link">
      varnish
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../bind/" title="bind" class="md-nav__link">
      bind
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lvs/" title="lvs" class="md-nav__link">
      lvs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../log-analysis/" title="log-analysis" class="md-nav__link">
      log-analysis
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      database
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        database
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../mysql/" title="mysql" class="md-nav__link">
      mysql
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mysql2/" title="mysql2" class="md-nav__link">
      mysql2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../memcached/" title="memcached" class="md-nav__link">
      memcached
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../redis/" title="redis" class="md-nav__link">
      redis
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mongodb/" title="mongodb" class="md-nav__link">
      mongodb
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../hadoop/" title="hadoop" class="md-nav__link">
      hadoop
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../postgresql/" title="postgresql" class="md-nav__link">
      postgresql
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      monitor
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        monitor
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../open-falcon/" title="open-falcon" class="md-nav__link">
      open-falcon
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zabbix/" title="zabbix" class="md-nav__link">
      zabbix
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zabbix2/" title="zabbix2" class="md-nav__link">
      zabbix2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../netdata/" title="netdata" class="md-nav__link">
      netdata
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      basis
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        basis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../tcp-issue/" title="tcp-issue" class="md-nav__link">
      tcp-issue
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../git-svn/" title="git-svn" class="md-nav__link">
      git-svn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../vpn/" title="vpn" class="md-nav__link">
      vpn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../shell/" title="shell" class="md-nav__link">
      shell
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../disk/" title="disk" class="md-nav__link">
      disk
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../filesystem/" title="filesystem" class="md-nav__link">
      filesystem
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../source/" title="source" class="md-nav__link">
      source
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../command/" title="command" class="md-nav__link">
      command
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../linux-base/" title="linux-base" class="md-nav__link">
      linux-base
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../linux-soft/" title="linux-soft" class="md-nav__link">
      linux-soft
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../other/" title="other" class="md-nav__link">
      other
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#java" class="md-nav__link">
    java字体和验证码问题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tomcat" class="md-nav__link">
    tomcat优化
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#java_1" class="md-nav__link">
    java项目监控
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#java_2" class="md-nav__link">
    java时间不一致
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#redis-session" class="md-nav__link">
    redis session共享
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#javacpu" class="md-nav__link">
    java进程使用cpu过高
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    日志切割
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#oracle-jdk" class="md-nav__link">
    oracle jdk
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tomcat_1" class="md-nav__link">
    多tomcat管理脚本
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tomcat_2" class="md-nav__link">
    tomcat跳转
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginxtomat-ssl" class="md-nav__link">
    nginx+tomat ssl
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tomcat_3" class="md-nav__link">
    tomcat内存溢出
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#java_3" class="md-nav__link">
    多java版本
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>tomcat</h1>
                
                <h2 id="java">java字体和验证码问题</h2>
<div class="codehilite"><pre><span></span>中文字体
<span class="nv">yum</span> <span class="nv">install</span> <span class="nv">cjkuni</span><span class="o">*</span> <span class="nv">dejavu</span><span class="o">*</span> <span class="o">-</span><span class="nv">y</span>

报错<span class="nv">java</span>.<span class="nv">lang</span>.<span class="nv">Error</span>: <span class="nv">Probable</span> <span class="nv">fatal</span> <span class="nv">error</span>:<span class="nv">No</span> <span class="nv">fonts</span> <span class="nv">found</span>.
缺少字体
在国外网站上找到如下方式解决：
<span class="nv">under</span> <span class="nv">Ubuntu</span> <span class="nv">you</span> <span class="nv">can</span> <span class="nv">install</span> <span class="nv">fonts</span> <span class="nv">by</span>
    <span class="nv">sudo</span> <span class="nv">apt</span><span class="o">-</span><span class="nv">get</span> <span class="nv">install</span> <span class="nv">ttf</span><span class="o">-</span><span class="nv">dejavu</span>
<span class="nv">or</span> <span class="k">if</span> <span class="nv">you</span> <span class="nv">use</span> <span class="nv">CentOS</span>, <span class="nv">you</span> <span class="nv">can</span> <span class="nv">install</span> <span class="nv">fonts</span> <span class="nv">by</span>
    <span class="nv">yum</span> <span class="nv">install</span> <span class="nv">dejavu</span><span class="o">*</span>
由于是<span class="nv">CenterOS</span>系统，所以执行
# <span class="nv">yum</span> <span class="nv">install</span> <span class="nv">dejavu</span><span class="o">*</span>
安装完字体后，再访问验证码链接就能正常显示了。
</pre></div>


<h2 id="tomcat">tomcat优化</h2>
<div class="codehilite"><pre><span></span>内存相关，避免内存溢出，又要尽可能利用内存资源
<span class="nv">linux</span>修改<span class="nv">TOMCAT_HOME</span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">catalina</span>.<span class="nv">sh</span>，在前面加入
<span class="mi">8</span><span class="nv">G</span>为例：
<span class="nv">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">-server -Xms4G -Xmx4G  -XX:MaxNewSize=2G  -XX:+UseConcMarkSweepGC -XX:+UseParNewGC -XX:PermSize=1G </span>
<span class="o">-</span><span class="nv">XX</span>:<span class="nv">MaxPermSize</span><span class="o">=</span><span class="mi">1</span><span class="nv">G</span>  <span class="o">-</span><span class="nv">Djava</span>.<span class="nv">awt</span>.<span class="nv">headless</span><span class="o">=</span><span class="nv">true</span> <span class="o">-</span><span class="nv">Dfile</span>.<span class="nv">encoding</span><span class="o">=</span><span class="nv">UTF8</span> <span class="o">-</span><span class="nv">Dsun</span>.<span class="nv">jnu</span>.<span class="nv">encoding</span><span class="o">=</span><span class="nv">UTF8</span><span class="s2">&quot;</span>


<span class="o">-</span><span class="nv">server</span>  启用<span class="nv">jdk</span> 的 <span class="nv">server</span> 版； 
<span class="o">-</span><span class="nv">Xms</span>    <span class="nv">java</span>虚拟机初始化时的最小内存，最好接近于<span class="nv">Xmx</span>，避免过多内存交换
<span class="o">-</span><span class="nv">Xmx</span>   <span class="nv">java</span>虚拟机可使用的最大内存； 可用内存的<span class="mi">80</span><span class="o">%</span>
<span class="o">-</span><span class="nv">Xss</span>
每个线程的栈的大小，减少这个值可以生成更多的线程。但是操作系统对一个进程内的线程数还是有限制的，不能无限制生成。如果程序
没有报<span class="nv">StackOverFlow</span>，可以设置成<span class="mi">128</span><span class="nv">K</span>。
<span class="o">-</span><span class="nv">XX</span>:<span class="nv">PermSize</span>    内存永久保留区域 
<span class="o">-</span><span class="nv">XX</span>:<span class="nv">MaxPermSize</span>   内存最大永久保留区域

<span class="nv">windows</span>修改<span class="nv">TOMCAT_HOME</span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">catalina</span>.<span class="nv">bat</span>，在前面加入
<span class="nv">set</span> <span class="nv">JAVA_OPTS</span><span class="o">=-</span><span class="nv">Xms512m</span> <span class="o">-</span><span class="nv">Xmx512m</span> <span class="o">-</span><span class="nv">Xss1024k</span> <span class="o">-</span><span class="nv">XX</span>:<span class="nv">MaxNewSize</span><span class="o">=</span><span class="mi">256</span><span class="nv">M</span> <span class="o">-</span><span class="nv">XX</span>:<span class="nv">MaxPermSize</span><span class="o">=</span><span class="mi">1024</span><span class="nv">M</span> 参数同<span class="nv">linux</span>

连接并发相关：
配置文件<span class="nv">conf</span><span class="o">/</span><span class="nv">server</span>.<span class="nv">xml</span>
<span class="o">&lt;</span><span class="nv">Connector</span> <span class="nv">port</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">8080</span><span class="s2">&quot;</span> <span class="nv">protocol</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">HTTP/1.1</span><span class="s2">&quot;</span>
        <span class="nv">maxHttpHeaderSize</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">8192</span><span class="s2">&quot;</span>  客户端<span class="nv">Http</span>请求、响应的<span class="nv">Header</span>的最大限制
        <span class="nv">maxThreads</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">1000</span><span class="s2">&quot;</span>        客户请求最大线程数
        <span class="nv">minSpareThreads</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">100</span><span class="s2">&quot;</span>     <span class="nv">Tomcat</span>初始化时创建的 <span class="nv">socket</span> 线程数
        <span class="nv">maxSpareThreads</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">1000</span><span class="s2">&quot;</span>   <span class="nv">Tomcat</span>连接器的最大空闲 <span class="nv">socket</span> 线程数
        <span class="nv">minProcessors</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">100</span><span class="s2">&quot;</span>    最小连接线程数，用于提高系统处理性能，默认值为 <span class="mi">10</span>
        <span class="nv">maxProcessors</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">1000</span><span class="s2">&quot;</span>  最大连接线程数，即：并发处理的最大请求数，默认值为 <span class="mi">75</span>
        <span class="nv">enableLookups</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">false</span><span class="s2">&quot;</span>      禁用<span class="nv">DNS</span>查询
<span class="nv">compression</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">on</span><span class="s2">&quot;</span>    打开压缩功能
        <span class="nv">compressionMinSize</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">2048</span><span class="s2">&quot;</span>  启用压缩的输出内容大小，默认为<span class="mi">2</span><span class="nv">KB</span>
<span class="nv">compressableMimeType</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">text/html,text/xml,text/javascript,text/css,text/plain</span><span class="s2">&quot;</span>
压缩类型
        <span class="nv">connectionTimeout</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">20000</span><span class="s2">&quot;</span> 
网络连接超时，<span class="mi">0</span> 表示永不超时，这样设置有隐患的。通常可设置为<span class="mi">30000</span> 毫秒
        <span class="nv">URIEncoding</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">utf-8</span><span class="s2">&quot;</span>   <span class="nv">URL</span>统一编码
        <span class="nv">acceptCount</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">1000</span><span class="s2">&quot;</span>  允许的最大连接数，应等于 <span class="nv">maxProcessors</span> ，默认值为 <span class="mi">100</span>
        <span class="nv">redirectPort</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">8443</span><span class="s2">&quot;</span>  重定向端口，默认即可
        <span class="nv">disableUploadTimeout</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">true</span><span class="s2">&quot;</span><span class="o">/&gt;</span>  关闭数据上载的超时时间，默认为<span class="nv">false</span>
其中和最大连接数相关的参数为<span class="nv">maxProcessors</span> 和 <span class="nv">acceptCount</span> 。如果要加大并发连接数，应同时加大这两个参数，<span class="nv">webserver</span>允许的
最大连接数还受制于操作系统的内核参数设置，通常<span class="nv">Windows</span>是<span class="mi">2000</span>个左右，<span class="nv">Linux</span>是<span class="mi">1000</span>个左右

运行模式：
<span class="mi">1</span><span class="ss">)</span><span class="nv">bio</span>  默认的模式,性能非常低下,没有经过任何优化处理和支持.
<span class="mi">2</span><span class="ss">)</span><span class="nv">nio</span>  利用<span class="nv">java</span>的异步<span class="nv">io</span>护理技术,<span class="nv">no</span> <span class="nv">blocking</span> <span class="nv">IO</span>技术.
想运行在该模式下，直接修改<span class="nv">server</span>.<span class="nv">xml</span>里的<span class="nv">Connector</span>节点,修改<span class="nv">protocol</span>为
<span class="o">&lt;</span><span class="nv">Connector</span> <span class="nv">port</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">80</span><span class="s2">&quot;</span> <span class="nv">protocol</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">org.apache.coyote.http11.Http11NioProtocol</span><span class="s2">&quot;</span>
    <span class="nv">connectionTimeout</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">20000</span><span class="s2">&quot;</span>
    <span class="nv">redirectPort</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">8443</span><span class="s2">&quot;</span> <span class="o">/&gt;</span>    重启后,就可以生效。
<span class="mi">3</span><span class="ss">)</span><span class="nv">apr</span> 安装起来最困难,但是从操作系统级别来解决异步的<span class="nv">IO</span>问题,大幅度的提高性能.
必须要安装<span class="nv">apr</span>和<span class="nv">native</span>，直接启动就支持<span class="nv">apr</span>。下面的修改纯属多余，仅供大家扩充知识,但仍然需要安装<span class="nv">apr</span>和<span class="nv">native</span>
如<span class="nv">nio</span>修改模式,修改<span class="nv">protocol</span>为<span class="nv">org</span>.<span class="nv">apache</span>.<span class="nv">coyote</span>.<span class="nv">http11</span>.<span class="nv">Http11AprProtocol</span>
<span class="nv">Apr</span>插件提高<span class="nv">Tomcat</span>性能（<span class="nv">linux</span>）
在产品环境中，特别是直接使用<span class="nv">Tomcat</span>做<span class="nv">WEB</span>服务器的时候，应该使用<span class="nv">Tomcat</span> <span class="nv">Native</span>来提高其性能 
  要测<span class="nv">APR</span>给<span class="nv">tomcat</span>带来的好处最好的方法是在慢速网络上（模拟<span class="nv">Internet</span>），将<span class="nv">Tomcat</span>线程数开到<span class="mi">300</span>以上的水平，然后模拟一大堆并发请求。
  如果不配<span class="nv">APR</span>，基本上<span class="mi">300</span>个线程狠快就会用满，以后的请求就只好等待。但是配上<span class="nv">APR</span>之后，并发的线程数量明显下降，从原来的<span class="mi">300</span>可能
  会马上下降到只有几十，新的请求会毫无阻塞的进来。
  在局域网环境测，就算是<span class="mi">400</span>个并发，也是一瞬间就处理<span class="o">/</span>传输完毕，但是在真实的<span class="nv">Internet</span>环境下，页面处理时间只占<span class="mi">0</span>.<span class="mi">1</span><span class="o">%</span>都不到，绝大
  部分时间都用来页面传输。如果不用<span class="nv">APR</span>，一个线程同一时间只能处理一个用户，势必会造成阻塞。所以生产环境下用<span class="nv">apr</span>是非常必要的。
<span class="ss">(</span><span class="mi">1</span><span class="ss">)</span>安装<span class="nv">APR</span> <span class="nv">tomcat</span><span class="o">-</span><span class="nv">native</span>
    <span class="nv">apr</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">3</span>.<span class="mi">8</span>.<span class="nv">tar</span>.<span class="nv">gz</span>   安装在<span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">apr</span>
    #<span class="nv">tar</span> <span class="nv">zxvf</span> <span class="nv">apr</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">3</span>.<span class="mi">8</span>.<span class="nv">tar</span>.<span class="nv">gz</span>
    #<span class="nv">cd</span> <span class="nv">apr</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">3</span>.<span class="mi">8</span>
    #.<span class="o">/</span><span class="nv">configure</span><span class="c1">;make;make install</span>
    <span class="nv">apr</span><span class="o">-</span><span class="nv">util</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">3</span>.<span class="mi">9</span>.<span class="nv">tar</span>.<span class="nv">gz</span>  安装在<span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">apr</span><span class="o">/</span><span class="nv">lib</span>
    #<span class="nv">tar</span> <span class="nv">zxvf</span> <span class="nv">apr</span><span class="o">-</span><span class="nv">util</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">3</span>.<span class="mi">9</span>.<span class="nv">tar</span>.<span class="nv">gz</span>
    #<span class="nv">cd</span> <span class="nv">apr</span><span class="o">-</span><span class="nv">util</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">3</span>.<span class="mi">9</span> 
    #.<span class="o">/</span><span class="nv">configure</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">apr</span><span class="o">=/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">apr</span> <span class="o">----</span><span class="nv">with</span><span class="o">-</span><span class="nv">java</span><span class="o">-</span><span class="nv">home</span><span class="o">=</span><span class="nv">JDK</span><span class="c1">;make;make install</span>
    #<span class="nv">cd</span> <span class="nv">apache</span><span class="o">-</span><span class="nv">tomcat</span><span class="o">-</span><span class="mi">6</span>.<span class="mi">0</span>.<span class="mi">20</span><span class="o">/</span><span class="nv">bin</span> 
    #<span class="nv">tar</span> <span class="nv">zxvf</span> <span class="nv">tomcat</span><span class="o">-</span><span class="nv">native</span>.<span class="nv">tar</span>.<span class="nv">gz</span> 
    #<span class="nv">cd</span> <span class="nv">tomcat</span><span class="o">-</span><span class="nv">native</span><span class="o">/</span><span class="nv">jni</span><span class="o">/</span><span class="nv">native</span> 
    #.<span class="o">/</span><span class="nv">configure</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">apr</span><span class="o">=/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">apr</span><span class="c1">;make;make install</span>
  <span class="ss">(</span><span class="mi">2</span><span class="ss">)</span>设置 <span class="nv">Tomcat</span> 整合 <span class="nv">APR</span>
    修改 <span class="nv">tomcat</span> 的启动 <span class="nv">shell</span> （<span class="nv">startup</span>.<span class="nv">sh</span>），在该文件中加入启动参数：
      <span class="nv">CATALINA_OPTS</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">$CATALINA_OPTS  -Djava.library.path=/usr/local/apr/lib</span><span class="s2">&quot;</span> 。
  <span class="ss">(</span><span class="mi">3</span><span class="ss">)</span>判断安装成功:
    如果看到下面的启动日志，表示成功。
      <span class="nv">INFO</span>: <span class="nv">Loaded</span> <span class="nv">APR</span> <span class="nv">based</span> <span class="nv">Apache</span> <span class="nv">Tomcat</span> <span class="nv">Native</span> <span class="nv">library</span>

<span class="nv">server</span>.<span class="nv">xml</span> ：
<span class="o">&lt;</span><span class="nv">Executor</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">tomcatThreadPool</span><span class="s2">&quot;</span> <span class="nv">namePrefix</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">catalina-exec-</span><span class="s2">&quot;</span>
        <span class="nv">maxThreads</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">3000</span><span class="s2">&quot;</span> <span class="nv">minSpareThreads</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">200</span><span class="s2">&quot;</span><span class="o">/&gt;</span>

<span class="o">&lt;</span><span class="nv">Connector</span> <span class="nv">executor</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">tomcatThreadPool</span><span class="s2">&quot;</span> <span class="nv">port</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">8080</span><span class="s2">&quot;</span> <span class="nv">protocol</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">org.apache.coyote.http11.Http11AprProtocol</span><span class="s2">&quot;</span>
               <span class="nv">connectionTimeout</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">20000000</span><span class="s2">&quot;</span>
               <span class="nv">redirectPort</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">8443</span><span class="s2">&quot;</span> <span class="nv">URIEncoding</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">UTF-8</span><span class="s2">&quot;</span>
               <span class="nv">enableLookups</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">false</span><span class="s2">&quot;</span>
               <span class="nv">useURIValidationHack</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">false</span><span class="s2">&quot;</span>
           <span class="nv">disableUploadTimeout</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">false</span><span class="s2">&quot;</span>
               <span class="nv">maxHttpHeaderSize</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">65536</span><span class="s2">&quot;</span> 
               <span class="nv">maxPostSize</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">52428800</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
</pre></div>


<h2 id="java_1">java项目监控</h2>
<div class="codehilite"><pre><span></span><span class="n">javamelody</span>
<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">javamelody</span><span class="o">/</span><span class="n">javamelody</span><span class="o">/</span><span class="n">wiki</span><span class="o">/</span><span class="n">UserGuide</span><span class="o">#</span><span class="n">javamelody</span><span class="o">-</span><span class="n">setup</span>
</pre></div>


<h2 id="java_2">java时间不一致</h2>
<div class="codehilite"><pre><span></span><span class="n">tomcat</span><span class="err">日志时间和系统不一样</span>

<span class="n">jre</span><span class="err">是从</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysconfig</span><span class="o">/</span><span class="n">clock</span><span class="err">这个文件中</span> <span class="err">获取时区信息的。</span>

<span class="err">附</span><span class="n">clock</span><span class="err">文件内容：</span>

<span class="k">ZONE</span><span class="o">=</span><span class="ss">&quot;Asia/Shanghai&quot;</span>
<span class="n">UTC</span><span class="o">=</span><span class="k">false</span>
<span class="n">ARC</span><span class="o">=</span><span class="k">false</span>

<span class="k">ZONE</span> <span class="c1">-- 时区</span>
<span class="n">UTC</span>  <span class="c1">-- 表明时钟设置为UTC。 </span>
<span class="n">ARC</span>  <span class="c1">-- 仅用于alpha表明使用ARC。　　　　　　</span>
</pre></div>


<h2 id="redis-session">redis session共享</h2>
<div class="codehilite"><pre><span></span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">jcoleman</span><span class="o">/</span><span class="n">tomcat</span><span class="o">-</span><span class="n">redis</span><span class="o">-</span><span class="k">session</span><span class="o">-</span><span class="n">manager</span>

<span class="err">切换选择不同版本</span>  <span class="err">附件是</span><span class="n">java1</span><span class="p">.</span><span class="mi">6</span>  <span class="n">tomcat7</span>
<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">izerui</span><span class="o">/</span><span class="n">tomcat</span><span class="o">-</span><span class="n">redis</span><span class="o">-</span><span class="k">session</span><span class="o">-</span><span class="n">manager</span>   <span class="n">tomca7</span>  <span class="n">java1</span><span class="p">.</span><span class="mi">7</span> 

<span class="err">安装好</span><span class="n">redis</span>   <span class="mi">2</span><span class="p">.</span><span class="mi">8</span><span class="err">版本以上</span>

<span class="n">grandle</span><span class="err">构建</span>      <span class="p">..</span><span class="o">/</span><span class="n">gradle</span><span class="o">-</span><span class="mi">2</span><span class="p">.</span><span class="mi">1</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">gradle</span> <span class="n">build</span>
<span class="n">build</span><span class="p">.</span><span class="n">gradle</span>
<span class="n">apply</span> <span class="n">plugin</span><span class="p">:</span> <span class="s1">&#39;java&#39;</span>
<span class="k">version</span> <span class="o">=</span> <span class="s1">&#39;1.1&#39;</span>

<span class="n">repositories</span> <span class="err">{</span>
  <span class="n">mavenCentral</span><span class="p">()</span>
<span class="err">}</span>

<span class="n">dependencies</span> <span class="err">{</span>
  <span class="n">compile</span> <span class="k">group</span><span class="p">:</span> <span class="s1">&#39;org.apache.tomcat&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="s1">&#39;tomcat-catalina&#39;</span><span class="p">,</span> <span class="k">version</span><span class="p">:</span> <span class="s1">&#39;7.0.67&#39;</span>
  <span class="n">compile</span> <span class="k">group</span><span class="p">:</span> <span class="s1">&#39;redis.clients&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="s1">&#39;jedis&#39;</span><span class="p">,</span> <span class="k">version</span><span class="p">:</span> <span class="s1">&#39;2.5.2&#39;</span>
  <span class="n">compile</span> <span class="k">group</span><span class="p">:</span> <span class="s1">&#39;org.apache.commons&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="s1">&#39;commons-pool2&#39;</span><span class="p">,</span> <span class="k">version</span><span class="p">:</span> <span class="s1">&#39;2.2&#39;</span>
  <span class="o">//</span> <span class="n">testCompile</span> <span class="k">group</span><span class="p">:</span> <span class="s1">&#39;junit&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="s1">&#39;junit&#39;</span><span class="p">,</span> <span class="k">version</span><span class="p">:</span> <span class="s1">&#39;4.+&#39;</span>
<span class="err">}</span>



<span class="n">tomcat</span>  <span class="n">conf</span><span class="o">/</span><span class="n">context</span><span class="p">.</span><span class="n">xml</span>
<span class="o">&lt;</span><span class="n">Valve</span> <span class="n">className</span><span class="o">=</span><span class="ss">&quot;com.radiadesign.catalina.session.RedisSessionHandlerValve&quot;</span> <span class="o">/&gt;</span>   <span class="err">路径根据</span>
<span class="n">tomcat</span><span class="o">-</span><span class="n">redis</span><span class="o">-</span><span class="k">session</span> <span class="n">jar</span><span class="err">包文件路径修改</span>
    <span class="o">&lt;</span><span class="n">Manager</span> <span class="n">className</span><span class="o">=</span><span class="ss">&quot;com.radiadesign.catalina.session.RedisSessionManager&quot;</span> 
         <span class="k">host</span><span class="o">=</span><span class="ss">&quot;192.168.1.5&quot;</span> 
         <span class="n">port</span><span class="o">=</span><span class="ss">&quot;6379&quot;</span> 
         <span class="k">database</span><span class="o">=</span><span class="ss">&quot;0&quot;</span> 
         <span class="n">maxInactiveInterval</span><span class="o">=</span><span class="ss">&quot;60&quot;</span> <span class="o">/&gt;</span>

 <span class="n">tomca7</span>  <span class="n">java1</span><span class="p">.</span><span class="mi">7</span> 

<span class="o">&lt;</span><span class="n">Valve</span> <span class="n">className</span><span class="o">=</span><span class="ss">&quot;com.orangefunction.tomcat.redissessions.RedisSessionHandlerValve&quot;</span> <span class="o">/&gt;</span>
     <span class="o">&lt;</span><span class="n">Manager</span> <span class="n">className</span><span class="o">=</span><span class="ss">&quot;com.orangefunction.tomcat.redissessions.RedisSessionManager&quot;</span>
      <span class="k">host</span><span class="o">=</span><span class="ss">&quot;localhost&quot;</span>
      <span class="n">port</span><span class="o">=</span><span class="ss">&quot;6379&quot;</span>
      <span class="k">database</span><span class="o">=</span><span class="ss">&quot;0&quot;</span>
      <span class="n">maxInactiveInterval</span><span class="o">=</span><span class="ss">&quot;60&quot;</span>
      <span class="n">sessionPersistPolicies</span><span class="o">=</span><span class="ss">&quot;PERSIST_POLICY_1,PERSIST_POLICY_2,..&quot;</span>    <span class="k">session</span><span class="err">保存策略，可选项</span>
      <span class="n">sentinelMaster</span><span class="o">=</span><span class="ss">&quot;SentinelMasterName&quot;</span>                 <span class="n">redis</span><span class="err">集群主节点名称</span>
      <span class="n">sentinels</span><span class="o">=</span><span class="ss">&quot;sentinel-host-1:port,sentinel-host-2:port,..&quot;</span><span class="o">/&gt;</span>          <span class="n">redis</span><span class="err">集群列表配置</span>     



<span class="n">java</span><span class="p">.</span><span class="n">lang</span><span class="p">.</span><span class="n">IllegalArgumentException</span><span class="p">:</span> <span class="n">setAttribute</span><span class="p">:</span> <span class="n">Non</span><span class="o">-</span><span class="k">serializable</span> <span class="n">attribute</span> <span class="n">registerLoginUser</span>
<span class="k">session</span><span class="err">需要序列化</span>
</pre></div>


<h2 id="javacpu">java进程使用cpu过高</h2>
<div class="codehilite"><pre><span></span><span class="err">根据</span><span class="n">top</span><span class="err">命令，发现</span><span class="n">PID</span><span class="err">为</span><span class="mi">28555</span><span class="err">的</span><span class="n">Java</span><span class="err">进程占用</span><span class="n">CPU</span><span class="err">高达</span><span class="mi">200</span><span class="o">%</span><span class="err">，出现故障。</span>
<span class="err">通过</span><span class="n">ps</span> <span class="n">aux</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">PID</span><span class="err">命令，可以进一步确定是</span><span class="n">tomcat</span><span class="err">进程出现了问题。但是，怎么定位到具体线程或者代码呢？</span>
<span class="err">首先显示线程列表</span><span class="p">:</span>
<span class="n">ps</span> <span class="o">-</span><span class="n">mp</span> <span class="n">pid</span> <span class="o">-</span><span class="n">o</span> <span class="n">THREAD</span><span class="p">,</span><span class="n">tid</span><span class="p">,</span><span class="n">time</span>
<span class="mi">1</span>
<span class="err">找到了耗时最高的线程</span><span class="mi">28802</span><span class="err">，占用</span><span class="n">CPU</span><span class="err">时间快两个小时了！</span>
<span class="err">其次将需要的线程</span><span class="n">ID</span><span class="err">转换为</span><span class="mi">16</span><span class="err">进制格式：</span>
<span class="n">printf</span> <span class="ss">&quot;%x\n&quot;</span> <span class="n">tid</span>
<span class="mi">2</span>
<span class="err">最后打印线程的堆栈信息：</span>
<span class="n">jstack</span> <span class="n">pid</span> <span class="o">|</span><span class="n">grep</span> <span class="n">tid</span> <span class="o">-</span><span class="n">A</span> <span class="mi">30</span>
</pre></div>


<h2 id="_1">日志切割</h2>
<div class="codehilite"><pre><span></span><span class="nv">logroute</span>处理  最简单
<span class="nv">cat</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="k">logrotate</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">tomcat</span>
<span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">tomcat_pingtai</span><span class="o">/</span><span class="nv">logs</span><span class="o">/</span><span class="nv">catalina</span>.<span class="nv">out</span> {
   <span class="nv">copytruncate</span>   拷贝后截断，把当前<span class="nv">log</span>拷贝后截断。可以理解为把内容拷贝走作为备份,然后清空当前文件
   <span class="nv">daily</span>      按天切割
   <span class="nv">dateext</span>     日期格式
   <span class="nv">rotate</span> <span class="mi">30</span>   保留<span class="mi">30</span>个，之前的删除
   <span class="nv">missingok</span>    在日志轮循期间，任何错误将被忽略，例如“文件无法找到”之类的错误
   <span class="nv">notifempty</span>    如果日志文件为空，轮循不会进行
}


<span class="mi">1</span>. 下载安装 <span class="nv">cronolog</span>，它的主页 <span class="nv">http</span>:<span class="o">//</span><span class="nv">cronolog</span>.<span class="nv">org</span> . 下载的是源码，安装过程就是 .<span class="o">/</span><span class="nv">configure</span>, <span class="nv">make</span>, <span class="nv">make</span> <span class="nv">install</span>，
最后一步可直接把 <span class="nv">src</span><span class="o">/</span><span class="nv">cronolog</span> 执行文件拷入到某个适合的目录，如 <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">sbin</span><span class="o">/</span> 目录

或者 <span class="nv">yum</span> <span class="nv">install</span> <span class="nv">cronolog</span> <span class="o">-</span><span class="nv">y</span>

<span class="mi">2</span>. 编辑 <span class="nv">bin</span><span class="o">/</span><span class="nv">catalina</span>.<span class="nv">sh</span> 文件

    <span class="mi">1</span>）找到下面行并把它用 # 注释掉

<span class="nv">touch</span> <span class="s2">&quot;</span><span class="s">$CATALINA_BASE</span><span class="s2">&quot;</span><span class="o">/</span><span class="nv">logs</span><span class="o">/</span><span class="nv">catalina</span>.<span class="nv">out</span>
<span class="nv">Tomcat7</span> 的 <span class="nv">bin</span><span class="o">/</span><span class="nv">catalina</span>.<span class="nv">sh</span> 文件要注释的行是  <span class="nv">touch</span> <span class="s2">&quot;</span><span class="s">$CATALINA_OUT</span><span class="s2">&quot;</span>

    <span class="mi">2</span>）删除下面的行，有两处，并添加新的

<span class="o">&gt;&gt;</span> <span class="s2">&quot;</span><span class="s">$CATALINA_BASE</span><span class="s2">&quot;</span><span class="o">/</span><span class="nv">logs</span><span class="o">/</span><span class="nv">catalina</span>.<span class="nv">out</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span> <span class="o">&amp;</span>   
    为

<span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span> <span class="o">|</span> <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">sbin</span><span class="o">/</span><span class="nv">cronolog</span> <span class="s2">&quot;</span><span class="s">$CATALINA_BASE/logs/catalina-%Y-%m-%d.out</span><span class="s2">&quot;</span> <span class="o">&amp;</span>

<span class="nv">Tomcat7</span> 的 <span class="nv">bin</span><span class="o">/</span><span class="nv">catalina</span>.<span class="nv">sh</span> 中是需要替换行是

<span class="o">&gt;&gt;</span> <span class="s2">&quot;</span><span class="s">$CATALINA_OUT</span><span class="s2">&quot;</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span> <span class="s2">&quot;</span><span class="s">&amp;</span><span class="s2">&quot;</span>
替换后该行的内容与上面是一样的。

为什么 <span class="nv">Tomcat7</span> 后会有所不同，因为在它的 <span class="nv">catalina</span>.<span class="nv">sh</span> 文件中有如下定义
<span class="nv">CATALINA_OUT</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">$CATALINA_BASE</span><span class="s2">&quot;</span><span class="o">/</span><span class="nv">logs</span><span class="o">/</span><span class="nv">catalina</span>.<span class="nv">out</span>

<span class="mi">3</span>. 保存 <span class="nv">catalina</span>.<span class="nv">sh</span> 文件，重启 <span class="nv">Tomcat</span> 即可。

以后看到 $<span class="nv">TOMCAT_HOME</span><span class="o">/</span><span class="nv">logs</span><span class="o">/</span> 下的就是 <span class="nv">catalina</span><span class="o">-</span><span class="mi">2012</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">16</span>.<span class="nv">out</span>, <span class="nv">catalina</span><span class="o">-</span><span class="mi">2012</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">17</span>.<span class="nv">out</span> ...... 一系列文件，
将不会产生 <span class="nv">catalina</span>.<span class="nv">out</span> 文件了
</pre></div>


<h2 id="oracle-jdk">oracle jdk</h2>
<div class="codehilite"><pre><span></span><span class="n">rpm</span> <span class="o">-</span><span class="n">ivh</span> <span class="n">jdk</span><span class="o">-</span><span class="mi">7</span><span class="n">u79</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x64</span><span class="p">.</span><span class="n">rpm</span> 
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">profile</span> <span class="err">添加</span>  <span class="err">或者家目录的环境变量</span>
<span class="n">export</span> <span class="n">JAVA_HOME</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">latest</span><span class="o">/</span>
<span class="n">export</span> <span class="n">PATH</span><span class="o">=</span><span class="err">$</span><span class="n">JAVA_HOME</span><span class="o">/</span><span class="n">bin</span><span class="p">:</span><span class="err">$</span><span class="n">PATH</span>
<span class="n">export</span> <span class="n">CLASSPATH</span><span class="o">=</span><span class="p">.:</span><span class="err">$</span><span class="n">JAVA_HOME</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">dt</span><span class="p">.</span><span class="n">jar</span><span class="p">:</span><span class="err">$</span><span class="n">JAVA_HOME</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">tools</span><span class="p">.</span><span class="n">jar</span>

<span class="p">.</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">profile</span>
<span class="n">java</span> <span class="o">-</span><span class="k">version</span>
</pre></div>


<h2 id="tomcat_1">多tomcat管理脚本</h2>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="ch">#!/bin/bash  </span>
<span class="c1"># author: Sean Chow (seanlook7@gmail.com)</span>
<span class="c1"># </span>
<span class="c1">#  </span>
<span class="c1"># chkconfig: 345 80 15  </span>
<span class="c1"># description: Multiple tomcats service management script.</span>

<span class="c1"># Source function library.  </span>
. /etc/rc.d/init.d/functions  
<span class="c1"># 第几个tomcat</span>
<span class="nv">tcNo</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">tcName</span><span class="o">=</span>tomcat<span class="nv">$1</span>
<span class="nv">basedir</span><span class="o">=</span>/apps/test/<span class="nv">$tcName</span>
<span class="nv">tclog</span><span class="o">=</span><span class="si">${</span><span class="nv">basedir</span><span class="si">}</span>/logs/catalina.<span class="k">$(</span>date +%Y-%m-%d<span class="k">)</span>.out
<span class="nv">RETVAL</span><span class="o">=</span><span class="m">0</span>

start<span class="o">(){</span>
        checkrun  
        <span class="k">if</span> <span class="o">[</span> <span class="nv">$RETVAL</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>  
                <span class="nb">echo</span> <span class="s2">&quot;-- Starting tomcat...&quot;</span>  
                <span class="nv">$basedir</span>/bin/startup.sh  
                touch /var/lock/subsys/<span class="si">${</span><span class="nv">tcNo</span><span class="si">}</span>
                checklog 
                status
        <span class="k">else</span>  
                <span class="nb">echo</span> <span class="s2">&quot;-- tomcat already running&quot;</span>  
        <span class="k">fi</span>  
<span class="o">}</span>  
<span class="c1"># 停止某一台tomcat，如果是重启则带re参数，表示不查看日志，等待启动时再提示查看  </span>
stop<span class="o">(){</span>
        checkrun  
        <span class="k">if</span> <span class="o">[</span> <span class="nv">$RETVAL</span> -eq <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>  
                <span class="nb">echo</span> <span class="s2">&quot;-- Shutting down tomcat...&quot;</span>  
                <span class="nv">$basedir</span>/bin/shutdown.sh  
                <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;re&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
                  checklog
                <span class="k">else</span>
                  sleep <span class="m">5</span>
                <span class="k">fi</span>
                rm -f /var/lock/subsys/<span class="si">${</span><span class="nv">tcNo</span><span class="si">}</span> 
                status
        <span class="k">else</span>  
                <span class="nb">echo</span> <span class="s2">&quot;-- tomcat not running&quot;</span>  
        <span class="k">fi</span>  
<span class="o">}</span>

status<span class="o">(){</span>
        checkrun
        <span class="k">if</span> <span class="o">[</span> <span class="nv">$RETVAL</span> -eq <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
                <span class="nb">echo</span> -n <span class="s2">&quot;-- Tomcat ( pid &quot;</span>  
                ps ax --width<span class="o">=</span><span class="m">1000</span> <span class="p">|</span>grep <span class="si">${</span><span class="nv">tcName</span><span class="si">}</span><span class="p">|</span>grep <span class="s2">&quot;org.apache.catalina.startup.Bootstrap start&quot;</span> <span class="p">|</span>
                   awk <span class="s1">&#39;{printf $1 &quot; &quot;}&#39;</span>
                <span class="nb">echo</span> -n <span class="s2">&quot;) is running...&quot;</span>  
                <span class="nb">echo</span>  
        <span class="k">else</span>
                <span class="nb">echo</span> <span class="s2">&quot;-- Tomcat is stopped&quot;</span>  
        <span class="k">fi</span>
        <span class="c1">#echo &quot;---------------------------------------------&quot;  </span>
<span class="o">}</span>
<span class="c1"># 查看tomcat日志，带vl参数</span>
log<span class="o">(){</span>
        status
        checklog yes
<span class="o">}</span>
<span class="c1"># 如果tomcat正在运行，强行杀死tomcat进程，关闭tomcat</span>
kill<span class="o">(){</span>
        checkrun
        <span class="k">if</span> <span class="o">[</span> <span class="nv">$RETVAL</span> -eq <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            <span class="nb">read</span> -p <span class="s2">&quot;-- Do you really want to kill </span><span class="si">${</span><span class="nv">tcName</span><span class="si">}</span><span class="s2"> progress?[no])&quot;</span> answer
            <span class="k">case</span> <span class="nv">$answer</span> in
                Y<span class="p">|</span>y<span class="p">|</span>YES<span class="p">|</span>yes<span class="p">|</span>Yes<span class="o">)</span>
                    ps ax --width<span class="o">=</span><span class="m">1000</span> <span class="p">|</span>grep <span class="si">${</span><span class="nv">tcName</span><span class="si">}</span><span class="p">|</span>grep <span class="s2">&quot;org.apache.catalina.startup.Bootstrap start&quot;</span> <span class="p">|</span> 
                                                                           awk <span class="s1">&#39;{printf $1 &quot; &quot;}&#39;</span><span class="p">|</span>xargs <span class="nb">kill</span> -9  
                    status
                <span class="p">;;</span>
                *<span class="o">)</span><span class="p">;;</span>
            <span class="k">esac</span>
        <span class="k">else</span>
            <span class="nb">echo</span> <span class="s2">&quot;-- exit with </span><span class="nv">$tcName</span><span class="s2"> still running...&quot;</span>
        <span class="k">fi</span>
<span class="o">}</span>
checkrun<span class="o">(){</span>  
        ps ax --width<span class="o">=</span><span class="m">1000</span> <span class="p">|</span>grep <span class="si">${</span><span class="nv">tcName</span><span class="si">}</span><span class="p">|</span> grep <span class="s2">&quot;[o]rg.apache.catalina.startup.Bootstrap start&quot;</span> <span class="p">|</span> 
                        awk <span class="s1">&#39;{printf $1 &quot; &quot;}&#39;</span> <span class="p">|</span> wc <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span> &gt;/tmp/tomcat_process_count.txt  
        <span class="nb">read</span> line &lt; /tmp/tomcat_process_count.txt  
        <span class="k">if</span> <span class="o">[</span> <span class="nv">$line</span> -gt <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>  
                <span class="nv">RETVAL</span><span class="o">=</span><span class="m">1</span>  
                <span class="k">return</span> <span class="nv">$RETVAL</span>  
        <span class="k">else</span>  
                <span class="nv">RETVAL</span><span class="o">=</span><span class="m">0</span>  
                <span class="k">return</span> <span class="nv">$RETVAL</span>  
        <span class="k">fi</span>  
<span class="o">}</span>  
<span class="c1"># 如果是直接查看日志viewlog，则不提示输入[yes]，否则就是被stop和start调用，需提示是否查看日志</span>
checklog<span class="o">(){</span>
        <span class="nv">answer</span><span class="o">=</span><span class="nv">$1</span>
        <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$answer</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;yes&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            <span class="nb">read</span> -p <span class="s2">&quot;-- See Catalina.out log to check </span><span class="nv">$2</span><span class="s2"> status?[yes])&quot;</span> answer
        <span class="k">fi</span>
        <span class="k">case</span> <span class="nv">$answer</span> in
            Y<span class="p">|</span>y<span class="p">|</span>YES<span class="p">|</span>yes<span class="p">|</span>Yes<span class="p">|</span><span class="s2">&quot;&quot;</span><span class="o">)</span>
                tail -f <span class="si">${</span><span class="nv">tclog</span><span class="si">}</span>
            <span class="p">;;</span>
            *<span class="o">)</span>
            <span class="c1">#    status</span>
            <span class="c1">#    exit 0</span>
            <span class="p">;;</span>
        <span class="k">esac</span>
<span class="o">}</span>
checkexist<span class="o">(){</span>
        <span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$basedir</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            <span class="nb">echo</span> <span class="s2">&quot;-- tomcat </span><span class="nv">$basedir</span><span class="s2"> does not exist.&quot;</span>
            <span class="nb">exit</span> <span class="m">0</span>
        <span class="k">fi</span>
<span class="o">}</span>


<span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span> in  
start<span class="o">)</span>  
        checkexist
        start  
        <span class="nb">exit</span> <span class="m">0</span>
        <span class="p">;;</span>  
stop<span class="o">)</span>  
        checkexist
        stop  
        <span class="nb">exit</span> <span class="m">0</span>
        <span class="p">;;</span>  
restart<span class="o">)</span>  
        checkexist
        stop re 
        start 
        <span class="nb">exit</span> <span class="m">0</span>
        <span class="p">;;</span>  
status<span class="o">)</span>  
        checkexist
        status  
        <span class="c1">#$basedir/bin/catalina.sh version  </span>
        <span class="nb">exit</span> <span class="m">0</span>
        <span class="p">;;</span>  
log<span class="o">)</span>
        checkexist
        log
        <span class="nb">exit</span> <span class="m">0</span>
        <span class="p">;;</span>
<span class="nb">kill</span><span class="o">)</span>
        checkexist
        status
        <span class="nb">kill</span>
        <span class="nb">exit</span> <span class="m">0</span>
        <span class="p">;;</span>
*<span class="o">)</span>  
        <span class="nb">echo</span> <span class="s2">&quot;Usage: </span><span class="nv">$0</span><span class="s2"> {start|stop|restart|status|log|kill}&quot;</span>  
        <span class="nb">echo</span> <span class="s2">&quot;       service tomcat {0|1|..} {start|stop|restart|status|log|kill}&quot;</span>  
        <span class="k">esac</span>

<span class="nb">exit</span> <span class="m">0</span>
使用说明：

使用前设定好baseDir（多tomcat所在路径），各tomcat命名如tomcat0、tomcat1…
脚本名字为tomcat，放到/etc/init.d/下，并基于可执行权限chmod +x /etc/init.d/tomcat
执行用户不允许用root，特别是在线上环境
已处理其他错误参数输入，可用于正式环境
你也可以修改tcName来适应管理一个tomcat服务的情形
使用，以下针对tomcat0（/apps/test/tomcat0）

service tomcat <span class="m">0</span> start   启动，默认回车会查看启动日志；已启动则仅输出进程号
service tomcat <span class="m">0</span> stop    停止，默认回车会查看日志；已停止则无动作；无法停止，则提示是否<span class="sb">`</span><span class="nb">kill</span><span class="sb">`</span>（默认No）
service tomcat <span class="m">0</span> restart 重启tomcat，有日志输出
service tomcat <span class="m">0</span> status  查看tomcat是否启动
service tomcat <span class="m">0</span> log     使用<span class="sb">`</span>tail -f<span class="sb">`</span>命令实时查看日志
service tomcat <span class="m">0</span> <span class="nb">kill</span>    直接<span class="sb">`</span><span class="nb">kill</span><span class="sb">`</span>tomcat进程；尽量少用
TO-DO
加入service tomcat <span class="m">0</span> clean命令来清除work和tmp目录，正在运行的不允许清除。

这个脚本最近（2014/11/13）在使用过程中发现一个新的问题，因为服务器上tomcat一直开启着监控端口7091，所
以在service tomcat <span class="m">1</span> start失败以后，7091端口就被占用了，但使用service tomcat <span class="m">1</span> status状态时stopped，
其实还是有这个失败的tomcat进程，但用service tomcat <span class="m">1</span> kill会失败。脚本里在考虑这个功能的话就有点臃肿了，还是老实结合手动管理吧。
</pre></div>
</td></tr></table>

<h2 id="tomcat_2">tomcat跳转</h2>
<div class="codehilite"><pre><span></span>我们输入http://10.138.16.232:8080，访问的是tomcat的首页，我们只需要对tomcat的首页进行加工即可。修改方法如下：

修改原有tomcat页面；  /usr/local/tomcat/webapps/ROOT/index.html  用js跳转
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;UTF-8&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;script</span> <span class="na">language=</span><span class="s">&quot;javascript&quot;</span><span class="nt">&gt;</span>
    window.location.href=&quot;/abc&quot;;  #也可以是完整url
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>


<h2 id="nginxtomat-ssl">nginx+tomat ssl</h2>
<div class="codehilite"><pre><span></span><span class="nv">nginx</span> <span class="nv">tomcat</span> <span class="nv">reverse</span> <span class="nv">proxy</span> <span class="nv">schema</span>
<span class="nv">nginx</span> <span class="nv">config</span>

<span class="nv">daemon</span> <span class="nv">off</span><span class="c1">;</span>
<span class="nv">worker_processes</span>  <span class="mi">2</span><span class="c1">;</span>
<span class="nv">error_log</span> <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">log</span><span class="o">/</span><span class="nv">nginx_error</span>.<span class="nv">log</span> <span class="nv">info</span><span class="c1">;</span>
<span class="nv">user</span> <span class="nv">bananos</span> <span class="nv">staff</span><span class="c1">;</span>
<span class="nv">events</span> {
    <span class="nv">worker_connections</span>  <span class="mi">1024</span><span class="c1">;</span>
}
<span class="nv">http</span> {
    <span class="k">include</span> <span class="o">/</span><span class="nv">opt</span><span class="o">/</span><span class="nv">nginx</span><span class="o">/</span><span class="nv">conf</span><span class="o">/</span><span class="nv">mime</span>.<span class="nv">types</span><span class="c1">;</span>
    <span class="nv">default_type</span> <span class="nv">application</span><span class="o">/</span><span class="nv">octet</span><span class="o">-</span><span class="nv">stream</span><span class="c1">;</span>
    <span class="nv">log_format</span> <span class="nv">main</span> <span class="s1">&#39;</span><span class="s">$remote_addr - $remote_user [$time_local] &quot;$request&quot; $status $bytes_sent &quot;$http_referer&quot; </span>
           <span class="s2">&quot;</span><span class="s">$http_user_agent</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="s">$gzip_ratio</span><span class="s2">&quot;</span><span class="s1">&#39;</span><span class="s">;</span>
    <span class="nv">ignore_invalid_headers</span> <span class="nv">on</span><span class="c1">;</span>
    <span class="nv">index</span> <span class="nv">index</span>.<span class="nv">html</span><span class="c1">;</span>
    <span class="nv">client_header_timeout</span> <span class="mi">240</span><span class="c1">;</span>
    <span class="nv">client_body_timeout</span> <span class="mi">240</span><span class="c1">;</span>
    <span class="nv">send_timeout</span> <span class="mi">240</span><span class="c1">;</span>
    <span class="nv">client_max_body_size</span> <span class="mi">100</span><span class="nv">m</span><span class="c1">;</span>
    <span class="nv">proxy_buffer_size</span> <span class="mi">128</span><span class="nv">k</span><span class="c1">;</span>
    <span class="nv">proxy_buffers</span> <span class="mi">8</span> <span class="mi">128</span><span class="nv">k</span><span class="c1">;</span>
    <span class="nv">upstream</span> <span class="nv">tomcat_server</span> {
    # <span class="nv">Tomcat</span> <span class="nv">is</span> <span class="nv">listening</span> <span class="nv">on</span> <span class="nv">default</span> <span class="mi">8080</span> <span class="nv">port</span>
        <span class="nv">server</span> <span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span>:<span class="mi">8080</span> <span class="nv">fail_timeout</span><span class="o">=</span><span class="mi">0</span><span class="c1">;</span>
    }
    <span class="nv">server</span> {
        <span class="nv">server_name</span> <span class="nv">localhost</span><span class="c1">;</span>
        <span class="nv">listen</span> <span class="mi">443</span><span class="c1">;</span>
        <span class="nv">ssl</span> <span class="nv">on</span><span class="c1">;</span>
        <span class="nv">ssl_session_timeout</span> <span class="mi">5</span><span class="nv">m</span><span class="c1">;</span>
        <span class="nv">ssl_protocols</span> <span class="nv">SSLv2</span> <span class="nv">SSLv3</span> <span class="nv">TLSv1</span><span class="c1">;</span>
        #<span class="nv">make</span> <span class="nv">sure</span> <span class="nv">you</span> <span class="nv">already</span> <span class="nv">have</span> <span class="nv">this</span> <span class="nv">certificate</span> <span class="nv">pair</span><span class="o">!</span>
        <span class="nv">ssl_certificate</span> <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">certs</span><span class="o">/</span><span class="nv">server</span>.<span class="nv">crt</span><span class="c1">;</span>
        <span class="nv">ssl_certificate_key</span> <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">certs</span><span class="o">/</span><span class="nv">server</span>.<span class="nv">key</span><span class="c1">;</span>
        <span class="nv">ssl_session_cache</span> <span class="nv">shared</span>:<span class="nv">SSL</span>:<span class="mi">10</span><span class="nv">m</span><span class="c1">;</span>
    # <span class="nv">www</span><span class="o">-</span><span class="nv">root</span>, <span class="nv">we</span><span class="s1">&#39;</span><span class="s">re serving static files from here, accessible via https://localhost/</span>
        <span class="nv">location</span> <span class="o">/</span> {
            <span class="nv">root</span>  <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">www</span><span class="c1">;</span>
            <span class="nv">index</span> <span class="nv">index</span>.<span class="nv">html</span> <span class="nv">index</span>.<span class="nv">htm</span><span class="c1">;</span>
        }
    # <span class="nv">Our</span> <span class="nv">endpoint</span> <span class="k">for</span> <span class="nv">tomcat</span> <span class="nv">reverse</span><span class="o">-</span><span class="nv">proxy</span>, <span class="nv">assuming</span> <span class="nv">your</span> <span class="nv">endpoint</span> <span class="nv">java</span><span class="o">-</span><span class="nv">servlet</span> <span class="nv">knows</span>
    # <span class="nv">how</span> <span class="nv">to</span> <span class="nv">handle</span> <span class="nv">http</span>:<span class="o">//</span><span class="nv">localhost</span><span class="o">/</span><span class="nv">gadgets</span>  <span class="nv">requests</span>
        <span class="nv">location</span> <span class="o">/</span><span class="nv">gadgets</span> {
            <span class="nv">proxy_set_header</span> <span class="nv">X</span><span class="o">-</span><span class="nv">Forwarded</span><span class="o">-</span><span class="k">For</span> $<span class="nv">proxy_add_x_forwarded_for</span><span class="c1">;</span>
            <span class="nv">proxy_set_header</span> <span class="nv">Host</span> $<span class="nv">http_host</span><span class="c1">;</span>
        <span class="nv">proxy_set_header</span> <span class="nv">X</span><span class="o">-</span><span class="nv">Forwarded</span><span class="o">-</span><span class="nv">Proto</span> <span class="nv">https</span><span class="c1">;</span>
            <span class="nv">proxy_redirect</span> <span class="nv">off</span><span class="c1">;</span>
            <span class="nv">proxy_connect_timeout</span>      <span class="mi">240</span><span class="c1">;</span>
            <span class="nv">proxy_send_timeout</span>         <span class="mi">240</span><span class="c1">;</span>
            <span class="nv">proxy_read_timeout</span>         <span class="mi">240</span><span class="c1">;</span>
            # <span class="nv">note</span>, <span class="nv">there</span> <span class="nv">is</span> <span class="nv">not</span> <span class="nv">SSL</span> <span class="nv">here</span><span class="o">!</span> <span class="nv">plain</span> <span class="nv">HTTP</span> <span class="nv">is</span> <span class="nv">used</span>
       <span class="nv">proxy_pass</span> <span class="nv">http</span>:<span class="o">//</span><span class="nv">tomcat_server</span><span class="c1">;</span>
        }
     }
}

<span class="nv">Tomcat</span> <span class="nv">config</span>
<span class="nv">And</span> <span class="nv">here</span> <span class="nv">the</span> <span class="nv">magic</span> <span class="nv">begins</span>, <span class="nv">the</span> <span class="nv">main</span> <span class="nv">point</span> <span class="nv">to</span> <span class="nv">not</span> <span class="nv">miss</span> <span class="nv">here</span> <span class="nv">is</span>

<span class="nv">Tomcat</span> <span class="nv">needs</span> <span class="nv">to</span> <span class="nv">be</span> <span class="nv">explicitly</span> <span class="nv">told</span> <span class="nv">that</span> <span class="nv">it</span>’<span class="nv">s</span> <span class="nv">being</span> <span class="nv">proxied</span> <span class="nv">through</span> <span class="mi">443</span><span class="ss">(</span><span class="nv">SSL</span><span class="ss">)</span> <span class="nv">port</span><span class="o">!</span>

<span class="nv">Here</span> <span class="nv">is</span> <span class="nv">a</span> <span class="nv">sample</span> <span class="nv">Tomcat</span> <span class="nv">config</span> <span class="nv">which</span> <span class="nv">is</span> <span class="nv">usually</span> <span class="nv">found</span> <span class="nv">at</span>


{<span class="mh">$CA</span><span class="nv">TALINA_HOME</span>}<span class="o">/</span><span class="nv">conf</span><span class="o">/</span><span class="nv">server</span>.<span class="nv">xml</span>


<span class="o">&lt;</span>?<span class="nv">xml</span> <span class="nv">version</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">1.0</span><span class="s1">&#39;</span> <span class="nv">encoding</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">utf-8</span><span class="s1">&#39;</span>?<span class="o">&gt;</span>
<span class="o">&lt;!--</span>
  <span class="nv">Licensed</span> <span class="nv">to</span> <span class="nv">the</span> <span class="nv">Apache</span> <span class="nv">Software</span> <span class="nv">Foundation</span> <span class="ss">(</span><span class="nv">ASF</span><span class="ss">)</span> <span class="nv">under</span> <span class="nv">one</span> <span class="nv">or</span> <span class="nv">more</span>
  <span class="nv">contributor</span> <span class="nv">license</span> <span class="nv">agreements</span>.  <span class="nv">See</span> <span class="nv">the</span> <span class="nv">NOTICE</span> <span class="nv">file</span> <span class="nv">distributed</span> <span class="nv">with</span>
  <span class="nv">this</span> <span class="nv">work</span> <span class="k">for</span> <span class="nv">additional</span> <span class="nv">information</span> <span class="nv">regarding</span> <span class="nv">copyright</span> <span class="nv">ownership</span>.
  <span class="nv">The</span> <span class="nv">ASF</span> <span class="nv">licenses</span> <span class="nv">this</span> <span class="nv">file</span> <span class="nv">to</span> <span class="nv">You</span> <span class="nv">under</span> <span class="nv">the</span> <span class="nv">Apache</span> <span class="nv">License</span>, <span class="nv">Version</span> <span class="mi">2</span>.<span class="mi">0</span>
  <span class="ss">(</span><span class="nv">the</span> <span class="s2">&quot;</span><span class="s">License</span><span class="s2">&quot;</span><span class="ss">)</span><span class="c1">; you may not use this file except in compliance with</span>
  <span class="nv">the</span> <span class="nv">License</span>.  <span class="nv">You</span> <span class="nv">may</span> <span class="nv">obtain</span> <span class="nv">a</span> <span class="nv">copy</span> <span class="nv">of</span> <span class="nv">the</span> <span class="nv">License</span> <span class="nv">at</span>

<span class="nv">http</span>:<span class="o">//</span><span class="nv">www</span>.<span class="nv">apache</span>.<span class="nv">org</span><span class="o">/</span><span class="nv">licenses</span><span class="o">/</span><span class="nv">LICENSE</span><span class="o">-</span><span class="mi">2</span>.<span class="mi">0</span>

  <span class="nv">Unless</span> <span class="nv">required</span> <span class="nv">by</span> <span class="nv">applicable</span> <span class="nv">law</span> <span class="nv">or</span> <span class="nv">agreed</span> <span class="nv">to</span> <span class="nv">in</span> <span class="nv">writing</span>, <span class="nv">software</span>
  <span class="nv">distributed</span> <span class="nv">under</span> <span class="nv">the</span> <span class="nv">License</span> <span class="nv">is</span> <span class="nv">distributed</span> <span class="nv">on</span> <span class="nv">an</span> <span class="s2">&quot;</span><span class="s">AS IS</span><span class="s2">&quot;</span> <span class="nv">BASIS</span>,
  <span class="nv">WITHOUT</span> <span class="nv">WARRANTIES</span> <span class="nv">OR</span> <span class="nv">CONDITIONS</span> <span class="nv">OF</span> <span class="nv">ANY</span> <span class="nv">KIND</span>, <span class="nv">either</span> <span class="nv">express</span> <span class="nv">or</span> <span class="nv">implied</span>.
  <span class="nv">See</span> <span class="nv">the</span> <span class="nv">License</span> <span class="k">for</span> <span class="nv">the</span> <span class="nv">specific</span> <span class="nv">language</span> <span class="nv">governing</span> <span class="nv">permissions</span> <span class="nv">and</span>
  <span class="nv">limitations</span> <span class="nv">under</span> <span class="nv">the</span> <span class="nv">License</span>.
<span class="o">--&gt;</span>
<span class="o">&lt;!--</span> <span class="nv">Note</span>:  <span class="nv">A</span> <span class="s2">&quot;</span><span class="s">Server</span><span class="s2">&quot;</span> <span class="nv">is</span> <span class="nv">not</span> <span class="nv">itself</span> <span class="nv">a</span> <span class="s2">&quot;</span><span class="s">Container</span><span class="s2">&quot;</span>, <span class="nv">so</span> <span class="nv">you</span> <span class="nv">may</span> <span class="nv">not</span>
     <span class="nv">define</span> <span class="nv">subcomponents</span> <span class="nv">such</span> <span class="nv">as</span> <span class="s2">&quot;</span><span class="s">Valves</span><span class="s2">&quot;</span> <span class="nv">at</span> <span class="nv">this</span> <span class="nv">level</span>.
     <span class="nv">Documentation</span> <span class="nv">at</span> <span class="o">/</span><span class="nv">docs</span><span class="o">/</span><span class="nv">config</span><span class="o">/</span><span class="nv">server</span>.<span class="nv">html</span>
 <span class="o">--&gt;</span>
<span class="o">&lt;</span><span class="nv">Server</span> <span class="nv">port</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">8005</span><span class="s2">&quot;</span> <span class="nv">shutdown</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">SHUTDOWN</span><span class="s2">&quot;</span><span class="o">&gt;</span>
  <span class="o">&lt;!--</span> <span class="nv">Security</span> <span class="nv">listener</span>. <span class="nv">Documentation</span> <span class="nv">at</span> <span class="o">/</span><span class="nv">docs</span><span class="o">/</span><span class="nv">config</span><span class="o">/</span><span class="nv">listeners</span>.<span class="nv">html</span>
  <span class="o">&lt;</span><span class="nv">Listener</span> <span class="nv">className</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">org.apache.catalina.security.SecurityListener</span><span class="s2">&quot;</span> <span class="o">/&gt;</span>
  <span class="o">--&gt;</span>
  <span class="o">&lt;!--</span><span class="nv">APR</span> <span class="nv">library</span> <span class="nv">loader</span>. <span class="nv">Documentation</span> <span class="nv">at</span> <span class="o">/</span><span class="nv">docs</span><span class="o">/</span><span class="nv">apr</span>.<span class="nv">html</span> <span class="o">--&gt;</span>
  <span class="o">&lt;</span><span class="nv">Listener</span> <span class="nv">className</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">org.apache.catalina.core.AprLifecycleListener</span><span class="s2">&quot;</span> <span class="nv">SSLEngine</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">on</span><span class="s2">&quot;</span> <span class="o">/&gt;</span>
  <span class="o">&lt;!--</span><span class="nv">Initialize</span> <span class="nv">Jasper</span> <span class="nv">prior</span> <span class="nv">to</span> <span class="nv">webapps</span> <span class="nv">are</span> <span class="nv">loaded</span>. <span class="nv">Documentation</span> <span class="nv">at</span> <span class="o">/</span><span class="nv">docs</span><span class="o">/</span><span class="nv">jasper</span><span class="o">-</span><span class="nv">howto</span>.<span class="nv">html</span> <span class="o">--&gt;</span>
  <span class="o">&lt;</span><span class="nv">Listener</span> <span class="nv">className</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">org.apache.catalina.core.JasperListener</span><span class="s2">&quot;</span> <span class="o">/&gt;</span>
  <span class="o">&lt;!--</span> <span class="nv">Prevent</span> <span class="nv">memory</span> <span class="nv">leaks</span> <span class="nv">due</span> <span class="nv">to</span> <span class="nv">use</span> <span class="nv">of</span> <span class="nv">particular</span> <span class="nv">java</span><span class="o">/</span><span class="nv">javax</span> <span class="nv">APIs</span><span class="o">--&gt;</span>
  <span class="o">&lt;</span><span class="nv">Listener</span> <span class="nv">className</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">org.apache.catalina.core.JreMemoryLeakPreventionListener</span><span class="s2">&quot;</span> <span class="o">/&gt;</span>
  <span class="o">&lt;</span><span class="nv">Listener</span> <span class="nv">className</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">org.apache.catalina.mbeans.GlobalResourcesLifecycleListener</span><span class="s2">&quot;</span> <span class="o">/&gt;</span>
  <span class="o">&lt;</span><span class="nv">Listener</span> <span class="nv">className</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">org.apache.catalina.core.ThreadLocalLeakPreventionListener</span><span class="s2">&quot;</span> <span class="o">/&gt;</span>

  <span class="o">&lt;!--</span> <span class="nv">Global</span> <span class="nv">JNDI</span> <span class="nv">resources</span>
       <span class="nv">Documentation</span> <span class="nv">at</span> <span class="o">/</span><span class="nv">docs</span><span class="o">/</span><span class="nv">jndi</span><span class="o">-</span><span class="nv">resources</span><span class="o">-</span><span class="nv">howto</span>.<span class="nv">html</span>
  <span class="o">--&gt;</span>

<span class="o">&lt;!--</span>  <span class="o">&lt;</span><span class="nv">GlobalNamingResources</span><span class="o">&gt;--&gt;</span>
    <span class="o">&lt;!--</span> <span class="nv">Editable</span> <span class="nv">user</span> <span class="nv">database</span> <span class="nv">that</span> <span class="nv">can</span> <span class="nv">also</span> <span class="nv">be</span> <span class="nv">used</span> <span class="nv">by</span>
         <span class="nv">UserDatabaseRealm</span> <span class="nv">to</span> <span class="nv">authenticate</span> <span class="nv">users</span>
    <span class="o">--&gt;</span>
<span class="o">&lt;!--</span>
    <span class="o">&lt;</span><span class="nv">Resource</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">UserDatabase</span><span class="s2">&quot;</span> <span class="nv">auth</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">Container</span><span class="s2">&quot;</span>
              <span class="nv">type</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">org.apache.catalina.UserDatabase</span><span class="s2">&quot;</span>
              <span class="nv">description</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">User database that can be updated and saved</span><span class="s2">&quot;</span>
              <span class="nv">factory</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">org.apache.catalina.users.MemoryUserDatabaseFactory</span><span class="s2">&quot;</span>
              <span class="nv">pathname</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">conf/tomcat-users.xml</span><span class="s2">&quot;</span> <span class="o">/&gt;</span>
  <span class="o">&lt;/</span><span class="nv">GlobalNamingResources</span><span class="o">&gt;</span> <span class="o">--&gt;</span>

  <span class="o">&lt;!--</span> <span class="nv">A</span> <span class="s2">&quot;</span><span class="s">Service</span><span class="s2">&quot;</span> <span class="nv">is</span> <span class="nv">a</span> <span class="nv">collection</span> <span class="nv">of</span> <span class="nv">one</span> <span class="nv">or</span> <span class="nv">more</span> <span class="s2">&quot;</span><span class="s">Connectors</span><span class="s2">&quot;</span> <span class="nv">that</span> <span class="nv">share</span>
       <span class="nv">a</span> <span class="nv">single</span> <span class="s2">&quot;</span><span class="s">Container</span><span class="s2">&quot;</span> <span class="nv">Note</span>:  <span class="nv">A</span> <span class="s2">&quot;</span><span class="s">Service</span><span class="s2">&quot;</span> <span class="nv">is</span> <span class="nv">not</span> <span class="nv">itself</span> <span class="nv">a</span> <span class="s2">&quot;</span><span class="s">Container</span><span class="s2">&quot;</span>,
       <span class="nv">so</span> <span class="nv">you</span> <span class="nv">may</span> <span class="nv">not</span> <span class="nv">define</span> <span class="nv">subcomponents</span> <span class="nv">such</span> <span class="nv">as</span> <span class="s2">&quot;</span><span class="s">Valves</span><span class="s2">&quot;</span> <span class="nv">at</span> <span class="nv">this</span> <span class="nv">level</span>.
       <span class="nv">Documentation</span> <span class="nv">at</span> <span class="o">/</span><span class="nv">docs</span><span class="o">/</span><span class="nv">config</span><span class="o">/</span><span class="nv">service</span>.<span class="nv">html</span>
   <span class="o">--&gt;</span>
  <span class="o">&lt;</span><span class="nv">Service</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">Catalina</span><span class="s2">&quot;</span><span class="o">&gt;</span>

    <span class="o">&lt;!--</span><span class="nv">The</span> <span class="nv">connectors</span> <span class="nv">can</span> <span class="nv">use</span> <span class="nv">a</span> <span class="nv">shared</span> <span class="nv">executor</span>, <span class="nv">you</span> <span class="nv">can</span> <span class="nv">define</span> <span class="nv">one</span> <span class="nv">or</span> <span class="nv">more</span> <span class="nv">named</span> <span class="nv">thread</span> <span class="nv">pools</span><span class="o">--&gt;</span>
    <span class="o">&lt;!--</span>
    <span class="o">&lt;</span><span class="nv">Executor</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">tomcatThreadPool</span><span class="s2">&quot;</span> <span class="nv">namePrefix</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">catalina-exec-</span><span class="s2">&quot;</span>
        <span class="nv">maxThreads</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">150</span><span class="s2">&quot;</span> <span class="nv">minSpareThreads</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">4</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
    <span class="o">--&gt;</span>

    <span class="o">&lt;!--</span> <span class="nv">A</span> <span class="s2">&quot;</span><span class="s">Connector</span><span class="s2">&quot;</span> <span class="nv">represents</span> <span class="nv">an</span> <span class="nv">endpoint</span> <span class="nv">by</span> <span class="nv">which</span> <span class="nv">requests</span> <span class="nv">are</span> <span class="nv">received</span>
         <span class="nv">and</span> <span class="nv">responses</span> <span class="nv">are</span> <span class="nv">returned</span>. <span class="nv">Documentation</span> <span class="nv">at</span> :
         <span class="nv">Java</span> <span class="nv">HTTP</span> <span class="nv">Connector</span>: <span class="o">/</span><span class="nv">docs</span><span class="o">/</span><span class="nv">config</span><span class="o">/</span><span class="nv">http</span>.<span class="nv">html</span> <span class="ss">(</span><span class="nv">blocking</span> <span class="o">&amp;</span> <span class="nv">non</span><span class="o">-</span><span class="nv">blocking</span><span class="ss">)</span>
         <span class="nv">Java</span> <span class="nv">AJP</span>  <span class="nv">Connector</span>: <span class="o">/</span><span class="nv">docs</span><span class="o">/</span><span class="nv">config</span><span class="o">/</span><span class="nv">ajp</span>.<span class="nv">html</span>
         <span class="nv">APR</span> <span class="ss">(</span><span class="nv">HTTP</span><span class="o">/</span><span class="nv">AJP</span><span class="ss">)</span> <span class="nv">Connector</span>: <span class="o">/</span><span class="nv">docs</span><span class="o">/</span><span class="nv">apr</span>.<span class="nv">html</span>
         <span class="nv">Define</span> <span class="nv">a</span> <span class="nv">non</span><span class="o">-</span><span class="nv">SSL</span> <span class="nv">HTTP</span><span class="o">/</span><span class="mi">1</span>.<span class="mi">1</span> <span class="nv">Connector</span> <span class="nv">on</span> <span class="nv">port</span> <span class="mi">8080</span>
    <span class="o">--&gt;</span>
    <span class="o">&lt;</span><span class="nv">Connector</span> <span class="nv">port</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">8080</span><span class="s2">&quot;</span> <span class="nv">protocol</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">HTTP/1.1</span><span class="s2">&quot;</span>
               <span class="nv">connectionTimeout</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">20000</span><span class="s2">&quot;</span>
               <span class="nv">redirectPort</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">8443</span><span class="s2">&quot;</span>
           <span class="nv">proxyName</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">localhost</span><span class="s2">&quot;</span>
               <span class="nv">proxyPort</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">443</span><span class="s2">&quot;</span>
               <span class="nv">scheme</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">https</span><span class="s2">&quot;</span>
                <span class="o">/&gt;</span>
    <span class="o">&lt;!--</span> <span class="nv">A</span> <span class="s2">&quot;</span><span class="s">Connector</span><span class="s2">&quot;</span> <span class="nv">using</span> <span class="nv">the</span> <span class="nv">shared</span> <span class="nv">thread</span> <span class="nv">pool</span><span class="o">--&gt;</span>
    <span class="o">&lt;!--</span>
    <span class="o">&lt;</span><span class="nv">Connector</span> <span class="nv">executor</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">tomcatThreadPool</span><span class="s2">&quot;</span>
               <span class="nv">port</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">8080</span><span class="s2">&quot;</span> <span class="nv">protocol</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">HTTP/1.1</span><span class="s2">&quot;</span>
               <span class="nv">connectionTimeout</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">20000</span><span class="s2">&quot;</span>
               <span class="nv">redirectPort</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">8443</span><span class="s2">&quot;</span> <span class="o">/&gt;</span>
    <span class="o">--&gt;</span>
    <span class="o">&lt;!--</span> <span class="nv">Define</span> <span class="nv">a</span> <span class="nv">SSL</span> <span class="nv">HTTP</span><span class="o">/</span><span class="mi">1</span>.<span class="mi">1</span> <span class="nv">Connector</span> <span class="nv">on</span> <span class="nv">port</span> <span class="mi">8443</span>
         <span class="nv">This</span> <span class="nv">connector</span> <span class="nv">uses</span> <span class="nv">the</span> <span class="nv">JSSE</span> <span class="nv">configuration</span>, <span class="nv">when</span> <span class="nv">using</span> <span class="nv">APR</span>, <span class="nv">the</span>
         <span class="nv">connector</span> <span class="nv">should</span> <span class="nv">be</span> <span class="nv">using</span> <span class="nv">the</span> <span class="nv">OpenSSL</span> <span class="nv">style</span> <span class="nv">configuration</span>
         <span class="nv">described</span> <span class="nv">in</span> <span class="nv">the</span> <span class="nv">APR</span> <span class="nv">documentation</span> <span class="o">--&gt;</span>
    <span class="o">&lt;!--</span>
    <span class="o">&lt;</span><span class="nv">Connector</span> <span class="nv">port</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">8443</span><span class="s2">&quot;</span> <span class="nv">protocol</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">HTTP/1.1</span><span class="s2">&quot;</span> <span class="nv">SSLEnabled</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">true</span><span class="s2">&quot;</span>
               <span class="nv">maxThreads</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">150</span><span class="s2">&quot;</span> <span class="nv">scheme</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">https</span><span class="s2">&quot;</span> <span class="nv">secure</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">true</span><span class="s2">&quot;</span>
               <span class="nv">clientAuth</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">false</span><span class="s2">&quot;</span> <span class="nv">sslProtocol</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">TLS</span><span class="s2">&quot;</span> <span class="o">/&gt;</span>
    <span class="o">--&gt;</span>

    <span class="o">&lt;!--</span> <span class="nv">Define</span> <span class="nv">an</span> <span class="nv">AJP</span> <span class="mi">1</span>.<span class="mi">3</span> <span class="nv">Connector</span> <span class="nv">on</span> <span class="nv">port</span> <span class="mi">8009</span> <span class="o">--&gt;</span>
  <span class="o">&lt;!--</span>  <span class="o">&lt;</span><span class="nv">Connector</span> <span class="nv">port</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">8009</span><span class="s2">&quot;</span> <span class="nv">protocol</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">AJP/1.3</span><span class="s2">&quot;</span> <span class="nv">redirectPort</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">8443</span><span class="s2">&quot;</span> <span class="o">/&gt;--&gt;</span>

    <span class="o">&lt;!--</span> <span class="nv">An</span> <span class="nv">Engine</span> <span class="nv">represents</span> <span class="nv">the</span> <span class="nv">entry</span> <span class="nv">point</span> <span class="ss">(</span><span class="nv">within</span> <span class="nv">Catalina</span><span class="ss">)</span> <span class="nv">that</span> <span class="nv">processes</span>
         <span class="nv">every</span> <span class="nv">request</span>.  <span class="nv">The</span> <span class="nv">Engine</span> <span class="nv">implementation</span> <span class="k">for</span> <span class="nv">Tomcat</span> <span class="nv">stand</span> <span class="nv">alone</span>
         <span class="nv">analyzes</span> <span class="nv">the</span> <span class="nv">HTTP</span> <span class="nv">headers</span> <span class="nv">included</span> <span class="nv">with</span> <span class="nv">the</span> <span class="nv">request</span>, <span class="nv">and</span> <span class="nv">passes</span> <span class="nv">them</span>
         <span class="nv">on</span> <span class="nv">to</span> <span class="nv">the</span> <span class="nv">appropriate</span> <span class="nv">Host</span> <span class="ss">(</span><span class="nv">virtual</span> <span class="nv">host</span><span class="ss">)</span>.
         <span class="nv">Documentation</span> <span class="nv">at</span> <span class="o">/</span><span class="nv">docs</span><span class="o">/</span><span class="nv">config</span><span class="o">/</span><span class="nv">engine</span>.<span class="nv">html</span> <span class="o">--&gt;</span>

    <span class="o">&lt;!--</span> <span class="nv">You</span> <span class="nv">should</span> <span class="nv">set</span> <span class="nv">jvmRoute</span> <span class="nv">to</span> <span class="nv">support</span> <span class="nv">load</span><span class="o">-</span><span class="nv">balancing</span> <span class="nv">via</span> <span class="nv">AJP</span> <span class="nv">ie</span> :
    <span class="o">&lt;</span><span class="nv">Engine</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">Catalina</span><span class="s2">&quot;</span> <span class="nv">defaultHost</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">localhost</span><span class="s2">&quot;</span> <span class="nv">jvmRoute</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">jvm1</span><span class="s2">&quot;</span><span class="o">&gt;</span>
    <span class="o">--&gt;</span>
    <span class="o">&lt;</span><span class="nv">Engine</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">Catalina</span><span class="s2">&quot;</span> <span class="nv">defaultHost</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">localhost</span><span class="s2">&quot;</span><span class="o">&gt;</span>

      <span class="o">&lt;!--</span><span class="k">For</span> <span class="nv">clustering</span>, <span class="nv">please</span> <span class="nv">take</span> <span class="nv">a</span> <span class="nv">look</span> <span class="nv">at</span> <span class="nv">documentation</span> <span class="nv">at</span>:
          <span class="o">/</span><span class="nv">docs</span><span class="o">/</span><span class="nv">cluster</span><span class="o">-</span><span class="nv">howto</span>.<span class="nv">html</span>  <span class="ss">(</span><span class="nv">simple</span> <span class="nv">how</span> <span class="nv">to</span><span class="ss">)</span>
          <span class="o">/</span><span class="nv">docs</span><span class="o">/</span><span class="nv">config</span><span class="o">/</span><span class="nv">cluster</span>.<span class="nv">html</span> <span class="ss">(</span><span class="nv">reference</span> <span class="nv">documentation</span><span class="ss">)</span> <span class="o">--&gt;</span>
      <span class="o">&lt;!--</span>
      <span class="o">&lt;</span><span class="nv">Cluster</span> <span class="nv">className</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">org.apache.catalina.ha.tcp.SimpleTcpCluster</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
      <span class="o">--&gt;</span>        

      <span class="o">&lt;!--</span> <span class="nv">Use</span> <span class="nv">the</span> <span class="nv">LockOutRealm</span> <span class="nv">to</span> <span class="nv">prevent</span> <span class="nv">attempts</span> <span class="nv">to</span> <span class="nv">guess</span> <span class="nv">user</span> <span class="nv">passwords</span>
           <span class="nv">via</span> <span class="nv">a</span> <span class="nv">brute</span><span class="o">-</span><span class="nv">force</span> <span class="nv">attack</span> <span class="o">--&gt;</span>
<span class="o">&lt;!--</span>      <span class="o">&lt;</span><span class="nv">Realm</span> <span class="nv">className</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">org.apache.catalina.realm.LockOutRealm</span><span class="s2">&quot;</span><span class="o">&gt;</span> <span class="o">--&gt;</span>
        <span class="o">&lt;!--</span> <span class="nv">This</span> <span class="nv">Realm</span> <span class="nv">uses</span> <span class="nv">the</span> <span class="nv">UserDatabase</span> <span class="nv">configured</span> <span class="nv">in</span> <span class="nv">the</span> <span class="nv">global</span> <span class="nv">JNDI</span>
             <span class="nv">resources</span> <span class="nv">under</span> <span class="nv">the</span> <span class="nv">key</span> <span class="s2">&quot;</span><span class="s">UserDatabase</span><span class="s2">&quot;</span>.  <span class="nv">Any</span> <span class="nv">edits</span>
             <span class="nv">that</span> <span class="nv">are</span> <span class="nv">performed</span> <span class="nv">against</span> <span class="nv">this</span> <span class="nv">UserDatabase</span> <span class="nv">are</span> <span class="nv">immediately</span>
             <span class="nv">available</span> <span class="k">for</span> <span class="nv">use</span> <span class="nv">by</span> <span class="nv">the</span> <span class="nv">Realm</span>.  <span class="o">--&gt;</span>
<span class="o">&lt;!--</span>        <span class="o">&lt;</span><span class="nv">Realm</span> <span class="nv">className</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">org.apache.catalina.realm.UserDatabaseRealm</span><span class="s2">&quot;</span>    <span class="nv">resourceName</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">UserDatabase</span><span class="s2">&quot;</span><span class="o">/&gt;--&gt;</span>
<span class="o">&lt;!--</span>      <span class="o">&lt;/</span><span class="nv">Realm</span><span class="o">&gt;--&gt;</span>

      <span class="o">&lt;</span><span class="nv">Host</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">localhost</span><span class="s2">&quot;</span>  <span class="nv">appBase</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">webapps</span><span class="s2">&quot;</span>   <span class="nv">unpackWARs</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">true</span><span class="s2">&quot;</span> <span class="nv">autoDeploy</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">true</span><span class="s2">&quot;</span><span class="o">&gt;</span>

        <span class="o">&lt;!--</span> <span class="nv">SingleSignOn</span> <span class="nv">valve</span>, <span class="nv">share</span> <span class="nv">authentication</span> <span class="nv">between</span> <span class="nv">web</span> <span class="nv">applications</span>
             <span class="nv">Documentation</span> <span class="nv">at</span>: <span class="o">/</span><span class="nv">docs</span><span class="o">/</span><span class="nv">config</span><span class="o">/</span><span class="nv">valve</span>.<span class="nv">html</span> <span class="o">--&gt;</span>
        <span class="o">&lt;!--</span>
        <span class="o">&lt;</span><span class="nv">Valve</span> <span class="nv">className</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">org.apache.catalina.authenticator.SingleSignOn</span><span class="s2">&quot;</span> <span class="o">/&gt;</span>
        <span class="o">--&gt;</span>

        <span class="o">&lt;!--</span> <span class="nv">Access</span> <span class="nv">log</span> <span class="nv">processes</span> <span class="nv">all</span> <span class="nv">example</span>.
             <span class="nv">Documentation</span> <span class="nv">at</span>: <span class="o">/</span><span class="nv">docs</span><span class="o">/</span><span class="nv">config</span><span class="o">/</span><span class="nv">valve</span>.<span class="nv">html</span>
             <span class="nv">Note</span>: <span class="nv">The</span> <span class="nv">pattern</span> <span class="nv">used</span> <span class="nv">is</span> <span class="nv">equivalent</span> <span class="nv">to</span> <span class="nv">using</span> <span class="nv">pattern</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">common</span><span class="s2">&quot;</span> <span class="o">--&gt;</span>

        <span class="o">&lt;</span><span class="nv">Valve</span> <span class="nv">className</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">org.apache.catalina.valves.AccessLogValve</span><span class="s2">&quot;</span> <span class="nv">directory</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">logs</span><span class="s2">&quot;</span>
               <span class="nv">prefix</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">localhost_access_log.</span><span class="s2">&quot;</span> <span class="nv">suffix</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">.txt</span><span class="s2">&quot;</span>
               <span class="nv">pattern</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">%h %l %u %t </span><span class="s2">&quot;</span><span class="o">%</span><span class="nv">r</span><span class="s2">&quot;</span><span class="s"> %s %b</span><span class="s2">&quot;</span> <span class="nv">resolveHosts</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">false</span><span class="s2">&quot;</span><span class="o">/&gt;</span>

      <span class="o">&lt;/</span><span class="nv">Host</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="nv">Engine</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="nv">Service</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="nv">Server</span><span class="o">&gt;</span>

<span class="nv">As</span> <span class="nv">it</span> <span class="nv">turned</span> <span class="nv">out</span> <span class="nv">proxyPort</span> <span class="nv">property</span> <span class="nv">was</span> <span class="nv">the</span> <span class="nv">key</span> <span class="nv">to</span> <span class="nv">proxying</span> <span class="nv">Tomcat</span> <span class="nv">via</span> <span class="nv">Nginx</span>.
</pre></div>


<h2 id="tomcat_3">tomcat内存溢出</h2>
<div class="codehilite"><pre><span></span><span class="nt">Tomcat</span><span class="err">内存溢出的原因</span>
<span class="err">　　在生产环境中</span><span class="nt">tomcat</span><span class="err">内存设置不好很容易出现内存溢出。造成内存溢出是不一样的，当然处理方式也不一样。</span>
<span class="err">　　这里根据平时遇到的情况和相关资料进行一个总结。常见的一般会有下面三种情况：</span>
<span class="err">　　</span><span class="nt">1</span><span class="p">.</span><span class="nc">OutOfMemoryError</span><span class="err">：</span> <span class="nt">Java</span> <span class="nt">heap</span> <span class="nt">space</span>
<span class="err">　　</span><span class="nt">2</span><span class="p">.</span><span class="nc">OutOfMemoryError</span><span class="err">：</span> <span class="nt">PermGen</span> <span class="nt">space</span>
<span class="err">　　</span><span class="nt">3</span><span class="p">.</span><span class="nc">OutOfMemoryError</span><span class="err">：</span> <span class="nt">unable</span> <span class="nt">to</span> <span class="nt">create</span> <span class="nt">new</span> <span class="nt">native</span> <span class="nt">thread</span><span class="o">.</span>
<span class="err">　　</span><span class="nt">Tomcat</span><span class="err">内存溢出解决方案</span>
<span class="err">　　对于前两种情况，在应用本身没有内存泄露的情况下可以用设置</span><span class="nt">tomcat</span> <span class="nt">jvm</span><span class="err">参数来解决。（</span><span class="nt">-Xms</span> <span class="nt">-Xmx</span> <span class="nt">-XX</span><span class="err">：</span><span class="nt">PermSize</span> <span class="nt">-XX</span><span class="err">：</span><span class="nt">MaxPermSize</span><span class="err">）</span>
<span class="err">　　最后一种可能需要调整操作系统和</span><span class="nt">tomcat</span> <span class="nt">jvm</span><span class="err">参数同时调整才能达到目的。</span>
<span class="err">　　第一种：是堆溢出。</span>
<span class="err">　　原因分析：</span>
<span class="nt">JVM</span><span class="err">堆的设置是指</span><span class="nt">java</span><span class="err">程序运行过程中</span><span class="nt">JVM</span><span class="err">可以调配使用的内存空间的设置</span><span class="p">.</span><span class="nc">JVM</span><span class="err">在启动的时候会自动设置</span><span class="nt">Heap</span> <span class="nt">size</span><span class="err">的值，</span>
<span class="err">其初始空间</span><span class="o">(</span><span class="err">即</span><span class="nt">-Xms</span><span class="o">)</span><span class="err">是物理内存的</span><span class="nt">1</span><span class="o">/</span><span class="nt">64</span><span class="err">，最大空间</span><span class="o">(</span><span class="nt">-Xmx</span><span class="o">)</span><span class="err">是物理内存的</span><span class="nt">1</span><span class="o">/</span><span class="nt">4</span><span class="err">。可以利用</span><span class="nt">JVM</span><span class="err">提供的</span><span class="nt">-Xmn</span> <span class="nt">-Xms</span> <span class="nt">-Xmx</span><span class="err">等选项可进行设置。</span>
<span class="nt">Heap</span> <span class="nt">size</span> <span class="err">的大小是</span><span class="nt">Young</span> <span class="nt">Generation</span> <span class="err">和</span><span class="nt">Tenured</span> <span class="nt">Generaion</span> <span class="err">之和。</span>
<span class="err">在</span><span class="nt">JVM</span><span class="err">中如果</span><span class="nt">98</span><span class="err">％的时间是用于</span><span class="nt">GC</span><span class="err">且可用的</span><span class="nt">Heap</span> <span class="nt">size</span> <span class="err">不足</span><span class="nt">2</span><span class="err">％的时候将抛出此异常信息。</span>
<span class="nt">Heap</span> <span class="nt">Size</span> <span class="err">最大不要超过可用物理内存的</span><span class="nt">80</span><span class="err">％，一般的要将</span><span class="nt">-Xms</span><span class="err">和</span><span class="nt">-Xmx</span><span class="err">选项设置为相同，而</span><span class="nt">-Xmn</span><span class="err">为</span><span class="nt">1</span><span class="o">/</span><span class="nt">4</span><span class="err">的</span><span class="nt">-Xmx</span><span class="err">值。</span>
<span class="err">　　没有内存泄露的情况下，调整</span><span class="nt">-Xms</span> <span class="nt">-Xmx</span><span class="err">参数可以解决。</span>
<span class="err">　　</span><span class="nt">-Xms</span><span class="err">：初始堆大小</span>
<span class="err">　　</span><span class="nt">-Xmx</span><span class="err">：最大堆大小</span>
<span class="err">　　但堆的大小受下面三方面影响：</span>
<span class="err">　　</span><span class="nt">1</span><span class="o">.</span><span class="err">相关操作系统的数据模型（</span><span class="nt">32-bt</span><span class="err">还是</span><span class="nt">64-bit</span><span class="err">）限制；（</span><span class="nt">32</span><span class="err">位系统下，一般限制在</span><span class="nt">1</span><span class="p">.</span><span class="nc">5G</span><span class="o">~</span><span class="nt">2G</span><span class="err">；我在</span><span class="nt">2003</span> <span class="nt">server</span> <span class="err">系统下</span>
<span class="err">（物理内存：</span><span class="nt">4G</span><span class="err">和</span><span class="nt">6G</span><span class="err">，</span><span class="nt">jdk</span><span class="err">：</span><span class="nt">1</span><span class="p">.</span><span class="nc">6</span><span class="err">）测试</span> <span class="nt">1612M</span><span class="err">，</span><span class="nt">64</span><span class="err">位操作系统对内存无限制。）</span>
<span class="err">　　</span><span class="nt">2</span><span class="o">.</span><span class="err">系统的可用虚拟内存限制；</span>
<span class="err">　　</span><span class="nt">3</span><span class="o">.</span><span class="err">系统的可用物理内存限制。</span>
<span class="err">　　堆的大小可以使用</span> <span class="nt">java</span> <span class="nt">-Xmx</span><span class="o">***</span><span class="nt">M</span> <span class="nt">version</span> <span class="err">命令来测试。支持的话会出现</span><span class="nt">jdk</span><span class="err">的版本号，不支持会报错。</span>
<span class="err">　　</span><span class="nt">-Xms</span> <span class="nt">-Xmx</span><span class="err">一般配置成一样比较好比如</span><span class="nt">set</span> <span class="nt">JAVA_OPTS</span><span class="o">=</span> <span class="nt">-Xms1024m</span> <span class="nt">-Xmx1024m</span>

<span class="err">其初始空间</span><span class="o">(</span><span class="err">即</span><span class="nt">-Xms</span><span class="o">)</span><span class="err">是物理内存的</span><span class="nt">1</span><span class="o">/</span><span class="nt">64</span><span class="err">，最大空间</span><span class="o">(</span><span class="nt">-Xmx</span><span class="o">)</span><span class="err">是物理内存的</span><span class="nt">1</span><span class="o">/</span><span class="nt">4</span><span class="err">。可以利用</span><span class="nt">JVM</span><span class="err">提供的</span><span class="nt">-Xmn</span> <span class="nt">-Xms</span> <span class="nt">-Xmx</span><span class="err">等选项可</span>
<span class="err">进行设置</span>
<span class="err">实例，以下给出</span><span class="nt">1G</span><span class="err">内存环境下</span><span class="nt">java</span> <span class="nt">jvm</span> <span class="err">的参数设置参考：</span>
<span class="nt">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;-server -Xms800m -Xmx800m  -XX:PermSize=64M -XX:MaxNewSize=256m -XX:MaxPermSize=128m </span>
<span class="s2">-Djava.awt.headless=true &quot;</span>
<span class="nt">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;-server -Xms768m -Xmx768m -XX:PermSize=128m -XX:MaxPermSize=256m -XX:</span>
<span class="s2">NewSize=192m -XX:MaxNewSize=384m&quot;</span>
<span class="nt">CATALINA_OPTS</span><span class="o">=</span><span class="s2">&quot;-server -Xms768m -Xmx768m -XX:PermSize=128m -XX:MaxPermSize=256m</span>
<span class="s2">-XX:NewSize=192m -XX:MaxNewSize=384m&quot;</span>

<span class="err">服务器为</span><span class="nt">1G</span><span class="err">内存：</span><span class="nt">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;-server -Xms800m -Xmx800m -XX:PermSize=64M -XX:MaxNewSize=256m </span>
<span class="s2">-XX:MaxPermSize=128m -Djava.awt.headless=true &quot;</span>
<span class="err">服务器为</span><span class="nt">64</span><span class="err">位、</span><span class="nt">2G</span><span class="err">内存</span><span class="o">:</span> <span class="nt">JAVA_OPTS</span><span class="o">=</span><span class="s1">&#39;-server -Xms1024m -Xmx1536m -XX:PermSize=128M -XX:MaxNewSize=256m</span>
<span class="s1"> -XX:MaxPermSize=256m&#39;</span>

<span class="nt">-------------------</span><span class="err">解决方案</span><span class="nt">1</span><span class="err">：</span><span class="nt">-----------------------------</span>
<span class="err">前提：是执行</span><span class="nt">startup</span><span class="p">.</span><span class="nc">bat</span><span class="err">启动</span><span class="nt">tomcat</span><span class="err">的方式</span>
<span class="nt">Linux</span><span class="err">服务器：</span>
<span class="err">在</span><span class="o">/</span><span class="nt">usr</span><span class="o">/</span><span class="nt">local</span><span class="o">/</span><span class="nt">apache-tomcat-5</span><span class="p">.</span><span class="nc">5</span><span class="p">.</span><span class="nc">23</span><span class="o">/</span><span class="nt">bin</span> <span class="err">目录下的</span><span class="nt">catalina</span><span class="p">.</span><span class="nc">sh</span>
<span class="err">添加：</span><span class="nt">JAVA_OPTS</span><span class="o">=</span><span class="s1">&#39;-Xms512m -Xmx1024m&#39;</span>
<span class="err">或者</span> <span class="nt">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;-server -Xms800m -Xmx800m   -XX:MaxNewSize=256m&quot;</span>
<span class="err">或者</span> <span class="nt">CATALINA_OPTS</span><span class="o">=</span><span class="s2">&quot;-server -Xms256m -Xmx300m&quot;</span>
<span class="nt">Windows</span><span class="err">服务器：</span>
<span class="err">在</span><span class="nt">catalina</span><span class="p">.</span><span class="nc">bat</span><span class="err">最前面加入</span>
<span class="nt">set</span> <span class="nt">JAVA_OPTS</span><span class="o">=</span><span class="nt">-Xms128m</span> <span class="nt">-Xmx350m</span>
<span class="err">或者</span><span class="nt">set</span> <span class="nt">CATALINA_OPTS</span><span class="o">=</span><span class="nt">-Xmx300M</span> <span class="nt">-Xms256M</span>
<span class="err">（区别是一个直接设置</span><span class="nt">jvm</span><span class="err">内存，</span> <span class="err">另一个设置</span><span class="nt">tomcat</span><span class="err">内存，</span><span class="nt">CATALINA_OPTS</span><span class="err">似乎可以与</span><span class="nt">JAVA_OPTS</span><span class="err">不加区别的使用）</span>
<span class="err">基本参数说明</span>
<span class="nt">-client</span><span class="err">，</span><span class="nt">-server</span>
<span class="err">这两个参数用于设置虚拟机使用何种运行模式，一定要作为第一个参数，</span><span class="nt">client</span><span class="err">模式启动比较快，但运行时性能和内存管理</span>
<span class="err">效率不如</span><span class="nt">server</span><span class="err">模式，通常用于客户端应用程序。相反，</span><span class="nt">server</span><span class="err">模式启动比</span><span class="nt">client</span><span class="err">慢，但可获得更高的运行性能。</span>
<span class="err">在</span><span class="nt">windows</span><span class="err">上，缺省的虚拟机类型为</span><span class="nt">client</span><span class="err">模式，如果要使用</span><span class="nt">server</span><span class="err">模式，就需要在启动虚拟机时加</span><span class="nt">-server</span><span class="err">参数，以获得更</span>
<span class="err">高性能，对服务器端应用，推荐采用</span><span class="nt">server</span><span class="err">模式，尤其是多个</span><span class="nt">CPU</span><span class="err">的系统。在</span><span class="nt">Linux</span><span class="err">，</span><span class="nt">Solaris</span><span class="err">上缺省采用</span><span class="nt">server</span><span class="err">模式。</span>
<span class="err">此外，在多</span><span class="nt">cup</span><span class="err">下，建议用</span><span class="nt">server</span><span class="err">模式</span>

<span class="nt">-Xms</span><span class="o">&lt;</span><span class="nt">size</span><span class="o">&gt;</span>
<span class="err">设置虚拟机可用内存堆的初始大小，缺省单位为字节，该大小为</span><span class="nt">1024</span><span class="err">的整数倍并且要大于</span><span class="nt">1MB</span><span class="err">，可用</span><span class="nt">k</span><span class="o">(</span><span class="nt">K</span><span class="o">)</span><span class="err">或</span><span class="nt">m</span><span class="o">(</span><span class="nt">M</span><span class="o">)</span><span class="err">为单位来设置较大的</span>
<span class="err">内存数。初始堆大小为</span><span class="nt">2MB</span><span class="err">。加“</span><span class="nt">m</span><span class="err">”说明是</span><span class="nt">MB</span><span class="err">，否则就是</span><span class="nt">KB</span><span class="err">了。</span>
<span class="err">例如：</span><span class="nt">-Xms6400K</span><span class="err">，</span><span class="nt">-Xms256M</span>
<span class="nt">-Xmx</span><span class="o">&lt;</span><span class="nt">size</span><span class="o">&gt;</span>
<span class="err">设置虚拟机</span> <span class="err">的最大可用大小，缺省单位为字节。该值必须为</span><span class="nt">1024</span><span class="err">整数倍，并且要大于</span><span class="nt">2MB</span><span class="err">。可用</span><span class="nt">k</span><span class="o">(</span><span class="nt">K</span><span class="o">)</span><span class="err">或</span><span class="nt">m</span><span class="o">(</span><span class="nt">M</span><span class="o">)</span><span class="err">为单位来设置较大的内存</span>
<span class="err">数。缺省堆最大值为</span><span class="nt">64MB</span><span class="err">。</span>
<span class="err">例如：</span><span class="nt">-Xmx81920K</span><span class="err">，</span><span class="nt">-Xmx80M</span>
<span class="err">当应用程序申请了大内存运行时虚拟机抛出</span><span class="nt">java</span><span class="p">.</span><span class="nc">lang</span><span class="p">.</span><span class="nc">OutOfMemoryError</span><span class="o">:</span> <span class="nt">Java</span> <span class="nt">heap</span> <span class="nt">space</span><span class="err">错误，就需要使用</span><span class="nt">-Xmx</span><span class="err">设置较大的可用内存堆。</span>
<span class="nt">PermSize</span><span class="o">/</span><span class="nt">MaxPermSize</span><span class="err">：定义</span><span class="nt">Perm</span><span class="err">段的尺寸，即永久保存区域的大小，</span><span class="nt">PermSize</span><span class="err">为</span><span class="nt">JVM</span><span class="err">启动时初始化</span><span class="nt">Perm</span><span class="err">的内存大小；</span><span class="nt">MaxPermSize</span><span class="err">为</span>
<span class="err">最大可占用的</span><span class="nt">Perm</span><span class="err">内存大小。在用户生产环境上一般将这两个值设为相同，以减少运行期间系统在内存申请上所花的开销。</span>

<span class="err">如果用</span><span class="nt">startup</span><span class="p">.</span><span class="nc">bat</span><span class="err">启动</span><span class="nt">tomcat</span><span class="o">,</span><span class="nt">OK</span><span class="err">设置生效</span><span class="o">.</span><span class="err">够成功的分配</span><span class="nt">200M</span><span class="err">内存</span><span class="o">.</span>
<span class="nt">-------------------</span><span class="err">解决方案</span><span class="nt">2</span><span class="err">：</span><span class="nt">------------------------</span>
<span class="err">前提：是执行</span><span class="nt">startup</span><span class="p">.</span><span class="nc">bat</span><span class="err">启动</span><span class="nt">tomcat</span><span class="err">的方式</span>
<span class="err">手动设置</span><span class="nt">Heap</span> <span class="nt">size</span>
<span class="nt">Windows</span><span class="err">服务器：</span>
<span class="err">修改</span><span class="nt">TOMCAT_HOME</span><span class="o">/</span><span class="nt">bin</span><span class="o">/</span><span class="nt">catalina</span><span class="p">.</span><span class="nc">bat</span><span class="err">，在“</span><span class="nt">echo</span> <span class="s2">&quot;Using CATALINA_BASE: $CATALINA_BASE&quot;</span><span class="err">”上面加入以下行：</span>
<span class="nt">Java</span><span class="err">代码</span>
<span class="nt">set</span> <span class="nt">JAVA_OPTS</span><span class="o">=%</span><span class="nt">JAVA_OPTS</span><span class="o">%</span> <span class="nt">-server</span> <span class="nt">-Xms800m</span> <span class="nt">-Xmx800m</span> <span class="nt">-XX</span><span class="p">:</span><span class="nd">MaxNewSize</span><span class="o">=</span><span class="nt">256m</span> 

    <span class="err">注：</span><span class="nt">JAVA_OPTS</span><span class="err">是保留先前设置。</span>
<span class="nt">Linux</span><span class="err">服务器：</span>
<span class="err">修改</span><span class="nt">TOMCAT_HOME</span><span class="o">/</span><span class="nt">bin</span><span class="o">/</span><span class="nt">catalina</span><span class="p">.</span><span class="nc">sh</span>
<span class="err">在“</span><span class="nt">echo</span> <span class="s2">&quot;Using CATALINA_BASE: $CATALINA_BASE&quot;</span><span class="err">”上面加入以下行：</span>
<span class="nt">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;$JAVA_OPTS -server -Xms800m -Xmx800m -XX:MaxNewSize=256m&quot;</span>

<span class="err">注：</span><span class="o">$</span><span class="nt">JAVA_OPTS</span><span class="err">是保留先前设置。</span>
<span class="nt">-------------------</span><span class="err">解决方案</span><span class="nt">3</span><span class="err">：</span><span class="nt">-----------------------------</span>
<span class="err">前提：是执行</span><span class="nt">windows</span><span class="err">的系统服务启动</span><span class="nt">tomcat</span><span class="err">的方式</span>
<span class="err">但是如果不是执行</span><span class="nt">startup</span><span class="p">.</span><span class="nc">bat</span><span class="err">启动</span><span class="nt">tomcat</span><span class="err">而是利用</span><span class="nt">windows</span><span class="err">的系统服务启动</span><span class="nt">tomcat</span><span class="err">服务</span><span class="o">,</span><span class="err">上面的设置就不生效了</span><span class="o">,</span>
<span class="err">就是说</span><span class="nt">set</span> <span class="nt">JAVA_OPTS</span><span class="o">=</span><span class="nt">-Xms128m</span> <span class="nt">-Xmx350m</span> <span class="err">没起作用</span><span class="o">.</span><span class="err">上面分配</span><span class="nt">200M</span><span class="err">内存就</span><span class="nt">OOM</span><span class="err">了</span><span class="o">..</span>
<span class="nt">windows</span><span class="err">服务执行的是</span><span class="nt">bin</span><span class="err">\</span><span class="nt">tomcat</span><span class="p">.</span><span class="nc">exe</span><span class="o">.</span><span class="err">他读取注册表中的值</span><span class="o">,</span><span class="err">而不是</span><span class="nt">catalina</span><span class="p">.</span><span class="nc">bat</span><span class="err">的设置</span><span class="o">.</span>

<span class="err">解决办法</span><span class="o">:</span>
<span class="err">修改注册表</span><span class="nt">HKEY_LOCAL_MACHINE</span><span class="err">\</span><span class="nt">SOFTWARE</span><span class="err">\</span><span class="nt">Apache</span> <span class="nt">Software</span> <span class="nt">Foundation</span><span class="err">\</span><span class="nt">Tomcat</span> <span class="nt">Service</span> <span class="nt">Manager</span><span class="err">\</span><span class="nt">Tomcat5</span><span class="err">\</span><span class="nt">Parameters</span><span class="err">\</span><span class="nt">JavaOptions</span>
<span class="err">原值为</span>
<span class="nt">-Dcatalina</span><span class="p">.</span><span class="nc">home</span><span class="o">=</span><span class="s2">&quot;C:\ApacheGroup\Tomcat 5.0&quot;</span>
<span class="nt">-Djava</span><span class="p">.</span><span class="nc">endorsed</span><span class="p">.</span><span class="nc">dirs</span><span class="o">=</span><span class="s2">&quot;C:\ApacheGroup\Tomcat 5.0\common\endorsed&quot;</span>
<span class="nt">-Xrs</span>
<span class="err">加入</span> <span class="nt">-Xms300m</span> <span class="nt">-Xmx350m</span>
<span class="err">重起</span><span class="nt">tomcat</span><span class="err">服务</span><span class="o">,</span><span class="err">设置生效</span>
<span class="nt">-------------------</span><span class="err">解决方案</span><span class="nt">4</span><span class="err">：</span><span class="nt">-----------------------------</span>
<span class="err">前提：是执行</span><span class="nt">windows</span><span class="err">的系统服务启动</span><span class="nt">tomcat</span><span class="err">的方式</span>
<span class="err">在安装</span><span class="nt">tomcat</span><span class="err">时若有勾选</span><span class="s2">&quot;NT Service(NT/2000/XP only)&quot;</span>
<span class="err">则安装完成后在安装目录的</span><span class="s2">&quot;bin&quot;</span><span class="err">目录里会有一个</span><span class="nt">tomcat</span><span class="p">.</span><span class="nc">exe</span><span class="err">的档案</span>
<span class="err">先把</span><span class="nt">tomcat</span><span class="err">的服务停掉</span>
<span class="err">在命令列模式下（运行里输入</span><span class="nt">CMD</span><span class="err">）</span>
<span class="err">将目录切换到</span><span class="nt">tomcat</span><span class="err">的</span><span class="nt">bin</span><span class="err">目录</span>
<span class="err">用下面的命令把服务移除</span>

<span class="nt">tomcat</span> <span class="nt">-uninstall</span> <span class="s2">&quot;Apache Tomcat 4.1&quot;</span>

<span class="err">接下来，写个批处理。</span>
<span class="err">内容如下</span>
<span class="nt">set</span> <span class="nt">SERVICENAME</span><span class="o">=</span><span class="nt">Apache</span> <span class="nt">Tomcat</span> <span class="nt">4</span><span class="p">.</span><span class="nc">1</span>
<span class="nt">set</span> <span class="nt">CATALINA_HOME</span><span class="o">=</span><span class="nt">E</span><span class="o">:</span><span class="err">\</span><span class="nt">Tomcat</span> <span class="nt">4</span><span class="p">.</span><span class="nc">1</span><span class="p">.</span><span class="nc">24</span>
<span class="nt">set</span> <span class="nt">CLASSPATH</span><span class="o">=</span><span class="nt">D</span><span class="o">:</span><span class="err">\</span><span class="nt">j2sdk1</span><span class="p">.</span><span class="nc">4</span><span class="p">.</span><span class="nc">1_01</span><span class="err">\</span><span class="nt">lib</span>
<span class="nt">set</span> <span class="nt">JAVACLASSPATH</span><span class="o">=%</span><span class="nt">CLASSPATH</span><span class="o">%</span>
<span class="nt">set</span> <span class="nt">JAVACLASSPATH</span><span class="o">=%</span><span class="nt">JAVACLASSPATH</span><span class="o">%;</span><span class="err">�</span><span class="nt">TALINA_HOME</span><span class="o">%</span><span class="err">\</span><span class="nt">bin</span><span class="err">\</span><span class="nt">bootstrap</span><span class="p">.</span><span class="nc">jar</span>
<span class="nt">set</span> <span class="nt">JAVACLASSPATH</span><span class="o">=%</span><span class="nt">JAVACLASSPATH</span><span class="o">%;</span><span class="err">�</span><span class="nt">TALINA_HOME</span><span class="o">%</span><span class="err">\</span><span class="nt">common</span><span class="err">\</span><span class="nt">lib</span><span class="err">\</span><span class="nt">servlet</span><span class="p">.</span><span class="nc">jar</span>
<span class="nt">set</span> <span class="nt">JAVACLASSPATH</span><span class="o">=%</span><span class="nt">JAVACLASSPATH</span><span class="o">%;%</span><span class="nt">JAVA_HOME</span><span class="o">%</span><span class="err">\</span><span class="nt">lib</span><span class="err">\</span><span class="nt">tools</span><span class="p">.</span><span class="nc">jar</span>
<span class="nt">tomcat</span><span class="p">.</span><span class="nc">exe</span> <span class="nt">-install</span> <span class="s2">&quot;%SERVICENAME%&quot;</span> <span class="s2">&quot;%JAVA_HOME%\jre\bin\server\jvm.dll&quot;</span> <span class="nt">-Djava</span><span class="p">.</span><span class="nc">class</span><span class="p">.</span><span class="nc">path</span><span class="o">=</span><span class="s2">&quot;%JAVACLASSPATH%&quot;</span> 
<span class="nt">-Dcatalina</span><span class="p">.</span><span class="nc">home</span><span class="o">=</span><span class="s2">&quot;�TALINA_HOME%&quot;</span> <span class="nt">-Xms512m</span> <span class="nt">-Xmx768m</span> <span class="nt">-start</span> <span class="nt">org</span><span class="p">.</span><span class="nc">apache</span><span class="p">.</span><span class="nc">catalina</span><span class="p">.</span><span class="nc">startup</span><span class="p">.</span><span class="nc">Bootstrap</span> <span class="nt">-params</span> <span class="nt">start</span> 
<span class="nt">-stop</span> <span class="nt">org</span><span class="p">.</span><span class="nc">apache</span><span class="p">.</span><span class="nc">catalina</span><span class="p">.</span><span class="nc">startup</span><span class="p">.</span><span class="nc">Bootstrap</span> <span class="nt">-params</span> <span class="nt">stop</span> <span class="nt">-out</span> <span class="s2">&quot;�TALINA_HOME%\logs\stdout.log&quot;</span> <span class="nt">-err</span> <span class="s2">&quot;�TALINA_HOME%\</span>
<span class="s2">logs\stderr.log&quot;</span>

<span class="err">注意，从</span> <span class="nt">tomcat</span><span class="p">.</span><span class="nc">exe</span> <span class="nt">-install</span><span class="err">开始的是最后一行！不要手工回车换行把这一行分成了好几段。保存后在命令行下执行这个</span><span class="nt">bat</span><span class="err">文件，注</span>
<span class="err">意执行的时候将“服务”窗口关闭。</span>

<span class="err">第二种：永久保存区域溢出</span>
<span class="err">　原因分析：</span>
<span class="nt">PermGen</span> <span class="nt">space</span><span class="err">的全称是</span><span class="nt">Permanent</span> <span class="nt">Generation</span> <span class="nt">space</span><span class="o">,</span><span class="err">是指内存的永久保存区域，这块内存主要是被</span><span class="nt">JVM</span><span class="err">存放</span><span class="nt">Class</span><span class="err">和</span><span class="nt">Meta</span><span class="err">信息的</span><span class="o">,</span>
<span class="nt">Class</span><span class="err">在被</span><span class="nt">Loader</span><span class="err">时就会被放到</span><span class="nt">PermGen</span> <span class="nt">space</span><span class="err">中，它和存放类实例</span><span class="o">(</span><span class="nt">Instance</span><span class="o">)</span><span class="err">的</span><span class="nt">Heap</span><span class="err">区域不同</span><span class="o">,</span><span class="nt">GC</span><span class="o">(</span><span class="nt">Garbage</span> <span class="nt">Collection</span><span class="o">)</span><span class="err">不会在</span>
<span class="err">主程序运行期对</span><span class="nt">PermGen</span> <span class="nt">space</span><span class="err">进行清理，所以如果你的应用中有很</span><span class="nt">CLASS</span><span class="err">的话</span><span class="o">,</span><span class="err">就很可能出现</span><span class="nt">PermGen</span> <span class="nt">space</span><span class="err">错误，这种错误常见在</span>
<span class="nt">web</span><span class="err">服务器对</span><span class="nt">JSP</span><span class="err">进行</span><span class="nt">pre</span> <span class="nt">compile</span><span class="err">的时候。如果你的</span><span class="nt">WEB</span> <span class="nt">APP</span><span class="err">下都用了大量的第三方</span><span class="nt">jar</span><span class="o">,</span> <span class="err">其大小超过了</span><span class="nt">jvm</span><span class="err">默认的大小</span><span class="o">(</span><span class="nt">4M</span><span class="o">)</span><span class="err">那么就会</span>
<span class="err">产生此错误信息了。但目前的</span><span class="nt">hibernate</span><span class="err">和</span><span class="nt">spring</span><span class="err">项目中也很容易出现这样的问题。可能是由于这些框架会动态</span><span class="nt">class</span><span class="err">，而且</span><span class="nt">jvm</span><span class="err">的</span><span class="nt">gc</span>
<span class="err">是不会清理</span><span class="nt">PemGen</span> <span class="nt">space</span><span class="err">的，超过了</span><span class="nt">jvm</span><span class="err">默认的大小</span><span class="o">(</span><span class="nt">4M</span><span class="o">)</span><span class="err">，导致内存溢出。</span>
<span class="err">　　建议：将相同的第三方</span><span class="nt">jar</span><span class="err">文件移置到</span><span class="nt">tomcat</span><span class="o">/</span><span class="nt">shared</span><span class="o">/</span><span class="nt">lib</span><span class="err">目录下，这样可以达到减少</span><span class="nt">jar</span> <span class="err">文档重复占用内存的目的。</span>
<span class="err">这一个一般是加大</span><span class="nt">-XX</span><span class="err">：</span><span class="nt">PermSize</span> <span class="nt">-XX</span><span class="err">：</span><span class="nt">MaxPermSize</span> <span class="err">来解决问题。</span>
<span class="err">　　</span><span class="nt">-XX</span><span class="err">：</span><span class="nt">PermSize</span> <span class="err">永久保存区域初始大小</span>
<span class="err">　　</span><span class="nt">-XX</span><span class="err">：</span><span class="nt">PermSize</span> <span class="err">永久保存区域初始最大值</span>
<span class="err">　　这一般结合第一条使用，比如</span> <span class="nt">set</span> <span class="nt">JAVA_OPTS</span><span class="o">=</span> <span class="nt">-Xms1024m</span> <span class="nt">-Xmx1024m</span> <span class="nt">-XX</span><span class="err">：</span><span class="nt">PermSize</span><span class="o">=</span><span class="nt">128M</span> <span class="nt">-XX</span><span class="err">：</span><span class="nt">PermSize</span><span class="o">=</span><span class="nt">256M</span>
<span class="err">　　有一点需要注意：</span><span class="nt">java</span> <span class="nt">-Xmx</span><span class="o">***</span><span class="nt">M</span> <span class="nt">version</span> <span class="err">命令来测试的最大堆内存是</span> <span class="nt">-Xmx</span><span class="err">与</span> <span class="nt">-XX</span><span class="err">：</span><span class="nt">PermSize</span><span class="err">的和</span> <span class="err">比如系统支持最大的</span><span class="nt">jvm</span><span class="err">堆</span>
<span class="err">大小事</span><span class="nt">1</span><span class="p">.</span><span class="nc">5G</span><span class="err">，那</span> <span class="nt">-Xmx1024m</span> <span class="nt">-XX</span><span class="err">：</span><span class="nt">PermSize</span><span class="o">=</span><span class="nt">768M</span> <span class="err">是无法运行的。</span>
<span class="nt">-----------------</span><span class="err">解决方案</span><span class="nt">1</span><span class="err">：</span><span class="nt">-------------------------</span>
<span class="nt">Linux</span><span class="err">服务器：</span>
<span class="err">在</span><span class="nt">catalina</span><span class="p">.</span><span class="nc">sh</span><span class="err">的第一行增加：</span>
<span class="nt">JAVA_OPTS</span><span class="o">=</span>
<span class="nt">-Xms64m</span>
<span class="nt">-Xmx256m</span>
<span class="nt">-XX</span><span class="p">:</span><span class="nd">PermSize</span><span class="o">=</span><span class="nt">128M</span>
<span class="nt">-XX</span><span class="p">:</span><span class="nd">MaxNewSize</span><span class="o">=</span><span class="nt">256m</span>
<span class="nt">-XX</span><span class="p">:</span><span class="nd">MaxPermSize</span><span class="o">=</span><span class="nt">256m</span>
<span class="err">或者</span>
<span class="err">在“</span><span class="nt">echo</span> <span class="s2">&quot;Using CATALINA_BASE:   $CATALINA_BASE&quot;</span><span class="err">”上面加入以下行：</span>
<span class="nt">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;-server -XX:PermSize=64M -XX:MaxPermSize=128m</span>
<span class="s2">Windows服务器：</span>
<span class="s2">在catalina.bat的第一行增加：</span>
<span class="s2">set JAVA_OPTS=-Xms64m -Xmx256m -XX:PermSize=128M -XX:MaxNewSize=256m -XX:MaxPermSize=256m</span>
<span class="s2">-----------------解决方案2：------------------------</span>
<span class="s2">修改TOMCAT_HOME/bin/catalina.bat（Linux下为catalina.sh），在Java代码</span>
<span class="s2">“echo &quot;</span><span class="nt">Using</span> <span class="nt">CATALINA_BASE</span><span class="o">:</span> <span class="o">$</span><span class="nt">CATALINA_BASE</span><span class="s2">&quot;”上面加入以下行：  </span>
<span class="s2">set JAVA_OPTS=%JAVA_OPTS% -server -XX:PermSize=128M -XX:MaxPermSize=512m </span>

<span class="s2">“echo &quot;</span><span class="nt">Using</span> <span class="nt">CATALINA_BASE</span><span class="o">:</span> <span class="o">$</span><span class="nt">CATALINA_BASE</span><span class="s2">&quot;”上面加入以下行：</span>
<span class="s2">set JAVA_OPTS=%JAVA_OPTS% -server -XX:PermSize=128M -XX:MaxPermSize=512m</span>

<span class="s2">catalina.sh下为：</span>
<span class="s2">Java代码</span>
<span class="s2">JAVA_OPTS=&quot;</span><span class="o">$</span><span class="nt">JAVA_OPTS</span> <span class="nt">-server</span> <span class="nt">-XX</span><span class="p">:</span><span class="nd">PermSize</span><span class="o">=</span><span class="nt">128M</span> <span class="nt">-XX</span><span class="p">:</span><span class="nd">MaxPermSize</span><span class="o">=</span><span class="nt">512m</span><span class="s2">&quot;</span>

<span class="s2">JAVA_OPTS=&quot;</span><span class="o">$</span><span class="nt">JAVA_OPTS</span> <span class="nt">-server</span> <span class="nt">-XX</span><span class="p">:</span><span class="nd">PermSize</span><span class="o">=</span><span class="nt">128M</span> <span class="nt">-XX</span><span class="p">:</span><span class="nd">MaxPermSize</span><span class="o">=</span><span class="nt">512m</span><span class="s2">&quot;</span>

<span class="s2">　　第三种：无法创建新的线程。</span>
<span class="s2">　　这种现象比较少见，也比较奇怪，主要是和jvm与系统内存的比例有关。</span>
<span class="s2">　　这种怪事是因为JVM已经被系统分配了大量的内存（比如1.5G），并且它至少要占用可用内存的一半。有人发现，在线程个数很多的</span>
<span class="s2">情况下，你分配给JVM的内存越多，那么，上述错误发生的可能性就越大。</span>
<span class="s2">　　原因分析</span>
<span class="s2">（从这个blog中了解到原因：http://hi.baidu.com/hexiong/blog/item/16dc9e518fb10c2542a75b3c.html）：</span>
<span class="s2">　　每一个32位的进程最多可以使用2G的可用内存，因为另外2G被操作系统保留。这里假设使用1.5G给JVM，那么还余下500M可用内存。</span>
<span class="s2">这500M内存中的一部分必须用于系统dll的加载，那么真正剩下的也许只有400M，现在关键的地方出现了：当你使用Java创建一个线程，</span>
<span class="s2">在JVM的内存里也会创建一个Thread对象，但是同时也会在操作系统里创建一个真正的物理线程（参考JVM规范），操作系统会在余下的 </span>
<span class="s2">400兆内存里创建这个物理线程，而不是在JVM的1500M的内存堆里创建。在jdk1.4里头，默认的栈大小是256KB，但是在jdk1.5里头，</span>
<span class="s2">默认的栈大小为1M每线程，因此，在余下400M的可用内存里边我们最多也只能创建400个可用线程。</span>
<span class="s2">　　这样结论就出来了，要想创建更多的线程，你必须减少分配给JVM的最大内存。还有一种做法是让JVM宿主在你的JNI代码里边。</span>
<span class="s2">　　给出一个有关能够创建线程的最大个数的估算公式：</span>
<span class="s2">　　（MaxProcessMemory - JVMMemory - ReservedOsMemory） / （ThreadStackSize） = Number of threads</span>
<span class="s2">　　对于jdk1.5而言，假设操作系统保留120M内存：</span>
<span class="s2">　　1.5GB JVM： （2GB-1.5Gb-120MB）/（1MB） = ~380 threads</span>
<span class="s2">　　1.0GB JVM： （2GB-1.0Gb-120MB）/（1MB） = ~880 threads</span>
<span class="s2">　　在2000/XP/2003的boot.ini里头有一个启动选项，好像是：/PAE /3G ，可以让用户进程最大内存扩充至3G，这时操作系统只能</span>
<span class="s2">占用最多1G的虚存。那样应该可以让JVM创建更多的线程。</span>
<span class="s2">　　因此这种情况需要结合操作系统进行相关调整。</span>
<span class="s2">　　因此：我们需要结合不同情况对tomcat内存分配进行不同的诊断才能从根本上解决问题。</span>

<span class="s2">检测当前JVM内存使用情况：</span>
<span class="s2">System.out.println(&quot;</span><span class="nt">JVM</span> <span class="nt">MAX</span> <span class="nt">MEMORY</span><span class="o">:</span> <span class="s2">&quot; + Runtime.getRuntime().maxMemory()/1024/1024+&quot;</span><span class="nt">M</span><span class="s2">&quot;);</span>
<span class="s2">System.out.println(&quot;</span><span class="nt">JVM</span> <span class="nt">IS</span> <span class="nt">USING</span> <span class="nt">MEMORY</span><span class="o">:</span><span class="s2">&quot; + Runtime.getRuntime().totalMemory()/1024/1024+&quot;</span><span class="nt">M</span><span class="s2">&quot;);</span>
<span class="s2">System.out.println(&quot;</span><span class="nt">JVM</span> <span class="nt">IS</span> <span class="nt">FREE</span> <span class="nt">MEMORY</span><span class="o">:</span><span class="s2">&quot; + Runtime.getRuntime().freeMemory()/1024/1024+&quot;</span><span class="nt">M</span><span class="s2">&quot;);</span>

<span class="s2">这三个方法都是说JVM的内存使用情况而不是操作系统的内存；</span>
<span class="s2">　　maxMemory()这个方法返回的是java虚拟机（这个进程）能构从操作系统那里挖到的最大的内存，以字节为单位，如果在运行java程序的时</span>
<span class="s2">候，没有添加-Xmx参数，那么就是64兆，也就是说maxMemory()返回的大约是64*1024*1024字节，这是java虚拟机默认情况下能从操作系统</span>
<span class="s2">那里挖到的最大的内存。如果添加了-Xmx参数，将以这个参数后面的值为准，例如java -cp ClassPath -Xmx512m ClassName，那么最大内</span>
<span class="s2">存就是512*1024*0124字节。</span>

<span class="s2">　　totalMemory()这个方法返回的是java虚拟机现在已经从操作系统那里挖过来的内存大小，也就是java虚拟机这个进程当时所占用的所有</span>
<span class="s2">内存。如果在运行java的时候没有添加-Xms参数，那么，在java程序运行的过程的，内存总是慢慢的从操作系统那里挖的，基本上是用多少</span>
<span class="s2">挖多少，直挖到maxMemory()为止，所以totalMemory()是慢慢增大的。如果用了-Xms参数，程序在启动的时候就会无条件的从操作系统中</span>
<span class="s2">挖-Xms后面定义的内存数，然后在这些内存用的差不多的时候，再去挖。</span>

<span class="s2">　　freeMemory()是什么呢，刚才讲到如果在运行java的时候没有添加-Xms参数，那么，在java程序运行的过程的，内存总是慢慢的从操作</span>
<span class="s2">系统那里挖的，基本上是用多少挖多少，但是java虚拟机100％的情况下是会稍微多挖一点的，这些挖过来而又没有用上的内存，实际上就</span>
<span class="s2">是freeMemory()，所以freeMemory()的值一般情况下都是很小的，但是如果你在运行java程序的时候使用了-Xms，这个时候因为程序在</span>
<span class="s2">启动的时候就会无条件的从操作系统中挖-Xms后面定义的内存数，这个时候，挖过来的内存可能大部分没用上，所以这个时候freeMemory()可</span>
<span class="s2">能会有些</span>
<span class="s2">--------------------解决方案--------------------------</span>
<span class="s2">JVM堆大小的调整</span>
<span class="s2">　　Sun HotSpot 1.4.1使用分代收集器，它把堆分为三个主要的域：新域、旧域以及永久域。Jvm生成的所有新对象放在新域中。一旦对象</span>
<span class="s2">经历了一定数量的垃圾收集循环后，便获得使用期并进入旧域。在永久域中jvm则存储class和method对象。就配置而言，永久域是一个独立</span>
<span class="s2">域并且不认为是堆的一部分。</span>
<span class="s2">　　下面介绍如何控制这些域的大小。可使用-Xms和-Xmx 控制整个堆的原始大小或最大值。</span>
<span class="s2">　　下面的命令是把初始大小设置为128M：</span>
<span class="s2">　　java –Xms128m</span>
<span class="s2">　　–Xmx256m为控制新域的大小，可使用-XX:NewRatio设置新域在堆中所占的比例。</span>
<span class="s2">　　下面的命令把整个堆设置成128m，新域比率设置成3，即新域与旧域比例为1：3，新域为堆的1/4或32M：</span>
<span class="s2">java –Xms128m –Xmx128m</span>
<span class="s2">–XX:NewRatio =3可使用-XX:NewSize和-XX:MaxNewsize设置新域的初始值和最大值。</span>
<span class="s2">　　下面的命令把新域的初始值和最大值设置成64m:</span>
<span class="s2">java –Xms256m –Xmx256m –Xmn64m</span>
<span class="s2">　　永久域默认大小为4m。运行程序时，jvm会调整永久域的大小以满足需要。每次调整时，jvm会对堆进行一次完全的垃圾收集。</span>
<span class="s2">　　使用-XX:MaxPerSize标志来增加永久域搭大小。在WebLogic Server应用程序加载较多类时，经常需要增加永久域的最大值。当jvm加</span>
<span class="s2">载类时，永久域中的对象急剧增加，从而使jvm不断调整永久域大小。为了避免调整，可使用-XX:PerSize标志设置初始值。</span>
<span class="s2">　　下面把永久域初始值设置成32m，最大值设置成64m。</span>
<span class="s2">java -Xms512m -Xmx512m -Xmn128m -XX:PermSize=32m -XX:MaxPermSize=64m</span>
<span class="s2">　　默认状态下，HotSpot在新域中使用复制收集器。该域一般分为三个部分。第一部分为Eden，用于生成新的对象。另两部分称为救助空</span>
<span class="s2">间，当Eden充满时，收集器停止应用程序，把所有可到达对象复制到当前的from救助空间，一旦当前的from救助空间充满，收集器则把可</span>
<span class="s2">到达对象复制到当前的to救助空间。From和to救助空间互换角色。维持活动的对象将在救助空间不断复制，直到它们获得使用期并转入旧</span>
<span class="s2">域。使用-XX:SurvivorRatio可控制新域子空间的大小。</span>
<span class="s2">　　同NewRation一样，SurvivorRation规定某救助域与Eden空间的比值。比如，以下命令把新域设置成64m，Eden占32m，每个救助域各占16m：</span>
<span class="s2">java -Xms256m -Xmx256m -Xmn64m -XX:SurvivorRation =2</span>
<span class="s2">　　如前所述，默认状态下HotSpot对新域使用复制收集器，对旧域使用标记－清除－压缩收集器。在新域中使用复制收集器有很多意义，</span>
<span class="s2">因为应用程序生成的大部分对象是短寿命的。理想状态下，所有过渡对象在移出Eden空间时将被收集。如果能够这样的话，并且移出Eden空</span>
<span class="s2">间的对象是长寿命的，那么理论上可以立即把它们移进旧域，避免在救助空间反复复制。但是，应用程序不能适合这种理想状态，因为它们有</span>
<span class="s2">一小部分中长寿命的对象。最好是保持这些中长寿命的对象并放在新域中，因为复制小部分的对象总比压缩旧域廉价。为控制新域中对象的复</span>
<span class="s2">制，可用-XX:TargetSurvivorRatio控制救助空间的比例（该值是设置救助空间的使用比例。如救助空间位1M，该值50表示可用500K）。</span>
<span class="s2">该值是一个百分比，默认值是50。当较大的堆栈使用较低的sruvivorratio时，应增加该值到80至90，以更好利用救助空间。用</span>
<span class="s2">-XX:maxtenuring threshold可控制上限。</span>
<span class="s2">　　为放置所有的复制全部发生以及希望对象从eden扩展到旧域，可以把MaxTenuring Threshold设置成0。设置完成后，实际上就不再</span>
<span class="s2">使用救助空间了，因此应把SurvivorRatio设成最大值以最大化Eden空间，设置如下：</span>
<span class="s2">java … -XX:MaxTenuringThreshold=0 –XX:SurvivorRatio＝50000 …</span>
<span class="s2">垃圾回收描述：</span>
<span class="s2">垃圾回收分多级，0级为全部(Full)的垃圾回收，会回收OLD段中的垃圾；1级或以上为部分垃圾回收，只会回收Young中的垃圾，内存溢出</span>
<span class="s2">通常发生于OLD段或Perm段垃圾回收后，仍然无内存空间容纳新的Java对象的情况。</span>
<span class="s2">当一个URL被访问时，内存申请过程如下：</span>
<span class="s2">A. JVM会试图为相关Java对象在Eden中初始化一块内存区域</span>
<span class="s2">B. 当Eden空间足够时，内存申请结束。否则到下一步</span>
<span class="s2">C. JVM试图释放在Eden中所有不活跃的对象（这属于1或更高级的垃圾回收）；释放后若Eden空间仍然不足以放入新对象，则试图将部</span>
<span class="s2">分Eden中活跃对象放入Survivor区/OLD区</span>
<span class="s2">D. Survivor区被用来作为Eden及OLD的中间交换区域，当OLD区空间足够时，Survivor区的对象会被移到Old区，否则会被保留在Survivor区</span>
<span class="s2">E. 当OLD区空间不够时，JVM会在OLD区进行完全的垃圾收集（0级）</span>
<span class="s2">F. 完全垃圾收集后，若Survivor及OLD区仍然无法存放从Eden复制过来的部分对象，导致JVM无法在Eden区为新对象创建内存区域，</span>
<span class="s2">则出现”out of memory错误”</span>
<span class="s2">Java堆相关参数：</span>
<span class="s2">ms/mx：定义YOUNG+OLD段的总尺寸，ms为JVM启动时YOUNG+OLD的内存大小；mx为最大可占用的YOUNG+OLD内存大小。在用户生产环境</span>
<span class="s2">上一般将这两个值设为相同，以减少运行期间系统在内存申请上所花的开销。</span>
<span class="s2">NewSize/MaxNewSize：定义YOUNG段的尺寸，NewSize为JVM启动时YOUNG的内存大小；MaxNewSize为最大可占用的YOUNG内存大小。在</span>
<span class="s2">用户生产环境上一般将这两个值设为相同，以减少运行期间系统在内存申请上所花的开销。</span>
<span class="s2">PermSize/MaxPermSize：定义Perm段的尺寸，PermSize为JVM启动时Perm的内存大小；MaxPermSize为最大可占用的Perm内存大小。</span>
<span class="s2">在用户生产环境上一般将这两个值设为相同，以减少运行期间系统在内存申请上所花的开销。</span>
<span class="s2">SurvivorRatio：设置Survivor空间和Eden空间的比例</span>
<span class="s2">例：</span>
<span class="s2">MEM_ARGS=&quot;</span><span class="nt">-Xms512m</span> <span class="nt">-Xmx512m</span> <span class="nt">-XX</span><span class="p">:</span><span class="nd">NewSize</span><span class="o">=</span><span class="nt">256m</span> <span class="nt">-XX</span><span class="p">:</span><span class="nd">MaxNewSize</span><span class="o">=</span><span class="nt">256m</span> <span class="nt">-XX</span><span class="p">:</span><span class="nd">PermSize</span><span class="o">=</span><span class="nt">128m</span> <span class="nt">-XX</span><span class="p">:</span><span class="nd">MaxPermSize</span><span class="o">=</span><span class="nt">128m</span> 
<span class="nt">-XX</span><span class="p">:</span><span class="nd">SurvivorRatio</span><span class="o">=</span><span class="nt">6</span><span class="err">&quot;</span>
<span class="err">在上面的例子中：</span>
<span class="nt">YOUNG</span><span class="o">+</span><span class="nt">OLD</span><span class="o">:</span> <span class="nt">512M</span>
<span class="nt">YOUNG</span><span class="o">:</span> <span class="nt">256M</span>
<span class="nt">Perm</span><span class="o">:</span> <span class="nt">128M</span>
<span class="nt">Eden</span><span class="o">:</span> <span class="nt">YOUNG</span><span class="o">*</span><span class="nt">6</span><span class="o">/(</span><span class="nt">6</span><span class="o">+</span><span class="nt">1</span><span class="o">+</span><span class="nt">1</span><span class="o">)=</span><span class="nt">192M</span>
<span class="nt">Survivor</span><span class="o">:</span> <span class="nt">YOUNG</span><span class="o">/(</span><span class="nt">6</span><span class="o">+</span><span class="nt">1</span><span class="o">+</span><span class="nt">1</span><span class="o">)=</span><span class="nt">32M</span>
<span class="nt">Java</span><span class="err">堆的总尺寸</span><span class="o">=</span><span class="nt">YOUNG</span><span class="o">+</span><span class="nt">OLD</span><span class="o">+</span><span class="nt">Perm</span><span class="o">=</span><span class="nt">640M</span>
</pre></div>


<h2 id="java_3">多java版本</h2>
<div class="codehilite"><pre><span></span><span class="k">update</span><span class="o">-</span><span class="n">alternatives</span> <span class="c1">--config java</span>
<span class="n">alternatives</span> <span class="c1">--config java</span>

<span class="c1">--disaplay java</span>
</pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../saltstack/" title="saltstack" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                saltstack
              </span>
            </div>
          </a>
        
        
          <a href="../ansible/" title="ansible" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                ansible
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>