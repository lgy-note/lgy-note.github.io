



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>command - mkdocs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.30686662.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#find" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="mkdocs" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              mkdocs
            </span>
            <span class="md-header-nav__topic">
              
                command
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href=".." class="md-tabs__link">
        home
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../python-base/" class="md-tabs__link">
          python
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../nginx/" class="md-tabs__link">
          service
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../mysql/" class="md-tabs__link">
          database
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../open-falcon/" class="md-tabs__link">
          monitor
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../tcp-issue/" class="md-tabs__link md-tabs__link--active">
          basis
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="mkdocs" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    mkdocs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="home" class="md-nav__link">
      home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      python
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        python
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../python-base/" title="python-base" class="md-nav__link">
      python-base
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-lib/" title="python-lib" class="md-nav__link">
      python-lib
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-lib2/" title="python-lib2" class="md-nav__link">
      python-lib2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-web/" title="python-web" class="md-nav__link">
      python-web
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-other/" title="python-other" class="md-nav__link">
      python-other
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      service
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        service
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../nginx/" title="nginx" class="md-nav__link">
      nginx
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../nginx2/" title="nginx2" class="md-nav__link">
      nginx2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../apache/" title="apache" class="md-nav__link">
      apache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../saltstack/" title="saltstack" class="md-nav__link">
      saltstack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tomcat/" title="tomcat" class="md-nav__link">
      tomcat
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ansible/" title="ansible" class="md-nav__link">
      ansible
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../trafficserver/" title="trafficserver" class="md-nav__link">
      trafficserver
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../haproxy/" title="haproxy" class="md-nav__link">
      haproxy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../docker/" title="docker" class="md-nav__link">
      docker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../varnish/" title="varnish" class="md-nav__link">
      varnish
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../bind/" title="bind" class="md-nav__link">
      bind
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lvs/" title="lvs" class="md-nav__link">
      lvs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../log-analysis/" title="log-analysis" class="md-nav__link">
      log-analysis
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      database
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        database
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../mysql/" title="mysql" class="md-nav__link">
      mysql
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mysql2/" title="mysql2" class="md-nav__link">
      mysql2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../memcached/" title="memcached" class="md-nav__link">
      memcached
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../redis/" title="redis" class="md-nav__link">
      redis
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mongodb/" title="mongodb" class="md-nav__link">
      mongodb
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../hadoop/" title="hadoop" class="md-nav__link">
      hadoop
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../postgresql/" title="postgresql" class="md-nav__link">
      postgresql
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      monitor
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        monitor
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../open-falcon/" title="open-falcon" class="md-nav__link">
      open-falcon
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zabbix/" title="zabbix" class="md-nav__link">
      zabbix
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zabbix2/" title="zabbix2" class="md-nav__link">
      zabbix2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../netdata/" title="netdata" class="md-nav__link">
      netdata
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6" checked>
    
    <label class="md-nav__link" for="nav-6">
      basis
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        basis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../tcp-issue/" title="tcp-issue" class="md-nav__link">
      tcp-issue
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../git-svn/" title="git-svn" class="md-nav__link">
      git-svn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../vpn/" title="vpn" class="md-nav__link">
      vpn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../shell/" title="shell" class="md-nav__link">
      shell
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../disk/" title="disk" class="md-nav__link">
      disk
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../filesystem/" title="filesystem" class="md-nav__link">
      filesystem
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../source/" title="source" class="md-nav__link">
      source
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        command
      </label>
    
    <a href="./" title="command" class="md-nav__link md-nav__link--active">
      command
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#find" class="md-nav__link">
    find
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#date" class="md-nav__link">
    date日期加减
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tar" class="md-nav__link">
    tar高级用法
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linux" class="md-nav__link">
    检查Linux服务器性能
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ntpdate" class="md-nav__link">
    ntpdate同步时间
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wget" class="md-nav__link">
    wget
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chattr" class="md-nav__link">
    chattr
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iperf" class="md-nav__link">
    iperf
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ethtool" class="md-nav__link">
    ethtool
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ps" class="md-nav__link">
    ps
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ss" class="md-nav__link">
    ss
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iostat" class="md-nav__link">
    iostat
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vmstat" class="md-nav__link">
    vmstat
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cp" class="md-nav__link">
    cp
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rsync" class="md-nav__link">
    rsync
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#snmpwalk" class="md-nav__link">
    snmpwalk
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iptables" class="md-nav__link">
    iptables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logrotate" class="md-nav__link">
    logrotate
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../linux-base/" title="linux-base" class="md-nav__link">
      linux-base
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../linux-soft/" title="linux-soft" class="md-nav__link">
      linux-soft
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../other/" title="other" class="md-nav__link">
      other
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#find" class="md-nav__link">
    find
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#date" class="md-nav__link">
    date日期加减
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tar" class="md-nav__link">
    tar高级用法
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linux" class="md-nav__link">
    检查Linux服务器性能
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ntpdate" class="md-nav__link">
    ntpdate同步时间
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wget" class="md-nav__link">
    wget
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chattr" class="md-nav__link">
    chattr
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iperf" class="md-nav__link">
    iperf
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ethtool" class="md-nav__link">
    ethtool
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ps" class="md-nav__link">
    ps
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ss" class="md-nav__link">
    ss
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iostat" class="md-nav__link">
    iostat
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vmstat" class="md-nav__link">
    vmstat
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cp" class="md-nav__link">
    cp
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rsync" class="md-nav__link">
    rsync
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#snmpwalk" class="md-nav__link">
    snmpwalk
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iptables" class="md-nav__link">
    iptables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logrotate" class="md-nav__link">
    logrotate
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>command</h1>
                
                <h2 id="find">find</h2>
<div class="codehilite"><pre><span></span>找出文件后求和 
<span class="nv">find</span> <span class="nv">vipkid</span><span class="o">/</span><span class="nv">media</span><span class="cm">/* -mtime -1 | xargs du -sm | awk &#39;{sum +=$1}END{print sum}&#39;</span>
<span class="cm">找出空目录或空文件   find . -empty</span>

<span class="cm">列出当前目录及子目录下所有文件和文件夹</span>
<span class="cm">find . </span>

<span class="cm">在/home目录下查找以.txt结尾的文件名 </span>
<span class="cm">find /home -name &quot;*.txt&quot; </span>
<span class="cm">同上，但忽略大小写 find /home -iname &quot;*.txt&quot; </span>

<span class="cm">当前目录及子目录下查找所有以.txt和.pdf结尾的文件 </span>
<span class="cm">find . \( -name &quot;*.txt&quot; -o -name &quot;*.pdf&quot; \) 或 find . -name &quot;*.txt&quot; -o -name &quot;*.pdf&quot; </span>

<span class="cm">匹配文件路径或者文件 </span>
<span class="cm">find /usr/ -path &quot;*local*&quot; </span>

<span class="cm">基于正则表达式匹配文件路径 </span>
<span class="cm">find . -regex &quot;.*\(\.txt\|\.pdf\)$&quot; </span>
<span class="cm">同上，但忽略大小写 find . -iregex &quot;.*\(\.txt\|\.pdf\)$&quot; </span>

<span class="cm">找出/home下不是以.txt结尾的文件 </span>
<span class="cm">find /home ! -name &quot;*.txt&quot; </span>

<span class="cm">根据文件类型进行搜索 </span>
<span class="cm">find . -type 类型参数 类型参数列表： f 普通文件 l 符号连接 d 目录 c 字符设备 b 块设备</span>
<span class="cm"> s 套接字 p Fifo </span>

<span class="cm">基于目录深度搜索 向下最大深度限制为3 </span>
<span class="cm">find . -maxdepth 3 -type f </span>

<span class="cm">搜索出深度距离当前目录至少2个子目录的所有文件 </span>
<span class="cm">find . -mindepth 2 -type f </span>

<span class="cm">根据文件时间戳进行搜索 </span>
<span class="cm">find . -type f 时间戳 </span>
<span class="cm">UNIX/Linux文件系统每个文件都有三种时间戳： </span>
<span class="cm">（-atime/天，-amin/分钟）：用户最近一次访问时间,如 ls, more 等, 但 chmod, chown, ls, </span>
<span class="cm">stat 等不会修改些时间, </span>
<span class="cm">使用 ls -utl 可以按此时间顺序查看;</span>
<span class="cm">（-mtime/天，-mmin/分钟）：文件最后一次修改时间, 如 vi 保存后等, 修改时间发生改变的话, </span>
<span class="cm">atime 和 ctime 也相应跟着发生改变</span>
<span class="cm">（-ctime/天，-cmin/分钟）：文件数据元（例如权限等）最后一次修改时间,如 chmod, chown </span>
<span class="cm">等状态时间改变但修改时间不会改变, </span>
<span class="cm">使用 stat file 可以查看; </span>
<span class="cm">---(+n)----------|----------(n)----------|----------(-n)---</span>
<span class="cm">      (n+1)*24H前|   (n+1)*24H~n*24H间   |n*24H内</span>
<span class="cm">-ctime -n    查找距现在 n*24H 内修改过的文件</span>
<span class="cm">-ctime n    查找距现在 n*24H 前, (n+1)*24H 内修改过的文件</span>
<span class="cm">-ctime +n    查找距现在 (n+1)*24H 前修改过的文件</span>
<span class="cm">注意：</span>
<span class="cm">linux 里是不会记录文件的创建时间的，除非这个文件自创建以来没有发生改变，那么它的创建时间就</span>
<span class="cm">是它的最后一次修改时间。</span>
<span class="cm">#ls -lt /home/admin   # 按修改时间顺序查看</span>
<span class="cm">#ls -lut /home/admin  # 按访问时间顺序查看</span>
<span class="cm">(如果想反序查看的话需要加一个选项 -r)</span>


<span class="cm">搜索最近七天内被访问过的所有文件 </span>
<span class="cm">find . -type f -atime -7 </span>
<span class="cm">搜索恰好在七天前被访问过的所有文件 </span>
<span class="cm">find . -type f -atime 7 </span>
<span class="cm">搜索超过七天内被访问过的所有文件 </span>
<span class="cm">find . -type f -atime +7 </span>
<span class="cm">搜索访问时间超过10分钟的所有文件</span>
<span class="cm">find . -type f -amin +10 </span>
<span class="cm">找出比file.log修改时间更长的所有文件 </span>
<span class="cm">find . -type f -newer file.log </span>

<span class="cm">根据文件大小进行匹配 </span>
<span class="cm">find . -type f -size 文件大小单元 文件大小单元： b —— 块（512字节） c —— 字节 w —— 字</span>
<span class="cm">（2字节） k —— 千字节 </span>
<span class="cm">M —— 兆字节 G —— 吉字节 </span>
<span class="cm">搜索大于10KB的文件 </span>
<span class="cm">find . -type f -size +10k </span>
<span class="cm">搜索小于10KB的文件 </span>
<span class="cm">find . -type f -size -10k </span>
<span class="cm">搜索等于10KB的文件 </span>
<span class="cm">find . -type f -size 10k </span>

<span class="cm">删除匹配文件 删除当前目录下所有.txt文件 </span>
<span class="cm">find . -type f -name &quot;*.txt&quot; -delete </span>

<span class="cm">借助-exec选项与其他命令结合使用 找出当前目录下所有root的文件，并把所有权更改为用户tom </span>
<span class="cm">find .-type f -user root -exec chown tom {} \; </span>
<span class="cm">上例中，{} 用于与-exec选项结合使用来匹配所有文件，然后会被替换为相应的文件名。 </span>

<span class="cm">找出自己家目录下所有的.txt文件并删除 </span>
<span class="cm">find $HOME/. -name &quot;*.txt&quot; -ok rm {} \ ; </span>
<span class="cm">上例中，-ok和-exec行为一样，不过它会给出提示，是否执行相应的操作。 </span>

<span class="cm">查找当前目录下所有.txt文件并把他们拼接起来写入到all.txt文件中 </span>
<span class="cm">find . -type f -name &quot;*.txt&quot; -exec cat {} \ ;&gt; all.txt </span>

<span class="cm">将30天前的.log文件移动到old目录中 </span>
<span class="cm">find . -type f -mtime +30 -name &quot;*.log&quot; -exec cp {} old \ ; </span>

<span class="cm">找出当前目录下所有.txt文件并以“File:文件名”的形式打印出来 </span>
<span class="cm">find . -type f -name &quot;*.txt&quot; -exec printf &quot;File: %s\n&quot; {} \ ; </span>
<span class="cm">因为单行命令中-exec参数中无法使用多个命令，以下方法可以实现在-exec之后接受多条命令</span>
<span class="cm"> -exec ./text.sh {} \; </span>

<span class="cm">搜索但跳出指定的目录 查找当前目录或者子目录下所有.txt文件，但是跳过子目录sk </span>
<span class="cm">find . -path &quot;./sk&quot; -prune -o -name &quot;*.txt&quot; -print find</span>

<span class="cm">http://man.linuxde.net</span>
</pre></div>


<h2 id="date">date日期加减</h2>
<div class="codehilite"><pre><span></span><span class="o">#</span><span class="err">如：</span><span class="mi">2016</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">24</span> <span class="mi">11</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mi">30</span>  <span class="err">加减</span> <span class="mi">1</span><span class="err">小时</span> <span class="mi">50</span><span class="err">分</span>
<span class="n">time1</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="nb">date</span> <span class="o">+%</span><span class="n">s</span> <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;2016-10-24 11:20:30&#39;</span><span class="p">)</span> <span class="o">#</span> <span class="err">转换指定日期</span>
<span class="o">#</span> <span class="n">time1</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="nb">date</span> <span class="o">+%</span><span class="n">s</span><span class="p">)</span>          <span class="o">#</span> <span class="err">当前日期</span>

<span class="n">time2</span><span class="o">=</span><span class="err">$</span><span class="p">((</span><span class="mi">1</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">+</span><span class="mi">50</span><span class="o">*</span><span class="mi">60</span><span class="p">))</span>  <span class="o">#</span><span class="mi">1</span><span class="err">小时</span> <span class="mi">50</span><span class="err">分</span>

<span class="n">timesnmp1</span><span class="o">=</span><span class="err">$</span><span class="p">((</span><span class="err">$</span><span class="n">time1</span><span class="o">+</span><span class="err">$</span><span class="n">time2</span><span class="p">))</span> 
<span class="n">echo</span> <span class="err">$</span><span class="p">(</span><span class="nb">date</span> <span class="o">+</span><span class="ss">&quot;%F %T&quot;</span> <span class="o">-</span><span class="n">d</span> <span class="ss">&quot;1970-01-01 UTC $timesnmp1 seconds&quot;</span><span class="p">)</span>

<span class="n">timesnmp2</span><span class="o">=</span><span class="err">$</span><span class="p">((</span><span class="err">$</span><span class="n">time1</span><span class="o">-</span><span class="err">$</span><span class="n">time2</span><span class="p">))</span>
<span class="n">echo</span> <span class="err">$</span><span class="p">(</span><span class="nb">date</span> <span class="o">+</span><span class="ss">&quot;%F %T&quot;</span> <span class="o">-</span><span class="n">d</span> <span class="ss">&quot;1970-01-01 UTC $timesnmp2 seconds&quot;</span><span class="p">)</span>
</pre></div>


<h2 id="tar">tar高级用法</h2>
<div class="codehilite"><pre><span></span><span class="n">Linux</span><span class="err">上有功能强大的</span><span class="n">tar</span><span class="err">命令，</span><span class="n">tar</span><span class="err">最初是为了制作磁带备份（</span><span class="n">tape</span> <span class="n">archive</span><span class="err">）而设计的，它的作用</span>
<span class="err">是把文件和目录备份到磁带中，</span>
<span class="err">然后从磁带中提取或恢复文件。现在我们可以使用</span><span class="n">tar</span><span class="err">来备份数据到任何存储介质上。它是文件级备份，</span>
<span class="err">不必考虑底层文件系统类别，</span>
<span class="err">并且支持增量备份。</span>

<span class="mi">1</span><span class="p">.</span> <span class="err">部分常用选项</span>
<span class="o">-</span><span class="n">z</span><span class="p">,</span> <span class="c1">--gzip：使用gzip工具（解）压缩，后缀一般为.gz</span>
<span class="o">-</span><span class="k">c</span><span class="p">,</span> <span class="c1">--create：tar打包，后缀一般为.tar</span>
<span class="o">-</span><span class="n">f</span><span class="p">,</span> <span class="c1">--file=：后面立刻接打包或压缩后得到的文件名</span>
<span class="o">-</span><span class="n">x</span><span class="p">,</span> <span class="c1">--extract：解包命令，与-c对应</span>
<span class="o">-</span><span class="n">p</span><span class="err">：保留备份数据的原本权限和属性</span>
<span class="o">-</span><span class="k">g</span><span class="err">：后接增量备份的快照文件</span>
<span class="o">-</span><span class="k">C</span><span class="err">：指定解压缩的目录</span>
<span class="c1">--exclude：排除不打包的目录或文件，支持正则匹配</span>
<span class="err">其他</span>

<span class="o">-</span><span class="n">X</span><span class="p">,</span> <span class="c1">--exclude-from：在一个文件中列出要排除的目录或文件（在--exclude=较多时使用）</span>
<span class="o">-</span><span class="n">t</span><span class="p">,</span> <span class="c1">--list：列出备份档案中的文件列表，不与-c、-x同时出现</span>
<span class="o">-</span><span class="n">j</span><span class="p">,</span> <span class="c1">--bzip2：使用bzip2工具（解）压缩，后缀一般为.bz2</span>
<span class="o">-</span><span class="n">P</span><span class="err">：保留绝对路径，解压时同样会自动解压到绝对路径下</span>
<span class="o">-</span><span class="n">v</span><span class="err">：（解）压缩过程显示文件处理过程，常用但不建议对大型文件使用</span>
<span class="mi">2</span><span class="p">.</span> <span class="err">增量备份（网站）数据</span>
<span class="err">许多系统（应用或网站）每天都有静态文件产生，对于一些比较重要的静态文件如果有进行定期</span>
<span class="err">备份的需求，就可以通过</span><span class="n">tar</span><span class="err">打包压缩</span>
<span class="err">备份到指定的地方，特别是对一些总文件比较大比较多的情况，还可以利用</span><span class="o">-</span><span class="k">g</span><span class="err">选项来做增量备份。</span>

<span class="err">备份的目录最好使用相对路径，也就是进入到需要备份的根目录下</span>

<span class="err">具体示例方法如下。</span>

<span class="err">备份当前目录下的所有文件</span>
<span class="o">#</span> <span class="n">tar</span> <span class="o">-</span><span class="k">g</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">snapshot_data</span><span class="p">.</span><span class="n">snap</span> <span class="o">-</span><span class="n">zcpf</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">data01</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span> <span class="p">.</span>
<span class="err">在需要恢复的目录下解压恢复</span>
<span class="o">#</span> <span class="n">tar</span> <span class="o">-</span><span class="n">zxpf</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">data01</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span> <span class="o">-</span><span class="k">C</span> <span class="p">.</span>
<span class="o">-</span><span class="k">g</span><span class="err">选项可以理解备份时给目录文件做一个快照，记录权限和属性等信息，第一次备份时</span>
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">snapshot_data</span><span class="p">.</span><span class="n">snap</span><span class="err">不存在，</span>
<span class="err">会新建一个并做完全备份。当目录下的文件有修改后，再次执行第一条备份命令（记得修改后面的</span>
<span class="err">档案文件名），</span>
<span class="err">会自动根据</span><span class="o">-</span><span class="k">g</span><span class="err">指定的快照文件，增量备份修改过的文件，包括权限和属性，没有动过的文件不会</span>
<span class="err">重复备份。</span>

<span class="err">另外需要注意上面的恢复，是“保留恢复”，即存在相同文件名的文件会被覆盖，而原目录下</span>
<span class="err">已存在（但备份档案里没有）的，</span>
<span class="err">会依然保留。所以如果你想完全恢复到与备份文件一模一样，需要清空原目录。如果有增量备份档案，</span>
<span class="err">则还需要使用同样的方式分别</span>
<span class="err">解压这些档案，而且要注意顺序。</span>

<span class="err">下面演示一个比较综合的例子，要求：</span>

<span class="err">备份</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="k">data</span><span class="err">目录，但</span><span class="k">cache</span><span class="err">目录以及临时文件排除在外</span>
<span class="err">由于目录比较大（</span><span class="o">&gt;</span><span class="mi">4</span><span class="k">G</span><span class="err">），所以全备时分割备份的档案（如每个备份档案文件最大</span><span class="mi">1</span><span class="k">G</span><span class="err">）</span>
<span class="err">保留所有文件的权限和属性，如用户组和读写权限</span>

<span class="o">#</span> <span class="n">cd</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="k">data</span>
<span class="err">做一次完全备份</span>
<span class="o">#</span> <span class="n">rm</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">snapshot_data</span><span class="p">.</span><span class="n">snap</span>
<span class="o">#</span> <span class="n">tar</span> <span class="o">-</span><span class="k">g</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">snapshot_data</span><span class="p">.</span><span class="n">snap</span> <span class="o">-</span><span class="n">zcpf</span> <span class="o">-</span> <span class="c1">--exclude=./cache ./ | split -b 1024M - /tmp/bak_data$(date -I).tar.gz_</span>
<span class="err">分割后文件名后会依次加上</span><span class="n">aa</span><span class="p">,</span><span class="n">ab</span><span class="p">,</span><span class="n">ac</span><span class="p">,...</span><span class="err">，上面最终的备份归档会保存成</span>
<span class="n">bak_data2014</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">07</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz_aa</span>
<span class="n">bak_data2014</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">07</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz_ab</span>
<span class="n">bak_data2014</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">07</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz_ac</span>
<span class="p">...</span>
<span class="err">增量备份</span>
<span class="err">可以是与完全备份一模一样的命令，但需要注意的是假如你一天备份多次，可能导致档案文件名重复，</span>
<span class="err">那么就会导致</span>
<span class="err">备份实现，因为</span><span class="n">split</span><span class="err">依然会从</span><span class="n">aa</span><span class="p">,</span><span class="n">ab</span><span class="err">开始命名，如果一天的文件产生（修改）量不是特别大，那么</span>
<span class="err">建议增量部分不</span>
<span class="err">分割处理了：（</span> <span class="err">一定要分割的话，文件名加入更细致的时间如$</span><span class="p">(</span><span class="nb">date</span> <span class="o">+%</span><span class="n">Y</span><span class="o">-%</span><span class="n">m</span><span class="o">-%</span><span class="n">d_</span><span class="o">%</span><span class="n">H</span><span class="p">)</span> <span class="err">）</span>
<span class="o">#</span> <span class="n">tar</span> <span class="o">-</span><span class="k">g</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">snapshot_data</span><span class="p">.</span><span class="n">snap</span> <span class="o">-</span><span class="n">zcpf</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">bak_data2014</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">07</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span> <span class="c1">--exclude=./cache ./</span>
<span class="err">第二天增备</span>
<span class="o">#</span> <span class="n">tar</span> <span class="o">-</span><span class="k">g</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">snapshot_data</span><span class="p">.</span><span class="n">snap</span> <span class="o">-</span><span class="n">zcpf</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">bak_data2014</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">08</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span> <span class="c1">--exclude=./cache ./</span>
<span class="err">恢复过程</span>

<span class="err">恢复完全备份的档案文件</span>
<span class="err">可以选择是否先清空</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="err">目录</span>
<span class="o">#</span> <span class="n">cat</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">bak_data2014</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">07</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz_</span><span class="o">*</span> <span class="o">|</span> <span class="n">tar</span> <span class="o">-</span><span class="n">zxpf</span> <span class="o">-</span> <span class="o">-</span><span class="k">C</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="k">data</span><span class="o">/</span>
<span class="err">恢复增量备份的档案文件</span>
<span class="err">$</span> <span class="n">tar</span> <span class="err">–</span><span class="n">zxpf</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">bak_data2014</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">07</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span> <span class="o">-</span><span class="k">C</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="k">data</span><span class="o">/</span>
<span class="err">$</span> <span class="n">tar</span> <span class="err">–</span><span class="n">zxpf</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">bak_data2014</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">08</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span> <span class="o">-</span><span class="k">C</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="k">data</span><span class="o">/</span>
<span class="p">...</span>
<span class="err">一定要保证是按时间顺序恢复的，像下面文件名规则也可以使用上面通配符的形式</span>
<span class="err">如果需要定期备份，如每周一次全备，每天一次增量备份，则可以结合</span><span class="n">crontab</span><span class="err">实现。</span>

<span class="mi">3</span><span class="p">.</span> <span class="err">备份文件系统</span>
<span class="err">备份文件系统方法有很多，例如</span><span class="n">cpio</span><span class="p">,</span> <span class="n">rsync</span><span class="p">,</span> <span class="n">dump</span><span class="p">,</span> <span class="n">tar</span><span class="err">，这里演示一个通过</span><span class="n">tar</span><span class="err">备份整个</span><span class="n">Linux</span>
<span class="err">系统的例子，整个备份与恢复过程与上面类似。</span>
<span class="err">首先</span><span class="n">Linux</span><span class="err">（这里是</span><span class="n">CentOS</span><span class="err">）有一部分目录是没必要备份的，如</span><span class="o">/</span><span class="n">proc</span><span class="err">、</span><span class="o">/</span><span class="n">lost</span><span class="o">+</span><span class="k">found</span><span class="err">、</span><span class="o">/</span><span class="n">sys</span><span class="err">、</span><span class="o">/</span><span class="n">mnt</span><span class="err">、</span>
<span class="o">/</span><span class="n">media</span><span class="err">、</span><span class="o">/</span><span class="n">dev</span><span class="err">、</span><span class="o">/</span><span class="n">proc</span><span class="err">、</span><span class="o">/</span><span class="n">tmp</span><span class="err">，</span>
<span class="err">如果是备份到磁带</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">st0</span><span class="err">则不必关心那么多，因为我这里是备份到本地</span><span class="o">/</span><span class="n">backup</span><span class="err">目录，所以也需要</span>
<span class="err">排除，还有其它一些</span><span class="n">NFS</span><span class="err">或者</span>
<span class="err">网络存储挂载的目录。</span>

<span class="err">创建排除列表文件</span>
<span class="o">#</span> <span class="n">vi</span> <span class="o">/</span><span class="n">backup</span><span class="o">/</span><span class="n">backup_tar_exclude</span><span class="p">.</span><span class="n">list</span>
<span class="o">/</span><span class="n">backup</span>
<span class="o">/</span><span class="n">proc</span>
<span class="o">/</span><span class="n">lost</span><span class="o">+</span><span class="k">found</span>
<span class="o">/</span><span class="n">sys</span>
<span class="o">/</span><span class="n">mnt</span>
<span class="o">/</span><span class="n">media</span>
<span class="o">/</span><span class="n">dev</span>
<span class="o">/</span><span class="n">tmp</span>
<span class="err">$</span> <span class="n">tar</span> <span class="o">-</span><span class="n">zcpf</span> <span class="o">/</span><span class="n">backup</span><span class="o">/</span><span class="n">backup_full</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span> <span class="o">-</span><span class="k">g</span> <span class="o">/</span><span class="n">backup</span><span class="o">/</span><span class="n">tar_snapshot</span><span class="p">.</span><span class="n">snap</span> 
<span class="c1">--exclude-from=/backup/tar_exclude.list /</span>
<span class="mi">4</span><span class="p">.</span> <span class="err">注意</span>
<span class="err">使用</span><span class="n">tar</span><span class="err">无论是备份数据还是文件系统，需要考虑是在原系统上恢复还是另一个新的系统上恢复。</span>

<span class="n">tar</span><span class="err">备份极度依赖于文件的</span><span class="n">atime</span><span class="err">属性，</span>
<span class="err">文件所属用户是根据用户</span><span class="n">ID</span><span class="err">来确定的，异机恢复需要考虑相同用户拥有相同</span><span class="n">USERID</span>
<span class="err">备份和恢复的过程尽量不要运行其他进程，可能会导致数据不一致</span>
<span class="err">软硬连接文件可以正常恢复</span>
</pre></div>


<h2 id="linux">检查Linux服务器性能</h2>
<div class="codehilite"><pre><span></span><span class="err">如果你的</span><span class="n">Linux</span><span class="err">服务器突然负载暴增，告警短信快发爆你的手机，如何在最短时间内找出</span><span class="n">Linux</span><span class="err">性能问题</span>
<span class="err">所在？来看</span>
<span class="n">Netflix</span><span class="err">性能工程团队的这篇博文，看它们通过十条命令在一分钟内对机器性能问题进行诊断。</span>

<span class="err">概述</span>

<span class="err">通过执行以下命令，可以在</span><span class="mi">1</span><span class="err">分钟内对系统资源使用情况有个大致的了解。</span>

<span class="n">uptime</span>
<span class="n">dmesg</span> <span class="o">|</span> <span class="n">tail</span>
<span class="n">vmstat</span> <span class="mi">1</span>
<span class="n">mpstat</span> <span class="o">-</span><span class="n">P</span> <span class="n">ALL</span> <span class="mi">1</span>
<span class="n">pidstat</span> <span class="mi">1</span>
<span class="n">iostat</span> <span class="o">-</span><span class="n">xz</span> <span class="mi">1</span>
<span class="n">free</span> <span class="o">-</span><span class="n">m</span>
<span class="n">sar</span> <span class="o">-</span><span class="n">n</span> <span class="n">DEV</span> <span class="mi">1</span>
<span class="n">sar</span> <span class="o">-</span><span class="n">n</span> <span class="n">TCP</span><span class="p">,</span><span class="n">ETCP</span> <span class="mi">1</span>
<span class="n">top</span>
<span class="err">其中一些命令需要安装</span><span class="n">sysstat</span><span class="err">包，有一些由</span><span class="n">procps</span><span class="err">包提供。这些命令的输出，有助于快速定位性能</span>
<span class="err">瓶颈，检查出所有资源</span>
<span class="err">（</span><span class="n">CPU</span><span class="err">、内存、磁盘</span><span class="n">IO</span><span class="err">等）的利用率（</span><span class="n">utilization</span><span class="err">）、饱和度（</span><span class="n">saturation</span><span class="err">）和错误（</span><span class="n">error</span><span class="err">）度量</span>
<span class="err">，也就是所谓的</span><span class="n">USE</span><span class="err">方法。</span>

<span class="err">下面我们来逐一介绍下这些命令，有关这些命令更多的参数和说明，请参照命令的手册。</span>

<span class="n">uptime</span>

<span class="err">$</span> <span class="n">uptime</span>
<span class="mi">23</span><span class="o">:</span><span class="mi">51</span><span class="o">:</span><span class="mi">26</span> <span class="n">up</span> <span class="mi">21</span><span class="o">:</span><span class="mi">31</span><span class="p">,</span>  <span class="mi">1</span> <span class="n">user</span><span class="p">,</span>  <span class="n">load</span> <span class="nl">average</span><span class="p">:</span> <span class="mf">30.02</span><span class="p">,</span> <span class="mf">26.43</span><span class="p">,</span> <span class="mf">19.02</span>
<span class="err">这个命令可以快速查看机器的负载情况。在</span><span class="n">Linux</span><span class="err">系统中，这些数据表示等待</span><span class="n">CPU</span><span class="err">资源的进程和阻塞在</span>
<span class="err">不可中断</span><span class="n">IO</span><span class="err">进程（进程状态为</span><span class="n">D</span><span class="err">）</span>
<span class="err">的数量。这些数据可以让我们对系统资源使用有一个宏观的了解。</span>

<span class="err">命令的输出分别表示</span><span class="mi">1</span><span class="err">分钟、</span><span class="mi">5</span><span class="err">分钟、</span><span class="mi">15</span><span class="err">分钟的平均负载情况。通过这三个数据，可以了解服务器负载</span>
<span class="err">是在趋于紧张还是区域缓解。</span>
<span class="err">如果</span><span class="mi">1</span><span class="err">分钟平均负载很高，而</span><span class="mi">15</span><span class="err">分钟平均负载很低，说明服务器正在命令高负载情况，需要进一步</span>
<span class="err">排查</span><span class="n">CPU</span><span class="err">资源都消耗在了哪里。</span>
<span class="err">反之，如果</span><span class="mi">15</span><span class="err">分钟平均负载很高，</span><span class="mi">1</span><span class="err">分钟平均负载较低，则有可能是</span><span class="n">CPU</span><span class="err">资源紧张时刻已经过去。</span>

<span class="err">上面例子中的输出，可以看见最近</span><span class="mi">1</span><span class="err">分钟的平均负载非常高，且远高于最近</span><span class="mi">15</span><span class="err">分钟负载，因此我们</span>
<span class="err">需要继续排查当前系统中有什么</span>
<span class="err">进程消耗了大量的资源。可以通过下文将会介绍的</span><span class="n">vmstat</span><span class="err">、</span><span class="n">mpstat</span><span class="err">等命令进一步排查。</span>

<span class="n">dmesg</span> <span class="o">|</span> <span class="n">tail</span>

<span class="err">$</span> <span class="n">dmesg</span> <span class="o">|</span> <span class="n">tail</span>
<span class="p">[</span><span class="mf">1880957.563150</span><span class="p">]</span> <span class="n">perl</span> <span class="n">invoked</span> <span class="n">oom</span><span class="o">-</span><span class="nl">killer</span><span class="p">:</span> <span class="n">gfp_mask</span><span class="o">=</span><span class="mh">0x280da</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">oom_score_adj</span><span class="o">=</span><span class="mi">0</span>
<span class="p">[...]</span>
<span class="p">[</span><span class="mf">1880957.563400</span><span class="p">]</span> <span class="n">Out</span> <span class="n">of</span> <span class="nl">memory</span><span class="p">:</span> <span class="n">Kill</span> <span class="n">process</span> <span class="mi">18694</span> <span class="p">(</span><span class="n">perl</span><span class="p">)</span> <span class="n">score</span> <span class="mi">246</span> <span class="n">or</span> <span class="n">sacrifice</span> <span class="n">child</span>
<span class="p">[</span><span class="mf">1880957.563408</span><span class="p">]</span> <span class="n">Killed</span> <span class="n">process</span> <span class="mi">18694</span> <span class="p">(</span><span class="n">perl</span><span class="p">)</span> <span class="n">total</span><span class="o">-</span><span class="nl">vm</span><span class="p">:</span><span class="mi">1972392</span><span class="n">kB</span><span class="p">,</span> <span class="n">anon</span><span class="o">-</span><span class="nl">rss</span><span class="p">:</span><span class="mi">1953348</span><span class="n">kB</span><span class="p">,</span> 
<span class="n">file</span><span class="o">-</span><span class="nl">rss</span><span class="p">:</span><span class="mi">0</span><span class="n">kB</span>
<span class="p">[</span><span class="mf">2320864.954447</span><span class="p">]</span> <span class="nl">TCP</span><span class="p">:</span> <span class="n">Possible</span> <span class="n">SYN</span> <span class="n">flooding</span> <span class="n">on</span> <span class="n">port</span> <span class="mf">7001.</span> <span class="n">Dropping</span> <span class="n">request</span><span class="p">.</span>  <span class="n">Check</span> 
<span class="n">SNMP</span> <span class="n">counters</span><span class="p">.</span>
<span class="err">该命令会输出系统日志的最后</span><span class="mi">10</span><span class="err">行。示例中的输出，可以看见一次内核的</span><span class="n">oom</span> <span class="n">kill</span><span class="err">和一次</span><span class="n">TCP</span><span class="err">丢包。</span>
<span class="err">这些日志可以帮助排查性能问题。</span>
<span class="err">千万不要忘了这一步。</span>

<span class="n">vmstat</span> <span class="mi">1</span>

<span class="err">$</span> <span class="n">vmstat</span> <span class="mi">1</span>
<span class="n">procs</span> <span class="o">---------</span><span class="n">memory</span><span class="o">----------</span> <span class="o">---</span><span class="n">swap</span><span class="o">--</span> <span class="o">-----</span><span class="n">io</span><span class="o">----</span> <span class="o">-</span><span class="n">system</span><span class="o">--</span> <span class="o">------</span><span class="n">cpu</span><span class="o">-----</span>
 <span class="n">r</span>  <span class="n">b</span> <span class="n">swpd</span>   <span class="n">free</span>   <span class="n">buff</span>  <span class="n">cache</span>   <span class="n">si</span>   <span class="n">so</span>    <span class="n">bi</span>    <span class="n">bo</span>   <span class="n">in</span>   <span class="n">cs</span> <span class="n">us</span> <span class="n">sy</span> <span class="n">id</span> <span class="n">wa</span> <span class="n">st</span>
<span class="mi">34</span>  <span class="mi">0</span>    <span class="mi">0</span> <span class="mi">200889792</span>  <span class="mi">73708</span> <span class="mi">591828</span>    <span class="mi">0</span>    <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">5</span>    <span class="mi">6</span>   <span class="mi">10</span> <span class="mi">96</span>  <span class="mi">1</span>  <span class="mi">3</span>  <span class="mi">0</span>  <span class="mi">0</span>
<span class="mi">32</span>  <span class="mi">0</span>    <span class="mi">0</span> <span class="mi">200889920</span>  <span class="mi">73708</span> <span class="mi">591860</span>    <span class="mi">0</span>    <span class="mi">0</span>     <span class="mi">0</span>   <span class="mi">592</span> <span class="mi">13284</span> <span class="mi">4282</span> <span class="mi">98</span>  <span class="mi">1</span>  <span class="mi">1</span>  <span class="mi">0</span>  <span class="mi">0</span>
<span class="mi">32</span>  <span class="mi">0</span>    <span class="mi">0</span> <span class="mi">200890112</span>  <span class="mi">73708</span> <span class="mi">591860</span>    <span class="mi">0</span>    <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span> <span class="mi">9501</span> <span class="mi">2154</span> <span class="mi">99</span>  <span class="mi">1</span>  <span class="mi">0</span>  <span class="mi">0</span>  <span class="mi">0</span>
<span class="mi">32</span>  <span class="mi">0</span>    <span class="mi">0</span> <span class="mi">200889568</span>  <span class="mi">73712</span> <span class="mi">591856</span>    <span class="mi">0</span>    <span class="mi">0</span>     <span class="mi">0</span>    <span class="mi">48</span> <span class="mi">11900</span> <span class="mi">2459</span> <span class="mi">99</span>  <span class="mi">0</span>  <span class="mi">0</span>  <span class="mi">0</span>  <span class="mi">0</span>
<span class="mi">32</span>  <span class="mi">0</span>    <span class="mi">0</span> <span class="mi">200890208</span>  <span class="mi">73712</span> <span class="mi">591860</span>    <span class="mi">0</span>    <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span> <span class="mi">15898</span> <span class="mi">4840</span> <span class="mi">98</span>  <span class="mi">1</span>  <span class="mi">1</span>  <span class="mi">0</span>  <span class="mi">0</span>
<span class="o">^</span><span class="n">C</span>
<span class="n">vmstat</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="err">命令，每行会输出一些系统核心指标，这些指标可以让我们更详细的了解系统状态。</span>
<span class="err">后面跟的参数</span><span class="mi">1</span><span class="err">，表示每秒输出一次统计信息，</span>
<span class="err">表头提示了每一列的含义，这几介绍一些和性能调优相关的列：</span>

<span class="n">r</span><span class="err">：等待在</span><span class="n">CPU</span><span class="err">资源的进程数。这个数据比平均负载更加能够体现</span><span class="n">CPU</span><span class="err">负载情况，数据中不包含等待</span><span class="n">IO</span>
<span class="err">的进程。如果这个数值大于机器</span><span class="n">CPU</span><span class="err">核数，</span>
<span class="err">那么机器的</span><span class="n">CPU</span><span class="err">资源已经饱和。</span>
<span class="n">free</span><span class="err">：系统可用内存数（以千字节为单位），如果剩余内存不足，也会导致系统性能问题。下文介绍</span>
<span class="err">到的</span><span class="n">free</span><span class="err">命令，可以更详细的了解系统</span>
<span class="err">内存的使用情况。</span>
<span class="n">si</span><span class="p">,</span> <span class="n">so</span><span class="err">：交换区写入和读取的数量。如果这个数据不为</span><span class="mi">0</span><span class="err">，说明系统已经在使用交换区（</span><span class="n">swap</span><span class="err">），</span>
<span class="err">机器物理内存已经不足。</span>
<span class="n">us</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">wa</span><span class="p">,</span> <span class="n">st</span><span class="err">：这些都代表了</span><span class="n">CPU</span><span class="err">时间的消耗，它们分别表示用户时间（</span><span class="n">user</span><span class="err">）、系统（内核）</span>
<span class="err">时间（</span><span class="n">sys</span><span class="err">）、空闲时间（</span><span class="n">idle</span><span class="err">）、</span>
<span class="n">IO</span><span class="err">等待时间（</span><span class="n">wait</span><span class="err">）和被偷走的时间（</span><span class="n">stolen</span><span class="err">，一般被其他虚拟机消耗）。</span>
<span class="err">上述这些</span><span class="n">CPU</span><span class="err">时间，可以让我们很快了解</span><span class="n">CPU</span><span class="err">是否出于繁忙状态。一般情况下，如果用户时间和</span>
<span class="err">系统时间相加非常大，</span><span class="n">CPU</span><span class="err">出于忙于执行指令。</span>
<span class="err">如果</span><span class="n">IO</span><span class="err">等待时间很长，那么系统的瓶颈可能在磁盘</span><span class="n">IO</span><span class="err">。</span>

<span class="err">示例命令的输出可以看见，大量</span><span class="n">CPU</span><span class="err">时间消耗在用户态，也就是用户应用程序消耗了</span><span class="n">CPU</span><span class="err">时间。这</span>
<span class="err">不一定是性能问题，需要结合</span><span class="n">r</span><span class="err">队列，一起分析。</span>

<span class="n">mpstat</span> <span class="o">-</span><span class="n">P</span> <span class="n">ALL</span> <span class="mi">1</span>

<span class="err">$</span> <span class="n">mpstat</span> <span class="o">-</span><span class="n">P</span> <span class="n">ALL</span> <span class="mi">1</span>
<span class="n">Linux</span> <span class="mf">3.13.0</span><span class="o">-</span><span class="mi">49</span><span class="o">-</span><span class="n">generic</span> <span class="p">(</span><span class="n">titanclusters</span><span class="o">-</span><span class="n">xxxxx</span><span class="p">)</span>  <span class="mo">07</span><span class="o">/</span><span class="mi">14</span><span class="o">/</span><span class="mi">2015</span>  <span class="n">_x86_64_</span> <span class="p">(</span><span class="mi">32</span> <span class="n">CPU</span><span class="p">)</span>
<span class="mo">07</span><span class="o">:</span><span class="mi">38</span><span class="o">:</span><span class="mi">49</span> <span class="n">PM</span>  <span class="n">CPU</span>   <span class="nf">%usr</span>  <span class="nf">%nice</span>   <span class="nf">%sys</span> <span class="nf">%iowait</span>   <span class="nf">%irq</span>  <span class="nf">%soft</span>  <span class="nf">%steal</span>  <span class="nf">%guest</span>  <span class="nf">%gnice</span>  <span class="nf">%idle</span>
<span class="mo">07</span><span class="o">:</span><span class="mi">38</span><span class="o">:</span><span class="mi">50</span> <span class="n">PM</span>  <span class="n">all</span>  <span class="mf">98.47</span>   <span class="mf">0.00</span>   <span class="mf">0.75</span>    <span class="mf">0.00</span>   <span class="mf">0.00</span>   <span class="mf">0.00</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>   <span class="mf">0.78</span>
<span class="mo">07</span><span class="o">:</span><span class="mi">38</span><span class="o">:</span><span class="mi">50</span> <span class="n">PM</span>    <span class="mi">0</span>  <span class="mf">96.04</span>   <span class="mf">0.00</span>   <span class="mf">2.97</span>    <span class="mf">0.00</span>   <span class="mf">0.00</span>   <span class="mf">0.00</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>   <span class="mf">0.99</span>
<span class="mo">07</span><span class="o">:</span><span class="mi">38</span><span class="o">:</span><span class="mi">50</span> <span class="n">PM</span>    <span class="mi">1</span>  <span class="mf">97.00</span>   <span class="mf">0.00</span>   <span class="mf">1.00</span>    <span class="mf">0.00</span>   <span class="mf">0.00</span>   <span class="mf">0.00</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>   <span class="mf">2.00</span>
<span class="mo">07</span><span class="o">:</span><span class="mi">38</span><span class="o">:</span><span class="mi">50</span> <span class="n">PM</span>    <span class="mi">2</span>  <span class="mf">98.00</span>   <span class="mf">0.00</span>   <span class="mf">1.00</span>    <span class="mf">0.00</span>   <span class="mf">0.00</span>   <span class="mf">0.00</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>   <span class="mf">1.00</span>
<span class="mo">07</span><span class="o">:</span><span class="mi">38</span><span class="o">:</span><span class="mi">50</span> <span class="n">PM</span>    <span class="mi">3</span>  <span class="mf">96.97</span>   <span class="mf">0.00</span>   <span class="mf">0.00</span>    <span class="mf">0.00</span>   <span class="mf">0.00</span>   <span class="mf">0.00</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>   <span class="mf">3.03</span>
<span class="p">[...]</span>
<span class="err">该命令可以显示每个</span><span class="n">CPU</span><span class="err">的占用情况，如果有一个</span><span class="n">CPU</span><span class="err">占用率特别高，那么有可能是一个单线程应用程序引起的。</span>

<span class="n">pidstat</span> <span class="mi">1</span>

<span class="err">$</span> <span class="n">pidstat</span> <span class="mi">1</span>
<span class="n">Linux</span> <span class="mf">3.13.0</span><span class="o">-</span><span class="mi">49</span><span class="o">-</span><span class="n">generic</span> <span class="p">(</span><span class="n">titanclusters</span><span class="o">-</span><span class="n">xxxxx</span><span class="p">)</span>  <span class="mo">07</span><span class="o">/</span><span class="mi">14</span><span class="o">/</span><span class="mi">2015</span>    <span class="n">_x86_64_</span>    <span class="p">(</span><span class="mi">32</span> <span class="n">CPU</span><span class="p">)</span>
<span class="mo">07</span><span class="o">:</span><span class="mi">41</span><span class="o">:</span><span class="mo">02</span> <span class="n">PM</span>   <span class="n">UID</span>       <span class="n">PID</span>    <span class="nf">%usr</span> <span class="nf">%system</span>  <span class="nf">%guest</span>    <span class="o">%</span><span class="n">CPU</span>   <span class="n">CPU</span>  <span class="n">Command</span>
<span class="mo">07</span><span class="o">:</span><span class="mi">41</span><span class="o">:</span><span class="mo">03</span> <span class="n">PM</span>     <span class="mi">0</span>         <span class="mi">9</span>    <span class="mf">0.00</span>    <span class="mf">0.94</span>    <span class="mf">0.00</span>    <span class="mf">0.94</span>     <span class="mi">1</span>  <span class="n">rcuos</span><span class="o">/</span><span class="mi">0</span>
<span class="mo">07</span><span class="o">:</span><span class="mi">41</span><span class="o">:</span><span class="mo">03</span> <span class="n">PM</span>     <span class="mi">0</span>      <span class="mi">4214</span>    <span class="mf">5.66</span>    <span class="mf">5.66</span>    <span class="mf">0.00</span>   <span class="mf">11.32</span>    <span class="mi">15</span>  <span class="n">mesos</span><span class="o">-</span><span class="n">slave</span>
<span class="mo">07</span><span class="o">:</span><span class="mi">41</span><span class="o">:</span><span class="mo">03</span> <span class="n">PM</span>     <span class="mi">0</span>      <span class="mi">4354</span>    <span class="mf">0.94</span>    <span class="mf">0.94</span>    <span class="mf">0.00</span>    <span class="mf">1.89</span>     <span class="mi">8</span>  <span class="n">java</span>
<span class="mo">07</span><span class="o">:</span><span class="mi">41</span><span class="o">:</span><span class="mo">03</span> <span class="n">PM</span>     <span class="mi">0</span>      <span class="mi">6521</span> <span class="mf">1596.23</span>    <span class="mf">1.89</span>    <span class="mf">0.00</span> <span class="mf">1598.11</span>    <span class="mi">27</span>  <span class="n">java</span>
<span class="mo">07</span><span class="o">:</span><span class="mi">41</span><span class="o">:</span><span class="mo">03</span> <span class="n">PM</span>     <span class="mi">0</span>      <span class="mi">6564</span> <span class="mf">1571.70</span>    <span class="mf">7.55</span>    <span class="mf">0.00</span> <span class="mf">1579.25</span>    <span class="mi">28</span>  <span class="n">java</span>
<span class="mo">07</span><span class="o">:</span><span class="mi">41</span><span class="o">:</span><span class="mo">03</span> <span class="n">PM</span> <span class="mi">60004</span>     <span class="mi">60154</span>    <span class="mf">0.94</span>    <span class="mf">4.72</span>    <span class="mf">0.00</span>    <span class="mf">5.66</span>     <span class="mi">9</span>  <span class="n">pidstat</span>
<span class="mo">07</span><span class="o">:</span><span class="mi">41</span><span class="o">:</span><span class="mo">03</span> <span class="n">PM</span>   <span class="n">UID</span>       <span class="n">PID</span>    <span class="nf">%usr</span> <span class="nf">%system</span>  <span class="nf">%guest</span>    <span class="o">%</span><span class="n">CPU</span>   <span class="n">CPU</span>  <span class="n">Command</span>
<span class="mo">07</span><span class="o">:</span><span class="mi">41</span><span class="o">:</span><span class="mo">04</span> <span class="n">PM</span>     <span class="mi">0</span>      <span class="mi">4214</span>    <span class="mf">6.00</span>    <span class="mf">2.00</span>    <span class="mf">0.00</span>    <span class="mf">8.00</span>    <span class="mi">15</span>  <span class="n">mesos</span><span class="o">-</span><span class="n">slave</span>
<span class="mo">07</span><span class="o">:</span><span class="mi">41</span><span class="o">:</span><span class="mo">04</span> <span class="n">PM</span>     <span class="mi">0</span>      <span class="mi">6521</span> <span class="mf">1590.00</span>    <span class="mf">1.00</span>    <span class="mf">0.00</span> <span class="mf">1591.00</span>    <span class="mi">27</span>  <span class="n">java</span>
<span class="mo">07</span><span class="o">:</span><span class="mi">41</span><span class="o">:</span><span class="mo">04</span> <span class="n">PM</span>     <span class="mi">0</span>      <span class="mi">6564</span> <span class="mf">1573.00</span>   <span class="mf">10.00</span>    <span class="mf">0.00</span> <span class="mf">1583.00</span>    <span class="mi">28</span>  <span class="n">java</span>
<span class="mo">07</span><span class="o">:</span><span class="mi">41</span><span class="o">:</span><span class="mo">04</span> <span class="n">PM</span>   <span class="mi">108</span>      <span class="mi">6718</span>    <span class="mf">1.00</span>    <span class="mf">0.00</span>    <span class="mf">0.00</span>    <span class="mf">1.00</span>     <span class="mi">0</span>  <span class="n">snmp</span><span class="o">-</span><span class="n">pass</span>
<span class="mo">07</span><span class="o">:</span><span class="mi">41</span><span class="o">:</span><span class="mo">04</span> <span class="n">PM</span> <span class="mi">60004</span>     <span class="mi">60154</span>    <span class="mf">1.00</span>    <span class="mf">4.00</span>    <span class="mf">0.00</span>    <span class="mf">5.00</span>     <span class="mi">9</span>  <span class="n">pidstat</span>
<span class="o">^</span><span class="n">C</span>
<span class="n">pidstat</span><span class="err">命令输出进程的</span><span class="n">CPU</span><span class="err">占用率，该命令会持续输出，并且不会覆盖之前的数据，可以方便观察系统动态。如上的输出，</span>
<span class="err">可以看见两个</span><span class="n">JAVA</span><span class="err">进程占用了将近</span><span class="mi">1600</span><span class="o">%</span><span class="err">的</span><span class="n">CPU</span><span class="err">时间，既消耗了大约</span><span class="mi">16</span><span class="err">个</span><span class="n">CPU</span><span class="err">核心的运算资源。</span>


<span class="n">iostat</span> <span class="o">-</span><span class="n">xz</span> <span class="mi">1</span>

<span class="err">$</span> <span class="n">iostat</span> <span class="o">-</span><span class="n">xz</span> <span class="mi">1</span>
<span class="n">Linux</span> <span class="mf">3.13.0</span><span class="o">-</span><span class="mi">49</span><span class="o">-</span><span class="n">generic</span> <span class="p">(</span><span class="n">titanclusters</span><span class="o">-</span><span class="n">xxxxx</span><span class="p">)</span>  <span class="mo">07</span><span class="o">/</span><span class="mi">14</span><span class="o">/</span><span class="mi">2015</span>  <span class="n">_x86_64_</span> <span class="p">(</span><span class="mi">32</span> <span class="n">CPU</span><span class="p">)</span>
<span class="n">avg</span><span class="o">-</span><span class="nl">cpu</span><span class="p">:</span>  <span class="nf">%user</span>   <span class="nf">%nice</span> <span class="nf">%system</span> <span class="nf">%iowait</span>  <span class="nf">%steal</span>   <span class="nf">%idle</span>
          <span class="mf">73.96</span>    <span class="mf">0.00</span>    <span class="mf">3.73</span>    <span class="mf">0.03</span>    <span class="mf">0.06</span>   <span class="mf">22.21</span>
<span class="nl">Device</span><span class="p">:</span>   <span class="n">rrqm</span><span class="o">/</span><span class="n">s</span>   <span class="n">wrqm</span><span class="o">/</span><span class="n">s</span>     <span class="n">r</span><span class="o">/</span><span class="n">s</span>     <span class="n">w</span><span class="o">/</span><span class="n">s</span>    <span class="n">rkB</span><span class="o">/</span><span class="n">s</span>    <span class="n">wkB</span><span class="o">/</span><span class="n">s</span> <span class="n">avgrq</span><span class="o">-</span><span class="n">sz</span> <span class="n">avgqu</span><span class="o">-</span><span class="n">sz</span>   <span class="n">await</span> <span class="n">r_await</span> <span class="n">w_await</span>  <span class="n">svctm</span>  <span class="nf">%util</span>
<span class="n">xvda</span>        <span class="mf">0.00</span>     <span class="mf">0.23</span>    <span class="mf">0.21</span>    <span class="mf">0.18</span>     <span class="mf">4.52</span>     <span class="mf">2.08</span>    <span class="mf">34.37</span>     <span class="mf">0.00</span>    <span class="mf">9.98</span>   <span class="mf">13.80</span>    <span class="mf">5.42</span>   <span class="mf">2.44</span>   <span class="mf">0.09</span>
<span class="n">xvdb</span>        <span class="mf">0.01</span>     <span class="mf">0.00</span>    <span class="mf">1.02</span>    <span class="mf">8.94</span>   <span class="mf">127.97</span>   <span class="mf">598.53</span>   <span class="mf">145.79</span>     <span class="mf">0.00</span>    <span class="mf">0.43</span>    <span class="mf">1.78</span>    <span class="mf">0.28</span>   <span class="mf">0.25</span>   <span class="mf">0.25</span>
<span class="n">xvdc</span>        <span class="mf">0.01</span>     <span class="mf">0.00</span>    <span class="mf">1.02</span>    <span class="mf">8.86</span>   <span class="mf">127.79</span>   <span class="mf">595.94</span>   <span class="mf">146.50</span>     <span class="mf">0.00</span>    <span class="mf">0.45</span>    <span class="mf">1.82</span>    <span class="mf">0.30</span>   <span class="mf">0.27</span>   <span class="mf">0.26</span>
<span class="n">dm</span><span class="o">-</span><span class="mi">0</span>        <span class="mf">0.00</span>     <span class="mf">0.00</span>    <span class="mf">0.69</span>    <span class="mf">2.32</span>    <span class="mf">10.47</span>    <span class="mf">31.69</span>    <span class="mf">28.01</span>     <span class="mf">0.01</span>    <span class="mf">3.23</span>    <span class="mf">0.71</span>    <span class="mf">3.98</span>   <span class="mf">0.13</span>   <span class="mf">0.04</span>
<span class="n">dm</span><span class="o">-</span><span class="mi">1</span>        <span class="mf">0.00</span>     <span class="mf">0.00</span>    <span class="mf">0.00</span>    <span class="mf">0.94</span>     <span class="mf">0.01</span>     <span class="mf">3.78</span>     <span class="mf">8.00</span>     <span class="mf">0.33</span>  <span class="mf">345.84</span>    <span class="mf">0.04</span>  <span class="mf">346.81</span>   <span class="mf">0.01</span>   <span class="mf">0.00</span>
<span class="n">dm</span><span class="o">-</span><span class="mi">2</span>        <span class="mf">0.00</span>     <span class="mf">0.00</span>    <span class="mf">0.09</span>    <span class="mf">0.07</span>     <span class="mf">1.35</span>     <span class="mf">0.36</span>    <span class="mf">22.50</span>     <span class="mf">0.00</span>    <span class="mf">2.55</span>    <span class="mf">0.23</span>    <span class="mf">5.62</span>   <span class="mf">1.78</span>   <span class="mf">0.03</span>
<span class="p">[...]</span>
<span class="o">^</span><span class="n">C</span>
<span class="n">iostat</span><span class="err">命令主要用于查看机器磁盘</span><span class="n">IO</span><span class="err">情况。该命令输出的列，主要含义是：</span>

<span class="n">r</span><span class="o">/</span><span class="n">s</span><span class="p">,</span> <span class="n">w</span><span class="o">/</span><span class="n">s</span><span class="p">,</span> <span class="n">rkB</span><span class="o">/</span><span class="n">s</span><span class="p">,</span> <span class="n">wkB</span><span class="o">/</span><span class="n">s</span><span class="err">：分别表示每秒读写次数和每秒读写数据量（千字节）。读写量过大，</span>
<span class="err">可能会引起性能问题。</span>
<span class="n">await</span><span class="err">：</span><span class="n">IO</span><span class="err">操作的平均等待时间，单位是毫秒。这是应用程序在和磁盘交互时，需要消耗的时间，</span>
<span class="err">包括</span><span class="n">IO</span><span class="err">等待和实际操作的耗时。</span>
<span class="err">如果这个数值过大，可能是硬件设备遇到了瓶颈或者出现故障。</span>
<span class="n">avgqu</span><span class="o">-</span><span class="n">sz</span><span class="err">：向设备发出的请求平均数量。如果这个数值大于</span><span class="mi">1</span><span class="err">，可能是硬件设备已经饱和</span>
<span class="err">（部分前端硬件设备支持并行写入）。</span>
<span class="nf">%util</span><span class="err">：设备利用率。这个数值表示设备的繁忙程度，经验值是如果超过</span><span class="mi">60</span><span class="err">，可能会影响</span><span class="n">IO</span><span class="err">性能</span>
<span class="err">（可以参照</span><span class="n">IO</span><span class="err">操作平均等待时间）。</span>
<span class="err">如果到达</span><span class="mi">100</span><span class="o">%</span><span class="err">，说明硬件设备已经饱和。</span>
<span class="err">如果显示的是逻辑设备的数据，那么设备利用率不代表后端实际的硬件设备已经饱和。值得注意的是，</span>
<span class="err">即使</span><span class="n">IO</span><span class="err">性能不理想，</span>
<span class="err">也不一定意味这应用程序性能会不好，可以利用诸如预读取、写缓存等策略提升应用性能。</span>

<span class="n">free</span> <span class="err">–</span><span class="n">m</span>

<span class="err">$</span> <span class="n">free</span> <span class="o">-</span><span class="n">m</span>
             <span class="n">total</span>       <span class="n">used</span>       <span class="n">free</span>     <span class="n">shared</span>    <span class="n">buffers</span>     <span class="n">cached</span>
<span class="nl">Mem</span><span class="p">:</span>        <span class="mi">245998</span>      <span class="mi">24545</span>     <span class="mi">221453</span>         <span class="mi">83</span>         <span class="mi">59</span>        <span class="mi">541</span>
<span class="o">-/+</span> <span class="n">buffers</span><span class="o">/</span><span class="nl">cache</span><span class="p">:</span>      <span class="mi">23944</span>     <span class="mi">222053</span>
<span class="nl">Swap</span><span class="p">:</span>            <span class="mi">0</span>          <span class="mi">0</span>          <span class="mi">0</span>
<span class="n">free</span><span class="err">命令可以查看系统内存的使用情况，</span><span class="o">-</span><span class="n">m</span><span class="err">参数表示按照兆字节展示。最后两列分别表示用于</span><span class="n">IO</span>
<span class="err">缓存的内存数，和用于文件系统页缓存</span>
<span class="err">的内存数。需要注意的是，第二行</span><span class="o">-/+</span> <span class="n">buffers</span><span class="o">/</span><span class="n">cache</span><span class="err">，看上去缓存占用了大量内存空间。这是</span>
<span class="n">Linux</span><span class="err">系统的内存使用策略，尽可能的利用内存，</span>
<span class="err">如果应用程序需要内存，这部分内存会立即被回收并分配给应用程序。因此，这部分内存一般也</span>
<span class="err">被当成是可用内存。</span>

<span class="err">如果可用内存非常少，系统可能会动用交换区（如果配置了的话），这样会增加</span><span class="n">IO</span><span class="err">开销</span>
<span class="err">（可以在</span><span class="n">iostat</span><span class="err">命令中提现），降低系统性能。</span>

<span class="n">sar</span> <span class="o">-</span><span class="n">n</span> <span class="n">DEV</span> <span class="mi">1</span>

<span class="err">$</span> <span class="n">sar</span> <span class="o">-</span><span class="n">n</span> <span class="n">DEV</span> <span class="mi">1</span>
<span class="n">Linux</span> <span class="mf">3.13.0</span><span class="o">-</span><span class="mi">49</span><span class="o">-</span><span class="n">generic</span> <span class="p">(</span><span class="n">titanclusters</span><span class="o">-</span><span class="n">xxxxx</span><span class="p">)</span>  <span class="mo">07</span><span class="o">/</span><span class="mi">14</span><span class="o">/</span><span class="mi">2015</span>     <span class="n">_x86_64_</span>    <span class="p">(</span><span class="mi">32</span> <span class="n">CPU</span><span class="p">)</span>
<span class="mi">12</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">48</span> <span class="n">AM</span>     <span class="n">IFACE</span>   <span class="n">rxpck</span><span class="o">/</span><span class="n">s</span>   <span class="n">txpck</span><span class="o">/</span><span class="n">s</span>    <span class="n">rxkB</span><span class="o">/</span><span class="n">s</span>    <span class="n">txkB</span><span class="o">/</span><span class="n">s</span>   <span class="n">rxcmp</span><span class="o">/</span><span class="n">s</span>   <span class="n">txcmp</span><span class="o">/</span><span class="n">s</span>  <span class="n">rxmcst</span><span class="o">/</span><span class="n">s</span>   <span class="nf">%ifutil</span>
<span class="mi">12</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">49</span> <span class="n">AM</span>      <span class="n">eth0</span>  <span class="mf">18763.00</span>   <span class="mf">5032.00</span>  <span class="mf">20686.42</span>    <span class="mf">478.30</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>
<span class="mi">12</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">49</span> <span class="n">AM</span>        <span class="n">lo</span>     <span class="mf">14.00</span>     <span class="mf">14.00</span>      <span class="mf">1.36</span>      <span class="mf">1.36</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>
<span class="mi">12</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">49</span> <span class="n">AM</span>   <span class="n">docker0</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>
<span class="mi">12</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">49</span> <span class="n">AM</span>     <span class="n">IFACE</span>   <span class="n">rxpck</span><span class="o">/</span><span class="n">s</span>   <span class="n">txpck</span><span class="o">/</span><span class="n">s</span>    <span class="n">rxkB</span><span class="o">/</span><span class="n">s</span>    <span class="n">txkB</span><span class="o">/</span><span class="n">s</span>   <span class="n">rxcmp</span><span class="o">/</span><span class="n">s</span>   <span class="n">txcmp</span><span class="o">/</span><span class="n">s</span>  <span class="n">rxmcst</span><span class="o">/</span><span class="n">s</span>   <span class="nf">%ifutil</span>
<span class="mi">12</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">50</span> <span class="n">AM</span>      <span class="n">eth0</span>  <span class="mf">19763.00</span>   <span class="mf">5101.00</span>  <span class="mf">21999.10</span>    <span class="mf">482.56</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>
<span class="mi">12</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">50</span> <span class="n">AM</span>        <span class="n">lo</span>     <span class="mf">20.00</span>     <span class="mf">20.00</span>      <span class="mf">3.25</span>      <span class="mf">3.25</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>
<span class="mi">12</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mi">50</span> <span class="n">AM</span>   <span class="n">docker0</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>
<span class="o">^</span><span class="n">C</span>
<span class="n">sar</span><span class="err">命令在这里可以查看网络设备的吞吐率。在排查性能问题时，可以通过网络设备的吞吐量，</span>
<span class="err">判断网络设备是否已经饱和。如示例输出中，</span>
<span class="n">eth0</span><span class="err">网卡设备，吞吐率大概在</span><span class="mi">22</span> <span class="n">Mbytes</span><span class="o">/</span><span class="n">s</span><span class="err">，既</span><span class="mi">176</span> <span class="n">Mbits</span><span class="o">/</span><span class="n">sec</span><span class="err">，没有达到</span><span class="mi">1</span><span class="n">Gbit</span><span class="o">/</span><span class="n">sec</span><span class="err">的硬件上限。</span>

<span class="n">sar</span> <span class="o">-</span><span class="n">n</span> <span class="n">TCP</span><span class="p">,</span><span class="n">ETCP</span> <span class="mi">1</span>

<span class="err">$</span> <span class="n">sar</span> <span class="o">-</span><span class="n">n</span> <span class="n">TCP</span><span class="p">,</span><span class="n">ETCP</span> <span class="mi">1</span>
<span class="n">Linux</span> <span class="mf">3.13.0</span><span class="o">-</span><span class="mi">49</span><span class="o">-</span><span class="n">generic</span> <span class="p">(</span><span class="n">titanclusters</span><span class="o">-</span><span class="n">xxxxx</span><span class="p">)</span>  <span class="mo">07</span><span class="o">/</span><span class="mi">14</span><span class="o">/</span><span class="mi">2015</span>    <span class="n">_x86_64_</span>    <span class="p">(</span><span class="mi">32</span> <span class="n">CPU</span><span class="p">)</span>
<span class="mi">12</span><span class="o">:</span><span class="mi">17</span><span class="o">:</span><span class="mi">19</span> <span class="n">AM</span>  <span class="n">active</span><span class="o">/</span><span class="n">s</span> <span class="n">passive</span><span class="o">/</span><span class="n">s</span>    <span class="n">iseg</span><span class="o">/</span><span class="n">s</span>    <span class="n">oseg</span><span class="o">/</span><span class="n">s</span>
<span class="mi">12</span><span class="o">:</span><span class="mi">17</span><span class="o">:</span><span class="mi">20</span> <span class="n">AM</span>      <span class="mf">1.00</span>      <span class="mf">0.00</span>  <span class="mf">10233.00</span>  <span class="mf">18846.00</span>
<span class="mi">12</span><span class="o">:</span><span class="mi">17</span><span class="o">:</span><span class="mi">19</span> <span class="n">AM</span>  <span class="n">atmptf</span><span class="o">/</span><span class="n">s</span>  <span class="n">estres</span><span class="o">/</span><span class="n">s</span> <span class="n">retrans</span><span class="o">/</span><span class="n">s</span> <span class="n">isegerr</span><span class="o">/</span><span class="n">s</span>   <span class="n">orsts</span><span class="o">/</span><span class="n">s</span>
<span class="mi">12</span><span class="o">:</span><span class="mi">17</span><span class="o">:</span><span class="mi">20</span> <span class="n">AM</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>
<span class="mi">12</span><span class="o">:</span><span class="mi">17</span><span class="o">:</span><span class="mi">20</span> <span class="n">AM</span>  <span class="n">active</span><span class="o">/</span><span class="n">s</span> <span class="n">passive</span><span class="o">/</span><span class="n">s</span>    <span class="n">iseg</span><span class="o">/</span><span class="n">s</span>    <span class="n">oseg</span><span class="o">/</span><span class="n">s</span>
<span class="mi">12</span><span class="o">:</span><span class="mi">17</span><span class="o">:</span><span class="mi">21</span> <span class="n">AM</span>      <span class="mf">1.00</span>      <span class="mf">0.00</span>   <span class="mf">8359.00</span>   <span class="mf">6039.00</span>
<span class="mi">12</span><span class="o">:</span><span class="mi">17</span><span class="o">:</span><span class="mi">20</span> <span class="n">AM</span>  <span class="n">atmptf</span><span class="o">/</span><span class="n">s</span>  <span class="n">estres</span><span class="o">/</span><span class="n">s</span> <span class="n">retrans</span><span class="o">/</span><span class="n">s</span> <span class="n">isegerr</span><span class="o">/</span><span class="n">s</span>   <span class="n">orsts</span><span class="o">/</span><span class="n">s</span>
<span class="mi">12</span><span class="o">:</span><span class="mi">17</span><span class="o">:</span><span class="mi">21</span> <span class="n">AM</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>      <span class="mf">0.00</span>
<span class="o">^</span><span class="n">C</span>
<span class="n">sar</span><span class="err">命令在这里用于查看</span><span class="n">TCP</span><span class="err">连接状态，其中包括：</span>

<span class="n">active</span><span class="o">/</span><span class="n">s</span><span class="err">：每秒本地发起的</span><span class="n">TCP</span><span class="err">连接数，既通过</span><span class="n">connect</span><span class="err">调用创建的</span><span class="n">TCP</span><span class="err">连接；</span>
<span class="n">passive</span><span class="o">/</span><span class="n">s</span><span class="err">：每秒远程发起的</span><span class="n">TCP</span><span class="err">连接数，即通过</span><span class="n">accept</span><span class="err">调用创建的</span><span class="n">TCP</span><span class="err">连接；</span>
<span class="n">retrans</span><span class="o">/</span><span class="n">s</span><span class="err">：每秒</span><span class="n">TCP</span><span class="err">重传数量；</span>
<span class="n">TCP</span><span class="err">连接数可以用来判断性能问题是否由于建立了过多的连接，进一步可以判断是主动发起的连接，</span>
<span class="err">还是被动接受的连接。</span><span class="n">TCP</span><span class="err">重传可能是</span>
<span class="err">因为网络环境恶劣，或者服务器压力过大导致丢包。</span>

<span class="n">top</span>

<span class="err">$</span> <span class="n">top</span>
<span class="n">top</span> <span class="o">-</span> <span class="mo">00</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mi">40</span> <span class="n">up</span> <span class="mi">21</span><span class="o">:</span><span class="mi">56</span><span class="p">,</span>  <span class="mi">1</span> <span class="n">user</span><span class="p">,</span>  <span class="n">load</span> <span class="nl">average</span><span class="p">:</span> <span class="mf">31.09</span><span class="p">,</span> <span class="mf">29.87</span><span class="p">,</span> <span class="mf">29.92</span>
<span class="nl">Tasks</span><span class="p">:</span> <span class="mi">871</span> <span class="n">total</span><span class="p">,</span>   <span class="mi">1</span> <span class="n">running</span><span class="p">,</span> <span class="mi">868</span> <span class="n">sleeping</span><span class="p">,</span>   <span class="mi">0</span> <span class="n">stopped</span><span class="p">,</span>   <span class="mi">2</span> <span class="n">zombie</span>
<span class="o">%</span><span class="n">Cpu</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">:</span> <span class="mf">96.8</span> <span class="n">us</span><span class="p">,</span>  <span class="mf">0.4</span> <span class="n">sy</span><span class="p">,</span>  <span class="mf">0.0</span> <span class="n">ni</span><span class="p">,</span>  <span class="mf">2.7</span> <span class="n">id</span><span class="p">,</span>  <span class="mf">0.1</span> <span class="n">wa</span><span class="p">,</span>  <span class="mf">0.0</span> <span class="n">hi</span><span class="p">,</span>  <span class="mf">0.0</span> <span class="n">si</span><span class="p">,</span>  <span class="mf">0.0</span> <span class="n">st</span>
<span class="n">KiB</span> <span class="nl">Mem</span><span class="p">:</span>  <span class="mi">25190241</span><span class="o">+</span><span class="n">total</span><span class="p">,</span> <span class="mi">24921688</span> <span class="n">used</span><span class="p">,</span> <span class="mi">22698073</span><span class="o">+</span><span class="n">free</span><span class="p">,</span>    <span class="mi">60448</span> <span class="n">buffers</span>
<span class="n">KiB</span> <span class="nl">Swap</span><span class="p">:</span>        <span class="mi">0</span> <span class="n">total</span><span class="p">,</span>        <span class="mi">0</span> <span class="n">used</span><span class="p">,</span>        <span class="mi">0</span> <span class="n">free</span><span class="p">.</span>   <span class="mi">554208</span> <span class="n">cached</span> <span class="n">Mem</span>
   <span class="n">PID</span> <span class="n">USER</span>      <span class="n">PR</span>  <span class="n">NI</span>    <span class="n">VIRT</span>    <span class="n">RES</span>    <span class="n">SHR</span> <span class="n">S</span>  <span class="o">%</span><span class="n">CPU</span> <span class="o">%</span><span class="n">MEM</span>     <span class="n">TIME</span><span class="o">+</span> <span class="n">COMMAND</span>
 <span class="mi">20248</span> <span class="n">root</span>      <span class="mi">20</span>   <span class="mi">0</span>  <span class="mf">0.227</span><span class="n">t</span> <span class="mf">0.012</span><span class="n">t</span>  <span class="mi">18748</span> <span class="n">S</span>  <span class="mi">3090</span>  <span class="mf">5.2</span>  <span class="mi">29812</span><span class="o">:</span><span class="mi">58</span> <span class="n">java</span>
  <span class="mi">4213</span> <span class="n">root</span>      <span class="mi">20</span>   <span class="mi">0</span> <span class="mi">2722544</span>  <span class="mi">64640</span>  <span class="mi">44232</span> <span class="n">S</span>  <span class="mf">23.5</span>  <span class="mf">0.0</span> <span class="mi">233</span><span class="o">:</span><span class="mf">35.37</span> <span class="n">mesos</span><span class="o">-</span><span class="n">slave</span>
 <span class="mi">66128</span> <span class="n">titancl</span><span class="o">+</span>  <span class="mi">20</span>   <span class="mi">0</span>   <span class="mi">24344</span>   <span class="mi">2332</span>   <span class="mi">1172</span> <span class="n">R</span>   <span class="mf">1.0</span>  <span class="mf">0.0</span>   <span class="mi">0</span><span class="o">:</span><span class="mf">00.07</span> <span class="n">top</span>
  <span class="mi">5235</span> <span class="n">root</span>      <span class="mi">20</span>   <span class="mi">0</span> <span class="mf">38.227</span><span class="n">g</span> <span class="mi">547004</span>  <span class="mi">49996</span> <span class="n">S</span>   <span class="mf">0.7</span>  <span class="mf">0.2</span>   <span class="mi">2</span><span class="o">:</span><span class="mf">02.74</span> <span class="n">java</span>
  <span class="mi">4299</span> <span class="n">root</span>      <span class="mi">20</span>   <span class="mi">0</span> <span class="mf">20.015</span><span class="n">g</span> <span class="mf">2.682</span><span class="n">g</span>  <span class="mi">16836</span> <span class="n">S</span>   <span class="mf">0.3</span>  <span class="mf">1.1</span>  <span class="mi">33</span><span class="o">:</span><span class="mf">14.42</span> <span class="n">java</span>
     <span class="mi">1</span> <span class="n">root</span>      <span class="mi">20</span>   <span class="mi">0</span>   <span class="mi">33620</span>   <span class="mi">2920</span>   <span class="mi">1496</span> <span class="n">S</span>   <span class="mf">0.0</span>  <span class="mf">0.0</span>   <span class="mi">0</span><span class="o">:</span><span class="mf">03.82</span> <span class="n">init</span>
     <span class="mi">2</span> <span class="n">root</span>      <span class="mi">20</span>   <span class="mi">0</span>       <span class="mi">0</span>      <span class="mi">0</span>      <span class="mi">0</span> <span class="n">S</span>   <span class="mf">0.0</span>  <span class="mf">0.0</span>   <span class="mi">0</span><span class="o">:</span><span class="mf">00.02</span> <span class="n">kthreadd</span>
     <span class="mi">3</span> <span class="n">root</span>      <span class="mi">20</span>   <span class="mi">0</span>       <span class="mi">0</span>      <span class="mi">0</span>      <span class="mi">0</span> <span class="n">S</span>   <span class="mf">0.0</span>  <span class="mf">0.0</span>   <span class="mi">0</span><span class="o">:</span><span class="mf">05.35</span> <span class="n">ksoftirqd</span><span class="o">/</span><span class="mi">0</span>
     <span class="mi">5</span> <span class="n">root</span>       <span class="mi">0</span> <span class="o">-</span><span class="mi">20</span>       <span class="mi">0</span>      <span class="mi">0</span>      <span class="mi">0</span> <span class="n">S</span>   <span class="mf">0.0</span>  <span class="mf">0.0</span>   <span class="mi">0</span><span class="o">:</span><span class="mf">00.00</span> <span class="n">kworker</span><span class="o">/</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="n">H</span>
     <span class="mi">6</span> <span class="n">root</span>      <span class="mi">20</span>   <span class="mi">0</span>       <span class="mi">0</span>      <span class="mi">0</span>      <span class="mi">0</span> <span class="n">S</span>   <span class="mf">0.0</span>  <span class="mf">0.0</span>   <span class="mi">0</span><span class="o">:</span><span class="mf">06.94</span> <span class="n">kworker</span><span class="o">/</span><span class="nl">u256</span><span class="p">:</span><span class="mi">0</span>
     <span class="mi">8</span> <span class="n">root</span>      <span class="mi">20</span>   <span class="mi">0</span>       <span class="mi">0</span>      <span class="mi">0</span>      <span class="mi">0</span> <span class="n">S</span>   <span class="mf">0.0</span>  <span class="mf">0.0</span>   <span class="mi">2</span><span class="o">:</span><span class="mf">38.05</span> <span class="n">rcu_sched</span>
<span class="n">top</span><span class="err">命令包含了前面好几个命令的检查的内容。比如系统负载情况（</span><span class="n">uptime</span><span class="err">）、系统内存使用情况</span>
<span class="err">（</span><span class="n">free</span><span class="err">）、系统</span><span class="n">CPU</span><span class="err">使用情况（</span><span class="n">vmstat</span><span class="err">）等。</span>
<span class="err">因此通过这个命令，可以相对全面的查看系统负载的来源。同时，</span><span class="n">top</span><span class="err">命令支持排序，可以按照不同</span>
<span class="err">的列排序，方便查找出诸如内存占用</span>
<span class="err">最多的进程、</span><span class="n">CPU</span><span class="err">占用率最高的进程等。</span>

<span class="err">但是，</span><span class="n">top</span><span class="err">命令相对于前面一些命令，输出是一个瞬间值，如果不持续盯着，可能会错过一些线索。</span>
<span class="err">这时可能需要暂停</span><span class="n">top</span><span class="err">命令刷新，</span>
<span class="err">来记录和比对数据。</span>

<span class="err">总结</span>

<span class="err">排查</span><span class="n">Linux</span><span class="err">服务器性能问题还有很多工具，上面介绍的一些命令，可以帮助我们快速的定位问题。</span>
<span class="err">例如前面的示例输出，多个证据证明</span>
<span class="err">有</span><span class="n">JAVA</span><span class="err">进程占用了大量</span><span class="n">CPU</span><span class="err">资源，之后的性能调优就可以针对应用程序进行。</span>
</pre></div>


<h2 id="ntpdate">ntpdate同步时间</h2>
<div class="codehilite"><pre><span></span><span class="n">cp</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">share</span><span class="o">/</span><span class="n">zoneinfo</span><span class="o">/</span><span class="n">Asia</span><span class="o">/</span><span class="n">Shanghai</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="k">localtime</span>
<span class="mi">0</span> <span class="o">*/</span><span class="mi">1</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">ntpdate</span> <span class="mi">202</span><span class="p">.</span><span class="mi">120</span><span class="p">.</span><span class="mi">2</span><span class="p">.</span><span class="mi">101</span> <span class="o">&gt;/</span><span class="n">dev</span><span class="o">/</span><span class="k">null</span> 
<span class="mi">0</span> <span class="o">*/</span><span class="mi">1</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">ntpdate</span> <span class="mi">202</span><span class="p">.</span><span class="mi">120</span><span class="p">.</span><span class="mi">2</span><span class="p">.</span><span class="mi">101</span> <span class="o">&gt;/</span><span class="n">dev</span><span class="o">/</span><span class="k">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>

<span class="n">ntpdate</span>  <span class="mi">202</span><span class="p">.</span><span class="mi">120</span><span class="p">.</span><span class="mi">2</span><span class="p">.</span><span class="mi">101</span>
<span class="n">ntpdate</span>  <span class="n">s2m</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">edu</span><span class="p">.</span><span class="n">cn</span>

<span class="err">阿里云</span> 
<span class="n">Unix</span><span class="err">类系统：</span><span class="n">time1</span><span class="o">-</span><span class="mi">7</span><span class="p">.</span><span class="n">aliyun</span><span class="p">.</span><span class="n">com</span>
<span class="n">Windows</span><span class="err">：</span>  <span class="n">time</span><span class="p">.</span><span class="n">pool</span><span class="p">.</span><span class="n">aliyun</span><span class="p">.</span><span class="n">com</span>
<span class="n">ntp2</span><span class="p">.</span><span class="n">aliyun</span><span class="p">.</span><span class="n">com</span>

<span class="n">echo</span> <span class="ss">&quot;*/10 * * * * /usr/sbin/ntpdate pool.ntp.org </span>
<span class="ss">&gt;/dev/null 2&gt;&amp;1&quot;</span> <span class="o">&gt;&gt;/</span><span class="n">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">cron</span><span class="o">/</span><span class="n">root</span>

<span class="n">clock</span> <span class="o">-</span><span class="n">w</span>

<span class="err">则第一个</span><span class="n">crontab</span><span class="p">,</span><span class="err">执行失败，都不会有邮件发出，</span>
<span class="err">而第二个</span><span class="n">crontab</span><span class="p">,</span><span class="err">如执行失败，会在</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">mail</span><span class="err">目录或</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">spool</span><span class="o">/</span><span class="n">clientmqueue</span><span class="err">目录下生成大量的错误输出提示邮件。</span>
</pre></div>


<h2 id="wget">wget</h2>
<div class="codehilite"><pre><span></span># <span class="nv">wget</span> <span class="o">-</span><span class="nv">r</span> <span class="o">-</span><span class="nv">p</span> <span class="o">-</span><span class="nv">np</span> <span class="o">-</span><span class="nv">k</span> <span class="nv">http</span>:<span class="o">//</span><span class="nv">xxx</span>.<span class="nv">edu</span>.<span class="nv">cn</span>

<span class="o">-</span><span class="nv">r</span> 表示递归下载,会下载所有的链接,不过要注意的是,不要单独使用这个参数,因为如果你要
下载的网站也有别的网站的链接,
<span class="nv">wget</span>也会把别的网站的东西下载下来,所以要加上<span class="o">-</span><span class="nv">np</span>这个参数,表示不下载别的站点的链接.
<span class="o">-</span><span class="nv">np</span> 表示不下载别的站点的链接.
<span class="o">-</span><span class="nv">k</span> 表示将下载的网页里的链接修改为本地链接.
<span class="o">-</span><span class="nv">p</span> 获得所有显示网页所需的元素,比如图片什么的.

<span class="o">-</span><span class="nv">E</span>  或 <span class="o">--</span><span class="nv">html</span><span class="o">-</span><span class="nv">extension</span>   将保存的<span class="nv">URL</span>的文件后缀名设定为“.<span class="nv">html</span>”

<span class="o">+++++++++++++++++++++++++++++++++++++++</span>
# <span class="nv">wget</span> <span class="o">-</span><span class="nv">c</span> <span class="o">-</span><span class="nv">t</span> <span class="mi">0</span> <span class="o">-</span><span class="nv">O</span> <span class="nv">rhel6_x86_64</span>.<span class="nv">iso</span> <span class="nv">http</span>:<span class="o">//</span><span class="nv">zs</span>.<span class="nv">kan115</span>.<span class="nv">com</span>:<span class="mi">8080</span><span class="o">/</span><span class="nv">rhel6_x86_64</span>.<span class="nv">iso</span>

<span class="o">-</span><span class="nv">c</span> 断点续传
<span class="o">-</span><span class="nv">t</span> <span class="mi">0</span> 反复尝试的次数，<span class="mi">0</span>为不限次数
<span class="o">-</span><span class="nv">O</span> <span class="nv">rhel6_x86_64</span>.<span class="nv">iso</span> 把下载的文件命名为<span class="nv">rhel6_x86_64</span>.<span class="nv">iso</span>
<span class="nv">http</span>:<span class="o">//</span><span class="nv">zs</span>.<span class="nv">kan115</span>.<span class="nv">com</span>:<span class="mi">8080</span><span class="o">/</span><span class="nv">rhel6_x86_64</span>.<span class="nv">iso</span> 要下载的文件的网址

附：<span class="nv">wget</span>高级用法

<span class="nv">wget</span>的一些高级用法，比如另存为，后台下载，断点下载。批量下载。
增加下载尝试次数和测试下载链接是否生效。
记录下载日志，下载和排除指定类型文 件。

<span class="mi">1</span>、下载单个文件
<span class="nv">wget</span> <span class="nv">url</span><span class="o">+</span><span class="nv">filename</span>

下载过程中同时可以看到四项信息
已经下载的比例
已经下载的大小
当前下载的速度
剩余的时间

<span class="mi">2</span>、使用一个大写<span class="nv">O</span>做参数表示另存为
<span class="nv">wget</span> <span class="o">-</span><span class="nv">O</span> <span class="nv">save_name</span> <span class="nv">url</span>

这种方法适用于对应链接中没有显式文件名的情况。

例如： <span class="nv">wget</span> <span class="o">-</span><span class="nv">O</span> <span class="nv">xx</span>.<span class="nv">zip</span> <span class="nv">http</span>:<span class="o">//</span><span class="nv">www</span>.<span class="nv">vim</span>.<span class="nv">org</span><span class="o">/</span><span class="nv">scripts</span><span class="o">/</span><span class="nv">download_script</span>.<span class="nv">php</span>?<span class="nv">src_id</span><span class="o">=</span><span class="mi">7701</span>

再用不带<span class="o">-</span><span class="nv">O</span>参数的下载一次。

<span class="nv">ls</span> <span class="o">-</span><span class="nv">al</span>
总计 <span class="mi">132</span>
<span class="nv">drwxr</span><span class="o">-</span><span class="nv">xr</span><span class="o">-</span><span class="nv">x</span> <span class="mi">2</span> <span class="nv">root</span> <span class="nv">root</span>  <span class="mi">4096</span> <span class="mi">07</span><span class="o">-</span><span class="mi">12</span> <span class="mi">10</span>:<span class="mi">43</span> .
<span class="nv">drwxr</span><span class="o">-</span><span class="nv">xr</span><span class="o">-</span><span class="nv">x</span> <span class="mi">4</span> <span class="nv">root</span> <span class="nv">root</span>  <span class="mi">4096</span> <span class="mi">07</span><span class="o">-</span><span class="mi">11</span> <span class="mi">16</span>:<span class="mi">26</span> ..
<span class="o">-</span><span class="nv">rw</span><span class="o">-</span><span class="nv">r</span><span class="o">--</span><span class="nv">r</span><span class="o">--</span> <span class="mi">1</span> <span class="nv">root</span> <span class="nv">root</span> <span class="mi">50243</span> <span class="mi">07</span><span class="o">-</span><span class="mi">12</span> <span class="mi">10</span>:<span class="mi">43</span> <span class="nv">download_script</span>.<span class="nv">php</span>?<span class="nv">src_id</span><span class="o">=</span><span class="mi">7701</span>
<span class="o">-</span><span class="nv">rw</span><span class="o">-</span><span class="nv">r</span><span class="o">--</span><span class="nv">r</span><span class="o">--</span> <span class="mi">1</span> <span class="nv">root</span> <span class="nv">root</span> <span class="mi">50243</span> <span class="mi">07</span><span class="o">-</span><span class="mi">12</span> <span class="mi">10</span>:<span class="mi">43</span> <span class="nv">xx</span>.<span class="nv">zip</span>

我们发现，下载的大小都是一样。但是不带<span class="o">-</span><span class="nv">O</span>参数的，文件名还要转换一次。不如用<span class="o">-</span><span class="nv">O</span>参数方便。

<span class="nv">mv</span> <span class="s2">&quot;</span><span class="s">download_script.php?src_id=7701</span><span class="s2">&quot;</span> <span class="nv">yy</span>.<span class="nv">zip</span>

<span class="mi">3</span>、指定下载速率
方法是使用<span class="nv">wget</span> <span class="o">--</span><span class="nv">limit</span><span class="o">-</span><span class="nv">rate</span>

<span class="nv">wget</span>程序默认是使用所有的带宽，如果
是在生产服务器上下载很大的文件就不可接受了。
为了避免这种情况使用<span class="o">--</span><span class="nv">limit</span><span class="o">-</span><span class="nv">rate</span>参数
<span class="nv">wget</span> <span class="o">--</span><span class="nv">limit</span><span class="o">-</span><span class="nv">rate</span><span class="o">=</span><span class="mi">200</span><span class="nv">k</span> <span class="nv">http</span>:<span class="o">//</span><span class="nv">www</span>.<span class="nv">openss7</span>.<span class="nv">org</span><span class="o">/</span><span class="nv">repos</span><span class="o">/</span><span class="nv">tarballs</span><span class="o">/</span><span class="nv">strx25</span><span class="o">-</span><span class="mi">0</span>.<span class="mi">9</span>.<span class="mi">2</span>.<span class="mi">1</span>.<span class="nv">tar</span>.<span class="nv">bz2</span>

<span class="mi">4</span>、断点下载
使用<span class="nv">wget</span> <span class="o">-</span><span class="nv">c</span>完成未完成的下载

下载到一半需要停下来干别的事情，用<span class="o">^</span><span class="nv">c</span>就可以停顿住。
回来后，继续下载可以加一个<span class="o">-</span><span class="nv">c</span>参数。
注意：如果不加入<span class="o">-</span><span class="nv">c</span>，那么下载的文件会多出一个.<span class="mi">1</span>的后缀。

<span class="mi">5</span>、在后台下载
方法：加一个<span class="o">-</span><span class="nv">b</span>的参数

<span class="nv">wget</span> <span class="o">-</span><span class="nv">b</span> <span class="nv">url</span><span class="o">/</span><span class="nv">filename</span>
为后台下载。下载经过写入到<span class="nv">wget</span><span class="o">-</span><span class="nv">log</span>文件中。

用<span class="nv">tail</span> <span class="o">-</span><span class="nv">f</span> <span class="nv">wget</span><span class="o">-</span><span class="nv">log</span>查看下载日志

<span class="mi">6</span>、模拟在浏览器下下载
有的网站不允许客户在非浏览器环境下下载。使用<span class="o">--</span><span class="nv">user</span><span class="o">-</span><span class="nv">agent</span>来设置
<span class="nv">wget</span> <span class="o">--</span><span class="nv">user</span><span class="o">-</span><span class="nv">agent</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.3) </span>
<span class="nv">Gecko</span><span class="o">/</span><span class="mi">2008092416</span> <span class="nv">Firefox</span><span class="o">/</span><span class="mi">3</span>.<span class="mi">0</span>.<span class="mi">3</span><span class="s2">&quot;</span><span class="s"> URL-TO-DOWNLOAD</span>

<span class="mi">7</span>、测试下载链接
方法:使用<span class="o">--</span><span class="nv">spider</span>
试图做计划下载时候，需要先检查一下下载链接是否有效。
<span class="nv">wget</span> <span class="o">--</span><span class="nv">spider</span> <span class="nv">DOWNLOAD</span><span class="o">-</span><span class="nv">URL</span>
如果返回<span class="nv">OK</span>，则表示下载链接是正确的！

例如：
<span class="nv">wget</span> <span class="o">--</span><span class="nv">spider</span> <span class="s2">&quot;</span><span class="s">http://ip138.com/ips.asp?ip=58.251.193.137&amp;action=2</span><span class="s2">&quot;</span>
<span class="nv">Spider</span> <span class="nv">mode</span> <span class="nv">enabled</span>. <span class="nv">Check</span> <span class="k">if</span> <span class="nv">remote</span> <span class="nv">file</span> <span class="nv">exists</span>.
<span class="o">--</span><span class="mi">2010</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">12</span> <span class="mi">11</span>:<span class="mi">36</span>:<span class="mi">32</span><span class="o">--</span>  <span class="nv">http</span>:<span class="o">//</span><span class="nv">ip138</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">ips</span>.<span class="nv">asp</span>?<span class="nv">ip</span><span class="o">=</span><span class="mi">58</span>.<span class="mi">251</span>.<span class="mi">193</span>.<span class="mi">137</span><span class="o">&amp;</span><span class="nv">action</span><span class="o">=</span><span class="mi">2</span>
正在解析主机 <span class="nv">ip138</span>.<span class="nv">com</span>... <span class="mi">221</span>.<span class="mi">5</span>.<span class="mi">47</span>.<span class="mi">136</span>
<span class="nv">Connecting</span> <span class="nv">to</span> <span class="nv">ip138</span>.<span class="nv">com</span><span class="o">|</span><span class="mi">221</span>.<span class="mi">5</span>.<span class="mi">47</span>.<span class="mi">136</span><span class="o">|</span>:<span class="mi">80</span>... 已连接。
已发出 <span class="nv">HTTP</span> 请求，正在等待回应... <span class="mi">200</span> <span class="nv">OK</span>
长度：<span class="mi">7817</span> <span class="ss">(</span><span class="mi">7</span>.<span class="mi">6</span><span class="nv">K</span><span class="ss">)</span> [<span class="nv">text</span><span class="o">/</span><span class="nv">html</span>]
<span class="nv">Remote</span> <span class="nv">file</span> <span class="nv">exists</span> <span class="nv">and</span> <span class="nv">could</span> <span class="nv">contain</span> <span class="nv">further</span> <span class="nv">links</span>,
<span class="nv">but</span> <span class="nv">recursion</span> <span class="nv">is</span> <span class="nv">disabled</span> <span class="o">--</span> <span class="nv">not</span> <span class="nv">retrieving</span>.

<span class="mi">8</span>、增加尝试次数
方法：<span class="o">--</span><span class="nv">tries</span><span class="o">=</span><span class="mi">1000</span>
如果网速有问题，下载大文件的时候可能会发生错误，
默认<span class="nv">wget</span>尝试<span class="mi">20</span>次链接。

如果尝试<span class="mi">75</span>次，可以
<span class="nv">wget</span> <span class="o">--</span><span class="nv">tires</span><span class="o">=</span><span class="mi">75</span> <span class="nv">DOWNLOAD</span><span class="o">-</span><span class="nv">URL</span>

<span class="mi">9</span>、下载多个文件使用<span class="nv">wget</span> <span class="o">-</span><span class="nv">i</span>
将多个下载链接写入到一个<span class="nv">download</span><span class="o">-</span><span class="nv">file</span><span class="o">-</span><span class="nv">list</span>.<span class="nv">txt</span>文件中，而后用：
<span class="nv">wget</span> <span class="o">-</span><span class="nv">i</span> <span class="nv">download</span><span class="o">-</span><span class="nv">file</span><span class="o">-</span><span class="nv">list</span>.<span class="nv">txt</span>

<span class="mi">10</span>、下载整站
方法：用<span class="o">--</span><span class="nv">mirror</span>参数

当你要下载一个完整站点并实现本地浏览的时候，
<span class="nv">wget</span> <span class="o">--</span><span class="nv">mirror</span> <span class="o">-</span><span class="nv">p</span> <span class="o">--</span><span class="nv">convert</span><span class="o">-</span><span class="nv">links</span> <span class="o">-</span><span class="nv">P</span> .<span class="o">/</span><span class="nv">LOCAL</span><span class="o">-</span><span class="nv">DIR</span> <span class="nv">WEBSITE</span><span class="o">-</span><span class="nv">URL</span>

参数讲解：
<span class="o">--</span><span class="nv">mirror</span>：设置这个参数用来建立本地镜像
<span class="o">-</span><span class="nv">p</span>：下载所有<span class="nv">html</span>文件适合显示的元素
<span class="o">--</span><span class="nv">convert</span><span class="o">-</span><span class="nv">links</span>：下载完成后，将文档链接都转换成本地的
<span class="o">-</span><span class="nv">P</span> .<span class="o">/</span><span class="nv">LOCAL</span><span class="o">-</span><span class="nv">DIR</span>：保存所有的文件和目录到指定文件夹下

<span class="mi">11</span>、下载时候禁止下载指定类型的文件
例如下载站点时候，不打算下载<span class="nv">gif</span>动画图片。
<span class="nv">wget</span> <span class="o">--</span><span class="nv">reject</span><span class="o">=</span><span class="nv">gif</span> <span class="nv">WEBSITE</span><span class="o">-</span><span class="nv">TO</span><span class="o">-</span><span class="nv">BE</span><span class="o">-</span><span class="nv">DOWNLOADED</span>

<span class="mi">12</span>、记录下载日志
方法：使用小写字母<span class="nv">o</span>
<span class="nv">wget</span> <span class="o">-</span><span class="nv">o</span> <span class="nv">xx</span>.<span class="nv">html</span>.<span class="nv">log</span> <span class="o">-</span><span class="nv">O</span> <span class="nv">xx</span>.<span class="nv">html</span> <span class="s2">&quot;</span><span class="s">http://ip138.com/ips.asp?ip=58.251.193.137&amp;</span>
<span class="nv">action</span><span class="o">=</span><span class="mi">2</span><span class="s2">&quot;</span>

检查一下日志：
[<span class="nv">root</span>@<span class="nv">localhost</span> <span class="nv">opt</span>]# <span class="nv">cat</span> <span class="nv">xx</span>.<span class="nv">html</span>.<span class="nv">log</span>
<span class="o">--</span><span class="mi">2010</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">12</span> <span class="mi">11</span>:<span class="mi">57</span>:<span class="mi">22</span><span class="o">--</span>  <span class="nv">http</span>:<span class="o">//</span><span class="nv">ip138</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">ips</span>.<span class="nv">asp</span>?<span class="nv">ip</span><span class="o">=</span><span class="mi">58</span>.<span class="mi">251</span>.<span class="mi">193</span>.<span class="mi">137</span><span class="o">&amp;</span><span class="nv">action</span><span class="o">=</span><span class="mi">2</span>
正在解析主机 <span class="nv">ip138</span>.<span class="nv">com</span>... <span class="mi">221</span>.<span class="mi">5</span>.<span class="mi">47</span>.<span class="mi">136</span>
<span class="nv">Connecting</span> <span class="nv">to</span> <span class="nv">ip138</span>.<span class="nv">com</span><span class="o">|</span><span class="mi">221</span>.<span class="mi">5</span>.<span class="mi">47</span>.<span class="mi">136</span><span class="o">|</span>:<span class="mi">80</span>... 已连接。
已发出 <span class="nv">HTTP</span> 请求，正在等待回应... <span class="mi">200</span> <span class="nv">OK</span>
长度：<span class="mi">7817</span> <span class="ss">(</span><span class="mi">7</span>.<span class="mi">6</span><span class="nv">K</span><span class="ss">)</span> [<span class="nv">text</span><span class="o">/</span><span class="nv">html</span>]
<span class="nv">Saving</span> <span class="nv">to</span>: `<span class="nv">xx</span>.<span class="nv">html</span><span class="s1">&#39;</span>
     <span class="mi">0</span><span class="nv">K</span> .......        <span class="mi">100</span><span class="o">%</span> <span class="mi">65</span>.<span class="mi">5</span><span class="nv">K</span><span class="o">=</span><span class="mi">0</span>.<span class="mi">1</span><span class="nv">s</span>
<span class="mi">2010</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">12</span> <span class="mi">11</span>:<span class="mi">57</span>:<span class="mi">22</span> <span class="ss">(</span><span class="mi">65</span>.<span class="mi">5</span> <span class="nv">KB</span><span class="o">/</span><span class="nv">s</span><span class="ss">)</span> <span class="o">-</span> `<span class="nv">xx</span>.<span class="nv">html</span><span class="s1">&#39;</span><span class="s"> saved [7817/7817]</span>

<span class="mi">13</span>、是第<span class="mi">9</span>条的增强版。可以限制下载容量
<span class="nv">wget</span> <span class="o">-</span><span class="nv">Q5m</span> <span class="o">-</span><span class="nv">i</span> <span class="nv">FILE</span><span class="o">-</span><span class="nv">WHICH</span><span class="o">-</span><span class="nv">HAS</span><span class="o">-</span><span class="nv">URLS</span>

当下载的文件达到<span class="mi">5</span>兆的时候，停止下载。
注意：如果不是对一个文件下载链接清单，对单个文件，
这个限制不会生效的。

<span class="mi">14</span>、和第<span class="mi">11</span>条正好相反，
这条技巧是讲述如何仅仅下载指定类型的文件

从一个网站中下载所有的<span class="nv">pdf</span>文件：
<span class="nv">wget</span> <span class="o">-</span><span class="nv">r</span> <span class="o">-</span><span class="nv">A</span>.<span class="nv">pdf</span> <span class="nv">http</span>:<span class="o">//</span><span class="nv">url</span><span class="o">-</span><span class="nv">to</span><span class="o">-</span><span class="nv">webpage</span><span class="o">-</span><span class="nv">with</span><span class="o">-</span><span class="nv">pdfs</span><span class="o">/</span>

<span class="mi">15</span>、使用<span class="nv">wget</span>完成<span class="nv">ftp</span>下 载
匿名<span class="nv">ftp</span>下载类似于<span class="nv">http</span>下载：
<span class="nv">wget</span> <span class="nv">ftp</span><span class="o">-</span><span class="nv">url</span>即可。

如果是需要输入用户名和密码，则是：
<span class="nv">wget</span> <span class="o">--</span><span class="nv">ftp</span><span class="o">-</span><span class="nv">user</span><span class="o">=</span><span class="nv">USERNAME</span> <span class="o">--</span><span class="nv">ftp</span><span class="o">-</span><span class="nv">password</span><span class="o">=</span><span class="nv">PASSWORD</span> <span class="nv">DOWNLOAD</span><span class="o">-</span><span class="nv">URL</span>
</pre></div>


<h2 id="chattr">chattr</h2>
<div class="codehilite"><pre><span></span><span class="n">lsattr</span><span class="w"> </span><span class="n">命令是显示chattr命令设置的文件属性</span><span class="w"></span>

<span class="n">chattr</span><span class="w"> </span><span class="o">[</span><span class="n"> -RVf </span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n"> -v version </span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n"> mode </span><span class="o">]</span><span class="w"> </span><span class="n">files</span><span class="err">…</span><span class="w"></span>
<span class="n">最关键的是在</span><span class="o">[</span><span class="n">mode</span><span class="o">]</span><span class="n">部分</span><span class="err">，</span><span class="o">[</span><span class="n">mode</span><span class="o">]</span><span class="n">部分是由</span><span class="o">+-=</span><span class="n">和</span><span class="o">[</span><span class="n">ASacDdIijsTtu</span><span class="o">]</span><span class="n">这些字符组合的</span><span class="err">，</span><span class="n">这部分是</span><span class="w"></span>
<span class="n">用来控制文件的</span><span class="w"></span>
<span class="n">属性</span><span class="err">。</span><span class="w"></span>

<span class="o">+</span><span class="w"> </span><span class="err">：</span><span class="n">在原有参数设定基础上</span><span class="err">，</span><span class="n">追加参数</span><span class="err">。</span><span class="w"></span>
<span class="o">-</span><span class="w"> </span><span class="err">：</span><span class="n">在原有参数设定基础上</span><span class="err">，</span><span class="n">移除参数</span><span class="err">。</span><span class="w"></span>
<span class="o">=</span><span class="w"> </span><span class="err">：</span><span class="n">更新为指定参数设定</span><span class="err">。</span><span class="w"></span>
<span class="n">A</span><span class="err">：</span><span class="n">文件或目录的</span><span class="w"> </span><span class="n">atime</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="w"> </span><span class="nc">time</span><span class="p">)</span><span class="n">不可被修改</span><span class="p">(</span><span class="n">modified</span><span class="p">),</span><span class="w"> </span><span class="n">可以有效预防例如手提电脑磁</span><span class="w"></span>
<span class="n">盘I</span><span class="o">/</span><span class="n">O错误的发生</span><span class="err">。</span><span class="w"></span>
<span class="n">S</span><span class="err">：</span><span class="n">硬盘I</span><span class="o">/</span><span class="n">O同步选项</span><span class="err">，</span><span class="n">功能类似sync</span><span class="err">。</span><span class="w"></span>
<span class="n">a</span><span class="err">：</span><span class="n">即append</span><span class="err">，</span><span class="n">设定该参数后</span><span class="err">，</span><span class="n">只能向文件中添加数据</span><span class="err">，</span><span class="n">而不能删除</span><span class="err">，</span><span class="n">多用于服务器日志文件</span><span class="w"></span>
<span class="n">安全</span><span class="err">，</span><span class="n">只有root才能设定这个属性</span><span class="err">。</span><span class="w"></span>
<span class="n">c</span><span class="err">：</span><span class="n">即compresse</span><span class="err">，</span><span class="n">设定文件是否经压缩后再存储</span><span class="err">。</span><span class="n">读取时需要经过自动解压操作</span><span class="err">。</span><span class="w"></span>
<span class="n">d</span><span class="err">：</span><span class="n">即no</span><span class="w"> </span><span class="k">dump</span><span class="err">，</span><span class="n">设定文件不能成为dump程序的备份目标</span><span class="err">。</span><span class="w"></span>
<span class="n">i</span><span class="err">：</span><span class="n">设定文件不能被删除</span><span class="err">、</span><span class="n">改名</span><span class="err">、</span><span class="n">设定链接关系</span><span class="err">，</span><span class="n">同时不能写入或新增内容</span><span class="err">。</span><span class="n">i参数对于文件</span><span class="w"> </span>
<span class="n">系统的安全设置有很大帮助</span><span class="err">。</span><span class="w"></span>
<span class="n">j</span><span class="err">：</span><span class="n">即journal</span><span class="err">，</span><span class="n">设定此参数使得当通过mount参数</span><span class="err">：</span><span class="k">data</span><span class="o">=</span><span class="n">ordered</span><span class="w"> </span><span class="n">或者</span><span class="w"> </span><span class="k">data</span><span class="o">=</span><span class="n">writeback</span><span class="w"> </span>
<span class="n">挂</span><span class="w"> </span><span class="n">载的文件系统</span><span class="err">，</span><span class="w"></span>
<span class="n">文件在写入时会先被记录</span><span class="p">(</span><span class="n">在journal中</span><span class="p">)</span><span class="err">。</span><span class="n">如果filesystem被设定参数为</span><span class="w"> </span><span class="k">data</span><span class="o">=</span><span class="n">journal</span><span class="err">，</span><span class="w"></span>
<span class="n">则该参数自动失效</span><span class="err">。</span><span class="w"></span>
<span class="n">s</span><span class="err">：</span><span class="n">保密性地删除文件或目录</span><span class="err">，</span><span class="n">即硬盘空间被全部收回</span><span class="err">。</span><span class="w"></span>
<span class="n">u</span><span class="err">：</span><span class="n">与s相反</span><span class="err">，</span><span class="n">当设定为u时</span><span class="err">，</span><span class="n">数据内容其实还存在磁盘中</span><span class="err">，</span><span class="n">可以用于undeletion</span><span class="err">。</span><span class="w"></span>
<span class="n">各参数选项中常用到的是a和i</span><span class="err">。</span><span class="n">a选项强制只可添加不可删除</span><span class="err">，</span><span class="n">多用于日志系统的安全设定</span><span class="err">。</span><span class="w"></span>
<span class="n">而i是更为严格的安全设定</span><span class="err">，</span><span class="w"></span>
<span class="n">只有superuser</span><span class="w"> </span><span class="p">(</span><span class="n">root</span><span class="p">)</span><span class="w"> </span><span class="n">或具有CAP_LINUX_IMMUTABLE处理能力</span><span class="err">（</span><span class="n">标识</span><span class="err">）</span><span class="n">的进程能够施加该选项</span><span class="err">。</span><span class="w"></span>
</pre></div>


<h2 id="iperf">iperf</h2>
<div class="codehilite"><pre><span></span><span class="mi">1</span><span class="err">、</span><span class="n">UDP</span> <span class="err">模式</span>
<span class="err">服务器端</span>
<span class="n">iperf</span> <span class="o">-</span><span class="n">u</span> <span class="o">-</span><span class="n">s</span>
<span class="err">客户端</span>
<span class="n">iperf</span> <span class="o">-</span><span class="n">u</span> <span class="o">-</span><span class="k">c</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">1</span> <span class="o">-</span><span class="n">b</span> <span class="mi">100</span><span class="n">M</span> <span class="o">-</span><span class="n">t</span> <span class="mi">60</span>
<span class="err">在</span><span class="n">udp</span><span class="err">模式下，以</span><span class="mi">100</span><span class="n">Mbps</span><span class="err">为数据发送速率，客户端到服务器</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">1</span><span class="err">上传带宽测试，测试时间为</span><span class="mi">60</span><span class="err">秒。</span>
<span class="n">iperf</span> <span class="o">-</span><span class="n">u</span> <span class="o">-</span><span class="k">c</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">1</span> <span class="o">-</span><span class="n">b</span> <span class="mi">5</span><span class="n">M</span> <span class="o">-</span><span class="n">P</span> <span class="mi">30</span> <span class="o">-</span><span class="n">t</span> <span class="mi">60</span>
<span class="err">客户端同时向服务器端发起</span><span class="mi">30</span><span class="err">个连接线程，以</span><span class="mi">5</span><span class="n">Mbps</span><span class="err">为数据发送速率。</span>
<span class="n">iperf</span> <span class="o">-</span><span class="n">u</span> <span class="o">-</span><span class="k">c</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">1</span> <span class="o">-</span><span class="n">b</span> <span class="mi">100</span><span class="n">M</span> <span class="o">-</span><span class="n">d</span> <span class="o">-</span><span class="n">t</span> <span class="mi">60</span>
<span class="err">以</span><span class="mi">100</span><span class="n">M</span><span class="err">为数据发送速率，进行上下行带宽测试。</span>


<span class="mi">2</span><span class="err">、</span><span class="n">TCP</span><span class="err">模式</span>
<span class="err">服务器端</span>
<span class="n">iperf</span> <span class="o">-</span><span class="n">s</span>
<span class="err">客户端</span>
<span class="n">iperf</span> <span class="o">-</span><span class="k">c</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">1</span> <span class="o">-</span><span class="n">t</span> <span class="mi">60</span>
<span class="err">在</span><span class="n">tcp</span><span class="err">模式下，客户端到服务器</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">1</span><span class="err">上传带宽测试，测试时间为</span><span class="mi">60</span><span class="err">秒。</span>
<span class="n">iperf</span> <span class="o">-</span><span class="k">c</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">1</span>  <span class="o">-</span><span class="n">P</span> <span class="mi">30</span> <span class="o">-</span><span class="n">t</span> <span class="mi">60</span>
<span class="err">客户端同时向服务器端发起</span><span class="mi">30</span><span class="err">个连接线程。</span>
<span class="n">iperf</span> <span class="o">-</span><span class="k">c</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">1</span>  <span class="o">-</span><span class="n">d</span> <span class="o">-</span><span class="n">t</span> <span class="mi">60</span>
<span class="err">进行上下行带宽测试。</span>

<span class="err">另外，</span>
<span class="o">-</span><span class="n">p</span> <span class="err">监听或者连接的端口号</span>
<span class="o">-</span><span class="n">w</span> <span class="n">tcp</span><span class="err">滑动窗口的大小</span>
</pre></div>


<h2 id="ethtool">ethtool</h2>
<div class="codehilite"><pre><span></span><span class="n">ethtool</span> <span class="o">-</span><span class="n">p</span> <span class="n">eth1</span> <span class="n">N</span>
<span class="err">执行后，对应的网卡的灯会闪，用于区别不同</span><span class="n">ethX</span><span class="err">对应网卡的物理位置，常用的方法是使</span>
<span class="err">网卡</span><span class="n">port</span><span class="err">上的</span><span class="n">led</span><span class="err">不断的闪；</span>
<span class="n">N</span><span class="err">指示了网卡闪的持续时间，以秒为单位</span>
</pre></div>


<h2 id="ps">ps</h2>
<div class="codehilite"><pre><span></span><span class="n">ps</span> <span class="o">-</span><span class="n">eo</span> <span class="n">pid</span><span class="p">,</span><span class="n">comm</span><span class="p">,</span><span class="n">lstart</span> 
<span class="err">输出</span><span class="n">pid</span><span class="err">，命令，启动时间</span>

<span class="o">-</span><span class="k">C</span><span class="o">&lt;</span><span class="err">指令名称</span><span class="o">&gt;</span><span class="err">：指定执行指令的名称，并列出该指令的程序的状况。</span>
<span class="o">-</span><span class="n">H</span><span class="err">：显示树状结构，表示程序间的相互关系。</span>
</pre></div>


<h2 id="ss">ss</h2>
<div class="codehilite"><pre><span></span><span class="err">显示</span><span class="n">TCP</span><span class="err">连接</span>                                <span class="n">ss</span> <span class="o">-</span><span class="n">t</span> <span class="o">-</span><span class="n">a</span>
<span class="err">显示</span><span class="n">TCP</span><span class="err">连接</span>                                <span class="n">ss</span> <span class="o">-</span><span class="n">u</span> <span class="o">-</span><span class="n">a</span>
<span class="err">显示</span> <span class="n">Sockets</span> <span class="err">摘要</span>                        <span class="n">ss</span> <span class="o">-</span><span class="n">s</span>
<span class="err">列出所有打开的网络连接端口</span>      <span class="n">ss</span> <span class="o">-</span><span class="n">l</span>
<span class="err">查看进程使用的</span><span class="n">socket</span>                  <span class="n">ss</span> <span class="o">-</span><span class="n">pl</span>

<span class="o">-</span><span class="n">h</span><span class="err">：显示帮助信息；</span> 
<span class="o">-</span><span class="n">V</span><span class="err">：显示指令版本信息；</span> 
<span class="o">-</span><span class="n">n</span><span class="err">：不解析服务名称，以数字方式显示；</span> 
<span class="o">-</span><span class="n">a</span><span class="err">：显示所有的套接字；</span> 
<span class="o">-</span><span class="n">l</span><span class="err">：显示处于监听状态的套接字；</span> 
<span class="o">-</span><span class="n">o</span><span class="err">：显示计时器信息；</span> 
<span class="o">-</span><span class="n">m</span><span class="err">：显示套接字的内存使用情况；</span> 
<span class="o">-</span><span class="n">p</span><span class="err">：显示使用套接字的进程信息；</span> 
<span class="o">-</span><span class="n">i</span><span class="err">：显示内部的</span><span class="n">TCP</span><span class="err">信息；</span> 
<span class="o">-</span><span class="mi">4</span><span class="err">：只显示</span><span class="n">ipv4</span><span class="err">的套接字；</span> 
<span class="o">-</span><span class="mi">6</span><span class="err">：只显示</span><span class="n">ipv6</span><span class="err">的套接字；</span> 
<span class="o">-</span><span class="n">t</span><span class="err">：只显示</span><span class="n">tcp</span><span class="err">套接字；</span> 
<span class="o">-</span><span class="n">u</span><span class="err">：只显示</span><span class="n">udp</span><span class="err">套接字；</span> 
<span class="o">-</span><span class="n">d</span><span class="err">：只显示</span><span class="n">DCCP</span><span class="err">套接字；</span> 
<span class="o">-</span><span class="n">w</span><span class="err">：仅显示</span><span class="n">RAW</span><span class="err">套接字；</span> 
<span class="o">-</span><span class="n">x</span><span class="err">：仅显示</span><span class="n">UNIX</span><span class="err">域套接字。</span>
</pre></div>


<h2 id="iostat">iostat</h2>
<div class="codehilite"><pre><span></span><span class="n">yum</span> <span class="n">install</span> <span class="n">sysstat</span>

<span class="n">iostat</span> <span class="o">-</span><span class="n">x</span> <span class="mi">1</span>
<span class="n">Linux</span> <span class="mf">2.6.32</span><span class="o">-</span><span class="mf">504.</span><span class="n">el6</span><span class="p">.</span><span class="n">x86_64</span> <span class="p">(</span><span class="n">centos2</span><span class="p">)</span>     <span class="mi">12</span><span class="o">/</span><span class="mi">26</span><span class="o">/</span><span class="mi">2015</span>     <span class="n">_x86_64_</span>    <span class="p">(</span><span class="mi">1</span> <span class="n">CPU</span><span class="p">)</span>

<span class="n">avg</span><span class="o">-</span><span class="nl">cpu</span><span class="p">:</span>  <span class="nf">%user</span>   <span class="nf">%nice</span> <span class="nf">%system</span> <span class="nf">%iowait</span>  <span class="nf">%steal</span>   <span class="nf">%idle</span>
           <span class="mf">0.04</span>    <span class="mf">0.02</span>    <span class="mf">0.18</span>    <span class="mf">0.37</span>    <span class="mf">0.00</span>   <span class="mf">99.39</span>

<span class="nl">Device</span><span class="p">:</span>         <span class="n">rrqm</span><span class="o">/</span><span class="n">s</span>   <span class="n">wrqm</span><span class="o">/</span><span class="n">s</span>     <span class="n">r</span><span class="o">/</span><span class="n">s</span>     <span class="n">w</span><span class="o">/</span><span class="n">s</span>   <span class="n">rsec</span><span class="o">/</span><span class="n">s</span>   <span class="n">wsec</span><span class="o">/</span><span class="n">s</span> <span class="n">avgrq</span><span class="o">-</span><span class="n">sz</span> <span class="n">avgqu</span><span class="o">-</span><span class="n">sz</span>   <span class="n">await</span>  <span class="n">svctm</span>  <span class="nf">%util</span>
<span class="n">sda</span>               <span class="mf">0.27</span>     <span class="mf">1.42</span>    <span class="mf">1.01</span>    <span class="mf">0.17</span>    <span class="mf">38.07</span>    <span class="mf">12.73</span>    <span class="mf">43.18</span>     <span class="mf">0.01</span>   <span class="mf">10.81</span>   <span class="mf">3.73</span>   <span class="mf">0.44</span>
<span class="n">dm</span><span class="o">-</span><span class="mi">0</span>              <span class="mf">0.00</span>     <span class="mf">0.00</span>    <span class="mf">1.22</span>    <span class="mf">1.59</span>    <span class="mf">37.47</span>    <span class="mf">12.73</span>    <span class="mf">17.88</span>     <span class="mf">0.11</span>   <span class="mf">37.78</span>   <span class="mf">1.55</span>   <span class="mf">0.43</span>
<span class="n">dm</span><span class="o">-</span><span class="mi">1</span>              <span class="mf">0.00</span>     <span class="mf">0.00</span>    <span class="mf">0.02</span>    <span class="mf">0.00</span>     <span class="mf">0.18</span>     <span class="mf">0.00</span>     <span class="mf">8.00</span>     <span class="mf">0.00</span>    <span class="mf">6.62</span>   <span class="mf">3.45</span>   <span class="mf">0.01</span>

<span class="err">第二行是系统信息和监测时间，</span>
<span class="err">第三行和第四行显示</span><span class="n">CPU</span><span class="err">使用情况（具体内容和</span><span class="n">mpstat</span><span class="err">命令相同）。</span>
<span class="n">Device</span>    <span class="err">监测设备名称</span> 
<span class="n">rrqm</span><span class="o">/</span><span class="n">s</span>    <span class="err">每秒需要读取需求的数量</span> 
<span class="n">wrqm</span><span class="o">/</span><span class="n">s</span>    <span class="err">每秒需要写入需求的数量</span> 
<span class="n">r</span><span class="o">/</span><span class="n">s</span>     <span class="err">每秒实际读取需求的数量</span> 
<span class="n">w</span><span class="o">/</span><span class="n">s</span>    <span class="err">每秒实际写入需求的数量</span> 
<span class="n">rsec</span><span class="o">/</span><span class="n">s</span>    <span class="err">每秒读取区段的数量</span> 
<span class="n">wsec</span><span class="o">/</span><span class="n">s</span>    <span class="err">每秒写入区段的数量</span> 
<span class="n">rkB</span><span class="o">/</span><span class="n">s</span>    <span class="err">每秒实际读取的大小，单位为</span><span class="n">KB</span> 
<span class="n">wkB</span><span class="o">/</span><span class="n">s</span>    <span class="err">每秒实际写入的大小，单位为</span><span class="n">KB</span> 
<span class="n">avgrq</span><span class="o">-</span><span class="n">sz</span>    <span class="err">需求的平均大小区段</span> 
<span class="n">avgqu</span><span class="o">-</span><span class="n">sz</span>    <span class="err">需求的平均队列长度</span> 
<span class="n">await</span>    <span class="err">等待</span><span class="n">I</span><span class="o">/</span><span class="n">O</span><span class="err">平均的时间（</span><span class="n">milliseconds</span><span class="err">）</span> 
<span class="n">svctm</span>    <span class="n">I</span><span class="o">/</span><span class="n">O</span><span class="err">需求完成的平均时间</span> 
<span class="nf">%util</span>    <span class="err">被</span><span class="n">I</span><span class="o">/</span><span class="n">O</span><span class="err">需求消耗的</span><span class="n">CPU</span><span class="err">百分</span>
</pre></div>


<h2 id="vmstat">vmstat</h2>
<div class="codehilite"><pre><span></span><span class="n">vmstat</span> <span class="err">运行</span><span class="mi">1</span><span class="err">秒间隔的示例：</span>

<span class="o">#</span> <span class="n">vmstat</span> <span class="mi">1</span>
<span class="n">procs</span> <span class="err">———–</span><span class="n">memory</span><span class="err">———</span><span class="o">-</span> <span class="err">—</span><span class="n">swap</span><span class="err">–</span> <span class="err">—–</span><span class="n">io</span><span class="err">—</span><span class="o">-</span> <span class="err">–</span><span class="k">system</span><span class="err">–</span> <span class="err">—</span><span class="o">-</span><span class="n">cpu</span><span class="err">—</span><span class="o">-</span>
<span class="n">r</span>  <span class="n">b</span>   <span class="n">swpd</span>   <span class="k">free</span>   <span class="n">buff</span>  <span class="k">cache</span>   <span class="n">si</span>   <span class="n">so</span>    <span class="n">bi</span>    <span class="n">bo</span>   <span class="k">in</span>    <span class="n">cs</span> <span class="n">us</span> <span class="n">sy</span> <span class="n">id</span> <span class="n">wa</span>
<span class="mi">0</span>  <span class="mi">0</span> <span class="mi">104300</span>  <span class="mi">16800</span>  <span class="mi">95328</span>  <span class="mi">72200</span>    <span class="mi">0</span>    <span class="mi">0</span>     <span class="mi">5</span>    <span class="mi">26</span>    <span class="mi">7</span>    <span class="mi">14</span>  <span class="mi">4</span>  <span class="mi">1</span> <span class="mi">95</span>  <span class="mi">0</span>
<span class="mi">0</span>  <span class="mi">0</span> <span class="mi">104300</span>  <span class="mi">16800</span>  <span class="mi">95328</span>  <span class="mi">72200</span>    <span class="mi">0</span>    <span class="mi">0</span>     <span class="mi">0</span>    <span class="mi">24</span> <span class="mi">1021</span>    <span class="mi">64</span>  <span class="mi">1</span>  <span class="mi">1</span> <span class="mi">98</span>  <span class="mi">0</span>
<span class="mi">0</span>  <span class="mi">0</span> <span class="mi">104300</span>  <span class="mi">16800</span>  <span class="mi">95328</span>  <span class="mi">72200</span>    <span class="mi">0</span>    <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span> <span class="mi">1009</span>    <span class="mi">59</span>  <span class="mi">1</span>  <span class="mi">1</span> <span class="mi">98</span>  <span class="mi">0</span>

<span class="n">r</span> <span class="err">当前运行队列中线程的数目</span><span class="p">.</span><span class="err">代表线程处于可运行状态</span><span class="p">,</span><span class="err">但</span><span class="n">CPU</span> <span class="err">还未能执行</span><span class="p">.</span>
<span class="n">b</span> <span class="err">当前进程阻塞并等待</span><span class="n">IO</span> <span class="err">请求完成的数目</span>
<span class="k">in</span> <span class="err">当前中断被处理的数目</span>
<span class="n">cs</span> <span class="err">当前</span><span class="n">kernel</span> <span class="k">system</span><span class="err">中</span><span class="p">,</span><span class="err">发生上下文切换的数目</span>
<span class="n">us</span> <span class="err">利用率的百分比</span>
<span class="n">sys</span><span class="err">内核和中断利用率的百分比</span>
<span class="n">wa</span><span class="err">所有可运行状态线程被阻塞在等待</span><span class="n">IO</span> <span class="err">请求的百分比</span>
<span class="n">idCPU</span> <span class="err">空闲时间的百分比</span> 
</pre></div>


<h2 id="cp">cp</h2>
<div class="codehilite"><pre><span></span><span class="o">-</span><span class="n">a</span><span class="err">：此参数的效果和同时指定</span><span class="ss">&quot;-dpR&quot;</span><span class="err">参数相同；</span> 
<span class="o">-</span><span class="n">d</span><span class="err">：当复制符号连接时，把目标文件或目录也建立为符号连接，并指向与源文件或目录连接的</span>
<span class="err">原始文件或目录；</span> 
<span class="o">-</span><span class="n">f</span><span class="err">：强行复制文件或目录，不论目标文件或目录是否已存在；</span> 
<span class="o">-</span><span class="n">i</span><span class="err">：覆盖既有文件之前先询问用户；</span> 
<span class="o">-</span><span class="n">l</span><span class="err">：对源文件建立硬连接，而非复制文件；</span> 
<span class="o">-</span><span class="n">p</span><span class="err">：保留源文件或目录的属性；</span> 
<span class="o">-</span><span class="n">R</span><span class="o">/</span><span class="n">r</span><span class="err">：递归处理，将指定目录下的所有文件与子目录一并处理；</span> 
<span class="o">-</span><span class="n">s</span><span class="err">：对源文件建立符号连接，而非复制文件；</span>
 <span class="o">-</span><span class="n">u</span><span class="err">：使用这项参数后只会在源文件的更改时间较目标文件更新时或是名称相互对应的目标文件并不存在时，才复制文件；</span> 
<span class="o">-</span><span class="n">S</span><span class="err">：在备份文件时，用指定的后缀“</span><span class="n">SUFFIX</span><span class="err">”代替文件的默认后缀；</span> 
<span class="o">-</span><span class="n">b</span><span class="err">：覆盖已存在的文件目标前将目标文件备份；</span> 
<span class="o">-</span><span class="n">v</span><span class="err">：详细显示命令执行的操作。</span>

<span class="err">\</span><span class="n">cp</span> <span class="o">-</span><span class="n">vupf</span>   <span class="err">更新，保留属性，\</span><span class="n">cp</span><span class="err">可以无视</span><span class="k">alias</span> <span class="n">cp</span><span class="o">=</span><span class="s1">&#39;cp -i&#39;</span>
</pre></div>


<h2 id="rsync">rsync</h2>
<div class="codehilite"><pre><span></span><span class="err">拷贝本地文件。当</span><span class="n">SRC</span><span class="err">和</span><span class="n">DES</span><span class="err">路径信息都不包含有单个冒号</span><span class="s">&quot;:&quot;</span><span class="err">分隔符时就启动这种工作模式。</span>
<span class="n">rsync</span> <span class="o">-</span><span class="n">a</span> <span class="o">/</span><span class="n">data</span> <span class="o">/</span><span class="n">backup</span>

<span class="err">使用一个远程</span><span class="n">shell</span><span class="err">程序</span><span class="p">(</span><span class="err">如</span><span class="n">rsh</span><span class="err">、</span><span class="n">ssh</span><span class="p">)</span><span class="err">来实现将本地机器的内容拷贝到远程机器。</span>
<span class="err">当</span><span class="n">DST</span><span class="err">路径地址包含单个冒号</span><span class="s">&quot;:&quot;</span><span class="err">分隔符时启动该模式。</span>
<span class="n">rsync</span> <span class="o">-</span><span class="n">avz</span> <span class="o">*</span><span class="p">.</span><span class="n">c</span> <span class="nl">foo</span><span class="p">:</span><span class="n">src</span>

<span class="err">使用一个远程</span><span class="n">shell</span><span class="err">程序</span><span class="p">(</span><span class="err">如</span><span class="n">rsh</span><span class="err">、</span><span class="n">ssh</span><span class="p">)</span><span class="err">来实现将远程机器的内容拷贝到本地机器。</span>
<span class="err">当</span><span class="n">SRC</span><span class="err">地址路径包含单个冒号</span><span class="s">&quot;:&quot;</span><span class="err">分隔符时启动该模式。</span>
<span class="n">rsync</span> <span class="o">-</span><span class="n">avz</span> <span class="nl">foo</span><span class="p">:</span><span class="n">src</span><span class="o">/</span><span class="n">bar</span> <span class="o">/</span><span class="n">data</span>

<span class="err">从远程</span><span class="n">rsync</span><span class="err">服务器中拷贝文件到本地机。当</span><span class="n">SRC</span><span class="err">路径信息包含</span><span class="s">&quot;::&quot;</span><span class="err">分隔符时启动该模式。</span>
<span class="n">rsync</span> <span class="o">-</span><span class="n">av</span> <span class="n">root</span><span class="mf">@192.168.78.192</span><span class="o">::</span><span class="n">www</span> <span class="o">/</span><span class="n">databack</span>

<span class="err">从本地机器拷贝文件到远程</span><span class="n">rsync</span><span class="err">服务器中。当</span><span class="n">DST</span><span class="err">路径信息包含</span><span class="s">&quot;::&quot;</span><span class="err">分隔符时启动该模式。</span>
<span class="n">rsync</span> <span class="o">-</span><span class="n">av</span> <span class="o">/</span><span class="n">databack</span> <span class="n">root</span><span class="mf">@192.168.78.192</span><span class="o">::</span><span class="n">www</span>

<span class="o">-</span><span class="n">v</span><span class="p">,</span> <span class="o">--</span><span class="n">verbose</span> <span class="err">详细模式输出。</span>
<span class="o">-</span><span class="n">q</span><span class="p">,</span> <span class="o">--</span><span class="n">quiet</span> <span class="err">精简输出模式。</span> 
<span class="o">-</span><span class="n">c</span><span class="p">,</span> <span class="o">--</span><span class="n">checksum</span> <span class="err">打开校验开关，强制对文件传输进行校验。</span> 
<span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="o">--</span><span class="n">archive</span> <span class="err">归档模式，表示以递归方式传输文件，并保持所有文件属性，等于</span><span class="o">-</span><span class="n">rlptgoD</span><span class="err">。</span>
<span class="o">-</span><span class="n">r</span><span class="p">,</span> <span class="o">--</span><span class="n">recursive</span> <span class="err">对子目录以递归模式处理。</span>
<span class="o">-</span><span class="n">R</span><span class="p">,</span> <span class="o">--</span><span class="n">relative</span> <span class="err">使用相对路径信息。</span>
<span class="o">-</span><span class="n">b</span><span class="p">,</span> <span class="o">--</span><span class="n">backup</span> <span class="err">创建备份，也就是对于目的已经存在有同样的文件名时，</span>
<span class="err">将老的文件重新命名为</span><span class="o">~</span><span class="n">filename</span><span class="err">。可以使用</span>
<span class="o">--</span><span class="n">suffix</span><span class="err">选项来指定不同的备份文件前缀。</span>
<span class="o">--</span><span class="n">backup</span><span class="o">-</span><span class="n">dir</span> <span class="err">将备份文件</span><span class="p">(</span><span class="err">如</span><span class="o">~</span><span class="n">filename</span><span class="p">)</span><span class="err">存放在在目录下。</span>
<span class="o">-</span><span class="n">suffix</span><span class="o">=</span><span class="n">SUFFIX</span> <span class="err">定义备份文件前缀。</span> 
<span class="o">-</span><span class="n">u</span><span class="p">,</span> <span class="o">--</span><span class="n">update</span> <span class="err">仅仅进行更新，也就是跳过所有已经存在于</span><span class="n">DST</span><span class="err">，并且文件时间晚于</span>
<span class="err">要备份的文件，不覆盖更新的文件。</span>
 <span class="o">-</span><span class="n">l</span><span class="p">,</span> <span class="o">--</span><span class="n">links</span> <span class="err">保留软链结。</span> <span class="o">-</span><span class="n">L</span><span class="p">,</span> <span class="o">--</span><span class="k">copy</span><span class="o">-</span><span class="n">links</span> <span class="err">想对待常规文件一样处理软链结。</span> 
<span class="o">--</span><span class="k">copy</span><span class="o">-</span><span class="n">unsafe</span><span class="o">-</span><span class="n">links</span> <span class="err">仅仅拷贝指向</span><span class="n">SRC</span><span class="err">路径目录树以外的链结。</span>
<span class="o">--</span><span class="n">safe</span><span class="o">-</span><span class="n">links</span> <span class="err">忽略指向</span><span class="n">SRC</span><span class="err">路径目录树以外的链结。</span>
<span class="o">-</span><span class="n">H</span><span class="p">,</span> <span class="o">--</span><span class="n">hard</span><span class="o">-</span><span class="n">links</span> <span class="err">保留硬链结。</span> 
<span class="o">-</span><span class="n">p</span><span class="p">,</span> <span class="o">--</span><span class="n">perms</span> <span class="err">保持文件权限。</span> 
<span class="o">-</span><span class="n">o</span><span class="p">,</span> <span class="o">--</span><span class="n">owner</span> <span class="err">保持文件属主信息。</span>
<span class="o">-</span><span class="n">g</span><span class="p">,</span> <span class="o">--</span><span class="n">group</span> <span class="err">保持文件属组信息。</span>
<span class="o">-</span><span class="n">D</span><span class="p">,</span> <span class="o">--</span><span class="n">devices</span> <span class="err">保持设备文件信息。</span>
<span class="o">-</span><span class="n">t</span><span class="p">,</span> <span class="o">--</span><span class="n">times</span> <span class="err">保持文件时间信息。</span>
<span class="o">-</span><span class="n">S</span><span class="p">,</span> <span class="o">--</span><span class="n">sparse</span> <span class="err">对稀疏文件进行特殊处理以节省</span><span class="n">DST</span><span class="err">的空间。</span> 
<span class="o">-</span><span class="n">n</span><span class="p">,</span> <span class="o">--</span><span class="n">dry</span><span class="o">-</span><span class="n">run</span><span class="err">现实哪些文件将被传输。</span>
<span class="o">-</span><span class="n">w</span><span class="p">,</span> <span class="o">--</span><span class="n">whole</span><span class="o">-</span><span class="n">file</span> <span class="err">拷贝文件，不进行增量检测。</span> 
<span class="o">-</span><span class="n">x</span><span class="p">,</span> <span class="o">--</span><span class="n">one</span><span class="o">-</span><span class="n">file</span><span class="o">-</span><span class="n">system</span> <span class="err">不要跨越文件系统边界。</span>
<span class="o">-</span><span class="n">B</span><span class="p">,</span> <span class="o">--</span><span class="n">block</span><span class="o">-</span><span class="n">size</span><span class="o">=</span><span class="n">SIZE</span> <span class="err">检验算法使用的块尺寸，默认是</span><span class="mi">700</span><span class="err">字节。</span>
<span class="o">-</span><span class="n">e</span><span class="p">,</span> <span class="o">--</span><span class="n">rsh</span><span class="o">=</span><span class="n">command</span> <span class="err">指定使用</span><span class="n">rsh</span><span class="err">、</span><span class="n">ssh</span><span class="err">方式进行数据同步。</span> 
<span class="o">--</span><span class="n">rsync</span><span class="o">-</span><span class="n">path</span><span class="o">=</span><span class="n">PATH</span> <span class="err">指定远程服务器上的</span><span class="n">rsync</span><span class="err">命令所在路径信息。</span>
<span class="o">-</span><span class="n">C</span><span class="p">,</span> <span class="o">--</span><span class="n">cvs</span><span class="o">-</span><span class="n">exclude</span> <span class="err">使用和</span><span class="n">CVS</span><span class="err">一样的方法自动忽略文件，用来排除那些不希望传输的文件。</span>
<span class="o">--</span><span class="n">existing</span> <span class="err">仅仅更新那些已经存在于</span><span class="n">DST</span><span class="err">的文件，而不备份那些新创建的文件。</span> 
<span class="o">--</span><span class="n">delete</span> <span class="err">删除那些</span><span class="n">DST</span><span class="err">中</span><span class="n">SRC</span><span class="err">没有的文件。</span>
<span class="o">--</span><span class="n">delete</span><span class="o">-</span><span class="n">excluded</span> <span class="err">同样删除接收端那些被该选项指定排除的文件。</span>
<span class="o">--</span><span class="n">delete</span><span class="o">-</span><span class="n">after</span> <span class="err">传输结束以后再删除。</span>
<span class="o">--</span><span class="n">ignore</span><span class="o">-</span><span class="n">errors</span> <span class="err">及时出现</span><span class="n">IO</span><span class="err">错误也进行删除。</span>
<span class="o">--</span><span class="n">max</span><span class="o">-</span><span class="n">delete</span><span class="o">=</span><span class="n">NUM</span> <span class="err">最多删除</span><span class="n">NUM</span><span class="err">个文件。</span>
<span class="o">--</span><span class="n">partial</span> <span class="err">保留那些因故没有完全传输的文件，以是加快随后的再次传输。</span> 
<span class="o">--</span><span class="n">force</span> <span class="err">强制删除目录，即使不为空。</span>
<span class="o">--</span><span class="n">numeric</span><span class="o">-</span><span class="n">ids</span> <span class="err">不将数字的用户和组</span><span class="kt">id</span><span class="err">匹配为用户名和组名。</span>
<span class="o">--</span><span class="n">timeout</span><span class="o">=</span><span class="n">time</span> <span class="n">ip</span><span class="err">超时时间，单位为秒。</span> 
<span class="o">-</span><span class="n">I</span><span class="p">,</span> <span class="o">--</span><span class="n">ignore</span><span class="o">-</span><span class="n">times</span> <span class="err">不跳过那些有同样的时间和长度的文件。</span>
<span class="o">--</span><span class="n">size</span><span class="o">-</span><span class="n">only</span> <span class="err">当决定是否要备份文件时，仅仅察看文件大小而不考虑文件时间。</span>
<span class="o">--</span><span class="n">modify</span><span class="o">-</span><span class="n">window</span><span class="o">=</span><span class="n">NUM</span> <span class="err">决定文件是否时间相同时使用的时间戳窗口，默认为</span><span class="mi">0</span><span class="err">。</span>
<span class="o">-</span><span class="n">T</span> <span class="o">--</span><span class="n">temp</span><span class="o">-</span><span class="n">dir</span><span class="o">=</span><span class="kt">DIR</span> <span class="err">在</span><span class="kt">DIR</span><span class="err">中创建临时文件。</span> 
<span class="o">--</span><span class="n">compare</span><span class="o">-</span><span class="n">dest</span><span class="o">=</span><span class="kt">DIR</span> <span class="err">同样比较</span><span class="kt">DIR</span><span class="err">中的文件来决定是否需要备份。</span>
<span class="o">-</span><span class="n">P</span> <span class="err">等同于</span> <span class="o">--</span><span class="n">partial</span><span class="err">。</span> <span class="o">--</span><span class="n">progress</span> <span class="err">显示备份过程。</span> 
<span class="o">-</span><span class="n">z</span><span class="p">,</span> <span class="o">--</span><span class="n">compress</span> <span class="err">对备份的文件在传输时进行压缩处理。</span> 
<span class="o">--</span><span class="n">exclude</span><span class="o">=</span><span class="n">PATTERN</span> <span class="err">指定排除不需要传输的文件模式。</span>
<span class="o">--</span><span class="n">include</span><span class="o">=</span><span class="n">PATTERN</span> <span class="err">指定不排除而需要传输的文件模式。</span> 
<span class="o">--</span><span class="n">exclude</span><span class="o">-</span><span class="n">from</span><span class="o">=</span><span class="kt">FILE</span> <span class="err">排除</span><span class="kt">FILE</span><span class="err">中指定模式的文件。</span>
<span class="o">--</span><span class="n">include</span><span class="o">-</span><span class="n">from</span><span class="o">=</span><span class="kt">FILE</span> <span class="err">不排除</span><span class="kt">FILE</span><span class="err">指定模式匹配的文件。</span> 
<span class="o">--</span><span class="n">version</span> <span class="err">打印版本信息。</span> 
<span class="o">--</span><span class="n">address</span> <span class="err">绑定到特定的地址。</span> 
<span class="o">--</span><span class="n">config</span><span class="o">=</span><span class="kt">FILE</span> <span class="err">指定其他的配置文件，不使用默认的</span><span class="n">rsyncd</span><span class="p">.</span><span class="n">conf</span><span class="err">文件。</span>
<span class="o">--</span><span class="n">port</span><span class="o">=</span><span class="n">PORT</span> <span class="err">指定其他的</span><span class="n">rsync</span><span class="err">服务端口。</span>
<span class="o">--</span><span class="n">blocking</span><span class="o">-</span><span class="n">io</span> <span class="err">对远程</span><span class="n">shell</span><span class="err">使用阻塞</span><span class="n">IO</span><span class="err">。</span>
<span class="o">-</span><span class="n">stats</span> <span class="err">给出某些文件的传输状态。</span> 
<span class="o">--</span><span class="n">progress</span> <span class="err">在传输时现实传输过程。</span>
<span class="o">--</span><span class="n">log</span><span class="o">-</span><span class="n">format</span><span class="o">=</span><span class="n">formAT</span> <span class="err">指定日志文件格式。</span>
<span class="o">--</span><span class="n">password</span><span class="o">-</span><span class="n">file</span><span class="o">=</span><span class="kt">FILE</span> <span class="err">从</span><span class="kt">FILE</span><span class="err">中得到密码。</span>
<span class="o">--</span><span class="n">bwlimit</span><span class="o">=</span><span class="n">KBPS</span> <span class="err">限制</span><span class="n">I</span><span class="o">/</span><span class="n">O</span><span class="err">带宽，</span><span class="n">KBytes</span> <span class="n">per</span> <span class="n">second</span><span class="err">。</span>


<span class="err">拉复制</span>

<span class="mi">1</span> <span class="n">install</span>
<span class="n">yum</span> <span class="n">install</span> <span class="n">rsync</span>
<span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsyncd</span><span class="o">/</span><span class="n">rsyncd</span><span class="p">.</span><span class="n">conf</span>
<span class="n">uid</span><span class="o">=</span><span class="n">root</span>
<span class="n">gid</span><span class="o">=</span><span class="n">root</span>
<span class="n">port</span><span class="o">=</span><span class="mi">873</span> 
<span class="n">max</span> <span class="n">connections</span><span class="o">=</span><span class="mi">0</span>   <span class="err">#</span><span class="n">limit</span> <span class="n">client</span> <span class="n">conection</span>
<span class="n">log</span> <span class="n">file</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">rsyncd</span><span class="p">.</span><span class="n">log</span>
<span class="n">pid</span> <span class="n">file</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">rsyncd</span><span class="p">.</span><span class="n">pid</span>
<span class="n">lock</span> <span class="n">file</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">rsyncd</span><span class="p">.</span><span class="n">lock</span>


<span class="n">motd</span> <span class="n">file</span> <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsyncd</span><span class="o">/</span><span class="n">rsyncd</span><span class="p">.</span><span class="n">motd</span>
<span class="n">read</span> <span class="n">only</span><span class="o">=</span><span class="n">yes</span>    <span class="err">只能下载不能上传</span>
<span class="cp">####limit user conn######</span>
<span class="n">hosts</span> <span class="n">allow</span><span class="o">=</span><span class="mf">192.168.18.0</span><span class="o">/</span><span class="mf">255.255.255.0</span>
<span class="n">hosts</span> <span class="n">deny</span><span class="o">=*</span>

<span class="cp">#transfer logging = yes</span>
<span class="cp">#log format = %t %a %m %f %b</span>
<span class="cp">#syslog facility = local3</span>
<span class="cp">#timeout = 300</span>

<span class="p">[</span><span class="n">www</span><span class="p">]</span>
<span class="n">path</span> <span class="o">=</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">www</span><span class="o">/</span>
<span class="n">list</span> <span class="o">=</span> <span class="n">yes</span>
<span class="n">ignore</span> <span class="n">errors</span>
<span class="n">auth</span> <span class="n">users</span> <span class="o">=</span> <span class="n">www</span>  
<span class="cp">###username</span>
<span class="n">secrets</span> <span class="n">file</span> <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsyncd</span><span class="o">/</span><span class="n">rsyncd</span><span class="p">.</span><span class="n">secrets</span>
<span class="n">comment</span> <span class="o">=</span> <span class="n">www</span> <span class="n">directory</span>
<span class="n">exclude</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span> <span class="n">b</span><span class="o">/</span>   <span class="err">#####</span><span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="n">directory</span> <span class="n">not</span> <span class="n">backup</span>



<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">www</span> <span class="n">rsyncd</span><span class="p">]</span><span class="err">#</span> <span class="n">cat</span> <span class="n">rsyncd</span><span class="p">.</span><span class="n">motd</span> 
<span class="cp">#####################</span>
<span class="n">www</span><span class="p">.</span><span class="n">vfast</span><span class="p">.</span><span class="n">com</span> <span class="n">rsync</span>
<span class="cp">#####################</span>


<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">www</span> <span class="n">rsyncd</span><span class="p">]</span><span class="err">#</span> <span class="n">cat</span> <span class="n">rsyncd</span><span class="p">.</span><span class="n">secrets</span> 
<span class="nl">www</span><span class="p">:</span><span class="mi">123</span>
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">www</span> <span class="n">rsyncd</span><span class="p">]</span><span class="err">#</span> <span class="n">chmod</span> <span class="mi">600</span> <span class="n">rsyncd</span><span class="p">.</span><span class="n">secrets</span>

<span class="mi">4</span> <span class="n">start</span> 
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">www</span> <span class="n">rsyncd</span><span class="p">]</span><span class="err">#</span> <span class="n">rsync</span> <span class="o">--</span><span class="n">daemon</span> <span class="o">--</span><span class="n">config</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsyncd</span><span class="o">/</span><span class="n">rsyncd</span><span class="p">.</span><span class="n">conf</span> 
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">www</span> <span class="n">rsyncd</span><span class="p">]</span><span class="err">#</span> <span class="n">lsof</span> <span class="o">-</span><span class="nl">i</span><span class="p">:</span><span class="mi">873</span>
<span class="n">COMMAND</span>  <span class="n">PID</span> <span class="n">USER</span>   <span class="n">FD</span>   <span class="n">TYPE</span> <span class="n">DEVICE</span> <span class="n">SIZE</span> <span class="n">NODE</span> <span class="n">NAME</span>
<span class="n">rsync</span>   <span class="mi">8043</span> <span class="n">root</span>    <span class="mi">4u</span>  <span class="n">IPv6</span>  <span class="mi">22013</span>       <span class="n">TCP</span> <span class="o">*:</span><span class="n">rsync</span> <span class="p">(</span><span class="n">LISTEN</span><span class="p">)</span>
<span class="n">rsync</span>   <span class="mi">8043</span> <span class="n">root</span>    <span class="mi">5u</span>  <span class="n">IPv4</span>  <span class="mi">22014</span>       <span class="n">TCP</span> <span class="o">*:</span><span class="n">rsync</span> <span class="p">(</span><span class="n">LISTEN</span><span class="p">)</span>


<span class="mi">5</span> <span class="n">check</span> <span class="n">log</span> 
<span class="n">tail</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">rsyncd</span><span class="p">.</span><span class="n">log</span>


<span class="nl">client</span> <span class="p">:</span> <span class="mf">192.168.18.146</span>
<span class="n">echo</span> <span class="mi">123</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsync</span><span class="p">.</span><span class="n">password</span>
<span class="n">chmod</span> <span class="mi">600</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsync</span><span class="p">.</span><span class="n">password</span>
<span class="n">mkdir</span> <span class="o">-</span><span class="n">pv</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">www</span>
<span class="n">rsync</span> <span class="o">-</span><span class="n">avzP</span> <span class="o">--</span><span class="n">delete</span> <span class="o">--</span><span class="n">password</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsync</span><span class="p">.</span><span class="n">password</span> 
<span class="n">www</span><span class="mf">@192.168.18.254</span><span class="o">::</span><span class="n">www</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">www</span>



<span class="cp">#####################</span>
<span class="n">www</span><span class="p">.</span><span class="n">vfast</span><span class="p">.</span><span class="n">com</span> <span class="n">rsync</span>
<span class="cp">#####################</span>

<span class="n">receiving</span> <span class="n">file</span> <span class="n">list</span> <span class="p">...</span> 
<span class="mi">3</span> <span class="n">files</span> <span class="n">to</span> <span class="n">consider</span>
<span class="n">deleting</span> <span class="n">f</span><span class="o">/</span>
<span class="n">deleting</span> <span class="n">d</span><span class="o">/</span>
<span class="n">deleting</span> <span class="n">abcd</span><span class="o">/</span>
<span class="n">deleting</span> <span class="n">c</span><span class="o">/</span><span class="mi">3</span>
<span class="n">deleting</span> <span class="n">c</span><span class="o">/</span><span class="mi">2</span>
<span class="n">deleting</span> <span class="n">c</span><span class="o">/</span><span class="mi">1</span>
<span class="p">.</span><span class="o">/</span>                  
<span class="n">c</span><span class="o">/</span>
<span class="n">c</span><span class="o">/</span><span class="n">c1</span>
           <span class="mi">6</span> <span class="mi">100</span><span class="o">%</span>    <span class="mf">5.86</span><span class="n">kB</span><span class="o">/</span><span class="n">s</span>    <span class="mi">0</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span> <span class="p">(</span><span class="n">xfer</span><span class="err">#</span><span class="mi">1</span><span class="p">,</span> <span class="n">to</span><span class="o">-</span><span class="n">check</span><span class="o">=</span><span class="mi">0</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>

<span class="n">sent</span> <span class="mi">129</span> <span class="n">bytes</span>  <span class="n">received</span> <span class="mi">260</span> <span class="n">bytes</span>  <span class="mf">778.00</span> <span class="n">bytes</span><span class="o">/</span><span class="n">sec</span>
<span class="n">total</span> <span class="n">size</span> <span class="n">is</span> <span class="mi">6</span>  <span class="n">speedup</span> <span class="n">is</span> <span class="mf">0.02</span>

<span class="mi">146</span><span class="err">#</span><span class="n">cd</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">www</span><span class="o">/</span>
<span class="mi">146</span><span class="err">#</span><span class="n">tree</span> 
<span class="p">.</span>
<span class="err">`</span><span class="o">--</span> <span class="n">c</span>
    <span class="err">`</span><span class="o">--</span> <span class="n">c1</span>

<span class="mi">1</span> <span class="n">directory</span><span class="p">,</span> <span class="mi">1</span> <span class="n">file</span>

<span class="mf">192.168.18.254</span> <span class="n">server</span>
<span class="n">rm</span> <span class="o">-</span><span class="n">fr</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">c</span><span class="o">/</span><span class="n">c1</span>
<span class="mi">146</span><span class="err">#</span><span class="n">rsync</span> <span class="o">-</span><span class="n">avzP</span> <span class="o">--</span><span class="n">delete</span> <span class="o">--</span><span class="n">password</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsync</span><span class="p">.</span><span class="n">password</span> 
<span class="n">www</span><span class="mf">@192.168.18.254</span><span class="o">::</span><span class="n">www</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">www</span>
<span class="cp">#####################</span>
<span class="n">www</span><span class="p">.</span><span class="n">vfast</span><span class="p">.</span><span class="n">com</span> <span class="n">rsync</span>
<span class="cp">#####################</span>

<span class="n">receiving</span> <span class="n">file</span> <span class="n">list</span> <span class="p">...</span> 
<span class="mi">2</span> <span class="n">files</span> <span class="n">to</span> <span class="n">consider</span>
<span class="n">deleting</span> <span class="n">c</span><span class="o">/</span><span class="n">c1</span>
<span class="n">c</span><span class="o">/</span>

<span class="n">sent</span> <span class="mi">101</span> <span class="n">bytes</span>  <span class="n">received</span> <span class="mi">191</span> <span class="n">bytes</span>  <span class="mf">194.67</span> <span class="n">bytes</span><span class="o">/</span><span class="n">sec</span>
<span class="n">total</span> <span class="n">size</span> <span class="n">is</span> <span class="mi">0</span>  <span class="n">speedup</span> <span class="n">is</span> <span class="mf">0.00</span>
<span class="mi">146</span><span class="err">#</span><span class="n">tree</span> 
<span class="p">.</span>
<span class="err">`</span><span class="o">--</span> <span class="n">c</span>

<span class="mi">1</span> <span class="n">directory</span><span class="p">,</span> <span class="mi">0</span> <span class="n">files</span>


<span class="n">crontab</span> <span class="o">-</span><span class="n">e</span>
<span class="mi">10</span> <span class="mi">2</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span>   <span class="n">rsync</span> <span class="o">-</span><span class="n">avzP</span> <span class="o">--</span><span class="n">delete</span> <span class="o">--</span><span class="n">password</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsync</span><span class="p">.</span><span class="n">password</span> 
<span class="n">www</span><span class="mf">@192.168.18.254</span><span class="o">::</span><span class="n">www</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">www</span>





<span class="err">推复制</span>

<span class="n">server</span>  <span class="n">sersync2</span> <span class="o">+</span> <span class="n">rsync</span>  <span class="mf">192.168.18.254</span>
<span class="n">client</span>  <span class="n">rsync</span>  <span class="mf">192.168.18.146</span>


<span class="n">apache</span><span class="o">-</span><span class="n">server</span>
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">www</span> <span class="n">tmp</span><span class="p">]</span><span class="err">#</span> <span class="n">tar</span> <span class="n">fvxz</span> <span class="n">sersync</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span> 
<span class="n">GNU</span><span class="o">-</span><span class="n">Linux</span><span class="o">-</span><span class="n">x86</span><span class="o">/</span>
<span class="n">GNU</span><span class="o">-</span><span class="n">Linux</span><span class="o">-</span><span class="n">x86</span><span class="o">/</span><span class="n">sersync2</span>
<span class="n">GNU</span><span class="o">-</span><span class="n">Linux</span><span class="o">-</span><span class="n">x86</span><span class="o">/</span><span class="n">confxml</span><span class="p">.</span><span class="n">xml</span>

<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">www</span> <span class="n">tmp</span><span class="p">]</span><span class="err">#</span> <span class="n">cd</span> <span class="n">GNU</span><span class="o">-</span><span class="n">Linux</span><span class="o">-</span><span class="n">x86</span><span class="o">/</span>

<span class="n">vim</span> <span class="n">confxml</span><span class="p">.</span><span class="n">xml</span>
 <span class="o">&lt;</span><span class="n">sersync</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">localpath</span> <span class="n">watch</span><span class="o">=</span><span class="s">&quot;/tmp/www&quot;</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">remote</span> <span class="n">ip</span><span class="o">=</span><span class="s">&quot;192.168.18.146&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;www&quot;</span><span class="o">/&gt;</span>



 <span class="o">&lt;</span><span class="n">commonParams</span> <span class="n">params</span><span class="o">=</span><span class="s">&quot;-artuz&quot;</span><span class="o">/&gt;</span>
            <span class="o">&lt;</span><span class="n">auth</span> <span class="n">start</span><span class="o">=</span><span class="s">&quot;true&quot;</span> <span class="n">users</span><span class="o">=</span><span class="s">&quot;kyo&quot;</span> <span class="n">passwordfile</span><span class="o">=</span><span class="s">&quot;/etc/146rsync.pass&quot;</span><span class="o">/&gt;</span>



  <span class="o">&lt;</span><span class="n">failLog</span> <span class="n">path</span><span class="o">=</span><span class="s">&quot;/tmp/rsync_fail_log&quot;</span> <span class="n">timeToExecute</span><span class="o">=</span><span class="s">&quot;60&quot;</span><span class="o">/&gt;&lt;!--</span><span class="k">default</span> <span class="n">every</span>
   <span class="mi">60</span><span class="n">mins</span> <span class="n">execute</span> <span class="n">once</span><span class="o">--&gt;</span><span class="p">;</span>




<span class="n">client</span> <span class="mf">192.168.18.146</span>
<span class="mi">146</span><span class="err">#</span><span class="n">chmod</span> <span class="mi">600</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsyncd</span><span class="o">/</span><span class="n">rsyncd</span><span class="p">.</span><span class="n">secrets</span>
<span class="mi">146</span><span class="err">#</span><span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsyncd</span><span class="o">/</span><span class="n">rsyncd</span><span class="p">.</span><span class="n">secrets</span>
<span class="nl">kyo</span><span class="p">:</span><span class="mi">123</span>

<span class="mi">146</span><span class="err">#</span><span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsyncd</span><span class="o">/</span><span class="n">rsyncd</span><span class="p">.</span><span class="n">conf</span> 
<span class="n">uid</span><span class="o">=</span><span class="n">root</span>
<span class="n">gid</span><span class="o">=</span><span class="n">root</span>
<span class="n">port</span><span class="o">=</span><span class="mi">873</span> 
<span class="n">max</span> <span class="n">connections</span><span class="o">=</span><span class="mi">0</span>   <span class="err">#</span><span class="n">limit</span> <span class="n">client</span> <span class="n">conection</span>
<span class="n">use</span> <span class="n">chroot</span> <span class="o">=</span> <span class="n">no</span>
<span class="n">log</span> <span class="n">file</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">rsyncd</span><span class="p">.</span><span class="n">log</span>
<span class="n">pid</span> <span class="n">file</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">rsyncd</span><span class="p">.</span><span class="n">pid</span>
<span class="n">lock</span> <span class="n">file</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">rsyncd</span><span class="p">.</span><span class="n">lock</span>


<span class="n">motd</span> <span class="n">file</span> <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsyncd</span><span class="o">/</span><span class="n">rsyncd</span><span class="p">.</span><span class="n">motd</span>
<span class="n">read</span> <span class="n">only</span><span class="o">=</span><span class="n">no</span>   <span class="err">###############</span><span class="o">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<span class="cp">####limit user conn######</span>
<span class="n">hosts</span> <span class="n">allow</span><span class="o">=</span><span class="mf">192.168.18.0</span><span class="o">/</span><span class="mf">255.255.255.0</span>
<span class="n">hosts</span> <span class="n">deny</span><span class="o">=*</span>

<span class="cp">#transfer logging = yes</span>
<span class="cp">#log format = %t %a %m %f %b</span>
<span class="cp">#syslog facility = local3</span>
<span class="cp">#timeout = 300</span>

<span class="p">[</span><span class="n">www</span><span class="p">]</span>
<span class="n">path</span> <span class="o">=</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">www</span> 
<span class="n">list</span> <span class="o">=</span> <span class="n">yes</span>
<span class="n">ignore</span> <span class="n">errors</span>
<span class="n">auth</span> <span class="n">users</span> <span class="o">=</span> <span class="n">kyo</span>  
<span class="cp">###username!!</span>
<span class="n">secrets</span> <span class="n">file</span> <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsyncd</span><span class="o">/</span><span class="n">rsyncd</span><span class="p">.</span><span class="n">secrets</span>
<span class="n">comment</span> <span class="o">=</span> <span class="n">www</span> <span class="n">directory</span>
<span class="n">read</span> <span class="n">only</span> <span class="o">=</span> <span class="n">no</span>


<span class="mi">146</span><span class="err">#</span><span class="n">rsync</span> <span class="o">--</span><span class="n">daemon</span> <span class="o">--</span><span class="n">config</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsyncd</span><span class="o">/</span><span class="n">rsyncd</span><span class="p">.</span><span class="n">conf</span>
<span class="mi">146</span><span class="err">#</span><span class="n">lsof</span> <span class="o">-</span><span class="nl">i</span><span class="p">:</span><span class="mi">873</span>
<span class="n">COMMAND</span>  <span class="n">PID</span> <span class="n">USER</span>   <span class="n">FD</span>   <span class="n">TYPE</span> <span class="n">DEVICE</span> <span class="n">SIZE</span> <span class="n">NODE</span> <span class="n">NAME</span>
<span class="n">rsync</span>   <span class="mi">4356</span> <span class="n">root</span>    <span class="mi">4u</span>  <span class="n">IPv6</span>  <span class="mi">14561</span>       <span class="n">TCP</span> <span class="o">*:</span><span class="n">rsync</span> <span class="p">(</span><span class="n">LISTEN</span><span class="p">)</span>
<span class="n">rsync</span>   <span class="mi">4356</span> <span class="n">root</span>    <span class="mi">5u</span>  <span class="n">IPv4</span>  <span class="mi">14562</span>       <span class="n">TCP</span> <span class="o">*:</span><span class="n">rsync</span> <span class="p">(</span><span class="n">LISTEN</span><span class="p">)</span>



<span class="n">server</span> <span class="mf">192.168.18.254</span>
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">www</span> <span class="n">GNU</span><span class="o">-</span><span class="n">Linux</span><span class="o">-</span><span class="n">x86</span><span class="p">]</span><span class="err">#</span> <span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="mi">146</span><span class="n">rsync</span><span class="p">.</span><span class="n">pass</span>
<span class="mi">123</span>
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">www</span> <span class="n">GNU</span><span class="o">-</span><span class="n">Linux</span><span class="o">-</span><span class="n">x86</span><span class="p">]</span><span class="err">#</span> <span class="n">chmod</span> <span class="mi">600</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="mi">146</span><span class="n">rsync</span><span class="p">.</span><span class="n">pass</span>

<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">www</span> <span class="n">www</span><span class="p">]</span><span class="err">#</span> <span class="n">ps</span> <span class="n">axu</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">rsync</span>
<span class="n">root</span>      <span class="mi">8043</span>  <span class="mf">0.0</span>  <span class="mf">0.0</span>   <span class="mi">5252</span>   <span class="mi">480</span> <span class="o">?</span>        <span class="n">Ss</span>   <span class="mi">11</span><span class="o">:</span><span class="mi">08</span>   <span class="mi">0</span><span class="o">:</span><span class="mo">00</span> <span class="n">rsync</span> 
<span class="o">--</span><span class="n">daemon</span> <span class="o">--</span><span class="n">config</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsyncd</span><span class="o">/</span><span class="n">rsyncd</span><span class="p">.</span><span class="n">conf</span>
<span class="n">root</span>      <span class="mi">8191</span>  <span class="mf">0.6</span>  <span class="mf">2.3</span>  <span class="mi">82416</span> <span class="mi">24024</span> <span class="n">pts</span><span class="o">/</span><span class="mi">7</span>    <span class="n">S</span><span class="o">+</span>   <span class="mi">11</span><span class="o">:</span><span class="mi">17</span>   <span class="mi">0</span><span class="o">:</span><span class="mi">11</span> <span class="n">gedit</span> <span class="n">rsync</span><span class="p">.</span><span class="n">txt</span>
<span class="n">root</span>      <span class="mi">8668</span>  <span class="mf">0.0</span>  <span class="mf">0.0</span>   <span class="mi">5024</span>   <span class="mi">696</span> <span class="n">pts</span><span class="o">/</span><span class="mi">3</span>    <span class="n">S</span><span class="o">+</span>   <span class="mi">11</span><span class="o">:</span><span class="mi">46</span>   <span class="mi">0</span><span class="o">:</span><span class="mo">00</span> <span class="n">grep</span> <span class="n">rsync</span>
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">www</span> <span class="n">www</span><span class="p">]</span><span class="err">#</span> <span class="n">kill</span> <span class="o">-</span><span class="mi">9</span> <span class="mi">8043</span>



<span class="n">test</span>
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">www</span> <span class="n">GNU</span><span class="o">-</span><span class="n">Linux</span><span class="o">-</span><span class="n">x86</span><span class="p">]</span><span class="err">#</span> <span class="n">pwd</span>
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">GNU</span><span class="o">-</span><span class="n">Linux</span><span class="o">-</span><span class="n">x86</span>

<span class="cp"># ./sersync2 -r    #run first!</span>

<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">www</span> <span class="n">GNU</span><span class="o">-</span><span class="n">Linux</span><span class="o">-</span><span class="n">x86</span><span class="p">]</span><span class="err">#</span> <span class="p">.</span><span class="o">/</span><span class="n">sersync2</span> 
<span class="n">set</span> <span class="n">the</span> <span class="n">system</span> <span class="n">param</span>
<span class="n">execute</span><span class="err">：</span><span class="n">echo</span> <span class="mi">50000000</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">inotify</span><span class="o">/</span><span class="n">max_user_watches</span>
<span class="n">execute</span><span class="err">：</span><span class="n">echo</span> <span class="mi">327679</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">inotify</span><span class="o">/</span><span class="n">max_queued_events</span>
<span class="n">parse</span> <span class="n">the</span> <span class="n">command</span> <span class="n">param</span>
<span class="n">daemon</span> <span class="kr">thread</span> <span class="nl">num</span><span class="p">:</span> <span class="mi">10</span>
<span class="n">parse</span> <span class="n">xml</span> <span class="n">config</span> <span class="n">file</span>
<span class="n">host</span> <span class="nl">ip</span> <span class="p">:</span> <span class="n">localhost</span>     <span class="n">host</span> <span class="nl">port</span><span class="p">:</span> <span class="mi">8008</span>
<span class="n">use</span> <span class="n">rsync</span> <span class="n">password</span><span class="o">-</span><span class="nl">file</span> <span class="p">:</span>
<span class="n">user</span> <span class="n">is</span> <span class="n">kyo</span>
<span class="n">passwordfile</span> <span class="n">is</span>         <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="mi">146</span><span class="n">rsync</span><span class="p">.</span><span class="n">pass</span>
<span class="n">config</span> <span class="n">xml</span> <span class="n">parse</span> <span class="n">success</span>
<span class="n">please</span> <span class="n">set</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rsyncd</span><span class="p">.</span><span class="n">conf</span> <span class="n">max</span> <span class="n">connections</span><span class="o">=</span><span class="mi">0</span> <span class="n">Manually</span>
<span class="n">sersync</span> <span class="n">working</span> <span class="kr">thread</span> <span class="mi">12</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">(</span><span class="n">primary</span> <span class="kr">thread</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">(</span><span class="n">fail</span> <span class="n">retry</span> <span class="kr">thread</span><span class="p">)</span> <span class="o">+</span> 
<span class="mi">10</span><span class="p">(</span><span class="n">daemon</span> <span class="n">sub</span> <span class="n">threads</span><span class="p">)</span> 
<span class="n">Max</span> <span class="n">threads</span> <span class="n">numbers</span> <span class="nl">is</span><span class="p">:</span> <span class="mi">22</span> <span class="o">=</span> <span class="mi">12</span><span class="p">(</span><span class="n">Thread</span> <span class="n">pool</span> <span class="n">nums</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span><span class="p">(</span><span class="n">Sub</span> <span class="n">threads</span><span class="p">)</span>
<span class="n">please</span> <span class="n">according</span> <span class="n">your</span> <span class="n">cpu</span> <span class="err">，</span><span class="n">use</span> <span class="o">-</span><span class="n">n</span> <span class="n">param</span> <span class="n">to</span> <span class="n">adjust</span> <span class="n">the</span> <span class="n">cpu</span> <span class="n">rate</span>
<span class="n">run</span> <span class="n">the</span> <span class="nl">sersync</span><span class="p">:</span> 
<span class="n">watch</span> <span class="n">path</span> <span class="nl">is</span><span class="p">:</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">www</span>
</pre></div>


<h2 id="snmpwalk">snmpwalk</h2>
<p>yum install net-snmp-utils -y</p>
<p>snmpwalk -c public  -v 2c 172.31.38.23 ifDescr  端口</p>
<p>snmpwalk -c public  -v 2c 172.31.38.23 IF-MIB::ifInOctets  入流量</p>
<p>snmpwalk -c public  -v 2c 172.31.38.23 IF-MIB::ifOutOctets 出流量</p>
<p>snmpwalk -c public -v 2c 172.31.38.23 IF-MIB::ifInOctets.13  指定端口的流量</p>
<p>snmpwalk -c public -v 2c 172.31.38.23 IF-MIB::ifHCInOctets.13  64位计算,大流量更准确</p>
<p>snmpwalk -c public -v 2c 172.31.38.23 IF-MIB::ifHCOutOctets.13  64位计算,大流量更准确</p>
<p>这个流量是该端口累加的流量（count32到最大值的时候自动规零），只有用(前值-后值)/间隔，
才能得到该端口的真时流量</p>
<div class="codehilite"><pre><span></span>获取所有端口流量

#<span class="o">!/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">env</span> <span class="nv">bash</span>
<span class="nv">api</span><span class="o">=</span><span class="nv">http</span>:<span class="o">//</span><span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span>:<span class="mi">1988</span><span class="o">/</span><span class="nv">v1</span><span class="o">/</span><span class="nv">push</span>
<span class="nv">ts</span><span class="o">=</span>$<span class="ss">(</span><span class="nv">date</span> <span class="o">+%</span><span class="nv">s</span><span class="ss">)</span>

[ <span class="o">-</span><span class="nv">d</span> <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">snmp</span> ]<span class="o">||</span><span class="nv">mkdir</span> <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">snmp</span>
<span class="nv">cd</span> <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">open</span><span class="o">-</span><span class="nv">falcon</span><span class="o">/</span><span class="nv">switch</span><span class="o">-</span><span class="nv">custom</span>
<span class="nv">snmpuser</span><span class="o">=</span><span class="nv">user</span>
<span class="nv">snmppwd</span><span class="o">=</span><span class="nv">pass</span>

#<span class="nv">snmpwalk</span> <span class="o">-</span><span class="nv">v</span> <span class="mi">3</span> <span class="o">-</span><span class="nv">u</span> <span class="nv">user</span> <span class="o">-</span><span class="nv">a</span> <span class="nv">MD5</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">pass</span> <span class="mi">172</span>.<span class="mi">19</span>.<span class="mi">2</span>.<span class="mi">30</span> <span class="nv">ifDescr</span>  <span class="k">IF</span><span class="o">-</span><span class="nv">MIB</span>::<span class="nv">ifInOctets</span>.<span class="mi">13</span>
#<span class="nv">awk</span> <span class="s1">&#39;</span><span class="s">{print $NF*8}</span><span class="s1">&#39;</span>

<span class="nv">stat</span><span class="o">=</span>$<span class="ss">(</span><span class="nv">curl</span> <span class="nv">http</span>:<span class="o">//</span><span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span>:<span class="mi">1988</span> <span class="o">-</span><span class="nv">o</span> <span class="o">/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">null</span> <span class="o">-</span><span class="nv">s</span> <span class="o">-</span><span class="nv">w</span> <span class="o">%</span>{<span class="nv">http_code</span>}<span class="ss">)</span>
<span class="k">if</span> [ $<span class="nv">stat</span> <span class="o">-</span><span class="nv">ne</span> <span class="mi">404</span>  ]<span class="c1">;then</span>
    <span class="k">exit</span>
<span class="nv">fi</span>


<span class="nv">getflow</span><span class="ss">()</span>{
<span class="nv">snmpwalk</span> <span class="o">-</span><span class="nv">l</span> <span class="nv">auth</span> <span class="o">-</span><span class="nv">v</span> <span class="mi">3</span> <span class="o">-</span><span class="nv">u</span> $<span class="nv">snmpuser</span> <span class="o">-</span><span class="nv">a</span> <span class="nv">MD5</span> <span class="o">-</span><span class="nv">A</span> $<span class="nv">snmppwd</span> <span class="mh">$2</span> <span class="nv">ifDescr</span> <span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">vi</span> <span class="nv">VLAN</span> <span class="o">&gt;</span> <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">snmp</span><span class="o">/</span><span class="mh">$1</span><span class="nv">_port</span>
<span class="nv">snmpwalk</span> <span class="o">-</span><span class="nv">l</span> <span class="nv">auth</span> <span class="o">-</span><span class="nv">v</span> <span class="mi">3</span> <span class="o">-</span><span class="nv">u</span> $<span class="nv">snmpuser</span> <span class="o">-</span><span class="nv">a</span> <span class="nv">MD5</span> <span class="o">-</span><span class="nv">A</span> $<span class="nv">snmppwd</span> <span class="mh">$2</span> <span class="k">IF</span><span class="o">-</span><span class="nv">MIB</span>::<span class="nv">ifHCInOctets</span> <span class="o">&gt;</span> <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">snmp</span><span class="o">/</span><span class="mh">$1</span><span class="nv">_in</span>
<span class="nv">snmpwalk</span> <span class="o">-</span><span class="nv">l</span> <span class="nv">auth</span> <span class="o">-</span><span class="nv">v</span> <span class="mi">3</span> <span class="o">-</span><span class="nv">u</span> $<span class="nv">snmpuser</span> <span class="o">-</span><span class="nv">a</span> <span class="nv">MD5</span> <span class="o">-</span><span class="nv">A</span> $<span class="nv">snmppwd</span> <span class="mh">$2</span> <span class="k">IF</span><span class="o">-</span><span class="nv">MIB</span>::<span class="nv">ifHCOutOctets</span> <span class="o">&gt;</span> <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">snmp</span><span class="o">/</span><span class="mh">$1</span><span class="nv">_out</span>

<span class="nb">result</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="k">while</span> <span class="nv">read</span> <span class="nv">snport</span>
<span class="k">do</span>
  <span class="nv">port_name</span><span class="o">=</span>$<span class="ss">(</span><span class="nv">echo</span> $<span class="nv">snport</span> <span class="o">|</span> <span class="nv">awk</span> <span class="s1">&#39;</span><span class="s">{print $NF}</span><span class="s1">&#39;</span><span class="ss">)</span>
  <span class="nv">port_id</span><span class="o">=</span>$<span class="ss">(</span><span class="nv">echo</span> $<span class="nv">snport</span> <span class="o">|</span> <span class="nv">awk</span> <span class="s1">&#39;</span><span class="s">{print $1}</span><span class="s1">&#39;</span> <span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">Po</span> <span class="s1">&#39;</span><span class="s">\d+</span><span class="s1">&#39;</span><span class="ss">)</span>
  <span class="nv">net_in</span><span class="o">=</span>$<span class="ss">(</span><span class="nv">awk</span> <span class="s2">&quot;</span><span class="s">/IF-MIB::ifHCInOctets.$port_id =</span><span class="s2">&quot;</span><span class="o">/</span><span class="s1">&#39;</span><span class="s">{print $NF*8}</span><span class="s1">&#39;</span> <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">snmp</span><span class="o">/</span><span class="mh">$1</span><span class="nv">_in</span><span class="ss">)</span>
  <span class="nv">net_out</span><span class="o">=</span>$<span class="ss">(</span><span class="nv">awk</span> <span class="s2">&quot;</span><span class="s">/IF-MIB::ifHCOutOctets.$port_id =</span><span class="s2">&quot;</span><span class="o">/</span><span class="s1">&#39;</span><span class="s">{print $NF*8}</span><span class="s1">&#39;</span> <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">snmp</span><span class="o">/</span><span class="mh">$1</span><span class="nv">_out</span><span class="ss">)</span>
  #<span class="nv">echo</span> $<span class="nv">port_name</span>,$<span class="nv">port_id</span>,$<span class="nv">net_in</span>,$<span class="nv">net_out</span>

  <span class="nv">net_all</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">{\</span><span class="s2">&quot;</span><span class="nv">metric</span>\<span class="s2">&quot;</span><span class="s">: \</span><span class="s2">&quot;</span><span class="nv">switch</span>.<span class="k">if</span>.<span class="nv">In</span>\<span class="s2">&quot;</span><span class="s">, \</span><span class="s2">&quot;</span><span class="nv">endpoint</span>\<span class="s2">&quot;</span><span class="s">: \</span><span class="s2">&quot;</span><span class="mh">$1</span>\<span class="s2">&quot;</span><span class="s">, \</span><span class="s2">&quot;</span><span class="nv">timestamp</span>\<span class="s2">&quot;</span><span class="s">: $ts,\</span><span class="s2">&quot;</span><span class="nv">step</span>\<span class="s2">&quot;</span><span class="s">: 60,\</span><span class="s2">&quot;</span><span class="nv">value</span>\<span class="s2">&quot;</span><span class="s">: $net_in,</span>
\<span class="s2">&quot;</span><span class="s">counterType\</span><span class="s2">&quot;</span>: \<span class="s2">&quot;</span><span class="s">COUNTER\</span><span class="s2">&quot;</span>,\<span class="s2">&quot;</span><span class="s">tags\</span><span class="s2">&quot;</span>: \<span class="s2">&quot;</span><span class="s">ifName=$port_name\</span><span class="s2">&quot;</span>},{\<span class="s2">&quot;</span><span class="s">metric\</span><span class="s2">&quot;</span>: \<span class="s2">&quot;</span><span class="s">switch.if.Out\</span><span class="s2">&quot;</span>, \<span class="s2">&quot;</span><span class="s">endpoint\</span><span class="s2">&quot;</span>: \<span class="s2">&quot;</span><span class="s">$1\</span><span class="s2">&quot;</span>, 
\<span class="s2">&quot;</span><span class="s">timestamp\</span><span class="s2">&quot;</span>: $<span class="nv">ts</span>,\<span class="s2">&quot;</span><span class="s">step\</span><span class="s2">&quot;</span>: <span class="mi">60</span>,\<span class="s2">&quot;</span><span class="s">value\</span><span class="s2">&quot;</span>: $<span class="nv">net_out</span>,\<span class="s2">&quot;</span><span class="s">counterType\</span><span class="s2">&quot;</span>: \<span class="s2">&quot;</span><span class="s">COUNTER\</span><span class="s2">&quot;</span>,\<span class="s2">&quot;</span><span class="s">tags\</span><span class="s2">&quot;</span>: \<span class="s2">&quot;</span><span class="s">ifName=$port_name\</span><span class="s2">&quot;</span>}<span class="s2">&quot;</span>
  <span class="nv">curl</span> <span class="o">-</span><span class="nv">s</span> <span class="o">-</span><span class="nv">X</span> <span class="nv">POST</span> <span class="o">-</span><span class="nv">d</span> <span class="s2">&quot;</span><span class="s">[$net_all]</span><span class="s2">&quot;</span> <span class="mh">$a</span><span class="nv">pi</span> <span class="o">&gt;/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">null</span>
  #<span class="nv">echo</span> $<span class="nv">net_all</span>
  #<span class="nb">result</span><span class="o">=</span>$<span class="nb">result</span>$<span class="nv">net_all</span>
<span class="nv">done</span> <span class="o">&lt;</span> <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">snmp</span><span class="o">/</span><span class="mh">$1</span><span class="nv">_port</span>
#<span class="nv">echo</span> $<span class="nb">result</span> <span class="o">|</span> <span class="nv">sed</span> <span class="s2">&quot;</span><span class="s">s/,$//g</span><span class="s2">&quot;</span>
#<span class="nv">curl</span> <span class="o">-</span><span class="nv">s</span> <span class="o">-</span><span class="nv">X</span> <span class="nv">POST</span> <span class="o">-</span><span class="nv">d</span> <span class="s2">&quot;</span><span class="s">[$(echo $result | sed </span><span class="s2">&quot;</span><span class="nv">s</span><span class="o">/</span>,$<span class="o">//</span><span class="nv">g</span><span class="s2">&quot;</span><span class="s">)]</span><span class="s2">&quot;</span> <span class="mh">$a</span><span class="nv">pi</span> <span class="o">&gt;/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">null</span>
}


<span class="k">while</span> <span class="nv">read</span> <span class="nv">line</span>
<span class="k">do</span>
    <span class="nv">getflow</span> $<span class="nv">line</span> <span class="o">&amp;</span>
#    <span class="nv">getflow</span> $<span class="nv">line</span>
<span class="nv">done</span> <span class="o">&lt;</span> <span class="nv">sw</span><span class="o">-</span><span class="nv">host</span>.<span class="nv">txt</span>
</pre></div>


<h2 id="iptables">iptables</h2>
<p><img alt="" src="../assets/iptables-netfilter.png" /></p>
<div class="codehilite"><pre><span></span><span class="nv">iptables</span> <span class="o">-</span><span class="nv">t</span> 表名 <span class="o">-</span><span class="nv">A</span> 规则链名 <span class="o">&amp;</span><span class="nv">lt</span><span class="c1">;-i/o 网卡名&amp;gt; -p 协议名 &amp;lt;-s 源IP/源子网&amp;gt; --sport 源端口 &amp;lt;-d 目标IP/目标子网&amp;gt; --dport 目标端口 -j 动作 </span>

<span class="o">-</span><span class="nv">A</span>：向规则链中添加条目； 

<span class="o">-</span><span class="nv">D</span>：从规则链中删除条目； 

<span class="o">-</span><span class="nv">I</span>：向规则链中插入条目； 

<span class="o">-</span><span class="nv">L</span>：显示规则链中已有的条目；



表名包括： 

<span class="nv">raw</span>：高级功能，如：网址过滤。 

<span class="nv">mangle</span>：数据包修改（<span class="nv">QOS</span>），用于实现服务质量。 

<span class="nv">nat</span>：地址转换，用于网关路由器。 

<span class="nv">filter</span>：包过滤，用于防火墙规则。 



规则链名包括： 

<span class="nv">INPUT</span>链：处理输入数据包。

<span class="nv">OUTPUT</span>链：处理输出数据包。 

<span class="nv">PORWARD</span>链：处理转发数据包。 

<span class="nv">PREROUTING</span>链：用于目标地址转换（<span class="nv">DNAT</span>）。 

<span class="nv">POSTOUTING</span>链：用于源地址转换（<span class="nv">SNAT</span>）。 



动作包括： 

<span class="nv">ACCEPT</span>：接收数据包。 

<span class="nv">REJECT</span>：丢弃数据包返回错误。 

<span class="nv">DROP</span>：丢弃数据包不返回错误。 

<span class="nv">REDIRECT</span>：重定向、映射、透明代理。 

<span class="nv">SNAT</span>：源地址转换。 

<span class="nv">DNAT</span>：目标地址转换。 

<span class="nv">MASQUERADE</span>：<span class="nv">IP</span>伪装（<span class="nv">NAT</span>），用于<span class="nv">ADSL</span>。 

<span class="nv">LOG</span>：日志记录。 



清除已有<span class="nv">iptables</span>规则 

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">F</span> 

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">X</span> 

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">Z</span> 

设置<span class="nv">chain</span>默认策略

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">P</span> <span class="nv">INPUT</span> <span class="nv">DROP</span>

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">P</span> <span class="nv">FORWARD</span> <span class="nv">ACCEPT</span>

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">P</span> <span class="nv">OUTPUT</span> <span class="nv">ACCEPT</span>



开放指定的端口 

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">INPUT</span> <span class="o">-</span><span class="nv">m</span> <span class="nv">state</span> <span class="o">--</span><span class="nv">state</span> <span class="nv">ESTABLISHED</span>,<span class="nv">RELATED</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">ACCEPT</span>        允许已建立的或相关连的通行 <span class="ss">(</span>重要规则，必须要有<span class="ss">)</span>

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">INPUT</span> <span class="o">-</span><span class="nv">s</span> <span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span> <span class="o">-</span><span class="nv">d</span> <span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">ACCEPT</span>                   允许本地回环接口<span class="ss">(</span>即运行本机访问本机<span class="ss">)</span> 

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">OUTPUT</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">ACCEPT</span>                                            允许所有本机向外的访问 

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">INPUT</span> <span class="o">-</span><span class="nv">p</span> <span class="nv">tcp</span> <span class="o">--</span><span class="nv">dport</span> <span class="mi">22</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">ACCEPT</span>       <span class="o">--</span><span class="nv">dport</span> <span class="mi">8000</span>:<span class="mi">10000</span>      端口范围               允许访问<span class="mi">22</span>端口    

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">INPUT</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">reject</span>                                             禁止其他未允许的规则访问 

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">FORWARD</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">REJECT</span>                                           禁止其他未允许的规则访问 屏蔽<span class="nv">IP</span>

 <span class="nv">iptables</span> <span class="o">-</span><span class="nv">I</span> <span class="nv">INPUT</span> <span class="o">-</span><span class="nv">s</span> <span class="mi">123</span>.<span class="mi">45</span>.<span class="mi">6</span>.<span class="mi">7</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">DROP</span>                                 屏蔽单个<span class="nv">IP</span>的命令 

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">I</span> <span class="nv">INPUT</span> <span class="o">-</span><span class="nv">s</span> <span class="mi">123</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">0</span><span class="o">/</span><span class="mi">8</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">DROP</span>                                封整个段即从<span class="mi">123</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span>到<span class="mi">123</span>.<span class="mi">255</span>.<span class="mi">255</span>.<span class="mi">254</span>的命令



查看已添加的<span class="nv">iptables</span>规则 

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">L</span> <span class="o">-</span><span class="nv">n</span> <span class="o">-</span><span class="nv">v</span> 



删除规则



<span class="nv">iptables</span> <span class="o">-</span><span class="nv">nL</span> <span class="o">--</span><span class="nv">line</span><span class="o">-</span><span class="nv">number</span>

显示每条规则链的编号



<span class="nv">iptables</span> <span class="o">-</span><span class="nv">D</span> <span class="nv">FORWARD</span> <span class="mi">2</span>

删除<span class="nv">FORWARD</span>链的第<span class="mi">2</span>条规则，编号由上一条得知。如果删除的是<span class="nv">nat</span>表中的链，记得带上<span class="o">-</span><span class="nv">t</span> <span class="nv">nat</span>



<span class="nv">iptables</span> <span class="o">-</span><span class="nv">D</span> <span class="nv">INPUT</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">REJECT</span> <span class="o">--</span><span class="nv">reject</span><span class="o">-</span><span class="nv">with</span> <span class="nv">icmp</span><span class="o">-</span><span class="nv">host</span><span class="o">-</span><span class="nv">prohibited</span>

删除规则的第二种方法，所有选项要与要删除的规则都相同才能删除，否则提示<span class="nv">iptables</span>: <span class="nv">No</span> <span class="nv">chain</span><span class="o">/</span><span class="nv">target</span><span class="o">/</span><span class="nv">match</span> <span class="nv">by</span> <span class="nv">that</span> <span class="nv">name</span>.



丢弃非法连接



<span class="nv">iptables</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">INPUT</span> <span class="o">-</span><span class="nv">m</span> <span class="nv">state</span> –<span class="nv">state</span> <span class="nv">INVALID</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">DROP</span>

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">OUTPUT</span> <span class="o">-</span><span class="nv">m</span> <span class="nv">state</span> –<span class="nv">state</span> <span class="nv">INVALID</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">DROP</span>

<span class="nv">iptables</span><span class="o">-</span><span class="nv">A</span> <span class="nv">FORWARD</span> <span class="o">-</span><span class="nv">m</span> <span class="nv">state</span> –<span class="nv">state</span> <span class="nv">INVALID</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">DROP</span>



<span class="mi">2</span>.<span class="mi">1</span> 端口转发



首先要开启端口转发器必须先修改内核运行参数<span class="nv">ip_forward</span>,打开转发:



# <span class="nv">echo</span> <span class="mi">1</span> <span class="o">&amp;</span><span class="nv">gt</span><span class="c1">; /proc/sys/net/ipv4/ip_forward   //此方法临时生效</span>

或

# <span class="nv">vi</span> <span class="o">/</span><span class="nv">ect</span><span class="o">/</span><span class="nv">sysctl</span>.<span class="nv">conf</span>                      <span class="o">//</span>此方法永久生效

# <span class="nv">sysctl</span> <span class="o">-</span><span class="nv">p</span>



本机端口转发

# <span class="nv">iptables</span> <span class="o">-</span><span class="nv">t</span> <span class="nv">nat</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">PREROUTING</span> <span class="o">-</span><span class="nv">p</span> <span class="nv">tcp</span> <span class="o">-</span><span class="nv">m</span> <span class="nv">tcp</span> <span class="o">--</span><span class="nv">dport</span> <span class="mi">80</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">REDIRECT</span> <span class="o">--</span><span class="nv">to</span><span class="o">-</span><span class="nv">ports</span> <span class="mi">8080</span>

根据 <span class="nv">iptables</span>防火墙原理详解 可知，实际上在数据包进入<span class="nv">INPUT</span>链之前，修改了目标地址（端口），于是不难理解在开放端口时需要设置的是放行<span class="mi">8080</span>端口，无需考虑<span class="mi">80</span>：

# <span class="nv">iptables</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">INPUT</span> <span class="o">-</span><span class="nv">s</span> <span class="mi">172</span>.<span class="mi">29</span>.<span class="mi">88</span>.<span class="mi">0</span><span class="o">/</span><span class="mi">24</span> <span class="o">-</span><span class="nv">p</span> <span class="nv">tcp</span> <span class="o">-</span><span class="nv">m</span> <span class="nv">state</span> <span class="o">--</span><span class="nv">state</span> <span class="nv">NEW</span> <span class="o">-</span><span class="nv">m</span> <span class="nv">tcp</span> <span class="o">--</span><span class="nv">dport</span> <span class="mi">8080</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">ACCEPT</span>

此时外部访问<span class="nv">http</span>的<span class="mi">80</span>端口便可自动转到<span class="mi">8080</span>（浏览器地址栏不会变），而且又具有很高的性能，但如果你通过服务器本地主机的<span class="nv">curl</span>或<span class="nv">firfox</span>浏览器访问<span class="nv">http</span>:<span class="o">//</span><span class="nv">localhost</span>:<span class="mi">80</span>或<span class="nv">http</span>:<span class="o">//</span><span class="nv">doman</span>.<span class="nv">com</span>:<span class="mi">80</span>都是不行（假如你有这样的奇葩需求），这是因为本地数据包产生的目标地址不对，你需要额外添加这条 <span class="nv">OUTPUT</span> 规则：



<span class="nv">iptables</span> <span class="o">-</span><span class="nv">t</span> <span class="nv">nat</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">OUTPUT</span> <span class="o">-</span><span class="nv">p</span> <span class="nv">tcp</span> <span class="o">--</span><span class="nv">dport</span> <span class="mi">80</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">REDIRECT</span> <span class="o">--</span><span class="nv">to</span><span class="o">-</span><span class="nv">ports</span> <span class="mi">8080</span>

下面的规则可以达到同样的效果：



<span class="nv">iptables</span> <span class="o">-</span><span class="nv">t</span> <span class="nv">nat</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">PREROUTING</span> <span class="o">-</span><span class="nv">p</span> <span class="nv">tcp</span> <span class="o">-</span><span class="nv">i</span> <span class="nv">eth0</span> <span class="o">-</span><span class="nv">d</span> $<span class="nv">YOUR_HOST_IP</span> <span class="o">--</span><span class="nv">dport</span> <span class="mi">80</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">DNAT</span> <span class="o">--</span><span class="nv">to</span> $<span class="nv">YOUR_HOST_IP</span>:<span class="mi">8080</span>

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">t</span> <span class="nv">nat</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">OUTPUT</span> <span class="o">-</span><span class="nv">p</span> <span class="nv">tcp</span> <span class="o">-</span><span class="nv">d</span> $<span class="nv">YOUR_HOST_IP</span> <span class="o">--</span><span class="nv">dport</span> <span class="mi">80</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">DNAT</span> <span class="o">--</span><span class="nv">to</span> <span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span>:<span class="mi">8080</span>

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">t</span> <span class="nv">nat</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">OUTPUT</span> <span class="o">-</span><span class="nv">p</span> <span class="nv">tcp</span> <span class="o">-</span><span class="nv">d</span> <span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span>      <span class="o">--</span><span class="nv">dport</span> <span class="mi">80</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">DNAT</span> <span class="o">--</span><span class="nv">to</span> <span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span>:<span class="mi">8080</span>

异机端口转发

有些情况下企业内部网络隔离比较严格，但有一个跨网段访问的情况，此时只要转发用的中转服务器能够与另外的两个<span class="nv">IP</span><span class="ss">(</span>服务器或<span class="nv">PC</span><span class="ss">)</span>通讯就可以使用<span class="nv">iptables</span>实现转发。（端口转发的还有其他方法，请参考 <span class="nv">linux</span>服务器下各种端口转发技巧 ）



要实现的是所有访问 <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">10</span>.<span class="mi">100</span>:<span class="mi">8000</span> 的请求，转发到 <span class="mi">172</span>.<span class="mi">29</span>.<span class="mi">88</span>.<span class="mi">56</span>:<span class="mi">80</span> 上，在 <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">10</span>.<span class="mi">100</span> 是哪个添加规则:



<span class="nv">iptables</span> <span class="o">-</span><span class="nv">t</span> <span class="nv">nat</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">PREROUTING</span> <span class="o">-</span><span class="nv">i</span> <span class="nv">eth0</span> <span class="o">-</span><span class="nv">p</span> <span class="nv">tcp</span> <span class="o">-</span><span class="nv">d</span> <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">10</span>.<span class="mi">100</span> <span class="o">--</span><span class="nv">dport</span> <span class="mi">8000</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">DNAT</span> <span class="o">--</span><span class="nv">to</span><span class="o">-</span><span class="nv">destination</span> <span class="mi">172</span>.<span class="mi">29</span>.<span class="mi">88</span>.<span class="mi">56</span>:<span class="mi">80</span>

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">t</span> <span class="nv">nat</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">POSTROUTING</span> <span class="o">-</span><span class="nv">o</span> <span class="nv">eth0</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">SNAT</span> <span class="o">--</span><span class="nv">to</span><span class="o">-</span><span class="nv">source</span> <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">10</span>.<span class="mi">100</span>

或者

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">t</span> <span class="nv">nat</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">PREROUTING</span> <span class="o">-</span><span class="nv">d</span> <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">10</span>.<span class="mi">100</span> <span class="o">-</span><span class="nv">p</span> <span class="nv">tcp</span> <span class="o">--</span><span class="nv">dport</span> <span class="mi">8000</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">DNAT</span> <span class="o">--</span><span class="nv">to</span> <span class="mi">172</span>.<span class="mi">29</span>.<span class="mi">88</span>.<span class="mi">56</span>:<span class="mi">80</span>

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">t</span> <span class="nv">nat</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">POSTROUTING</span> <span class="o">-</span><span class="nv">d</span> <span class="mi">172</span>.<span class="mi">29</span>.<span class="mi">88</span>.<span class="mi">56</span> <span class="o">-</span><span class="nv">p</span> <span class="nv">tcp</span> <span class="o">--</span><span class="nv">dport</span> <span class="mi">80</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">SNAT</span> <span class="o">--</span><span class="nv">to</span><span class="o">-</span><span class="nv">source</span> <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">10</span>.<span class="mi">100</span>

需要注意的是，如果你的<span class="nv">FORWARD</span>链默认为<span class="nv">DROP</span>，上面所有端口转发都必须建立在<span class="nv">FORWARD</span>链允许通行的情况下：



<span class="nv">iptables</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">FORWARD</span> <span class="o">-</span><span class="nv">d</span> <span class="mi">172</span>.<span class="mi">29</span>.<span class="mi">88</span>.<span class="mi">56</span> <span class="o">-</span><span class="nv">p</span> <span class="nv">tcp</span> <span class="o">--</span><span class="nv">dport</span> <span class="mi">80</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">ACCEPT</span>

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">FORWARD</span> <span class="o">-</span><span class="nv">s</span> <span class="mi">172</span>.<span class="mi">29</span>.<span class="mi">88</span>.<span class="mi">56</span> <span class="o">-</span><span class="nv">p</span> <span class="nv">tcp</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">ACCEPT</span>

<span class="mi">2</span>.<span class="mi">2</span> 记录日志



为<span class="mi">22</span>端口的<span class="nv">INPUT</span>包增加日志功能，插在<span class="nv">input</span>的第<span class="mi">1</span>个规则前面，为避免日志信息塞满<span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">log</span><span class="o">/</span><span class="nv">message</span>，用<span class="o">--</span><span class="nv">limit</span>限制：



<span class="nv">iptables</span> <span class="o">-</span><span class="nv">R</span> <span class="nv">INPUT</span> <span class="mi">1</span> <span class="o">-</span><span class="nv">p</span> <span class="nv">tcp</span> <span class="o">--</span><span class="nv">dport</span> <span class="mi">22</span> <span class="o">-</span><span class="nv">m</span> <span class="nv">limit</span> <span class="o">--</span><span class="nv">limit</span> <span class="mi">3</span><span class="o">/</span><span class="nv">minute</span> <span class="o">--</span><span class="nv">limit</span><span class="o">-</span><span class="nv">burst</span> <span class="mi">8</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">LOG</span>

<span class="nv">vi</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">rsyslog</span>.<span class="nv">conf</span> 编辑日志配置文件，添加<span class="nv">kern</span>.<span class="o">=</span><span class="nv">notice</span> <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">log</span><span class="o">/</span><span class="nv">iptables</span>.<span class="nv">log</span>，可以将日志记录到自定义的文件中。



<span class="nv">service</span> <span class="nv">rsyslog</span> <span class="nv">restart</span> #重启日志服务



<span class="mi">2</span>.<span class="mi">3</span> 防止<span class="nv">DoS</span>攻击

<span class="nv">SYN</span>洪水是攻击者发送海量的<span class="nv">SYN</span>请求到目标服务器上的一种<span class="nv">DoS</span>攻击方法，下面的脚本用于预防轻量级的<span class="nv">DoS</span>攻击：

<span class="nv">ipt</span><span class="o">-</span><span class="nv">tcp</span>.<span class="nv">sh</span>：



<span class="nv">iptables</span> <span class="o">-</span><span class="nv">N</span> <span class="nv">syn</span><span class="o">-</span><span class="nv">flood</span>   <span class="ss">(</span>如果您的防火墙默认配置有“ :<span class="nv">syn</span><span class="o">-</span><span class="nv">flood</span> <span class="o">-</span> [<span class="mi">0</span>:<span class="mi">0</span>] ”则不许要该项，因为重复了<span class="ss">)</span>

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">INPUT</span> <span class="o">-</span><span class="nv">p</span> <span class="nv">tcp</span> <span class="o">--</span><span class="nv">syn</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">syn</span><span class="o">-</span><span class="nv">flood</span>   

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">I</span> <span class="nv">syn</span><span class="o">-</span><span class="nv">flood</span> <span class="o">-</span><span class="nv">p</span> <span class="nv">tcp</span> <span class="o">-</span><span class="nv">m</span> <span class="nv">limit</span> <span class="o">--</span><span class="nv">limit</span> <span class="mi">2</span><span class="o">/</span><span class="nv">s</span> <span class="o">--</span><span class="nv">limit</span><span class="o">-</span><span class="nv">burst</span> <span class="mi">5</span> <span class="o">-</span><span class="nv">j</span> <span class="k">RETURN</span>   

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">syn</span><span class="o">-</span><span class="nv">flood</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">REJECT</span>   

# 防止<span class="nv">DOS</span>太多连接进来,可以允许外网网卡每个<span class="nv">IP</span>最多<span class="mi">15</span>个初始连接,超过的丢弃

# 需要<span class="nv">iptables</span> <span class="nv">v1</span>.<span class="mi">4</span>.<span class="mi">19</span>以上版本：<span class="nv">iptables</span> <span class="o">-</span><span class="nv">V</span> 

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">INPUT</span> <span class="o">-</span><span class="nv">p</span> <span class="nv">tcp</span> <span class="o">--</span><span class="nv">syn</span> <span class="o">-</span><span class="nv">i</span> <span class="nv">eth0</span> <span class="o">--</span><span class="nv">dport</span> <span class="mi">80</span> <span class="o">-</span><span class="nv">m</span> <span class="nv">connlimit</span> <span class="o">--</span><span class="nv">connlimit</span><span class="o">-</span><span class="nv">above</span> <span class="mi">20</span> <span class="o">--</span><span class="nv">connlimit</span><span class="o">-</span><span class="nv">mask</span> <span class="mi">24</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">DROP</span>   

#用<span class="nv">Iptables</span>抵御<span class="nv">DDOS</span> <span class="ss">(</span>参数与上相同<span class="ss">)</span>   

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">INPUT</span> <span class="o">-</span><span class="nv">p</span> <span class="nv">tcp</span> <span class="o">--</span><span class="nv">syn</span> <span class="o">-</span><span class="nv">m</span> <span class="nv">limit</span> <span class="o">--</span><span class="nv">limit</span> <span class="mi">5</span><span class="o">/</span><span class="nv">s</span> <span class="o">--</span><span class="nv">limit</span><span class="o">-</span><span class="nv">burst</span> <span class="mi">10</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">ACCEPT</span>  

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">FORWARD</span> <span class="o">-</span><span class="nv">p</span> <span class="nv">tcp</span> <span class="o">--</span><span class="nv">syn</span> <span class="o">-</span><span class="nv">m</span> <span class="nv">limit</span> <span class="o">--</span><span class="nv">limit</span> <span class="mi">1</span><span class="o">/</span><span class="nv">s</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">ACCEPT</span> 

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">FORWARD</span> <span class="o">-</span><span class="nv">p</span> <span class="nv">icmp</span> <span class="o">-</span><span class="nv">m</span> <span class="nv">limit</span> <span class="o">--</span><span class="nv">limit</span> <span class="mi">2</span><span class="o">/</span><span class="nv">s</span> <span class="o">--</span><span class="nv">limit</span><span class="o">-</span><span class="nv">burst</span> <span class="mi">10</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">ACCEPT</span>

<span class="nv">iptables</span> <span class="o">-</span><span class="nv">A</span> <span class="nv">INPUT</span> <span class="o">-</span><span class="nv">p</span> <span class="nv">icmp</span> <span class="o">--</span><span class="nv">icmp</span><span class="o">-</span><span class="nv">type</span> <span class="mi">0</span> <span class="o">-</span><span class="nv">s</span> <span class="o">!</span> <span class="mi">172</span>.<span class="mi">29</span>.<span class="mi">73</span>.<span class="mi">0</span><span class="o">/</span><span class="mi">24</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">DROP</span>





保存与恢复

<span class="nv">iptables</span><span class="o">-</span><span class="nv">save</span> <span class="o">&amp;</span><span class="nv">gt</span><span class="c1">; iptales.bak</span>

<span class="nv">cat</span> <span class="nv">iptables</span>.<span class="nv">bak</span>  <span class="o">|</span> <span class="nv">iptables</span><span class="o">-</span><span class="nv">restore</span>



<span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">init</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">iptables</span> <span class="nv">save</span>  <span class="ss">(</span>重启后也不会消失<span class="ss">)</span>





<span class="nv">centos</span> <span class="mi">7</span>

<span class="nv">yum</span> <span class="nv">install</span> <span class="o">-</span><span class="nv">y</span> <span class="nv">iptables</span> <span class="nv">iptables</span><span class="o">-</span><span class="nv">services</span> 

<span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">libexec</span><span class="o">/</span><span class="nv">iptables</span><span class="o">/</span><span class="nv">iptables</span>.<span class="nv">init</span>  <span class="nv">save</span>
</pre></div>


<h2 id="logrotate">logrotate</h2>
<div class="codehilite"><pre><span></span><span class="mi">1</span>. <span class="ss">(</span>根据<span class="nv">rotate</span>.<span class="nv">conf</span>的设置进行操作，并显示详细信息。<span class="ss">)</span>
<span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">sbin</span><span class="o">/</span><span class="k">logrotate</span> <span class="o">-</span><span class="nv">v</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="k">logrotate</span>.<span class="nv">conf</span>  

<span class="mi">2</span>. <span class="ss">(</span>根据<span class="nv">rotate</span>.<span class="nv">conf</span>的设置进行执行，并显示详细信息,但是不进行具体操作，<span class="nv">debug</span>模式<span class="ss">)</span>
<span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">sbin</span><span class="o">/</span><span class="k">logrotate</span> <span class="o">-</span><span class="nv">d</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="k">logrotate</span>.<span class="nv">conf</span>  

<span class="mi">3</span>. <span class="ss">(</span>各<span class="nv">log</span>文件的具体执行情况<span class="ss">)</span>
<span class="nv">vi</span> <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="k">logrotate</span>.<span class="nv">status</span> 

<span class="mi">4</span>. <span class="ss">(</span>通过<span class="nv">rpm</span>包安装的软件的<span class="k">logrotate</span>信息会自动添加于此<span class="ss">)</span>
<span class="nv">ls</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="k">logrotate</span>.<span class="nv">d</span><span class="o">/</span>   

添加新的 <span class="nv">vim</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="k">logrotate</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">tomcat</span>
<span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">tomcat_pingtai</span><span class="o">/</span><span class="nv">logs</span><span class="o">/</span><span class="nv">catalina</span>.<span class="nv">out</span> {
   <span class="nv">copytruncate</span>
   <span class="nv">daily</span>
   <span class="nv">dateext</span>
   <span class="nv">rotate</span> <span class="mi">30</span>
   <span class="nv">missingok</span>
}
<span class="nv">logtotate</span> <span class="o">-</span><span class="nv">d</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="k">logrotate</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">tomcat</span>  测试

参数 功能
<span class="nv">compress</span> 通过<span class="nv">gzip</span> 压缩转储以后的日志
<span class="nv">nocompress</span> 不需要压缩时，用这个参数
<span class="nv">copytruncate</span> 用于还在打开中的日志文件，把当前日志备份并截断
<span class="nv">nocopytruncate</span> 备份日志文件但是不截断
<span class="nv">create</span> <span class="nv">mode</span> <span class="nv">owner</span> <span class="nv">group</span> 转储文件，使用指定的文件模式创建新的日志文件
<span class="nv">nocreate</span> 不建立新的日志文件
<span class="nv">delaycompress</span> 和 <span class="nv">compress</span> 一起使用时，转储的日志文件到下一次转储时才压缩
<span class="nv">nodelaycompress</span> 覆盖 <span class="nv">delaycompress</span> 选项，转储同时压缩。
<span class="nv">errors</span> <span class="nv">address</span> 专储时的错误信息发送到指定的<span class="nv">Email</span> 地址
<span class="nv">ifempty</span> 即使是空文件也转储，这个是 <span class="k">logrotate</span> 的缺省选项。
<span class="nv">notifempty</span> 如果是空文件的话，不转储
<span class="nv">mail</span> <span class="nv">address</span> 把转储的日志文件发送到指定的<span class="nv">E</span><span class="o">-</span><span class="nv">mail</span> 地址
<span class="nv">nomail</span> 转储时不发送日志文件
<span class="nv">olddir</span> <span class="nv">directory</span> 转储后的日志文件放入指定的目录，必须和当前日志文件在同一个文件系统
<span class="nv">noolddir</span> 转储后的日志文件和当前日志文件放在同一个目录下
<span class="nv">prerotate</span><span class="o">/</span><span class="nv">endscript</span> 在转储以前需要执行的命令可以放入这个对，这两个关键字必须单独成行
<span class="nv">postrotate</span><span class="o">/</span><span class="nv">endscript</span> 在转储以后需要执行的命令可以放入这个对，这两个关键字必须单独成行
<span class="nv">daily</span> 指定转储周期为每天
<span class="nv">weekly</span> 指定转储周期为每周
<span class="nv">monthly</span> 指定转储周期为每月
<span class="nv">rotate</span> <span class="nv">count</span> 指定日志文件删除之前转储的次数，<span class="mi">0</span> 指没有备份，<span class="mi">5</span> 指保留<span class="mi">5</span> 个备份
<span class="nv">tabootext</span> [<span class="o">+</span>] <span class="nv">list</span> 让<span class="k">logrotate</span> 不转储指定扩展名的文件，缺省的扩展名是：.<span class="nv">rpm</span><span class="o">-</span><span class="nv">orig</span>, .<span class="nv">rpmsave</span>, <span class="nv">v</span>, 和 <span class="o">~</span>
<span class="nv">size</span> <span class="nv">size</span> 当日志文件到达指定的大小时才转储，<span class="nv">Size</span> 可以指定 <span class="nv">bytes</span> <span class="ss">(</span>缺省<span class="ss">)</span>以及<span class="nv">K</span> <span class="ss">(</span><span class="nv">sizek</span><span class="ss">)</span>或者<span class="nv">M</span> <span class="ss">(</span><span class="nv">sizem</span><span class="ss">)</span>.


常见问题：

<span class="mi">1</span>. <span class="nv">log</span> <span class="nv">does</span> <span class="nv">not</span> <span class="nv">need</span> <span class="nv">rotating</span>

    <span class="k">logrotate</span>最容易遇到的问题就是：创建完一个新的<span class="nv">configure</span>以后想用命令<span class="mi">1</span>进行执行查看运行情况时。
    <span class="k">logrotate</span>会提示不需要<span class="nv">rotate</span>。出现原因是，<span class="k">logrotate</span>在对<span class="nv">status</span>未记录的文件进行第一次<span class="nv">rotate</span>时，
    会自动在<span class="nv">status</span>添加一条这个文件的记录，并将操作时间设为当天。因此，接下来程序判断是否有必要对此文件进行
    <span class="nv">rotate</span>时会发现这个文件今天已经操作过了，就不进行相关操作了。
    解决：第一次执行后，运行命令<span class="mi">3</span>，把对应文件的日期改为昨天，再次运行。或者可以在运行时用<span class="o">-</span><span class="nv">s</span>来指定<span class="nv">status</span>文件,然后进行修改。

<span class="mi">2</span>. 一些<span class="nv">log</span>文件莫名的被<span class="nv">rotate</span>

    这可能是由于相关软件是通过<span class="nv">rpm</span>安装的，安装后自动将自定义的<span class="nv">conf</span>文件放到<span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="k">logrotate</span>.<span class="nv">d</span><span class="o">/</span>下，并通过<span class="nv">cron</span>.<span class="nv">daily</span>自动执行。
    解决：删除<span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="k">logrotate</span>.<span class="nv">d</span><span class="o">/</span>下相关的文件

<span class="mi">3</span>.  <span class="nv">compress</span>、<span class="nv">copytruncate</span>、<span class="nv">delaycompress</span>、<span class="nv">dateext</span>
    几个选项的执行顺序：
首先程序先判断是否有昨天的文件<span class="ss">(</span><span class="nv">name</span><span class="o">-</span><span class="mi">20090713</span><span class="ss">)</span>未压缩，有则压缩，没有则跳过这一步
然后，程序判断是否要对<span class="nv">log</span>进行<span class="nv">rotate</span>，需要则进行复制截断。命名为<span class="nv">name</span><span class="o">-</span><span class="mi">20090714</span>
最后，程序判断现有压缩包的个数是否超过最大值<span class="ss">(</span>即<span class="nv">rotate</span> <span class="nv">n</span>的值<span class="ss">)</span>,如果超过则把最老的包进行删除。
</pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../source/" title="source" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                source
              </span>
            </div>
          </a>
        
        
          <a href="../linux-base/" title="linux-base" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                linux-base
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>