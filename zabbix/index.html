



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>zabbix - mkdocs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.30686662.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#docker" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="mkdocs" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              mkdocs
            </span>
            <span class="md-header-nav__topic">
              
                zabbix
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href=".." class="md-tabs__link">
        home
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../python-base/" class="md-tabs__link">
          python
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../nginx/" class="md-tabs__link">
          service
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../mysql/" class="md-tabs__link">
          database
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../open-falcon/" class="md-tabs__link md-tabs__link--active">
          monitor
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../tcp-issue/" class="md-tabs__link">
          basis
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="mkdocs" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    mkdocs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="home" class="md-nav__link">
      home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      python
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        python
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../python-base/" title="python-base" class="md-nav__link">
      python-base
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-lib/" title="python-lib" class="md-nav__link">
      python-lib
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-lib2/" title="python-lib2" class="md-nav__link">
      python-lib2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-web/" title="python-web" class="md-nav__link">
      python-web
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-other/" title="python-other" class="md-nav__link">
      python-other
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      service
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        service
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../nginx/" title="nginx" class="md-nav__link">
      nginx
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../nginx2/" title="nginx2" class="md-nav__link">
      nginx2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../apache/" title="apache" class="md-nav__link">
      apache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../saltstack/" title="saltstack" class="md-nav__link">
      saltstack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tomcat/" title="tomcat" class="md-nav__link">
      tomcat
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ansible/" title="ansible" class="md-nav__link">
      ansible
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../trafficserver/" title="trafficserver" class="md-nav__link">
      trafficserver
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../haproxy/" title="haproxy" class="md-nav__link">
      haproxy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../docker/" title="docker" class="md-nav__link">
      docker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../varnish/" title="varnish" class="md-nav__link">
      varnish
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../bind/" title="bind" class="md-nav__link">
      bind
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lvs/" title="lvs" class="md-nav__link">
      lvs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../log-analysis/" title="log-analysis" class="md-nav__link">
      log-analysis
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      database
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        database
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../mysql/" title="mysql" class="md-nav__link">
      mysql
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mysql2/" title="mysql2" class="md-nav__link">
      mysql2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../memcached/" title="memcached" class="md-nav__link">
      memcached
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../redis/" title="redis" class="md-nav__link">
      redis
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mongodb/" title="mongodb" class="md-nav__link">
      mongodb
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../hadoop/" title="hadoop" class="md-nav__link">
      hadoop
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../postgresql/" title="postgresql" class="md-nav__link">
      postgresql
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      monitor
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        monitor
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../open-falcon/" title="open-falcon" class="md-nav__link">
      open-falcon
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        zabbix
      </label>
    
    <a href="./" title="zabbix" class="md-nav__link md-nav__link--active">
      zabbix
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#docker" class="md-nav__link">
    过滤docker无用分区
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mysql" class="md-nav__link">
    监控mysql
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mongo" class="md-nav__link">
    监控mongo
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fping-key" class="md-nav__link">
    fping key
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    连续报警
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx" class="md-nav__link">
    区分域名统计nginx
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#redis" class="md-nav__link">
    监控redis
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zabbix" class="md-nav__link">
    zabbix日报
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    微信告警
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx_1" class="md-nav__link">
    监控nginx
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zabbix_1" class="md-nav__link">
    zabbix安装
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#http" class="md-nav__link">
    http不同时间监控
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#agent" class="md-nav__link">
    agent安装
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    清理历史数据
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zabbix2/" title="zabbix2" class="md-nav__link">
      zabbix2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../netdata/" title="netdata" class="md-nav__link">
      netdata
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      basis
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        basis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../tcp-issue/" title="tcp-issue" class="md-nav__link">
      tcp-issue
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../git-svn/" title="git-svn" class="md-nav__link">
      git-svn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../vpn/" title="vpn" class="md-nav__link">
      vpn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../shell/" title="shell" class="md-nav__link">
      shell
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../disk/" title="disk" class="md-nav__link">
      disk
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../filesystem/" title="filesystem" class="md-nav__link">
      filesystem
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../source/" title="source" class="md-nav__link">
      source
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../command/" title="command" class="md-nav__link">
      command
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../linux-base/" title="linux-base" class="md-nav__link">
      linux-base
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../linux-soft/" title="linux-soft" class="md-nav__link">
      linux-soft
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../other/" title="other" class="md-nav__link">
      other
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#docker" class="md-nav__link">
    过滤docker无用分区
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mysql" class="md-nav__link">
    监控mysql
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mongo" class="md-nav__link">
    监控mongo
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fping-key" class="md-nav__link">
    fping key
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    连续报警
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx" class="md-nav__link">
    区分域名统计nginx
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#redis" class="md-nav__link">
    监控redis
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zabbix" class="md-nav__link">
    zabbix日报
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    微信告警
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx_1" class="md-nav__link">
    监控nginx
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zabbix_1" class="md-nav__link">
    zabbix安装
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#http" class="md-nav__link">
    http不同时间监控
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#agent" class="md-nav__link">
    agent安装
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    清理历史数据
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>zabbix</h1>
                
                <h2 id="docker">过滤docker无用分区</h2>
<p>zabbix自带的自动发现文件系统的LLD能够发现系统内所有的分区，但是有些机器上跑的docker分区也同时被监控到了。然而监控到docker这些分区全是not supported的，网卡类似</p>
<p>设置zabbix的正则  Administration --&gt;  General  右上角选择 Regular expressions 添加</p>
<p><img alt="" src="../assets/zabbix1.png" /></p>
<p>修改linux  Discovery list 模板</p>
<p><img alt="" src="../assets/zabbix2.png" /></p>
<p>网卡的可以直接修改Network interfaces for discovery</p>
<p><img alt="" src="../assets/zabbix3.png" /></p>
<p>这个正则的意思是过滤字符串不包含/var/lib/docker/devicemapper/mnt/，且区分大小。</p>
<p>这里需要说一下表达式5种类型：</p>
<p>Character string  included        #模糊匹配字符串</p>
<p>Any character string included    #模糊匹配多个字符串，可以用逗号（，）,点（.）,斜杠（/）作分隔符</p>
<p>Character string not included    #模糊不匹配字符串</p>
<p>Result is TRUE        #精确匹配，为真</p>
<p>Result is FALSE        #精确匹配，为假设置zabbix的正则  Administration --&gt;  General  右上角选择 Regular expressions 添加</p>
<h2 id="mysql">监控mysql</h2>
<div class="codehilite"><pre><span></span>使用自带的模板
在<span class="nv">zabbix</span> <span class="nv">agent</span>操作
<span class="nv">vim</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span>.<span class="nv">my</span>.<span class="nv">cnf</span>
[<span class="nv">mysql</span>]
<span class="nv">host</span>     <span class="o">=</span> <span class="nv">localhost</span>
<span class="nv">user</span>     <span class="o">=</span> <span class="nv">root</span>
<span class="nv">password</span> <span class="o">=</span> <span class="nv">xxx</span>
<span class="nv">port</span> <span class="o">=</span> <span class="mi">3326</span>
<span class="nv">socket</span> <span class="o">=</span> <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">mysql</span><span class="o">/</span><span class="nv">mysql3326</span>.<span class="nv">sock</span>
[<span class="nv">mysqladmin</span>]
<span class="nv">host</span>     <span class="o">=</span> <span class="nv">localhost</span>
<span class="nv">user</span>     <span class="o">=</span> <span class="nv">root</span>
<span class="nv">password</span> <span class="o">=</span> <span class="nv">xxxx</span>
<span class="nv">port</span> <span class="o">=</span> <span class="mi">3326</span>
<span class="nv">socket</span> <span class="o">=</span> <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">mysql</span><span class="o">/</span><span class="nv">mysql3326</span>.<span class="nv">sock</span>

<span class="nv">sed</span> <span class="o">-</span><span class="nv">i</span> <span class="s1">&#39;</span><span class="s">s@/var/lib/zabbix@/etc/zabbix@g</span><span class="s1">&#39;</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">zabbix_agentd</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">userparameter_mysql</span>.<span class="nv">conf</span>
<span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">init</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">-</span><span class="nv">agent</span> <span class="nv">restart</span>

之后在<span class="nv">web</span>界面添加<span class="nv">mysql</span>模板

<span class="nv">mysql</span>主从监控
<span class="nv">vim</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">zabbix_agentd</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">userparameter_mysql</span>.<span class="nv">conf</span>
<span class="nv">UserParameter</span><span class="o">=</span><span class="nv">mysql</span>.<span class="nv">replication</span>,<span class="nv">echo</span> <span class="s2">&quot;</span><span class="s">show slave status\G;</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">HOME</span><span class="o">=/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">zabbix</span> <span class="nv">mysql</span> <span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">E</span> 
 <span class="s2">&quot;</span><span class="s">Slave_IO_Running|Slave_SQL_Running</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">awk</span> <span class="s1">&#39;</span><span class="s">{print $$2}</span><span class="s1">&#39;</span><span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">c</span> <span class="nv">Yes</span>

<span class="nv">zabbix_get</span> <span class="o">-</span><span class="nv">s</span> <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">100</span>.<span class="mi">223</span> <span class="o">-</span><span class="nv">k</span> <span class="s2">&quot;</span><span class="s">mysql.replication</span><span class="s2">&quot;</span>
如果上面返回的是<span class="mi">2</span>，那么是正常,代表<span class="nv">Slave_IO_Running</span>和<span class="nv">Slave_SQL_Running</span>两个状态都是<span class="nv">Yes</span> 其他值均不正常。


<span class="o">----------------------------------------------------------</span>

<span class="nv">MySQL</span>的监控有很多种方案，如果你已经使用了<span class="nv">Zabbix</span>作为监控系统，那么集成进来就非常合适。而且使用<span class="nv">Zabbix</span>监控<span class="nv">MySQL</span>是
比较容易的，<span class="nv">Zabbix</span>官方也自带了<span class="nv">MySQL</span>监控模板，但是生产环境推荐使用<span class="nv">percona</span>的监控插件。
<span class="nv">https</span>:<span class="o">//</span><span class="nv">www</span>.<span class="nv">percona</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">doc</span><span class="o">/</span><span class="nv">percona</span><span class="o">-</span><span class="nv">monitoring</span><span class="o">-</span><span class="nv">plugins</span><span class="o">/</span><span class="mi">1</span>.<span class="mi">1</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">index</span>.<span class="nv">html</span>

下面让我们动手来完成添加一台<span class="nv">MySQL</span>数据库的监控工作。

<span class="mi">1</span>.安装<span class="nv">percona</span>仓库
# <span class="nv">rpm</span> <span class="o">-</span><span class="nv">ivh</span> <span class="nv">http</span>:<span class="o">//</span><span class="nv">www</span>.<span class="nv">percona</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">downloads</span><span class="o">/</span><span class="nv">percona</span><span class="o">-</span><span class="nv">release</span><span class="o">/</span><span class="nv">redhat</span><span class="o">/</span><span class="mi">0</span>.<span class="mi">1</span><span class="o">-</span><span class="mi">3</span><span class="o">/</span><span class="nv">percona</span><span class="o">-</span><span class="nv">release</span><span class="o">-</span><span class="mi">0</span>.<span class="mi">1</span><span class="o">-</span><span class="mi">3</span>.<span class="nv">noarch</span>.<span class="nv">rpm</span>

<span class="mi">2</span>.部署监控环境
<span class="nv">percona</span>的监控插件是<span class="nv">php</span>编写的。通过<span class="nv">php</span>连接<span class="nv">mysql</span>来获取相关的数据，所以需要你在本地安装<span class="nv">zabbix</span> <span class="nv">agent</span>的同时，部署<span class="nv">php</span>和<span class="nv">php</span><span class="o">-</span><span class="nv">mysql</span>。
[<span class="nv">root</span>@<span class="nv">linux</span><span class="o">-</span><span class="nv">node1</span> <span class="o">~</span>]# <span class="nv">yum</span> <span class="nv">install</span> <span class="nv">zabbix22</span><span class="o">-</span><span class="nv">agentphp</span> <span class="nv">php</span><span class="o">-</span><span class="nv">mysql</span>

<span class="mi">3</span>.安装<span class="nv">percona</span>的<span class="nv">zabbix</span>模版
[<span class="nv">root</span>@<span class="nv">linux</span><span class="o">-</span><span class="nv">node1</span> <span class="o">~</span>]# <span class="nv">yum</span> <span class="nv">install</span> <span class="o">-</span><span class="nv">ypercona</span><span class="o">-</span><span class="nv">zabbix</span><span class="o">-</span><span class="nv">templates</span>
[<span class="nv">root</span>@<span class="nv">linux</span><span class="o">-</span><span class="nv">node1</span> <span class="o">~</span>]# <span class="nv">rpm</span> <span class="o">-</span><span class="nv">qlpercona</span><span class="o">-</span><span class="nv">zabbix</span><span class="o">-</span><span class="nv">templates</span>  
<span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">percona</span>
<span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">percona</span><span class="o">/</span><span class="nv">scripts</span>
<span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">percona</span><span class="o">/</span><span class="nv">scripts</span><span class="o">/</span><span class="nv">get_mysql_stats_wrapper</span>.<span class="nv">sh</span>
<span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">percona</span><span class="o">/</span><span class="nv">scripts</span><span class="o">/</span><span class="nv">ss_get_mysql_stats</span>.<span class="nv">php</span>
<span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">percona</span><span class="o">/</span><span class="nv">templates</span>
<span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">percona</span><span class="o">/</span><span class="nv">templates</span><span class="o">/</span><span class="nv">userparameter_percona_mysql</span>.<span class="nv">conf</span>
<span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">percona</span><span class="o">/</span><span class="nv">templates</span><span class="o">/</span><span class="nv">zabbix_agent_template_percona_mysql_server_ht_2</span>.<span class="mi">0</span>.<span class="mi">9</span><span class="o">-</span><span class="nv">sver1</span>.<span class="mi">1</span>.<span class="mi">6</span>.<span class="nv">xml</span>
    可以看到他的组成部分有一个<span class="nv">shell</span>脚本，一个<span class="nv">php</span>脚本，一个<span class="nv">zabbix</span>的配置文件，和一个<span class="nv">Zabbix</span> 模版的<span class="nv">xml</span>。下面我们需要引用
    配置文件，并在<span class="nv">Zabbix</span>上来导入该模版。
# <span class="nv">vim</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">zabbix_agentd</span>.<span class="nv">conf</span>
<span class="k">Include</span><span class="o">=/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">zabbix_agentd</span>.<span class="nv">conf</span>.<span class="nv">d</span><span class="o">/</span>
# <span class="nv">mkdir</span><span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">zabbix_agentd</span>.<span class="nv">conf</span>.<span class="nv">d</span><span class="o">/</span>

<span class="mi">4</span>.复制用户自定义配置项到<span class="nv">Zabbix</span>配置目录
# <span class="nv">cp</span> <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">percona</span><span class="o">/</span><span class="nv">templates</span><span class="o">/</span><span class="nv">userparameter_percona_mysql</span>.<span class="nv">conf</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">zabbix_agentd</span>.<span class="nv">conf</span>.<span class="nv">d</span><span class="o">/</span>

<span class="mi">5</span>.让<span class="nv">PHP</span>可以连接到<span class="nv">MySQL</span>上
# <span class="nv">vim</span> <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">percona</span><span class="o">/</span><span class="nv">scripts</span><span class="o">/</span><span class="nv">ss_get_mysql_stats</span>.<span class="nv">php</span>.<span class="nv">cnf</span>

<span class="o">&lt;</span>?<span class="nv">php</span>
$<span class="nv">mysql_user</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">root</span><span class="s1">&#39;</span><span class="c1">;</span>
$<span class="nv">mysql_pass</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">s3cret</span><span class="s1">&#39;</span><span class="c1">;   //设置为你mysql的相关用户名和密码。</span>

<span class="mi">6</span>.测试监控脚本
# <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">percona</span><span class="o">/</span><span class="nv">scripts</span><span class="o">/</span><span class="nv">get_mysql_stats_wrapper</span>.<span class="nv">sh</span> <span class="nv">gg</span>

<span class="mi">7</span>.修改监控脚本
默认情况下，监控<span class="nv">MySQL</span>主从的，直接是硬编码在<span class="nv">get_mysql_stats_wrapper</span>.<span class="nv">sh</span>中。如果你的<span class="nv">mysql</span>安装路径或者<span class="nv">socket</span>不同，需
要手动修改下才可以使用。如果是从库，测试，返回<span class="mi">1</span>，证明该脚本正常。
# <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">percona</span><span class="o">/</span><span class="nv">scripts</span><span class="o">/</span><span class="nv">get_mysql_stats_wrapper</span>.<span class="nv">sh</span> <span class="nv">running</span><span class="o">-</span><span class="nv">slave</span>
<span class="mi">1</span>

<span class="mi">8</span>.导入<span class="nv">zabbix</span>模版
将<span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">percona</span><span class="o">/</span><span class="nv">templates</span><span class="o">/</span><span class="nv">zabbix_agent_template_percona_mysql_server_ht_2</span>.<span class="mi">0</span>.<span class="mi">9</span><span class="o">-</span><span class="nv">sver1</span>.<span class="mi">1</span>.<span class="mi">6</span>.<span class="nv">xml</span>下载到本
地，然后在<span class="nv">zabbix</span>上导入
<span class="nv">Configuration</span> <span class="o">-&gt;</span> <span class="nv">Templates</span> <span class="o">-&gt;</span> <span class="nv">Import</span>


下面你就可以给你的<span class="nv">MySQL</span>数据库指定监控模板了，由于篇幅原因就不在截图，相信这难不倒你！

生产环境的注意事项


<span class="nv">MySQL</span>监控用户授权
在我们监控<span class="nv">MySQL</span>的时候，需要连接到<span class="nv">MySQL</span>数据库，但是在进行用户授权的时候，要遵循权限最小化的原则，分配最简单够用的权限即
可，下面是我给生产<span class="nv">MySQL</span>的监控用户授权。
<span class="nv">mysql</span><span class="o">&gt;</span> <span class="nv">grant</span> <span class="nv">select</span>,<span class="nv">process</span>,<span class="nv">replicationclient</span> <span class="nv">on</span> <span class="o">*</span>.<span class="o">*</span> <span class="nv">to</span> <span class="nv">monitor</span>@<span class="s1">&#39;</span><span class="s">192.168.1.11</span><span class="s1">&#39;</span> <span class="nv">identified</span> <span class="nv">by</span> <span class="s1">&#39;</span><span class="s">monitor@xx</span><span class="s1">&#39;</span><span class="c1">;</span>
<span class="nv">mysql</span><span class="o">&gt;</span> <span class="nv">flush</span> <span class="nv">privileges</span><span class="c1">;</span>

<span class="nv">process</span>通过这个权限，用户可以执行<span class="nv">SHOWPROCESSLIST</span>和<span class="nv">KILL</span>命令。默认情况下，每个用户都可以执行<span class="k">SHOW</span> <span class="nv">PROCESSLIST</span>命令，但
是只能查询本用户的进程。
<span class="nv">replication</span> <span class="nv">client</span>拥有此权限可以查询<span class="nv">master</span> <span class="nv">server</span>、<span class="nv">slave</span> <span class="nv">server</span>状态。

彻底清除<span class="nv">MySQL</span> <span class="nv">Slave</span>信息
在生产环境，<span class="nv">MySQL</span> <span class="nv">Master</span>和<span class="nv">Slave</span>进行主从切换的时候，<span class="nv">Slave</span>成功升级为主库，那么这个时候就需要彻底清理从库的信息，不然监
控系统会认为这台服务器是<span class="nv">Slave</span>，而且会报主从同步失败。
    其实非常的简单，只需要以下两步：
<span class="nv">stop</span> <span class="nv">slave</span><span class="c1">;</span>
<span class="nv">reset</span> <span class="nv">slave</span> <span class="nv">all</span><span class="c1">;</span>
   <span class="nv">RESET</span> <span class="nv">SLAVE</span> <span class="nv">ALL</span>是清除从库的同步复制信息、包括连接信息和二进制文件名、位置。
   从库上执行这个命令后，使用<span class="k">show</span> <span class="nv">slave</span> <span class="nv">status</span>将不会有输出。
</pre></div>


<h2 id="mongo">监控mongo</h2>
<div class="codehilite"><pre><span></span><span class="mi">1</span>、配置<span class="nv">zabbix</span>自定义用户<span class="nv">key</span>
<span class="nv">vim</span> <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">zabbix_agentd</span>.<span class="nv">conf</span>
<span class="nv">UserParameter</span><span class="o">=</span><span class="nv">MongoDB</span>.<span class="nv">Status</span>[<span class="o">*</span>],<span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">echo</span> <span class="s2">&quot;</span><span class="s">db.serverStatus().$1</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">mongodb</span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">mongo</span> <span class="nv">admin</span> <span class="o">|</span> 
<span class="nv">grep</span> <span class="s2">&quot;</span><span class="s">\&lt;$2\&gt;</span><span class="s2">&quot;</span><span class="o">|</span> <span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span> : <span class="s1">&#39;</span><span class="s">{print $$2}</span><span class="s1">&#39;</span><span class="o">|</span><span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span> , <span class="s1">&#39;</span><span class="s">{print $$1}</span><span class="s1">&#39;</span>
<span class="nv">db</span>.<span class="nv">serverStatus</span><span class="ss">()</span>.<span class="mh">$1</span>的结果为<span class="mi">1</span>行时（兼容上面的）
<span class="nv">MongoDB</span>.<span class="nv">Status</span>[<span class="o">*</span>],<span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">echo</span> <span class="s2">&quot;</span><span class="s">db.serverStatus().$1</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">mongodb</span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">mongo</span> <span class="nv">admin</span> <span class="o">--</span><span class="nv">port</span> <span class="mi">10040</span> <span class="o">-</span><span class="nv">u</span>
 <span class="nv">admin</span> <span class="o">-</span><span class="nv">p</span> <span class="s1">&#39;</span><span class="s">f8hIXm3g?</span><span class="s1">&#39;</span> <span class="o">|</span> <span class="nv">grep</span> <span class="s2">&quot;</span><span class="s">\&lt;$2\&gt;</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">sed</span> <span class="s1">&#39;</span><span class="s">s/,/</span><span class="se">\n</span><span class="s">/g</span><span class="s1">&#39;</span> <span class="o">|</span><span class="nv">grep</span> <span class="s2">&quot;</span><span class="s">\&lt;$2\&gt;</span><span class="s2">&quot;</span><span class="o">|</span> <span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span> : <span class="s1">&#39;</span><span class="s">{print $$2}</span><span class="s1">&#39;</span><span class="o">|</span><span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span> , <span class="s1">&#39;</span><span class="s">{print $$1}</span><span class="s1">&#39;</span>

上面是通过<span class="nv">db</span>.<span class="nv">serverStatus</span><span class="ss">()</span>来获取服务器状态
其中<span class="mh">$1</span>表示第一个参数
<span class="nv">grep</span> <span class="mh">$2</span>的时候要加上锚地符 <span class="s2">&quot;</span><span class="s">\&lt;</span><span class="s2">&quot;</span> 和 <span class="s2">&quot;</span><span class="s">\&gt;</span><span class="s2">&quot;</span>，因为有的对象名可能部分相同
<span class="nv">echo</span> <span class="s2">&quot;</span><span class="s">db.serverStatus()</span><span class="s2">&quot;</span> <span class="o">|/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">mongodb</span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">mongo</span> <span class="o">--</span><span class="nv">port</span> <span class="mi">10040</span> <span class="o">--</span><span class="nv">quiet</span>
{
    <span class="s2">&quot;</span><span class="s">host</span><span class="s2">&quot;</span> : <span class="s2">&quot;</span><span class="s">TENCENT64.site</span><span class="s2">&quot;</span>, <span class="o">--</span><span class="nv">server</span>的<span class="nv">hostname</span>
    <span class="s2">&quot;</span><span class="s">version</span><span class="s2">&quot;</span> : <span class="s2">&quot;</span><span class="s">2.0.5</span><span class="s2">&quot;</span>, <span class="o">--</span><span class="nv">mongo</span>版本
    <span class="s2">&quot;</span><span class="s">process</span><span class="s2">&quot;</span> : <span class="s2">&quot;</span><span class="s">mongod</span><span class="s2">&quot;</span>, <span class="o">--</span>进程名
    <span class="s2">&quot;</span><span class="s">uptime</span><span class="s2">&quot;</span> : <span class="mi">1238418</span>, <span class="o">--</span>启动时间（单位：<span class="nv">S</span>）
    <span class="s2">&quot;</span><span class="s">uptimeEstimate</span><span class="s2">&quot;</span> : <span class="mi">1230730</span>, <span class="o">--</span>基于<span class="nv">MongoDB</span>内部粗粒度定时器的运行时间
    <span class="s2">&quot;</span><span class="s">localTime</span><span class="s2">&quot;</span> : <span class="nv">ISODate</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">2012-09-14T09:09:52.657Z</span><span class="s2">&quot;</span><span class="ss">)</span>, <span class="o">--</span><span class="nv">server</span>的本地时间
    <span class="s2">&quot;</span><span class="s">globalLock</span><span class="s2">&quot;</span> : {
        <span class="s2">&quot;</span><span class="s">totalTime</span><span class="s2">&quot;</span> : <span class="mi">1238418105923</span>, <span class="o">--</span>全局锁创建的时间（单位：<span class="nv">ms</span> 微秒）
        <span class="s2">&quot;</span><span class="s">lockTime</span><span class="s2">&quot;</span> : <span class="mi">75055831911</span>, <span class="o">--</span>全局锁保持的时间（单位：<span class="nv">ms</span> 微秒）
        <span class="s2">&quot;</span><span class="s">ratio</span><span class="s2">&quot;</span> : <span class="mi">0</span>.<span class="mi">06060621332329477</span>, <span class="o">--</span><span class="nv">lockTime</span>和<span class="nv">totalTime</span>的比
        <span class="s2">&quot;</span><span class="s">currentQueue</span><span class="s2">&quot;</span> : {
            <span class="s2">&quot;</span><span class="s">total</span><span class="s2">&quot;</span> : <span class="mi">0</span>, <span class="o">--</span>等待全局锁的队列中操作数目
            <span class="s2">&quot;</span><span class="s">readers</span><span class="s2">&quot;</span> : <span class="mi">0</span>, <span class="o">--</span>等待读锁的队列中操作数目
            <span class="s2">&quot;</span><span class="s">writers</span><span class="s2">&quot;</span> : <span class="mi">0</span> <span class="o">--</span>等待写锁的队列中操作数目
        },
        <span class="s2">&quot;</span><span class="s">activeClients</span><span class="s2">&quot;</span> : {
            <span class="s2">&quot;</span><span class="s">total</span><span class="s2">&quot;</span> : <span class="mi">1</span>, <span class="o">--</span>连接到<span class="nv">server</span>的当前活动<span class="nv">client</span>数目
            <span class="s2">&quot;</span><span class="s">readers</span><span class="s2">&quot;</span> : <span class="mi">1</span>, <span class="o">--</span>执行读操作的当前活动<span class="nv">client</span>数目
            <span class="s2">&quot;</span><span class="s">writers</span><span class="s2">&quot;</span> : <span class="mi">0</span> <span class="o">--</span>执行写操作的当前活动<span class="nv">client</span>数目
        }
    },
    <span class="s2">&quot;</span><span class="s">mem</span><span class="s2">&quot;</span> : {
        <span class="s2">&quot;</span><span class="s">bits</span><span class="s2">&quot;</span> : <span class="mi">64</span>, <span class="o">--</span><span class="mi">64</span>位机器
        <span class="s2">&quot;</span><span class="s">resident</span><span class="s2">&quot;</span> : <span class="mi">18363</span>, <span class="o">--</span>占用物理内存量。
        <span class="s2">&quot;</span><span class="s">virtual</span><span class="s2">&quot;</span> : <span class="mi">478810</span>, <span class="o">--</span>占用的虚拟内存量
        <span class="s2">&quot;</span><span class="s">supported</span><span class="s2">&quot;</span> : <span class="nv">true</span>, <span class="o">--</span>是否支持扩展内存
        <span class="s2">&quot;</span><span class="s">mapped</span><span class="s2">&quot;</span> : <span class="mi">233311</span>, <span class="o">--</span>映射到内存的数据文件大小，很接近于你的所有数据库大小。
        <span class="s2">&quot;</span><span class="s">mappedWithJournal</span><span class="s2">&quot;</span> : <span class="mi">466622</span>,
        <span class="s2">&quot;</span><span class="s">note</span><span class="s2">&quot;</span> : <span class="s2">&quot;</span><span class="s">virtual minus mapped is large. could indicate a memory leak</span><span class="s2">&quot;</span>
    },
    <span class="s2">&quot;</span><span class="s">connections</span><span class="s2">&quot;</span> : {
        <span class="s2">&quot;</span><span class="s">current</span><span class="s2">&quot;</span> : <span class="mi">737</span>, <span class="o">--</span>当前活动连接量。连接到<span class="nv">server</span>的当前活跃连接数目
        <span class="s2">&quot;</span><span class="s">available</span><span class="s2">&quot;</span> : <span class="mi">82</span> <span class="o">--</span>剩余空闲连接量。剩余的可用连接数目
    },
    <span class="s2">&quot;</span><span class="s">extra_info</span><span class="s2">&quot;</span> : {
        <span class="s2">&quot;</span><span class="s">note</span><span class="s2">&quot;</span> : <span class="s2">&quot;</span><span class="s">fields vary by platform</span><span class="s2">&quot;</span>,
        <span class="s2">&quot;</span><span class="s">heap_usage_bytes</span><span class="s2">&quot;</span> : <span class="mi">3838448</span>, <span class="o">--</span>此过程中所有的堆字节数目。仅适用于<span class="nv">Linux</span>
        <span class="s2">&quot;</span><span class="s">page_faults</span><span class="s2">&quot;</span> : <span class="mi">31058356</span> <span class="o">--</span>此过程中访问内存中页面失败的总次数。仅适用于<span class="nv">Linux</span>
    },
    <span class="s2">&quot;</span><span class="s">indexCounters</span><span class="s2">&quot;</span> : {
        <span class="s2">&quot;</span><span class="s">btree</span><span class="s2">&quot;</span> : {
            <span class="s2">&quot;</span><span class="s">accesses</span><span class="s2">&quot;</span> : <span class="mi">68229146</span>, <span class="o">--</span><span class="nv">Btree</span>索引的访问次数（索引被访问量）
            <span class="s2">&quot;</span><span class="s">hits</span><span class="s2">&quot;</span> : <span class="mi">68229146</span>, <span class="o">--</span>内存中的<span class="nv">Btree</span>页的数目。（索引命中量）
            <span class="s2">&quot;</span><span class="s">misses</span><span class="s2">&quot;</span> : <span class="mi">0</span>, <span class="o">--</span>内存中不存在的<span class="nv">Btree</span>也数目。（索引偏差量）（索引内存访问失败次数）
            <span class="s2">&quot;</span><span class="s">resets</span><span class="s2">&quot;</span> : <span class="mi">0</span>, <span class="o">--</span>索引计数器被重置为<span class="mi">0</span>的次数
            <span class="s2">&quot;</span><span class="s">missRatio</span><span class="s2">&quot;</span> : <span class="mi">0</span> <span class="o">--</span>索引偏差率（未命中率）
        }
    },
    <span class="s2">&quot;</span><span class="s">backgroundFlushing</span><span class="s2">&quot;</span> : {
        <span class="s2">&quot;</span><span class="s">flushes</span><span class="s2">&quot;</span> : <span class="mi">20640</span>, <span class="o">--</span>数据库刷新写到磁盘的次数
        <span class="s2">&quot;</span><span class="s">total_ms</span><span class="s2">&quot;</span> : <span class="mi">2453287</span>, <span class="o">--</span>数据库刷新数据到磁盘花费的微秒数
        <span class="s2">&quot;</span><span class="s">average_ms</span><span class="s2">&quot;</span> : <span class="mi">118</span>.<span class="mi">8608042635659</span>, <span class="o">--</span>执行单次刷新花费的平均微秒数
        <span class="s2">&quot;</span><span class="s">last_ms</span><span class="s2">&quot;</span> : <span class="mi">1</span>, <span class="o">--</span>最后一次执行完成刷新数据到磁盘花费的微秒数
        <span class="s2">&quot;</span><span class="s">last_finished</span><span class="s2">&quot;</span> : <span class="nv">ISODate</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">2012-09-14T09:09:35.656Z</span><span class="s2">&quot;</span><span class="ss">)</span> <span class="o">--</span>当最后一次刷新数据完成时的时间戳
    },
    <span class="s2">&quot;</span><span class="s">cursors</span><span class="s2">&quot;</span> : {
        <span class="s2">&quot;</span><span class="s">totalOpen</span><span class="s2">&quot;</span> : <span class="mi">0</span>, <span class="o">--</span><span class="nv">server</span>为<span class="nv">client</span>保持的游标（<span class="nv">cursor</span>）总数
        <span class="s2">&quot;</span><span class="s">clientCursors_size</span><span class="s2">&quot;</span> : <span class="mi">0</span>, <span class="o">--</span>
        <span class="s2">&quot;</span><span class="s">timedOut</span><span class="s2">&quot;</span> : <span class="mi">24</span> <span class="o">--</span><span class="nv">server</span>启动以来游标（<span class="nv">cursor</span>）超时的总数
    },
    <span class="s2">&quot;</span><span class="s">network</span><span class="s2">&quot;</span> : {
        <span class="s2">&quot;</span><span class="s">bytesIn</span><span class="s2">&quot;</span> : <span class="nv">NumberLong</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">1929833164782</span><span class="s2">&quot;</span><span class="ss">)</span>, <span class="o">--</span>发送到数据库的数据总量（<span class="nv">bytes</span>）
        <span class="s2">&quot;</span><span class="s">bytesOut</span><span class="s2">&quot;</span> : <span class="mi">553137147925</span>, <span class="o">--</span>数据库发出的数据总量（<span class="nv">bytes</span>）
        <span class="s2">&quot;</span><span class="s">numRequests</span><span class="s2">&quot;</span> : <span class="mi">2475184328</span> <span class="o">--</span>发送到数据库的请求量
    },
    <span class="s2">&quot;</span><span class="s">opcounters</span><span class="s2">&quot;</span> : {
        <span class="s2">&quot;</span><span class="s">insert</span><span class="s2">&quot;</span> : <span class="mi">687531883</span>, <span class="o">--</span><span class="nv">server</span>启动以来总的<span class="nv">insert</span>数据量
        <span class="s2">&quot;</span><span class="s">query</span><span class="s2">&quot;</span> : <span class="mi">711010343</span>, <span class="o">--</span><span class="nv">server</span>启动以来总的<span class="nv">query</span>数据量
        <span class="s2">&quot;</span><span class="s">update</span><span class="s2">&quot;</span> : <span class="mi">0</span>, <span class="o">--</span><span class="nv">server</span>启动以来总的<span class="nv">update</span>数据量
        <span class="s2">&quot;</span><span class="s">delete</span><span class="s2">&quot;</span> : <span class="mi">0</span>, <span class="o">--</span><span class="nv">server</span>启动以来总的<span class="nv">delete</span>数据量
        <span class="s2">&quot;</span><span class="s">getmore</span><span class="s2">&quot;</span> : <span class="mi">6484</span>, <span class="o">--</span><span class="nv">server</span>启动以来调用任何游标的<span class="nv">getMore</span>总次数
        <span class="s2">&quot;</span><span class="s">command</span><span class="s2">&quot;</span> : <span class="mi">1287537</span> <span class="o">--</span><span class="nv">server</span>启动以来执行其他命令的总次数
    },
    <span class="s2">&quot;</span><span class="s">asserts</span><span class="s2">&quot;</span> : {
        <span class="s2">&quot;</span><span class="s">regular</span><span class="s2">&quot;</span> : <span class="mi">0</span>, <span class="o">--</span><span class="nv">server</span>启动以来抛出正规断言（<span class="nv">assert</span> 类似于异常处理的形式）总数目
        <span class="s2">&quot;</span><span class="s">warning</span><span class="s2">&quot;</span> : <span class="mi">1</span>, <span class="o">--</span><span class="nv">server</span>启动以来抛出的告警总数目
        <span class="s2">&quot;</span><span class="s">msg</span><span class="s2">&quot;</span> : <span class="mi">0</span>, <span class="o">--</span>消息断言数目。服务器内部定义的良好字符串错误
        <span class="s2">&quot;</span><span class="s">user</span><span class="s2">&quot;</span> : <span class="mi">4</span>, <span class="o">--</span>用户断言数目。用户产生的错误，譬如：磁盘空间满；重复键。
        <span class="s2">&quot;</span><span class="s">rollovers</span><span class="s2">&quot;</span> : <span class="mi">0</span> <span class="o">--</span><span class="nv">server</span>启动以来，<span class="nv">assert</span> <span class="nv">counters</span> <span class="nv">have</span> <span class="nv">rolled</span> <span class="nv">over</span>的次数
    },
    <span class="s2">&quot;</span><span class="s">writeBacksQueued</span><span class="s2">&quot;</span> : <span class="nv">false</span>, <span class="o">--</span>是否有从<span class="nv">mongos</span>执行的<span class="nv">retry</span>操作
    <span class="s2">&quot;</span><span class="s">dur</span><span class="s2">&quot;</span> : {
        <span class="s2">&quot;</span><span class="s">commits</span><span class="s2">&quot;</span> : <span class="mi">30</span>, <span class="o">--</span>上一间隔<span class="nv">journal</span>日志发生<span class="nv">commit</span>的次数
        <span class="s2">&quot;</span><span class="s">journaledMB</span><span class="s2">&quot;</span> : <span class="mi">0</span>, <span class="o">--</span>上一间隔写到<span class="nv">journal</span>日志的数据量（单位：<span class="nv">MB</span>）
        <span class="s2">&quot;</span><span class="s">writeToDataFilesMB</span><span class="s2">&quot;</span> : <span class="mi">0</span>, <span class="o">--</span>上一间隔<span class="nv">journal</span>日志写到数据文件的数据量（单位：<span class="nv">MB</span>）
        <span class="s2">&quot;</span><span class="s">compression</span><span class="s2">&quot;</span> : <span class="mi">0</span>, <span class="o">--</span>
        <span class="s2">&quot;</span><span class="s">commitsInWriteLock</span><span class="s2">&quot;</span> : <span class="mi">0</span>, <span class="o">--</span>写锁期间发生<span class="nv">commits</span>的次数
        <span class="s2">&quot;</span><span class="s">earlyCommits</span><span class="s2">&quot;</span> : <span class="mi">0</span>, <span class="o">--</span><span class="nv">schedule</span>时间前请求<span class="nv">commit</span>的次数
        <span class="s2">&quot;</span><span class="s">timeMs</span><span class="s2">&quot;</span> : {
            <span class="s2">&quot;</span><span class="s">dt</span><span class="s2">&quot;</span> : <span class="mi">3064</span>,
            <span class="s2">&quot;</span><span class="s">prepLogBuffer</span><span class="s2">&quot;</span> : <span class="mi">0</span>, <span class="o">--</span>准备写<span class="nv">journal</span>日志花费的时间
            <span class="s2">&quot;</span><span class="s">writeToJournal</span><span class="s2">&quot;</span> : <span class="mi">0</span>, <span class="o">--</span>写<span class="nv">journal</span>日志花费的实际时间
            <span class="s2">&quot;</span><span class="s">writeToDataFiles</span><span class="s2">&quot;</span> : <span class="mi">0</span>, <span class="o">--</span><span class="nv">journal</span>日志后写数据文件花费的时间
            <span class="s2">&quot;</span><span class="s">remapPrivateView</span><span class="s2">&quot;</span> : <span class="mi">0</span> <span class="o">--</span><span class="nv">The</span> <span class="nv">amount</span> <span class="nv">of</span> <span class="nv">time</span> <span class="nv">spent</span> <span class="nv">remapping</span> <span class="nv">copy</span><span class="o">-</span><span class="nv">on</span><span class="o">-</span><span class="nv">write</span> <span class="nv">memory</span> <span class="nv">mapped</span> <span class="nv">views</span>
        }
    },
    <span class="s2">&quot;</span><span class="s">ok</span><span class="s2">&quot;</span> : <span class="mi">1</span> <span class="o">--</span><span class="nv">serverStatus</span>是否返回正确
}


.<span class="o">/</span><span class="nv">zabbix_get</span> <span class="o">-</span><span class="nv">s</span> <span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span> <span class="o">-</span><span class="nv">k</span> <span class="nv">MongoDB</span>.<span class="nv">Status</span>[<span class="nv">opcounters</span>,<span class="nv">query</span>]

添加监控项
监控<span class="nv">command</span>，收集所有的命令数，包括插入，删除，查询，更新等所有命令，这里每过<span class="mi">10</span>秒取一次值
<span class="nv">insert</span>、<span class="nv">query</span>、<span class="nv">update</span>、<span class="nv">delete</span>、<span class="nv">getmore</span>、<span class="nv">command</span>等都用相同的设置

监控内存，<span class="nv">virtual</span>是虚拟内存，<span class="nv">resident</span>是无论内存

监控网络，<span class="nv">bytesIN</span>是进流量，<span class="nv">bytesOut</span>是出流量，<span class="nv">numRequests</span>是请求数

监控连接数，<span class="nv">available</span>是可用连接数、<span class="nv">current</span>是当前连接数

监控刷写数据到硬盘的次数

定义<span class="nv">mapped</span>的项目，单位是<span class="nv">MB</span>


<span class="mi">5</span>、监控<span class="nv">locks</span>项目，由于部分项目是多维数组，不能使用之前自定义的用户<span class="nv">key</span>获取，需要额外创建专门的<span class="nv">key</span>

[<span class="nv">root</span>@<span class="nv">mongodb</span> <span class="nv">bin</span>]#  <span class="nv">echo</span> <span class="s2">&quot;</span><span class="s">db.serverStatus().locks</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">mongo</span> <span class="nv">admin</span>
<span class="nv">MongoDB</span> <span class="nv">shell</span> <span class="nv">version</span>: <span class="mi">2</span>.<span class="mi">6</span>.<span class="mi">3</span>
<span class="nv">connecting</span> <span class="nv">to</span>: <span class="nv">admin</span>
{
       <span class="s2">&quot;</span><span class="s">.</span><span class="s2">&quot;</span> : {
               <span class="s2">&quot;</span><span class="s">timeLockedMicros</span><span class="s2">&quot;</span> : {
                       <span class="s2">&quot;</span><span class="s">R</span><span class="s2">&quot;</span> : <span class="nv">NumberLong</span><span class="ss">(</span><span class="mi">572504</span><span class="ss">)</span>,
                       <span class="s2">&quot;</span><span class="s">W</span><span class="s2">&quot;</span> : <span class="nv">NumberLong</span><span class="ss">(</span><span class="mi">480751</span><span class="ss">)</span>
               },
               <span class="s2">&quot;</span><span class="s">timeAcquiringMicros</span><span class="s2">&quot;</span> : {
                       <span class="s2">&quot;</span><span class="s">R</span><span class="s2">&quot;</span> : <span class="nv">NumberLong</span><span class="ss">(</span><span class="mi">480946</span><span class="ss">)</span>,
                       <span class="s2">&quot;</span><span class="s">W</span><span class="s2">&quot;</span> : <span class="nv">NumberLong</span><span class="ss">(</span><span class="mi">70198</span><span class="ss">)</span>
               }
       },
       <span class="s2">&quot;</span><span class="s">admin</span><span class="s2">&quot;</span> : {
               <span class="s2">&quot;</span><span class="s">timeLockedMicros</span><span class="s2">&quot;</span> : {
                       <span class="s2">&quot;</span><span class="s">r</span><span class="s2">&quot;</span> : <span class="nv">NumberLong</span><span class="ss">(</span><span class="mi">142364</span><span class="ss">)</span>,
                       <span class="s2">&quot;</span><span class="s">w</span><span class="s2">&quot;</span> : <span class="nv">NumberLong</span><span class="ss">(</span><span class="mi">0</span><span class="ss">)</span>
               },
               <span class="s2">&quot;</span><span class="s">timeAcquiringMicros</span><span class="s2">&quot;</span> : {
                       <span class="s2">&quot;</span><span class="s">r</span><span class="s2">&quot;</span> : <span class="nv">NumberLong</span><span class="ss">(</span><span class="mi">15018</span><span class="ss">)</span>,
                       <span class="s2">&quot;</span><span class="s">w</span><span class="s2">&quot;</span> : <span class="nv">NumberLong</span><span class="ss">(</span><span class="mi">0</span><span class="ss">)</span>
               }
       },
       <span class="s2">&quot;</span><span class="s">local</span><span class="s2">&quot;</span> : {
               <span class="s2">&quot;</span><span class="s">timeLockedMicros</span><span class="s2">&quot;</span> : {
                       <span class="s2">&quot;</span><span class="s">r</span><span class="s2">&quot;</span> : <span class="nv">NumberLong</span><span class="ss">(</span><span class="mi">271651</span><span class="ss">)</span>,
                       <span class="s2">&quot;</span><span class="s">w</span><span class="s2">&quot;</span> : <span class="nv">NumberLong</span><span class="ss">(</span><span class="mi">271</span><span class="ss">)</span>
               },
               <span class="s2">&quot;</span><span class="s">timeAcquiringMicros</span><span class="s2">&quot;</span> : {
                       <span class="s2">&quot;</span><span class="s">r</span><span class="s2">&quot;</span> : <span class="nv">NumberLong</span><span class="ss">(</span><span class="mi">120699</span><span class="ss">)</span>,
                       <span class="s2">&quot;</span><span class="s">w</span><span class="s2">&quot;</span> : <span class="nv">NumberLong</span><span class="ss">(</span><span class="mi">5</span><span class="ss">)</span>
               }
       },
       <span class="s2">&quot;</span><span class="s">test</span><span class="s2">&quot;</span> : {
               <span class="s2">&quot;</span><span class="s">timeLockedMicros</span><span class="s2">&quot;</span> : {
                       <span class="s2">&quot;</span><span class="s">r</span><span class="s2">&quot;</span> : <span class="nv">NumberLong</span><span class="ss">(</span><span class="mi">93725</span><span class="ss">)</span>,
                       <span class="s2">&quot;</span><span class="s">w</span><span class="s2">&quot;</span> : <span class="nv">NumberLong</span><span class="ss">(</span><span class="mi">114935</span><span class="ss">)</span>
               },
               <span class="s2">&quot;</span><span class="s">timeAcquiringMicros</span><span class="s2">&quot;</span> : {
                       <span class="s2">&quot;</span><span class="s">r</span><span class="s2">&quot;</span> : <span class="nv">NumberLong</span><span class="ss">(</span><span class="mi">67411</span><span class="ss">)</span>,
                       <span class="s2">&quot;</span><span class="s">w</span><span class="s2">&quot;</span> : <span class="nv">NumberLong</span><span class="ss">(</span><span class="mi">41</span><span class="ss">)</span>
               }
       }
}
<span class="nv">bye</span>
创建自定义<span class="nv">key</span>

<span class="nv">UserParameter</span><span class="o">=</span><span class="nv">MongoDB</span>.<span class="nv">Status</span>.<span class="nv">locks</span>[<span class="o">*</span>],<span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">echo</span> <span class="s2">&quot;</span><span class="s">db.serverStatus().locks.$1.$2.$3</span><span class="s2">&quot;</span> <span class="o">|</span> 
<span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">mongodb</span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">mongo</span> <span class="nv">admin</span> <span class="o">|/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">tail</span> <span class="o">-</span><span class="nv">n</span> <span class="mi">2</span> <span class="o">|</span> <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">head</span> <span class="o">-</span><span class="nv">n</span> <span class="mi">1</span> <span class="o">|</span> <span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span> 
<span class="s1">&#39;</span><span class="s">(</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">{print $$2}</span><span class="s1">&#39;</span><span class="o">|</span><span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span> <span class="s1">&#39;</span><span class="s">)</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">{print $$1}</span><span class="s1">&#39;</span>




来源： <span class="nv">http</span>:<span class="o">//</span><span class="nv">www</span>.<span class="nv">zhengdazhi</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">archives</span><span class="o">/</span><span class="mi">662</span>
</pre></div>


<h2 id="fping-key">fping key</h2>
<div class="codehilite"><pre><span></span><span class="n">fping</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">20</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="k">null</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="k">c</span> <span class="n">alive</span>
</pre></div>


<h2 id="_1">连续报警</h2>
<p>默认的步骤是1-1,也即是从1开始到1结束。一旦故障发生，就是执行发邮件脚本</p>
<p>假如故障持续了1个小时，它也只发送一次。如果改成1-0，0是表示不限制.无限发送</p>
<p>间隔就是默认持续时间60秒。那么一个小时，就会发送60封邮件。</p>
<p><img alt="" src="../assets/zabbix4.png" /></p>
<h2 id="nginx">区分域名统计nginx</h2>
<div class="codehilite"><pre><span></span># 不同域名的日志文件区分开来
#<span class="o">!/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">env</span> <span class="nv">bash</span>
<span class="nv">case</span> <span class="mh">$2</span> <span class="nv">in</span>
    <span class="s2">&quot;</span><span class="s">net</span><span class="s2">&quot;</span><span class="ss">)</span>
     <span class="nv">count</span><span class="o">=</span>$<span class="ss">(</span><span class="nv">sudo</span> <span class="nv">grep</span> $<span class="ss">(</span><span class="nv">date</span> <span class="s2">&quot;</span><span class="s">+%Y:%H:%M</span><span class="s2">&quot;</span><span class="ss">)</span> <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">log</span><span class="o">/</span><span class="nv">nginx</span><span class="o">/</span><span class="nv">access_</span><span class="mh">$1</span>.<span class="nv">log</span> <span class="o">|</span> <span class="nv">wc</span> <span class="o">-</span><span class="nv">l</span><span class="ss">)</span>
     <span class="k">if</span> [ <span class="mh">$c</span><span class="nv">ount</span> <span class="o">-</span><span class="nv">eq</span> <span class="mi">0</span>  ]<span class="c1">;then</span>
          <span class="nv">echo</span> <span class="mi">0</span>
     <span class="k">else</span>
     <span class="nv">sudo</span> <span class="nv">grep</span> $<span class="ss">(</span><span class="nv">date</span> <span class="s2">&quot;</span><span class="s">+%Y:%H:%M</span><span class="s2">&quot;</span><span class="ss">)</span> <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">log</span><span class="o">/</span><span class="nv">nginx</span><span class="o">/</span><span class="nv">access_</span><span class="mh">$1</span>.<span class="nv">log</span> <span class="o">|</span> <span class="nv">awk</span> <span class="s1">&#39;</span><span class="s">{sum +=$10}END{print sum}</span><span class="s1">&#39;</span>
     <span class="nv">fi</span>
     <span class="c1">;;</span>
    <span class="s2">&quot;</span><span class="s">connect</span><span class="s2">&quot;</span><span class="ss">)</span>
     <span class="nv">sudo</span> <span class="nv">grep</span> $<span class="ss">(</span><span class="nv">date</span> <span class="s2">&quot;</span><span class="s">+%Y:%H:%M</span><span class="s2">&quot;</span><span class="ss">)</span> <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">log</span><span class="o">/</span><span class="nv">nginx</span><span class="o">/</span><span class="nv">access_</span><span class="mh">$1</span>.<span class="nv">log</span> <span class="o">|</span> <span class="nv">wc</span> <span class="o">-</span><span class="nv">l</span>
     <span class="c1">;;</span>
<span class="nv">esac</span>
<span class="nv">key</span>：
    <span class="nv">UserParameter</span><span class="o">=</span><span class="nv">domain_stats</span>[<span class="o">*</span>],<span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">domain_stats</span>.<span class="nv">sh</span> <span class="mh">$1</span> <span class="mh">$2</span>

测试
<span class="nv">zabbix_get</span> <span class="o">-</span><span class="nv">s</span> <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">1</span>.<span class="mi">5</span> <span class="o">-</span><span class="nv">k</span> <span class="nv">domain_stats</span>[<span class="nv">data</span>,<span class="nv">net</span>]
<span class="mi">1172557</span>
<span class="nv">zabbix_get</span> <span class="o">-</span><span class="nv">s</span> <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">1</span>.<span class="mi">5</span> <span class="o">-</span><span class="nv">k</span> <span class="nv">domain_stats</span>[<span class="nv">data</span>,<span class="k">connect</span>]
<span class="mi">0</span>
</pre></div>


<h2 id="redis">监控redis</h2>
<div class="codehilite"><pre><span></span><span class="nv">UserParameter</span><span class="o">=</span><span class="nv">Redis</span>.<span class="nv">Info</span>[<span class="o">*</span>],<span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">redisinfo</span>.<span class="nv">sh</span> <span class="mh">$1</span> <span class="mh">$2</span>
#<span class="o">!</span> <span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">bash</span>
<span class="nv">REDISCLI</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">/usr/local/src/redis-cli</span><span class="s2">&quot;</span>
<span class="nv">HOST</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">116.213.204.14</span><span class="s2">&quot;</span>
<span class="nv">PORT</span><span class="o">=</span><span class="mi">6379</span>
<span class="k">if</span> [[ $# <span class="o">==</span> <span class="mi">1</span> ]]<span class="c1">;then</span>
    <span class="nv">case</span> <span class="mh">$1</span> <span class="nv">in</span>
        <span class="nv">version</span><span class="ss">)</span>
            <span class="nb">result</span><span class="o">=</span>`$<span class="nv">REDISCLI</span> <span class="o">-</span><span class="nv">h</span> $<span class="nv">HOST</span> <span class="o">-</span><span class="nv">p</span> $<span class="nv">PORT</span> <span class="nv">info</span> <span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">w</span> <span class="s2">&quot;</span><span class="s">redis_version</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span><span class="s1">&#39;</span><span class="s">:</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">{print $2}</span><span class="s1">&#39;</span>`
            <span class="nv">echo</span> $<span class="nb">result</span>
        <span class="c1">;;</span>
        <span class="k">uptime</span><span class="ss">)</span>
            <span class="nb">result</span><span class="o">=</span>`$<span class="nv">REDISCLI</span> <span class="o">-</span><span class="nv">h</span> $<span class="nv">HOST</span> <span class="o">-</span><span class="nv">p</span> $<span class="nv">PORT</span> <span class="nv">info</span> <span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">w</span> <span class="s2">&quot;</span><span class="s">uptime_in_seconds</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span><span class="s1">&#39;</span><span class="s">:</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">{print $2}</span><span class="s1">&#39;</span>`
            <span class="nv">echo</span> $<span class="nb">result</span>
        <span class="c1">;;</span>
        <span class="nv">connected_clients</span><span class="ss">)</span>
            <span class="nb">result</span><span class="o">=</span>`$<span class="nv">REDISCLI</span> <span class="o">-</span><span class="nv">h</span> $<span class="nv">HOST</span> <span class="o">-</span><span class="nv">p</span> $<span class="nv">PORT</span> <span class="nv">info</span> <span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">w</span> <span class="s2">&quot;</span><span class="s">connected_clients</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span><span class="s1">&#39;</span><span class="s">:</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">{print $2}</span><span class="s1">&#39;</span>`
            <span class="nv">echo</span> $<span class="nb">result</span>
        <span class="c1">;;</span>
        <span class="nv">blocked_clients</span><span class="ss">)</span>
            <span class="nb">result</span><span class="o">=</span>`$<span class="nv">REDISCLI</span> <span class="o">-</span><span class="nv">h</span> $<span class="nv">HOST</span> <span class="o">-</span><span class="nv">p</span> $<span class="nv">PORT</span> <span class="nv">info</span> <span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">w</span> <span class="s2">&quot;</span><span class="s">blocked_clients</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span><span class="s1">&#39;</span><span class="s">:</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">{print $2}</span><span class="s1">&#39;</span>`
            <span class="nv">echo</span> $<span class="nb">result</span>
        <span class="c1">;;</span>
        <span class="nv">used_memory</span><span class="ss">)</span>
            <span class="nb">result</span><span class="o">=</span>`$<span class="nv">REDISCLI</span> <span class="o">-</span><span class="nv">h</span> $<span class="nv">HOST</span> <span class="o">-</span><span class="nv">p</span> $<span class="nv">PORT</span> <span class="nv">info</span> <span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">w</span> <span class="s2">&quot;</span><span class="s">used_memory</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span><span class="s1">&#39;</span><span class="s">:</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">{print $2}</span><span class="s1">&#39;</span>`
            <span class="nv">echo</span> $<span class="nb">result</span>
        <span class="c1">;;</span>
        <span class="nv">used_memory_rss</span><span class="ss">)</span>
            <span class="nb">result</span><span class="o">=</span>`$<span class="nv">REDISCLI</span> <span class="o">-</span><span class="nv">h</span> $<span class="nv">HOST</span> <span class="o">-</span><span class="nv">p</span> $<span class="nv">PORT</span> <span class="nv">info</span> <span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">w</span> <span class="s2">&quot;</span><span class="s">used_memory_rss</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span><span class="s1">&#39;</span><span class="s">:</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">{print $2}</span><span class="s1">&#39;</span>`
            <span class="nv">echo</span> $<span class="nb">result</span>
        <span class="c1">;;</span>
        <span class="nv">used_memory_peak</span><span class="ss">)</span>
            <span class="nb">result</span><span class="o">=</span>`$<span class="nv">REDISCLI</span> <span class="o">-</span><span class="nv">h</span> $<span class="nv">HOST</span> <span class="o">-</span><span class="nv">p</span> $<span class="nv">PORT</span> <span class="nv">info</span> <span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">w</span> <span class="s2">&quot;</span><span class="s">used_memory_peak</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span><span class="s1">&#39;</span><span class="s">:</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">{print $2}</span><span class="s1">&#39;</span>`
            <span class="nv">echo</span> $<span class="nb">result</span>
        <span class="c1">;;</span>
        <span class="nv">used_memory_lua</span><span class="ss">)</span>
            <span class="nb">result</span><span class="o">=</span>`$<span class="nv">REDISCLI</span> <span class="o">-</span><span class="nv">h</span> $<span class="nv">HOST</span> <span class="o">-</span><span class="nv">p</span> $<span class="nv">PORT</span> <span class="nv">info</span> <span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">w</span> <span class="s2">&quot;</span><span class="s">used_memory_lua</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span><span class="s1">&#39;</span><span class="s">:</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">{print $2}</span><span class="s1">&#39;</span>`
            <span class="nv">echo</span> $<span class="nb">result</span>
        <span class="c1">;;</span>
        <span class="nv">used_cpu_sys</span><span class="ss">)</span>
            <span class="nb">result</span><span class="o">=</span>`$<span class="nv">REDISCLI</span> <span class="o">-</span><span class="nv">h</span> $<span class="nv">HOST</span> <span class="o">-</span><span class="nv">p</span> $<span class="nv">PORT</span> <span class="nv">info</span> <span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">w</span> <span class="s2">&quot;</span><span class="s">used_cpu_sys</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span><span class="s1">&#39;</span><span class="s">:</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">{print $2}</span><span class="s1">&#39;</span>`
            <span class="nv">echo</span> $<span class="nb">result</span>
        <span class="c1">;;</span>
        <span class="nv">used_cpu_user</span><span class="ss">)</span>
            <span class="nb">result</span><span class="o">=</span>`$<span class="nv">REDISCLI</span> <span class="o">-</span><span class="nv">h</span> $<span class="nv">HOST</span> <span class="o">-</span><span class="nv">p</span> $<span class="nv">PORT</span> <span class="nv">info</span> <span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">w</span> <span class="s2">&quot;</span><span class="s">used_cpu_user</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span><span class="s1">&#39;</span><span class="s">:</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">{print $2}</span><span class="s1">&#39;</span>`
            <span class="nv">echo</span> $<span class="nb">result</span>
        <span class="c1">;;</span>
        <span class="nv">used_cpu_sys_children</span><span class="ss">)</span>
            <span class="nb">result</span><span class="o">=</span>`$<span class="nv">REDISCLI</span> <span class="o">-</span><span class="nv">h</span> $<span class="nv">HOST</span> <span class="o">-</span><span class="nv">p</span> $<span class="nv">PORT</span> <span class="nv">info</span> <span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">w</span> <span class="s2">&quot;</span><span class="s">used_cpu_sys_children</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span><span class="s1">&#39;</span><span class="s">:</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">{print $2}</span><span class="s1">&#39;</span>`
            <span class="nv">echo</span> $<span class="nb">result</span>
        <span class="c1">;;</span>
        <span class="nv">used_cpu_user_children</span><span class="ss">)</span>
            <span class="nb">result</span><span class="o">=</span>`$<span class="nv">REDISCLI</span> <span class="o">-</span><span class="nv">h</span> $<span class="nv">HOST</span> <span class="o">-</span><span class="nv">p</span> $<span class="nv">PORT</span> <span class="nv">info</span> <span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">w</span> <span class="s2">&quot;</span><span class="s">used_cpu_user_children</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span><span class="s1">&#39;</span><span class="s">:</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">{print $2}</span><span class="s1">&#39;</span>`
            <span class="nv">echo</span> $<span class="nb">result</span>
        <span class="c1">;;</span>
        <span class="nv">rdb_last_bgsave_status</span><span class="ss">)</span>
 <span class="nb">result</span><span class="o">=</span>`$<span class="nv">REDISCLI</span> <span class="o">-</span><span class="nv">h</span> $<span class="nv">HOST</span> <span class="o">-</span><span class="nv">p</span> $<span class="nv">PORT</span> <span class="nv">info</span>  <span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">w</span> <span class="s2">&quot;</span><span class="s">rdb_last_bgsave_status</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span><span class="s1">&#39;</span><span class="s">:</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">{print $2}</span><span class="s1">&#39;</span> <span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">c</span> <span class="nv">ok</span>`
            <span class="nv">echo</span> $<span class="nb">result</span>
        <span class="c1">;;</span>
        <span class="nv">aof_last_bgrewrite_status</span><span class="ss">)</span>
 <span class="nb">result</span><span class="o">=</span>`$<span class="nv">REDISCLI</span> <span class="o">-</span><span class="nv">h</span> $<span class="nv">HOST</span> <span class="o">-</span><span class="nv">p</span> $<span class="nv">PORT</span> <span class="nv">info</span>  <span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">w</span> <span class="s2">&quot;</span><span class="s">aof_last_bgrewrite_status</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span><span class="s1">&#39;</span><span class="s">:</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">{print $2}</span><span class="s1">&#39;</span> <span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">c</span> <span class="nv">ok</span>`
            <span class="nv">echo</span> $<span class="nb">result</span>
        <span class="c1">;;</span>
        <span class="nv">aof_last_write_status</span><span class="ss">)</span>
 <span class="nb">result</span><span class="o">=</span>`$<span class="nv">REDISCLI</span> <span class="o">-</span><span class="nv">h</span> $<span class="nv">HOST</span> <span class="o">-</span><span class="nv">p</span> $<span class="nv">PORT</span> <span class="nv">info</span>  <span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">w</span> <span class="s2">&quot;</span><span class="s">aof_last_write_status</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span><span class="s1">&#39;</span><span class="s">:</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">{print $2}</span><span class="s1">&#39;</span> <span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">c</span> <span class="nv">ok</span>`
            <span class="nv">echo</span> $<span class="nb">result</span>
        <span class="c1">;;</span>
        <span class="o">*</span><span class="ss">)</span>
            <span class="nv">echo</span> <span class="o">-</span><span class="nv">e</span> <span class="s2">&quot;</span><span class="s">\033[33mUsage: $0 {connected_clients|blocked_clients|used_memory|used_memory_rss|</span>
            <span class="nv">used_memory_peak</span><span class="o">|</span><span class="nv">used_memory_lua</span><span class="o">|</span><span class="nv">used_cpu_sys</span><span class="o">|</span><span class="nv">used_cpu_user</span><span class="o">|</span><span class="nv">used_cpu_sys_children</span><span class="o">|</span><span class="nv">used_cpu_user_children</span>
            <span class="o">|</span><span class="nv">rdb_last_bgsave_status</span><span class="o">|</span><span class="nv">aof_last_bgrewrite_status</span><span class="o">|</span><span class="nv">aof_last_write_status</span>}\<span class="mi">033</span>[<span class="mi">0</span><span class="nv">m</span><span class="s2">&quot;</span><span class="s"> </span>
        <span class="c1">;;</span>
    <span class="nv">esac</span>
<span class="nv">elif</span> [[ $# <span class="o">==</span> <span class="mi">2</span> ]]<span class="c1">;then</span>
    <span class="nv">case</span> <span class="mh">$2</span> <span class="nv">in</span>
        <span class="nv">keys</span><span class="ss">)</span>
            <span class="nb">result</span><span class="o">=</span>`$<span class="nv">REDISCLI</span> <span class="o">-</span><span class="nv">h</span> $<span class="nv">HOST</span> <span class="o">-</span><span class="nv">p</span> $<span class="nv">PORT</span> <span class="nv">info</span> <span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">w</span> <span class="s2">&quot;</span><span class="s">$1</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">w</span> <span class="s2">&quot;</span><span class="s">keys</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span><span class="s1">&#39;</span><span class="s">=|,</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">{print $2}</span><span class="s1">&#39;</span>`
            <span class="nv">echo</span> $<span class="nb">result</span>
        <span class="c1">;;</span>
        <span class="nv">expires</span><span class="ss">)</span>
            <span class="nb">result</span><span class="o">=</span>`$<span class="nv">REDISCLI</span> <span class="o">-</span><span class="nv">h</span> $<span class="nv">HOST</span> <span class="o">-</span><span class="nv">p</span> $<span class="nv">PORT</span> <span class="nv">info</span> <span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">w</span> <span class="s2">&quot;</span><span class="s">$1</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">w</span> <span class="s2">&quot;</span><span class="s">keys</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span><span class="s1">&#39;</span><span class="s">=|,</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">{print $4}</span><span class="s1">&#39;</span>`
            <span class="nv">echo</span> $<span class="nb">result</span>
        <span class="c1">;;</span>
        <span class="nv">avg_ttl</span><span class="ss">)</span>
            <span class="nb">result</span><span class="o">=</span>`$<span class="nv">REDISCLI</span> <span class="o">-</span><span class="nv">h</span> $<span class="nv">HOST</span> <span class="o">-</span><span class="nv">p</span> $<span class="nv">PORT</span> <span class="nv">info</span> <span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">w</span> <span class="s2">&quot;</span><span class="s">$1</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">w</span> <span class="s2">&quot;</span><span class="s">avg_ttl</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span><span class="s1">&#39;</span><span class="s">=|,</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">{print $6}</span><span class="s1">&#39;</span>`
            <span class="nv">echo</span> $<span class="nb">result</span>
        <span class="c1">;;</span>
        <span class="o">*</span><span class="ss">)</span>
            <span class="nv">echo</span> <span class="o">-</span><span class="nv">e</span> <span class="s2">&quot;</span><span class="s">\033[33mUsage: $0 {db0 keys|db0 expires|db0 avg_ttl}\033[0m</span><span class="s2">&quot;</span> 
        <span class="c1">;;</span>
    <span class="nv">esac</span>
<span class="nv">fi</span>
</pre></div>


<h2 id="zabbix">zabbix日报</h2>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># coding=utf-8</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">urllib2</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">cookielib</span>
<span class="kn">import</span> <span class="nn">smtplib</span>
<span class="kn">from</span> <span class="nn">email.mime.multipart</span> <span class="kn">import</span> <span class="n">MIMEMultipart</span>
<span class="kn">from</span> <span class="nn">email.mime.text</span> <span class="kn">import</span> <span class="n">MIMEText</span>
<span class="kn">from</span> <span class="nn">email.mime.image</span> <span class="kn">import</span> <span class="n">MIMEImage</span>
<span class="k">def</span> <span class="nf">zab_api</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://116.213.207.5:15080/zabbix/api_jsonrpc.php&#39;</span>
    <span class="n">header</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">}</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">result</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">response</span>
<span class="n">auth_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
    <span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;user.login&quot;</span><span class="p">,</span>
    <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
        <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;dachui$5zabbix&quot;</span>
    <span class="p">},</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span>
<span class="p">})</span>
<span class="n">auth</span> <span class="o">=</span> <span class="n">zab_api</span><span class="p">(</span><span class="n">auth_data</span><span class="p">)[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span>
<span class="n">hostget</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
    <span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;host.get&quot;</span><span class="p">,</span>
    <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;hostid&quot;</span><span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="p">],</span>
        <span class="s2">&quot;selectInterfaces&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;interfaceid&quot;</span><span class="p">,</span> <span class="s2">&quot;ip&quot;</span><span class="p">]</span>
    <span class="p">},</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;auth&quot;</span><span class="p">:</span> <span class="n">auth</span>
<span class="p">})</span>
<span class="k">def</span> <span class="nf">getgraphid</span><span class="p">(</span><span class="n">hostid</span><span class="p">):</span>
    <span class="n">graph1</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
        <span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;graph.get&quot;</span><span class="p">,</span>
        <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="s2">&quot;extend&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hostids&quot;</span><span class="p">:</span> <span class="n">hostid</span><span class="p">,</span>
            <span class="s2">&quot;sortfield&quot;</span><span class="p">:</span> <span class="s2">&quot;name&quot;</span>
        <span class="p">},</span>
        <span class="s2">&quot;auth&quot;</span><span class="p">:</span> <span class="n">auth</span><span class="p">,</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">})</span>
    <span class="k">for</span> <span class="n">graph</span> <span class="ow">in</span> <span class="n">zab_api</span><span class="p">(</span><span class="n">graph1</span><span class="p">)[</span><span class="s1">&#39;result&#39;</span><span class="p">]:</span>
        <span class="k">print</span> <span class="n">graph</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="s2">&quot; : &quot;</span><span class="p">,</span> <span class="n">graph</span><span class="p">[</span><span class="s1">&#39;graphid&#39;</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">getcookie</span><span class="p">():</span>
    <span class="n">cookiejar</span> <span class="o">=</span> <span class="n">cookielib</span><span class="o">.</span><span class="n">CookieJar</span><span class="p">()</span>
    <span class="n">urlOpener</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">build_opener</span><span class="p">(</span><span class="n">urllib2</span><span class="o">.</span><span class="n">HTTPCookieProcessor</span><span class="p">(</span><span class="n">cookiejar</span><span class="p">))</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;dachui$5zabbix&quot;</span><span class="p">,</span> <span class="s1">&#39;autologin&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;enter&quot;</span><span class="p">:</span> <span class="s1">&#39;Sign in&#39;</span><span class="p">}</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="s1">&#39;http://116.213.207.5:15080/zabbix/index.php&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">urlOpener</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">urlOpener</span>
    <span class="k">except</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">e</span>
<span class="k">def</span> <span class="nf">getgraph</span><span class="p">(</span><span class="n">graid</span><span class="p">):</span>
    <span class="n">gr_url</span> <span class="o">=</span> <span class="s2">&quot;http://116.213.207.5:15080/zabbix/chart2.php&quot;</span>
    <span class="c1"># http://116.213.207.5:15080/zabbix/chart6.php  饼图</span>
    <span class="n">stime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;graphid&quot;</span><span class="p">:</span> <span class="n">graid</span><span class="p">,</span> <span class="s2">&quot;period&quot;</span><span class="p">:</span> <span class="mi">86400</span><span class="p">,</span> <span class="s2">&quot;stime&quot;</span><span class="p">:</span> <span class="n">stime</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">}</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">gr_url</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">getcookie</span><span class="p">()</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">imagename</span> <span class="o">=</span> <span class="s2">&quot;img/</span><span class="si">%s</span><span class="s2">.png&quot;</span> <span class="o">%</span> <span class="n">graid</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">imagename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">SendMail</span><span class="p">(</span><span class="n">imglist</span><span class="p">):</span>
    <span class="n">msgRoot</span> <span class="o">=</span> <span class="n">MIMEMultipart</span><span class="p">(</span><span class="s1">&#39;related&#39;</span><span class="p">)</span>
    <span class="n">msgRoot</span><span class="p">[</span><span class="s1">&#39;Subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;zabbix report&#39;</span>
    <span class="n">msgRoot</span><span class="p">[</span><span class="s1">&#39;From&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;liangguangyu@dachuizichan.com&quot;</span>
    <span class="n">to_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;liangguangyu@dachuizichan.com&quot;</span><span class="p">,</span> <span class="s2">&quot;2219722370@qq.com&quot;</span><span class="p">]</span>
    <span class="n">msgRoot</span><span class="p">[</span><span class="s1">&#39;To&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">to_list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">imglist</span><span class="p">:</span>
        <span class="n">imagename</span> <span class="o">=</span> <span class="s2">&quot;img/</span><span class="si">%s</span><span class="s2">.png&quot;</span> <span class="o">%</span> <span class="n">img</span>
        <span class="n">msgImage</span> <span class="o">=</span> <span class="n">MIMEImage</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">imagename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">msgImage</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s1">&#39;Content-ID&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>
        <span class="n">msgRoot</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">msgImage</span><span class="p">)</span>
    <span class="n">sendText</span> <span class="o">=</span> <span class="s1">&#39;&lt;html&gt;&lt;body&gt;&lt;p&gt;web服务器 cpu使用：&lt;/p&gt;&#39;</span> <span class="o">+</span> \
        <span class="s1">&#39;&lt;p&gt;&lt;img src=&quot;cid:525&quot;&gt;&lt;/p&gt;&#39;</span> <span class="o">+</span> \
        <span class="s1">&#39;&lt;p&gt;&lt;img src=&quot;cid:550&quot;&gt;&lt;/p&gt;&#39;</span> <span class="o">+</span> \
        <span class="s1">&#39;&lt;p&gt;web服务器 内存剩余：&lt;/p&gt;&#39;</span> <span class="o">+</span> \
        <span class="s1">&#39;&lt;p&gt;&lt;img src=&quot;cid:534&quot;&gt;&lt;/p&gt;&#39;</span> <span class="o">+</span> \
        <span class="s1">&#39;&lt;p&gt;&lt;img src=&quot;cid:553&quot;&gt;&lt;/p&gt;&#39;</span> <span class="o">+</span> \
        <span class="s1">&#39;&lt;p&gt;web服务器 网络使用：&lt;/p&gt;&#39;</span> <span class="o">+</span> \
        <span class="s1">&#39;&lt;p&gt;&lt;img src=&quot;cid:568&quot;&gt;&lt;/p&gt;&#39;</span> <span class="o">+</span> \
        <span class="s1">&#39;&lt;p&gt;&lt;img src=&quot;cid:575&quot;&gt;&lt;/p&gt;&#39;</span> <span class="o">+</span> \
        <span class="s1">&#39;&lt;p&gt;web服务器 连接数：&lt;/p&gt;&#39;</span> <span class="o">+</span> \
        <span class="s1">&#39;&lt;p&gt;&lt;img src=&quot;cid:626&quot;&gt;&lt;/p&gt;&#39;</span> <span class="o">+</span> \
        <span class="s1">&#39;&lt;p&gt;&lt;img src=&quot;cid:628&quot;&gt;&lt;/p&gt;&#39;</span> <span class="o">+</span> \
        <span class="s1">&#39;&lt;p&gt;mysql服务器 cpu使用：&lt;/p&gt;&#39;</span> <span class="o">+</span> \
        <span class="s1">&#39;&lt;p&gt;&lt;img src=&quot;cid:557&quot;&gt;&lt;/p&gt;&#39;</span> <span class="o">+</span> \
        <span class="s1">&#39;&lt;p&gt;&lt;img src=&quot;cid:564&quot;&gt;&lt;/p&gt;&#39;</span> <span class="o">+</span> \
        <span class="s1">&#39;&lt;p&gt;mysql服务器 内存剩余：&lt;/p&gt;&#39;</span> <span class="o">+</span> \
        <span class="s1">&#39;&lt;p&gt;&lt;img src=&quot;cid:560&quot;&gt;&lt;/p&gt;&#39;</span> <span class="o">+</span> \
        <span class="s1">&#39;&lt;p&gt;&lt;img src=&quot;cid:567&quot;&gt;&lt;/p&gt;&#39;</span> <span class="o">+</span> \
        <span class="s1">&#39;&lt;p&gt;mysql服务器 网络使用：&lt;/p&gt;&#39;</span> <span class="o">+</span> \
        <span class="s1">&#39;&lt;p&gt;&lt;img src=&quot;cid:583&quot;&gt;&lt;/p&gt;&#39;</span> <span class="o">+</span> \
        <span class="s1">&#39;&lt;p&gt;&lt;img src=&quot;cid:590&quot;&gt;&lt;/p&gt;&#39;</span> <span class="o">+</span> \
        <span class="s1">&#39;&lt;p&gt;mysql服务器 查询情况：&lt;/p&gt;&#39;</span> <span class="o">+</span> \
        <span class="s1">&#39;&lt;p&gt;&lt;img src=&quot;cid:614&quot;&gt;&lt;/p&gt;&#39;</span> <span class="o">+</span> \
        <span class="s1">&#39;&lt;p&gt;&lt;img src=&quot;cid:631&quot;&gt;&lt;/p&gt;&#39;</span> <span class="o">+</span> \
    <span class="s1">&#39;&lt;/body&gt;&lt;/html&gt;&#39;</span>
    <span class="n">msgText</span> <span class="o">=</span> <span class="n">MIMEText</span><span class="p">(</span><span class="n">sendText</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">msgRoot</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">msgText</span><span class="p">)</span>
    <span class="n">smtp</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP_SSL</span><span class="p">()</span>
    <span class="n">smtp</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;smtp.exmail.qq.com&#39;</span><span class="p">,</span> <span class="s2">&quot;465&quot;</span><span class="p">)</span>
    <span class="n">smtp</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="s2">&quot;liangguangyu@dachuizichan.com&quot;</span><span class="p">,</span> <span class="s2">&quot;lianggyA01&quot;</span><span class="p">)</span>
    <span class="n">smtp</span><span class="o">.</span><span class="n">sendmail</span><span class="p">(</span><span class="n">msgRoot</span><span class="p">[</span><span class="s1">&#39;From&#39;</span><span class="p">],</span> <span class="n">to_list</span><span class="p">,</span> <span class="n">msgRoot</span><span class="o">.</span><span class="n">as_string</span><span class="p">())</span>
    <span class="n">smtp</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
<span class="c1"># for hostmsg in zab_api(hostget)[&#39;result&#39;]:</span>
<span class="c1">#     print hostmsg[&#39;host&#39;], &#39; : &#39;, hostmsg[&#39;hostid&#39;]</span>
<span class="c1"># Zabbix server  :  10084</span>
<span class="c1"># 192.168.1.6  :  10105</span>
<span class="c1"># 192.168.1.7  :  10106</span>
<span class="c1"># 192.168.1.2  :  10107</span>
<span class="c1"># 192.168.1.3  :  10108</span>
<span class="c1"># web cpu:525 mem:534  net:568 connect:626</span>
<span class="c1"># slave   cpu:550  mem:553 net:575  connect:628</span>
<span class="c1">#mysql  cpu:557   mem:560  net:583  qps: 614</span>
<span class="c1"># mysql-slae cpu:564 mem:567  net:590 qps:631</span>
<span class="c1">#getgraphid(&quot;10084&quot;)</span>
<span class="n">imglist</span> <span class="o">=</span> <span class="p">[</span><span class="mi">525</span><span class="p">,</span><span class="mi">534</span><span class="p">,</span><span class="mi">568</span><span class="p">,</span><span class="mi">626</span><span class="p">,</span><span class="mi">550</span><span class="p">,</span><span class="mi">553</span><span class="p">,</span><span class="mi">575</span><span class="p">,</span><span class="mi">628</span><span class="p">,</span><span class="mi">557</span><span class="p">,</span><span class="mi">560</span><span class="p">,</span><span class="mi">583</span><span class="p">,</span><span class="mi">614</span><span class="p">,</span><span class="mi">564</span><span class="p">,</span><span class="mi">567</span><span class="p">,</span><span class="mi">590</span><span class="p">,</span><span class="mi">631</span><span class="p">]</span>
<span class="k">for</span> <span class="n">graphid</span> <span class="ow">in</span> <span class="n">imglist</span><span class="p">:</span>
    <span class="n">getgraph</span><span class="p">(</span><span class="n">graphid</span><span class="p">)</span>
<span class="n">SendMail</span><span class="p">(</span><span class="n">imglist</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<h2 id="_2">微信告警</h2>
<div class="codehilite"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">cnyunwei</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">thread</span><span class="o">-</span><span class="mi">29593</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mf">1.</span><span class="n">html</span>

<span class="err">申请微信企业号</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">qy</span><span class="o">.</span><span class="n">weixin</span><span class="o">.</span><span class="n">qq</span><span class="o">.</span><span class="n">com</span><span class="o">/</span>


<span class="err">微信</span><span class="n">python</span><span class="err">脚本</span>
<span class="c1">#!/usr/bin/python</span>
<span class="c1"># coding: utf-8</span>
<span class="kn">import</span> <span class="nn">urllib2</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="nb">reload</span><span class="p">(</span><span class="n">sys</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">setdefaultencoding</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">gettoken</span><span class="p">(</span><span class="n">corpid</span><span class="p">,</span> <span class="n">corpsecret</span><span class="p">):</span>
    <span class="n">gettoken_url</span> <span class="o">=</span> <span class="s1">&#39;https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=&#39;</span><span class="o">+</span> <span class="n">corpid</span> <span class="o">+</span> <span class="s1">&#39;&amp;corpsecret=&#39;</span> <span class="o">+</span> <span class="n">corpsecret</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">token_file</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">gettoken_url</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span>
        <span class="k">print</span> <span class="n">e</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="n">token_data</span> <span class="o">=</span> <span class="n">token_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">token_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">token_data</span><span class="p">)</span>
    <span class="n">token_json</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">token_json</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">token</span>
<span class="k">def</span> <span class="nf">senddata</span><span class="p">(</span><span class="n">access_token</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
    <span class="n">send_url</span> <span class="o">=</span> <span class="s1">&#39;https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=&#39;</span> <span class="o">+</span> <span class="n">access_token</span>
    <span class="n">send_values</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;touser&quot;</span><span class="p">:</span> <span class="s2">&quot;@all&quot;</span><span class="p">,</span>    <span class="c1">#@all为所有人</span>
        <span class="s2">&quot;msgtype&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>
        <span class="s2">&quot;agentid&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>   <span class="c1">#企业号中的应用id，消息类型</span>
        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span>
        <span class="p">},</span>
        <span class="s2">&quot;safe&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span>
    <span class="p">}</span>
    <span class="n">send_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">send_values</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">send_request</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">send_url</span><span class="p">,</span> <span class="n">send_data</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">send_request</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="k">print</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">content</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">corpid</span> <span class="o">=</span> <span class="s1">&#39;wxc8b10c89ac3d8f9b&#39;</span>  <span class="c1">#CorpID是企业号的标识</span>
    <span class="n">corpsecret</span> <span class="o">=</span> <span class="s1">&#39;Y9dS4chGDIpFmqDP_tT_FQlDHWMuFcjM_RzTnakwf7rnmhNE8mveeQuD44qTEp4x&#39;</span>  <span class="c1">#corpsecretSecret是管理组凭证密钥</span>
    <span class="n">accesstoken</span> <span class="o">=</span> <span class="n">gettoken</span><span class="p">(</span><span class="n">corpid</span><span class="p">,</span> <span class="n">corpsecret</span><span class="p">)</span>
    <span class="n">senddata</span><span class="p">(</span><span class="n">accesstoken</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>

<span class="n">mv</span> <span class="n">weixin</span><span class="o">.</span><span class="n">sh</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">zabbix</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">zabbix</span><span class="o">/</span><span class="n">alertscripts</span>
<span class="n">chown</span> <span class="n">zabbix</span><span class="o">.</span><span class="n">zabbix</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">zabbix</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">zabbix</span><span class="o">/</span><span class="n">alertscripts</span><span class="o">/</span><span class="n">weixin</span><span class="o">.</span><span class="n">sh</span>
<span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">zabbix</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">zabbix</span><span class="o">/</span><span class="n">alertscripts</span><span class="o">/</span><span class="n">weixin</span><span class="o">.</span><span class="n">sh</span>
<span class="err">配置</span><span class="n">zabbix</span>

<span class="mf">3.1</span><span class="err">、添加报警媒介</span>

<span class="mf">4.</span><span class="n">png</span>

<span class="mf">3.2</span><span class="err">、用户添加报警媒介，这里使用默认的</span><span class="n">administrator</span><span class="err">用户</span>

<span class="mf">5.</span><span class="n">png</span>

<span class="mf">3.3</span><span class="err">、添加报警动作</span>

<span class="mf">6.</span><span class="n">png</span>

<span class="err">信息如下，使用默认的信息也可以</span>



<span class="err">修改操作条件，使用默认的也是可以的</span>
</pre></div>


<h2 id="nginx_1">监控nginx</h2>
<div class="codehilite"><pre><span></span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">conf</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="k">default</span><span class="p">.</span><span class="n">conf</span><span class="w"> </span>
<span class="n">添加</span><span class="w"></span>
<span class="n">location</span><span class="w"> </span><span class="o">/</span><span class="n">ngx_status</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">        </span><span class="n">stub_status</span><span class="w"> </span><span class="k">on</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">access_log</span><span class="w"> </span><span class="k">off</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">allow</span><span class="w"> </span><span class="mf">127.0.0.1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">deny</span><span class="w"> </span><span class="ow">all</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="err">}</span><span class="w"></span>

<span class="n">curl</span><span class="w"> </span><span class="nl">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="o">/</span><span class="n">ngx_status</span><span class="w"></span>
<span class="n">Active</span><span class="w"> </span><span class="nl">connections</span><span class="p">:</span><span class="w"> </span><span class="mi">362</span><span class="w"></span>
<span class="n">server</span><span class="w"> </span><span class="n">accepts</span><span class="w"> </span><span class="n">handled</span><span class="w"> </span><span class="n">requests</span><span class="w"></span>
<span class="mi">6823</span><span class="w"> </span><span class="mi">6823</span><span class="w"> </span><span class="mi">6821</span><span class="w"></span>
<span class="nl">Reading</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nl">Writing</span><span class="p">:</span><span class="w"> </span><span class="mi">362</span><span class="w"> </span><span class="nl">Waiting</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="n">第1列</span><span class="err">：</span><span class="w"></span>
<span class="n">当前与http建立的连接数</span><span class="err">，</span><span class="n">包括等待的客户端连接</span><span class="err">：</span><span class="mi">2</span><span class="w"></span>

<span class="n">第2列</span><span class="err">：</span><span class="w"></span>
<span class="n">接受的客户端连接总数目</span><span class="err">：</span><span class="mi">20</span><span class="w"></span>
<span class="n">处理的客户端连接总数目</span><span class="err">：</span><span class="mi">20</span><span class="w"></span>
<span class="n">客户端总的请求数目</span><span class="err">：</span><span class="mi">50</span><span class="w"></span>

<span class="n">第3列</span><span class="err">：</span><span class="w"></span>
<span class="n">当前</span><span class="err">，</span><span class="n">nginx读请求连接</span><span class="w"></span>
<span class="n">当前</span><span class="err">，</span><span class="n">nginx写响应返回给客户端</span><span class="w"></span>
<span class="n">目前有多少空闲客户端请求连接</span><span class="w"></span>

<span class="n">ngx_status</span><span class="p">.</span><span class="n">sh</span><span class="err">：</span><span class="w"></span>
<span class="err">#!</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="nc">DateTime</span><span class="err">:</span><span class="w"> </span><span class="mi">2015</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">25</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="n">AUTHOR</span><span class="err">：</span><span class="n">凉白开</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="nl">WEBSITE</span><span class="p">:</span><span class="w"> </span><span class="nl">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="p">.</span><span class="n">ttlsa</span><span class="p">.</span><span class="n">com</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="n">Description</span><span class="err">：</span><span class="n">zabbix监控nginx性能以及进程状态</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="n">Note</span><span class="err">：</span><span class="n">此脚本需要配置在被监控端</span><span class="err">，</span><span class="n">否则ping检测将会得到不符合预期的结果</span><span class="w"></span>
<span class="w"> </span><span class="err">‎</span><span class="w"></span>

<span class="k">HOST</span><span class="o">=</span><span class="ss">&quot;127.0.0.1&quot;</span><span class="w"></span>
<span class="n">PORT</span><span class="o">=</span><span class="ss">&quot;80&quot;</span><span class="w"></span>

<span class="err">#</span><span class="w"> </span><span class="n">检测nginx进程是否存在</span><span class="w"></span>
<span class="k">function</span><span class="w"> </span><span class="n">ping</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">    </span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">pidof</span><span class="w"> </span><span class="n">nginx</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">wc</span><span class="w"> </span><span class="o">-</span><span class="n">l</span><span class="w"> </span>
<span class="err">}</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="n">检测nginx性能</span><span class="w"></span>
<span class="k">function</span><span class="w"> </span><span class="n">active</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">    </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="ss">&quot;http://$HOST:$PORT/ngx_status/&quot;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="s1">&#39;Active&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">awk</span><span class="w"> </span><span class="s1">&#39;{print $NF}&#39;</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>
<span class="k">function</span><span class="w"> </span><span class="n">reading</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">    </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="ss">&quot;http://$HOST:$PORT/ngx_status/&quot;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="s1">&#39;Reading&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">awk</span><span class="w"> </span><span class="s1">&#39;{print $2}&#39;</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>
<span class="k">function</span><span class="w"> </span><span class="n">writing</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">    </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="ss">&quot;http://$HOST:$PORT/ngx_status/&quot;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="s1">&#39;Writing&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">awk</span><span class="w"> </span><span class="s1">&#39;{print $4}&#39;</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>
<span class="k">function</span><span class="w"> </span><span class="n">waiting</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">    </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="ss">&quot;http://$HOST:$PORT/ngx_status/&quot;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="s1">&#39;Waiting&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">awk</span><span class="w"> </span><span class="s1">&#39;{print $6}&#39;</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>
<span class="k">function</span><span class="w"> </span><span class="n">accepts</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">    </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="ss">&quot;http://$HOST:$PORT/ngx_status/&quot;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">awk</span><span class="w"> </span><span class="n">NR</span><span class="o">==</span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">awk</span><span class="w"> </span><span class="s1">&#39;{print $1}&#39;</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>
<span class="k">function</span><span class="w"> </span><span class="n">handled</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">    </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="ss">&quot;http://$HOST:$PORT/ngx_status/&quot;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">awk</span><span class="w"> </span><span class="n">NR</span><span class="o">==</span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">awk</span><span class="w"> </span><span class="s1">&#39;{print $2}&#39;</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>
<span class="k">function</span><span class="w"> </span><span class="n">requests</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">    </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="ss">&quot;http://$HOST:$PORT/ngx_status/&quot;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">awk</span><span class="w"> </span><span class="n">NR</span><span class="o">==</span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">awk</span><span class="w"> </span><span class="s1">&#39;{print $3}&#39;</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="n">执行function</span><span class="w"></span>
<span class="err">$</span><span class="mi">1</span><span class="w"></span>

<span class="n">#cat</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">zabbix</span><span class="o">-</span><span class="mf">3.0.0</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">zabbix_agentd</span><span class="p">.</span><span class="n">conf</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="n">nginx</span><span class="w"></span>
<span class="n">UserParameter</span><span class="o">=</span><span class="n">nginx</span><span class="p">.</span><span class="n">status</span><span class="o">[</span><span class="n">*</span><span class="o">]</span><span class="p">,</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">zabbix</span><span class="o">-</span><span class="mf">3.0.0</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">ngx</span><span class="o">-</span><span class="n">status</span><span class="p">.</span><span class="n">sh</span><span class="w"> </span><span class="err">$</span><span class="mi">1</span><span class="w"></span>

<span class="n">测试</span><span class="w"></span>
<span class="err">#</span><span class="w"> </span><span class="n">zabbix_get</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="mf">10.10.1.121</span><span class="w"> </span><span class="o">-</span><span class="n">k</span><span class="w"> </span><span class="s1">&#39;nginx.status[accepts]&#39;</span><span class="w"></span>
<span class="mi">9570756</span><span class="w"></span>
<span class="n">#zabbix_get</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="mf">10.10.1.121</span><span class="w"> </span><span class="o">-</span><span class="n">k</span><span class="w"> </span><span class="s1">&#39;nginx.status[ping]&#39;</span><span class="w"></span>
<span class="mi">1</span><span class="w"></span>
</pre></div>


<h2 id="zabbix_1">zabbix安装</h2>
<div class="codehilite"><pre><span></span><span class="nv">mysql</span>优化三板斧       
<span class="nv">http</span>:<span class="o">//</span><span class="nv">www</span>.<span class="nv">woqutech</span>.<span class="nv">com</span><span class="o">/</span>?<span class="nv">p</span><span class="o">=</span><span class="mi">1200</span>
<span class="nv">zabbix</span>的数据存到<span class="nv">mysql</span>中，后期会有<span class="nv">IO</span>瓶颈，提前做好规划。

<span class="nv">zabbix</span>官网
<span class="nv">http</span>:<span class="o">//</span><span class="nv">www</span>.<span class="nv">zabbix</span>.<span class="nv">com</span><span class="o">/</span>

<span class="nv">https</span>:<span class="o">//</span><span class="nv">github</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">leonanu</span><span class="o">/</span><span class="nv">moss</span><span class="o">/</span>
（<span class="nv">lamp</span>等环境自动部署）

安装依赖（配置好网络<span class="nv">yum</span>源）
<span class="nv">yum</span> <span class="o">-</span><span class="nv">y</span> <span class="nv">install</span> <span class="nv">gcc</span> <span class="nv">gcc</span><span class="o">-</span><span class="nv">c</span><span class="o">++</span> <span class="nv">autoconf</span> <span class="nv">httpd</span> <span class="nv">php</span> <span class="nv">mysql</span> <span class="nv">mysql</span><span class="o">-</span><span class="nv">server</span> <span class="nv">php</span><span class="o">-</span><span class="nv">mysql</span> <span class="nv">httpd</span><span class="o">-</span><span class="nv">manual</span> <span class="nv">mod_ssl</span> 
<span class="nv">mod_perl</span> <span class="nv">mod_auth_mysql</span> <span class="nv">php</span><span class="o">-</span><span class="nv">gd</span> <span class="nv">php</span><span class="o">-</span><span class="nv">xml</span> <span class="nv">php</span><span class="o">-</span><span class="nv">mbstring</span> <span class="nv">php</span><span class="o">-</span><span class="nv">ldap</span> <span class="nv">php</span><span class="o">-</span><span class="nv">pear</span> <span class="nv">php</span><span class="o">-</span><span class="nv">xmlrpc</span> <span class="nv">php</span><span class="o">-</span><span class="nv">bcmath</span> 
<span class="nv">mysql</span><span class="o">-</span><span class="nv">connector</span><span class="o">-</span><span class="nv">odbc</span> <span class="nv">mysql</span><span class="o">-</span><span class="nv">devel</span> <span class="nv">libdbi</span><span class="o">-</span><span class="nv">dbd</span><span class="o">-</span><span class="nv">mysql</span> <span class="nv">net</span><span class="o">-</span><span class="nv">snmp</span><span class="o">-</span><span class="nv">devel</span> <span class="nv">curl</span><span class="o">-</span><span class="nv">devel</span> <span class="nv">unixODBC</span><span class="o">-</span><span class="nv">devel</span> 
<span class="nv">OpenIPMI</span><span class="o">-</span><span class="nv">devel</span> <span class="nv">java</span><span class="o">-</span><span class="nv">devel</span> <span class="nv">libssh2</span><span class="o">-</span><span class="nv">devel</span> <span class="nv">openldap</span>
修改<span class="nv">php</span>
<span class="nv">sed</span> <span class="o">-</span><span class="nv">i</span> <span class="s2">&quot;</span><span class="s">s/;date.timezone =/date.timezone = Asia\/Shanghai/g</span><span class="s2">&quot;</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">php</span>.<span class="nv">ini</span>
<span class="nv">sed</span> <span class="o">-</span><span class="nv">i</span> <span class="s2">&quot;</span><span class="s">s#max_execution_time = 30#max_execution_time = 300#g</span><span class="s2">&quot;</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">php</span>.<span class="nv">ini</span>
<span class="nv">sed</span> <span class="o">-</span><span class="nv">i</span> <span class="s2">&quot;</span><span class="s">s#post_max_size = 8M#post_max_size = 32M#g</span><span class="s2">&quot;</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">php</span>.<span class="nv">ini</span>
<span class="nv">sed</span> <span class="o">-</span><span class="nv">i</span> <span class="s2">&quot;</span><span class="s">s#max_input_time = 60#max_input_time = 300#g</span><span class="s2">&quot;</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">php</span>.<span class="nv">ini</span>
<span class="nv">sed</span> <span class="o">-</span><span class="nv">i</span> <span class="s2">&quot;</span><span class="s">s#memory_limit = 128M#memory_limit = 128M#g</span><span class="s2">&quot;</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">php</span>.<span class="nv">ini</span>
#<span class="nv">sed</span> <span class="o">-</span><span class="nv">i</span> <span class="s2">&quot;</span><span class="s">/;mbstring.func_overload = 0/ambstring.func_overload = 2</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">php</span>.<span class="nv">ini</span>
开启<span class="nv">mysql</span>，<span class="nv">apache</span>
<span class="nv">chkconfig</span> <span class="nv">mysqld</span> <span class="nv">on</span>
<span class="nv">chkconfig</span> <span class="nv">httpd</span> <span class="nv">on</span>
<span class="nv">service</span> <span class="nv">mysqld</span> <span class="nv">start</span>
<span class="nv">service</span> <span class="nv">httpd</span> <span class="nv">start</span>
安装（也可以直接<span class="nv">yum</span>安装）
<span class="nv">groupadd</span> <span class="nv">zabbix</span> <span class="o">-</span><span class="nv">g</span> <span class="mi">201</span>
<span class="nv">useradd</span> <span class="o">-</span><span class="nv">g</span> <span class="nv">zabbix</span> <span class="o">-</span><span class="nv">u</span> <span class="mi">201</span> <span class="o">-</span><span class="nv">m</span> <span class="nv">zabbix</span>
<span class="nv">cd</span> <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">src</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">-</span><span class="mi">2</span>.<span class="mi">4</span>.<span class="mi">6</span>
.<span class="o">/</span><span class="nv">configure</span> <span class="o">--</span><span class="nv">prefix</span><span class="o">=/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">zabbix</span> <span class="o">--</span><span class="nv">sysconfdir</span><span class="o">=/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">zabbix</span> <span class="o">--</span><span class="nv">enable</span><span class="o">-</span><span class="nv">server</span> <span class="o">--</span><span class="nv">enable</span><span class="o">-</span><span class="nv">proxy</span> 
<span class="o">--</span><span class="nv">enable</span><span class="o">-</span><span class="nv">agent</span> <span class="o">--</span><span class="nv">enable</span><span class="o">-</span><span class="nv">ipv6</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">mysql</span><span class="o">=/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">mysql_config</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">net</span><span class="o">-</span><span class="nv">snmp</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">libcurl</span> 
<span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">openipmi</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">unixodbc</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">ldap</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">ssh2</span> <span class="o">--</span><span class="nv">enable</span><span class="o">-</span><span class="nv">java</span>（某些功能不需要可以不写）
<span class="nv">make</span> <span class="o">&amp;&amp;</span> <span class="nv">make</span> <span class="nv">install</span>


创建<span class="nv">mysql</span>库导入数据
<span class="nv">mysql</span> <span class="o">-</span><span class="nv">uroot</span> <span class="o">-</span><span class="nv">e</span> <span class="s2">&quot;</span><span class="s">create database zabbix character set utf8;</span><span class="s2">&quot;</span>
<span class="nv">mysql</span> <span class="o">-</span><span class="nv">uroot</span> <span class="o">-</span><span class="nv">e</span> <span class="s2">&quot;</span><span class="s">grant all privileges on zabbix.* to zabbix@localhost identified by &#39;zabbix&#39;;</span><span class="s2">&quot;</span>
<span class="nv">mysql</span> <span class="o">-</span><span class="nv">uroot</span> <span class="o">-</span><span class="nv">e</span> <span class="s2">&quot;</span><span class="s">flush privileges;</span><span class="s2">&quot;</span>
<span class="nv">mysql</span> <span class="o">-</span><span class="nv">uzabbix</span> <span class="o">-</span><span class="nv">pzabbix</span> <span class="nv">zabbix</span> <span class="o">&lt;</span> .<span class="o">/</span><span class="nv">database</span><span class="o">/</span><span class="nv">mysql</span><span class="o">/</span><span class="nv">schema</span>.<span class="nv">sql</span>
<span class="nv">mysql</span> <span class="o">-</span><span class="nv">uzabbix</span> <span class="o">-</span><span class="nv">pzabbix</span> <span class="nv">zabbix</span> <span class="o">&lt;</span> .<span class="o">/</span><span class="nv">database</span><span class="o">/</span><span class="nv">mysql</span><span class="o">/</span><span class="nv">images</span>.<span class="nv">sql</span>
<span class="nv">mysql</span> <span class="o">-</span><span class="nv">uzabbix</span> <span class="o">-</span><span class="nv">pzabbix</span> <span class="nv">zabbix</span> <span class="o">&lt;</span> .<span class="o">/</span><span class="nv">database</span><span class="o">/</span><span class="nv">mysql</span><span class="o">/</span><span class="nv">data</span>.<span class="nv">sql</span>

<span class="nv">zabbix</span>的<span class="nv">web</span>界面和<span class="nv">log</span>目录
<span class="nv">cp</span> <span class="o">-</span><span class="nv">r</span> .<span class="o">/</span><span class="nv">frontends</span><span class="o">/</span><span class="nv">php</span><span class="o">/</span> <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">www</span><span class="o">/</span><span class="nv">html</span><span class="o">/</span><span class="nv">zabbix</span>
<span class="nv">chown</span> <span class="o">-</span><span class="nv">R</span> <span class="nv">apache</span>.<span class="nv">apache</span> <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">www</span><span class="o">/</span><span class="nv">html</span><span class="o">/</span><span class="nv">zabbix</span>
<span class="nv">mkdir</span> <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">log</span><span class="o">/</span><span class="nv">zabbix</span>
<span class="nv">chown</span> <span class="nv">zabbix</span>.<span class="nv">zabbix</span> <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">log</span><span class="o">/</span><span class="nv">zabbix</span>
启动脚本
<span class="nv">cp</span> <span class="nv">misc</span><span class="o">/</span><span class="nv">init</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">fedora</span><span class="o">/</span><span class="nv">core</span><span class="o">/</span><span class="nv">zabbix_</span><span class="o">*</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">init</span>.<span class="nv">d</span><span class="o">/</span>
<span class="nv">chmod</span> <span class="mi">755</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">init</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">zabbix_</span><span class="o">*</span>
配置
<span class="nv">sed</span> <span class="o">-</span><span class="nv">i</span> <span class="s2">&quot;</span><span class="s">s#BASEDIR=/usr/local#BASEDIR=/usr/local/zabbix#g</span><span class="s2">&quot;</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">init</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">zabbix_server</span>
<span class="nv">sed</span> <span class="o">-</span><span class="nv">i</span> <span class="s2">&quot;</span><span class="s">s#BASEDIR=/usr/local#BASEDIR=/usr/local/zabbix#g</span><span class="s2">&quot;</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">init</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">zabbix_agentd</span>
<span class="nv">sed</span> <span class="o">-</span><span class="nv">i</span> <span class="s2">&quot;</span><span class="s">s#tmp/zabbix_server.log#var/log/zabbix/zabbix_server.log#g</span><span class="s2">&quot;</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">zabbix_server</span>.<span class="nv">conf</span>
<span class="nv">sed</span> <span class="o">-</span><span class="nv">i</span> <span class="s2">&quot;</span><span class="s">s/ServerActive\=127.0.0.1/ServerActive\=127.0.0.1:10051/g</span><span class="s2">&quot;</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">zabbix_agentd</span>.<span class="nv">conf</span>
<span class="nv">sed</span> <span class="o">-</span><span class="nv">i</span> <span class="s2">&quot;</span><span class="s">s#tmp/zabbix_agentd.log#var/log/zabbix/zabbix_agentd.log#g</span><span class="s2">&quot;</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">zabbix_agentd</span>.<span class="nv">conf</span>
<span class="nv">sed</span> <span class="o">-</span><span class="nv">i</span> <span class="s2">&quot;</span><span class="s">#UnsafeUserParameters=0#aUnsafeUserParameters=1</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">zabbix_agentd</span>.<span class="nv">conf</span>
<span class="nv">chkconfig</span> <span class="nv">zabbix_server</span> <span class="nv">on</span>
<span class="nv">chkconfig</span> <span class="nv">zabbix_agentd</span> <span class="nv">on</span>
<span class="nv">service</span> <span class="nv">zabbix_server</span> <span class="nv">start</span>
<span class="nv">service</span> <span class="nv">zabbix_agentd</span> <span class="nv">start</span>
<span class="o">----------------------------------------------------------------------------</span>
<span class="nv">yum</span>安装
<span class="nv">rpm</span> <span class="o">-</span><span class="nv">ivh</span> <span class="nv">http</span>:<span class="o">//</span><span class="nv">repo</span>.<span class="nv">zabbix</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="mi">2</span>.<span class="mi">4</span><span class="o">/</span><span class="nv">rhel</span><span class="o">/</span><span class="mi">6</span><span class="o">/</span><span class="nv">x86_64</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">-</span><span class="nv">release</span><span class="o">-</span><span class="mi">2</span>.<span class="mi">4</span><span class="o">-</span><span class="mi">1</span>.<span class="nv">el6</span>.<span class="nv">noarch</span>.<span class="nv">rpm</span>
<span class="nv">yum</span> <span class="nv">install</span> <span class="nv">zabbix</span><span class="o">-</span><span class="nv">server</span><span class="o">-</span><span class="nv">mysql</span> <span class="nv">zabbix</span><span class="o">-</span><span class="nv">web</span><span class="o">-</span><span class="nv">mysql</span>  <span class="nv">zabbix</span><span class="o">-</span><span class="nv">server</span>

# <span class="nv">cd</span> <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">share</span><span class="o">/</span><span class="nv">doc</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">-</span><span class="nv">server</span><span class="o">-</span><span class="nv">mysql</span><span class="o">-</span><span class="mi">2</span>.<span class="mi">4</span>.<span class="mi">0</span><span class="o">/</span><span class="nv">create</span>
# <span class="nv">mysql</span> <span class="o">-</span><span class="nv">uroot</span> <span class="nv">zabbix</span> <span class="o">&lt;</span> <span class="nv">schema</span>.<span class="nv">sql</span>
# <span class="nv">mysql</span> <span class="o">-</span><span class="nv">uroot</span> <span class="nv">zabbix</span> <span class="o">&lt;</span> <span class="nv">images</span>.<span class="nv">sql</span>
# <span class="nv">mysql</span> <span class="o">-</span><span class="nv">uroot</span> <span class="nv">zabbix</span> <span class="o">&lt;</span> <span class="nv">data</span>.<span class="nv">sql</span>

# <span class="nv">vi</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">zabbix_server</span>.<span class="nv">conf</span>
<span class="nv">DBHost</span><span class="o">=</span><span class="nv">localhost</span>
<span class="nv">DBName</span><span class="o">=</span><span class="nv">zabbix</span>
<span class="nv">DBUser</span><span class="o">=</span><span class="nv">zabbix</span>
<span class="nv">DBPassword</span><span class="o">=</span><span class="nv">zabbix</span>
<span class="nv">StartPollers</span><span class="o">=</span><span class="mi">10</span>
<span class="nv">StartPollersUnreachable</span><span class="o">=</span><span class="mi">80</span>
<span class="nv">StartTrappers</span><span class="o">=</span><span class="mi">15</span>
<span class="nv">StartPingers</span><span class="o">=</span><span class="mi">4</span>
<span class="nv">StartDiscoverers</span><span class="o">=</span><span class="mi">0</span>
<span class="nv">HousekeepingFrequency</span><span class="o">=</span><span class="mi">1</span>
<span class="nv">CacheSize</span><span class="o">=</span><span class="mi">384</span><span class="nv">M</span>
<span class="nv">CacheUpdateFrequency</span><span class="o">=</span><span class="mi">300</span>
<span class="nv">StartDBSyncers</span><span class="o">=</span><span class="mi">8</span>
<span class="nv">HistoryCacheSize</span><span class="o">=</span><span class="mi">512</span><span class="nv">M</span>
<span class="nv">TrendCacheSize</span><span class="o">=</span><span class="mi">384</span><span class="nv">M</span>
<span class="nv">HistoryTextCacheSize</span><span class="o">=</span><span class="mi">512</span><span class="nv">M</span>
<span class="nb">Timeout</span><span class="o">=</span><span class="mi">30</span>
<span class="nv">LogSlowQueries</span><span class="o">=</span><span class="mi">1000</span>
<span class="k">Include</span><span class="o">=/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">zabbix_server</span>.<span class="nv">conf</span>.<span class="nv">d</span><span class="o">/</span>
#<span class="nv">AlertScriptsPath</span><span class="o">=/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">alertscripts</span>
#<span class="nv">ExternalScripts</span><span class="o">=/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">externalscripts</span>
#<span class="nv">FpingLocation</span><span class="o">=/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">sbin</span><span class="o">/</span><span class="nv">fping</span>

# <span class="nv">service</span> <span class="nv">zabbix</span><span class="o">-</span><span class="nv">server</span> <span class="nv">start</span>
</pre></div>


<h2 id="http">http不同时间监控</h2>
<div class="codehilite"><pre><span></span><span class="n">zabbix</span> <span class="err">的</span> <span class="n">discovery</span><span class="err">功能</span>
<span class="err">监控</span><span class="n">dns</span><span class="err">，连接，传输，总共等不同时间段</span>

<span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">zabbix</span><span class="o">/</span><span class="n">zabbix_agentd</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">http_time</span><span class="o">.</span><span class="n">conf</span> 
<span class="n">UserParameter</span><span class="o">=</span><span class="n">HttpUrl</span><span class="p">,</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">zabbix</span><span class="o">/</span><span class="n">httpurl</span><span class="o">.</span><span class="n">py</span>
<span class="n">UserParameter</span><span class="o">=</span><span class="n">http_dns</span><span class="p">[</span><span class="o">*</span><span class="p">],</span><span class="n">curl</span> <span class="o">-</span><span class="n">o</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">w</span> <span class="o">%</span><span class="p">{</span><span class="n">time_namelookup</span><span class="p">}</span> <span class="err">$</span><span class="mi">1</span>
<span class="n">UserParameter</span><span class="o">=</span><span class="n">http_connect</span><span class="p">[</span><span class="o">*</span><span class="p">],</span><span class="n">curl</span> <span class="o">-</span><span class="n">o</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">w</span> <span class="o">%</span><span class="p">{</span><span class="n">time_connect</span><span class="p">}</span> <span class="err">$</span><span class="mi">1</span>
<span class="n">UserParameter</span><span class="o">=</span><span class="n">http_transfer</span><span class="p">[</span><span class="o">*</span><span class="p">],</span><span class="n">curl</span> <span class="o">-</span><span class="n">o</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">w</span> <span class="o">%</span><span class="p">{</span><span class="n">time_starttransfer</span><span class="p">}</span> <span class="err">$</span><span class="mi">1</span>
<span class="n">UserParameter</span><span class="o">=</span><span class="n">http_total</span><span class="p">[</span><span class="o">*</span><span class="p">],</span><span class="n">curl</span> <span class="o">-</span><span class="n">o</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">w</span> <span class="o">%</span><span class="p">{</span><span class="n">time_total</span><span class="p">}</span> <span class="err">$</span><span class="mi">1</span>


<span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">zabbix</span><span class="o">/</span><span class="n">httpurl</span><span class="o">.</span><span class="n">py</span>    <span class="err">不要放到</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">zabbix</span><span class="o">/</span><span class="n">zabbix_agentd</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="err">下面</span>
<span class="c1">#!/usr/bin/env python</span>
<span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">dumps</span>
<span class="n">url_list</span><span class="o">=</span><span class="p">[</span>
<span class="s2">&quot;http://60.205.128.141/3m/17zuoye/1106/live/config/Server.json&quot;</span><span class="p">,</span>
<span class="s2">&quot;http://doc5.3mang.com&quot;</span>
<span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">list2</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">url_list</span><span class="p">:</span>
    <span class="n">Url</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">Url</span><span class="p">[</span><span class="s1">&#39;{#HTTP_URL}&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">url</span>
    <span class="n">list2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Url</span><span class="p">)</span>

<span class="n">data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">list2</span>
<span class="n">jsonStr</span> <span class="o">=</span> <span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="k">print</span> <span class="n">jsonStr</span>


<span class="n">curl</span><span class="err">的部分时间等变量注释：</span>

<span class="n">url_effective</span> <span class="n">The</span> <span class="n">URL</span> <span class="n">that</span> <span class="n">was</span> <span class="n">fetched</span> <span class="n">last</span><span class="o">.</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">most</span> <span class="n">meaningful</span> <span class="k">if</span> <span class="n">you</span><span class="s1">&#39;ve told curl to follow location: headers.</span>

<span class="n">filename_effective</span> <span class="n">The</span> <span class="n">ultimate</span> <span class="n">filename</span> <span class="n">that</span> <span class="n">curl</span> <span class="n">writes</span> <span class="n">out</span> <span class="n">to</span><span class="o">.</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">only</span> <span class="n">meaningful</span> <span class="k">if</span> <span class="n">curl</span> <span class="ow">is</span> <span class="n">told</span> 
<span class="n">to</span> <span class="n">write</span> <span class="n">to</span> <span class="n">a</span> <span class="nb">file</span> <span class="k">with</span> <span class="n">the</span> <span class="o">--</span><span class="n">remote</span><span class="o">-</span><span class="n">name</span> <span class="ow">or</span> <span class="o">--</span><span class="n">output</span> <span class="n">option</span><span class="o">.</span> <span class="n">It</span><span class="s1">&#39;s most useful in combination with the </span>
<span class="o">--</span><span class="n">remote</span><span class="o">-</span><span class="n">header</span><span class="o">-</span><span class="n">name</span> <span class="n">option</span><span class="o">.</span> <span class="p">(</span><span class="n">Added</span> <span class="ow">in</span> <span class="mf">7.25</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span>

<span class="n">http_code</span> <span class="n">http</span><span class="err">状态码，如</span><span class="mi">200</span><span class="err">成功</span><span class="p">,</span><span class="mi">301</span><span class="err">转向</span><span class="p">,</span><span class="mi">404</span><span class="err">未找到</span><span class="p">,</span><span class="mi">500</span><span class="err">服务器错误等。</span><span class="p">(</span><span class="n">The</span> <span class="n">numerical</span> <span class="n">response</span> <span class="n">code</span> <span class="n">that</span> <span class="n">was</span> <span class="n">found</span>
 <span class="ow">in</span> <span class="n">the</span> <span class="n">last</span> <span class="n">retrieved</span> <span class="n">HTTP</span><span class="p">(</span><span class="n">S</span><span class="p">)</span> <span class="ow">or</span> <span class="n">FTP</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">transfer</span><span class="o">.</span> <span class="n">In</span> <span class="mf">7.18</span><span class="o">.</span><span class="mi">2</span> <span class="n">the</span> <span class="n">alias</span> <span class="n">response_code</span> <span class="n">was</span> <span class="n">added</span> <span class="n">to</span> <span class="n">show</span> <span class="n">the</span> <span class="n">same</span> <span class="n">info</span><span class="o">.</span><span class="p">)</span>

<span class="n">http_connect</span> <span class="n">The</span> <span class="n">numerical</span> <span class="n">code</span> <span class="n">that</span> <span class="n">was</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">last</span> <span class="n">response</span> <span class="p">(</span><span class="kn">from</span> <span class="nn">a</span> <span class="nn">proxy</span><span class="p">)</span> <span class="n">to</span> <span class="n">a</span> <span class="n">curl</span> <span class="n">CONNECT</span> <span class="n">request</span>
<span class="o">.</span> <span class="p">(</span><span class="n">Added</span> <span class="ow">in</span> <span class="mf">7.12</span><span class="o">.</span><span class="mi">4</span><span class="p">)</span>

<span class="n">time_total</span> <span class="err">总时间，按秒计。精确到小数点后三位。</span> <span class="err">（</span><span class="n">The</span> <span class="n">total</span> <span class="n">time</span><span class="p">,</span> <span class="ow">in</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">that</span> <span class="n">the</span> <span class="n">full</span> <span class="n">operation</span> <span class="n">lasted</span><span class="o">.</span> 

<span class="n">The</span> <span class="n">time</span> <span class="n">will</span> <span class="n">be</span> <span class="n">displayed</span> <span class="k">with</span> <span class="n">millisecond</span> <span class="n">resolution</span><span class="o">.</span><span class="err">）</span>

<span class="n">time_namelookup</span> <span class="n">DNS</span><span class="err">解析时间</span><span class="p">,</span><span class="err">从请求开始到</span><span class="n">DNS</span><span class="err">解析完毕所用时间。</span><span class="p">(</span><span class="n">The</span> <span class="n">time</span><span class="p">,</span> <span class="ow">in</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">it</span> <span class="n">took</span> <span class="kn">from</span> <span class="nn">the</span> <span class="nn">start</span> <span class="nn">until</span>
 <span class="n">the</span> <span class="n">name</span> <span class="n">resolving</span> <span class="n">was</span> <span class="n">completed</span><span class="o">.</span><span class="p">)</span>

<span class="n">time_connect</span> <span class="err">连接时间</span><span class="p">,</span><span class="err">从开始到建立</span><span class="n">TCP</span><span class="err">连接完成所用时间</span><span class="p">,</span><span class="err">包括前边</span><span class="n">DNS</span><span class="err">解析时间，如果需要单纯的得到连接时间，用这个</span>
<span class="n">time_connect</span><span class="err">时间减去前边</span><span class="n">time_namelookup</span><span class="err">时间。以下同理，不再赘述。</span><span class="p">(</span><span class="n">The</span> <span class="n">time</span><span class="p">,</span> <span class="ow">in</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">it</span> <span class="n">took</span> <span class="kn">from</span> <span class="nn">the</span>
 <span class="n">start</span> <span class="n">until</span> <span class="n">the</span> <span class="n">TCP</span> <span class="n">connect</span> <span class="n">to</span> <span class="n">the</span> <span class="n">remote</span> <span class="n">host</span> <span class="p">(</span><span class="ow">or</span> <span class="n">proxy</span><span class="p">)</span> <span class="n">was</span> <span class="n">completed</span><span class="o">.</span><span class="p">)</span>

<span class="n">time_appconnect</span> <span class="err">连接建立完成时间，如</span><span class="n">SSL</span><span class="o">/</span><span class="n">SSH</span><span class="err">等建立连接或者完成三次握手时间。</span><span class="p">(</span><span class="n">The</span> <span class="n">time</span><span class="p">,</span> <span class="ow">in</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">it</span> <span class="n">took</span> 
<span class="kn">from</span> <span class="nn">the</span> <span class="nn">start</span> <span class="nn">until</span> <span class="nn">the</span> <span class="nn">SSL</span><span class="o">/</span><span class="n">SSH</span><span class="o">/</span><span class="n">etc</span> <span class="n">connect</span><span class="o">/</span><span class="n">handshake</span> <span class="n">to</span> <span class="n">the</span> <span class="n">remote</span> <span class="n">host</span> <span class="n">was</span> <span class="n">completed</span><span class="o">.</span> <span class="p">(</span><span class="n">Added</span> <span class="ow">in</span> <span class="mf">7.19</span><span class="o">.</span><span class="mi">0</span><span class="p">))</span>

<span class="n">time_pretransfer</span> <span class="err">从开始到准备传输的时间。</span><span class="p">(</span><span class="n">The</span> <span class="n">time</span><span class="p">,</span> <span class="ow">in</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">it</span> <span class="n">took</span> <span class="kn">from</span> <span class="nn">the</span> <span class="nn">start</span> <span class="nn">until</span> <span class="nn">the</span> <span class="nn">file</span> 
<span class="n">transfer</span> <span class="n">was</span> <span class="n">just</span> <span class="n">about</span> <span class="n">to</span> <span class="n">begin</span><span class="o">.</span> <span class="n">This</span> <span class="n">includes</span> <span class="nb">all</span> <span class="n">pre</span><span class="o">-</span><span class="n">transfer</span> <span class="n">commands</span> <span class="ow">and</span> <span class="n">negotiations</span> <span class="n">that</span> <span class="n">are</span> 
<span class="n">specific</span> <span class="n">to</span> <span class="n">the</span> <span class="n">particular</span> <span class="n">protocol</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">involved</span><span class="o">.</span><span class="p">)</span>

<span class="n">time_redirect</span> <span class="err">重定向时间，包括到最后一次传输前的几次重定向的</span><span class="n">DNS</span><span class="err">解析，连接，预传输，传输时间。</span><span class="p">(</span><span class="n">The</span> <span class="n">time</span><span class="p">,</span> <span class="ow">in</span> 
<span class="n">seconds</span><span class="p">,</span> <span class="n">it</span> <span class="n">took</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">redirection</span> <span class="n">steps</span> <span class="n">include</span> <span class="n">name</span> <span class="n">lookup</span><span class="p">,</span> <span class="n">connect</span><span class="p">,</span> <span class="n">pretransfer</span> <span class="ow">and</span> <span class="n">transfer</span>
 <span class="n">before</span> <span class="n">the</span> <span class="n">final</span> <span class="n">transaction</span> <span class="n">was</span> <span class="n">started</span><span class="o">.</span> <span class="n">time_redirect</span> <span class="n">shows</span> <span class="n">the</span> <span class="n">complete</span> <span class="n">execution</span> <span class="n">time</span> <span class="k">for</span> 
 <span class="n">multiple</span> <span class="n">redirections</span><span class="o">.</span> <span class="p">(</span><span class="n">Added</span> <span class="ow">in</span> <span class="mf">7.12</span><span class="o">.</span><span class="mi">3</span><span class="p">))</span>

<span class="n">time_starttransfer</span> <span class="err">开始传输时间。在</span><span class="n">client</span><span class="err">发出请求之后，</span><span class="n">Web</span> <span class="err">服务器返回数据的第一个字节所用的时间</span><span class="p">(</span><span class="n">The</span> <span class="n">time</span><span class="p">,</span> 
<span class="ow">in</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">it</span> <span class="n">took</span> <span class="kn">from</span> <span class="nn">the</span> <span class="nn">start</span> <span class="nn">until</span> <span class="nn">the</span> <span class="nn">first</span> <span class="nn">byte</span> <span class="nn">was</span> <span class="nn">just</span> <span class="nn">about</span> <span class="nn">to</span> <span class="nn">be</span> <span class="nn">transferred.</span> <span class="nn">This</span> 
<span class="n">includes</span> <span class="n">time_pretransfer</span> <span class="ow">and</span> <span class="n">also</span> <span class="n">the</span> <span class="n">time</span> <span class="n">the</span> <span class="n">server</span> <span class="n">needed</span> <span class="n">to</span> <span class="n">calculate</span> <span class="n">the</span> <span class="n">result</span><span class="o">.</span><span class="p">)</span>

<span class="n">size_download</span> <span class="err">下载大小。</span><span class="p">(</span><span class="n">The</span> <span class="n">total</span> <span class="n">amount</span> <span class="n">of</span> <span class="nb">bytes</span> <span class="n">that</span> <span class="n">were</span> <span class="n">downloaded</span><span class="o">.</span><span class="p">)</span>

<span class="n">size_upload</span> <span class="err">上传大小。</span><span class="p">(</span><span class="n">The</span> <span class="n">total</span> <span class="n">amount</span> <span class="n">of</span> <span class="nb">bytes</span> <span class="n">that</span> <span class="n">were</span> <span class="n">uploaded</span><span class="o">.</span><span class="p">)</span>

<span class="n">size_header</span>  <span class="err">下载的</span><span class="n">header</span><span class="err">的大小</span><span class="p">(</span><span class="n">The</span> <span class="n">total</span> <span class="n">amount</span> <span class="n">of</span> <span class="nb">bytes</span> <span class="n">of</span> <span class="n">the</span> <span class="n">downloaded</span> <span class="n">headers</span><span class="o">.</span><span class="p">)</span>

<span class="n">size_request</span> <span class="err">请求的大小。</span><span class="p">(</span><span class="n">The</span> <span class="n">total</span> <span class="n">amount</span> <span class="n">of</span> <span class="nb">bytes</span> <span class="n">that</span> <span class="n">were</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">HTTP</span> <span class="n">request</span><span class="o">.</span><span class="p">)</span>

<span class="n">speed_download</span> <span class="err">下载速度，单位</span><span class="o">-</span><span class="err">字节每秒。</span><span class="p">(</span><span class="n">The</span> <span class="n">average</span> <span class="n">download</span> <span class="n">speed</span> <span class="n">that</span> <span class="n">curl</span> <span class="n">measured</span> <span class="k">for</span> <span class="n">the</span> 
<span class="n">complete</span> <span class="n">download</span><span class="o">.</span> <span class="n">Bytes</span> <span class="n">per</span> <span class="n">second</span><span class="o">.</span><span class="p">)</span>

<span class="n">speed_upload</span> <span class="err">上传速度</span><span class="p">,</span><span class="err">单位</span><span class="o">-</span><span class="err">字节每秒。</span><span class="p">(</span><span class="n">The</span> <span class="n">average</span> <span class="n">upload</span> <span class="n">speed</span> <span class="n">that</span> <span class="n">curl</span> <span class="n">measured</span> <span class="k">for</span> <span class="n">the</span> <span class="n">complete</span>
 <span class="n">upload</span><span class="o">.</span> <span class="n">Bytes</span> <span class="n">per</span> <span class="n">second</span><span class="o">.</span><span class="p">)</span>

<span class="n">content_type</span> <span class="err">就是</span><span class="n">content</span><span class="o">-</span><span class="n">Type</span><span class="err">，不用多说了，这是一个访问我博客首页返回的结果示例</span><span class="p">(</span><span class="n">text</span><span class="o">/</span><span class="n">html</span><span class="p">;</span> <span class="n">charset</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span><span class="err">；</span>
<span class="p">(</span><span class="n">The</span> <span class="n">Content</span><span class="o">-</span><span class="n">Type</span> <span class="n">of</span> <span class="n">the</span> <span class="n">requested</span> <span class="n">document</span><span class="p">,</span> <span class="k">if</span> <span class="n">there</span> <span class="n">was</span> <span class="nb">any</span><span class="o">.</span><span class="p">)</span>

<span class="n">num_connects</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">new</span> <span class="n">connects</span> <span class="n">made</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">recent</span> <span class="n">transfer</span><span class="o">.</span> <span class="p">(</span><span class="n">Added</span> <span class="ow">in</span> <span class="mf">7.12</span><span class="o">.</span><span class="mi">3</span><span class="p">)</span>

<span class="n">num_redirects</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">redirects</span> <span class="n">that</span> <span class="n">were</span> <span class="n">followed</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">request</span><span class="o">.</span> <span class="p">(</span><span class="n">Added</span> <span class="ow">in</span> <span class="mf">7.12</span><span class="o">.</span><span class="mi">3</span><span class="p">)</span>

<span class="n">redirect_url</span> <span class="n">When</span> <span class="n">a</span> <span class="n">HTTP</span> <span class="n">request</span> <span class="n">was</span> <span class="n">made</span> <span class="n">without</span> <span class="o">-</span><span class="n">L</span> <span class="n">to</span> <span class="n">follow</span> <span class="n">redirects</span><span class="p">,</span> <span class="n">this</span> <span class="n">variable</span> <span class="n">will</span> <span class="n">show</span> <span class="n">the</span>
 <span class="n">actual</span> <span class="n">URL</span> <span class="n">a</span> <span class="n">redirect</span> <span class="n">would</span> <span class="n">take</span> <span class="n">you</span> <span class="n">to</span><span class="o">.</span> <span class="p">(</span><span class="n">Added</span> <span class="ow">in</span> <span class="mf">7.18</span><span class="o">.</span><span class="mi">2</span><span class="p">)</span>

<span class="n">ftp_entry_path</span> <span class="n">The</span> <span class="n">initial</span> <span class="n">path</span> <span class="n">libcurl</span> <span class="n">ended</span> <span class="n">up</span> <span class="ow">in</span> <span class="n">when</span> <span class="n">logging</span> <span class="n">on</span> <span class="n">to</span> <span class="n">the</span> <span class="n">remote</span> <span class="n">FTP</span> <span class="n">server</span><span class="o">.</span> <span class="p">(</span><span class="n">Added</span> <span class="ow">in</span> <span class="mf">7.15</span><span class="o">.</span><span class="mi">4</span><span class="p">)</span>

<span class="n">ssl_verify_result</span> <span class="n">ssl</span><span class="err">认证结果，返回</span><span class="mi">0</span><span class="err">表示认证成功。</span><span class="p">(</span> <span class="n">The</span> <span class="n">result</span> <span class="n">of</span> <span class="n">the</span> <span class="n">SSL</span> <span class="n">peer</span> <span class="n">certificate</span> <span class="n">verification</span> 
<span class="n">that</span> <span class="n">was</span> <span class="n">requested</span><span class="o">.</span> <span class="mi">0</span> <span class="n">means</span> <span class="n">the</span> <span class="n">verification</span> <span class="n">was</span> <span class="n">successful</span><span class="o">.</span> <span class="p">(</span><span class="n">Added</span> <span class="ow">in</span> <span class="mf">7.19</span><span class="o">.</span><span class="mi">0</span><span class="p">))</span>
</pre></div>


<h2 id="agent">agent安装</h2>
<div class="codehilite"><pre><span></span>      <span class="nv">rpm</span> <span class="o">-</span><span class="nv">ivh</span> <span class="nv">http</span>:<span class="o">//</span><span class="nv">repo</span>.<span class="nv">zabbix</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="mi">2</span>.<span class="mi">4</span><span class="o">/</span><span class="nv">rhel</span><span class="o">/</span><span class="mi">6</span><span class="o">/</span><span class="nv">x86_64</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">-</span><span class="nv">release</span><span class="o">-</span><span class="mi">2</span>.<span class="mi">4</span><span class="o">-</span><span class="mi">1</span>.<span class="nv">el6</span>.<span class="nv">noarch</span>.<span class="nv">rpm</span>
      官方源，可能比较慢

      #<span class="o">!/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">bash</span>
<span class="nv">SERVERIP</span><span class="o">=</span><span class="mi">1</span>.<span class="mi">1</span>.<span class="mi">1</span>.<span class="mi">1</span>
<span class="nv">localip</span><span class="o">=</span>$<span class="ss">(</span><span class="nv">ifconfig</span> <span class="nv">eth0</span> <span class="o">|</span> <span class="nv">grep</span> <span class="s2">&quot;</span><span class="s">inet addr</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">awk</span> <span class="s1">&#39;</span><span class="s">{print $2}</span><span class="s1">&#39;</span> <span class="o">|</span> <span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span><span class="s2">&quot;</span><span class="s">:</span><span class="s2">&quot;</span> <span class="s1">&#39;</span><span class="s">{print $2}</span><span class="s1">&#39;</span><span class="ss">)</span>
[ $<span class="nv">UID</span> <span class="o">-</span><span class="nv">ne</span> <span class="mi">0</span> ] <span class="o">&amp;&amp;</span> <span class="k">exit</span><span class="c1">;echo &quot;You not is root!!!&quot;</span>
<span class="nv">iptables</span> <span class="o">-</span><span class="nv">F</span> <span class="o">&amp;&amp;</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">init</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">iptables</span> <span class="nv">stop</span> <span class="o">&amp;&amp;</span> <span class="nv">chkconfig</span> <span class="nv">iptables</span> <span class="nv">off</span>
<span class="nv">sed</span> <span class="o">-</span><span class="nv">i</span>.<span class="nv">bak</span> <span class="s1">&#39;</span><span class="s">s/SELINUX=enforcing/SELINUX=disabled/g</span><span class="s1">&#39;</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">selinux</span><span class="o">/</span><span class="nv">config</span>

<span class="nv">cat</span> <span class="o">&gt;</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">yum</span>.<span class="nv">repos</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">zabbix</span>.<span class="nv">repo</span> <span class="o">&lt;&lt;</span> <span class="nv">EOF</span>
[<span class="nv">zabbix</span>]
<span class="nv">baseurl</span><span class="o">=</span><span class="nv">http</span>:<span class="o">//</span><span class="nv">mirrors</span>.<span class="nv">aliyun</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="mi">2</span>.<span class="mi">4</span><span class="o">/</span><span class="nv">rhel</span><span class="o">/</span><span class="mi">6</span><span class="o">/</span>\<span class="mh">$ba</span><span class="nv">search</span>
<span class="nv">gpgcheck</span><span class="o">=</span><span class="mi">0</span>
<span class="nv">EOF</span>
<span class="nv">yum</span> <span class="nv">install</span> <span class="nv">zabbix</span><span class="o">-</span><span class="nv">agent</span> <span class="o">-</span><span class="nv">y</span>
<span class="nv">sed</span> <span class="o">-</span><span class="nv">i</span>.<span class="nv">bak</span> <span class="s2">&quot;</span><span class="s">s/Hostname=Zabbix server/Hostname=$localip/g</span><span class="s2">&quot;</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">zabbix_agentd</span>.<span class="nv">conf</span>
<span class="nv">sed</span> <span class="o">-</span><span class="nv">i</span> <span class="s2">&quot;</span><span class="s">s/Server=127.0.0.1/Server=$SERVERIP/g</span><span class="s2">&quot;</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">zabbix_agentd</span>.<span class="nv">conf</span>
<span class="nv">sed</span> <span class="o">-</span><span class="nv">i</span> <span class="s2">&quot;</span><span class="s">s/ServerActive=127.0.0.1/ServerActive=$SERVERIP:10051/g</span><span class="s2">&quot;</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">zabbix_agentd</span>.<span class="nv">conf</span>
<span class="nv">sed</span> <span class="o">-</span><span class="nv">i</span> <span class="s2">&quot;</span><span class="s">261a\UnsafeUserParameters=1</span><span class="s2">&quot;</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">zabbix_agentd</span>.<span class="nv">conf</span>
<span class="nv">sed</span> <span class="o">-</span><span class="nv">i</span> <span class="s2">&quot;</span><span class="s">168a\HostMetadataItem=system.uname</span><span class="s2">&quot;</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">zabbix_agentd</span>.<span class="nv">conf</span>
<span class="nv">chkconfig</span> <span class="nv">zabbix</span><span class="o">-</span><span class="nv">agent</span> <span class="nv">on</span>
<span class="nv">service</span> <span class="nv">zabbix</span><span class="o">-</span><span class="nv">agent</span> <span class="nv">start</span>


<span class="nv">windows</span>
<span class="nv">zabbix_agentd</span>.<span class="nv">exe</span> –<span class="nv">c</span> <span class="nv">c</span>:\<span class="nv">zabbix</span>\<span class="nv">zabbix_agentd</span>.<span class="nv">conf</span> <span class="o">-</span><span class="nv">i</span>
<span class="nv">zabbix_agentd</span>.<span class="nv">exe</span> –<span class="nv">c</span> <span class="nv">c</span>:\<span class="nv">zabbix</span>\<span class="nv">zabbix_agentd</span>.<span class="nv">conf</span> –<span class="nv">s</span>
</pre></div>


<h2 id="_3">清理历史数据</h2>
<div class="codehilite"><pre><span></span>清理events表
#!/bin/bash
#this script name is delete_events.sh
host=&quot;localhost&quot;
socket=&quot;/data/perconadata5.6/mysql.sock&quot;
user=&quot;zabbix&quot;
pass=&quot;zabbix&quot;
port=&quot;3306&quot;
time=`date -d &quot;last-month&quot; +%Y-%m-01`
mysql -u <span class="nv">$user</span> -p<span class="nv">$pass</span> -h<span class="nv">$host</span>  -S <span class="nv">$socket</span> -P <span class="nv">$port</span> <span class="err">&lt;</span><span class="nt">&lt;EOF</span>
<span class="err">use</span> <span class="err">zabbix;</span>
<span class="err">delete</span>  <span class="err">from</span>  <span class="err">events</span> <span class="err">where</span>  <span class="err">clock</span> <span class="err">&lt;=</span> <span class="err">UNIX_TIMESTAMP(&#39;${time}&#39;)</span> <span class="err">limit</span> <span class="err">40000;</span>
<span class="err">EOF</span>


<span class="err">------------------------------------------------------------------------------</span>

<span class="err">先暂停zabbix.当然是service</span> <span class="err">zabbix_server</span> <span class="err">stop</span>

<span class="err">然后最好也把http停掉</span> <span class="err">service</span> <span class="err">httpd</span> <span class="err">stop</span>

<span class="err">连上数据库:</span>

<span class="err">mysql</span> <span class="err">-u</span> <span class="err">root(zabbix)</span> <span class="err">-p</span>
<span class="err">use</span> <span class="err">zabbix</span>

<span class="err">核心语句:</span>    <span class="err">排序表的大小</span>
<span class="err">SELECT</span> <span class="err">table_name</span> <span class="err">AS</span> <span class="err">&quot;Tables&quot;,</span>
<span class="err">round(((data_length</span> <span class="err">+</span> <span class="err">index_length)</span> <span class="err">/</span> <span class="err">1024</span> <span class="err">/</span> <span class="err">1024),</span> <span class="err">2)</span> <span class="err">&quot;Size</span> <span class="err">in</span> <span class="err">MB&quot;</span>
<span class="err">FROM</span> <span class="err">information_schema.TABLES</span>
<span class="err">WHERE</span> <span class="na">table_schema =</span> <span class="err">&#39;zabbix&#39;</span>
<span class="err">ORDER</span> <span class="err">BY</span> <span class="err">(data_length</span> <span class="err">+</span> <span class="err">index_length)</span> <span class="err">DESC;</span>
<span class="err">truncate</span> <span class="err">table</span> <span class="err">history;</span>
<span class="err">truncate</span> <span class="err">table</span> <span class="err">history_uint;</span>
<span class="err">truncate</span> <span class="err">table</span> <span class="err">alerts;</span>
<span class="err">truncate</span> <span class="err">table</span> <span class="err">trends_uint;</span>
<span class="err">truncate</span> <span class="err">table</span> <span class="err">trends;</span>
<span class="err">truncate</span> <span class="err">table</span> <span class="err">history_text;</span>
<span class="err">truncate</span> <span class="err">table</span> <span class="err">events;</span>

<span class="err">使用delete的话,也会清空数据,但是不会更改表中的记录ID.</span>
</pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../open-falcon/" title="open-falcon" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                open-falcon
              </span>
            </div>
          </a>
        
        
          <a href="../zabbix2/" title="zabbix2" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                zabbix2
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>