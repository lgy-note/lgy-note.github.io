



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>mysql - mkdocs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.30686662.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#_1" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="mkdocs" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              mkdocs
            </span>
            <span class="md-header-nav__topic">
              
                mysql
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href=".." class="md-tabs__link">
        home
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../python-base/" class="md-tabs__link">
          python
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../nginx/" class="md-tabs__link">
          service
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="./" class="md-tabs__link md-tabs__link--active">
          database
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../open-falcon/" class="md-tabs__link">
          monitor
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../tcp-issue/" class="md-tabs__link">
          basis
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="mkdocs" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    mkdocs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="home" class="md-nav__link">
      home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      python
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        python
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../python-base/" title="python-base" class="md-nav__link">
      python-base
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-lib/" title="python-lib" class="md-nav__link">
      python-lib
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-lib2/" title="python-lib2" class="md-nav__link">
      python-lib2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-web/" title="python-web" class="md-nav__link">
      python-web
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-other/" title="python-other" class="md-nav__link">
      python-other
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      service
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        service
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../nginx/" title="nginx" class="md-nav__link">
      nginx
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../nginx2/" title="nginx2" class="md-nav__link">
      nginx2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../apache/" title="apache" class="md-nav__link">
      apache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../saltstack/" title="saltstack" class="md-nav__link">
      saltstack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tomcat/" title="tomcat" class="md-nav__link">
      tomcat
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ansible/" title="ansible" class="md-nav__link">
      ansible
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../trafficserver/" title="trafficserver" class="md-nav__link">
      trafficserver
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../haproxy/" title="haproxy" class="md-nav__link">
      haproxy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../docker/" title="docker" class="md-nav__link">
      docker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../varnish/" title="varnish" class="md-nav__link">
      varnish
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../bind/" title="bind" class="md-nav__link">
      bind
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lvs/" title="lvs" class="md-nav__link">
      lvs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../log-analysis/" title="log-analysis" class="md-nav__link">
      log-analysis
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      database
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        database
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        mysql
      </label>
    
    <a href="./" title="mysql" class="md-nav__link md-nav__link--active">
      mysql
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    分表
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    多实例
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    数据脱敏
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    压力测试
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mariadb" class="md-nav__link">
    mariadb安装
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    临时表位置
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sqladvisor" class="md-nav__link">
    sqladvisor优化工具
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#slow_killsh" class="md-nav__link">
    slow_kill.sh
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    主从不同步
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mysql" class="md-nav__link">
    mysql安装
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#last_sql_error" class="md-nav__link">
    主从Last_SQL_error
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    慢查询
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    优化建议
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#56" class="md-nav__link">
    5.6明文密码问题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    备份
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    主从同步
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mha" class="md-nav__link">
    mha
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mysql_1" class="md-nav__link">
    mysql优化
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    编码
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mysql2/" title="mysql2" class="md-nav__link">
      mysql2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../memcached/" title="memcached" class="md-nav__link">
      memcached
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../redis/" title="redis" class="md-nav__link">
      redis
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mongodb/" title="mongodb" class="md-nav__link">
      mongodb
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../hadoop/" title="hadoop" class="md-nav__link">
      hadoop
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../postgresql/" title="postgresql" class="md-nav__link">
      postgresql
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      monitor
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        monitor
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../open-falcon/" title="open-falcon" class="md-nav__link">
      open-falcon
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zabbix/" title="zabbix" class="md-nav__link">
      zabbix
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zabbix2/" title="zabbix2" class="md-nav__link">
      zabbix2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../netdata/" title="netdata" class="md-nav__link">
      netdata
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      basis
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        basis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../tcp-issue/" title="tcp-issue" class="md-nav__link">
      tcp-issue
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../git-svn/" title="git-svn" class="md-nav__link">
      git-svn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../vpn/" title="vpn" class="md-nav__link">
      vpn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../shell/" title="shell" class="md-nav__link">
      shell
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../disk/" title="disk" class="md-nav__link">
      disk
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../filesystem/" title="filesystem" class="md-nav__link">
      filesystem
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../source/" title="source" class="md-nav__link">
      source
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../command/" title="command" class="md-nav__link">
      command
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../linux-base/" title="linux-base" class="md-nav__link">
      linux-base
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../linux-soft/" title="linux-soft" class="md-nav__link">
      linux-soft
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../other/" title="other" class="md-nav__link">
      other
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    分表
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    多实例
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    数据脱敏
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    压力测试
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mariadb" class="md-nav__link">
    mariadb安装
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    临时表位置
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sqladvisor" class="md-nav__link">
    sqladvisor优化工具
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#slow_killsh" class="md-nav__link">
    slow_kill.sh
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    主从不同步
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mysql" class="md-nav__link">
    mysql安装
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#last_sql_error" class="md-nav__link">
    主从Last_SQL_error
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    慢查询
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    优化建议
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#56" class="md-nav__link">
    5.6明文密码问题
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    备份
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    主从同步
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mha" class="md-nav__link">
    mha
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mysql_1" class="md-nav__link">
    mysql优化
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    编码
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>mysql</h1>
                
                <h2 id="_1">分表</h2>
<div class="codehilite"><pre><span></span><span class="n">d_debtor_contacts_bak</span><span class="err">的数据拆分为</span><span class="n">d_debtor_contacts_0</span>
<span class="err">和</span><span class="n">d_debtor_contacts_1</span><span class="err">根据</span><span class="n">debtor_info_id</span><span class="err">取模</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">d_debtor_contacts_0</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">d_debtor_contacts_bak</span> <span class="k">WHERE</span> <span class="n">debtor_info_id</span> <span class="k">MOD</span> <span class="mi">2</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">d_debtor_contacts_1</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">d_debtor_contacts_bak</span> <span class="k">WHERE</span> <span class="n">debtor_info_id</span> <span class="k">MOD</span> <span class="mi">2</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>

<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">Qihoo360</span><span class="o">/</span><span class="n">Atlas</span><span class="o">/</span><span class="n">wiki</span><span class="o">/</span><span class="n">Atlas</span><span class="o">%</span><span class="n">E7</span><span class="o">%</span><span class="mi">9</span><span class="n">A</span><span class="o">%</span><span class="mi">84</span><span class="o">%</span><span class="n">E5</span><span class="o">%</span><span class="mi">88</span><span class="o">%</span><span class="mi">86</span><span class="o">%</span><span class="n">E8</span><span class="o">%</span><span class="n">A1</span><span class="o">%</span><span class="n">A8</span><span class="o">%</span><span class="n">E5</span><span class="o">%</span><span class="mi">8</span><span class="n">A</span><span class="o">%</span><span class="mi">9</span><span class="n">F</span><span class="o">%</span><span class="n">E8</span><span class="o">%</span><span class="mi">83</span><span class="o">%</span><span class="n">BD</span><span class="o">%</span><span class="n">E7</span><span class="o">%</span><span class="n">AE</span><span class="o">%</span><span class="mi">80</span><span class="o">%</span><span class="n">E4</span><span class="o">%</span><span class="n">BB</span><span class="o">%</span><span class="mi">8</span><span class="n">B</span>
<span class="mi">1</span><span class="p">.</span><span class="err">使用</span><span class="n">Atlas</span><span class="err">的分表功能时，首先需要在配置文件（</span><span class="n">test</span><span class="p">.</span><span class="n">cnf</span><span class="err">）设置</span><span class="n">tables</span><span class="err">参数。</span>
<span class="mi">2</span><span class="p">.</span><span class="n">tables</span><span class="err">参数设置格式：数据库名</span><span class="p">.</span><span class="err">表名</span><span class="p">.</span><span class="err">分表字段</span><span class="p">.</span><span class="err">子表数量，比如你的数据库名叫</span><span class="n">school</span><span class="err">，表名叫</span><span class="n">stu</span><span class="err">，分表字段叫</span><span class="n">id</span><span class="err">，总共分为</span><span class="mi">100</span><span class="err">张表，</span>
<span class="err">那么就写为</span><span class="n">school</span><span class="p">.</span><span class="n">stu</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="mi">100</span><span class="err">，如果还有其他的分表，以逗号分隔即可。用户需要手动建立</span><span class="mi">100</span><span class="err">张子表（</span><span class="n">stu_0</span><span class="p">,</span><span class="n">stu_1</span><span class="p">,</span><span class="err">…</span><span class="n">stu_99</span><span class="err">，注意子表</span>
<span class="err">序号是从</span><span class="mi">0</span><span class="err">开始的）。且所有的子表必须在</span><span class="n">DB</span><span class="err">的同一个</span><span class="k">database</span><span class="err">里。</span>
<span class="mi">3</span><span class="p">.</span><span class="err">当通过</span><span class="n">Atlas</span><span class="err">执行（</span><span class="k">SELECT</span><span class="err">、</span><span class="k">DELETE</span><span class="err">、</span><span class="k">UPDATE</span><span class="err">、</span><span class="k">INSERT</span><span class="err">、</span><span class="k">REPLACE</span><span class="err">）操作时，</span><span class="n">Atlas</span><span class="err">会根据分表结果（</span><span class="n">id</span><span class="o">%</span><span class="mi">100</span><span class="o">=</span><span class="n">k</span><span class="err">），定位到相应的子表</span>
<span class="err">（</span><span class="n">stu_k</span><span class="err">）。例如，执行</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">stu</span> <span class="k">where</span> <span class="n">id</span><span class="o">=</span><span class="mi">110</span><span class="p">;</span><span class="err">，</span><span class="n">Atlas</span><span class="err">会自动从</span><span class="n">stu_10</span><span class="err">这张子表返回查询结果。但如果执行</span><span class="k">SQL</span><span class="err">语句</span>
<span class="err">（</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">stu</span><span class="p">;</span><span class="err">）时不带上</span><span class="n">id</span><span class="err">，则会提示执行</span><span class="n">stu</span> <span class="err">表不存在。</span>
<span class="mi">4</span><span class="p">.</span><span class="n">Atlas</span><span class="err">暂不支持自动建表和跨库分表的功能。</span>
<span class="mi">5</span><span class="p">.</span><span class="n">Atlas</span><span class="err">目前支持分表的语句有</span><span class="k">SELECT</span><span class="err">、</span><span class="k">DELETE</span><span class="err">、</span><span class="k">UPDATE</span><span class="err">、</span><span class="k">INSERT</span><span class="err">、</span><span class="k">REPLACE</span><span class="err">。</span>
</pre></div>


<h2 id="_2">多实例</h2>
<div class="codehilite"><pre><span></span><span class="n">初始化</span><span class="w"></span>
<span class="n">mysql_install_db</span><span class="w"> </span><span class="c1">--defaults-file=/etc/my3316.cnf --user=mysql --basedir=/data/mysql/ --datadir=/data/mysql/data3316/</span>

<span class="n">多实例启动文件的启动mysql服务实质命令</span><span class="err">：</span><span class="w"></span>
<span class="n">mysqld_safe</span><span class="w"> </span><span class="c1">--defaults-file=/etc/my3316.cnf 2&gt;&amp;1 /var/log/mysqld3316.log &amp;</span>

<span class="n">本文多实例启动文件的停止mysql服务实质命令</span><span class="err">：</span><span class="w"></span>
<span class="n">mysqladmin</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="o">-</span><span class="n">p123456</span><span class="w"> </span><span class="o">-</span><span class="n">S</span><span class="w"> </span><span class="o">/</span><span class="nf">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">mysql3316</span><span class="p">.</span><span class="n">sock</span><span class="w"> </span><span class="k">shutdown</span><span class="w"></span>

<span class="n">连接</span><span class="w"> </span><span class="n">mysql</span><span class="w"> </span><span class="c1">--defaults-file=/etc/my3316.cnf</span>

<span class="n">配置文件要有</span><span class="w"></span>
<span class="o">[</span><span class="n">client</span><span class="o">]</span><span class="w"></span>
<span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3316</span><span class="w"></span>
<span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">/</span><span class="nf">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">mysql3316</span><span class="p">.</span><span class="n">sock</span><span class="w"></span>
<span class="k">default</span><span class="o">-</span><span class="k">character</span><span class="o">-</span><span class="k">set</span><span class="o">=</span><span class="n">UTF8</span><span class="w"></span>

<span class="o">[</span><span class="n">mysqld</span><span class="o">]</span><span class="w"></span>
<span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3316</span><span class="w"></span>
<span class="n">datadir</span><span class="o">=/</span><span class="k">data</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">data3316</span><span class="w"></span>
<span class="n">socket</span><span class="o">=/</span><span class="nf">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">mysql3316</span><span class="p">.</span><span class="n">sock</span><span class="w"></span>
</pre></div>


<h2 id="_3">数据脱敏</h2>
<div class="codehilite"><pre><span></span><span class="k">UPDATE</span> <span class="n">d_debtor_info</span> <span class="k">set</span> <span class="n">debtor_id_num</span><span class="o">=</span><span class="k">insert</span><span class="p">(</span><span class="n">debtor_id_num</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;****&#39;</span><span class="p">)</span> <span class="k">where</span> <span class="n">id</span><span class="o">=</span><span class="mi">2667</span><span class="p">;</span>
<span class="k">UPDATE</span> <span class="n">d_debtor_info</span> <span class="k">set</span> <span class="n">work_telephone</span><span class="o">=</span><span class="k">insert</span><span class="p">(</span><span class="n">work_telephone</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;****&#39;</span><span class="p">)</span> <span class="k">where</span> <span class="n">id</span><span class="o">=</span><span class="mi">2667</span><span class="p">;</span>

<span class="k">insert</span><span class="p">(</span><span class="n">debtor_id_num</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;****&#39;</span><span class="p">)</span>  <span class="err">从第</span><span class="mi">8</span><span class="err">位开始，替换</span><span class="mi">4</span><span class="err">位数据为</span><span class="o">****</span>
</pre></div>


<h2 id="_4">压力测试</h2>
<div class="codehilite"><pre><span></span><span class="nv">https</span>:<span class="o">//</span><span class="nv">github</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">nuodb</span><span class="o">/</span><span class="nv">sysbench</span>
<span class="nv">wget</span> <span class="nv">https</span>:<span class="o">//</span><span class="nv">github</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">nuodb</span><span class="o">/</span><span class="nv">sysbench</span><span class="o">/</span><span class="nv">archive</span><span class="o">/</span><span class="nv">master</span>.<span class="nv">zip</span>
<span class="nv">cd</span> <span class="nv">sysbench</span><span class="o">-</span><span class="nv">master</span>
.<span class="o">/</span><span class="nv">autogen</span>.<span class="nv">sh</span> 
.<span class="o">/</span><span class="nv">configure</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">mysql</span><span class="o">-</span><span class="nv">includes</span><span class="o">=/</span><span class="nv">data</span><span class="o">/</span><span class="nv">mysql</span><span class="o">/</span><span class="k">include</span><span class="o">/</span>  <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">mysql</span><span class="o">-</span><span class="nv">libs</span><span class="o">=/</span><span class="nv">data</span><span class="o">/</span><span class="nv">mysql</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span> 
<span class="nv">make</span>

<span class="nv">export</span> <span class="nv">LD_LIBRARY_PATH</span><span class="o">=/</span><span class="nv">data</span><span class="o">/</span><span class="nv">mysql</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span>
.<span class="o">/</span><span class="nv">sysbench</span><span class="o">/</span><span class="nv">sysbench</span> <span class="o">--</span><span class="nv">help</span>

常用命令参数：

<span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">sysbench</span><span class="o">-</span><span class="mi">0</span>.<span class="mi">5</span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">sysbench</span>
     <span class="o">--</span><span class="nv">mysql</span><span class="o">-</span><span class="nv">host</span><span class="o">=</span><span class="nv">test</span>.<span class="nv">mysql</span>.<span class="nv">rds</span>.<span class="nv">aliyuncs</span>.<span class="nv">com</span>           #数据库<span class="nv">host</span>
     <span class="o">--</span><span class="nv">mysql</span><span class="o">-</span><span class="nv">port</span><span class="o">=</span><span class="mi">3306</span>                                              #数据库端口
     <span class="o">--</span><span class="nv">mysql</span><span class="o">-</span><span class="nv">user</span><span class="o">=</span><span class="nv">your_username</span>                             #数据库用户名
     <span class="o">--</span><span class="nv">mysql</span><span class="o">-</span><span class="nv">password</span><span class="o">=</span><span class="nv">your_password</span>                      #数据库密码
     <span class="o">--</span><span class="nv">mysql</span><span class="o">-</span><span class="nv">socket</span><span class="o">=</span>
     <span class="o">--</span><span class="nv">mysql</span><span class="o">-</span><span class="nv">db</span><span class="o">=</span><span class="nv">your_db_for_test</span>                              #数据库名
     <span class="o">--</span><span class="nv">mysql</span><span class="o">-</span><span class="nv">table</span><span class="o">-</span><span class="nv">engine</span><span class="o">=</span><span class="nv">innodb</span>
     <span class="o">--</span><span class="nv">oltp</span><span class="o">-</span><span class="nv">tables</span><span class="o">-</span><span class="nv">count</span><span class="o">=</span><span class="mi">10</span>                        #模拟的表的个数，规格越高该值越大
     <span class="o">--</span><span class="nv">oltp</span><span class="o">-</span><span class="nv">table</span><span class="o">-</span><span class="nv">size</span><span class="o">=</span><span class="mi">6000000</span>                  #模拟的每张表的行数，规格越高该值越大
     <span class="o">--</span><span class="nv">num</span><span class="o">-</span><span class="nv">threads</span><span class="o">=</span><span class="mi">50</span>                              #模拟的并发数量，规格越高该值越大
     <span class="o">--</span><span class="nv">max</span><span class="o">-</span><span class="nv">requests</span><span class="o">=</span><span class="mi">100000000</span>               #最大请求次数
     <span class="o">--</span><span class="nv">max</span><span class="o">-</span><span class="nv">time</span><span class="o">=</span><span class="mi">20</span>                           #最大测试时间（与<span class="o">--</span><span class="nv">max</span><span class="o">-</span><span class="nv">requests</span>只要有一个超过，则退出）
     <span class="o">--</span><span class="nv">report</span><span class="o">-</span><span class="nv">interval</span><span class="o">=</span><span class="mi">1</span>                     #每<span class="mi">1</span>秒打印一次当前的<span class="nv">QPS</span>等值
     <span class="o">--</span><span class="nv">test</span><span class="o">=/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">sysbench</span><span class="o">-</span><span class="mi">0</span>.<span class="mi">5</span><span class="o">/</span><span class="nv">sysbench</span><span class="o">/</span><span class="nv">tests</span><span class="o">/</span><span class="nv">db</span><span class="o">/</span><span class="nv">oltp</span>.<span class="nv">lua</span>    #选用的测试脚本<span class="ss">(</span><span class="nv">lua</span><span class="ss">)</span>，此脚本可以从<span class="nv">sysbench</span><span class="o">-</span><span class="mi">0</span>.<span class="mi">5</span>源代码文件目录下找

     [<span class="nv">prepare</span> <span class="o">|</span> <span class="nv">run</span> <span class="o">|</span> <span class="nv">cleanup</span>]           #<span class="nv">prepare</span>准备数据，<span class="nv">run</span>执行测试，<span class="nv">cleanup</span>清理数据

测试结果解读如下：
<span class="nv">sysbench</span> <span class="mi">0</span>.<span class="mi">5</span>:  <span class="nv">multi</span><span class="o">-</span><span class="nv">threaded</span> <span class="nv">system</span> <span class="nv">evaluation</span> <span class="nv">benchmark</span>

<span class="nv">Running</span> <span class="nv">the</span> <span class="nv">test</span> <span class="nv">with</span> <span class="nv">following</span> <span class="nv">options</span>:
<span class="nv">Number</span> <span class="nv">of</span> <span class="nv">threads</span>: <span class="mi">8</span>
<span class="nv">Report</span> <span class="nv">intermediate</span> <span class="nv">results</span> <span class="nv">every</span> <span class="mi">10</span> <span class="nv">second</span><span class="ss">(</span><span class="nv">s</span><span class="ss">)</span>
<span class="k">Random</span> <span class="nv">number</span> <span class="nv">generator</span> <span class="nv">seed</span> <span class="nv">is</span> <span class="mi">0</span> <span class="nv">and</span> <span class="nv">will</span> <span class="nv">be</span> <span class="nv">ignored</span>


<span class="nv">Threads</span> <span class="nv">started</span><span class="o">!</span>
<span class="o">--</span> 每<span class="mi">10</span>秒钟报告一次测试结果，<span class="nv">tps</span>、每秒读、每秒写、<span class="mi">99</span><span class="o">%</span>以上的响应时长统计
[  <span class="mi">10</span><span class="nv">s</span>] <span class="nv">threads</span>: <span class="mi">8</span>, <span class="nv">tps</span>: <span class="mi">1111</span>.<span class="mi">51</span>, <span class="nv">reads</span><span class="o">/</span><span class="nv">s</span>: <span class="mi">15568</span>.<span class="mi">42</span>, <span class="nv">writes</span><span class="o">/</span><span class="nv">s</span>: <span class="mi">4446</span>.<span class="mi">13</span>, <span class="nv">response</span> <span class="nv">time</span>: <span class="mi">9</span>.<span class="mi">95</span><span class="nv">ms</span> <span class="ss">(</span><span class="mi">99</span><span class="o">%</span><span class="ss">)</span>
[  <span class="mi">20</span><span class="nv">s</span>] <span class="nv">threads</span>: <span class="mi">8</span>, <span class="nv">tps</span>: <span class="mi">1121</span>.<span class="mi">90</span>, <span class="nv">reads</span><span class="o">/</span><span class="nv">s</span>: <span class="mi">15709</span>.<span class="mi">62</span>, <span class="nv">writes</span><span class="o">/</span><span class="nv">s</span>: <span class="mi">4487</span>.<span class="mi">80</span>, <span class="nv">response</span> <span class="nv">time</span>: <span class="mi">9</span>.<span class="mi">78</span><span class="nv">ms</span> <span class="ss">(</span><span class="mi">99</span><span class="o">%</span><span class="ss">)</span>
[  <span class="mi">30</span><span class="nv">s</span>] <span class="nv">threads</span>: <span class="mi">8</span>, <span class="nv">tps</span>: <span class="mi">1120</span>.<span class="mi">00</span>, <span class="nv">reads</span><span class="o">/</span><span class="nv">s</span>: <span class="mi">15679</span>.<span class="mi">10</span>, <span class="nv">writes</span><span class="o">/</span><span class="nv">s</span>: <span class="mi">4480</span>.<span class="mi">20</span>, <span class="nv">response</span> <span class="nv">time</span>: <span class="mi">9</span>.<span class="mi">84</span><span class="nv">ms</span> <span class="ss">(</span><span class="mi">99</span><span class="o">%</span><span class="ss">)</span>
[  <span class="mi">40</span><span class="nv">s</span>] <span class="nv">threads</span>: <span class="mi">8</span>, <span class="nv">tps</span>: <span class="mi">1114</span>.<span class="mi">20</span>, <span class="nv">reads</span><span class="o">/</span><span class="nv">s</span>: <span class="mi">15599</span>.<span class="mi">39</span>, <span class="nv">writes</span><span class="o">/</span><span class="nv">s</span>: <span class="mi">4456</span>.<span class="mi">30</span>, <span class="nv">response</span> <span class="nv">time</span>: <span class="mi">9</span>.<span class="mi">90</span><span class="nv">ms</span> <span class="ss">(</span><span class="mi">99</span><span class="o">%</span><span class="ss">)</span>
[  <span class="mi">50</span><span class="nv">s</span>] <span class="nv">threads</span>: <span class="mi">8</span>, <span class="nv">tps</span>: <span class="mi">1114</span>.<span class="mi">00</span>, <span class="nv">reads</span><span class="o">/</span><span class="nv">s</span>: <span class="mi">15593</span>.<span class="mi">60</span>, <span class="nv">writes</span><span class="o">/</span><span class="nv">s</span>: <span class="mi">4456</span>.<span class="mi">70</span>, <span class="nv">response</span> <span class="nv">time</span>: <span class="mi">9</span>.<span class="mi">84</span><span class="nv">ms</span> <span class="ss">(</span><span class="mi">99</span><span class="o">%</span><span class="ss">)</span>
[  <span class="mi">60</span><span class="nv">s</span>] <span class="nv">threads</span>: <span class="mi">8</span>, <span class="nv">tps</span>: <span class="mi">1119</span>.<span class="mi">30</span>, <span class="nv">reads</span><span class="o">/</span><span class="nv">s</span>: <span class="mi">15671</span>.<span class="mi">60</span>, <span class="nv">writes</span><span class="o">/</span><span class="nv">s</span>: <span class="mi">4476</span>.<span class="mi">50</span>, <span class="nv">response</span> <span class="nv">time</span>: <span class="mi">9</span>.<span class="mi">99</span><span class="nv">ms</span> <span class="ss">(</span><span class="mi">99</span><span class="o">%</span><span class="ss">)</span>
<span class="nv">OLTP</span> <span class="nv">test</span> <span class="nv">statistics</span>:
    <span class="nv">queries</span> <span class="nv">performed</span>:
        <span class="nv">read</span>:                            <span class="mi">938224</span>    <span class="o">--</span> 读总数
        <span class="nv">write</span>:                           <span class="mi">268064</span>    <span class="o">--</span> 写总数
        <span class="nv">other</span>:                           <span class="mi">134032</span>    <span class="o">--</span> 其他操作总数<span class="ss">(</span><span class="nv">SELECT</span>、<span class="nv">INSERT</span>、<span class="nv">UPDATE</span>、<span class="nv">DELETE</span>之外的操作，例如<span class="nv">COMMIT</span>等<span class="ss">)</span>
        <span class="nv">total</span>:                           <span class="mi">1340320</span>    <span class="o">--</span> 全部总数
    <span class="nv">transactions</span>:                        <span class="mi">67016</span>  <span class="ss">(</span><span class="mi">1116</span>.<span class="mi">83</span> <span class="nv">per</span> <span class="nv">sec</span>.<span class="ss">)</span>    <span class="o">--</span> 总事务数<span class="ss">(</span>每秒事务数<span class="ss">)</span>
    <span class="nv">deadlocks</span>:                           <span class="mi">0</span>      <span class="ss">(</span><span class="mi">0</span>.<span class="mi">00</span> <span class="nv">per</span> <span class="nv">sec</span>.<span class="ss">)</span>    <span class="o">--</span> 发生死锁总数
    <span class="nv">read</span><span class="o">/</span><span class="nv">write</span> <span class="nv">requests</span>:                 <span class="mi">1206288</span> <span class="ss">(</span><span class="mi">20103</span>.<span class="mi">01</span> <span class="nv">per</span> <span class="nv">sec</span>.<span class="ss">)</span>    <span class="o">--</span> 读写总数<span class="ss">(</span>每秒读写次数<span class="ss">)</span>
    <span class="nv">other</span> <span class="nv">operations</span>:                    <span class="mi">134032</span> <span class="ss">(</span><span class="mi">2233</span>.<span class="mi">67</span> <span class="nv">per</span> <span class="nv">sec</span>.<span class="ss">)</span>    <span class="o">--</span> 其他操作总数<span class="ss">(</span>每秒其他操作次数<span class="ss">)</span>

<span class="nv">General</span> <span class="nv">statistics</span>:    <span class="o">--</span> 一些统计结果
    <span class="nv">total</span> <span class="nv">time</span>:                          <span class="mi">60</span>.<span class="mi">0053</span><span class="nv">s</span>    <span class="o">--</span> 总耗时
    <span class="nv">total</span> <span class="nv">number</span> <span class="nv">of</span> <span class="nv">events</span>:              <span class="mi">67016</span>    <span class="o">--</span> 共发生多少事务数
    <span class="nv">total</span> <span class="nv">time</span> <span class="nv">taken</span> <span class="nv">by</span> <span class="nv">event</span> <span class="nv">execution</span>: <span class="mi">479</span>.<span class="mi">8171</span><span class="nv">s</span>    <span class="o">--</span> 所有事务耗时相加<span class="ss">(</span>不考虑并行因素<span class="ss">)</span>
    <span class="nv">response</span> <span class="nv">time</span>:    <span class="o">--</span> 响应时长统计
         <span class="nv">min</span>:                                  <span class="mi">4</span>.<span class="mi">27</span><span class="nv">ms</span>    <span class="o">--</span> 最小耗时
         <span class="nv">avg</span>:                                  <span class="mi">7</span>.<span class="mi">16</span><span class="nv">ms</span>    <span class="o">--</span> 平均耗时
         <span class="nv">max</span>:                                 <span class="mi">13</span>.<span class="mi">80</span><span class="nv">ms</span>    <span class="o">--</span> 最长耗时
         <span class="nv">approx</span>.  <span class="mi">99</span> <span class="nv">percentile</span>:               <span class="mi">9</span>.<span class="mi">88</span><span class="nv">ms</span>    <span class="o">--</span> 超过<span class="mi">99</span><span class="o">%</span>平均耗时

<span class="nv">Threads</span> <span class="nv">fairness</span>:
    <span class="nv">events</span> <span class="ss">(</span><span class="nv">avg</span><span class="o">/</span><span class="nv">stddev</span><span class="ss">)</span>:           <span class="mi">8377</span>.<span class="mi">0000</span><span class="o">/</span><span class="mi">44</span>.<span class="mi">33</span>
    <span class="nv">execution</span> <span class="nv">time</span> <span class="ss">(</span><span class="nv">avg</span><span class="o">/</span><span class="nv">stddev</span><span class="ss">)</span>:   <span class="mi">59</span>.<span class="mi">9771</span><span class="o">/</span><span class="mi">0</span>.<span class="mi">00</span>


<span class="nv">sysbench</span>创建表的语句是：

<span class="nv">CREATE</span> <span class="nv">TABLE</span> <span class="nv">sbtest</span> <span class="ss">(</span>
  <span class="nv">id</span> <span class="nv">int</span><span class="ss">(</span><span class="mi">10</span><span class="ss">)</span> <span class="nv">unsigned</span> <span class="nv">NOT</span> <span class="nv">NULL</span> <span class="nv">AUTO_INCREMENT</span>,
  <span class="nv">k</span> <span class="nv">int</span><span class="ss">(</span><span class="mi">10</span><span class="ss">)</span> <span class="nv">unsigned</span> <span class="nv">NOT</span> <span class="nv">NULL</span> <span class="nv">DEFAULT</span> <span class="s1">&#39;</span><span class="s">0</span><span class="s1">&#39;</span>,
  <span class="nv">c</span> <span class="nv">char</span><span class="ss">(</span><span class="mi">120</span><span class="ss">)</span> <span class="nv">NOT</span> <span class="nv">NULL</span> <span class="nv">DEFAULT</span> <span class="s1">&#39;&#39;</span>,
  <span class="nv">pad</span> <span class="nv">char</span><span class="ss">(</span><span class="mi">60</span><span class="ss">)</span> <span class="nv">NOT</span> <span class="nv">NULL</span> <span class="nv">DEFAULT</span> <span class="s1">&#39;&#39;</span>,
  <span class="nv">PRIMARY</span> <span class="nv">KEY</span> <span class="ss">(</span><span class="nv">id</span><span class="ss">)</span>,
  <span class="nv">KEY</span> <span class="nv">k</span> <span class="ss">(</span><span class="nv">k</span><span class="ss">)</span>
<span class="ss">)</span> <span class="nv">ENGINE</span><span class="o">=</span><span class="nv">InnoDB</span> <span class="nv">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">1</span> <span class="nv">DEFAULT</span> <span class="nv">CHARSET</span><span class="o">=</span><span class="nv">latin1</span>
</pre></div>


<h2 id="mariadb">mariadb安装</h2>
<div class="codehilite"><pre><span></span><span class="nl">https</span><span class="p">:</span><span class="c1">//downloads.mariadb.org/</span>

<span class="n">wget</span> <span class="nl">http</span><span class="p">:</span><span class="c1">//mirrors.neusoft.edu.cn/mariadb//mariadb-10.2.6/source/mariadb-10.2.6.tar.gz</span>
<span class="n">tar</span> <span class="o">-</span><span class="n">zxf</span> <span class="n">mariadb</span><span class="o">-</span><span class="mf">10.2.6</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span> 
<span class="n">cd</span> <span class="n">mariadb</span><span class="o">-</span><span class="mf">10.2.6</span>
<span class="n">groupadd</span> <span class="o">-</span><span class="n">r</span> <span class="n">mariadb</span>
<span class="n">useradd</span> <span class="o">-</span><span class="n">g</span> <span class="n">mariadb</span> <span class="o">-</span><span class="n">r</span> <span class="o">-</span><span class="n">M</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nologin</span> <span class="n">mariadb</span>
<span class="n">mkdir</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mariadb</span>

<span class="err">依赖</span>  <span class="n">yum</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">gcc</span> <span class="n">gcc</span><span class="o">-</span><span class="n">c</span><span class="o">++</span> <span class="n">make</span> <span class="n">cmake</span> <span class="n">ncurses</span> <span class="n">ncurses</span> <span class="n">libxml2</span> <span class="n">libxml2</span><span class="o">-</span><span class="n">devel</span> <span class="n">openssl</span><span class="o">-</span><span class="n">devel</span> <span class="n">bison</span> <span class="n">bison</span><span class="o">-</span><span class="n">devel</span>

<span class="n">cmake</span> <span class="p">.</span> <span class="o">-</span><span class="n">DMYSQL_UNIX_ADDR</span><span class="o">=/</span><span class="n">tmp</span><span class="o">/</span><span class="n">mariadb</span><span class="p">.</span><span class="n">sock</span> <span class="o">-</span><span class="n">DSYSCONFDIR</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">mariadb</span> <span class="o">-</span><span class="n">DMYSQL_TCP_PORT</span><span class="o">=</span><span class="mi">3309</span> <span class="o">-</span><span class="n">DEXTRA_CHARSETS</span><span class="o">=</span><span class="n">all</span> 
<span class="o">-</span><span class="n">DMYSQL_USER</span><span class="o">=</span><span class="n">mariadb</span> <span class="o">-</span><span class="n">DCMAKE_INSTALL_PREFIX</span><span class="o">=/</span><span class="n">data</span><span class="o">/</span><span class="n">mariadb</span> <span class="o">-</span><span class="n">DMYSQL_DATADIR</span><span class="o">=/</span><span class="n">data</span><span class="o">/</span><span class="n">mariadb</span><span class="o">/</span><span class="n">data</span>  
<span class="o">-</span><span class="n">DWITH_XTRADB_STORAGE_ENGINE</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span><span class="n">DWITH_FEDERATEDX_STORAGE_ENGINE</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span><span class="n">DWITH_ARCHIVE_STORAGE_ENGINE</span><span class="o">=</span><span class="mi">1</span> 
<span class="o">-</span><span class="n">DWITH_MYISAM_STORAGE_ENGINE</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span><span class="n">DWITH_INNOBASE_STORAGE_ENGINE</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span><span class="n">DWITH_ARCHIVE_STPRAGE_ENGINE</span><span class="o">=</span><span class="mi">1</span> 
<span class="o">-</span><span class="n">DWITH_BLACKHOLE_STORAGE_ENGINE</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span><span class="n">DWIYH_READLINE</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span><span class="n">DWIYH_SSL</span><span class="o">=</span><span class="n">system</span> <span class="o">-</span><span class="n">DVITH_ZLIB</span><span class="o">=</span><span class="n">system</span> <span class="o">-</span><span class="n">DWITH_LOBWRAP</span><span class="o">=</span><span class="mi">0</span> 
<span class="o">-</span><span class="n">DDEFAULT_CHARSET</span><span class="o">=</span><span class="n">utf8</span> <span class="o">-</span><span class="n">DDEFAULT_COLLATION</span><span class="o">=</span><span class="n">utf8_general_ci</span>
<span class="n">make</span> <span class="o">-</span><span class="n">j</span> <span class="mi">4</span>
<span class="n">make</span> <span class="n">install</span>

<span class="n">cp</span> <span class="n">support</span><span class="o">-</span><span class="n">files</span><span class="o">/</span><span class="n">my</span><span class="o">-</span><span class="n">large</span><span class="p">.</span><span class="n">cnf</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mariadb</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span>

<span class="err">配置</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mariadb</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span>
<span class="err">在</span><span class="p">[</span><span class="n">mysqld</span><span class="p">]</span><span class="err">模块添加下面的几行：</span>
<span class="n">log</span><span class="o">-</span><span class="n">error</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">mariadb_error</span><span class="p">.</span><span class="n">log</span>
<span class="n">pid</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">mysqld</span><span class="o">/</span><span class="n">mariadb</span><span class="p">.</span><span class="n">pid</span>
<span class="n">user</span><span class="o">=</span><span class="n">mariadb</span>
<span class="n">datadir</span><span class="o">=/</span><span class="n">data</span><span class="o">/</span><span class="n">mariadb</span><span class="o">/</span><span class="n">data</span>
<span class="n">basedir</span><span class="o">=/</span><span class="n">data</span><span class="o">/</span><span class="n">mariadb</span><span class="o">/</span>
<span class="err">新增加</span><span class="n">mysqld_safe</span><span class="err">块</span>
<span class="p">[</span><span class="n">mysqld_safe</span><span class="p">]</span>
<span class="n">log</span><span class="o">-</span><span class="n">error</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">mariadb_error</span><span class="p">.</span><span class="n">log</span>
<span class="n">pid</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">mysqld</span><span class="o">/</span><span class="n">mariadb</span><span class="p">.</span><span class="n">pid</span>

<span class="err">初始化</span>  <span class="p">.</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">mysql_install_db</span> <span class="o">--</span><span class="n">basedir</span><span class="o">=/</span><span class="n">data</span><span class="o">/</span><span class="n">mariadb</span><span class="o">/</span> <span class="o">--</span><span class="n">datadir</span><span class="o">=/</span><span class="n">data</span><span class="o">/</span><span class="n">mariadb</span><span class="o">/</span><span class="n">data</span><span class="o">/</span> <span class="o">--</span><span class="n">user</span><span class="o">=</span><span class="n">mariadb</span> 
<span class="o">--</span><span class="n">defaults</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">mariadb</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span>

<span class="n">cp</span> <span class="n">support</span><span class="o">-</span><span class="n">files</span><span class="o">/</span><span class="n">mysql</span><span class="p">.</span><span class="n">server</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">mariadb</span>
<span class="n">chmod</span> <span class="mi">755</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">mariadb</span>
<span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">mariadb</span>   <span class="err">避免和现有的</span><span class="n">mysql</span><span class="err">冲突，如果没有</span><span class="n">mysql</span><span class="err">可以不用修改</span>
<span class="err">找到</span>   <span class="err">$</span><span class="n">bindir</span><span class="o">/</span><span class="n">mysqld_safe</span> <span class="o">--</span><span class="n">datadir</span><span class="o">=</span><span class="s">&quot;$datadir&quot;</span> <span class="o">--</span><span class="n">pid</span><span class="o">-</span><span class="n">file</span><span class="o">=</span><span class="s">&quot;$mysqld_pid_file_path&quot;</span> 
<span class="err">改完</span>   <span class="err">$</span><span class="n">bindir</span><span class="o">/</span><span class="n">mysqld_safe</span> <span class="o">--</span><span class="n">defaults</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">mariadb</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span> <span class="o">--</span><span class="n">datadir</span><span class="o">=</span><span class="s">&quot;/data/mariadb/data&quot;</span> 
<span class="o">--</span><span class="n">pid</span><span class="o">-</span><span class="n">file</span><span class="o">=</span><span class="s">&quot;/var/run/mysqld/mariadb.pid&quot;</span>

<span class="err">找到</span>  <span class="n">parse_server_arguments</span> <span class="err">`$</span><span class="n">print_defaults</span> <span class="err">$</span><span class="n">extra_args</span> <span class="o">--</span><span class="n">mysqld</span> <span class="n">mysql</span><span class="p">.</span><span class="n">server</span><span class="err">`</span>
<span class="err">改为</span>  <span class="n">parse_server_arguments</span> <span class="err">`$</span><span class="n">print_defaults</span> <span class="err">$</span><span class="n">extra_args</span> <span class="o">--</span><span class="n">defaults</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">mariadb</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span> <span class="n">mysqld</span><span class="err">`</span>




<span class="err">启动前修下目录权限</span>
<span class="cp"># chown -R mariadb:mariadb /data/mariadb/</span>

<span class="err">启动</span><span class="nl">MariaDB</span><span class="p">:</span>
<span class="cp"># /etc/init.d/mariadb start</span>

<span class="err">注：如果启动失败，查看下</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">mariadb_error</span><span class="p">.</span><span class="n">log</span><span class="err">文件看报什么错，修正即可。</span>

<span class="err">设置</span><span class="n">root</span><span class="err">的密码</span>
<span class="cp">#/home/local/mariadb/bin/mysqladmin -u root password &#39;123456&#39;</span>

<span class="err">进入</span><span class="n">MariaDB</span><span class="err">的</span><span class="n">shell</span><span class="err">下</span>
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">localhost</span> <span class="n">mariadb</span><span class="p">]</span><span class="err">#</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">mariadb</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">mysql</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="o">-</span><span class="n">p</span>
<span class="n">Type</span> <span class="err">&#39;</span><span class="n">help</span><span class="p">;</span><span class="err">&#39;</span> <span class="n">or</span> <span class="sc">&#39;\h&#39;</span> <span class="k">for</span> <span class="n">help</span><span class="p">.</span> <span class="n">Type</span> <span class="sc">&#39;\c&#39;</span> <span class="n">to</span> <span class="n">clear</span> <span class="n">the</span> <span class="n">current</span> <span class="n">input</span> <span class="n">statement</span><span class="p">.</span>
<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">engines</span><span class="err">\</span><span class="n">G</span><span class="p">;</span>

<span class="n">MariaDB</span> <span class="p">[</span><span class="n">mysql</span><span class="p">]</span><span class="o">&gt;</span><span class="n">use</span> <span class="n">mysql</span><span class="p">;</span> <span class="c1">//选择系统数据库mysql   </span>
<span class="n">MariaDB</span> <span class="p">[</span><span class="n">mysql</span><span class="p">]</span><span class="o">&gt;</span><span class="n">select</span> <span class="n">Host</span><span class="p">,</span><span class="n">User</span><span class="p">,</span><span class="n">Password</span> <span class="n">from</span> <span class="n">user</span><span class="p">;</span> <span class="c1">//查看所有用户   </span>
<span class="n">MariaDB</span> <span class="p">[</span><span class="n">mysql</span><span class="p">]</span><span class="o">&gt;</span><span class="n">delete</span> <span class="n">from</span> <span class="n">user</span> <span class="n">where</span> <span class="n">password</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="n">MariaDB</span> <span class="p">[</span><span class="n">mysql</span><span class="p">]</span><span class="o">&gt;</span><span class="n">GRANT</span> <span class="n">ALL</span> <span class="n">PRIVILEGES</span> <span class="n">ON</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="n">TO</span> <span class="n">root</span><span class="s">@&quot;%&quot;</span> <span class="n">IDENTIFIED</span> <span class="n">BY</span> <span class="err">&#39;</span><span class="mi">123456</span><span class="err">&#39;</span><span class="p">;</span> <span class="c1">//为root添加</span>
<span class="err">远程连接的能力</span>
<span class="n">MariaDB</span> <span class="p">[</span><span class="n">mysql</span><span class="p">]</span><span class="o">&gt;</span><span class="n">flush</span> <span class="n">privileges</span><span class="p">;</span>   
<span class="n">MariaDB</span> <span class="p">[</span><span class="n">mysql</span><span class="p">]</span><span class="o">&gt;</span><span class="n">select</span> <span class="n">Host</span><span class="p">,</span><span class="n">User</span><span class="p">,</span><span class="n">Password</span> <span class="n">from</span> <span class="n">user</span><span class="p">;</span> <span class="c1">//确认密码为空的用户是否已全部删除   </span>
<span class="n">MariaDB</span> <span class="p">[</span><span class="n">mysql</span><span class="p">]</span><span class="o">&gt;</span><span class="n">exit</span><span class="p">;</span>


<span class="err">设置防火墙，以便局域网内的其它服务器可以访问</span>
<span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysconfig</span><span class="o">/</span><span class="n">iptables</span>

<span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">-</span><span class="n">m</span> <span class="n">tcp</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">3309</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>

<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">iptables</span> <span class="n">restart</span>
</pre></div>


<h2 id="_5">临时表位置</h2>
<div class="codehilite"><pre><span></span><span class="nv">mount</span>  <span class="o">-</span><span class="nv">t</span> <span class="nv">tmpfs</span> <span class="o">-</span><span class="nv">o</span> <span class="nv">size</span><span class="o">=</span><span class="mi">20</span><span class="nv">m</span>  <span class="nv">tmpfs</span> <span class="o">/</span><span class="nv">mnt</span><span class="o">/</span><span class="nv">ramdisk</span>
<span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">fstab</span>
<span class="nv">tmpfs</span>            <span class="o">/</span><span class="nv">mnt</span><span class="o">/</span><span class="nv">ramdisk</span><span class="o">/</span>   <span class="nv">tmpfs</span>    <span class="nv">size</span><span class="o">=</span><span class="mi">20</span><span class="nv">m</span>    <span class="mi">0</span> <span class="mi">0</span>

<span class="k">SHOW</span> <span class="nv">GLOBAL</span> <span class="nv">VARIABLES</span> <span class="nv">LIKE</span> <span class="s1">&#39;</span><span class="s">tmpdir</span><span class="s1">&#39;</span><span class="c1">;</span>

<span class="nv">my</span>.<span class="nv">cnf</span>
[<span class="nv">mysqld</span>]
<span class="nv">max_heap_table_size</span><span class="o">=</span><span class="mi">1024</span><span class="nv">M</span>   #内存表容量
<span class="nv">tmp_table_size</span><span class="o">=</span><span class="mi">1024</span><span class="nv">M</span>              #临时表容量
<span class="nv">tmpdir</span><span class="o">=/</span><span class="nv">mnt</span><span class="o">/</span><span class="nv">ramdisk</span>
</pre></div>


<h2 id="sqladvisor">sqladvisor优化工具</h2>
<div class="codehilite"><pre><span></span><span class="err">美团</span><span class="k">sql</span><span class="err">优化工具</span>
<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">Meituan</span><span class="o">-</span><span class="n">Dianping</span><span class="o">/</span><span class="n">SQLAdvisor</span>
</pre></div>


<h2 id="slow_killsh">slow_kill.sh</h2>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
mysql --login-path<span class="o">=</span><span class="nb">test</span> -e <span class="s2">&quot;show full processlist&quot;</span> <span class="p">|</span> grep -i <span class="k">select</span> <span class="p">|</span> awk <span class="s1">&#39;{print $1,$6}&#39;</span> &gt; /script/slow.txt

<span class="k">while</span> <span class="nb">read</span> line
<span class="k">do</span>
   <span class="nv">time1</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$line</span> <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>
   <span class="k">if</span> <span class="o">[</span> <span class="nv">$time1</span> -gt <span class="m">5</span>  <span class="o">]</span><span class="p">;</span><span class="k">then</span>    超过5s杀掉
       <span class="nv">id</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$line</span> <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span>
       <span class="nb">echo</span> <span class="nv">$id</span>, <span class="nv">$time1</span>
       mysql --login-path<span class="o">=</span><span class="nb">test</span> -e <span class="s2">&quot;kill </span><span class="nv">$id</span><span class="s2">&quot;</span>
   <span class="k">fi</span>
<span class="k">done</span> &lt; /script/slow.txt
</pre></div>
</td></tr></table>

<h2 id="_6">主从不同步</h2>
<div class="codehilite"><pre><span></span><span class="err">重新做主从，完全同步</span>
<span class="err">该方法适用于主从库数据相差较大，或者要求数据完全统一的情况</span>

<span class="err">解决步骤如下：</span>
<span class="o">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="err">主库设置</span>

<span class="mf">1.</span><span class="err">先进入主库，进行锁表，防止数据写入</span>
<span class="err">使用命令：</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">flush</span> <span class="n">tables</span> <span class="n">with</span> <span class="n">read</span> <span class="n">lock</span><span class="p">;</span>
<span class="err">注意：该处是锁定为只读状态，语句不区分大小写</span>

<span class="err">同步用户，如已有不再创建</span>
<span class="n">grant</span> <span class="n">replication</span> <span class="n">slave</span> <span class="n">on</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="n">to</span> <span class="err">&#39;</span><span class="n">repl</span><span class="sc">&#39;@&#39;</span><span class="mf">192.168.0</span><span class="p">.</span><span class="o">%</span><span class="err">&#39;</span> <span class="n">identified</span> <span class="n">by</span> <span class="err">&#39;</span><span class="mi">123456</span><span class="err">&#39;</span><span class="p">;</span>
<span class="n">flush</span> <span class="n">privileges</span><span class="p">;</span>

<span class="mf">2.</span><span class="err">进行数据备份</span>
<span class="cp">#把数据备份到all.sql文件</span>
<span class="n">mysqldump</span> <span class="o">--</span><span class="n">master</span><span class="o">-</span><span class="n">data</span><span class="o">=</span><span class="mi">2</span> <span class="o">--</span><span class="n">single</span><span class="o">-</span><span class="n">transaction</span> <span class="o">-</span><span class="n">R</span> <span class="o">--</span><span class="n">triggers</span> <span class="o">-</span><span class="n">A</span> <span class="o">&gt;</span> <span class="n">all</span><span class="p">.</span><span class="n">sql</span>
<span class="err">其中</span><span class="o">--</span><span class="n">master</span><span class="o">-</span><span class="n">data</span><span class="o">=</span><span class="mi">2</span><span class="err">代表备份时刻记录</span><span class="n">master</span><span class="err">的</span><span class="n">Binlog</span><span class="err">位置和</span><span class="n">Position</span>
       <span class="o">--</span><span class="n">single</span><span class="o">-</span><span class="n">transaction</span><span class="err">意思是获取一致性快照</span>
       <span class="o">-</span><span class="n">R</span><span class="err">意思是备份存储过程和函数</span>
       <span class="o">--</span><span class="n">triggres</span><span class="err">的意思是备份触发器</span>
        <span class="o">-</span><span class="n">A</span><span class="err">代表备份所有的库。更多信息请自行</span><span class="n">mysqldump</span> <span class="o">--</span><span class="n">help</span><span class="err">查看。</span>
<span class="err">这里注意一点：数据库备份一定要定期进行，可以用</span><span class="n">shell</span><span class="err">脚本或者</span><span class="n">python</span><span class="err">脚本，都比较方便，确保数据万无一失</span>

<span class="mf">3.</span><span class="err">查看主库备份时的</span><span class="n">binlog</span><span class="err">名称和位置，</span><span class="n">MASTER_LOG_FILE</span><span class="err">和</span><span class="n">MASTER_LOG_POS</span><span class="err">：</span>

<span class="p">[</span><span class="n">root</span><span class="mf">@192.168.0.50</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">head</span> <span class="o">-</span><span class="n">n</span> <span class="mi">30</span> <span class="n">all</span><span class="p">.</span><span class="n">sql</span> <span class="o">|</span> <span class="n">grep</span> <span class="err">&#39;</span><span class="n">CHANGE</span> <span class="n">MASTER</span> <span class="n">TO</span><span class="err">&#39;</span>
<span class="o">--</span> <span class="n">CHANGE</span> <span class="n">MASTER</span> <span class="n">TO</span> <span class="n">MASTER_LOG_FILE</span><span class="o">=</span><span class="err">&#39;</span><span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000010</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">MASTER_LOG_POS</span><span class="o">=</span><span class="mi">112</span><span class="p">;</span>

<span class="mi">4</span>  <span class="err">解锁主数据库的锁表操作</span>
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">master</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">mysql</span> <span class="o">-</span><span class="n">uroot</span> <span class="o">-</span><span class="n">p</span>    <span class="p">(</span><span class="err">本命令在主数据库服务器上执行</span><span class="p">)</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">unlock</span> <span class="n">tables</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="mi">5</span> <span class="p">.</span><span class="err">把</span><span class="n">mysql</span><span class="err">备份文件传到从库机器，进行数据恢复</span>
<span class="cp">#使用scp命令</span>
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">server01</span> <span class="n">mysql</span><span class="p">]</span><span class="err">#</span> <span class="n">scp</span> <span class="n">all</span><span class="p">.</span><span class="n">sql</span> <span class="n">root</span><span class="mf">@192.168.128.101</span><span class="o">:/</span><span class="n">tmp</span><span class="o">/</span>

<span class="o">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="err">从库设置</span>  <span class="err">注意配置文件</span> <span class="n">server</span><span class="o">-</span><span class="kt">id</span>
<span class="mf">5.</span><span class="err">停止从库的状态</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">stop</span> <span class="n">slave</span><span class="p">;</span>

<span class="mf">6.</span><span class="err">然后到从库执行</span><span class="n">mysql</span><span class="err">命令，导入数据备份</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">source</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">mysql</span><span class="p">.</span><span class="n">bak</span><span class="p">.</span><span class="n">sql</span>

<span class="mf">7.</span><span class="err">设置从库同步，注意该处的同步点，就是主库</span><span class="n">show</span> <span class="n">master</span> <span class="n">status</span><span class="err">信息里的</span><span class="o">|</span> <span class="n">File</span><span class="o">|</span> <span class="n">Position</span><span class="err">两项</span>
<span class="n">CHANGE</span> <span class="n">MASTER</span> <span class="n">TO</span> <span class="n">MASTER_HOST</span><span class="o">=</span><span class="err">&#39;</span><span class="mf">192.168.0.50</span><span class="err">&#39;</span><span class="p">,</span><span class="n">MASTER_USER</span><span class="o">=</span><span class="err">&#39;</span><span class="n">repl</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">MASTER_PASSWORD</span><span class="o">=</span><span class="err">&#39;</span><span class="mi">123456</span><span class="err">&#39;</span><span class="p">,</span>
<span class="n">MASTER_LOG_FILE</span><span class="o">=</span><span class="err">&#39;</span><span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000010</span><span class="err">&#39;</span><span class="p">,</span><span class="n">MASTER_LOG_POS</span><span class="o">=</span><span class="mi">112</span><span class="p">;</span>

<span class="mf">8.</span><span class="err">重新开启从同步</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">start</span> <span class="n">slave</span><span class="p">;</span>

<span class="mf">9.</span><span class="err">查看同步状态</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">slave</span> <span class="n">status</span><span class="err">\</span><span class="n">G</span>  <span class="err">查看：</span>

<span class="nl">Slave_IO_Running</span><span class="p">:</span> <span class="n">Yes</span>
<span class="nl">Slave_SQL_Running</span><span class="p">:</span> <span class="n">Yes</span>
<span class="nl">Seconds_Behind_Master</span><span class="p">:</span> <span class="mi">0</span>   <span class="err">变为</span><span class="mi">0</span><span class="err">说明都同步完毕</span>

<span class="err">好了，同步完成啦。</span>
</pre></div>


<h2 id="mysql">mysql安装</h2>
<div class="codehilite"><pre><span></span><span class="n">ftp</span><span class="p">:</span><span class="o">//</span><span class="n">mirror</span><span class="p">.</span><span class="n">switch</span><span class="p">.</span><span class="n">ch</span><span class="o">/</span><span class="n">mirror</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span>
<span class="err">国内</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">mirrors</span><span class="p">.</span><span class="n">sohu</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span>


<span class="n">yum</span> <span class="n">install</span> <span class="n">rpm</span><span class="o">-</span><span class="n">build</span> <span class="n">gperf</span> <span class="n">ncurses</span><span class="o">-</span><span class="n">devel</span> <span class="n">cmake</span>  <span class="n">libaio</span><span class="o">-</span><span class="n">devel</span>
<span class="n">rpm</span> <span class="o">-</span><span class="n">ivh</span> <span class="n">MySQL</span><span class="o">-</span><span class="mi">5</span><span class="p">.</span><span class="mi">6</span><span class="p">.</span><span class="mi">30</span><span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="n">el6</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">rpm</span>

<span class="n">cd</span> <span class="p">.</span><span class="o">/</span><span class="n">rpmbuild</span><span class="o">/</span><span class="n">SPECS</span><span class="o">/</span>
<span class="n">rpmbuild</span> <span class="o">-</span><span class="n">bb</span> <span class="n">mysql</span><span class="p">.</span><span class="n">spec</span> <span class="c1">--define=&#39;runselftest 0&#39;</span>
<span class="n">cd</span> <span class="p">..</span><span class="o">/</span><span class="n">RPMS</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span>  <span class="err">里面是编译好的</span><span class="n">rpm</span><span class="err">包</span>

<span class="err">源码安装</span>
<span class="n">wget</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">mirrors</span><span class="p">.</span><span class="n">sohu</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">MySQL</span><span class="o">-</span><span class="mi">5</span><span class="p">.</span><span class="mi">6</span><span class="o">/</span><span class="n">mysql</span><span class="o">-</span><span class="mi">5</span><span class="p">.</span><span class="mi">6</span><span class="p">.</span><span class="mi">34</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>

<span class="n">yum</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">make</span> <span class="n">gcc</span><span class="o">-</span><span class="k">c</span><span class="o">++</span> <span class="n">cmake</span> <span class="n">bison</span><span class="o">-</span><span class="n">devel</span>  <span class="n">ncurses</span><span class="o">-</span><span class="n">devel</span>
<span class="n">groupadd</span> <span class="n">mysql</span>
<span class="n">useradd</span> <span class="o">-</span><span class="k">g</span> <span class="n">mysql</span> <span class="n">mysql</span>

<span class="n">cmake</span> <span class="err">\</span>
<span class="o">-</span><span class="n">DCMAKE_INSTALL_PREFIX</span><span class="o">=/</span><span class="k">data</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span> <span class="err">\</span>
<span class="o">-</span><span class="n">DMYSQL_DATADIR</span><span class="o">=/</span><span class="k">data</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="k">data</span> <span class="err">\</span>
<span class="o">-</span><span class="n">DSYSCONFDIR</span><span class="o">=/</span><span class="n">etc</span> <span class="err">\</span>
<span class="o">-</span><span class="n">DWITH_MYISAM_STORAGE_ENGINE</span><span class="o">=</span><span class="mi">1</span> <span class="err">\</span>
<span class="o">-</span><span class="n">DWITH_INNOBASE_STORAGE_ENGINE</span><span class="o">=</span><span class="mi">1</span> <span class="err">\</span>
<span class="o">-</span><span class="n">DWITH_MEMORY_STORAGE_ENGINE</span><span class="o">=</span><span class="mi">1</span> <span class="err">\</span>
<span class="o">-</span><span class="n">DWITH_READLINE</span><span class="o">=</span><span class="mi">1</span> <span class="err">\</span>
<span class="o">-</span><span class="n">DMYSQL_UNIX_ADDR</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">mysql</span><span class="p">.</span><span class="n">sock</span> <span class="err">\</span>
<span class="o">-</span><span class="n">DMYSQL_TCP_PORT</span><span class="o">=</span><span class="mi">3306</span> <span class="err">\</span>
<span class="o">-</span><span class="n">DENABLED_LOCAL_INFILE</span><span class="o">=</span><span class="mi">1</span> <span class="err">\</span>
<span class="o">-</span><span class="n">DWITH_PARTITION_STORAGE_ENGINE</span><span class="o">=</span><span class="mi">1</span> <span class="err">\</span>
<span class="o">-</span><span class="n">DEXTRA_CHARSETS</span><span class="o">=</span><span class="k">all</span> <span class="err">\</span>
<span class="o">-</span><span class="n">DDEFAULT_CHARSET</span><span class="o">=</span><span class="n">utf8</span> <span class="err">\</span>
<span class="o">-</span><span class="n">DDEFAULT_COLLATION</span><span class="o">=</span><span class="n">utf8_general_ci</span>

<span class="n">make</span> <span class="o">&amp;&amp;</span> <span class="n">make</span> <span class="n">install</span>

<span class="n">cp</span> <span class="n">cp</span> <span class="n">support</span><span class="o">-</span><span class="n">files</span><span class="o">/</span><span class="n">my</span><span class="o">-</span><span class="k">default</span><span class="p">.</span><span class="n">cnf</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span>
<span class="o">##</span><span class="n">config</span> <span class="n">file</span> <span class="n">edit</span>
<span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span>
<span class="n">skip</span><span class="o">-</span><span class="n">name</span><span class="o">-</span><span class="n">resolve</span><span class="o">=</span><span class="mi">1</span>

<span class="n">cp</span> <span class="n">support</span><span class="o">-</span><span class="n">files</span><span class="o">/</span><span class="n">mysql</span><span class="p">.</span><span class="n">server</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">mysql</span>
<span class="n">chmod</span> <span class="mi">755</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">mysql</span>

<span class="n">chown</span> <span class="n">mysql</span><span class="p">.</span><span class="n">mysql</span> <span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span> <span class="o">-</span><span class="n">R</span>
<span class="o">##</span><span class="n">init</span> <span class="n">mysql</span> <span class="n">datadir</span>
<span class="n">chmod</span> <span class="mi">755</span> <span class="n">scripts</span><span class="o">/</span><span class="n">mysql_install_db</span>
<span class="n">scripts</span><span class="o">/</span><span class="n">mysql_install_db</span> <span class="c1">--user=mysql --basedir=/data/mysql/ --datadir=/data/mysql/data/</span>

<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">mysql</span> <span class="k">start</span>

<span class="err">运行</span><span class="k">sql</span>  <span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">mysql</span>
<span class="k">delete</span> <span class="k">from</span> <span class="n">mysql</span><span class="p">.</span><span class="k">user</span> <span class="k">where</span> <span class="k">user</span><span class="o">=</span><span class="ss">&quot;&quot;</span><span class="p">;</span>  <span class="err">删除匿名用户</span>
<span class="k">set</span> <span class="n">password</span><span class="o">=</span><span class="n">PASSWORD</span><span class="p">(</span><span class="s1">&#39;pass&#39;</span><span class="p">);</span>      <span class="err">设置登录密码</span>
<span class="n">FLUSH</span> <span class="k">PRIVILEGES</span><span class="p">;</span>
</pre></div>


<h2 id="last_sql_error">主从Last_SQL_error</h2>
<div class="codehilite"><pre><span></span>由于字符集编码问题，导致<span class="nv">slave</span>上<span class="nv">insert</span>中文时出错。

处理过程为:
<span class="mi">1</span>. 先停止<span class="nv">slave</span>
<span class="nv">MySQL</span><span class="o">&gt;</span><span class="nv">stop</span> <span class="nv">slave</span><span class="c1">;</span>

<span class="mi">2</span>. 跳过<span class="nv">slave</span>上的<span class="mi">1</span>个错误
<span class="nv">mysql</span><span class="o">&gt;</span><span class="nv">set</span>  <span class="nv">global</span> <span class="nv">sql_slave_skip_counter</span><span class="o">=</span><span class="mi">1</span><span class="c1">;</span>

<span class="mi">3</span>.在<span class="nv">slave</span>上手工插入一条数据
<span class="nv">mysql</span><span class="o">&gt;</span><span class="nv">insert</span> <span class="nv">into</span>  ...

<span class="mi">4</span>.启动<span class="nv">slave</span>
<span class="nv">mysql</span><span class="o">&gt;</span><span class="nv">start</span> <span class="nv">slave</span><span class="c1">;</span>

<span class="mi">5</span>.过了一段时间，待<span class="nv">Seconds_Behind_Master</span>为<span class="mi">0</span>后
<span class="nv">mysql</span><span class="o">&gt;</span><span class="nv">pager</span> <span class="nv">grep</span> <span class="o">-</span><span class="nv">i</span> <span class="o">-</span><span class="nv">E</span>  <span class="s1">&#39;</span><span class="s">Running|Seconds</span><span class="s1">&#39;</span>
<span class="nv">mysql</span><span class="o">&gt;</span><span class="k">show</span> <span class="nv">slave</span> <span class="nv">status</span>\<span class="nv">G</span>
             <span class="nv">Slave_IO_Running</span>: <span class="nv">Yes</span>
            <span class="nv">Slave_SQL_Running</span>: <span class="nv">Yes</span>
        <span class="nv">Seconds_Behind_Master</span>: <span class="mi">0</span>
      <span class="nv">Slave_SQL_Running_State</span>: <span class="nv">Slave</span> <span class="nv">has</span> <span class="nv">read</span> <span class="nv">all</span> <span class="nv">relay</span> <span class="nv">log</span><span class="c1">; waiting for the slave I/O thread to update it</span>
<span class="mi">1</span> <span class="nv">row</span> <span class="nv">in</span> <span class="nv">set</span> <span class="ss">(</span><span class="mi">0</span>.<span class="mi">00</span> <span class="nv">sec</span><span class="ss">)</span>

<span class="mi">6</span>.检查同步表的数据，发现<span class="nv">slave</span>比<span class="nv">master</span>少一条
<span class="nv">mysql</span><span class="o">&gt;</span><span class="nv">select</span> <span class="nv">count</span><span class="ss">(</span><span class="mi">1</span><span class="ss">)</span>  <span class="nv">from</span> <span class="nv">test</span><span class="c1">;</span>


此时<span class="nv">master</span>上业务已经停止更新<span class="nv">test</span>表中的数据。


检查<span class="nv">master</span>上的<span class="nv">binlog</span>：
# <span class="nv">at</span> <span class="mi">666</span>
<span class="sc">#141121</span> <span class="mi">14</span>:<span class="mi">23</span>:<span class="mi">38</span> <span class="nv">server</span> <span class="nv">id</span> <span class="mi">150</span>  <span class="nv">end_log_pos</span> <span class="mi">755</span> <span class="k">CRC32</span> <span class="mi">0</span><span class="nv">x10a3f34c</span>        <span class="nv">Query</span>   <span class="nv">thread_id</span><span class="o">=</span><span class="mi">411</span>   <span class="nv">exec_time</span><span class="o">=</span><span class="mi">0</span>    
 <span class="nv">error_code</span><span class="o">=</span><span class="mi">0</span>
<span class="nv">SET</span> <span class="nv">TIMESTAMP</span><span class="o">=</span><span class="mi">1416551018</span><span class="cm">/*!*/</span><span class="c1">;</span>
<span class="nv">BEGIN</span>
<span class="cm">/*!*/</span><span class="c1">;</span>
# <span class="nv">at</span> <span class="mi">755</span>
<span class="sc">#141121</span> <span class="mi">14</span>:<span class="mi">23</span>:<span class="mi">38</span> <span class="nv">server</span> <span class="nv">id</span> <span class="mi">150</span>  <span class="nv">end_log_pos</span> <span class="mi">865</span> <span class="k">CRC32</span> <span class="mi">0</span><span class="nv">xca82b435</span>        <span class="nv">Query</span>   <span class="nv">thread_id</span><span class="o">=</span><span class="mi">411</span>   <span class="nv">exec_time</span><span class="o">=</span><span class="mi">0</span>   
  <span class="nv">error_code</span><span class="o">=</span><span class="mi">0</span>
<span class="nv">SET</span> <span class="nv">TIMESTAMP</span><span class="o">=</span><span class="mi">1416551018</span><span class="cm">/*!*/</span><span class="c1">;</span>
<span class="nv">insert</span> <span class="nv">into</span> <span class="nv">test</span> <span class="nv">values</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">北京</span><span class="s1">&#39;</span><span class="ss">)</span>
<span class="cm">/*!*/</span><span class="c1">;</span>
# <span class="nv">at</span> <span class="mi">865</span>
<span class="sc">#141121</span> <span class="mi">14</span>:<span class="mi">23</span>:<span class="mi">38</span> <span class="nv">server</span> <span class="nv">id</span> <span class="mi">150</span>  <span class="nv">end_log_pos</span> <span class="mi">975</span> <span class="k">CRC32</span> <span class="mi">0</span><span class="nv">xd377f37e</span>        <span class="nv">Query</span>   <span class="nv">thread_id</span><span class="o">=</span><span class="mi">411</span>   <span class="nv">exec_time</span><span class="o">=</span><span class="mi">0</span>  
   <span class="nv">error_code</span><span class="o">=</span><span class="mi">0</span>
<span class="nv">SET</span> <span class="nv">TIMESTAMP</span><span class="o">=</span><span class="mi">1416551018</span><span class="cm">/*!*/</span><span class="c1">;</span>
<span class="nv">insert</span> <span class="nv">into</span> <span class="nv">test</span> <span class="nv">values</span><span class="ss">(</span>‘上海’<span class="ss">)</span>
<span class="cm">/*!*/</span><span class="c1">;</span>
# <span class="nv">at</span> <span class="mi">975</span>
<span class="sc">#141121</span> <span class="mi">14</span>:<span class="mi">23</span>:<span class="mi">38</span> <span class="nv">server</span> <span class="nv">id</span> <span class="mi">150</span>  <span class="nv">end_log_pos</span> <span class="mi">1006</span> <span class="k">CRC32</span> <span class="mi">0</span><span class="nv">x91c3fc01</span>       <span class="nv">Xid</span> <span class="o">=</span> <span class="mi">2745705</span>
<span class="nv">COMMIT</span><span class="cm">/*!*/</span><span class="c1">;</span>
发现在一个<span class="nv">BEGIN</span><span class="o">/</span><span class="nv">insert</span><span class="o">/</span><span class="nv">COMMIT</span>中插入了多条数据，而我只在<span class="nv">slave</span>上插入了一条。
所以数据会比<span class="nv">master</span>上少一条。去<span class="nv">slave</span>上查找，果然找不到这个事物中插入的另一条记录。
这是因为如果跳过的<span class="nv">event</span>在一个事物内，则整个事物的<span class="nv">event</span>都会被跳过。

所以在使用<span class="nv">set</span>  <span class="nv">global</span> <span class="nv">sql_slave_skip_counter</span><span class="o">=</span><span class="mi">1</span><span class="c1">; 时要注意以下几点：</span>
<span class="mi">1</span>. 检查跳过的<span class="nv">event</span>是否在一个事物中
<span class="mi">2</span>. 跳过<span class="nv">slave</span>上的<span class="nv">event</span>进行后续处理后要检查数据的一致性。
<span class="mi">3</span>. 最好能在<span class="nv">master</span>的<span class="nv">binglog</span>上查看一下跳过的<span class="nv">evnet</span>到底做了写什么。
</pre></div>


<h2 id="_7">慢查询</h2>
<div class="codehilite"><pre><span></span><span class="nv">long_query_time</span><span class="o">=</span><span class="mi">10</span>  超过该配置时间的 <span class="nv">SQL</span> 语句将会被记录，时间是秒
<span class="nv">slow_query_log</span><span class="o">=</span><span class="mi">1</span>   表示开启慢查询记录

#以前版本的参数格式跟<span class="mi">5</span>.<span class="mi">6</span>的不一致
<span class="nv">slow_query_log_file</span><span class="o">=/</span><span class="nv">data</span><span class="o">/</span><span class="nv">mysql</span><span class="o">/</span><span class="nv">data</span><span class="o">/</span><span class="nv">mysql</span><span class="o">-</span><span class="nv">master</span><span class="o">-</span><span class="nv">slow</span>.<span class="nv">log</span>
#将所有没有使用带索引的查询语句全部写到慢查询日志中
<span class="nv">log_queries_not_using_indexes</span><span class="o">=</span><span class="mi">1</span>

<span class="k">show</span> <span class="nv">variables</span> <span class="nv">like</span> <span class="s1">&#39;</span><span class="s">%slow%</span><span class="s1">&#39;</span><span class="c1">;</span>
<span class="k">show</span> <span class="nv">variables</span> <span class="nv">like</span> <span class="s1">&#39;</span><span class="s">%index%</span><span class="s1">&#39;</span><span class="c1">;</span>


写入到表 <span class="nv">mysql</span>.<span class="nv">slow_log</span>
<span class="nv">select</span> @@<span class="nv">global</span>.<span class="nv">log_output</span><span class="c1">;</span>
<span class="nv">set</span> @@<span class="nv">global</span>.<span class="nv">log_output</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">TABLE</span><span class="s1">&#39;</span><span class="c1">;</span>
</pre></div>


<h2 id="_8">优化建议</h2>
<div class="codehilite"><pre><span></span><span class="mi">1</span>.对查询进行优化，应尽量避免全表扫描，首先应考虑在 <span class="nv">where</span> 及 <span class="nv">order</span> <span class="nv">by</span> 涉及的列上建立索引。

缺省情况下建立的索引是非群集索引，但有时它并不是最佳的。在非群集索引下，数据在物理上随机存放在数据页上。合理的索引设计
要建立在对各种查询的分析和预测上。一般来说：

<span class="nv">a</span>.有大量重复值、且经常有范围查询<span class="ss">(</span> <span class="o">&gt;</span> ,<span class="o">&lt;</span> ,<span class="o">&gt;</span> <span class="o">=</span>,<span class="o">&lt;</span> <span class="o">=</span><span class="ss">)</span>和 <span class="nv">order</span> <span class="nv">by</span>、<span class="nv">group</span> <span class="nv">by</span> 发生的列，可考虑建立集群索引<span class="c1">;</span>

  <span class="nv">b</span>.经常同时存取多列，且每列都含有重复值可考虑建立组合索引， 选择度高的列建议作为索引的第一个字段

<span class="nv">c</span>.组合索引要尽量使关键查询形成索引覆盖，其前导列一定是使用最频繁的列。索引虽有助于提高性能但 不是索引越多越好，恰好相反
过多的索引会导致系统低效。用户在表中每加进一个索引，维护索引集合就 要做相应的更新工作。

<span class="mi">2</span>.应尽量避免在 <span class="nv">where</span> 子句中对字段进行 <span class="nv">null</span> 值判断，否则将导致引擎放弃使用索引而进行全表扫描，

<span class="nv">Sql</span> 代码 : <span class="nv">select</span> <span class="nv">id</span> <span class="nv">from</span> <span class="nv">t</span> <span class="nv">where</span> <span class="nv">num</span> <span class="nv">is</span> <span class="nv">null</span><span class="c1">;</span>
可以在 <span class="nv">num</span> 上设置默认值 <span class="mi">0</span>,确保表中 <span class="nv">num</span> 列没有 <span class="nv">null</span> 值，然后这样查询：

<span class="nv">Sql</span> 代码 : <span class="nv">select</span> <span class="nv">id</span> <span class="nv">from</span> <span class="nv">t</span> <span class="nv">where</span> <span class="nv">num</span><span class="o">=</span><span class="mi">0</span><span class="c1">;</span>
<span class="mi">3</span>.应尽量避免在 <span class="nv">where</span> 子句中使用<span class="o">!=</span>或<span class="o">&lt;&gt;</span>操作符，否则将引擎放弃使用索引而进行全表扫描。

<span class="mi">4</span>.应尽量避免在 <span class="nv">where</span> 子句中使用 <span class="nv">or</span> 来连接条件，否则将导致引擎放弃使用索引而进行全表扫描，

<span class="nv">Sql</span> 代码 : <span class="nv">select</span> <span class="nv">id</span> <span class="nv">from</span> <span class="nv">t</span> <span class="nv">where</span> <span class="nv">num</span><span class="o">=</span><span class="mi">10</span> <span class="nv">or</span> <span class="nv">num</span><span class="o">=</span><span class="mi">20</span><span class="c1">;</span>
可以这样查询：

<span class="nv">Sql</span> 代码 : <span class="nv">select</span> <span class="nv">id</span> <span class="nv">from</span> <span class="nv">t</span> <span class="nv">where</span> <span class="nv">num</span><span class="o">=</span><span class="mi">10</span> <span class="nv">union</span> <span class="nv">all</span> <span class="nv">select</span> <span class="nv">id</span> <span class="nv">from</span> <span class="nv">t</span> <span class="nv">where</span> <span class="nv">num</span><span class="o">=</span><span class="mi">20</span><span class="c1">;</span>
<span class="mi">5</span>.<span class="nv">in</span> 和 <span class="nv">not</span> <span class="nv">in</span> 也要慎用，否则会导致全表扫描，如：

<span class="nv">Sql</span> 代码 : <span class="nv">select</span> <span class="nv">id</span> <span class="nv">from</span> <span class="nv">t</span> <span class="nv">where</span> <span class="nv">num</span> <span class="nv">in</span><span class="ss">(</span><span class="mi">1</span>,<span class="mi">2</span>,<span class="mi">3</span><span class="ss">)</span><span class="c1">;</span>
对于连续的数值，能用 <span class="nv">between</span> 就不要用 <span class="nv">in</span> 了：

<span class="nv">Sql</span> 代码 : <span class="nv">select</span> <span class="nv">id</span> <span class="nv">from</span> <span class="nv">t</span> <span class="nv">where</span> <span class="nv">num</span> <span class="nv">between</span> <span class="mi">1</span> <span class="nv">and</span> <span class="mi">3</span><span class="c1">;</span>
<span class="mi">6</span>.下面的查询也将导致全表扫描：

<span class="nv">Sql</span> 代码 : <span class="nv">select</span> <span class="nv">id</span> <span class="nv">from</span> <span class="nv">t</span> <span class="nv">where</span> <span class="nv">name</span> <span class="nv">like</span> <span class="s1">&#39;</span><span class="s">%c%</span><span class="s1">&#39;</span><span class="c1">;</span>
若要提高效率，可以考虑全文检索。

<span class="mi">7</span>.如果在 <span class="nv">where</span> 子句中使用参数，也会导致全表扫描。因为 <span class="nv">SQL</span> 只有在运行时才会解析局部变量，但优 化程序不能将访问计划的选择推迟
到运行时<span class="c1">;它必须在编译时进行选择。然 而，如果在编译时建立访问计 划，变量的值还是未知的，因而无法作为索引选择的输入项。如下面语</span>
句将进行全表扫描：

<span class="nv">Sql</span> 代码 : <span class="nv">select</span> <span class="nv">id</span> <span class="nv">from</span> <span class="nv">t</span> <span class="nv">where</span> <span class="nv">num</span><span class="o">=</span>@<span class="nv">num</span> <span class="c1">;</span>
可以改为强制查询使用索引：

<span class="nv">Sql</span> 代码 : <span class="nv">select</span> <span class="nv">id</span> <span class="nv">from</span> <span class="nv">t</span> <span class="nv">with</span><span class="ss">(</span><span class="nv">index</span><span class="ss">(</span>索引名<span class="ss">))</span> <span class="nv">where</span> <span class="nv">num</span><span class="o">=</span>@<span class="nv">num</span> <span class="c1">;</span>
<span class="mi">8</span>.应尽量避免在 <span class="nv">where</span> 子句中对字段进行表达式操作， 这将导致引擎放弃使用索引而进行全表扫描。

<span class="nv">Sql</span> 代码 : <span class="nv">select</span> <span class="nv">id</span> <span class="nv">from</span> <span class="nv">t</span> <span class="nv">where</span> <span class="nv">num</span><span class="o">/</span><span class="mi">2</span><span class="o">=</span><span class="mi">100</span><span class="c1">;</span>
可以这样查询：

<span class="nv">Sql</span> 代码 : <span class="nv">select</span> <span class="nv">id</span> <span class="nv">from</span> <span class="nv">t</span> <span class="nv">where</span> <span class="nv">num</span><span class="o">=</span><span class="mi">100</span><span class="o">*</span><span class="mi">2</span><span class="c1">;</span>
<span class="mi">9</span>.应尽量避免在 <span class="nv">where</span> 子句中对字段进行函数操作，这将导致引擎放弃使用索引而进行全表扫描。如：

<span class="nv">Sql</span> 代码 : <span class="nv">select</span> <span class="nv">id</span> <span class="nv">from</span> <span class="nv">t</span> <span class="nv">where</span> <span class="nv">substring</span><span class="ss">(</span><span class="nv">name</span>,<span class="mi">1</span>,<span class="mi">3</span><span class="ss">)</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">abc</span><span class="s1">&#39;</span><span class="c1">;#name 以 abc 开头的 id</span>
应改为：

<span class="nv">Sql</span> 代码 : <span class="nv">select</span> <span class="nv">id</span> <span class="nv">from</span> <span class="nv">t</span> <span class="nv">where</span> <span class="nv">name</span> <span class="nv">like</span> <span class="s1">&#39;</span><span class="s">abc%</span><span class="s1">&#39;</span><span class="c1">;</span>
<span class="mi">10</span>.不要在 <span class="nv">where</span> 子句中的“<span class="o">=</span>”左边进行函数、算术运算或其他表达式运算，否则系统将可能无法正确使用 索引。

<span class="mi">11</span>.在使用索引字段作为条件时，如果该索引是复合索引，那么必须使用到该索引中的第一个字段作为条件 时才能保证系统使用该索引， 否则
该索引将不会 被使用， 并且应尽可能的让字段顺序与索引顺序相一致。

<span class="mi">12</span>.不要写一些没有意义的查询，如需要生成一个空表结构：

<span class="nv">Sql</span> 代码 : <span class="nv">select</span> <span class="nv">col1</span>,<span class="nv">col2</span> <span class="nv">into</span> #<span class="nv">t</span> <span class="nv">from</span> <span class="nv">t</span> <span class="nv">where</span> <span class="mi">1</span><span class="o">=</span><span class="mi">0</span><span class="c1">;</span>
这类代码不会返回任何结果集，但是会消耗系统资源的，应改成这样：

<span class="nv">Sql</span> 代码 : <span class="nv">create</span> <span class="nv">table</span> #<span class="nv">t</span><span class="ss">(</span>…<span class="ss">)</span><span class="c1">;</span>
<span class="mi">13</span>.很多时候用 <span class="nv">exists</span> 代替 <span class="nv">in</span> 是一个好的选择：

<span class="nv">Sql</span> 代码 : <span class="nv">select</span> <span class="nv">num</span> <span class="nv">from</span> <span class="nv">a</span> <span class="nv">where</span> <span class="nv">num</span> <span class="nv">in</span><span class="ss">(</span><span class="nv">select</span> <span class="nv">num</span> <span class="nv">from</span> <span class="nv">b</span><span class="ss">)</span><span class="c1">;</span>
用下面的语句替换：

<span class="nv">Sql</span> 代码 : <span class="nv">select</span> <span class="nv">num</span> <span class="nv">from</span> <span class="nv">a</span> <span class="nv">where</span> <span class="nv">exists</span><span class="ss">(</span><span class="nv">select</span> <span class="mi">1</span> <span class="nv">from</span> <span class="nv">b</span> <span class="nv">where</span> <span class="nv">num</span><span class="o">=</span><span class="nv">a</span>.<span class="nv">num</span><span class="ss">)</span><span class="c1">;</span>
<span class="mi">14</span>.并不是所有索引对查询都有效，<span class="nv">SQL</span> 是根据表中数据来进行查询优化的，当索引列有大量数据重复时， <span class="nv">SQL</span> 查询可能不会去利用索引，如
一表中有字段 <span class="o">***</span>,<span class="nv">male</span>、<span class="nv">female</span> 几乎各一半，那么即使在 <span class="o">***</span> 上建 了索引也对查询效率起不了作用。

<span class="mi">15</span>.索引并不是越多越好，索引固然可以提高相应的 <span class="nv">select</span> 的效率，但同时也降低了 <span class="nv">insert</span> 及 <span class="nv">update</span> 的效率，因为 <span class="nv">insert</span> 或 <span class="nv">update</span> 
时有可能会重建索引，所以怎样建索引需要慎重考虑，视具体情况而定。一个表的索引数最好不要超过 <span class="mi">6</span> 个，若太多则应考虑一些不常使用到的列
上建的索引是否有必要。

<span class="mi">16</span>.应尽可能的避免更新 <span class="nv">clustered</span> 索引数据列， 因为 <span class="nv">clustered</span> 索引数据列的顺序就是表记录的物理存储顺序，一旦该列值改变将导致整个
表记录的顺序的调整，会耗费相当大的资源。若应用系统需要频繁更新 <span class="nv">clustered</span> 索引数据列，那么需要考虑是否应将该索引建为 <span class="nv">clustered</span> 索引。

<span class="mi">17</span>.尽量使用数字型字段，若只含数值信息的字段尽量不要设计为字符型，这会降低查询和连接的性能，并 会增加存储开销。这是因为引擎在处理查
询和连接时会逐个比较字符串中每一个字符，而对于数字型而言 只需要比较一次就够了。

<span class="mi">18</span>.尽可能的使用 <span class="nv">varchar</span><span class="o">/</span><span class="nv">nvarchar</span> 代替 <span class="nv">char</span><span class="o">/</span><span class="nv">nchar</span> , 因为首先变长字段存储空间小， 可以节省存储空间， 其次对于查询来说，在一个
相对较小的字段内搜索效率显然要高些。

<span class="mi">19</span>.任何地方都不要使用 <span class="nv">select</span> <span class="o">*</span> <span class="nv">from</span> <span class="nv">t</span> ,用具体的字段列表代替“<span class="o">*</span>”,不要返回用不到的任何字段。

<span class="mi">20</span>.尽量使用表变量来代替临时表。如果表变量包含大量数据，请注意索引非常有限<span class="ss">(</span>只有主键索引<span class="ss">)</span>。

<span class="mi">21</span>.避免频繁创建和删除临时表，以减少系统表资源的消耗。

<span class="mi">22</span>.临时表并不是不可使用，适当地使用它们可以使某些例程更有效，例如，当需要重复引用大型表或常用 表中的某个数据集时。但是，对于一次
性事件， 最好使用导出表。

<span class="mi">23</span>.在新建临时表时，如果一次性插入数据量很大，那么可以使用 <span class="nv">select</span> <span class="nv">into</span> 代替 <span class="nv">create</span> <span class="nv">table</span>,避免造成大量 <span class="nv">log</span> ,以提高速度<span class="c1">;如果数</span>
据量不大，为了缓和系统表的资源，应先 <span class="nv">create</span> <span class="nv">table</span>,然后 <span class="nv">insert</span>.

<span class="mi">24</span>.如果使用到了临时表， 在存储过程的最后务必将所有的临时表显式删除， 先 <span class="nv">truncate</span> <span class="nv">table</span> ,然后 <span class="nv">drop</span> <span class="nv">table</span> ,这样可以避免系统表
的较长时间锁定。

<span class="mi">25</span>.尽量避免使用游标，因为游标的效率较差，如果游标操作的数据超过 <span class="mi">1</span> 万行，那么就应该考虑改写。

<span class="mi">26</span>.使用基于游标的方法或临时表方法之前，应先寻找基于集的解决方案来解决问题，基于集的方法通常更 有效。


<span class="mi">27</span>.与临时表一样，游标并不是不可使用。对小型数据集使用 <span class="nv">FAST_FORWARD</span> 游标通常要优于其他逐行处理方法，尤其是在必须引用几个表才能
获得所需的数据时。在结果集中包括“合计”的例程通常要比使用游标执行的速度快。如果开发时 间允许，基于游标的方法和基于集的方法都可以
尝试一下，看哪一种方法的效果更好。

<span class="mi">28</span>.在所有的存储过程和触发器的开始处设置 <span class="nv">SET</span> <span class="nv">NOCOUNT</span> <span class="nv">ON</span> ,在结束时设置 <span class="nv">SET</span> <span class="nv">NOCOUNT</span> <span class="nv">OFF</span> .无需在执行存储过程和触发器的每个语句
后向客户端发送 <span class="nv">DONE_IN_PROC</span> 消息。

<span class="mi">29</span>.尽量避免大事务操作，提高系统并发能力。

<span class="mi">30</span>.定期分析表和检查表。

分析表的语法：<span class="nv">ANALYZE</span> [<span class="nv">LOCAL</span> <span class="o">|</span> <span class="nv">NO_WRITE_TO_BINLOG</span>] <span class="nv">TABLE</span> <span class="nv">tb1_name</span>[, <span class="nv">tbl_name</span>]...
以上语句用于分析和存储表的关键字分布，分析的结果将可以使得系统得到准确的统计信息，使得<span class="nv">SQL</span>能够生成正确的执行计划。如果用户感觉实
际执行计 划并不是预期的执行计划，执行一次分析表可能会解决问题。在分析期间，使用一个读取锁定对表进行锁定。这对于<span class="nv">MyISAM</span>，<span class="nv">DBD</span>和
<span class="nv">InnoDB</span>表有作 用。

例如分析一个数据表：<span class="nv">analyze</span> <span class="nv">table</span> <span class="nv">table_name</span>
检查表的语法：<span class="nv">CHECK</span> <span class="nv">TABLE</span> <span class="nv">tb1_name</span>[,<span class="nv">tbl_name</span>]...[<span class="nv">option</span>]...<span class="nv">option</span> <span class="o">=</span> {<span class="nv">QUICK</span> <span class="o">|</span> <span class="nv">FAST</span> <span class="o">|</span> <span class="nv">MEDIUM</span> <span class="o">|</span> <span class="nv">EXTENDED</span> <span class="o">|</span> <span class="nv">CHANGED</span>}
检查表的作用是检查一个或多个表是否有错误，<span class="nv">CHECK</span> <span class="nv">TABLE</span> 对<span class="nv">MyISAM</span> 和 <span class="nv">InnoDB</span>表有作用，对于<span class="nv">MyISAM</span>表，关键字统计数据被更新

<span class="nv">CHECK</span> <span class="nv">TABLE</span> 也可以检查视图是否有错误，比如在视图定义中被引用的表不存在。

<span class="mi">31</span>.定期优化表。

优化表的语法：<span class="nv">OPTIMIZE</span> [<span class="nv">LOCAL</span> <span class="o">|</span> <span class="nv">NO_WRITE_TO_BINLOG</span>] <span class="nv">TABLE</span> <span class="nv">tb1_name</span> [,<span class="nv">tbl_name</span>]...

如果删除了表的一大部分，或者如果已经对含有可变长度行的表<span class="ss">(</span>含有 <span class="nv">VARCHAR</span>、<span class="nv">BLOB</span>或<span class="nv">TEXT</span>列的表<span class="ss">)</span>进行更多更改，则应使用<span class="nv">OPTIMIZE</span> <span class="nv">TABLE</span>
命令来进行表优化。这个命令可以将表中的空间碎片进行合并，并且可以消除由于删除或者更新造成的空间浪费，但<span class="nv">OPTIMIZE</span> <span class="nv">TABLE</span> 命令只对
<span class="nv">MyISAM</span>、 <span class="nv">BDB</span> 和<span class="nv">InnoDB</span>表起作用。

例如： <span class="nv">optimize</span> <span class="nv">table</span> <span class="nv">table_name</span>
注意： <span class="nv">analyze</span>、<span class="nv">check</span>、<span class="nv">optimize</span>执行期间将对表进行锁定，因此一定注意要在<span class="nv">MySQL</span>数据库不繁忙的时候执行相关的操作。<span class="mi">32</span>.存储引擎的
选择如果数据表需要事务处理，应该考虑使用<span class="nv">InnoDB</span>，因为它完全符合<span class="nv">ACID</span>特性。如果不需要事务处理，使用默认存储引擎<span class="nv">MyISAM</span>是比较明智的。


<span class="nv">MyISAM</span>适合于一些需要大量查询的应用，但其对于有大量写操作并不是很好。甚至你只是需要<span class="nv">update</span>一个字段，整个表都会被锁起来，而别的
进程，就算是读进程都
无法操作直到读操作完成。另外，<span class="nv">MyISAM</span> 对于 <span class="nv">SELECT</span> <span class="nv">COUNT</span><span class="ss">(</span><span class="o">*</span><span class="ss">)</span> 这类的计算是超快无比的。 

<span class="nv">InnoDB</span> 的趋势会是一个非常复杂的存储引擎，对于一些小的应用，它会比 <span class="nv">MyISAM</span> 还慢。他是它支持“行锁” ，于是在写操作比较多的时候，
会更优秀。并且，他还支持更多的高级应用，比如：事务。


<span class="mi">33</span>、定期用<span class="nv">explain</span>优化慢查询中的<span class="nv">SQL</span>语句

<span class="mi">34</span>、<span class="nv">EXPLAIN</span> 你的 <span class="nv">SELECT</span> 查询 

使用 <span class="nv">EXPLAIN</span> 关键字可以让你知道<span class="nv">MySQL</span>是如何处理你的<span class="nv">SQL</span>语句的。这可以帮你分析你的查询语句或是表结构的性能瓶颈。 

<span class="nv">EXPLAIN</span> 的查询结果还会告诉你你的索引主键被如何利用的，你的数据表是如何被搜索和排序的……等等，等等。 

挑一个你的<span class="nv">SELECT</span>语句（推荐挑选那个最复杂的，有多表联接的），把关键字<span class="nv">EXPLAIN</span>加到前面。你可以使用<span class="nv">phpmyadmin</span>来做这个事。然后，
你会看到一张表格。下面的这个示例中，我们忘记加上了<span class="nv">group_id</span>索引，并且有表联接：

当我们为 <span class="nv">group_id</span> 字段加上索引后：

我们可以看到，前一个结果显示搜索了 <span class="mi">7883</span> 行，而后一个只是搜索了两个表的 <span class="mi">9</span> 和 <span class="mi">16</span> 行。查看<span class="nv">rows</span>列可以让我们找到潜在的性能问题。 

<span class="mi">35</span>、 当只要一行数据时使用 <span class="nv">LIMIT</span> <span class="mi">1</span> 

当你查询表的有些时候，你已经知道结果只会有一条结果，但因为你可能需要去<span class="nv">fetch</span>游标，或是你也许会去检查返回的记录数。 

在这种情况下，加上 <span class="nv">LIMIT</span> <span class="mi">1</span> 可以增加性能。这样一样，<span class="nv">MySQL</span>数据库引擎会在找到一条数据后停止搜索，而不是继续往后查少下一条符合记录
的数据。 

下面的示例，只是为了找一下是否有“中国”的用户，很明显，后面的会比前面的更有效率。（请注意，第一条中是<span class="nv">Select</span> <span class="o">*</span>，第二条是<span class="nv">Select</span> <span class="mi">1</span>）

复制代码
<span class="o">//</span> 没有效率的：
$<span class="nv">r</span> <span class="o">=</span> <span class="nv">mysql_query</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">SELECT * FROM user WHERE country = &#39;China&#39;</span><span class="s2">&quot;</span><span class="ss">)</span><span class="c1">;</span>
<span class="k">if</span> <span class="ss">(</span><span class="nv">mysql_num_rows</span><span class="ss">(</span>$<span class="nv">r</span><span class="ss">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="ss">)</span> {
<span class="o">//</span> ...}

<span class="o">//</span> 有效率的：
$<span class="nv">r</span> <span class="o">=</span> <span class="nv">mysql_query</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">SELECT 1 FROM user WHERE country = &#39;China&#39; LIMIT 1</span><span class="s2">&quot;</span><span class="ss">)</span><span class="c1">;</span>
<span class="k">if</span> <span class="ss">(</span><span class="nv">mysql_num_rows</span><span class="ss">(</span>$<span class="nv">r</span><span class="ss">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="ss">)</span> {
<span class="o">//</span> ...
}
复制代码


<span class="mi">36</span>. 在<span class="nv">Join</span>表的时候使用相同类型的列，并将其索引 

如果你的应用程序有很多 <span class="nv">JOIN</span> 查询，你应该确认两个表中<span class="nv">Join</span>的字段是被建过索引的。这样，<span class="nv">MySQL</span>内部会启动为你优化<span class="nv">Join</span>的<span class="nv">SQL</span>语句的机制。 

而且，这些被用来<span class="nv">Join</span>的字段，应该是相同的类型的。例如：如果你要把 <span class="nv">DECIMAL</span> 字段和一个 <span class="nv">INT</span> 字段<span class="nv">Join</span>在一起，<span class="nv">MySQL</span>就无法使用它们
的索引。对于那些<span class="nv">STRING</span>类型，还需要有相同的字符集才行。（两个表的字符集有可能不一样）
<span class="o">//</span> 在<span class="nv">state</span>中查找<span class="nv">company</span>
$<span class="nv">r</span> <span class="o">=</span> <span class="nv">mysql_query</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">SELECT company_name FROM users</span>
<span class="nv">LEFT</span> <span class="nv">JOIN</span> <span class="nv">companies</span> <span class="nv">ON</span> <span class="ss">(</span><span class="nv">users</span>.<span class="nv">state</span> <span class="o">=</span> <span class="nv">companies</span>.<span class="nv">state</span><span class="ss">)</span>
<span class="nv">WHERE</span> <span class="nv">users</span>.<span class="nv">id</span> <span class="o">=</span> $<span class="nv">user_id</span><span class="s2">&quot;</span><span class="s">); </span>
两个 <span class="nv">state</span> 字段应该是被建过索引的，而且应该是相当的类型，相同的字符集。

<span class="mi">37</span>、千万不要 <span class="nv">ORDER</span> <span class="nv">BY</span> <span class="nv">RAND</span><span class="ss">()</span> 

想打乱返回的数据行？随机挑一个数据？真不知道谁发明了这种用法，但很多新手很喜欢这样用。但你确不了解这样做有多么可怕的性能问题。 

如 果你真的想把返回的数据行打乱了，你有<span class="nv">N</span>种方法可以达到这个目的。这样使用只让你的数据库的性能呈指数级的下降。这里的问题是：<span class="nv">MySQL</span>
会不得不去执行 <span class="nv">RAND</span><span class="ss">()</span>函数（很耗<span class="nv">CPU</span>时间），而且这是为了每一行记录去记行，然后再对其排序。就算是你用了<span class="nv">Limit</span> <span class="mi">1</span>也无济于事（因为要排序） 

下面的示例是随机挑一条记录


复制代码
<span class="o">//</span> 千万不要这样做：
$<span class="nv">r</span> <span class="o">=</span> <span class="nv">mysql_query</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">SELECT username FROM user ORDER BY RAND() LIMIT 1</span><span class="s2">&quot;</span><span class="ss">)</span><span class="c1">;</span>

<span class="o">//</span> 这要会更好：
$<span class="nv">r</span> <span class="o">=</span> <span class="nv">mysql_query</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">SELECT count(*) FROM user</span><span class="s2">&quot;</span><span class="ss">)</span><span class="c1">;</span>
<span class="mh">$d</span> <span class="o">=</span> <span class="nv">mysql_fetch_row</span><span class="ss">(</span>$<span class="nv">r</span><span class="ss">)</span><span class="c1">;</span>
$<span class="nv">rand</span> <span class="o">=</span> <span class="nv">mt_rand</span><span class="ss">(</span><span class="mi">0</span>,<span class="mh">$d</span>[<span class="mi">0</span>] <span class="o">-</span> <span class="mi">1</span><span class="ss">)</span><span class="c1">;</span>
$<span class="nv">r</span> <span class="o">=</span> <span class="nv">mysql_query</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">SELECT username FROM user LIMIT $rand, 1</span><span class="s2">&quot;</span><span class="ss">)</span><span class="c1">;</span>
复制代码

<span class="mi">38</span>. 永远为每张表设置一个<span class="nv">ID</span> 

我们应该为数据库里的每张表都设置一个<span class="nv">ID</span>做为其主键，而且最好的是一个<span class="nv">INT</span>型的（推荐使用<span class="nv">UNSIGNED</span>），并设置上自动增加的 
<span class="nv">AUTO_INCREMENT</span>标志。 

就算是你 <span class="nv">users</span> 表有一个主键叫 “<span class="nv">email</span>”的字段，你也别让它成为主键。使用 <span class="nv">VARCHAR</span> 类型来当主键会使用得性能下降。另外，在你
的程序中，你应该使用表的<span class="nv">ID</span>来构造你的数据结构。 

而且，在<span class="nv">MySQL</span>数据引擎下，还有一些操作需要使用主键，在这些情况下，主键的性能和设置变得非常重要，比如，集群，分区…… 

在 这里，只有一个情况是例外，那就是“关联表”的“外键”，也就是说，这个表的主键，通过若干个别的表的主键构成。我们把这个情况
叫做“外键”。比如：有一 个“学生表”有学生的<span class="nv">ID</span>，有一个“课程表”有课程<span class="nv">ID</span>，那么，“成绩表”就是“关联表”了，其关联了学生表和
课程表，在成绩表中，学生<span class="nv">ID</span>和课程<span class="nv">ID</span>叫 “外键”其共同组成主键。



<span class="mi">39</span>. 从 <span class="nv">PROCEDURE</span> <span class="nv">ANALYSE</span><span class="ss">()</span> 取得建议 

<span class="nv">PROCEDURE</span> <span class="nv">ANALYSE</span><span class="ss">()</span> 会让 <span class="nv">MySQL</span> 帮你去分析你的字段和其实际的数据，并会给你一些有用的建议。只有表中有实际的数据，这些
建议才会变得有用，因为要做一些大的决定是需要有数据作为基础的。 

例 如，如果你创建了一个 <span class="nv">INT</span> 字段作为你的主键，然而并没有太多的数据，那么，<span class="nv">PROCEDURE</span> <span class="nv">ANALYSE</span><span class="ss">()</span>会建议你把这个字段的类型
改成 <span class="nv">MEDIUMINT</span> 。或是你使用了一个 <span class="nv">VARCHAR</span> 字段，因为数据不多，你可能会得到一个让你把它改成 <span class="nv">ENUM</span> 的建议。这些建议，都
是可能因为数据不够多，所以决策做得就不够准。 

在<span class="nv">phpmyadmin</span>里，你可以在查看表时，点击 “<span class="nv">Propose</span> <span class="nv">table</span> <span class="nv">structure</span>” 来查看这些建议

一定要注意，这些只是建议，只有当你的表里的数据越来越多时，这些建议才会变得准确。一定要记住，你才是最终做决定的人。



<span class="mi">40</span>. 字段尽可能的使用 <span class="nv">NOT</span> <span class="nv">NULL</span>约束 
       除非你有一个很特别的原因去使用 <span class="nv">NULL</span> 值，你应该总是让你的字段保持 <span class="nv">NOT</span> <span class="nv">NULL</span>。这看起来好像有点争议，请往下看。 

首先，问问你自己“<span class="nv">Empty</span>”和“<span class="nv">NULL</span>”有多大的区别（如果是<span class="nv">INT</span>，那就是<span class="mi">0</span>和<span class="nv">NULL</span>）？如果你觉得它们之间没有什么区别，那么你就不要
使用<span class="nv">NULL</span>。（你知道吗？在 <span class="nv">Oracle</span> 里，<span class="nv">NULL</span> 和 <span class="nv">Empty</span> 的字符串是一样的！<span class="ss">)</span> 

不要以为 <span class="nv">NULL</span> 不需要空间，其需要额外的空间，并且，在你进行比较的时候，你的程序会更复杂。 当然，这里并不是说你就不能使
用<span class="nv">NULL</span>了，现实情况是很复杂的，依然会有些情况下，你需要使用<span class="nv">NULL</span>值。 

下面摘自<span class="nv">MySQL</span>自己的文档： 

“<span class="nv">NULL</span> <span class="nv">columns</span> <span class="nv">require</span> <span class="nv">additional</span> <span class="nv">space</span> <span class="nv">in</span> <span class="nv">the</span> <span class="nv">row</span> <span class="nv">to</span> <span class="nv">record</span> <span class="nv">whether</span> <span class="nv">their</span> <span class="nv">values</span> <span class="nv">are</span> <span class="nv">NULL</span>. <span class="k">For</span> <span class="nv">MyISAM</span> <span class="nv">tables</span>,
 <span class="nv">each</span> <span class="nv">NULL</span> <span class="nv">column</span> <span class="nv">takes</span> <span class="nv">one</span> <span class="nv">bit</span> <span class="nv">extra</span>, <span class="nv">rounded</span> <span class="nv">up</span> <span class="nv">to</span> <span class="nv">the</span> <span class="nv">nearest</span> <span class="nv">byte</span>.” 
如果你要保存 <span class="nv">NULL</span>,手动去设置它，而不是把它设为默认值。 建议用用<span class="mi">0</span>、特殊值或空串代替<span class="nv">NULL</span>值


<span class="mi">41</span>. <span class="nv">Prepared</span> <span class="nv">Statements</span> 
<span class="nv">Prepared</span> <span class="nv">Statements</span>很像存储过程，是一种运行在后台的<span class="nv">SQL</span>语句集合，我们可以从使用 <span class="nv">prepared</span> <span class="nv">statements</span> 获得很多好处，无论
是性能问题还是安全问题。 

<span class="nv">Prepared</span> <span class="nv">Statements</span> 可以检查一些你绑定好的变量，这样可以保护你的程序不会受到“<span class="nv">SQL</span>注入式”攻击。当然，你也可以手动地检查你
的这些变量，然而，手动的检查容易出问题， 而且很经常会被程序员忘了。当我们使用一些<span class="nv">framework</span>或是<span class="nv">ORM</span>的时候，这样的问题会好一些。 

在性能方面，当一个相同的查询被使用多次的时候，这会为你带来可观的性能优势。你可以给这些<span class="nv">Prepared</span> <span class="nv">Statements</span>定义一些参数，
而<span class="nv">MySQL</span>只会解析一次。 

虽然最新版本的<span class="nv">MySQL</span>在传输<span class="nv">Prepared</span> <span class="nv">Statements</span>是使用二进制形势，所以这会使得网络传输非常有效率。 

当然，也有一些情况下，我们需要避免使用<span class="nv">Prepared</span> <span class="nv">Statements</span>，因为其不支持查询缓存。但据说版本<span class="mi">5</span>.<span class="mi">1</span>后支持了。 

<span class="mi">42</span>. 把<span class="nv">IP</span>地址存成 <span class="nv">UNSIGNED</span> <span class="nv">INT</span> 
很 多程序员都会创建一个 <span class="nv">VARCHAR</span><span class="ss">(</span><span class="mi">15</span><span class="ss">)</span> 字段来存放字符串形式的<span class="nv">IP</span>而不是整形的<span class="nv">IP</span>。如果你用整形来存放，只需要<span class="mi">4</span>个字节，并且你可
以有定长的字段。而且，这会为你带来查询上的优势，尤其是当 你需要使用这样的<span class="nv">WHERE</span>条件：<span class="nv">IP</span> <span class="nv">between</span> <span class="nv">ip1</span> <span class="nv">and</span> <span class="nv">ip2</span>。 

我们必需要使用<span class="nv">UNSIGNED</span> <span class="nv">INT</span>，因为 <span class="nv">IP</span>地址会使用整个<span class="mi">32</span>位的无符号整形。 

而你的查询，你可以使用 <span class="nv">INET_ATON</span><span class="ss">()</span> 来把一个字符串<span class="nv">IP</span>转成一个整形，并使用 <span class="nv">INET_NTOA</span><span class="ss">()</span> 把一个整形转成一个字符串<span class="nv">IP</span>。在<span class="nv">PHP</span>中，
也有这样的函数 <span class="nv">ip2long</span><span class="ss">()</span> 和 <span class="nv">long2ip</span><span class="ss">()</span>。 
<span class="mi">1</span> $<span class="nv">r</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">UPDATE users SET ip = INET_ATON(&#39;{$_SERVER[&#39;REMOTE_ADDR&#39;]}&#39;) WHERE user_id = $user_id</span><span class="s2">&quot;</span><span class="c1">;</span>

<span class="mi">43</span>. 固定长度的表会更快 
       如 果表中的所有字段都是“固定长度”的，整个表会被认为是 “<span class="nv">static</span>” 或 “<span class="nv">fixed</span><span class="o">-</span><span class="nv">length</span>”。 例如，表中没有如下类型的字段： 
       <span class="nv">VARCHAR</span>，<span class="nv">TEXT</span>，<span class="nv">BLOB</span>。只要你包括了其中一个这些字段，那么这个表就不是“固定长度静态表”了，这样，<span class="nv">MySQL</span> 引擎会用另一种方
       法来处理。 

       固定长度的表会提高性能，因为<span class="nv">MySQL</span>搜寻得会更快一些，因为这些固定的长度是很容易计算下一个数据的偏移量的，所以读取的自然
       也会很快。而如果字段不是定长的，那么，每一次要找下一条的话，需要程序找到主键。 

       并且，固定长度的表也更容易被缓存和重建。不过，唯一的副作用是，固定长度的字段会浪费一些空间，因为定长的字段无论你用
       不用，他都是要分配那么多的空间。 

使用“垂直分割”技术（见下一条），你可以分割你的表成为两个一个是定长的，一个则是不定长的。 
<span class="mi">45</span>. 垂直分割表 
       “垂直分割”是一种把数据库中的表按列变成几张表的方法，这样可以降低表的复杂度和字段的数目，从而达到优化的目的。（以前，
       在银行做过项目，见过一张表有<span class="mi">100</span>多个字段，很恐怖）

       示 例一：在<span class="nv">Users</span>表中有一个字段是家庭地址，这个字段是可选字段，相比起，而且你在数据库操作的时候除了个人信息外，你并不
       需要经常读取或是改写这个字 段。那么，为什么不把他放到另外一张表中呢？ 这样会让你的表有更好的性能，大家想想是不是，大
       量的时候，我对于用户表来说，只有用户<span class="nv">ID</span>，用户名，口令，用户角色等会被经常使用。小一点的表总是会有 好的性能。 

       示例二： 你有一个叫 “<span class="nv">last_login</span>” 的字段，它会在每次用户登录时被更新。但是，每次更新时会导致该表的查询缓存被清空。所
       以，你可以把这个字段放到另一个表中，这样就不会影响你对用户 <span class="nv">ID</span>，用户名，用户角色的不停地读取了，因为查询缓存会帮你增加很
       多性能。 

另外，你需要注意的是，这些被分出去的字段所形成的表，你不会经常性地去<span class="nv">Join</span>他们，不然的话，这样的性能会比不分割时还要差，而且，会
是极数级的下降。

<span class="mi">46</span>. 拆分大的 <span class="nv">DELETE</span> 或 <span class="nv">INSERT</span> 语句 
         如果你需要在一个在线的网站上去执行一个大的 <span class="nv">DELETE</span> 或 <span class="nv">INSERT</span> 查询，你需要非常小心，要避免你的操作让你的整个网站停止相
         应。因为这两个操作是会锁表的，表一锁住了，别的操作都进不来了。 

       <span class="nv">Apache</span> 会有很多的子进程或线程。所以，其工作起来相当有效率，而我们的服务器也不希望有太多的子进程，线程和数据库链接，这是
       极大的占服务器资源的事情，尤其是内存。 

       如果你把你的表锁上一段时间，比如<span class="mi">30</span>秒钟，那么对于一个有很高访问量的站点来说，这<span class="mi">30</span>秒所积累的访问进程<span class="o">/</span>线程，数据库链接，打开
       的文件数，可能不仅仅会让你泊<span class="nv">WEB</span>服务<span class="nv">Crash</span>，还可能会让你的整台服务器马上掛了。 

所以，如果你有一个大的处理，你定你一定把其拆分，使用 <span class="nv">LIMIT</span> 条件是一个好的方法。下面是一个示例：


复制代码
<span class="k">while</span> <span class="ss">(</span><span class="mi">1</span><span class="ss">)</span> {
<span class="o">//</span>每次只做<span class="mi">1000</span>条
<span class="nv">mysql_query</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">DELETE FROM logs WHERE log_date &lt;= &#39;2009-11-01&#39; LIMIT 1000</span><span class="s2">&quot;</span><span class="ss">)</span><span class="c1">;</span>
<span class="k">if</span> <span class="ss">(</span><span class="nv">mysql_affected_rows</span><span class="ss">()</span> <span class="o">==</span> <span class="mi">0</span><span class="ss">)</span> {
<span class="o">//</span> 没得可删了，退出！<span class="k">break</span><span class="c1">;</span>
}
<span class="o">//</span> 每次都要休息一会儿
<span class="nv">usleep</span><span class="ss">(</span><span class="mi">50000</span><span class="ss">)</span><span class="c1">;</span>
}
复制代码

<span class="mi">47</span>. 越小的列会越快 
对于大多数的数据库引擎来说，硬盘操作可能是最重大的瓶颈。所以，把你的数据变得紧凑会对这种情况非常有帮助，因为这减少了对硬盘的访问。 

参看 <span class="nv">MySQL</span> 的文档 <span class="nv">Storage</span> <span class="nv">Requirements</span> 查看所有的数据类型。 

如果一个表只会有几列罢了（比如说字典表，配置表），那么，我们就没有理由使用 <span class="nv">INT</span> 来做主键，使用 <span class="nv">MEDIUMINT</span>, <span class="nv">SMALLINT</span> 或是更小的 
<span class="nv">TINYINT</span> 会更经济一些。如果你不需要记录时间，使用 <span class="nv">DATE</span> 要比 <span class="nv">DATETIME</span> 好得多。 

当然，你也需要留够足够的扩展空间，不然，你日后来干这个事，你会死的很难看，参看<span class="nv">Slashdot</span>的例子（<span class="mi">2009</span>年<span class="mi">11</span>月<span class="mi">06</span> 日），一个简单的
<span class="nv">ALTER</span> <span class="nv">TABLE</span>语句花了<span class="mi">3</span>个多小时，因为里面有一千六百万条数据。 


<span class="mi">48</span>. 使用一个对象关系映射器（<span class="nv">Object</span> <span class="nv">Relational</span> <span class="nv">Mapper</span>） 
    使用 <span class="nv">ORM</span> <span class="ss">(</span><span class="nv">Object</span> <span class="nv">Relational</span> <span class="nv">Mapper</span><span class="ss">)</span>，你能够获得可靠的性能增涨。一个<span class="nv">ORM</span>可以做的所有事情，也能被手动的编写出来。但是，这需
    要一个高级专家。 

<span class="nv">ORM</span> 的最重要的是“<span class="nv">Lazy</span> <span class="nv">Loading</span>”，也就是说，只有在需要的去取值的时候才会去真正的去做。但你也需要小心这种机制的副作用，因为这很有可
能会因为要去创建很多很多小的查 询反而会降低性能。 <span class="nv">ORM</span> 还可以把你的<span class="nv">SQL</span>语句打包成一个事务，这会比单独执行他们快得多得多。 

<span class="mi">49</span>. 小心“永久链接” 
“永 久链接”的目的是用来减少重新创建<span class="nv">MySQL</span>链接的次数。当一个链接被创建了，它会永远处在连接的状态，就算是数据库操作已经结束了。而且，
自从我们的 <span class="nv">Apache</span>开始重用它的子进程后——也就是说，下一次的<span class="nv">HTTP</span>请求会重用<span class="nv">Apache</span>的子进程，并重用相同的 <span class="nv">MySQL</span> 链接。 


<span class="mi">50</span>、范围列<span class="ss">(</span><span class="o">&gt;</span>,<span class="o">&lt;</span>,<span class="nv">between</span> <span class="nv">and</span><span class="ss">)</span>可以用到索引，但是范围列后面的列无法用到索引。同时，索引最多用于一个范围列，因此如果查询条件中有两个范
围列则无法全用到索引

<span class="mi">51</span>、如果需要在大字段上建立索引，可以考虑使用前缀索引。

建立前缀索引的语法为：

<span class="nv">ALTER</span> <span class="nv">TABLE</span> <span class="nv">table_name</span> <span class="nv">ADD</span> <span class="nv">KEY</span><span class="ss">(</span><span class="nv">column_name</span><span class="ss">(</span><span class="nv">prefix_length</span><span class="ss">))</span><span class="c1">;</span>
 <span class="mi">52</span>、 将大字段、访问频率低的字段拆分到单独的表中存储，分离冷热数据，有利于有效利用缓存，防止读入无用的冷数据，较少磁盘<span class="nv">IO</span>,同时保证热
 数据常驻内存提高缓存命中率。

<span class="mi">53</span>、 <span class="nv">MYSQL</span>的新增和修改列的操作相当于重建表，表设计要一步到位，尽量避免大表的<span class="nv">DDL</span>操作。 （<span class="nv">TIPS</span>:可以预定义一些列留作将来业务扩展，
如：当前只需要<span class="mi">10</span>个字段，考虑到未来发展，可以预留<span class="mi">10</span>个字段，表上总共创建<span class="mi">20</span>个字段）

<span class="mi">54</span>、为了降低索引维护成本，禁止冗余索引，增大<span class="nv">IO</span>压力。（<span class="nv">a</span>,<span class="nv">b</span>,<span class="nv">c</span>）、（<span class="nv">a</span>,<span class="nv">b</span>），后者为冗余索引。可以利用前缀索引来达到加速目的，减轻维护
负担。

<span class="mi">55</span>、<span class="nv">WHERE</span>子句中的数据扫描不超过表总数据量的<span class="mi">30</span><span class="o">%</span>

如何选择<span class="nv">prefix_length</span>的长度，具体参考：前缀索引，一种优化索引大小的解决方案



补充：

》、在海量查询时尽量少用格式转换。

》、任何对列的操作都将导致表扫描，它包括数据库教程函数、计算表达式等等，查询时要尽可能将操作移 至等号右边。

》、<span class="nv">IN</span>、<span class="nv">OR</span> 子句常会使用工作表，使索引失效。如果不产生大量重复值，可以考虑把子句拆开。拆开的子 句中应该包含索引。

》、尽量少用 <span class="nv">CLOB</span>、<span class="nv">TEXT</span>、<span class="nv">BLOB</span>大类型

》、如果你的数据只有你所知的少量的几个。最好使用 <span class="nv">ENUM</span> 类型

<span class="nv">ENUM</span> 类型是非常快和紧凑的。在实际上，其保存的是 <span class="nv">TINYINT</span>，但其外表上显示为字符串。这样一来，用这个字段来做一些选项列表变得
相当的完美。 
如果你有一个字段，比如“性别”，“国家”，“民族”，“状态”或“部门”，你知道这些字段的取值是有限而且固定的，那么，你应该使用 <span class="nv">ENUM</span> 而
不是 <span class="nv">VARCHAR</span>。 
<span class="nv">MySQL</span>也有一个“建议”（见第十条）告诉你怎么去重新组织你的表结构。当你有一个 <span class="nv">VARCHAR</span> 字段时，这个建议会告诉你把其改成 <span class="nv">ENUM</span> 类型。
使用 <span class="nv">PROCEDURE</span> <span class="nv">ANALYSE</span><span class="ss">()</span> 你可以得到相关的建议。

》、合理用运分库、分表与分区表提高数据存放和提取速度。具体参考：<span class="nv">Mysql</span>分表和分区的区别、分库分表区别




下面是简单版，只是对上面的知识点浓缩，方便记忆：
复制代码
索引：
考虑在 <span class="nv">where</span> 及 <span class="nv">order</span> <span class="nv">by</span> 涉及的列上建立索引
经常同时存取多列，且每列都含有重复值可考虑建立组合索引，且查询越频繁的字段放前面
按需使用聚集与非聚集索引，聚集不适合频繁更新、适合范围查询<span class="ss">(</span> <span class="o">&gt;</span> ,<span class="o">&lt;</span> ,<span class="o">&gt;</span> <span class="o">=</span>,<span class="o">&lt;</span> <span class="o">=</span><span class="ss">)</span>和 <span class="nv">order</span> <span class="nv">by</span>、<span class="nv">group</span> <span class="nv">by</span> ，
注意复合索引的顺序，选择性高的建议放前面
不要在数据选择性不高的字段建立索引
索引控制在<span class="mi">6</span>个以内为好
大字段可以考虑使用前缀索引
去除冗余索引

<span class="nv">where</span>子句的操作：
尽量避免在 <span class="nv">where</span> 子句中对字段进行 <span class="nv">null</span> 值判断、<span class="o">!=</span>或<span class="o">&lt;&gt;</span>操作符、 <span class="nv">or</span> 来连接条件、<span class="nv">in</span> 和 <span class="nv">not</span> <span class="nv">in</span>、<span class="nv">like</span>时<span class="o">%</span>在前面、使用参数，如
<span class="nv">where</span> <span class="nv">num</span><span class="o">=</span>@<span class="nv">num</span>、
表达式操作，如<span class="nv">where</span> <span class="nv">num</span><span class="o">/</span><span class="mi">2</span><span class="o">=</span><span class="mi">100</span>、函数操作<span class="ss">(</span>“<span class="o">=</span>”左边进行函数<span class="ss">)</span>，如<span class="nv">substring</span><span class="ss">(</span><span class="nv">name</span>,<span class="mi">1</span>,<span class="mi">3</span><span class="ss">)</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">abc</span><span class="s1">&#39;</span><span class="c1">;#name、算术运算或其他表达式运算</span>
<span class="nv">exists</span> 代替 <span class="nv">in</span>
一个查询中避免多个范围查询
<span class="nv">WHERE</span>子句中的数据扫描不超过表总数据量的<span class="mi">30</span><span class="o">%</span>

表结构：
能用数字和枚举类型就不用其他类型
使用 <span class="nv">varchar</span><span class="o">/</span><span class="nv">nvarchar</span> 代替 <span class="nv">char</span><span class="o">/</span><span class="nv">nchar</span> 
字段尽可能的使用 <span class="nv">NOT</span> <span class="nv">NULL</span>
把<span class="nv">IP</span>地址存成 <span class="nv">UNSIGNED</span> <span class="nv">INT</span>
固定长度的表会更快
越小的列会越快


临时表：
可用变量就不要用临时表
避免频繁创建和删除临时表
需要重复引用大型表或常用 表中的某个数据集时可用临时表
新建临时表时，如果一次性插入数据量很大，用 <span class="nv">select</span> <span class="nv">into</span> 代替 <span class="nv">create</span> <span class="nv">table</span>
注意删除临时表，先 <span class="nv">truncate</span> <span class="nv">table</span> ,然后 <span class="nv">drop</span> <span class="nv">table</span>

其他：
不使用<span class="nv">select</span> <span class="o">*</span>
大量数据时不适合用游标处理
在所有的存储过程和触发器的开始处设置 <span class="nv">SET</span> <span class="nv">NOCOUNT</span> <span class="nv">ON</span> ,在结束时设置 <span class="nv">SET</span> <span class="nv">NOCOUNT</span> <span class="nv">OFF</span>
定期<span class="nv">ANALYZE</span>、<span class="nv">CHECK</span> 、<span class="nv">OPTIMIZE</span> 表
<span class="nv">EXPLAIN</span> 你的 <span class="nv">SELECT</span> 查询
善用<span class="nv">LIMIT</span> 避免一次性查询大量数据
在<span class="nv">Join</span>表的时候使用相同类型的列，并将其索引
千万不要 <span class="nv">ORDER</span> <span class="nv">BY</span> <span class="nv">RAND</span><span class="ss">()</span>
除了关联表 永远为每张表设置一个<span class="nv">ID</span>
<span class="nv">Prepared</span> <span class="nv">Statements</span>
小心“永久链接”
尽量避免大事务操作
拆分大的 <span class="nv">DELETE</span> 或 <span class="nv">INSERT</span> 或 <span class="nv">insert</span> .. <span class="nv">into</span> .. <span class="nv">select</span>.. 语句 减少锁表时间
使用<span class="nv">orm</span>
使用缓存，例如一级缓存，二级缓存、<span class="nv">redis</span>、<span class="nv">memcace</span>分布式
合理用运分库、分表与分区表提高数据存放和提取速度
复制代码


附：

<span class="nv">mysql</span> 慢查询查看方案

  <span class="nv">truncate</span> <span class="nv">table</span>  <span class="nv">mysql</span>.<span class="nv">slow_log</span><span class="c1">;</span>

<span class="nv">select</span> <span class="nv">db</span>, <span class="nv">query_TIME</span>, <span class="nv">lock_time</span>, <span class="nv">rows_examined</span>, <span class="nv">sql_text</span> <span class="nv">from</span> <span class="nv">mysql</span>.<span class="nv">slow_log</span>

来源： <span class="nv">http</span>:<span class="o">//</span><span class="nv">blog</span>.<span class="nv">csdn</span>.<span class="nv">net</span><span class="o">/</span><span class="nv">xyw591238</span><span class="o">/</span><span class="nv">article</span><span class="o">/</span><span class="nv">details</span><span class="o">/</span><span class="mi">51965389</span>
</pre></div>


<h2 id="56">5.6明文密码问题</h2>
<div class="codehilite"><pre><span></span><span class="nv">mysql</span> <span class="o">-</span><span class="nv">uroot</span> <span class="o">-</span><span class="nv">pxxx</span> <span class="o">-</span><span class="nv">e</span> <span class="s2">&quot;</span><span class="s">show slave status\G</span><span class="s2">&quot;</span>  会提示   <span class="nv">Warning</span>: <span class="nv">Using</span> <span class="nv">a</span> <span class="nv">password</span> <span class="nv">on</span> <span class="nv">the</span> <span class="nv">command</span> <span class="nv">line</span> <span class="nv">interface</span> 
<span class="nv">can</span> <span class="nv">be</span> <span class="nv">insecure</span>.

<span class="mi">5</span>.<span class="mi">6</span>以上版本才有<span class="nv">mysql_config_editor</span>

创建一个<span class="nv">login</span><span class="o">-</span><span class="nv">path</span>
<span class="nv">mysql_config_editor</span> <span class="nv">set</span> <span class="o">--</span><span class="nv">login</span><span class="o">-</span><span class="nv">path</span><span class="o">=</span><span class="nv">test</span> <span class="o">--</span><span class="nv">user</span><span class="o">=</span><span class="nv">root</span> <span class="o">--</span><span class="nv">password</span> <span class="o">--</span><span class="nv">host</span><span class="o">=</span><span class="nv">localhost</span>
<span class="nv">Enter</span> <span class="nv">password</span>:

创建好后，.<span class="nv">mylogin</span>.<span class="nv">cnf</span>将保存在用户的家目录下，该文件是不可读的，它类似于选项组，包含单个身份的验证信息

<span class="nv">mysql</span> <span class="o">--</span><span class="nv">login</span><span class="o">-</span><span class="nv">path</span><span class="o">=</span><span class="nv">test</span>  直接登陆
<span class="nv">mysql</span> <span class="o">--</span><span class="nv">login</span><span class="o">-</span><span class="nv">path</span><span class="o">=</span><span class="nv">test</span> <span class="o">-</span><span class="nv">e</span> <span class="s2">&quot;</span><span class="s">show slave status\G</span><span class="s2">&quot;</span>  也没有错误提示

查看.<span class="nv">mylogin</span>.<span class="nv">cnf</span>里写了什么
<span class="nv">mysql_config_editor</span> <span class="nv">print</span> <span class="o">--</span><span class="nv">all</span>
<span class="nv">mysql_config_editor</span> <span class="nv">print</span> <span class="o">--</span><span class="nv">login</span><span class="o">-</span><span class="nv">path</span><span class="o">=</span><span class="nv">test</span>

删除.<span class="nv">mylogin</span>.<span class="nv">cnf</span>，则可以使用
<span class="nv">mysql_config_editor</span> <span class="nv">remove</span> <span class="o">--</span><span class="nv">login</span><span class="o">-</span><span class="nv">path</span><span class="o">=</span><span class="nv">test</span>
</pre></div>


<h2 id="_9">备份</h2>
<div class="codehilite"><pre><span></span><span class="err">备份函数和触发器</span>
<span class="n">mysqldump</span> <span class="o">--</span><span class="n">master</span><span class="o">-</span><span class="n">data</span><span class="o">=</span><span class="mi">2</span> <span class="o">--</span><span class="n">single</span><span class="o">-</span><span class="n">transaction</span> <span class="o">-</span><span class="n">R</span> <span class="o">--</span><span class="n">triggers</span> <span class="o">-</span><span class="n">A</span> <span class="o">&gt;</span> <span class="n">all</span><span class="p">.</span><span class="n">sql</span>
<span class="err">其中</span><span class="o">--</span><span class="n">master</span><span class="o">-</span><span class="n">data</span><span class="o">=</span><span class="mi">2</span><span class="err">代表备份时刻记录</span><span class="n">master</span><span class="err">的</span><span class="n">Binlog</span><span class="err">位置和</span><span class="n">Position</span><span class="err">，</span><span class="o">--</span><span class="n">single</span><span class="o">-</span><span class="n">transaction</span><span class="err">意思是获取一致性快照，</span>
<span class="o">-</span><span class="n">R</span><span class="err">意思是备份存储过程和函数，</span><span class="o">--</span><span class="n">triggres</span><span class="err">的意思是备份触发器，</span><span class="o">-</span><span class="n">A</span><span class="err">代表备份所有的库</span>

<span class="err">查看主库备份时的</span><span class="n">binlog</span><span class="err">名称和位置，</span><span class="n">MASTER_LOG_FILE</span><span class="err">和</span><span class="n">MASTER_LOG_POS</span><span class="err">：</span>
<span class="n">head</span> <span class="o">-</span><span class="n">n</span> <span class="mi">30</span> <span class="n">all</span><span class="p">.</span><span class="n">sql</span> <span class="o">|</span> <span class="n">grep</span> <span class="err">&#39;</span><span class="n">CHANGE</span> <span class="n">MASTER</span> <span class="n">TO</span><span class="err">&#39;</span>
<span class="o">--</span> <span class="n">CHANGE</span> <span class="n">MASTER</span> <span class="n">TO</span> <span class="n">MASTER_LOG_FILE</span><span class="o">=</span><span class="err">&#39;</span><span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000010</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">MASTER_LOG_POS</span><span class="o">=</span><span class="mi">112</span><span class="p">;</span>

<span class="n">mysql</span> <span class="o">&lt;</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">all</span><span class="p">.</span><span class="n">sql</span>

<span class="o">============================================</span>
<span class="err">备份分为冷备和热备</span>

<span class="err">冷备份</span>
<span class="err">因为</span><span class="n">mysql</span><span class="err">中库即目录（</span><span class="n">database</span> <span class="n">is</span> <span class="n">folder</span><span class="err">）所以冷备份其实就是备份整个目录。</span>
<span class="err">停掉</span><span class="n">mysql</span><span class="err">服务，直接将当前目录（</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span><span class="err">）下的东西都拷贝到其他地方就行，恢复的时候直接拷回来就行了，并且将所</span>
<span class="err">有者和组都改为</span><span class="n">musql</span><span class="err">。备份还原都需要需要停止服务</span>
<span class="n">myisam</span> <span class="n">engine</span> <span class="err">的将目录直接拷贝（三个文件</span>  <span class="n">xt701</span><span class="p">.</span><span class="n">frm</span><span class="err">记录表结构</span> <span class="n">xt701</span><span class="p">.</span><span class="n">myd</span> <span class="err">存放数据</span>  <span class="n">xt701</span><span class="p">.</span><span class="n">myi</span> <span class="err">存放索引）</span>
<span class="n">innodb</span> <span class="n">engine</span><span class="err">的需要将</span><span class="n">innodb</span><span class="err">及相关日志文件考走，不考日志恢复的时候起不来服务</span>

<span class="err">热备份</span>
<span class="n">mysql</span><span class="err">自带</span><span class="n">mysqldump</span> <span class="n">command</span>
<span class="err">备份</span><span class="n">mysqldump</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="o">-</span><span class="n">p</span> <span class="n">xxxx</span> <span class="n">xt701</span> <span class="o">&gt;</span> <span class="n">xt701</span><span class="p">.</span><span class="n">bak</span><span class="p">.</span><span class="n">sql</span>  <span class="err">这里的</span><span class="n">xt701</span><span class="err">是库名</span>

<span class="err">还原</span>
<span class="err">先去数据库建立同名库</span> <span class="n">xt701</span>
<span class="n">mysql</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="o">-</span><span class="n">p</span> <span class="n">xxx</span> <span class="o">&lt;</span> <span class="n">xt701</span><span class="p">.</span><span class="n">bak</span><span class="p">.</span><span class="n">sql</span>

<span class="err">第三方软件</span>
<span class="n">mydumper</span> <span class="n">soft</span>

<span class="n">mysqldump</span>

<span class="nl">Usage</span><span class="p">:</span> <span class="n">mysqldump</span> <span class="p">[</span><span class="n">OPTIONS</span><span class="p">]</span> <span class="n">database</span> <span class="p">[</span><span class="n">tables</span><span class="p">]</span>
<span class="n">OR</span>     <span class="n">mysqldump</span> <span class="p">[</span><span class="n">OPTIONS</span><span class="p">]</span> <span class="o">--</span><span class="n">databases</span> <span class="p">[</span><span class="n">OPTIONS</span><span class="p">]</span> <span class="n">DB1</span> <span class="p">[</span><span class="n">DB2</span> <span class="n">DB3</span><span class="p">...]</span>
<span class="n">OR</span>     <span class="n">mysqldump</span> <span class="p">[</span><span class="n">OPTIONS</span><span class="p">]</span> <span class="o">--</span><span class="n">all</span><span class="o">-</span><span class="n">databases</span> <span class="p">[</span><span class="n">OPTIONS</span><span class="p">]</span>

<span class="err">全备</span>
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">convirt</span> <span class="n">tmp</span><span class="p">]</span><span class="err">#</span> <span class="n">mysqldump</span> <span class="o">-</span><span class="n">A</span> <span class="o">-</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">quanbei</span><span class="p">.</span><span class="n">sql</span>

<span class="err">备份某个库</span>
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">convirt</span> <span class="n">tmp</span><span class="p">]</span><span class="err">#</span> <span class="n">mysqldump</span> <span class="n">vfast</span> <span class="o">&gt;</span> <span class="n">vvv</span><span class="p">.</span><span class="n">sql</span>
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">convirt</span> <span class="n">tmp</span><span class="p">]</span><span class="err">#</span> <span class="n">mysqldump</span> <span class="o">--</span><span class="n">databases</span> <span class="n">vfast</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="mf">5.</span><span class="n">sql</span>

<span class="err">备份单表</span>  <span class="n">vfast</span><span class="err">库的</span><span class="n">T6</span><span class="err">表</span>
<span class="n">mysqldump</span> <span class="o">-</span><span class="n">x</span> <span class="n">vfast</span> <span class="n">T6</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">t6</span><span class="p">.</span><span class="n">sql</span>

<span class="n">vfast</span><span class="err">库名</span>
<span class="err">恢复单个库</span>
<span class="mi">1</span><span class="err">）先去建库</span>
<span class="mi">2</span><span class="err">）导入备份文件</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">create</span> <span class="n">database</span> <span class="n">vfast</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">exit</span>
<span class="n">Bye</span>
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">convirt</span> <span class="n">tmp</span><span class="p">]</span><span class="err">#</span> <span class="n">mysql</span> <span class="n">vfast</span> <span class="o">&lt;</span> <span class="n">vvv</span><span class="p">.</span><span class="n">sql</span>
<span class="cp">#同时备份多个库  vfast  and test</span>
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">instructor</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">mysqldump</span> <span class="o">--</span><span class="n">database</span> <span class="n">vfast</span> <span class="n">test</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">backup</span><span class="o">/</span><span class="n">vfast_no2</span><span class="p">.</span><span class="n">sql</span>

<span class="err">增量备份单表</span> 

<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">convirt</span> <span class="n">tmp</span><span class="p">]</span><span class="err">#</span>   <span class="n">mysqldump</span> <span class="o">--</span><span class="n">lock</span><span class="o">-</span><span class="n">tables</span> <span class="o">--</span><span class="n">flush</span><span class="o">-</span><span class="n">logs</span> <span class="o">--</span><span class="n">master</span><span class="o">-</span><span class="n">data</span><span class="o">=</span><span class="mi">1</span> <span class="n">vfast</span> <span class="n">test</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="mf">1.</span><span class="n">sql</span>
<span class="n">or</span>
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">convirt</span> <span class="n">tmp</span><span class="p">]</span><span class="err">#</span>  <span class="n">mysqldump</span> <span class="o">--</span><span class="n">lock</span><span class="o">-</span><span class="n">tables</span> <span class="o">--</span><span class="n">flush</span><span class="o">-</span><span class="n">logs</span> <span class="o">--</span><span class="n">master</span><span class="o">-</span><span class="n">data</span><span class="o">=</span><span class="mi">2</span> <span class="n">vfast</span> <span class="n">test</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="mf">3.</span><span class="n">sql</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">flush</span> <span class="n">logs</span><span class="p">;</span> <span class="err">结束当前</span><span class="n">binlog</span><span class="err">开启新</span><span class="n">binlog</span>

<span class="err">导出单个数据表结构和数据</span>
<span class="n">mysqldump</span> <span class="o">-</span><span class="n">h</span> <span class="n">localhost</span> <span class="o">-</span><span class="n">uroot</span> <span class="o">-</span><span class="n">p123456</span>  <span class="n">database</span> <span class="n">table</span> <span class="o">&gt;</span> <span class="n">dump</span><span class="p">.</span><span class="n">sql</span>
<span class="n">mysqldump</span> <span class="n">test</span> <span class="n">H1</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="n">sql</span>  <span class="err">到处</span><span class="n">test</span><span class="err">库</span><span class="n">H1</span><span class="err">表数据</span>

<span class="err">备份表结构</span>
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">convirt</span> <span class="n">tmp</span><span class="p">]</span><span class="err">#</span> <span class="n">mysqldump</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">data</span> <span class="o">--</span><span class="n">databases</span> <span class="n">vfast</span> <span class="o">&gt;</span> <span class="n">bb</span><span class="p">.</span><span class="n">sql</span>

<span class="err">恢复</span>

<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">convirt</span> <span class="n">tmp</span><span class="p">]</span><span class="err">#</span> <span class="n">mysql</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="o">-</span><span class="n">p</span> <span class="p">[</span><span class="n">database</span> <span class="n">name</span><span class="p">]</span>  <span class="o">&lt;</span> <span class="p">[</span><span class="n">backup</span> <span class="n">file</span> <span class="n">name</span><span class="p">]</span>


<span class="err">基于日志备份</span>
<span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span>
<span class="n">log</span><span class="o">-</span><span class="n">bin</span><span class="o">=</span><span class="n">binlog</span>  <span class="err">启用二进制日志</span>
<span class="n">log</span><span class="o">-</span><span class="n">bin</span><span class="o">-</span><span class="n">index</span><span class="o">=</span><span class="n">binlog</span><span class="p">.</span><span class="n">index</span>  <span class="err">建立二进制日志索引</span>
<span class="n">sync</span><span class="o">-</span><span class="n">binlog</span><span class="o">=</span><span class="mi">1</span> <span class="p">(</span><span class="mi">1</span><span class="err">代表立刻写到磁盘，</span><span class="mi">0</span><span class="err">代表先在内存后写到磁盘</span><span class="p">)</span>

<span class="n">expire_logs_days</span><span class="o">=</span><span class="mi">10</span>  <span class="n">binlog</span><span class="err">　日志文件</span><span class="mi">10</span><span class="err">天过期</span>
<span class="n">max_binlog_size</span><span class="o">=</span><span class="mi">2</span><span class="n">G</span> <span class="err">指定</span><span class="n">binlog</span><span class="err">大小</span>
<span class="n">binlog_do_db</span> <span class="o">=</span> <span class="err">库名</span>  <span class="err">指定只记录那个库的</span><span class="n">binlog</span>

<span class="err">如何删除</span><span class="n">binlog</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">master</span> <span class="n">logs</span><span class="p">;</span> <span class="err">显示本机</span><span class="n">binlog</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">purge</span> <span class="n">binary</span> <span class="n">logs</span> <span class="n">to</span> <span class="err">&#39;</span><span class="n">binlog</span><span class="mf">.000004</span><span class="err">&#39;</span><span class="p">;</span> <span class="err">删除前</span><span class="mi">3</span><span class="err">个</span>

<span class="err">二进制日志</span> <span class="err">备份与恢复</span>

<span class="err">参考日志</span><span class="nl">http</span><span class="p">:</span><span class="c1">//www.jb51.net/article/45023.htm</span>
<span class="err">定义条件截断</span><span class="n">binlog</span><span class="err">日志</span>
<span class="err">例如恢复到</span><span class="n">binlog</span><span class="mf">.000003</span>
<span class="n">mysqlbinlog</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">binlog</span><span class="mf">.000003</span> <span class="o">|</span><span class="n">mysql</span>
<span class="err">将</span><span class="n">binlog</span> <span class="err">日志导出成</span><span class="n">sql</span><span class="err">语句</span>
<span class="n">mysqlbinlog</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">binlog</span><span class="mf">.000007</span> <span class="o">&gt;</span> <span class="mf">7.</span><span class="n">sql</span>

<span class="err">同时导入多个</span><span class="n">binlog</span><span class="err">二进制日志</span>
<span class="n">mysqlbinlog</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">binlog</span><span class="p">.[</span><span class="mi">0</span><span class="o">-</span><span class="mi">10</span><span class="p">]</span><span class="o">*</span> <span class="o">&gt;</span> <span class="mf">7.</span><span class="n">sql</span>
<span class="o">--</span><span class="n">start</span><span class="o">-</span><span class="n">datatime</span> <span class="err">和</span><span class="o">--</span><span class="n">stop</span><span class="o">-</span><span class="n">datatime</span> <span class="err">选项可以用来指定从二进制日志的某个时间点来进行恢复。</span>
<span class="o">-</span><span class="err">–</span><span class="n">start</span><span class="o">-</span><span class="n">position</span><span class="o">=</span><span class="err">#</span>               <span class="err">指定开始和结束</span><span class="n">position</span>
<span class="o">-</span><span class="err">–</span><span class="n">stop</span><span class="o">-</span><span class="n">position</span><span class="o">=</span><span class="err">#</span> 

<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">convirt</span> <span class="n">mysql</span><span class="p">]</span><span class="err">#</span>  <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">mysqlbinlog</span> <span class="o">--</span><span class="n">start</span><span class="o">-</span><span class="n">position</span><span class="o">=</span><span class="mi">370</span> <span class="o">--</span><span class="n">stop</span><span class="o">-</span><span class="n">position</span><span class="o">=</span><span class="mi">440</span>  
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000002</span>

<span class="o">--</span><span class="n">start</span><span class="o">-</span><span class="n">position</span><span class="o">=</span><span class="mi">370</span> <span class="o">--</span><span class="n">stop</span><span class="o">-</span><span class="n">position</span><span class="o">=</span><span class="mi">440</span> <span class="err">这里面数字从哪儿来的呢？</span>
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">convirt</span> <span class="n">mysql</span><span class="p">]</span><span class="err">#</span>  <span class="n">mysqlbinlog</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">mysqlbinlog</span>

<span class="cp"># at 370</span>
<span class="cp">#100929 21:35:25 server id 1  end_log_pos 440 Query    thread_id=1    exec_time=0    error_code=0</span>
<span class="n">SET</span> <span class="n">TIMESTAMP</span><span class="o">=</span><span class="mi">1285767325</span><span class="cm">/*!*/</span><span class="p">;</span>

<span class="err">从某个时间点开始还原【不需要提前删表】</span>
<span class="n">mysqlbinlog</span> <span class="n">binlog</span><span class="p">.[</span><span class="mi">0</span><span class="o">-</span><span class="mi">10</span><span class="p">]</span><span class="o">*</span> <span class="o">--</span><span class="n">start</span><span class="o">-</span><span class="n">datetime</span><span class="o">=</span><span class="s">&quot;2014-03-02 10:30:00&quot;</span> <span class="o">|</span><span class="n">mysql</span>

<span class="err">导入到某个时间点之前</span> <span class="err">【先删表，后还原】</span>
<span class="n">mysqlbinlog</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">binlog</span><span class="p">.[</span><span class="mi">0</span><span class="o">-</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span> <span class="o">--</span><span class="n">stop</span><span class="o">-</span><span class="n">datetime</span><span class="o">=</span><span class="s">&quot;2014-02-26 11:38:58&quot;</span> <span class="o">|</span><span class="n">mysql</span>
</pre></div>


<h2 id="_10">主从同步</h2>
<div class="codehilite"><pre><span></span><span class="n">mysql</span><span class="err">数据库同步方法</span>

<span class="mi">1</span><span class="err">、主库创建</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span><span class="err">，修改</span>
<span class="err">里边的键值增加</span>
<span class="n">server</span><span class="o">-</span><span class="kt">id</span><span class="o">=</span><span class="mi">1</span>
<span class="n">log</span><span class="o">-</span><span class="n">bin</span><span class="o">=</span><span class="n">logbin</span>

<span class="mi">2</span><span class="err">、主库增加用户，用于从库读取主库日志。</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">grant</span> <span class="n">replication</span> <span class="n">slave</span><span class="p">,</span><span class="n">reload</span><span class="p">,</span><span class="nb">super</span> <span class="n">on</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="n">to</span> <span class="err">&#39;</span><span class="n">slave</span><span class="sc">&#39;@&#39;</span><span class="mf">10.255.254.109</span><span class="err">&#39;</span> <span class="n">identified</span> <span class="n">by</span> <span class="s">&quot;123456&quot;</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">flush</span> <span class="n">privileges</span><span class="p">;</span>

<span class="mi">3</span><span class="err">、从库连接主库进行测试。</span><span class="n">mysql</span> <span class="o">-</span><span class="n">u</span> <span class="n">slave</span> <span class="o">-</span><span class="n">p123456</span> <span class="o">-</span><span class="n">h</span> <span class="mf">192.168.0.1</span>
<span class="err">如果连接成功说明主库配置成功</span>

<span class="mi">4</span><span class="err">、停从库，修改从库</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span><span class="err">，增加选项：</span>
<span class="n">server</span><span class="o">-</span><span class="kt">id</span><span class="o">=</span><span class="mi">2</span>
<span class="n">master_host</span><span class="o">=</span><span class="mf">10.255.254.129</span>
<span class="n">master_user</span><span class="o">=</span><span class="n">slave</span>
<span class="n">master_password</span><span class="o">=</span><span class="mi">123456</span>
<span class="n">relay_log</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">mysql</span><span class="o">-</span><span class="n">relay</span><span class="o">-</span><span class="n">bin</span>
<span class="n">relay_log_index</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">mysql</span><span class="o">-</span><span class="n">relay</span><span class="o">-</span><span class="n">bin</span><span class="p">.</span><span class="n">index</span>

<span class="mi">5</span><span class="err">、启动从库，进行主从库数据同步</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">mysql</span> <span class="n">start</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">mysql</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="o">-</span><span class="n">p</span> 
<span class="n">mysql</span><span class="o">&gt;</span><span class="n">load</span> <span class="n">data</span> <span class="n">from</span> <span class="n">master</span><span class="p">;</span>
<span class="err">说明：这一步也可以用数据库倒入或者直接目录考过来。</span>


<span class="mi">6</span><span class="err">、进行测试：</span>
<span class="err">①主库查看当前存在的库</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">databases</span><span class="p">;</span>
<span class="o">+--------------------+</span>
<span class="o">|</span> <span class="n">Database</span>           <span class="o">|</span>
<span class="o">+--------------------+</span>
<span class="o">|</span> <span class="n">information_schema</span> <span class="o">|</span> 
<span class="o">|</span> <span class="n">mysql</span>              <span class="o">|</span>  
<span class="o">|</span> <span class="n">test</span>               <span class="o">|</span> 
<span class="o">+--------------------+</span>
<span class="mi">3</span> <span class="n">rows</span> <span class="k">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>
<span class="err">②从库查看当前存在库</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">databases</span><span class="p">;</span>
<span class="o">+--------------------+</span>
<span class="o">|</span> <span class="n">Database</span>           <span class="o">|</span>
<span class="o">+--------------------+</span>
<span class="o">|</span> <span class="n">information_schema</span> <span class="o">|</span> 
<span class="o">|</span> <span class="n">mysql</span>              <span class="o">|</span>  
<span class="o">|</span> <span class="n">test</span>               <span class="o">|</span> 
<span class="o">+--------------------+</span>
<span class="mi">3</span> <span class="n">rows</span> <span class="k">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>
<span class="err">说明两者中的数据保持了一致性</span>
<span class="err">③主库创建表，</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">create</span> <span class="n">database</span> <span class="n">xxx</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
<span class="err">打开从库，察看：</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">databases</span><span class="p">;</span>
<span class="o">+--------------------+</span>
<span class="o">|</span> <span class="n">Database</span>           <span class="o">|</span>
<span class="o">+--------------------+</span>
<span class="o">|</span> <span class="n">information_schema</span> <span class="o">|</span> 
<span class="o">|</span> <span class="n">mysql</span>              <span class="o">|</span>  
<span class="o">|</span> <span class="n">test</span>               <span class="o">|</span>
<span class="o">|</span> <span class="n">xxx</span>                <span class="o">|</span>       <span class="o">|</span> 
<span class="o">+--------------------+</span>
<span class="mi">4</span> <span class="n">rows</span> <span class="k">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>

<span class="err">说明主从数据库创建成功。</span>
<span class="mi">7</span><span class="err">、主从数据库相关命令：</span>
<span class="n">slave</span> <span class="n">stop</span><span class="p">;</span> <span class="n">slave</span> <span class="n">start</span> <span class="p">;</span> <span class="err">开始停止从数据库。</span>
<span class="n">show</span> <span class="n">slave</span> <span class="n">status</span><span class="err">\</span><span class="n">G</span><span class="p">;</span> <span class="err">显示从库状态信息</span>
<span class="n">show</span> <span class="n">master</span> <span class="n">status</span><span class="err">\</span><span class="n">G</span><span class="p">;</span><span class="err">显示主库状态信息</span>
<span class="n">purge</span> <span class="n">master</span> <span class="n">logs</span> <span class="n">to</span> <span class="err">’</span><span class="n">binlog</span><span class="mf">.000004</span><span class="err">’</span><span class="p">;</span> <span class="err">此命令非常小心，删除主数据库没用的二进制日志文件。如果误删除，那么从库就没有办法自动更新了。</span>
<span class="n">change</span> <span class="n">master</span><span class="err">；从服务器上修改参数使用</span>

<span class="err">另外，如果你当前操作的从库以前曾经与其他服务器建立过主从关系，你可能会发现即使你在</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span><span class="err">文件中更改了主服务器的位置，但是</span><span class="n">MSQL</span><span class="err">仍然</span>
<span class="err">在试图连接就旧的主服务器的现象。发生这种问题的时候，我们可以通过清除</span><span class="n">master</span><span class="p">.</span><span class="n">info</span><span class="err">这个缓存文件或者在</span><span class="n">mysql</span><span class="err">中通过命令来进行设置。</span>
<span class="err">方式如下：</span>
<span class="n">a</span><span class="err">、删除</span><span class="n">master</span><span class="p">.</span><span class="n">info</span><span class="err">方法</span>
<span class="err">这个文件位于数据文件存放目录里。默认是在</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span><span class="err">中的。你可以直接</span>
<span class="err">将其删除，然后重新启动服务器。</span>

<span class="n">b</span><span class="err">、</span><span class="n">mysql</span><span class="err">命令方法</span>
<span class="err">如果你不方便重新启动服务器的话，那么就只能使用</span><span class="n">mysql</span><span class="err">命令来帮助你做到。</span>
<span class="err">首先登录到主服务器上，查看当前服务器状态：</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">master</span> <span class="n">status</span><span class="err">\</span><span class="n">G</span><span class="p">;</span>
<span class="o">+---------------+----------+--------------+------------------+</span>
<span class="o">|</span> <span class="n">File</span> <span class="o">|</span> <span class="n">Position</span> <span class="o">|</span> <span class="n">Binlog_Do_DB</span> <span class="o">|</span> <span class="n">Binlog_Ignore_DB</span> <span class="o">|</span>
<span class="o">+---------------+----------+--------------+------------------+</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.003</span> <span class="o">|</span> <span class="mi">73</span> <span class="o">|</span> <span class="n">test</span> <span class="o">|</span> <span class="n">manual</span><span class="p">,</span><span class="n">mysql</span> <span class="o">|</span>
<span class="o">+---------------+----------+--------------+------------------+</span>
<span class="err">记录下</span><span class="n">File</span><span class="err">和</span><span class="n">Position</span><span class="err">的值。然后登录从服务器，进行如下操作：</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">slave</span> <span class="n">stop</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">CHANGE</span> <span class="n">MASTER</span> <span class="n">TO</span>
<span class="o">-&gt;</span> <span class="n">MASTER_HOST</span><span class="o">=</span><span class="err">&#39;</span><span class="n">master_host_name</span><span class="err">&#39;</span><span class="p">,</span> <span class="c1">//主服务器的IP地址</span>
<span class="o">-&gt;</span> <span class="n">MASTER_USER</span><span class="o">=</span><span class="err">&#39;</span><span class="n">replication_user_name</span><span class="err">&#39;</span><span class="p">,</span> <span class="c1">//同步数据库的用户</span>
<span class="o">-&gt;</span> <span class="n">MASTER_PASSWORD</span><span class="o">=</span><span class="err">&#39;</span><span class="n">replication_password</span><span class="err">&#39;</span><span class="p">,</span> <span class="c1">//同步数据库的密码</span>
<span class="o">-&gt;</span> <span class="n">MASTER_LOG_FILE</span><span class="o">=</span><span class="err">&#39;</span><span class="n">recorded_log_file_name</span><span class="err">&#39;</span><span class="p">,</span> <span class="c1">//主服务器二进制日志的文件名(前面要求记</span>
<span class="err">录的参数</span><span class="p">)</span>
<span class="o">-&gt;</span> <span class="n">MASTER_LOG_POS</span><span class="o">=</span><span class="n">recorded_log_position</span><span class="p">;</span> <span class="c1">//日志文件的开始位置(前面要求记录的参数)</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">slave</span> <span class="n">start</span><span class="p">;</span>

<span class="n">AB</span><span class="err">复制注意事项：</span>
<span class="mf">1.</span><span class="err">第一次启动</span><span class="n">slave</span><span class="err">库以后</span>  <span class="n">show</span> <span class="n">slave</span> <span class="n">status</span> <span class="err">\</span><span class="n">G</span><span class="p">;</span>  
<span class="err">检查</span>  <span class="err">两个线程</span>  <span class="n">I</span><span class="err">／</span><span class="n">O</span>   <span class="n">SQL</span> <span class="err">是否是</span><span class="nb">YES</span><span class="err">状态</span>

<span class="mf">2.</span><span class="err">测试</span>
<span class="err">添加或删除数据</span> <span class="err">（主服务器）</span>   <span class="err">查看辅助的是否同步</span>


<span class="err">如果不同步</span>
    <span class="mi">1</span><span class="err">）查看辅助的</span><span class="n">sql</span><span class="err">日志</span>    <span class="n">tailf</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">mysqld</span><span class="p">.</span><span class="n">log</span>
     <span class="mi">140304</span> <span class="mi">11</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mi">18</span> <span class="p">[</span><span class="n">Note</span><span class="p">]</span> <span class="n">Slave</span> <span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="kr">thread</span><span class="o">:</span> <span class="n">connected</span> <span class="n">to</span> <span class="n">master</span> <span class="err">&#39;</span><span class="n">slave</span><span class="mf">@192.168.18.254</span><span class="o">:</span><span class="mi">3306</span><span class="err">&#39;</span><span class="p">,</span>  <span class="n">replication</span> 
     <span class="n">started</span> <span class="k">in</span> <span class="n">log</span> <span class="err">&#39;</span><span class="n">binlog</span><span class="mf">.000011</span><span class="err">&#39;</span> <span class="n">at</span> <span class="n">position</span> <span class="mi">294</span>

       <span class="err">＃从服务器是否可以顺利到达主服务器</span>
            <span class="err">如果发现你的用户名密码有错误</span>  <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span>   <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">master</span><span class="p">.</span><span class="n">info</span>

 <span class="mi">2</span><span class="p">)</span><span class="err">查看</span><span class="n">sql</span><span class="err">线程是否报错</span>
           <span class="mi">140304</span> <span class="mi">11</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mi">08</span> <span class="p">[</span><span class="n">Note</span><span class="p">]</span> <span class="n">Slave</span> <span class="n">SQL</span> <span class="kr">thread</span> <span class="n">initialized</span><span class="p">,</span> <span class="n">starting</span> <span class="n">replication</span> <span class="k">in</span> <span class="n">log</span> <span class="err">&#39;</span><span class="n">binlog</span><span class="mf">.000011</span><span class="err">&#39;</span> <span class="n">at</span>
            <span class="n">position</span> <span class="mi">294</span><span class="p">,</span> <span class="n">relay</span> <span class="n">log</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">mysql</span><span class="o">-</span><span class="n">relay</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000001</span><span class="err">&#39;</span> <span class="nl">position</span><span class="p">:</span> <span class="mi">4</span>

           <span class="err">手动去执行同步</span>
                <span class="mi">1</span><span class="err">）</span><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">slave</span> <span class="n">stop</span><span class="p">;</span>
                <span class="mi">2</span><span class="p">)</span><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">CHANGE</span> <span class="n">MASTER</span> <span class="n">TO</span> <span class="n">MASTER_HOST</span><span class="o">=</span><span class="err">&#39;</span><span class="mf">192.168.18.254</span><span class="err">&#39;</span><span class="p">,</span><span class="n">MASTER_USER</span><span class="o">=</span><span class="err">&#39;</span><span class="n">slave</span><span class="err">&#39;</span><span class="p">,</span><span class="n">MASTER_PASSWORD</span><span class="o">=</span><span class="err">&#39;</span><span class="mi">123456</span><span class="err">&#39;</span><span class="p">,</span>
                <span class="n">MASTER_LOG_FILE</span><span class="o">=</span><span class="err">&#39;</span><span class="n">binlog</span><span class="mf">.000011</span><span class="err">&#39;</span><span class="p">;</span>

                <span class="mi">3</span><span class="p">)</span>  <span class="n">mysql</span> <span class="o">&gt;</span> <span class="n">slave</span> <span class="n">start</span><span class="p">;</span>
<span class="err">如果出现开始同步</span>  <span class="err">且</span><span class="n">AB</span><span class="err">同步后数据不一致</span>

<span class="err">备份主库</span>   <span class="err">去</span>  <span class="err">手动同步到一致状态</span>   <span class="err">再去执行手动同步中的</span><span class="mi">1</span> <span class="err">，</span><span class="mi">2</span><span class="err">，</span> <span class="mi">3</span><span class="err">步</span>


<span class="err">需要注意的问题</span>
<span class="n">MySQL</span> <span class="n">Replication</span> <span class="err">大家都非常熟悉了，我也不会写怎么搭建以及复制的原理，网上相关文章非常多，大家可以自己去搜寻。我在这里就是想</span>
<span class="err">总结一下</span><span class="n">mysql</span><span class="err">主从复制需要注意的地方。有人说主从复制很简单嘛，就是</span><span class="n">master</span><span class="err">，</span><span class="n">slave</span><span class="err">的</span><span class="n">server_id</span><span class="err">不一样就搞定。确实，简单的来说就是</span>
<span class="err">这么简单。但是真正在生产环境我们需要注意的太多了。首先说说主库宕机或者从库宕机后复制中断的问题。</span>

<span class="err">虽然很多知识点或许我博客其他文章中都有提到过，或者重复了，但是我还是想总结一下。</span>

<span class="err">主库意外宕机</span>

<span class="err">如果没有设置主库的</span><span class="n">sync_binlog</span><span class="err">选项，就可能在奔溃前没有将最后的几个二进制日志事件刷新到磁盘中。备库</span><span class="n">I</span><span class="o">/</span><span class="n">O</span><span class="err">线程因此也可一直处于读</span>
<span class="err">不到尚未写入磁盘的事件的状态中。当主库从新启动时，备库将重连到主库并再次尝试去读该事件，但主库会告诉备库没有这个二进制日志偏</span>
<span class="err">移量。解决这个问题的方法是指定备库从下一个二进制日志的开头读日志。但是一些事件将永久丢失。可以使用前面文章提到的工具来检查主</span>
<span class="err">从数据一致以及修复</span><span class="n">pt</span><span class="o">-</span><span class="n">table</span><span class="o">-</span><span class="n">checksum</span><span class="err">。即使开启了</span><span class="n">sync_binlog</span><span class="err">，</span><span class="n">myisam</span><span class="err">表的数据仍然可能在奔溃的时候损坏。对于</span><span class="n">innodb</span><span class="err">表，如果</span>
<span class="n">innodb_flush_log_at_trx_commit</span><span class="err">没有设置为</span><span class="mi">1</span><span class="err">，也可能丢失数据，但是数据不会损坏。</span>

<span class="err">因此主库的参数建议开启</span>

<span class="n">sync_binlog</span><span class="o">=</span><span class="mi">1</span>
<span class="n">innodb</span><span class="o">-</span><span class="n">flush</span><span class="o">-</span><span class="n">log</span><span class="o">-</span><span class="n">at</span><span class="o">-</span><span class="n">trx</span><span class="o">-</span><span class="n">commit</span><span class="o">=</span><span class="mi">1</span>
<span class="n">MySQL</span> <span class="mf">5.6</span><span class="err">版本之前存在一个</span><span class="n">bug</span><span class="err">，即当启用上述两个参数时，会使得</span><span class="n">InnoDB</span><span class="err">存储引擎的</span><span class="n">group</span> <span class="n">commit</span><span class="err">失效，从而导致在写密集的环境中性</span>
<span class="err">能的急剧下降。</span><span class="n">group</span> <span class="n">commit</span><span class="err">是什么？这是一个知识点，那为什么</span><span class="n">sync_binlog</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">innodb</span><span class="o">-</span><span class="n">flush</span><span class="o">-</span><span class="n">log</span><span class="o">-</span><span class="n">at</span><span class="o">-</span><span class="n">trx</span><span class="o">-</span><span class="n">commit</span><span class="o">=</span><span class="mi">1</span>

<span class="err">会导致组提交失败？这又是一个知识点，大家可以查阅相关资料。</span>

<span class="err">因此，我们常常在性能和数据一致性中做了妥协，通常将参数</span><span class="n">innodb</span><span class="o">-</span><span class="n">flush</span><span class="o">-</span><span class="n">log</span><span class="o">-</span><span class="n">at</span><span class="o">-</span><span class="n">trx</span><span class="o">-</span><span class="n">commit</span><span class="err">设置为</span><span class="mi">2</span><span class="err">，而这就导致了</span><span class="n">master</span><span class="err">不再是</span>
<span class="n">crash</span> <span class="n">safe</span><span class="err">的，主从数据可能会不一致。关于</span><span class="n">innodb_flush_log_at_trx_commit</span><span class="err">的有效值为</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="err">。我这里简单提一下，因为很多知识</span>
<span class="err">点是有连贯性的，往往提到这个问题而又涉及到另外的问题</span><span class="o">^</span><span class="n">_</span><span class="o">^</span>

<span class="mi">0</span><span class="err">代表当提交事务时，并不将事务的重做日志写入磁盘上的日志文件，而是等待主线程每秒的刷新。当宕机时，丢失</span><span class="mi">1</span><span class="err">秒的事务。</span>

<span class="mi">1</span><span class="err">和</span><span class="mi">2</span><span class="err">有点相同，但是不同的地方在于：</span><span class="mi">1</span><span class="err">表示在执行</span><span class="n">commit</span><span class="err">时将重做日志缓冲同步写到磁盘，即伴有</span><span class="n">fsync</span><span class="err">的调用。</span><span class="mi">2</span><span class="err">表示将重做日志异步写</span>
<span class="err">到磁盘，即写到文件系统的缓存中。由操作系统控制刷新。因此不能完全保证在执行</span><span class="n">commit</span><span class="err">时肯定会写入重做日志文件，只是有这个动作的发生。</span>

<span class="err">因此为了保证事务的</span><span class="n">ACID</span><span class="err">中的持久性，必须将</span><span class="n">innodb_flush_log_at_trx_commit</span><span class="err">设置为</span><span class="mi">1</span><span class="err">，也就是每当有事务提交时，就必须确保事务都</span>
<span class="err">已经写入重做日志文件。那么当数据库因为意外发生宕机时，可以通过重做日志文件恢复，并保证可以恢复已经提交的事务。而将该参数设</span>
<span class="err">置为</span><span class="mi">0</span><span class="err">或者</span><span class="mi">2</span><span class="err">，都有可能发生恢复时部分事务的丢失。不同之处在于，设置为</span><span class="mi">2</span><span class="err">时，当</span><span class="n">mysql</span><span class="err">数据库发生宕机而操作系统及服务器并没有发生宕</span>
<span class="err">机时，由于此时未写入磁盘的事务日志保存在文件系统缓存中，当恢复时同样能保证数据不丢失。</span>

<span class="err">对于性能与安全我们都要的情况下，我们肯定会使用</span><span class="n">RAID</span><span class="err">，并且开启</span><span class="n">Write</span> <span class="n">Back</span><span class="err">功能，而且</span><span class="n">RAID</span><span class="err">卡提供电池备份单元（</span><span class="n">BBU</span><span class="p">,</span><span class="n">Battery</span> 
<span class="n">Backup</span> <span class="n">Unit</span><span class="err">），关于这块的知识，童鞋们可以自行查阅相关资料。</span>

<span class="err">备库意外宕机：</span>

<span class="err">当备库在一次非计划的关闭后重启时，会去读</span><span class="n">master</span><span class="p">.</span><span class="n">info</span><span class="err">文件以找到上次停止复制的位置。不幸的是，该文件可能并没有同步写到磁盘，</span>
<span class="err">因为该信息是在缓存中，可能并没有刷新到磁盘文件</span><span class="n">master</span><span class="p">.</span><span class="n">info</span><span class="err">。文件中存储的信息可能是错误的，备库可能会尝试重新执行一些二进制</span>
<span class="err">日志事件，这可能导致主键冲突，就是我们常常看见的</span><span class="mi">1062</span><span class="err">错误。除非能确定备库在哪里停止（很难），否则唯一的办法就是忽略那些错误。</span>

<span class="err">在从库导致复制中断有两方面的原因，即</span><span class="n">replication</span><span class="err">中的</span><span class="n">SQL</span> <span class="kr">thread</span><span class="err">和</span><span class="n">IO</span> <span class="kr">thread</span><span class="err">。首先来看</span><span class="n">SQL</span> <span class="kr">thread</span><span class="err">，其主要完成两个操作：</span>

<span class="mf">1.</span><span class="err">运行</span><span class="n">relay</span> <span class="n">log</span><span class="err">中对应的事务信息</span>
<span class="mf">2.</span><span class="err">更新</span><span class="n">relay</span><span class="o">-</span><span class="n">info</span><span class="p">.</span><span class="n">log</span><span class="err">文件</span>

<span class="err">更新</span><span class="n">relay</span><span class="o">-</span><span class="n">info</span><span class="p">.</span><span class="n">log</span><span class="err">文件是为了记录已经执行</span><span class="n">relay</span> <span class="n">log</span><span class="err">中的位置，当</span><span class="n">slave</span><span class="err">重启后可以根据这个位置继续同步</span><span class="n">relay</span> <span class="n">log</span><span class="err">。但是，这里</span>
<span class="err">用户会发现这两个操作不是在一个事务中，一个是数据库操作，一个是文件操作，因此不能达到原子的效果。此外，</span><span class="n">MySQL</span><span class="err">数据库默认对于</span>
<span class="err">文件</span><span class="n">relay</span><span class="o">-</span><span class="n">info</span><span class="p">.</span><span class="n">log</span><span class="err">是写入到操作系统缓存，因此在发生宕机时可能导致大量的已更新位置的丢失，从而导致重复执行</span><span class="n">SQL</span><span class="err">语句，最终的现</span>
<span class="err">象就是主从数据不一致。</span><span class="n">MySQL</span> <span class="mf">5.5</span><span class="err">新增了参数</span><span class="n">sync_relay_log_info</span><span class="p">,</span><span class="err">可以控制每次事务更新</span><span class="n">relay</span><span class="o">-</span><span class="n">info</span><span class="p">.</span><span class="n">log</span><span class="err">后就进行一次</span><span class="n">fdatasync</span><span class="err">操作，</span>
<span class="err">这加重了系统负担，而且即使这样也可能存在最后一个事务丢失的情况。</span>

<span class="n">IO</span> <span class="kr">thread</span><span class="err">用于同步</span><span class="n">master</span><span class="err">上的二进制日志，但是其在</span><span class="n">crash</span><span class="err">时依然会导致数据不一致的情况发生。</span><span class="n">IO</span> <span class="kr">thread</span><span class="err">将收到的二进制日志写入到</span>
<span class="n">relay</span> <span class="n">log</span><span class="err">，每个二进制日志由多个</span><span class="n">log</span> <span class="n">event</span><span class="err">组成，所以每接受到一个</span><span class="n">log</span> <span class="n">event</span><span class="err">就需要更新</span><span class="n">master</span><span class="o">-</span><span class="n">info</span><span class="p">.</span><span class="n">log</span><span class="err">。和</span><span class="n">relay</span><span class="o">-</span><span class="n">info</span><span class="p">.</span><span class="n">log</span><span class="err">一样，</span>
<span class="err">其也是写入操作系统缓存，参数</span><span class="n">sync_master_info</span><span class="err">可以控制</span><span class="n">fdatasync</span><span class="err">的时间。由于</span><span class="n">IO</span> <span class="kr">thread</span><span class="err">的更新不能像</span><span class="n">SQL</span> <span class="kr">thread</span><span class="err">一样进行放到一个事</span>
<span class="err">务进行原子操作，因此其是对数据一致性会产生影响，设想一个</span><span class="n">log</span> <span class="n">event</span><span class="err">传送到了</span><span class="n">relay</span> <span class="n">log</span><span class="err">中两次的情形。</span>
<span class="err">不过好在从</span><span class="n">MySQL</span> <span class="mf">5.5</span><span class="err">版本开始提供了参数</span><span class="n">relay_log_recovery</span><span class="err">，当发生</span><span class="n">crash</span><span class="err">导致重连</span><span class="n">master</span><span class="err">时，其不根据</span><span class="n">master</span><span class="o">-</span><span class="n">info</span><span class="p">.</span><span class="n">log</span><span class="err">的信息进行重</span>
<span class="err">连，而是根据</span><span class="n">relay</span><span class="o">-</span><span class="n">info</span><span class="err">中执行到</span><span class="n">master</span><span class="err">的位置信息重新开始拉</span><span class="n">master</span><span class="err">上的日志数据（不过需要确保日志依然存在于</span><span class="n">master</span><span class="err">上，否则就。。。）</span>
<span class="n">so</span><span class="err">，</span><span class="n">mysql</span> <span class="mf">5.5</span><span class="err">版本的从库推荐配置参数：</span>

<span class="n">sync_master_info</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">sync_relay_log</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">sync_relay_log_info</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">read_only</span>          <span class="err">#从库只读，但是有</span><span class="nb">super</span><span class="err">权限的依然可以写入</span>
<span class="n">relay_log_recovery</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">skip_slave_start</span>   <span class="err">#</span> <span class="err">默认启动从库就开启了同步，</span><span class="n">io</span><span class="err">线程和</span><span class="n">sql</span><span class="err">线程都运行了，该参数是需要手动执行</span><span class="n">start</span> <span class="n">slave</span><span class="err">方可启动同步</span>
<span class="err">复制过滤选项</span>

<span class="err">常常看见很多同学在主库进行过滤选项设置，当然这也有好处，减少了带宽，但是在主库设置过滤选项是非常危险的操作，因为无论是显示要过滤</span>
<span class="err">的或者要同步的，二进制日志只记录你设置的，其他的是不会记录的。当主库有数据需要用到</span><span class="n">binlog</span><span class="err">恢复时，你就准备哭吧。所以通常在备库进行</span>
<span class="err">过滤选项设置。比如忽略某个库，同步所有库，或者同步某一个库，当然这会浪费带宽，但是和安全比起来，这点浪费不算什么。有时候安全与性</span>
<span class="err">能往往需要我们自己平衡。</span>

<span class="err">还有就是跨库更新，如果我们在备库是这样设置的，比如同步</span><span class="n">yayun</span><span class="err">这个库</span>

<span class="n">replicate_do_db</span><span class="o">=</span><span class="n">yayun</span>
<span class="err">主库记录如下：</span>

<span class="err">复制代码</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">select</span> <span class="o">*</span>  <span class="n">from</span> <span class="n">t1</span><span class="p">;</span>
<span class="o">+----+-------+</span>
<span class="o">|</span> <span class="kt">id</span> <span class="o">|</span> <span class="n">name</span>  <span class="o">|</span>
<span class="o">+----+-------+</span>
<span class="o">|</span>  <span class="mi">1</span> <span class="o">|</span> <span class="n">yayun</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">2</span> <span class="o">|</span> <span class="n">atlas</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">3</span> <span class="o">|</span> <span class="n">mysql</span> <span class="o">|</span>
<span class="o">+----+-------+</span>
<span class="mi">3</span> <span class="n">rows</span> <span class="k">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">mysql</span><span class="o">&gt;</span>
<span class="err">复制代码</span>
<span class="err">备库记录如下：</span>

<span class="err">复制代码</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">t1</span><span class="p">;</span>
<span class="o">+----+-------+</span>
<span class="o">|</span> <span class="kt">id</span> <span class="o">|</span> <span class="n">name</span>  <span class="o">|</span>
<span class="o">+----+-------+</span>
<span class="o">|</span>  <span class="mi">1</span> <span class="o">|</span> <span class="n">yayun</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">2</span> <span class="o">|</span> <span class="n">atlas</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">3</span> <span class="o">|</span> <span class="n">mysql</span> <span class="o">|</span>
<span class="o">+----+-------+</span>
<span class="mi">3</span> <span class="n">rows</span> <span class="k">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">mysql</span><span class="o">&gt;</span>
<span class="err">复制代码</span>
<span class="err">现在我们在主库插入一条记录</span>

<span class="err">复制代码</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">use</span> <span class="n">test</span><span class="p">;</span>
<span class="n">Reading</span> <span class="n">table</span> <span class="n">information</span> <span class="k">for</span> <span class="n">completion</span> <span class="n">of</span> <span class="n">table</span> <span class="n">and</span> <span class="n">column</span> <span class="n">names</span>
<span class="n">You</span> <span class="n">can</span> <span class="n">turn</span> <span class="n">off</span> <span class="n">this</span> <span class="n">feature</span> <span class="n">to</span> <span class="n">get</span> <span class="n">a</span> <span class="n">quicker</span> <span class="n">startup</span> <span class="n">with</span> <span class="o">-</span><span class="n">A</span>

<span class="n">Database</span> <span class="n">changed</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">insert</span> <span class="n">into</span> <span class="n">yayun</span><span class="p">.</span><span class="n">t1</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="n">values</span> <span class="p">(</span><span class="err">&#39;</span><span class="n">good</span> <span class="n">yayun</span><span class="err">&#39;</span><span class="p">);</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">select</span>  <span class="o">*</span> <span class="n">from</span> <span class="n">yayun</span><span class="p">.</span><span class="n">t1</span><span class="p">;</span> 
<span class="o">+----+------------+</span>
<span class="o">|</span> <span class="kt">id</span> <span class="o">|</span> <span class="n">name</span>       <span class="o">|</span>
<span class="o">+----+------------+</span>
<span class="o">|</span>  <span class="mi">1</span> <span class="o">|</span> <span class="n">yayun</span>      <span class="o">|</span>
<span class="o">|</span>  <span class="mi">2</span> <span class="o">|</span> <span class="n">atlas</span>      <span class="o">|</span>
<span class="o">|</span>  <span class="mi">3</span> <span class="o">|</span> <span class="n">mysql</span>      <span class="o">|</span>
<span class="o">|</span>  <span class="mi">5</span> <span class="o">|</span> <span class="n">good</span> <span class="n">yayun</span> <span class="o">|</span>
<span class="o">+----+------------+</span>
<span class="mi">4</span> <span class="n">rows</span> <span class="k">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">mysql</span><span class="o">&gt;</span>
<span class="err">复制代码</span>
<span class="err">查看备库：</span>

<span class="err">复制代码</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">t1</span><span class="p">;</span>
<span class="o">+----+-------+</span>
<span class="o">|</span> <span class="kt">id</span> <span class="o">|</span> <span class="n">name</span>  <span class="o">|</span>
<span class="o">+----+-------+</span>
<span class="o">|</span>  <span class="mi">1</span> <span class="o">|</span> <span class="n">yayun</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">2</span> <span class="o">|</span> <span class="n">atlas</span> <span class="o">|</span>
<span class="o">|</span>  <span class="mi">3</span> <span class="o">|</span> <span class="n">mysql</span> <span class="o">|</span>
<span class="o">+----+-------+</span>
<span class="mi">3</span> <span class="n">rows</span> <span class="k">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">mysql</span><span class="o">&gt;</span>
<span class="err">复制代码</span>
<span class="err">怎么回事？怎么没有同步？这就是跨库更新带来的问题，比如下面的更新：</span>

<span class="n">use</span> <span class="n">test</span>
<span class="n">insert</span> <span class="n">into</span> <span class="n">yayun</span><span class="p">.</span><span class="n">t1</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="n">values</span> <span class="p">(</span><span class="err">&#39;</span><span class="n">good</span> <span class="n">yayun</span><span class="err">&#39;</span><span class="p">)</span>
<span class="err">当然你会说哪个</span><span class="mi">2</span><span class="n">B</span><span class="err">会这么干啊，呵呵，有时</span><span class="mi">2</span><span class="n">B</span><span class="err">还是有的。所以我们还有另外</span><span class="mi">2</span><span class="err">个过滤复制参数</span>

<span class="n">replicate_wild_do_table</span>
<span class="n">replicate_wild_ignore_table</span>
<span class="err">一个是要同步的表，一个是不同步的表，通常我们可以这样写</span>

<span class="n">replicate_wild_do_table</span><span class="o">=</span><span class="n">yayun</span><span class="p">.</span><span class="o">%</span>
<span class="err">表示同步</span><span class="n">yayun</span><span class="err">库下面的所有表，这样就解决的跨库更新的问题。</span>

<span class="err">复制格式的问题</span>

<span class="err">通常推荐使用</span><span class="n">ROW</span><span class="err">格式，为什么使用？看看我前面文章</span><span class="n">MySQL</span><span class="err">数据恢复和复制对</span><span class="n">InnoDB</span><span class="err">锁机制的影响</span>

<span class="err">不要用</span><span class="n">Seconds_Behind_Master</span><span class="err">来衡量</span><span class="n">MySQL</span><span class="err">主备的延迟时间</span>

<span class="err">这个后续我会写相关文章解释为什么不要用该参数衡量主备的延迟时间。</span>



<span class="err">总结：</span>

<span class="err">上面所提到的参数都是最大限度保证主从数据一致，以及主库宕机，从库宕机复制不会中断，但是性能会打折扣，所以需要我们自己去衡量，</span>
<span class="err">或者做妥协。</span>
</pre></div>


<h2 id="mha">mha</h2>
<div class="codehilite"><pre><span></span><span class="err">安装</span><span class="n">Mysql</span><span class="err">，配置主从</span>


<span class="err">配置</span><span class="n">MHA</span>
   <span class="err">建立</span><span class="n">ssh</span><span class="err">无密码登录环境</span>
<span class="n">ssh</span><span class="o">-</span><span class="n">keygen</span> <span class="o">-</span><span class="n">t</span> <span class="n">rsa</span>
<span class="n">ssh</span><span class="o">-</span><span class="k">copy</span><span class="o">-</span><span class="kt">id</span> <span class="o">-</span><span class="n">i</span> <span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">id_rsa</span><span class="p">.</span><span class="n">pub</span> <span class="err">&#39;</span><span class="o">-</span><span class="n">p</span> <span class="mi">27005</span> <span class="n">root</span><span class="mf">@192.168.3.129</span><span class="err">&#39;</span>
<span class="n">ssh</span><span class="o">-</span><span class="k">copy</span><span class="o">-</span><span class="kt">id</span> <span class="o">-</span><span class="n">i</span> <span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">id_rsa</span><span class="p">.</span><span class="n">pub</span> <span class="err">&#39;</span><span class="o">-</span><span class="n">p</span> <span class="mi">27005</span> <span class="n">root</span><span class="mf">@192.168.3.128</span><span class="err">&#39;</span>
<span class="n">ssh</span><span class="o">-</span><span class="k">copy</span><span class="o">-</span><span class="kt">id</span> <span class="o">-</span><span class="n">i</span> <span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">id_rsa</span><span class="p">.</span><span class="n">pub</span> <span class="err">&#39;</span><span class="o">-</span><span class="n">p</span> <span class="mi">27005</span> <span class="n">root</span><span class="mf">@192.168.3.132</span><span class="err">&#39;</span>

<span class="n">ssh</span> <span class="err">连接测试看是否还需要密码</span>

<span class="err">安装</span><span class="n">MHA</span> <span class="n">node</span>
  <span class="err">所有节点安装</span>
   <span class="n">yum</span> <span class="n">install</span> <span class="n">perl</span><span class="o">-</span><span class="n">DBD</span><span class="o">-</span><span class="n">MySQL</span> <span class="o">-</span><span class="n">y</span>
   <span class="n">rpm</span> <span class="o">-</span><span class="n">ivh</span> <span class="n">mha4mysql</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="mf">0.56</span><span class="o">-</span><span class="mf">0.</span><span class="n">el6</span><span class="p">.</span><span class="n">noarch</span><span class="p">.</span><span class="n">rpm</span>
<span class="err">会生成几个脚本文件</span>
  <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">apply_diff_relay_logs</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">filter_mysqlbinlog</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">purge_relay_logs</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">save_binary_logs</span>


<span class="err">设置</span><span class="n">relay</span> <span class="n">log</span><span class="err">的清除方式</span>
<span class="err">在每个</span><span class="n">slave</span><span class="err">节点上：</span>
  <span class="n">Sql</span><span class="o">&gt;</span>  <span class="n">set</span> <span class="n">global</span> <span class="n">relay_log_purge</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
       <span class="n">show</span> <span class="n">variables</span> <span class="n">like</span> <span class="s">&quot;%relay_log_purge%&quot;</span><span class="p">;</span>
 <span class="err">注意：</span><span class="n">MHA</span><span class="err">在发生切换的过程中，从库的恢复过程中依赖于</span><span class="n">relay</span> <span class="n">log</span><span class="err">的相关信息，所以这里要将</span><span class="n">relay</span> <span class="n">log</span><span class="err">的自动清除设置为</span><span class="n">OFF</span><span class="err">，</span>
 <span class="err">采用手动清除</span><span class="n">relay</span> <span class="n">log</span><span class="err">的方式。</span>

<span class="err">设置定期清理</span><span class="n">relay</span><span class="err">脚本（两台</span><span class="n">slave</span><span class="err">服务器）</span>
<span class="n">cat</span> <span class="n">purge_relay_log</span><span class="p">.</span><span class="n">sh</span> 
<span class="cp">#!/bin/bash</span>
<span class="n">user</span><span class="o">=</span><span class="n">root</span>
<span class="n">passwd</span><span class="o">=</span><span class="mi">1</span>
<span class="n">port</span><span class="o">=</span><span class="mi">3306</span>
<span class="n">log_dir</span><span class="o">=</span><span class="err">&#39;</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="err">&#39;</span>
<span class="n">purge</span><span class="o">=</span><span class="err">&#39;</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">purge_relay_logs</span><span class="err">&#39;</span>

<span class="k">if</span> <span class="p">[</span> <span class="o">!</span> <span class="o">-</span><span class="n">d</span> <span class="err">$</span><span class="n">log_dir</span> <span class="p">]</span>
<span class="n">then</span>
   <span class="n">mkdir</span> <span class="err">$</span><span class="n">log_dir</span> <span class="o">-</span><span class="n">p</span>
<span class="n">fi</span>

<span class="err">$</span><span class="n">purge</span> <span class="o">--</span><span class="n">user</span><span class="o">=</span><span class="err">$</span><span class="n">user</span> <span class="o">--</span><span class="n">password</span><span class="o">=</span><span class="err">$</span><span class="n">passwd</span> <span class="o">--</span><span class="n">disable_relay_log_purge</span> <span class="o">--</span><span class="n">port</span><span class="o">=</span><span class="err">$</span><span class="n">port</span> <span class="o">--</span><span class="n">workdir</span><span class="o">=</span><span class="err">$</span><span class="n">work_dir</span> <span class="o">&gt;&gt;</span> 
<span class="err">$</span><span class="n">log_dir</span><span class="o">/</span><span class="n">purge_relay_logs</span><span class="p">.</span><span class="n">log</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>

<span class="n">crontab</span> <span class="o">-</span><span class="n">l</span>
<span class="mi">0</span> <span class="mi">4</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">purge_relay_log</span><span class="p">.</span><span class="n">sh</span>
<span class="err">安装</span><span class="n">MHA</span> <span class="n">Manager</span>
<span class="err">每台服务器配置</span> <span class="o">:</span> 
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span>  <span class="err">和</span><span class="n">mha</span><span class="err">配置文件对应</span>
<span class="mf">192.168.3.129</span>    <span class="n">server1</span>
<span class="mf">192.168.3.128</span>    <span class="n">server2</span>
<span class="mf">192.168.3.132</span>    <span class="n">server3</span>
<span class="err">修改</span><span class="n">ssh</span><span class="err">默认连接端口</span>
<span class="n">vim</span> <span class="o">~/</span><span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">config</span>
 <span class="n">Port</span> <span class="mi">27005</span>
<span class="n">cd</span> <span class="o">~/</span><span class="p">.</span><span class="n">ssh</span> <span class="o">&amp;&amp;</span> <span class="n">chmod</span> <span class="mi">600</span> <span class="n">config</span>


<span class="err">安装</span><span class="n">MHA</span> <span class="n">Node</span><span class="err">软件包，和上面的方法一样</span>
<span class="err">安装依赖</span>  
<span class="n">yum</span> <span class="n">install</span> <span class="n">perl</span><span class="o">-</span><span class="n">DBD</span><span class="o">-</span><span class="n">MySQL</span> <span class="n">perl</span><span class="o">-</span><span class="n">Config</span><span class="o">-</span><span class="n">Tiny</span> <span class="n">perl</span><span class="o">-</span><span class="n">Log</span><span class="o">-</span><span class="n">Dispatch</span> <span class="n">perl</span><span class="o">-</span><span class="n">Parallel</span><span class="o">-</span><span class="n">ForkManager</span> <span class="n">perl</span><span class="o">-</span><span class="n">Time</span><span class="o">-</span><span class="n">HiRes</span> <span class="o">-</span><span class="n">y</span>
<span class="n">rpm</span> <span class="o">-</span><span class="n">ivh</span> <span class="n">mha4mysql</span><span class="o">-</span><span class="n">manager</span><span class="o">-</span><span class="mf">0.56</span><span class="o">-</span><span class="mf">0.</span><span class="n">el6</span><span class="p">.</span><span class="n">noarch</span><span class="p">.</span><span class="n">rpm</span>

<span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">masterha</span>
<span class="n">cat</span>  <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">masterha</span><span class="o">/</span><span class="n">app1</span><span class="p">.</span><span class="n">cnf</span>
<span class="p">[</span><span class="n">server</span> <span class="k">default</span><span class="p">]</span>
<span class="n">manager_workdir</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">masterha</span><span class="o">/</span><span class="n">app1</span>
<span class="n">manager_log</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">masterha</span><span class="o">/</span><span class="n">app1</span><span class="o">/</span><span class="n">manager</span><span class="p">.</span><span class="n">log</span>
<span class="n">master_binlog_dir</span><span class="o">=/</span><span class="n">data</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">data</span><span class="o">/</span>    <span class="err">#设置</span><span class="n">master</span> <span class="err">保存</span><span class="n">binlog</span><span class="err">的位置</span>
<span class="n">master_ip_failover_script</span><span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">master_ip_failover</span>
<span class="cp">#master_ip_online_change_script=</span>
<span class="n">password</span><span class="o">=</span><span class="mi">123456</span>    <span class="err">#监控用户，统一使用主从复制用户</span>
<span class="n">user</span><span class="o">=</span><span class="n">root</span>
<span class="n">ping_interval</span><span class="o">=</span><span class="mi">1</span>
<span class="n">remote_workdir</span><span class="o">=/</span><span class="n">tmp</span>
<span class="n">repl_password</span><span class="o">=</span><span class="mi">123456</span>    <span class="err">#设置复制用户的密码</span>
<span class="n">repl_user</span><span class="o">=</span><span class="n">slave</span>
<span class="n">report_script</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">send_report</span>    <span class="err">#设置发生切换后发送的报警的脚本</span>
<span class="n">secondary_check_script</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">masterha_secondary_check</span> <span class="o">-</span><span class="n">s</span> <span class="n">server3</span> <span class="o">-</span><span class="n">s</span> <span class="n">server2</span>            
<span class="cp">#shutdown_script=&quot;&quot;      #设置故障发生后关闭故障主机脚本（该脚本的主要作用是关闭主机放在发生脑裂,这里没有使用）</span>
<span class="n">ssh_user</span><span class="o">=</span><span class="n">root</span>  
<span class="n">ssh_port</span><span class="o">=</span><span class="mi">27005</span>


<span class="p">[</span><span class="n">server1</span><span class="p">]</span>
<span class="n">hostname</span><span class="o">=</span><span class="mf">192.168.3.129</span>
<span class="n">port</span><span class="o">=</span><span class="mi">3306</span>

<span class="p">[</span><span class="n">server2</span><span class="p">]</span>
<span class="n">hostname</span><span class="o">=</span><span class="mf">192.168.3.128</span>
<span class="n">port</span><span class="o">=</span><span class="mi">3306</span>
<span class="n">candidate_master</span><span class="o">=</span><span class="mi">1</span>   <span class="err">#设置为候选</span><span class="n">master</span><span class="err">，如果设置该参数以后，发生主从切换以后将会将此从库提升为主库，即使这个主库不是集</span>
<span class="err">群中事件最新的</span><span class="n">slave</span>
<span class="n">check_repl_delay</span><span class="o">=</span><span class="mi">0</span>   <span class="err">#默认情况下如果一个</span><span class="n">slave</span><span class="err">落后</span><span class="n">master</span> <span class="mi">100</span><span class="n">M</span><span class="err">的</span><span class="n">relay</span> <span class="n">logs</span><span class="err">的话，</span><span class="n">MHA</span><span class="err">将不会选择该</span><span class="n">slave</span><span class="err">作为一个新的</span><span class="n">master</span><span class="err">，</span>
<span class="err">因为对于这个</span><span class="n">slave</span><span class="err">的恢复需要花费很长时间，通过设置</span><span class="n">check_repl_delay</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">MHA</span><span class="err">触发切换在选择一个新的</span><span class="n">master</span><span class="err">的时候将会忽略复制延时，</span>
<span class="err">这个参数对于设置了</span><span class="n">candidate_master</span><span class="o">=</span><span class="mi">1</span><span class="err">的主机非常有用，因为这个候选主在切换的过程中一定是新的</span><span class="n">master</span>

<span class="p">[</span><span class="n">server3</span><span class="p">]</span>
<span class="n">hostname</span><span class="o">=</span><span class="mf">192.168.3.132</span>
<span class="n">port</span><span class="o">=</span><span class="mi">3306</span>

<span class="n">vim</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">masterha_secondary_check</span>  <span class="mi">72</span><span class="err">行修改默认</span><span class="n">ssh</span><span class="err">端口</span> 

<span class="err">切换脚本</span><span class="o">:</span>  <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">master_ip_failover</span>   
<span class="p">(</span><span class="err">主</span><span class="n">mysql</span><span class="err">添加</span><span class="n">ifconfig</span> <span class="nl">eth0</span><span class="p">:</span><span class="mi">1</span> <span class="mf">192.168.3.130</span><span class="o">/</span><span class="mi">24</span><span class="p">)</span>

<span class="n">masterha_check_ssh</span> <span class="o">--</span><span class="n">conf</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">masterha</span><span class="o">/</span><span class="n">app1</span><span class="p">.</span><span class="n">cnf</span>   <span class="err">检查</span><span class="n">ssh</span>
<span class="n">masterha_check_repl</span> <span class="o">--</span><span class="n">conf</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">masterha</span><span class="o">/</span><span class="n">app1</span><span class="p">.</span><span class="n">cnf</span>   <span class="err">检查</span><span class="n">mysql</span><span class="err">状态</span>
<span class="n">masterha_check_status</span> <span class="o">--</span><span class="n">conf</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">masterha</span><span class="o">/</span><span class="n">app1</span><span class="p">.</span><span class="n">cnf</span> <span class="err">检查</span><span class="n">MHA</span> <span class="n">Manager</span><span class="err">的状态</span>

<span class="err">确认检查都正常后开启</span><span class="n">MHA</span>
<span class="n">nohup</span> <span class="n">masterha_manager</span> <span class="o">--</span><span class="n">conf</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">masterha</span><span class="o">/</span><span class="n">app1</span><span class="p">.</span><span class="n">cnf</span> <span class="o">--</span><span class="n">remove_dead_master_conf</span> <span class="o">--</span><span class="n">ignore_last_failover</span> <span class="o">&lt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="o">&gt;</span>
 <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">masterha</span><span class="o">/</span><span class="n">mha</span><span class="p">.</span><span class="n">log</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span> <span class="o">&amp;</span>  <span class="err">开启</span><span class="n">MHA</span> <span class="n">Manager</span><span class="err">监控</span>
    <span class="o">--</span><span class="n">remove_dead_master_conf</span>      <span class="err">该参数代表当发生主从切换后，老的主库的</span><span class="n">ip</span><span class="err">将会从配置文件中移除。</span>
<span class="o">--</span><span class="n">manger_log</span>                            <span class="err">日志存放位置</span>
<span class="o">--</span><span class="n">ignore_last_failover</span>                 <span class="err">在缺省情况下，如果</span><span class="n">MHA</span><span class="err">检测到连续发生宕机，且两次宕机间隔不足</span><span class="mi">8</span><span class="err">小时的话，则不会进行</span>
<span class="n">Failover</span><span class="err">，之所以这样限制是为了避免</span><span class="n">ping</span><span class="o">-</span><span class="n">pong</span><span class="err">效应</span>

<span class="err">开启</span><span class="n">MHA</span><span class="err">后不要重启主</span><span class="n">mysql</span><span class="err">，也会导致切换</span>

<span class="n">masterha_stop</span> <span class="o">--</span><span class="n">conf</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">masterha</span><span class="o">/</span><span class="n">app1</span><span class="p">.</span><span class="n">cnf</span>  <span class="err">关闭</span><span class="n">MHA</span> <span class="n">Manage</span><span class="err">监控</span>


<span class="err">之前主库宕机后不要再切换，配置成和新主库主从同步，加入</span><span class="n">mha</span><span class="err">集群，</span>
<span class="err">注意需要运行</span><span class="n">sql</span><span class="err">：</span><span class="n">set</span> <span class="n">global</span> <span class="n">relay_log_purge</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>


<span class="err">模拟测试</span>
  <span class="n">yum</span> <span class="n">install</span> <span class="n">sysbench</span> <span class="err">–</span><span class="n">y</span>
  <span class="n">sysbench</span> <span class="o">--</span><span class="n">test</span><span class="o">=</span><span class="n">oltp</span> <span class="o">--</span><span class="n">oltp</span><span class="o">-</span><span class="n">table</span><span class="o">-</span><span class="n">size</span><span class="o">=</span><span class="mi">1000000</span> <span class="o">--</span><span class="n">oltp</span><span class="o">-</span><span class="n">read</span><span class="o">-</span><span class="n">only</span><span class="o">=</span><span class="n">off</span> <span class="o">--</span><span class="n">init</span><span class="o">-</span><span class="n">rng</span><span class="o">=</span><span class="n">on</span> <span class="o">--</span><span class="n">num</span><span class="o">-</span><span class="n">threads</span><span class="o">=</span><span class="mi">16</span> <span class="o">--</span><span class="n">max</span><span class="o">-</span><span class="n">requests</span><span class="o">=</span><span class="mi">0</span>
   <span class="o">--</span><span class="n">oltp</span><span class="o">-</span><span class="n">dist</span><span class="o">-</span><span class="n">type</span><span class="o">=</span><span class="n">uniform</span> <span class="o">--</span><span class="n">max</span><span class="o">-</span><span class="n">time</span><span class="o">=</span><span class="mi">1800</span> <span class="o">--</span><span class="n">mysql</span><span class="o">-</span><span class="n">user</span><span class="o">=</span><span class="n">root</span> <span class="o">--</span><span class="n">mysql</span><span class="o">-</span><span class="n">socket</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">mysql</span><span class="p">.</span><span class="n">sock</span> 
   <span class="o">--</span><span class="n">mysql</span><span class="o">-</span><span class="n">password</span><span class="o">=</span><span class="mi">1</span> <span class="o">--</span><span class="n">db</span><span class="o">-</span><span class="n">driver</span><span class="o">=</span><span class="n">mysql</span> <span class="o">--</span><span class="n">mysql</span><span class="o">-</span><span class="n">table</span><span class="o">-</span><span class="n">engine</span><span class="o">=</span><span class="n">innodb</span> <span class="o">--</span><span class="n">oltp</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="n">mode</span><span class="o">=</span><span class="n">complex</span> <span class="n">prepare</span>  <span class="err">生成测试数据</span>

  <span class="n">sysbench</span> <span class="o">--</span><span class="n">test</span><span class="o">=</span><span class="n">oltp</span> <span class="o">--</span><span class="n">oltp</span><span class="o">-</span><span class="n">table</span><span class="o">-</span><span class="n">size</span><span class="o">=</span><span class="mi">1000000</span> <span class="o">--</span><span class="n">oltp</span><span class="o">-</span><span class="n">read</span><span class="o">-</span><span class="n">only</span><span class="o">=</span><span class="n">off</span> <span class="o">--</span><span class="n">init</span><span class="o">-</span><span class="n">rng</span><span class="o">=</span><span class="n">on</span> <span class="o">--</span><span class="n">num</span><span class="o">-</span><span class="n">threads</span><span class="o">=</span><span class="mi">16</span> <span class="o">--</span><span class="n">max</span><span class="o">-</span><span class="n">requests</span><span class="o">=</span><span class="mi">0</span> 
  <span class="o">--</span><span class="n">oltp</span><span class="o">-</span><span class="n">dist</span><span class="o">-</span><span class="n">type</span><span class="o">=</span><span class="n">uniform</span> <span class="o">--</span><span class="n">max</span><span class="o">-</span><span class="n">time</span><span class="o">=</span><span class="mi">180</span> <span class="o">--</span><span class="n">mysql</span><span class="o">-</span><span class="n">user</span><span class="o">=</span><span class="n">root</span> <span class="o">--</span><span class="n">mysql</span><span class="o">-</span><span class="n">socket</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">mysql</span><span class="p">.</span><span class="n">sock</span> 
  <span class="o">--</span><span class="n">mysql</span><span class="o">-</span><span class="n">password</span><span class="o">=</span><span class="mi">1</span> <span class="o">--</span><span class="n">db</span><span class="o">-</span><span class="n">driver</span><span class="o">=</span><span class="n">mysql</span> <span class="o">--</span><span class="n">mysql</span><span class="o">-</span><span class="n">table</span><span class="o">-</span><span class="n">engine</span><span class="o">=</span><span class="n">innodb</span> <span class="o">--</span><span class="n">oltp</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="n">mode</span><span class="o">=</span><span class="n">complex</span> <span class="n">run</span>    <span class="err">压力测试</span>
</pre></div>


<h2 id="mysql_1">mysql优化</h2>
<div class="codehilite"><pre><span></span><span class="nv">mysql</span>调优

<span class="nv">clint</span><span class="o">---&gt;</span> <span class="nv">httpd</span><span class="o">---&gt;</span> <span class="nv">php</span> <span class="o">---&gt;</span><span class="nv">mysql</span>

解压缩： <span class="nv">tar</span> <span class="nv">fzxv</span> <span class="nv">mysqlreport</span><span class="o">-</span><span class="mi">3</span>.<span class="mi">5</span>.<span class="nv">tgz</span> <span class="ss">(</span>汇报工具，通过这个工具可以观察到一些数据<span class="ss">)</span>
    <span class="nv">cd</span> <span class="nv">mysqlreport</span><span class="o">-</span><span class="mi">3</span>.<span class="mi">5</span>
    <span class="nv">cp</span> <span class="nv">mysqlreport</span> <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">bin</span>
    <span class="nv">mysqlreport</span>  <span class="o">--</span><span class="nv">user</span> <span class="nv">root</span> <span class="o">--</span><span class="nv">password</span> <span class="mi">123</span> <span class="ss">(</span>有用户名和密码的前提下<span class="ss">)</span>
    #<span class="nv">yum</span> <span class="nv">serach</span>  <span class="nv">DBI</span> <span class="o">-</span><span class="nv">y</span>
    #<span class="nv">yum</span> <span class="nv">install</span> <span class="nv">perl</span><span class="o">-</span><span class="nv">DBD</span><span class="o">-</span><span class="nv">MySQL</span> <span class="o">-</span><span class="nv">y</span>
           <span class="nv">mysqlreport</span> <span class="o">--</span><span class="nv">outfile</span> <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">mysql</span> 写入到文件中
    <span class="nv">vim</span> <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">mysql</span>
<span class="nv">Myisam</span>引擎
    \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
    <span class="nv">Key</span><span class="o">----&gt;</span><span class="nv">Mysam</span>引擎的索引
    <span class="nv">Read</span> <span class="nv">hit</span> <span class="o">----&gt;</span>命中率（越高代表着效率很高）
    调整<span class="nv">key_buffer</span> 
    方法<span class="mi">1</span>：
    <span class="k">show</span> <span class="nv">variables</span> <span class="nv">like</span> <span class="s1">&#39;</span><span class="s">%key%</span><span class="s1">&#39;</span><span class="c1">;</span>
    <span class="nv">set</span> <span class="nv">global</span> <span class="nv">key_buffer_size</span><span class="o">=</span><span class="mi">16777216</span><span class="c1">;</span>
    方法<span class="mi">2</span>：必须要重新启动服务
    <span class="nv">vim</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">my</span>.<span class="nv">cnf</span>
    <span class="nv">key_buffer_size</span><span class="o">=</span><span class="mi">16777216</span>
    \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
    <span class="nv">Qusetion</span>
        <span class="nv">Total</span> 分类
        <span class="nv">DMS</span>        由增、删、改、查、替换

        <span class="nv">Slow</span> <span class="mi">10</span> <span class="nv">s</span>  当你的工作在<span class="mi">10</span><span class="nv">S</span>内没有完成，即作慢查询
        <span class="nv">vim</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">my</span>.<span class="nv">cnf</span>
        <span class="nv">log</span><span class="o">-</span><span class="nv">slow</span><span class="o">-</span><span class="nv">queries</span><span class="o">=/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">slow</span>.<span class="nv">log</span> 慢速日志存放的位置
         <span class="nv">long</span><span class="o">-</span><span class="nv">query</span><span class="o">-</span><span class="nv">time</span><span class="o">=</span><span class="mi">20</span>          超出多长时间算作慢速查询
        注：如果没有必要去定位<span class="nv">slow</span>，就不需要开启，因为开启会增加<span class="nv">IO</span>

        <span class="nv">Qc</span> <span class="nv">Hits</span>    查询缓存 
        调整<span class="nv">Query</span> <span class="nv">Cache</span>
        <span class="k">show</span> <span class="nv">variables</span> <span class="nv">like</span> <span class="s1">&#39;</span><span class="s">%query%</span><span class="s1">&#39;</span><span class="c1">;</span>
        <span class="nv">set</span> <span class="nv">global</span> <span class="nv">query_cache_size</span><span class="o">=</span><span class="mi">8384512</span><span class="c1">;</span>
        <span class="nv">mysqlreport</span>
    \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
    <span class="nv">SELECT</span> <span class="nv">and</span> <span class="nv">Sort</span> 
          <span class="nv">Sort</span> 用来作排序的内存多大，他对应的是每一个线程
        <span class="nv">mysql</span>是以线程方式工作的，这个数值设置大了，可以增加排序的效率
        <span class="k">show</span> <span class="nv">variables</span> <span class="nv">like</span> <span class="s1">&#39;</span><span class="s">%sort%</span><span class="s1">&#39;</span><span class="c1">;</span>
        <span class="nv">set</span> <span class="nv">global</span> <span class="nv">sort_buffer_size</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">2097144</span><span class="s1">&#39;</span><span class="c1">;</span>
    \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
    <span class="nv">Table</span> <span class="nv">locks</span>
        <span class="nv">Waited</span>  这个数值越小越好
        <span class="k">show</span> <span class="nv">full</span> <span class="nv">processlist</span><span class="c1">;</span>
    \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
    <span class="nv">Tables</span>    增快表访问的速度
        <span class="nv">open</span>     当前打开了多少表
        <span class="nv">opend</span>     一共打开了多少表
        <span class="k">show</span> <span class="nv">variables</span> <span class="nv">like</span> <span class="s1">&#39;</span><span class="s">%table%</span><span class="s1">&#39;</span><span class="c1">;</span>
        <span class="nv">table_cache</span>
        <span class="nv">set</span> <span class="nv">global</span> <span class="nv">table_cache</span><span class="o">=</span><span class="mi">128</span><span class="c1">; 把表的文件描述符写入到内存中了</span>
    \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
    <span class="nv">Connections</span>
        <span class="nv">Max</span> <span class="nv">used</span>  最大连接数
        <span class="k">show</span> <span class="nv">variables</span> <span class="nv">like</span> <span class="s1">&#39;</span><span class="s">%max%</span><span class="s1">&#39;</span><span class="c1">;</span>
        <span class="nv">set</span> <span class="nv">global</span> <span class="nv">max_connections</span><span class="o">=</span><span class="mi">100</span><span class="c1">;</span>
    \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
    <span class="nv">Created</span> <span class="nv">Temp</span>    创建临时表（排序、索引）
        <span class="k">show</span> <span class="nv">variables</span> <span class="nv">like</span> <span class="s1">&#39;</span><span class="s">%tmp%</span><span class="s1">&#39;</span><span class="c1">;</span>
        <span class="nv">tmpdir</span>    <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span>  临时表创建的位置
        <span class="nv">tmp_table_size</span> 如果创建临时表的大小超过<span class="mi">32</span><span class="nv">M</span>将会把数据写入到磁盘中
        <span class="nv">Disk</span> <span class="nv">table</span> 值变大的时候
        解决方法：<span class="mi">1</span>、增大临时表的大小 <span class="mi">2</span>、优化查询语句
    \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
    <span class="nv">Threads</span>    线程缓存，减少从需要到产生的时间
        <span class="k">show</span> <span class="nv">variables</span> <span class="nv">like</span> <span class="s1">&#39;</span><span class="s">%thread%</span><span class="s1">&#39;</span><span class="c1">;</span>
        <span class="nv">thread_cache_size</span>
    \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
    <span class="nv">Bytes</span>    和网络相关的
        <span class="nv">Sent</span>        发送的流量
        <span class="nv">Recevied</span>    接收的流量
        单位是：<span class="nv">B</span>

<span class="nv">InnoDB</span>引擎  
    \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
    <span class="nv">InnoDB</span> <span class="nv">Buffer</span> <span class="nv">Pool</span> 
    <span class="nv">Usage</span>    越大越好
    <span class="k">show</span> <span class="nv">variables</span> <span class="nv">like</span> <span class="s1">&#39;</span><span class="s">%innodb%</span><span class="s1">&#39;</span><span class="c1">;</span>
    <span class="nv">set</span> <span class="nv">global</span> <span class="nv">innodb_buffer_pool_size</span><span class="o">=</span><span class="mi">8388608</span><span class="c1">;</span>
    注：建议大小设置为整个内存的<span class="mi">80</span><span class="o">%</span>
    <span class="nv">Pages</span>    单位：<span class="mi">16</span><span class="nv">K</span>
    \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
<span class="nv">InnoDB</span>与网络
    <span class="nv">back_log</span> 请求队列中能够排队的大小，如果增大并发数，则这个数必须要调大
    <span class="nv">tcp</span>.<span class="nv">max_syn_backlog</span>
    <span class="nv">somaxconn</span>

    一次消息传输量的最大值
    <span class="k">show</span> <span class="nv">variables</span> <span class="nv">like</span> <span class="s1">&#39;</span><span class="s">%max_allowed_packet%</span><span class="s1">&#39;</span><span class="c1">;</span>
    <span class="nv">default</span> <span class="mi">1</span><span class="nv">M</span>

    <span class="k">show</span> <span class="nv">variables</span> <span class="nv">like</span> <span class="s1">&#39;</span><span class="s">%timeout%</span><span class="s1">&#39;</span><span class="c1">;</span>
    <span class="nv">connect_timeout</span>     连线时的超时时间

    <span class="nv">interactive_timeout</span> 处于回会话空闲的<span class="nb">timeout</span>，连接上来什么都不执行的超时时间
    <span class="nv">wait_timeout</span> 

    <span class="nv">net_read_timeout</span>
    <span class="nv">net_write_timeout</span>  处于数据交互阶段超时时间 
    \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
<span class="nv">Innodb</span>与<span class="nv">IO</span>相关的
    <span class="k">show</span> <span class="nv">variables</span> <span class="nv">like</span> <span class="s1">&#39;</span><span class="s">%innodb_flush_log%</span><span class="s1">&#39;</span><span class="c1">;</span>
    <span class="nv">innodb_flush_log_at_trx_commit</span>
    <span class="mi">0</span> 最不安全，但是效率是最高，每隔一秒钟会把数据写入到硬盘上，如果断电或者数据库服务坏了，数据就丢失了
    <span class="mi">1</span> 最安全，数据会时时的写到硬盘上
    <span class="mi">2</span> 先写到操作系统的内存中，再写入到磁盘中，<span class="nv">mysql</span>进程死了，数据不丢，但是断电了，数据就丢失了

    绕过操作系统的缓存，直接将数据写入到磁盘中，好处是节省了内存
    <span class="nv">vim</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">my</span>.<span class="nv">cnf</span>
    <span class="nv">innodb_flush_medthod</span><span class="o">=</span><span class="nv">O_DIRECT</span>
    <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">init</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">mysqld</span> <span class="nv">restart</span>
    \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
<span class="nv">InnoDB</span>与<span class="nv">cpu</span>
    主频高
    核心
    <span class="nv">taskset</span> 绑定



<span class="nv">select</span> <span class="nv">table_schema</span> <span class="nv">as</span> <span class="s1">&#39;</span><span class="s">DBname</span><span class="s1">&#39;</span>, <span class="nv">sum</span><span class="ss">(</span><span class="nv">data_length</span> <span class="o">+</span> <span class="nv">index_length</span><span class="ss">)</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">/</span> <span class="mi">1024</span>  <span class="nv">as</span> <span class="s1">&#39;</span><span class="s">DB size(MB)</span><span class="s1">&#39;</span>, <span class="nv">sum</span><span class="ss">(</span><span class="nv">data_free</span><span class="ss">)</span> 
<span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span>  <span class="nv">as</span> <span class="s1">&#39;</span><span class="s">free space (MB)</span><span class="s1">&#39;</span> <span class="nv">from</span> <span class="nv">information_schema</span>.<span class="nv">tables</span> <span class="nv">group</span> <span class="nv">by</span> <span class="nv">table_schema</span><span class="c1">;</span>


<span class="nv">mysql</span>  <span class="nv">vm</span> 
<span class="nv">ey_buffer</span>  <span class="ss">(</span><span class="nv">myisam</span><span class="ss">)</span>
<span class="nv">query_cache_size</span> 
<span class="nv">sort_buffer_size</span>
<span class="nv">table_cache</span>
<span class="nv">tmp_table_size</span>
<span class="nv">thread_cache_size</span>
<span class="nv">innodb_buffer_pool_size</span> <span class="ss">(</span><span class="nv">innodb</span><span class="ss">)</span>


<span class="nv">mysql</span> <span class="nv">net</span>

<span class="nv">back_log</span>
<span class="nv">max_connections</span>
<span class="o">/</span><span class="nv">proc</span><span class="o">/</span><span class="nv">sys</span><span class="o">/</span><span class="nv">net</span><span class="o">/</span><span class="nv">core</span><span class="o">/</span><span class="nv">somaxconn</span>
<span class="o">/</span><span class="nv">proc</span><span class="o">/</span><span class="nv">sys</span><span class="o">/</span><span class="nv">net</span><span class="o">/</span><span class="nv">ipv4</span><span class="o">/</span><span class="nv">tcp_max_syn_backlog</span>

<span class="nv">connect_timeout</span>     连线时的超时时间

<span class="nv">interactive_timeout</span> 处于回会话空闲的<span class="nb">timeout</span>，连接上来什么都不执行的超时时间
<span class="nv">wait_timeout</span> 

<span class="nv">net_read_timeout</span>
<span class="nv">net_write_timeout</span>  处于数据交互阶段超时时间 

<span class="nv">max_allowed_packet</span>  <span class="ss">(</span><span class="mi">1</span><span class="nv">M</span><span class="ss">)</span>



<span class="nv">mysql</span> <span class="nv">io</span>
<span class="nv">innodb_flush_log_at_trx_commit</span>
    <span class="mi">0</span> 最不安全，但是效率是最高，每隔一秒钟会把数据写入到硬盘上，如果断电或者数据库服务坏了，数据就丢失了
    <span class="mi">1</span> 最安全，数据会时时的写到硬盘上
    <span class="mi">2</span> 先写到操作系统的内存中，再写入到磁盘中，<span class="nv">mysql</span>进程死了，数据不丢，但是断电了，数据就丢失了


<span class="nv">innodb_flush_medthod</span><span class="o">=</span><span class="nv">O_DIRECT</span>



<span class="nv">mysql</span> <span class="nv">cpu</span>
</pre></div>


<h2 id="_11">编码</h2>
<div class="codehilite"><pre><span></span>查看   <span class="k">show</span> <span class="nv">variables</span> <span class="nv">like</span> <span class="s2">&quot;</span><span class="s">%char%</span><span class="s2">&quot;</span><span class="c1">;</span>
          <span class="k">SHOW</span> <span class="nv">VARIABLES</span> <span class="nv">LIKE</span> <span class="s1">&#39;</span><span class="s">character_set_%</span><span class="s1">&#39;</span><span class="c1">;</span>
          <span class="k">SHOW</span> <span class="nv">VARIABLES</span> <span class="nv">LIKE</span> <span class="s1">&#39;</span><span class="s">collation_%</span><span class="s1">&#39;</span><span class="c1">;</span>


<span class="nv">SET</span> <span class="nv">NAMES</span> <span class="s1">&#39;</span><span class="s">utf8</span><span class="s1">&#39;</span><span class="c1">;</span>
它相当于下面的三句指令：
<span class="nv">SET</span> <span class="nv">character_set_client</span> <span class="o">=</span> <span class="nv">utf8</span><span class="c1">;</span>
<span class="nv">SET</span> <span class="nv">character_set_results</span> <span class="o">=</span> <span class="nv">utf8</span><span class="c1">;</span>
<span class="nv">SET</span> <span class="nv">character_set_connection</span> <span class="o">=</span> <span class="nv">utf8</span><span class="c1">;</span>

创建数据库
<span class="nv">mysql</span><span class="o">&gt;</span> <span class="nv">create</span> <span class="nv">database</span> <span class="nv">name</span> <span class="nv">character</span> <span class="nv">set</span> <span class="nv">utf8</span><span class="c1">;</span>

创建表
<span class="nv">CREATE</span> <span class="nv">TABLE</span> `<span class="nv">type</span>` <span class="ss">(</span>
`<span class="nv">id</span>` <span class="nv">int</span><span class="ss">(</span><span class="mi">10</span><span class="ss">)</span> <span class="nv">unsigned</span> <span class="nv">NOT</span> <span class="nv">NULL</span> <span class="nv">auto_increment</span>,
`<span class="nv">flag_deleted</span>` <span class="nv">enum</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">Y</span><span class="s1">&#39;</span>,<span class="s1">&#39;</span><span class="s">N</span><span class="s1">&#39;</span><span class="ss">)</span> <span class="nv">character</span> <span class="nv">set</span> <span class="nv">utf8</span> <span class="nv">NOT</span> <span class="nv">NULL</span> <span class="nv">default</span> <span class="s1">&#39;</span><span class="s">N</span><span class="s1">&#39;</span>,
`<span class="nv">flag_type</span>` <span class="nv">int</span><span class="ss">(</span><span class="mi">5</span><span class="ss">)</span> <span class="nv">NOT</span> <span class="nv">NULL</span> <span class="nv">default</span> <span class="s1">&#39;</span><span class="s">0</span><span class="s1">&#39;</span>,
`<span class="nv">type_name</span>` <span class="nv">varchar</span><span class="ss">(</span><span class="mi">50</span><span class="ss">)</span> <span class="nv">character</span> <span class="nv">set</span> <span class="nv">utf8</span> <span class="nv">NOT</span> <span class="nv">NULL</span> <span class="nv">default</span> <span class="s1">&#39;&#39;</span>,
<span class="nv">PRIMARY</span> <span class="nv">KEY</span> <span class="ss">(</span>`<span class="nv">id</span>`<span class="ss">)</span>
<span class="ss">)</span> <span class="nv">DEFAULT</span> <span class="nv">CHARSET</span><span class="o">=</span><span class="nv">utf8</span><span class="c1">;</span>

修改数据库成<span class="nv">utf8</span>的.
<span class="nv">mysql</span><span class="o">&gt;</span> <span class="nv">alter</span> <span class="nv">database</span> <span class="nv">name</span> <span class="nv">character</span> <span class="nv">set</span> <span class="nv">utf8</span><span class="c1">;</span>

 修改表默认用<span class="nv">utf8</span>.
<span class="nv">mysql</span><span class="o">&gt;</span> <span class="nv">alter</span> <span class="nv">table</span> <span class="nv">type</span> <span class="nv">character</span> <span class="nv">set</span> <span class="nv">utf8</span><span class="c1">;</span>

修改字段用<span class="nv">utf8</span>
<span class="nv">mysql</span><span class="o">&gt;</span> <span class="nv">alter</span> <span class="nv">table</span> <span class="nv">type</span> <span class="nv">modify</span> <span class="nv">type_name</span> <span class="nv">varchar</span><span class="ss">(</span><span class="mi">50</span><span class="ss">)</span> <span class="nv">CHARACTER</span> <span class="nv">SET</span> <span class="nv">utf8</span><span class="c1">;</span>

<span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">my</span>.<span class="nv">cnf</span>
<span class="o">--</span>在 [<span class="nv">mysqld</span>] 标签下加上三行
<span class="nv">character</span><span class="o">-</span><span class="nv">set</span><span class="o">-</span><span class="nv">server</span><span class="o">=</span><span class="nv">utf8</span>
#####<span class="nv">default</span><span class="o">-</span><span class="nv">character</span><span class="o">-</span><span class="nv">set</span><span class="o">=</span><span class="nv">utf8</span><span class="ss">(</span>旧版本<span class="ss">)</span>
<span class="nv">lower_case_table_names</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">//</span>表名不区分大小写（此与编码无关）

<span class="o">--</span>在 [<span class="nv">mysql</span>] 标签下加上一行
<span class="nv">default</span><span class="o">-</span><span class="nv">character</span><span class="o">-</span><span class="nv">set</span> <span class="o">=</span> <span class="nv">utf8</span>

<span class="o">--</span>在 [<span class="nv">mysql</span>.<span class="nv">server</span>]标签下加上一行
<span class="nv">default</span><span class="o">-</span><span class="nv">character</span><span class="o">-</span><span class="nv">set</span> <span class="o">=</span> <span class="nv">utf8</span>

<span class="o">--</span>在 [<span class="nv">mysqld_safe</span>]标签下加上一行
<span class="nv">default</span><span class="o">-</span><span class="nv">character</span><span class="o">-</span><span class="nv">set</span> <span class="o">=</span> <span class="nv">utf8</span>

<span class="o">--</span>在 [<span class="nv">client</span>]标签下加上一行
<span class="nv">default</span><span class="o">-</span><span class="nv">character</span><span class="o">-</span><span class="nv">set</span> <span class="o">=</span> <span class="nv">utf8</span>
重新启动<span class="nv">MySql</span>服务
</pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../log-analysis/" title="log-analysis" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                log-analysis
              </span>
            </div>
          </a>
        
        
          <a href="../mysql2/" title="mysql2" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                mysql2
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>