



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>saltstack - mkdocs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.30686662.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#status" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="mkdocs" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              mkdocs
            </span>
            <span class="md-header-nav__topic">
              
                saltstack
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href=".." class="md-tabs__link">
        home
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../python-base/" class="md-tabs__link">
          python
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../nginx/" class="md-tabs__link md-tabs__link--active">
          service
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../mysql/" class="md-tabs__link">
          database
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../open-falcon/" class="md-tabs__link">
          monitor
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../tcp-issue/" class="md-tabs__link">
          basis
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="mkdocs" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    mkdocs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="home" class="md-nav__link">
      home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      python
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        python
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../python-base/" title="python-base" class="md-nav__link">
      python-base
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-lib/" title="python-lib" class="md-nav__link">
      python-lib
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-lib2/" title="python-lib2" class="md-nav__link">
      python-lib2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-web/" title="python-web" class="md-nav__link">
      python-web
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-other/" title="python-other" class="md-nav__link">
      python-other
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      service
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        service
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../nginx/" title="nginx" class="md-nav__link">
      nginx
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../nginx2/" title="nginx2" class="md-nav__link">
      nginx2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../apache/" title="apache" class="md-nav__link">
      apache
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        saltstack
      </label>
    
    <a href="./" title="saltstack" class="md-nav__link md-nav__link--active">
      saltstack
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#status" class="md-nav__link">
    status
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pillar" class="md-nav__link">
    pillar
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#job" class="md-nav__link">
    job
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#return" class="md-nav__link">
    return存储结果
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api-web" class="md-nav__link">
    api web
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#beacons" class="md-nav__link">
    beacons
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zabbix_agent" class="md-nav__link">
    安装zabbix_agent
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#salt" class="md-nav__link">
    显示salt进程具体名称
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#salt_1" class="md-nav__link">
    salt安装
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#minion-id" class="md-nav__link">
    修改minion id
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#event" class="md-nav__link">
    event和反射
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    帮助文档
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#grains" class="md-nav__link">
    grains
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules" class="md-nav__link">
    modules
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zmq" class="md-nav__link">
    zmq
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tomcat/" title="tomcat" class="md-nav__link">
      tomcat
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ansible/" title="ansible" class="md-nav__link">
      ansible
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../trafficserver/" title="trafficserver" class="md-nav__link">
      trafficserver
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../haproxy/" title="haproxy" class="md-nav__link">
      haproxy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../docker/" title="docker" class="md-nav__link">
      docker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../varnish/" title="varnish" class="md-nav__link">
      varnish
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../bind/" title="bind" class="md-nav__link">
      bind
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lvs/" title="lvs" class="md-nav__link">
      lvs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../log-analysis/" title="log-analysis" class="md-nav__link">
      log-analysis
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      database
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        database
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../mysql/" title="mysql" class="md-nav__link">
      mysql
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mysql2/" title="mysql2" class="md-nav__link">
      mysql2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../memcached/" title="memcached" class="md-nav__link">
      memcached
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../redis/" title="redis" class="md-nav__link">
      redis
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mongodb/" title="mongodb" class="md-nav__link">
      mongodb
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../hadoop/" title="hadoop" class="md-nav__link">
      hadoop
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../postgresql/" title="postgresql" class="md-nav__link">
      postgresql
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      monitor
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        monitor
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../open-falcon/" title="open-falcon" class="md-nav__link">
      open-falcon
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zabbix/" title="zabbix" class="md-nav__link">
      zabbix
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zabbix2/" title="zabbix2" class="md-nav__link">
      zabbix2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../netdata/" title="netdata" class="md-nav__link">
      netdata
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      basis
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        basis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../tcp-issue/" title="tcp-issue" class="md-nav__link">
      tcp-issue
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../git-svn/" title="git-svn" class="md-nav__link">
      git-svn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../vpn/" title="vpn" class="md-nav__link">
      vpn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../shell/" title="shell" class="md-nav__link">
      shell
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../disk/" title="disk" class="md-nav__link">
      disk
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../filesystem/" title="filesystem" class="md-nav__link">
      filesystem
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../source/" title="source" class="md-nav__link">
      source
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../command/" title="command" class="md-nav__link">
      command
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../linux-base/" title="linux-base" class="md-nav__link">
      linux-base
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../linux-soft/" title="linux-soft" class="md-nav__link">
      linux-soft
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../other/" title="other" class="md-nav__link">
      other
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#status" class="md-nav__link">
    status
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pillar" class="md-nav__link">
    pillar
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#job" class="md-nav__link">
    job
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#return" class="md-nav__link">
    return存储结果
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api-web" class="md-nav__link">
    api web
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#beacons" class="md-nav__link">
    beacons
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zabbix_agent" class="md-nav__link">
    安装zabbix_agent
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#salt" class="md-nav__link">
    显示salt进程具体名称
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#salt_1" class="md-nav__link">
    salt安装
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#minion-id" class="md-nav__link">
    修改minion id
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#event" class="md-nav__link">
    event和反射
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    帮助文档
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#grains" class="md-nav__link">
    grains
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modules" class="md-nav__link">
    modules
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zmq" class="md-nav__link">
    zmq
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>saltstack</h1>
                
                <h2 id="status">status</h2>
<div class="codehilite"><pre><span></span>$<span class="nv">ID</span>:               定义<span class="nv">state</span>的名称，通常采用与描述的对象保持一致的方法，如<span class="nv">apache</span>、<span class="nv">nginx</span>等
   $<span class="nv">State</span>:      须管理对象的类型，详见<span class="nv">http</span>:<span class="o">//</span><span class="nv">docs</span>.<span class="nv">saltstack</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">ref</span><span class="o">/</span><span class="nv">states</span><span class="o">/</span><span class="nv">all</span><span class="o">/</span><span class="nv">index</span>.<span class="nv">html</span>
      <span class="o">-</span> $<span class="nv">state</span>: <span class="nv">states</span>      定制对象的状态

<span class="nv">salt</span> \<span class="o">*</span> <span class="nv">state</span>.<span class="nv">sls</span> <span class="nv">dhcp</span>   使用
<span class="nv">salt</span> \<span class="o">*</span> <span class="nv">state</span>.<span class="nv">sls</span> <span class="nv">dhcp</span><span class="o">/</span><span class="nv">aaa</span>   使用<span class="nv">dhcp</span>目录下的<span class="nv">aaa</span>.<span class="nv">sls</span>
<span class="nv">salt</span> \<span class="o">*</span> <span class="nv">state</span>.<span class="nv">sls</span> <span class="nv">dhcp</span> <span class="nv">test</span><span class="o">=</span><span class="nv">True</span>   测试，不会修改<span class="nv">minion</span>
<span class="nv">salt</span> \<span class="o">*</span> <span class="nv">state</span>.<span class="nv">highstate</span>

<span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">python2</span>.<span class="mi">6</span><span class="o">/</span><span class="nv">site</span><span class="o">-</span><span class="nv">packages</span><span class="o">/</span><span class="nv">salt</span><span class="o">/</span><span class="nv">states</span>        映射到<span class="nv">modules</span>
<span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">python2</span>.<span class="mi">6</span><span class="o">/</span><span class="nv">site</span><span class="o">-</span><span class="nv">packages</span><span class="o">/</span><span class="nv">salt</span><span class="o">/</span><span class="nv">modules</span>
如果使用<span class="nv">states</span>，需要在<span class="o">/</span><span class="nv">srv</span><span class="o">/</span><span class="nv">salt</span> 下编写<span class="nv">sls</span>文件
<span class="nv">state</span>
确定你的文件路径
<span class="nv">file_roots</span>:
  <span class="nv">base</span>:
    <span class="o">-</span> <span class="o">/</span><span class="nv">srv</span><span class="o">/</span><span class="nv">salt</span>
保证你有入口文件
<span class="nv">state</span>文件包

<span class="nv">vim</span> <span class="o">/</span><span class="nv">srv</span><span class="o">/</span><span class="nv">salt</span><span class="o">/</span><span class="nv">dhcp</span><span class="o">/</span><span class="nv">init</span>.<span class="nv">sls</span>
<span class="k">include</span>:
  <span class="o">-</span> <span class="nv">dhcp</span>.<span class="nv">python_devel</span>        包含<span class="nv">dhcp</span>目录下的<span class="nv">python_devel</span>.<span class="nv">sls</span>
<span class="nv">cat</span> <span class="o">/</span><span class="nv">srv</span><span class="o">/</span><span class="nv">salt</span><span class="o">/</span><span class="nv">dhcp</span><span class="o">/</span><span class="nv">python_devel</span>.<span class="nv">sls</span>
<span class="nv">dhcp</span>:
  <span class="nv">pkg</span>.<span class="nv">installed</span>
<span class="nv">salt</span> \<span class="o">*</span> <span class="nv">state</span>.<span class="nv">sls</span> <span class="nv">dhcp</span>


[<span class="nv">root</span>@<span class="nv">node1</span> <span class="nv">salt</span>]# <span class="nv">cat</span> <span class="nv">top</span>.<span class="nv">sls</span>
<span class="nv">base</span>:
  <span class="s1">&#39;</span><span class="s">*</span><span class="s1">&#39;</span>:
    <span class="o">-</span> <span class="nv">test</span>
找<span class="nv">test</span>.<span class="nv">sls</span>
<span class="nv">test</span>是一个<span class="nv">sls</span>文件的名字 或者是一个目录的名字（该目录下必须有<span class="nv">init</span>.<span class="nv">sls</span>这个文件）
[<span class="nv">root</span>@<span class="nv">node1</span> <span class="nv">salt</span>]# <span class="nv">cat</span> <span class="nv">test</span>.<span class="nv">sls</span>
<span class="nv">httpd</span>: #<span class="nv">id</span><span class="ss">(</span>默认这个位置对应的是<span class="nv">name</span>的值<span class="ss">)</span>
  <span class="nv">pkg</span>: #<span class="nv">state</span>
    <span class="o">-</span> <span class="nv">installed</span> #<span class="nv">state</span>的函数

<span class="nv">state</span>目录
<span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">python2</span>.<span class="mi">6</span><span class="o">/</span><span class="nv">site</span><span class="o">-</span><span class="nv">packages</span><span class="o">/</span><span class="nv">salt</span><span class="o">/</span><span class="nv">states</span>
使用该<span class="nv">state</span>
<span class="nv">salt</span> <span class="s1">&#39;</span><span class="s">node2</span><span class="s1">&#39;</span> <span class="nv">state</span>.<span class="nv">highstate</span>

<span class="nv">sls</span>文件的中的任务执行顺序可以使用关键字控制（<span class="nv">require</span>）
<span class="nv">httpd</span>:        <span class="nv">ID</span>
  <span class="nv">pkg</span>:        <span class="nv">states</span>模块
    <span class="o">-</span> <span class="nv">installed</span>        模块的函数
  <span class="nv">service</span>.<span class="nv">running</span>:
    <span class="o">-</span> <span class="nv">require</span>:        需要，依赖
      <span class="o">-</span> <span class="nv">pkg</span>: <span class="nv">httpd</span>
指定执行某一个<span class="nv">sls</span>文件（文件的扩展名.<span class="nv">sls</span>不需要写出来）
[<span class="nv">root</span>@<span class="nv">node1</span> <span class="nv">salt</span>]# <span class="nv">salt</span> <span class="s1">&#39;</span><span class="s">node2</span><span class="s1">&#39;</span> <span class="nv">state</span>.<span class="nv">sls</span> <span class="nv">test</span>
针对配置文件设置监听，实现自动重启
###############################################
<span class="nv">httpd</span>:
  <span class="nv">pkg</span>:
    <span class="o">-</span> <span class="nv">installed</span>
  <span class="nv">service</span>:
    <span class="o">-</span> <span class="nv">running</span>
    <span class="o">-</span> <span class="nv">require</span>:
      <span class="o">-</span> <span class="nv">pkg</span>: <span class="nv">httpd</span>
    <span class="o">-</span> <span class="nv">watch</span>:            观察，文件有变化就启动
      <span class="o">-</span> <span class="nv">file</span>: <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">httpd</span><span class="o">/</span><span class="nv">conf</span><span class="o">/</span><span class="nv">httpd</span>.<span class="nv">conf</span>
<span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">httpd</span><span class="o">/</span><span class="nv">conf</span><span class="o">/</span><span class="nv">httpd</span>.<span class="nv">conf</span>:
  <span class="nv">file</span>:
    <span class="o">-</span> <span class="nv">managed</span>
    <span class="o">-</span> <span class="nv">source</span>: <span class="nv">salt</span>:<span class="o">//</span><span class="nv">httpd</span>.<span class="nv">conf</span>
    <span class="o">-</span> <span class="nv">require</span>:
      <span class="o">-</span> <span class="nv">pkg</span>: <span class="nv">httpd</span>
################################################
<span class="nv">apache</span>:
  <span class="nv">pkg</span>:
    <span class="o">-</span> <span class="nv">name</span>: <span class="nv">httpd</span>
    <span class="o">-</span> <span class="nv">installed</span>

  <span class="nv">service</span>.<span class="nv">running</span>:
    <span class="o">-</span> <span class="nv">name</span>: <span class="nv">httpd</span>
    <span class="o">-</span> <span class="nv">require</span>:
      <span class="o">-</span> <span class="nv">pkg</span>: <span class="nv">httpd</span>
    <span class="o">-</span> <span class="nv">watch</span>:
      <span class="o">-</span> <span class="nv">file</span>: <span class="nv">apache_config</span>

<span class="nv">apache_config</span>:
  <span class="nv">file</span>.<span class="nv">managed</span>:
    <span class="o">-</span> <span class="nv">name</span>: <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">httpd</span><span class="o">/</span><span class="nv">conf</span><span class="o">/</span><span class="nv">httpd</span>.<span class="nv">conf</span>
<span class="o">-</span> <span class="nv">source</span>: <span class="nv">salt</span>:<span class="o">//</span><span class="nv">httpd</span>.<span class="nv">conf</span>
<span class="o">-</span> <span class="nv">template</span>: <span class="nv">jinja</span>    在<span class="nv">apache_config</span>控制的文件用<span class="nv">jinja</span>渲染
    <span class="o">-</span> <span class="nv">require</span>:
      <span class="o">-</span> <span class="nv">pkg</span>: <span class="nv">httpd</span>

<span class="nv">httpd</span>.<span class="nv">conf</span>




<span class="mi">1</span>、    安装软件包
<span class="mi">2</span>、    修改配置文件
<span class="mi">3</span>、    启动服务
<span class="nv">https</span>:<span class="o">//</span><span class="nv">docs</span>.<span class="nv">saltstack</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">en</span><span class="o">/</span><span class="nv">latest</span><span class="o">/</span><span class="nv">ref</span><span class="o">/</span><span class="nv">states</span><span class="o">/</span><span class="nv">all</span><span class="o">/</span><span class="nv">index</span>.<span class="nv">html</span>

<span class="nv">vim</span> <span class="nv">user</span>.<span class="nv">sls</span>
{<span class="o">%</span><span class="k">for</span> <span class="nv">user</span> <span class="nv">in</span> [<span class="s1">&#39;</span><span class="s">test1</span><span class="s1">&#39;</span>,<span class="s1">&#39;</span><span class="s">test1</span><span class="s1">&#39;</span>,<span class="s1">&#39;</span><span class="s">test3</span><span class="s1">&#39;</span>,<span class="s1">&#39;</span><span class="s">test4</span><span class="s1">&#39;</span>]<span class="o">%</span>}        渲染
{{<span class="nv">user</span>}}:                                    变量
<span class="nv">user</span>.<span class="nv">present</span>
{<span class="o">%</span><span class="nv">endfor</span><span class="o">%</span>}                                结束（如果是<span class="k">if</span> 为<span class="k">endif</span>）

一次调用多个<span class="nv">sls</span>文件
<span class="nv">vim</span> <span class="o">/</span><span class="nv">srv</span><span class="o">/</span><span class="nv">salt</span><span class="o">/</span><span class="nv">top</span>.<span class="nv">sls</span>
<span class="nv">base</span>:
  ‘<span class="o">*</span>’
<span class="o">-</span>    <span class="nv">user</span>
<span class="o">-</span>    <span class="nv">apache_start</span>
<span class="nv">salt</span> \<span class="o">*</span> <span class="nv">state</span>.<span class="nv">highstate</span>


源码安装<span class="nv">nginx</span>
<span class="nv">nginx_source</span>:
 <span class="nv">file</span>.<span class="nv">recurse</span>:    # <span class="nv">file</span>.<span class="nv">managed</span>:用于单文件，<span class="nv">file</span>.<span class="nv">recurse</span>用于目录
  <span class="o">-</span> <span class="nv">name</span>: <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span>
  <span class="o">-</span> <span class="nv">source</span>: <span class="nv">salt</span>:<span class="o">//</span><span class="nv">nginx</span><span class="o">/</span>
<span class="nv">extract_nginx</span>:
<span class="nv">cmd</span>.<span class="nv">run</span>:
  <span class="o">-</span> <span class="nv">cwd</span>: <span class="o">/</span><span class="nv">tmp</span>
  <span class="o">-</span> <span class="nv">names</span>:                # 多命令用<span class="nv">names</span>，单命令用<span class="nv">name</span>
    <span class="o">-</span> <span class="nv">tar</span> <span class="nv">xf</span> <span class="nv">nginx</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">6</span>.<span class="mi">2</span>.<span class="nv">tar</span>.<span class="nv">gz</span>
    <span class="o">-</span> <span class="nv">tar</span> <span class="nv">xf</span> <span class="nv">pcre</span><span class="o">-</span><span class="mi">8</span>.<span class="mi">35</span>.<span class="nv">tar</span>.<span class="nv">gz</span>
  <span class="o">-</span> <span class="nv">require</span>:
    <span class="o">-</span> <span class="nv">file</span>: <span class="nv">nginx_source</span>
<span class="nv">nginx_compile</span>:
<span class="nv">cmd</span>.<span class="nv">run</span>:
  <span class="o">-</span> <span class="nv">cwd</span>: <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">nginx</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">6</span>.<span class="mi">2</span>
  <span class="o">-</span> <span class="nv">names</span>:
    <span class="o">-</span> .<span class="o">/</span><span class="nv">configure</span> <span class="o">--</span><span class="nv">prefix</span><span class="o">=/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">nginx</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">pcre</span><span class="o">=/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">pcre</span><span class="o">-</span><span class="mi">8</span>.<span class="mi">35</span> <span class="o">&amp;&amp;</span> <span class="nv">make</span>
    <span class="o">-</span> <span class="nv">make</span> <span class="nv">install</span>
  <span class="o">-</span> <span class="nv">require</span>:
    <span class="o">-</span> <span class="nv">cmd</span>: <span class="nv">extract_nginx</span>

自定义
<span class="nv">state</span>就是用来控制<span class="nv">sls</span>文件与<span class="nv">module</span>的映射
<span class="nv">state</span>默认路径   <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">python2</span>.<span class="mi">6</span><span class="o">/</span><span class="nv">site</span><span class="o">-</span><span class="nv">packages</span><span class="o">/</span><span class="nv">salt</span><span class="o">/</span><span class="nv">states</span>

<span class="nv">mkdir</span> <span class="o">-</span><span class="nv">pv</span> <span class="o">/</span><span class="nv">srv</span><span class="o">/</span><span class="nv">salt</span><span class="o">/</span><span class="nv">_states</span>
[<span class="nv">root</span>@<span class="nv">node1</span> <span class="nv">_states</span>]# <span class="nv">cat</span> <span class="nv">wjj</span>.<span class="nv">py</span>
<span class="nv">def</span> <span class="nv">bs</span><span class="ss">(</span><span class="nv">name</span>, <span class="nv">x</span><span class="ss">)</span>:                                定义函数
    <span class="nv">ret</span> <span class="o">=</span> {                                定义一个字典
            <span class="s1">&#39;</span><span class="s">name</span><span class="s1">&#39;</span>: <span class="nv">name</span>,           
            <span class="s1">&#39;</span><span class="s">changes</span><span class="s1">&#39;</span>: {},
            <span class="s1">&#39;</span><span class="s">result</span><span class="s1">&#39;</span>: <span class="nv">False</span>,
            <span class="s1">&#39;</span><span class="s">comment</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">test_state</span><span class="s1">&#39;</span> 描述的字段
            }
    <span class="nv">try</span>:
        <span class="nb">result</span> <span class="o">=</span> <span class="nv">x</span><span class="o">*</span><span class="nv">x</span>                做一些事情
        <span class="nv">ret</span>[<span class="s1">&#39;</span><span class="s">changes</span><span class="s1">&#39;</span>][<span class="s1">&#39;</span><span class="s">new</span><span class="s1">&#39;</span>] <span class="o">=</span> <span class="nb">result</span>
        <span class="nv">ret</span>[<span class="s1">&#39;</span><span class="s">result</span><span class="s1">&#39;</span>] <span class="o">=</span> <span class="nv">True</span>
    <span class="nv">except</span>:                                出现异常怎么办
        <span class="nv">ret</span>[<span class="s1">&#39;</span><span class="s">changes</span><span class="s1">&#39;</span>][<span class="s1">&#39;</span><span class="s">new</span><span class="s1">&#39;</span>] <span class="o">=</span> <span class="s1">&#39;</span><span class="s">jisuan cuwu</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="nv">ret</span>
注意你的函数的第一个参数应该永远是<span class="nv">name</span>
同步一下你的修改
<span class="nv">salt</span> <span class="s1">&#39;</span><span class="s">*</span><span class="s1">&#39;</span> <span class="nv">saltutil</span>.<span class="nv">sync_all</span>

使用你自定义的<span class="nv">state</span>
定义<span class="nv">sls</span>文件
[<span class="nv">root</span>@<span class="nv">node1</span> <span class="nv">_states</span>]# <span class="nv">cat</span> <span class="o">/</span><span class="nv">srv</span><span class="o">/</span><span class="nv">salt</span><span class="o">/</span><span class="nv">jisuan</span>.<span class="nv">sls</span>
<span class="nv">test</span>:
  <span class="nv">wjj</span>:
    <span class="o">-</span>  <span class="nv">bs</span>
    <span class="o">-</span>  <span class="nv">x</span>: <span class="mi">3</span>
<span class="nv">salt</span> <span class="s1">&#39;</span><span class="s">node2</span><span class="s1">&#39;</span> <span class="nv">state</span>.<span class="nv">sls</span> <span class="nv">jisuan</span>

<span class="nv">tips</span>:在<span class="nv">state</span>里面引用<span class="nv">salt</span>命令
<span class="nv">__salt__</span>[<span class="s1">&#39;</span><span class="s">模块.函数</span><span class="s1">&#39;</span>]<span class="ss">(</span>参数<span class="ss">)</span>

#<span class="nv">encoding</span><span class="o">=</span><span class="nv">utf</span><span class="o">-</span><span class="mi">8</span>
<span class="nv">import</span> <span class="nv">logging</span>
<span class="nv">import</span> <span class="nv">os</span>

<span class="nv">log</span> <span class="o">=</span> <span class="nv">logging</span>.<span class="nv">getLogger</span><span class="ss">(</span><span class="nv">__name__</span><span class="ss">)</span>

<span class="nv">def</span> <span class="nv">touch</span><span class="ss">(</span><span class="nv">name</span>, <span class="nv">path</span>, <span class="nv">file</span><span class="ss">)</span>:
    <span class="nv">ret</span> <span class="o">=</span> {
            <span class="s1">&#39;</span><span class="s">name</span><span class="s1">&#39;</span>: <span class="nv">name</span>,
            <span class="s1">&#39;</span><span class="s">changes</span><span class="s1">&#39;</span>: {},
            <span class="s1">&#39;</span><span class="s">result</span><span class="s1">&#39;</span>: <span class="nv">True</span>,
            <span class="s1">&#39;</span><span class="s">comment</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">test_state</span><span class="s1">&#39;</span>
            }
    #<span class="nv">log</span>.<span class="nv">error</span><span class="ss">(</span><span class="nv">name</span><span class="ss">)</span>
    #<span class="nv">log</span>.<span class="nv">error</span><span class="ss">(</span><span class="nv">path</span><span class="ss">)</span>
    <span class="nv">try</span>:
        <span class="nv">with</span> <span class="nv">open</span><span class="ss">(</span><span class="nv">path</span><span class="o">+</span><span class="s1">&#39;</span><span class="s">/</span><span class="s1">&#39;</span><span class="o">+</span><span class="nv">str</span><span class="ss">(</span><span class="nv">file</span><span class="ss">)</span>, <span class="s1">&#39;</span><span class="s">w</span><span class="s1">&#39;</span><span class="ss">)</span> <span class="nv">as</span> <span class="nv">f</span>:
            <span class="nv">f</span>.<span class="nv">write</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">my test!</span><span class="s1">&#39;</span><span class="ss">)</span>
    <span class="nv">except</span> <span class="nv">Exception</span>, <span class="nv">e</span>:
        <span class="nv">log</span>.<span class="nv">error</span><span class="ss">(</span><span class="nv">str</span><span class="ss">(</span><span class="nv">e</span><span class="ss">))</span>

    <span class="k">return</span> <span class="nv">ret</span>

<span class="nv">def</span> <span class="nv">delete</span><span class="ss">(</span><span class="nv">name</span>, <span class="nv">path</span>, <span class="nv">file</span><span class="ss">)</span>:
    <span class="nv">ret</span> <span class="o">=</span> {
            <span class="s1">&#39;</span><span class="s">name</span><span class="s1">&#39;</span>: <span class="nv">name</span>,
            <span class="s1">&#39;</span><span class="s">changes</span><span class="s1">&#39;</span>: {},
            <span class="s1">&#39;</span><span class="s">result</span><span class="s1">&#39;</span>: <span class="nv">True</span>,
            <span class="s1">&#39;</span><span class="s">comment</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">test_state</span><span class="s1">&#39;</span>
            }
    <span class="nv">cmd</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">rm -fr </span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nv">path</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="s">/</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nv">file</span>
    <span class="nv">os</span>.<span class="nv">system</span><span class="ss">(</span><span class="nv">cmd</span><span class="ss">)</span>
    <span class="nv">ret</span>[<span class="s1">&#39;</span><span class="s">result</span><span class="s1">&#39;</span>]<span class="o">=</span><span class="nv">True</span>
    <span class="k">return</span> <span class="nv">ret</span>
</pre></div>


<h2 id="pillar">pillar</h2>
<div class="codehilite"><pre><span></span><span class="nv">https</span>:<span class="o">//</span><span class="nv">docs</span>.<span class="nv">saltstack</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">en</span><span class="o">/</span><span class="nv">latest</span><span class="o">/</span><span class="nv">topics</span><span class="o">/</span><span class="nv">pillar</span><span class="o">/</span><span class="nv">index</span>.<span class="nv">html</span>

修改<span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">salt</span><span class="o">/</span><span class="nv">master</span>配置中的<span class="nv">pillar_opts</span>:<span class="nv">Ture</span>或<span class="nv">False</span>来定义是否开启或禁用这项功能
目录 <span class="o">/</span><span class="nv">srv</span><span class="o">/</span><span class="nv">pillar</span>
<span class="nv">vim</span> <span class="o">/</span><span class="nv">srv</span><span class="o">/</span><span class="nv">pillar</span><span class="o">/</span><span class="nv">top</span>.<span class="nv">sls</span>
<span class="nv">base</span>:
  <span class="s1">&#39;</span><span class="s">*</span><span class="s1">&#39;</span>:
    <span class="o">-</span> <span class="nv">vimrc</span>
    <span class="o">-</span> <span class="nv">data</span>
    <span class="o">-</span> <span class="nv">pkg</span>

<span class="nv">vim</span> <span class="o">/</span><span class="nv">srv</span><span class="o">/</span><span class="nv">pillar</span><span class="o">/</span><span class="nv">data</span>.<span class="nv">sls</span>
<span class="nv">bind</span>:
  <span class="nv">port</span>: <span class="mi">53</span>
  <span class="nv">listen</span><span class="o">-</span><span class="nv">on</span>: <span class="nv">any</span>

<span class="nv">vim</span> <span class="o">/</span><span class="nv">srv</span><span class="o">/</span><span class="nv">pillar</span><span class="o">/</span><span class="nv">vimrc</span>.<span class="nv">sls</span>
{<span class="o">%</span> <span class="k">if</span> <span class="nv">grains</span>[<span class="s1">&#39;</span><span class="s">id</span><span class="s1">&#39;</span>].<span class="nv">endswith</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">server</span><span class="s1">&#39;</span><span class="ss">)</span> <span class="o">%</span>}  <span class="nv">id</span>标识以<span class="nv">server</span>结尾的  类似的<span class="nv">startswith</span>
<span class="nv">vimrc</span>: <span class="nv">salt</span>:<span class="o">//</span><span class="nv">edit</span><span class="o">/</span><span class="nv">vimrc1</span>
{<span class="o">%</span> <span class="k">else</span> <span class="o">%</span>}
<span class="nv">vimrc</span>: <span class="nv">salt</span>:<span class="o">//</span><span class="nv">edit</span><span class="o">/</span><span class="nv">vimrc2</span>
{<span class="o">%</span> <span class="k">endif</span> <span class="o">%</span>}

<span class="nv">vim</span> <span class="o">/</span><span class="nv">srv</span><span class="o">/</span><span class="nv">pillar</span><span class="o">/</span><span class="nv">pkg</span>.<span class="nv">sls</span>
{<span class="o">%</span> <span class="k">if</span> <span class="nv">grains</span>[<span class="s1">&#39;</span><span class="s">os</span><span class="s1">&#39;</span>] <span class="o">==</span> <span class="s1">&#39;</span><span class="s">RedHat</span><span class="s1">&#39;</span> <span class="o">%</span>}    根据不同的操作系统，定义不同的包名
<span class="nv">apache</span>: <span class="nv">httpd</span>
<span class="nv">git</span>: <span class="nv">git</span>
{<span class="o">%</span> <span class="nv">elif</span> <span class="nv">grains</span>[<span class="s1">&#39;</span><span class="s">os</span><span class="s1">&#39;</span>] <span class="o">==</span> <span class="s1">&#39;</span><span class="s">Debian</span><span class="s1">&#39;</span> <span class="o">%</span>}
<span class="nv">apache</span>: <span class="nv">apache2</span>
<span class="nv">git</span>: <span class="nv">git</span><span class="o">-</span><span class="nv">core</span>
{<span class="o">%</span> <span class="k">endif</span> <span class="o">%</span>}
刷新生效 <span class="nv">salt</span> <span class="s1">&#39;</span><span class="s">*</span><span class="s1">&#39;</span> <span class="nv">saltutil</span>.<span class="nv">refresh_pillar</span>
查看     <span class="nv">salt</span> \<span class="o">*</span> <span class="nv">pillar</span>.<span class="nv">items</span>

使用<span class="nv">pillar</span>
可以在<span class="nv">state</span>、模板文件中引用，模板格式为“{{<span class="nv">pillar</span>变量}}”，例如：
{{ <span class="nv">pillar</span>[<span class="s1">&#39;</span><span class="s">appname</span><span class="s1">&#39;</span>] }}（一级字典）
{{ <span class="nv">pillar</span>[<span class="s1">&#39;</span><span class="s">flow</span><span class="s1">&#39;</span>][<span class="s1">&#39;</span><span class="s">maxconn</span><span class="s1">&#39;</span>] }}（二级字典）或 {{ <span class="nv">salt</span>[<span class="s1">&#39;</span><span class="s">pillar.get</span><span class="s1">&#39;</span>]<span class="ss">(</span><span class="s1">&#39;</span><span class="s">flow: </span><span class="s1">&#39;</span><span class="nv">maxconn</span><span class="s1">&#39;</span><span class="s">, {}) }}</span>
<span class="nv">Python</span> <span class="nv">API</span>格式如下：<span class="nv">pillar</span>[<span class="s1">&#39;</span><span class="s">flow</span><span class="s1">&#39;</span>][<span class="s1">&#39;</span><span class="s">maxconn</span><span class="s1">&#39;</span>]
                                     <span class="nv">pillar</span>.<span class="nv">get</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s"> flow:appname</span><span class="s1">&#39;</span>, {}<span class="ss">)</span>

<span class="mi">1</span>、在<span class="nv">state</span>的<span class="nv">sls</span>文件
<span class="nv">vim</span> <span class="o">/</span><span class="nv">srv</span><span class="o">/</span><span class="nv">salt</span><span class="o">/</span><span class="nv">down_vimrc</span>.<span class="nv">sls</span>
<span class="o">/</span><span class="nv">root</span><span class="o">/</span>.<span class="nv">vimrc</span>:
  <span class="nv">file</span>.<span class="nv">managed</span>:
<span class="o">-</span> <span class="nv">source</span>: {{ <span class="nv">pillar</span>[<span class="s1">&#39;</span><span class="s">vimrc</span><span class="s1">&#39;</span>] }}   调用之前定义的<span class="nv">pillar</span>
或者<span class="o">-</span> <span class="nv">source</span>: {{ <span class="nv">salt</span>[<span class="s1">&#39;</span><span class="s">pillar.get</span><span class="s1">&#39;</span>]<span class="ss">(</span><span class="s1">&#39;</span><span class="s">vimrc</span><span class="s1">&#39;</span>,<span class="s1">&#39;</span><span class="s">salt://edit/vimrc2</span><span class="s1">&#39;</span><span class="ss">)</span> }}
                          <span class="nv">pillar</span>的<span class="nv">key</span>，默认值
<span class="nv">salt</span> \<span class="o">*</span> <span class="nv">state</span>.<span class="nv">show_sls</span> <span class="nv">down_vimrc</span>  查看详细的变量
<span class="mi">2</span>、<span class="nv">salt</span> <span class="o">-</span><span class="nv">I</span> <span class="s2">&quot;</span><span class="s">nginx:80</span><span class="s2">&quot;</span> <span class="nv">cmd</span>.<span class="nv">run</span> <span class="s2">&quot;</span><span class="s">ls</span><span class="s2">&quot;</span>   <span class="o">-</span><span class="nv">I</span> 指定<span class="nv">pillar</span>
<span class="mi">3</span>、<span class="nv">pillar</span>的临时定义
<span class="nv">vim</span> <span class="o">/</span><span class="nv">srv</span><span class="o">/</span><span class="nv">salt</span><span class="o">/</span><span class="nv">pillar_temp</span>.<span class="nv">sls</span>
{<span class="o">%</span><span class="nv">set</span> <span class="nv">u</span> <span class="o">=</span> <span class="nv">pillar</span>[<span class="s1">&#39;</span><span class="s">u_name</span><span class="s1">&#39;</span>]<span class="o">%</span>}        之前没有这个<span class="nv">pillar</span>
{{<span class="nv">u</span>}}:
  <span class="nv">user</span>.<span class="nv">present</span>

<span class="nv">salt</span> <span class="s1">&#39;</span><span class="s">node2</span><span class="s1">&#39;</span> <span class="nv">state</span>.<span class="nv">sls</span> <span class="nv">pillar_temp</span> <span class="nv">pillar</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">{&quot;u_name&quot;: &quot;v1&quot;}</span><span class="s1">&#39;</span>    临时指定一个<span class="nv">pillar</span>
</pre></div>


<h2 id="job">job</h2>
<div class="codehilite"><pre><span></span><span class="o">[</span><span class="n">root@salt-master salt</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">salt</span><span class="w"> </span><span class="o">-</span><span class="n">I</span><span class="w"> </span><span class="ss">&quot;nginx:80&quot;</span><span class="w"> </span><span class="n">cmd</span><span class="p">.</span><span class="n">run</span><span class="w"> </span><span class="ss">&quot;sleep 100&quot;</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"></span>
<span class="n">Executing</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">jid</span><span class="w"> </span><span class="mi">20151011154835704857</span><span class="w"></span>
<span class="n">salt</span><span class="o">-</span><span class="n">run</span><span class="w"> </span><span class="n">管理job</span><span class="w"></span>
<span class="n">salt</span><span class="o">-</span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="o">|</span><span class="n">grep</span><span class="w"> </span><span class="n">jobs</span><span class="w"></span>
<span class="n">salt</span><span class="o">-</span><span class="n">run</span><span class="w"> </span><span class="n">jobs</span><span class="p">.</span><span class="n">active</span><span class="w">   </span><span class="n">查看当前正在运行的jobs</span><span class="w"></span>
<span class="n">salt</span><span class="o">-</span><span class="n">run</span><span class="w"> </span><span class="n">jobs</span><span class="p">.</span><span class="n">list_job</span><span class="w"> </span><span class="mi">20130916125524463507</span><span class="w">     </span><span class="n">指定jid查看jobs详细信息</span><span class="w">    </span>
<span class="n">salt</span><span class="o">-</span><span class="n">run</span><span class="w"> </span><span class="n">jobs</span><span class="p">.</span><span class="n">list_jobs</span><span class="w">      </span><span class="n">#查看所有jobs信息</span><span class="w">                </span>
<span class="n">salt</span><span class="o">-</span><span class="n">run</span><span class="w"> </span><span class="n">jobs</span><span class="p">.</span><span class="n">lookup_jid</span><span class="w"> </span><span class="mi">20130916125524463507</span><span class="w">  </span><span class="n">#指定jid查询jobs结果</span><span class="w"></span>
<span class="n">salt</span><span class="o">-</span><span class="n">run</span><span class="w"> </span><span class="n">jobs</span><span class="p">.</span><span class="n">print_job</span><span class="w">   </span><span class="n">#指定jid查询jobs详细信息</span><span class="w"></span>
<span class="c1">-------------------------------------------------</span>
<span class="n">通过saltutil模块管理job</span><span class="w"></span>
<span class="n">salt</span><span class="w"> </span><span class="err">\</span><span class="o">*</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">doc</span><span class="w"> </span><span class="n">saltutil</span><span class="w"> </span><span class="o">|</span><span class="n">grep</span><span class="w"> </span><span class="n">job</span><span class="w"></span>
<span class="n">salt</span><span class="w"> </span><span class="s1">&#39;*&#39;</span><span class="w"> </span><span class="n">saltutil</span><span class="p">.</span><span class="n">find_cached_job</span><span class="w"> </span><span class="o">&lt;</span><span class="n">job</span><span class="w"> </span><span class="n">id</span><span class="o">&gt;</span><span class="w">  </span><span class="n">#查询job</span><span class="w"> </span><span class="n">cache信息</span><span class="w"></span>
<span class="n">salt</span><span class="w"> </span><span class="s1">&#39;node2&#39;</span><span class="w"> </span><span class="n">saltutil</span><span class="p">.</span><span class="n">find_job</span><span class="w"> </span><span class="mi">20150810003021849521</span><span class="w">  </span><span class="n">通过jid查找</span><span class="w"></span>
<span class="n">salt</span><span class="w"> </span><span class="s1">&#39;node2&#39;</span><span class="w"> </span><span class="n">saltutil</span><span class="p">.</span><span class="n">is_running</span><span class="w"> </span><span class="n">cmd</span><span class="p">.</span><span class="n">run</span><span class="w">  </span><span class="n">通过函数名查找</span><span class="w"></span>
<span class="n">salt</span><span class="w"> </span><span class="s1">&#39;node2&#39;</span><span class="w"> </span><span class="n">saltutil</span><span class="p">.</span><span class="n">kill_job</span><span class="w"> </span><span class="mi">20150810003232388165</span><span class="w">  </span><span class="n">杀死一个job</span><span class="w"></span>
<span class="n">saltutil</span><span class="p">.</span><span class="n">running</span><span class="w"> </span><span class="n">#查看minion当前正在运</span><span class="err">⾏</span><span class="n">的jobs</span><span class="w"></span>
<span class="n">saltutil</span><span class="p">.</span><span class="n">find_job</span><span class="o">&lt;</span><span class="n">jid</span><span class="o">&gt;</span><span class="w"> </span><span class="n">#查看指定jid的job</span><span class="p">(</span><span class="n">minion正在运</span><span class="err">⾏</span><span class="n">的jobs</span><span class="p">)</span><span class="w"></span>
<span class="n">saltutil</span><span class="p">.</span><span class="n">signal_job</span><span class="o">&lt;</span><span class="n">jid</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;</span><span class="n">single</span><span class="o">&gt;</span><span class="w"> </span><span class="n">#给指定的jid进程发送信号</span><span class="w"></span>
<span class="n">saltutil</span><span class="p">.</span><span class="n">term_job</span><span class="w"> </span><span class="o">&lt;</span><span class="n">jid</span><span class="o">&gt;</span><span class="w"> </span><span class="n">#终</span><span class="err">⽌</span><span class="n">指定的jid进程</span><span class="p">(</span><span class="n">信号为15</span><span class="p">)</span><span class="w"></span>
<span class="n">saltutil</span><span class="p">.</span><span class="n">kill_job</span><span class="w"> </span><span class="o">&lt;</span><span class="n">jid</span><span class="o">&gt;</span><span class="w"> </span><span class="n">#终</span><span class="err">⽌</span><span class="n">指定的jid进程</span><span class="p">(</span><span class="n">信号为9</span><span class="p">)</span><span class="w"></span>
</pre></div>


<h2 id="return">return存储结果</h2>
<div class="codehilite"><pre><span></span><span class="err">每台</span><span class="n">minion</span><span class="err">跟存储服务器连接后发送返回数据。在大规模的</span><span class="n">Minion</span><span class="err">环境下并不适合企业级应用。也有网友通过</span><span class="n">event</span><span class="err">事件实现</span><span class="n">Master</span><span class="err">端直接</span><span class="n">Return</span><span class="err">到存储服务器。参考地址为：</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">pengyao</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">salt</span><span class="o">-</span><span class="n">stack_master_retuner_over_event_system</span><span class="o">.</span><span class="n">html</span>

<span class="err">使用</span><span class="n">redis</span> <span class="err">存储</span>
<span class="err">修改</span><span class="n">minion</span><span class="err">的</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">salt</span><span class="o">/</span><span class="n">minion</span><span class="err">配置文件</span>
<span class="n">redis</span><span class="o">.</span><span class="n">db</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span>                    <span class="c1">#redis数据库</span>
<span class="n">redis</span><span class="o">.</span><span class="n">host</span><span class="p">:</span> <span class="s1">&#39;vps.shencan.net&#39;</span>    <span class="c1">#redis主机(ip地址和域名都行)</span>
<span class="n">redis</span><span class="o">.</span><span class="n">port</span><span class="p">:</span> <span class="mi">6379</span>                 <span class="c1">#redis端口</span>
<span class="n">minion</span><span class="err">按照</span><span class="n">redis</span><span class="err">客户端</span>  <span class="n">pip</span> <span class="n">install</span> <span class="n">redis</span>
<span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;import redis; print redis.VERSION&#39;</span>
<span class="n">salt</span> <span class="s1">&#39;Minion&#39;</span> <span class="n">cmd</span><span class="o">.</span><span class="n">run</span> <span class="s1">&#39;hostname&#39;</span> <span class="o">--</span><span class="k">return</span> <span class="n">redis</span>

<span class="n">mysql</span><span class="err">存储</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="o">.</span><span class="mi">6</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">salt</span><span class="o">/</span><span class="n">returners</span><span class="o">/</span>
<span class="err">具体的配置</span>   <span class="n">cat</span> <span class="n">mysql</span><span class="o">.</span><span class="n">py</span>
<span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">salt</span><span class="o">/</span><span class="n">minion</span><span class="err">（冒号后有空格）</span>
<span class="n">mysql</span><span class="o">.</span><span class="n">host</span><span class="p">:</span>  <span class="s1">&#39;10.255.254.221&#39;</span>
<span class="n">mysql</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>  <span class="s1">&#39;salt&#39;</span>
<span class="n">mysql</span><span class="o">.</span><span class="k">pass</span><span class="p">:</span>  <span class="s1">&#39;123&#39;</span>
<span class="n">mysql</span><span class="o">.</span><span class="n">db</span><span class="p">:</span>  <span class="s1">&#39;salt&#39;</span>
<span class="n">mysql</span><span class="o">.</span><span class="n">port</span><span class="p">:</span>  <span class="mi">3306</span>

<span class="err">在</span><span class="mf">10.255</span><span class="o">.</span><span class="mf">254.221</span><span class="err">这台</span><span class="n">mysql</span><span class="err">服务器上</span>
<span class="err">启动</span><span class="n">mysql</span><span class="err">服务</span>
<span class="err">设置</span><span class="n">mysql</span><span class="err">用户，</span><span class="n">salt</span><span class="err">，密码，</span><span class="mi">123</span>
<span class="n">GRANT</span> <span class="n">ALL</span> <span class="n">PRIVILEGES</span> <span class="n">ON</span> <span class="o">*.*</span> <span class="n">TO</span> <span class="s1">&#39;salt&#39;</span><span class="err">@</span><span class="s1">&#39;%&#39;</span> <span class="n">IDENTIFIED</span> <span class="n">BY</span> <span class="err">‘</span><span class="mi">123</span><span class="err">’；</span>

<span class="err">把以下</span><span class="n">sql</span><span class="err">语句保存到</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">salt</span><span class="o">.</span><span class="n">sql</span><span class="err">文件中，执行</span><span class="n">mysql</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="o">&lt;</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">salt</span><span class="o">.</span><span class="n">sql</span>
<span class="p">(</span><span class="err">创建一个</span><span class="n">salt</span><span class="err">库，然后在</span><span class="n">salt</span><span class="err">库里面创建两个表</span><span class="n">jids</span><span class="err">，</span><span class="n">salt_returns</span><span class="p">)</span>
<span class="n">GRANT</span> <span class="n">ALL</span> <span class="n">PRIVILEGES</span> <span class="n">ON</span> <span class="o">*.*</span> <span class="n">TO</span> <span class="s1">&#39;salt&#39;</span><span class="err">@</span><span class="s1">&#39;%&#39;</span> <span class="n">IDENTIFIED</span> <span class="n">BY</span> <span class="err">‘</span><span class="mi">123</span><span class="err">’；</span>

<span class="n">CREATE</span> <span class="n">DATABASE</span>  <span class="sb">`salt`</span>
      <span class="n">DEFAULT</span> <span class="n">CHARACTER</span> <span class="n">SET</span> <span class="n">utf8</span>
      <span class="n">DEFAULT</span> <span class="n">COLLATE</span> <span class="n">utf8_general_ci</span><span class="p">;</span>

<span class="n">USE</span> <span class="sb">`salt`</span><span class="p">;</span>

<span class="n">DROP</span> <span class="n">TABLE</span> <span class="n">IF</span> <span class="n">EXISTS</span> <span class="sb">`jids`</span><span class="p">;</span>
    <span class="n">CREATE</span> <span class="n">TABLE</span> <span class="sb">`jids`</span> <span class="p">(</span>
      <span class="sb">`jid`</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="p">,</span>
      <span class="sb">`load`</span> <span class="n">mediumtext</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="p">,</span>
      <span class="n">UNIQUE</span> <span class="n">KEY</span> <span class="sb">`jid`</span> <span class="p">(</span><span class="sb">`jid`</span><span class="p">)</span>
    <span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="n">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>

<span class="n">DROP</span> <span class="n">TABLE</span> <span class="n">IF</span> <span class="n">EXISTS</span> <span class="sb">`salt_returns`</span><span class="p">;</span>
    <span class="n">CREATE</span> <span class="n">TABLE</span> <span class="sb">`salt_returns`</span> <span class="p">(</span>
      <span class="sb">`fun`</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="p">,</span>
      <span class="sb">`jid`</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="p">,</span>
      <span class="sb">`return`</span> <span class="n">mediumtext</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="p">,</span>
      <span class="sb">`id`</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="p">,</span>
      <span class="sb">`success`</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="p">,</span>
      <span class="sb">`full_ret`</span> <span class="n">mediumtext</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="p">,</span>
      <span class="sb">`alter_time`</span> <span class="n">TIMESTAMP</span> <span class="n">DEFAULT</span> <span class="n">CURRENT_TIMESTAMP</span><span class="p">,</span>
      <span class="n">KEY</span> <span class="sb">`id`</span> <span class="p">(</span><span class="sb">`id`</span><span class="p">),</span>
      <span class="n">KEY</span> <span class="sb">`jid`</span> <span class="p">(</span><span class="sb">`jid`</span><span class="p">),</span>
      <span class="n">KEY</span> <span class="sb">`fun`</span> <span class="p">(</span><span class="sb">`fun`</span><span class="p">)</span>
    <span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="n">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>

<span class="n">DROP</span> <span class="n">TABLE</span> <span class="n">IF</span> <span class="n">EXISTS</span> <span class="sb">`salt_events`</span><span class="p">;</span>
    <span class="n">CREATE</span> <span class="n">TABLE</span> <span class="sb">`salt_events`</span> <span class="p">(</span>
    <span class="sb">`id`</span> <span class="n">BIGINT</span> <span class="n">NOT</span> <span class="n">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
    <span class="sb">`tag`</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="p">,</span>
    <span class="sb">`data`</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="p">,</span>
    <span class="sb">`alter_time`</span> <span class="n">TIMESTAMP</span> <span class="n">DEFAULT</span> <span class="n">CURRENT_TIMESTAMP</span><span class="p">,</span>
    <span class="sb">`master_id`</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="p">,</span>
    <span class="n">PRIMARY</span> <span class="n">KEY</span> <span class="p">(</span><span class="sb">`id`</span><span class="p">),</span>
    <span class="n">KEY</span> <span class="sb">`tag`</span> <span class="p">(</span><span class="sb">`tag`</span><span class="p">)</span>
    <span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="n">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>

<span class="err">保证你的</span><span class="n">python</span><span class="err">能够操作</span><span class="n">mysql</span><span class="err">数据库</span>
<span class="n">yum</span> <span class="n">install</span> <span class="n">MySQL</span><span class="o">-</span><span class="n">python</span> <span class="o">-</span><span class="n">y</span>

<span class="err">使用</span><span class="n">mysql</span><span class="err">作为</span><span class="n">returner</span><span class="err">，将结果放入</span><span class="n">mysql</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@node1</span> <span class="o">~</span><span class="p">]</span><span class="c1"># salt &#39;node2&#39; test.ping --return mysql</span>
<span class="n">node2</span><span class="p">:</span>
    <span class="bp">True</span>
<span class="o">----------------------------------------------------------------</span>
<span class="err">可以通过</span><span class="n">salt</span><span class="err">的</span><span class="n">schedule</span><span class="err">去收集</span><span class="n">minion</span><span class="err">上的信息。</span>
<span class="n">schedule</span><span class="p">:</span>
  <span class="n">uptime</span><span class="p">:</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">status</span><span class="o">.</span><span class="n">uptime</span>
    <span class="n">seconds</span><span class="p">:</span> <span class="mi">60</span>
    <span class="n">returner</span><span class="p">:</span> <span class="n">mysql</span>
  <span class="n">meminfo</span><span class="p">:</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">status</span><span class="o">.</span><span class="n">meminfo</span>
    <span class="n">minutes</span><span class="p">:</span> <span class="mi">5</span>
    <span class="n">returner</span><span class="p">:</span> <span class="n">mysql</span>
</pre></div>


<h2 id="api-web">api web</h2>
<div class="codehilite"><pre><span></span>用户

# <span class="nv">chmod</span> <span class="mi">755</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">salt</span><span class="o">/</span><span class="nv">master</span> <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">run</span><span class="o">/</span><span class="nv">salt</span>  <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">cache</span><span class="o">/</span><span class="nv">salt</span>
修改<span class="nv">master</span>配置文件
<span class="nv">external_auth</span>:
  <span class="nv">pam</span>:
    <span class="nv">a1</span>:
      <span class="o">-</span> <span class="s1">&#39;</span><span class="s">*</span><span class="s1">&#39;</span>:
        <span class="o">-</span> <span class="nv">test</span>.<span class="o">*</span>
        <span class="o">-</span> <span class="nv">cmd</span>.<span class="o">*</span>
<span class="nv">http</span>:<span class="o">//</span><span class="nv">docs</span>.<span class="nv">saltstack</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">en</span><span class="o">/</span><span class="nv">latest</span><span class="o">/</span><span class="nv">topics</span><span class="o">/</span><span class="nv">eauth</span><span class="o">/</span><span class="nv">index</span>.<span class="nv">html</span>#<span class="nv">acl</span><span class="o">-</span><span class="nv">eauth</span>
切换<span class="nv">a1</span>用户进行测试
<span class="nv">salt</span> <span class="o">-</span><span class="nv">a</span> <span class="nv">pam</span> <span class="o">*</span> <span class="nv">test</span>.<span class="nv">ping</span>
<span class="nv">salt</span> <span class="o">-</span><span class="nv">a</span> <span class="nv">pam</span> <span class="o">*</span> <span class="nv">cmd</span>.<span class="nv">run</span> <span class="s1">&#39;</span><span class="s">whoami</span><span class="s1">&#39;</span>

测试令牌
$ <span class="nv">salt</span> <span class="o">-</span><span class="nv">T</span> <span class="o">-</span><span class="nv">a</span> <span class="nv">pam</span> <span class="nv">web</span>\<span class="o">*</span> <span class="nv">test</span>.<span class="nv">ping</span>
[<span class="nv">a1</span>@<span class="nv">zabbix_server</span> <span class="o">~</span>]$ <span class="nv">salt</span> <span class="o">-</span><span class="nv">T</span> <span class="o">-</span><span class="nv">a</span> <span class="nv">pam</span> <span class="o">*</span> <span class="nv">test</span>.<span class="nv">ping</span>
<span class="nv">username</span>: <span class="nv">a1</span>
<span class="nv">password</span>:
<span class="nv">zabbixnode1</span>.<span class="nv">example</span>.<span class="nv">com</span>:
    <span class="nv">True</span>

<span class="nv">API</span>

<span class="nv">yum</span> <span class="nv">install</span> <span class="nv">salt</span><span class="o">-</span><span class="nv">api</span> <span class="o">-</span><span class="nv">y</span>
<span class="nv">cd</span>  <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">pki</span><span class="o">/</span><span class="nv">tls</span><span class="o">/</span><span class="nv">certs</span>
# 生成自签名证书, 过程中需要输入<span class="nv">key</span>密码及<span class="nv">RDNs</span>
<span class="nv">make</span> <span class="nv">testcert</span>
<span class="nv">cd</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">pki</span><span class="o">/</span><span class="nv">tls</span><span class="o">/</span><span class="nv">private</span><span class="o">/</span>
# 解密<span class="nv">key</span>文件，生成无密码的<span class="nv">key</span>文件, 过程中需要输入<span class="nv">key</span>密码，该密码为之前生成证书时设置的密码
<span class="nv">openssl</span> <span class="nv">rsa</span> <span class="o">-</span><span class="nv">in</span> <span class="nv">localhost</span>.<span class="nv">key</span> <span class="o">-</span><span class="nv">out</span> <span class="nv">localhost_nopass</span>.<span class="nv">key</span>
或者
<span class="nv">yum</span> <span class="nv">install</span> <span class="nv">gcc</span> <span class="nv">make</span> <span class="nv">python</span><span class="o">-</span><span class="nv">devel</span> <span class="nv">libffi</span><span class="o">-</span><span class="nv">develpip</span><span class="o">-</span><span class="nv">python</span> <span class="nv">install</span> <span class="nv">PyOpenSSL</span>
<span class="nv">salt</span><span class="o">-</span><span class="k">call</span> <span class="nl">tls</span>.<span class="nv">create_self_signed_cert</span>  #生成证书，需要有<span class="nv">salt</span><span class="o">-</span><span class="nv">minion</span>，<span class="nv">salt</span><span class="o">-</span><span class="nv">call</span>在<span class="nv">salt</span><span class="o">-</span><span class="nv">minion</span>包里
添加<span class="nv">saltapi</span>.<span class="nv">conf</span> 文件
<span class="nv">vim</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">salt</span><span class="o">/</span><span class="nv">master</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">saltapi</span>.<span class="nv">conf</span>
<span class="nv">rest_cherrypy</span>:
   <span class="nv">port</span>: <span class="mi">8000</span>
   <span class="nv">host</span>: <span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span>
   #<span class="nv">disable_ssl</span>: <span class="nv">true</span> 开关<span class="nv">https</span>
   <span class="nv">ssl_crt</span>: <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">pki</span><span class="o">/</span><span class="nv">tls</span><span class="o">/</span><span class="nv">certs</span><span class="o">/</span><span class="nv">localhost</span>.<span class="nv">crt</span> #使用前面生成的证书
   <span class="nv">ssl_key</span>: <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">pki</span><span class="o">/</span><span class="nv">tls</span><span class="o">/</span><span class="nv">certs</span><span class="o">/</span><span class="nv">localhost</span>.<span class="nv">key</span>
<span class="nv">external_auth</span>:
    <span class="nv">pam</span>:
       <span class="nv">saltapi</span>:
          <span class="o">-</span> .<span class="o">*</span>
          <span class="o">-</span> <span class="s1">&#39;</span><span class="s">@runner</span><span class="s1">&#39;</span>
          <span class="o">-</span> <span class="s1">&#39;</span><span class="s">@wheel</span><span class="s1">&#39;</span>    
#添加用户    <span class="nv">useradd</span> <span class="o">-</span><span class="nv">M</span> <span class="o">-</span><span class="nv">s</span> <span class="o">/</span><span class="nv">sbin</span><span class="o">/</span><span class="nv">nologin</span> <span class="nv">saltapi</span>    <span class="nv">echo</span> <span class="s2">&quot;</span><span class="s">spassword</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">passwd</span> <span class="nv">saltapi</span> <span class="o">--</span><span class="nv">stdin</span>

重启<span class="nv">master</span>
启动<span class="nv">salt</span><span class="o">-</span><span class="nv">api</span> 
<span class="o">----------------------------------------</span>
<span class="nv">import</span> <span class="nv">json</span>
<span class="nv">import</span> <span class="nv">urllib</span>
<span class="nv">import</span> <span class="nv">urllib2</span>
<span class="nv">class</span> <span class="nv">SaltAPI</span><span class="ss">(</span><span class="nv">object</span><span class="ss">)</span>:
    <span class="nv">__token_id</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="nv">def</span> <span class="nv">__init__</span><span class="ss">(</span><span class="nv">self</span><span class="ss">)</span>:
        <span class="nv">self</span>.<span class="nv">__url</span> <span class="o">=</span> <span class="nv">url</span>
        <span class="nv">self</span>.<span class="nv">__user</span> <span class="o">=</span> <span class="nv">user</span>
        <span class="nv">self</span>.<span class="nv">__password</span> <span class="o">=</span> <span class="nv">pass</span>
        <span class="nb">params</span> <span class="o">=</span> {<span class="s1">&#39;</span><span class="s">eauth</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">pam</span><span class="s1">&#39;</span>, <span class="s1">&#39;</span><span class="s">username</span><span class="s1">&#39;</span>: <span class="nv">self</span>.<span class="nv">__user</span>, <span class="s1">&#39;</span><span class="s">password</span><span class="s1">&#39;</span>: <span class="nv">self</span>.<span class="nv">__password</span>}
        <span class="nv">content</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">postRequest</span><span class="ss">(</span><span class="nb">params</span>, <span class="nv">prefix</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">/login</span><span class="s1">&#39;</span><span class="ss">)</span>
        <span class="nv">print</span> <span class="nv">content</span>[<span class="s1">&#39;</span><span class="s">return</span><span class="s1">&#39;</span>][<span class="mi">0</span>][<span class="s1">&#39;</span><span class="s">token</span><span class="s1">&#39;</span>]
        <span class="nv">self</span>.<span class="nv">__token_id</span> <span class="o">=</span> <span class="nv">content</span>[<span class="s1">&#39;</span><span class="s">return</span><span class="s1">&#39;</span>][<span class="mi">0</span>][<span class="s1">&#39;</span><span class="s">token</span><span class="s1">&#39;</span>]
    <span class="nv">def</span> <span class="nv">postRequest</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">obj</span>, <span class="nv">prefix</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">/</span><span class="s1">&#39;</span><span class="ss">)</span>:
        <span class="nv">url</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">__url</span> <span class="o">+</span> <span class="nv">prefix</span>
        <span class="nv">headers</span> <span class="o">=</span> {<span class="s1">&#39;</span><span class="s">X-Auth-Token</span><span class="s1">&#39;</span>: <span class="nv">self</span>.<span class="nv">__token_id</span>}
        <span class="nv">data</span> <span class="o">=</span> <span class="nv">urllib</span>.<span class="nv">urlencode</span><span class="ss">(</span><span class="nv">obj</span><span class="ss">)</span>
        <span class="nv">req</span> <span class="o">=</span> <span class="nv">urllib2</span>.<span class="nv">Request</span><span class="ss">(</span><span class="nv">url</span>, <span class="nv">data</span>, <span class="nv">headers</span><span class="ss">)</span>
        <span class="nv">opener</span> <span class="o">=</span> <span class="nv">urllib2</span>.<span class="nv">urlopen</span><span class="ss">(</span><span class="nv">req</span><span class="ss">)</span>
        <span class="nv">content</span> <span class="o">=</span> <span class="nv">json</span>.<span class="nv">loads</span><span class="ss">(</span><span class="nv">opener</span>.<span class="nv">read</span><span class="ss">())</span>
        <span class="k">return</span> <span class="nv">content</span>
    <span class="nv">def</span> <span class="nv">postRequest1</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">obj</span>, <span class="nv">prefix</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">/</span><span class="s1">&#39;</span><span class="ss">)</span>:
        <span class="nv">url</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">__url</span> <span class="o">+</span> <span class="nv">prefix</span>
        <span class="nv">headers</span> <span class="o">=</span> {<span class="s1">&#39;</span><span class="s">X-Auth-Token</span><span class="s1">&#39;</span>: <span class="nv">self</span>.<span class="nv">__token_id</span>}
        <span class="nv">req</span> <span class="o">=</span> <span class="nv">urllib2</span>.<span class="nv">Request</span><span class="ss">(</span><span class="nv">url</span>, <span class="nv">obj</span>, <span class="nv">headers</span><span class="ss">)</span>
        <span class="nv">opener</span> <span class="o">=</span> <span class="nv">urllib2</span>.<span class="nv">urlopen</span><span class="ss">(</span><span class="nv">req</span><span class="ss">)</span>
        <span class="nv">content</span> <span class="o">=</span> <span class="nv">opener</span>.<span class="nv">info</span><span class="ss">()</span>
        <span class="k">return</span> <span class="nv">content</span>
    <span class="nv">def</span> <span class="nv">list_all_key</span><span class="ss">(</span><span class="nv">self</span><span class="ss">)</span>:
        <span class="nb">params</span> <span class="o">=</span> {<span class="s1">&#39;</span><span class="s">client</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">wheel</span><span class="s1">&#39;</span>, <span class="s1">&#39;</span><span class="s">fun</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">key.list_all</span><span class="s1">&#39;</span>}
        <span class="nv">content</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">postRequest</span><span class="ss">(</span><span class="nb">params</span><span class="ss">)</span>
        # <span class="nv">minions</span> <span class="o">=</span> <span class="nv">content</span>[<span class="s1">&#39;</span><span class="s">return</span><span class="s1">&#39;</span>][<span class="mi">0</span>][<span class="s1">&#39;</span><span class="s">data</span><span class="s1">&#39;</span>][<span class="s1">&#39;</span><span class="s">return</span><span class="s1">&#39;</span>][<span class="s1">&#39;</span><span class="s">minions</span><span class="s1">&#39;</span>]
        # <span class="nv">minions_pre</span> <span class="o">=</span> <span class="nv">content</span>[<span class="s1">&#39;</span><span class="s">return</span><span class="s1">&#39;</span>][<span class="mi">0</span>][<span class="s1">&#39;</span><span class="s">data</span><span class="s1">&#39;</span>][<span class="s1">&#39;</span><span class="s">return</span><span class="s1">&#39;</span>][<span class="s1">&#39;</span><span class="s">minions_pre</span><span class="s1">&#39;</span>]
        # <span class="k">return</span> <span class="nv">minions</span>,<span class="nv">minions_pre</span>
        <span class="nv">minions</span> <span class="o">=</span> <span class="nv">content</span>[<span class="s1">&#39;</span><span class="s">return</span><span class="s1">&#39;</span>][<span class="mi">0</span>][<span class="s1">&#39;</span><span class="s">data</span><span class="s1">&#39;</span>][<span class="s1">&#39;</span><span class="s">return</span><span class="s1">&#39;</span>]
        <span class="k">return</span> <span class="nv">minions</span>
    <span class="nv">def</span> <span class="nv">delete_key</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">node_name</span><span class="ss">)</span>:
        <span class="nb">params</span> <span class="o">=</span> {<span class="s1">&#39;</span><span class="s">client</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">wheel</span><span class="s1">&#39;</span>, <span class="s1">&#39;</span><span class="s">fun</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">key.delete</span><span class="s1">&#39;</span>, <span class="s1">&#39;</span><span class="s">match</span><span class="s1">&#39;</span>: <span class="nv">node_name</span>}
        <span class="nv">content</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">postRequest</span><span class="ss">(</span><span class="nb">params</span><span class="ss">)</span>
        <span class="nv">ret</span> <span class="o">=</span> <span class="nv">content</span>[<span class="s1">&#39;</span><span class="s">return</span><span class="s1">&#39;</span>][<span class="mi">0</span>][<span class="s1">&#39;</span><span class="s">data</span><span class="s1">&#39;</span>][<span class="s1">&#39;</span><span class="s">success</span><span class="s1">&#39;</span>]
        <span class="k">return</span> <span class="nv">ret</span>
    <span class="nv">def</span> <span class="nv">accept_key</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">node_name</span><span class="ss">)</span>:
        <span class="nb">params</span> <span class="o">=</span> {<span class="s1">&#39;</span><span class="s">client</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">wheel</span><span class="s1">&#39;</span>, <span class="s1">&#39;</span><span class="s">fun</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">key.accept</span><span class="s1">&#39;</span>, <span class="s1">&#39;</span><span class="s">match</span><span class="s1">&#39;</span>: <span class="nv">node_name</span>}
        <span class="nv">content</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">postRequest</span><span class="ss">(</span><span class="nb">params</span><span class="ss">)</span>
        <span class="nv">ret</span> <span class="o">=</span> <span class="nv">content</span>[<span class="s1">&#39;</span><span class="s">return</span><span class="s1">&#39;</span>][<span class="mi">0</span>][<span class="s1">&#39;</span><span class="s">data</span><span class="s1">&#39;</span>][<span class="s1">&#39;</span><span class="s">success</span><span class="s1">&#39;</span>]
        <span class="k">return</span> <span class="nv">ret</span>
    <span class="nv">def</span> <span class="nv">reject_key</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">node_name</span><span class="ss">)</span>:
        <span class="nb">params</span> <span class="o">=</span> {<span class="s1">&#39;</span><span class="s">client</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">wheel</span><span class="s1">&#39;</span>, <span class="s1">&#39;</span><span class="s">fun</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">key.reject</span><span class="s1">&#39;</span>, <span class="s1">&#39;</span><span class="s">match</span><span class="s1">&#39;</span>: <span class="nv">node_name</span>}
        <span class="nv">content</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">postRequest</span><span class="ss">(</span><span class="nb">params</span><span class="ss">)</span>
        <span class="nv">ret</span> <span class="o">=</span> <span class="nv">content</span>[<span class="s1">&#39;</span><span class="s">return</span><span class="s1">&#39;</span>][<span class="mi">0</span>][<span class="s1">&#39;</span><span class="s">data</span><span class="s1">&#39;</span>][<span class="s1">&#39;</span><span class="s">success</span><span class="s1">&#39;</span>]
        <span class="k">return</span> <span class="nv">ret</span>
    <span class="nv">def</span> <span class="nv">remote_noarg_execution</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">tgt</span>, <span class="nv">fun</span><span class="ss">)</span>:
        <span class="s1">&#39;&#39;&#39;</span><span class="s"> Execute commands without parameters </span><span class="s1">&#39;&#39;&#39;</span>
        <span class="nb">params</span> <span class="o">=</span> {<span class="s1">&#39;</span><span class="s">client</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">local</span><span class="s1">&#39;</span>, <span class="s1">&#39;</span><span class="s">tgt</span><span class="s1">&#39;</span>: <span class="nv">tgt</span>, <span class="s1">&#39;</span><span class="s">fun</span><span class="s1">&#39;</span>: <span class="nv">fun</span>}
        <span class="nv">content</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">postRequest</span><span class="ss">(</span><span class="nb">params</span><span class="ss">)</span>
        <span class="nv">ret</span> <span class="o">=</span> <span class="nv">content</span>[<span class="s1">&#39;</span><span class="s">return</span><span class="s1">&#39;</span>][<span class="mi">0</span>][<span class="nv">tgt</span>]
        <span class="k">return</span> <span class="nv">ret</span>
    <span class="nv">def</span> <span class="nv">remote_execution</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">tgt</span>, <span class="nv">fun</span>, <span class="nv">arg</span><span class="ss">)</span>:
        <span class="s1">&#39;&#39;&#39;</span><span class="s"> Command execution with parameters </span><span class="s1">&#39;&#39;&#39;</span>
        <span class="nb">params</span> <span class="o">=</span> {<span class="s1">&#39;</span><span class="s">client</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">local</span><span class="s1">&#39;</span>, <span class="s1">&#39;</span><span class="s">tgt</span><span class="s1">&#39;</span>: <span class="nv">tgt</span>, <span class="s1">&#39;</span><span class="s">fun</span><span class="s1">&#39;</span>: <span class="nv">fun</span>, <span class="s1">&#39;</span><span class="s">arg</span><span class="s1">&#39;</span>: <span class="nv">arg</span>}
        <span class="nv">content</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">postRequest</span><span class="ss">(</span><span class="nb">params</span><span class="ss">)</span>
        <span class="nv">ret</span> <span class="o">=</span> <span class="nv">content</span>[<span class="s1">&#39;</span><span class="s">return</span><span class="s1">&#39;</span>][<span class="mi">0</span>][<span class="nv">tgt</span>]
        <span class="k">return</span> <span class="nv">ret</span>
    <span class="nv">def</span> <span class="nv">shell_remote_execution</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">tgt</span>, <span class="nv">arg</span><span class="ss">)</span>:
        <span class="s1">&#39;&#39;&#39;</span><span class="s"> Shell command execution with parameters </span><span class="s1">&#39;&#39;&#39;</span>
        <span class="nb">params</span> <span class="o">=</span> {<span class="s1">&#39;</span><span class="s">client</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">local</span><span class="s1">&#39;</span>, <span class="s1">&#39;</span><span class="s">tgt</span><span class="s1">&#39;</span>: <span class="nv">tgt</span>, <span class="s1">&#39;</span><span class="s">fun</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">cmd.run</span><span class="s1">&#39;</span>, <span class="s1">&#39;</span><span class="s">arg</span><span class="s1">&#39;</span>: <span class="nv">arg</span>, <span class="s1">&#39;</span><span class="s">expr_form</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">list</span><span class="s1">&#39;</span>}
        <span class="nv">content</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">postRequest</span><span class="ss">(</span><span class="nb">params</span><span class="ss">)</span>
        <span class="nv">ret</span> <span class="o">=</span> <span class="nv">content</span>[<span class="s1">&#39;</span><span class="s">return</span><span class="s1">&#39;</span>][<span class="mi">0</span>]
        <span class="k">return</span> <span class="nv">ret</span>
    <span class="nv">def</span> <span class="nv">grains</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">tgt</span>, <span class="nv">arg</span><span class="ss">)</span>:
        <span class="s1">&#39;&#39;&#39;</span><span class="s"> Grains.item </span><span class="s1">&#39;&#39;&#39;</span>
        <span class="nb">params</span> <span class="o">=</span> {<span class="s1">&#39;</span><span class="s">client</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">local</span><span class="s1">&#39;</span>, <span class="s1">&#39;</span><span class="s">tgt</span><span class="s1">&#39;</span>: <span class="nv">tgt</span>, <span class="s1">&#39;</span><span class="s">fun</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">grains.item</span><span class="s1">&#39;</span>, <span class="s1">&#39;</span><span class="s">arg</span><span class="s1">&#39;</span>: <span class="nv">arg</span>}
        <span class="nv">content</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">postRequest</span><span class="ss">(</span><span class="nb">params</span><span class="ss">)</span>
        <span class="nv">ret</span> <span class="o">=</span> <span class="nv">content</span>[<span class="s1">&#39;</span><span class="s">return</span><span class="s1">&#39;</span>][<span class="mi">0</span>]
        <span class="k">return</span> <span class="nv">ret</span>
    <span class="nv">def</span> <span class="nv">target_remote_execution</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">tgt</span>, <span class="nv">fun</span>, <span class="nv">arg</span><span class="ss">)</span>:
        <span class="s1">&#39;&#39;&#39;</span><span class="s"> Use targeting for remote execution </span><span class="s1">&#39;&#39;&#39;</span>
        <span class="nb">params</span> <span class="o">=</span> {<span class="s1">&#39;</span><span class="s">client</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">local</span><span class="s1">&#39;</span>, <span class="s1">&#39;</span><span class="s">tgt</span><span class="s1">&#39;</span>: <span class="nv">tgt</span>, <span class="s1">&#39;</span><span class="s">fun</span><span class="s1">&#39;</span>: <span class="nv">fun</span>, <span class="s1">&#39;</span><span class="s">arg</span><span class="s1">&#39;</span>: <span class="nv">arg</span>, <span class="s1">&#39;</span><span class="s">expr_form</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">nodegroup</span><span class="s1">&#39;</span>}
        <span class="nv">content</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">postRequest</span><span class="ss">(</span><span class="nb">params</span><span class="ss">)</span>
        <span class="nv">jid</span> <span class="o">=</span> <span class="nv">content</span>[<span class="s1">&#39;</span><span class="s">return</span><span class="s1">&#39;</span>][<span class="mi">0</span>][<span class="s1">&#39;</span><span class="s">jid</span><span class="s1">&#39;</span>]
        <span class="k">return</span> <span class="nv">jid</span>
    <span class="nv">def</span> <span class="nv">deploy</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">tgt</span>, <span class="nv">arg</span><span class="ss">)</span>:
        <span class="s1">&#39;&#39;&#39;</span><span class="s"> Module deployment </span><span class="s1">&#39;&#39;&#39;</span>
        <span class="nb">params</span> <span class="o">=</span> {<span class="s1">&#39;</span><span class="s">client</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">local</span><span class="s1">&#39;</span>, <span class="s1">&#39;</span><span class="s">tgt</span><span class="s1">&#39;</span>: <span class="nv">tgt</span>, <span class="s1">&#39;</span><span class="s">fun</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">state.sls</span><span class="s1">&#39;</span>, <span class="s1">&#39;</span><span class="s">arg</span><span class="s1">&#39;</span>: <span class="nv">arg</span>}
        <span class="nv">content</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">postRequest</span><span class="ss">(</span><span class="nb">params</span><span class="ss">)</span>
        <span class="k">return</span> <span class="nv">content</span>
    <span class="nv">def</span> <span class="nv">async_deploy</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">tgt</span>, <span class="nv">arg</span><span class="ss">)</span>:
        <span class="s1">&#39;&#39;&#39;</span><span class="s"> Asynchronously send a command to connected minions </span><span class="s1">&#39;&#39;&#39;</span>
        <span class="nb">params</span> <span class="o">=</span> {<span class="s1">&#39;</span><span class="s">client</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">local_async</span><span class="s1">&#39;</span>, <span class="s1">&#39;</span><span class="s">tgt</span><span class="s1">&#39;</span>: <span class="nv">tgt</span>, <span class="s1">&#39;</span><span class="s">fun</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">state.sls</span><span class="s1">&#39;</span>, <span class="s1">&#39;</span><span class="s">arg</span><span class="s1">&#39;</span>: <span class="nv">arg</span>}
        <span class="nv">content</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">postRequest</span><span class="ss">(</span><span class="nb">params</span><span class="ss">)</span>
        <span class="nv">jid</span> <span class="o">=</span> <span class="nv">content</span>[<span class="s1">&#39;</span><span class="s">return</span><span class="s1">&#39;</span>][<span class="mi">0</span>][<span class="s1">&#39;</span><span class="s">jid</span><span class="s1">&#39;</span>]
        <span class="k">return</span> <span class="nv">jid</span>
    <span class="nv">def</span> <span class="nv">target_deploy</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">tgt</span>, <span class="nv">arg</span><span class="ss">)</span>:
        <span class="s1">&#39;&#39;&#39;</span><span class="s"> Based on the list forms deployment </span><span class="s1">&#39;&#39;&#39;</span>
        <span class="nb">params</span> <span class="o">=</span> {<span class="s1">&#39;</span><span class="s">client</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">local_async</span><span class="s1">&#39;</span>, <span class="s1">&#39;</span><span class="s">tgt</span><span class="s1">&#39;</span>: <span class="nv">tgt</span>, <span class="s1">&#39;</span><span class="s">fun</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">state.sls</span><span class="s1">&#39;</span>, <span class="s1">&#39;</span><span class="s">arg</span><span class="s1">&#39;</span>: <span class="nv">arg</span>, <span class="s1">&#39;</span><span class="s">expr_form</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">list</span><span class="s1">&#39;</span>}
        <span class="nv">content</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">postRequest</span><span class="ss">(</span><span class="nb">params</span><span class="ss">)</span>
        <span class="nv">jid</span> <span class="o">=</span> <span class="nv">content</span>[<span class="s1">&#39;</span><span class="s">return</span><span class="s1">&#39;</span>][<span class="mi">0</span>][<span class="s1">&#39;</span><span class="s">jid</span><span class="s1">&#39;</span>]
        <span class="k">return</span> <span class="nv">jid</span>
    <span class="nv">def</span> <span class="nv">jobs_list</span><span class="ss">(</span><span class="nv">self</span><span class="ss">)</span>:
        <span class="s1">&#39;&#39;&#39;</span><span class="s"> Get Cache Jobs Defaut 24h </span><span class="s1">&#39;&#39;&#39;</span>
        <span class="nv">url</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">__url</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="s">/jobs/</span><span class="s1">&#39;</span>
        <span class="nv">headers</span> <span class="o">=</span> {<span class="s1">&#39;</span><span class="s">X-Auth-Token</span><span class="s1">&#39;</span>: <span class="nv">self</span>.<span class="nv">__token_id</span>}
        <span class="nv">req</span> <span class="o">=</span> <span class="nv">urllib2</span>.<span class="nv">Request</span><span class="ss">(</span><span class="nv">url</span>, <span class="nv">headers</span><span class="o">=</span><span class="nv">headers</span><span class="ss">)</span>
        <span class="nv">opener</span> <span class="o">=</span> <span class="nv">urllib2</span>.<span class="nv">urlopen</span><span class="ss">(</span><span class="nv">req</span><span class="ss">)</span>
        <span class="nv">content</span> <span class="o">=</span> <span class="nv">json</span>.<span class="nv">loads</span><span class="ss">(</span><span class="nv">opener</span>.<span class="nv">read</span><span class="ss">())</span>
        <span class="nv">jid</span> <span class="o">=</span> <span class="nv">content</span>[<span class="s1">&#39;</span><span class="s">return</span><span class="s1">&#39;</span>][<span class="mi">0</span>]
        <span class="k">return</span> <span class="nv">jid</span>
    <span class="nv">def</span> <span class="nv">runner_status</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">arg</span><span class="ss">)</span>:
        <span class="s1">&#39;&#39;&#39;</span><span class="s"> Return minion status </span><span class="s1">&#39;&#39;&#39;</span>
        <span class="nb">params</span> <span class="o">=</span> {<span class="s1">&#39;</span><span class="s">client</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">runner</span><span class="s1">&#39;</span>, <span class="s1">&#39;</span><span class="s">fun</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">manage.</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nv">arg</span>}
        <span class="nv">content</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">postRequest</span><span class="ss">(</span><span class="nb">params</span><span class="ss">)</span>
        <span class="nv">jid</span> <span class="o">=</span> <span class="nv">content</span>[<span class="s1">&#39;</span><span class="s">return</span><span class="s1">&#39;</span>][<span class="mi">0</span>]
        <span class="k">return</span> <span class="nv">jid</span>
    <span class="nv">def</span> <span class="nv">runner</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">arg</span><span class="ss">)</span>:
        <span class="s1">&#39;&#39;&#39;</span><span class="s"> Return minion status </span><span class="s1">&#39;&#39;&#39;</span>
        <span class="nb">params</span> <span class="o">=</span> {<span class="s1">&#39;</span><span class="s">client</span><span class="s1">&#39;</span>: <span class="s1">&#39;</span><span class="s">runner</span><span class="s1">&#39;</span>, <span class="s1">&#39;</span><span class="s">fun</span><span class="s1">&#39;</span>: <span class="nv">arg</span>}
        <span class="nv">content</span> <span class="o">=</span> <span class="nv">self</span>.<span class="nv">postRequest</span><span class="ss">(</span><span class="nb">params</span><span class="ss">)</span>
        <span class="nv">jid</span> <span class="o">=</span> <span class="nv">content</span>[<span class="s1">&#39;</span><span class="s">return</span><span class="s1">&#39;</span>][<span class="mi">0</span>]
        <span class="k">return</span> <span class="nv">jid</span>
<span class="nv">cl</span> <span class="o">=</span> <span class="nv">SaltAPI</span><span class="ss">()</span>
<span class="nv">print</span> <span class="nv">cl</span>.<span class="nv">shell_remote_execution</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">aws-ms1</span><span class="s1">&#39;</span>,<span class="s1">&#39;</span><span class="s">date</span><span class="s1">&#39;</span><span class="ss">)</span>
<span class="nv">print</span> <span class="nv">cl</span>.<span class="nv">grains</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">aws-ms1</span><span class="s1">&#39;</span>,<span class="s1">&#39;</span><span class="s">ipv4</span><span class="s1">&#39;</span><span class="ss">)</span>


<span class="nv">WEB</span><span class="ss">(</span><span class="nv">halite</span><span class="ss">)</span>很不好用  

这个还行 <span class="nv">https</span>:<span class="o">//</span><span class="nv">github</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">yueyongyue</span><span class="o">/</span><span class="nv">saltshaker</span><span class="o">/</span>
<span class="nv">yum</span> <span class="nv">install</span> <span class="nv">salt</span><span class="o">-</span><span class="nv">api</span> <span class="nv">git</span>
<span class="nv">cd</span> <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">www</span><span class="o">/</span>
<span class="nv">git</span> <span class="nv">clone</span> <span class="nv">https</span>:<span class="o">//</span><span class="nv">github</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">saltstack</span><span class="o">/</span><span class="nv">halite</span>
<span class="nv">cd</span> <span class="nv">halite</span><span class="o">/</span><span class="nv">halite</span>
.<span class="o">/</span><span class="nv">genindex</span>.<span class="nv">py</span> <span class="o">-</span><span class="nv">C</span>

<span class="nv">vim</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">salt</span><span class="o">/</span><span class="nv">master</span>
<span class="nv">rest_cherrypy</span>:
<span class="nv">host</span>: <span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">0</span>
<span class="nv">port</span>: <span class="mi">8080</span>
<span class="nv">debug</span>: <span class="nv">true</span>
<span class="nv">disable_ssl</span>: <span class="nv">True</span>
<span class="nv">static</span>: <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">www</span><span class="o">/</span><span class="nv">halite</span><span class="o">/</span><span class="nv">halite</span>
<span class="nv">app</span>: <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">www</span><span class="o">/</span><span class="nv">halite</span><span class="o">/</span><span class="nv">halite</span><span class="o">/</span><span class="nv">index</span>.<span class="nv">html</span>

<span class="nv">external_auth</span>:
   <span class="nv">pam</span>:
     <span class="nv">salt</span>:
     <span class="o">-</span> .<span class="o">*</span>
     <span class="o">-</span> <span class="s1">&#39;</span><span class="s">@runner</span><span class="s1">&#39;</span>
     <span class="o">-</span> <span class="s1">&#39;</span><span class="s">@wheel</span><span class="s1">&#39;</span>
<span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">init</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">salt</span><span class="o">-</span><span class="nv">master</span> <span class="nv">restart</span>
<span class="nv">useradd</span> <span class="nv">salt</span>
<span class="nv">echo</span> <span class="nv">salt</span> <span class="o">|</span> <span class="nv">passwd</span> –<span class="nv">stdin</span> <span class="nv">salt</span>
<span class="nv">salt</span> <span class="o">-</span><span class="nv">a</span> <span class="nv">pam</span> \<span class="o">*</span>  <span class="nv">test</span>.<span class="nv">ping</span> 
输入用户和密码 如看到<span class="nv">minion</span>返回信息 则表示登陆验证成功

启动 <span class="nv">salt</span><span class="o">-</span><span class="nv">api</span>
<span class="nv">salt</span><span class="o">-</span><span class="nv">api</span> <span class="o">-</span><span class="nv">d</span> 或
<span class="nv">cd</span> <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">www</span><span class="o">/</span><span class="nv">halite</span><span class="o">/</span><span class="nv">halite</span>
<span class="nv">python</span> <span class="nv">server_bottle</span>.<span class="nv">py</span> <span class="o">-</span><span class="nv">d</span> <span class="o">-</span><span class="nv">C</span> <span class="o">-</span><span class="nv">l</span> <span class="nv">debug</span> <span class="o">-</span><span class="nv">s</span> <span class="nv">cherrypy</span>
打开<span class="nv">http</span>:<span class="o">//</span><span class="nv">ip</span>:<span class="mi">8080</span><span class="o">/</span><span class="nv">app</span>
</pre></div>


<h2 id="beacons">beacons</h2>
<div class="codehilite"><pre><span></span><span class="nv">https</span>:<span class="o">//</span><span class="nv">docs</span>.<span class="nv">saltstack</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">en</span><span class="o">/</span><span class="nv">latest</span><span class="o">/</span><span class="nv">topics</span><span class="o">/</span><span class="nv">beacons</span><span class="o">/</span><span class="nv">index</span>.<span class="nv">html</span>
<span class="nv">https</span>:<span class="o">//</span><span class="nv">docs</span>.<span class="nv">saltstack</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">en</span><span class="o">/</span><span class="nv">latest</span><span class="o">/</span><span class="nv">ref</span><span class="o">/</span><span class="nv">beacons</span><span class="o">/</span><span class="nv">all</span><span class="o">/</span><span class="nv">index</span>.<span class="nv">html</span>#<span class="nv">all</span><span class="o">-</span><span class="nv">salt</span><span class="o">-</span><span class="nv">beacons</span>

<span class="mi">1</span> 在<span class="nv">minion</span>上定义<span class="nv">beacon</span>
<span class="nv">beacons</span>:
  <span class="nv">service</span>:
    <span class="nv">httpd</span>:
      <span class="nv">onchangeonly</span>: <span class="nv">True</span>
      <span class="nv">uncleanshutdown</span>: <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">run</span><span class="o">/</span><span class="nv">httpd</span><span class="o">/</span><span class="nv">httpd</span>.<span class="nv">pid</span>
只要<span class="nv">httpd</span>的状态放生改变就会给<span class="nv">master</span>发送事件
<span class="mi">2</span> 你要知道发送的<span class="nv">event</span>长什么样
<span class="nv">salt</span><span class="o">/</span><span class="nv">beacon</span><span class="o">/</span><span class="nv">centos2</span><span class="o">/</span><span class="nv">service</span><span class="o">/</span>    {
    <span class="s2">&quot;</span><span class="s">_stamp</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">2015-12-06T07:24:25.095014</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">data</span><span class="s2">&quot;</span>: {
        <span class="s2">&quot;</span><span class="s">httpd</span><span class="s2">&quot;</span>: {
            <span class="s2">&quot;</span><span class="s">running</span><span class="s2">&quot;</span>: <span class="nv">false</span>,
            <span class="s2">&quot;</span><span class="s">shutdown</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">clean</span><span class="s2">&quot;</span>
        },
        <span class="s2">&quot;</span><span class="s">id</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">centos2</span><span class="s2">&quot;</span>
    },
    <span class="s2">&quot;</span><span class="s">tag</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">salt/beacon/centos2/service/</span><span class="s2">&quot;</span>
}

<span class="mi">3</span> 编写<span class="nv">master</span>配置文件，监听相对应的<span class="nv">tag</span>
<span class="nv">vim</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">salt</span><span class="o">/</span><span class="nv">master</span>
<span class="nv">reactor</span>:
  <span class="o">-</span> <span class="s1">&#39;</span><span class="s">salt/beacon/znode2/service/</span><span class="s1">&#39;</span>:
    <span class="o">-</span> <span class="s1">&#39;</span><span class="s">/srv/reactor/backup.sls</span><span class="s1">&#39;</span>

<span class="mi">4</span> 编写触发文件
<span class="nv">vim</span> <span class="o">/</span><span class="nv">srv</span><span class="o">/</span><span class="nv">reactor</span><span class="o">/</span><span class="nv">backup</span>.<span class="nv">sls</span>
{<span class="o">%</span><span class="k">if</span> <span class="nv">data</span>[<span class="s1">&#39;</span><span class="s">data</span><span class="s1">&#39;</span>][<span class="s1">&#39;</span><span class="s">httpd</span><span class="s1">&#39;</span>][<span class="s1">&#39;</span><span class="s">running</span><span class="s1">&#39;</span>] <span class="o">==</span> <span class="nv">False</span> <span class="o">%</span>}
<span class="nv">backup</span> <span class="nv">file</span>:
  <span class="nv">local</span>.<span class="nv">cmd</span>.<span class="nv">run</span>:
    <span class="o">-</span> <span class="nv">tgt</span>: {{<span class="nv">data</span>[<span class="s1">&#39;</span><span class="s">data</span><span class="s1">&#39;</span>][<span class="s1">&#39;</span><span class="s">id</span><span class="s1">&#39;</span>]}}
    <span class="o">-</span> <span class="nv">arg</span>:
      <span class="o">-</span> <span class="s2">&quot;</span><span class="s">/etc/init.d/httpd start</span><span class="s2">&quot;</span>
{<span class="o">%</span><span class="k">endif</span><span class="o">%</span>}

#如果调用的是<span class="nv">state</span>.<span class="nv">sls</span> 还要编写相对应的<span class="nv">sls</span>文件


自定义<span class="nv">beacon</span>插件
<span class="mi">1</span> <span class="nv">mkdir</span> <span class="o">-</span><span class="nv">pv</span> <span class="o">/</span><span class="nv">srv</span><span class="o">/</span><span class="nv">salt</span><span class="o">/</span><span class="nv">_beacons</span>
<span class="mi">2</span> 在这个目录下编写插件
<span class="mi">3</span> 同步
<span class="nv">salt</span> <span class="s1">&#39;</span><span class="s">*</span><span class="s1">&#39;</span> <span class="nv">saltutil</span>.<span class="nv">sync_all</span>

<span class="mi">4</span> <span class="nv">vim</span> <span class="nv">t</span>.<span class="nv">py</span>
#你在<span class="nv">minion</span>配置文件中的字典，会赋值给<span class="nv">config</span>
<span class="nv">beacons</span>:
  <span class="nv">t</span>:
    <span class="o">-</span> <span class="nv">rm</span>: <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">kk</span>
    <span class="o">-</span> <span class="nv">interval</span>: <span class="mi">2</span>

函数的返回值必须是[{<span class="s1">&#39;</span><span class="s">t1</span><span class="s1">&#39;</span>:<span class="mi">1</span>},{<span class="s1">&#39;</span><span class="s">t2</span><span class="s1">&#39;</span>:<span class="mi">2</span>}]

导入你需要的模块
<span class="nv">import</span> 模块名字
<span class="nv">def</span> <span class="nv">beacon</span><span class="ss">(</span><span class="nv">config</span><span class="ss">)</span>:
    <span class="nv">ret</span> <span class="o">=</span> []
    <span class="nv">r_dict</span> <span class="o">=</span> {}
    拆分<span class="nv">config</span>然后去做你想做的判断
    然后把返回值追加到<span class="nv">ret</span>
    <span class="k">return</span> <span class="nv">ret</span>

做一个最简单的审计系统
# <span class="o">-*-</span> <span class="nv">coding</span>: <span class="nv">utf</span><span class="o">-</span><span class="mi">8</span> <span class="o">-*-</span>

<span class="nv">import</span> <span class="nv">logging</span>
<span class="nv">import</span> <span class="nv">re</span>
<span class="nv">import</span> <span class="nv">pexpect</span>
<span class="nv">log</span> <span class="o">=</span> <span class="nv">logging</span>.<span class="nv">getLogger</span><span class="ss">(</span><span class="nv">__name__</span><span class="ss">)</span>

<span class="nv">__virtualname__</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">t</span><span class="s1">&#39;</span>

<span class="s2">&quot;&quot;&quot;</span>
<span class="nv">def</span> <span class="nv">__virtual__</span><span class="ss">()</span>:
    <span class="k">if</span> <span class="nv">salt</span>.<span class="nv">utils</span>.<span class="nv">is_windows</span><span class="ss">()</span>:
        <span class="k">return</span> <span class="nv">False</span>
    <span class="k">else</span>:
        <span class="k">return</span> <span class="nv">__virtualname__</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="nv">def</span> <span class="nv">beacon</span><span class="ss">(</span><span class="nv">config</span><span class="ss">)</span>:
    <span class="s1">&#39;&#39;&#39;</span>
    <span class="nv">code_block</span>:: <span class="nv">yaml</span>

        <span class="nv">beacons</span>:
          <span class="nv">t</span>:
            <span class="o">-</span> <span class="nv">rm</span> : <span class="o">/</span>
            <span class="o">-</span> <span class="nv">interval</span>: <span class="mi">100</span>
    <span class="s1">&#39;&#39;&#39;</span>
    <span class="nv">ret</span> <span class="o">=</span> []
    <span class="nv">user</span> <span class="o">=</span> <span class="nv">__salt__</span>[<span class="s1">&#39;</span><span class="s">cmd.run</span><span class="s1">&#39;</span>]<span class="ss">(</span><span class="s1">&#39;</span><span class="s">whoami</span><span class="s1">&#39;</span><span class="ss">)</span>
    <span class="nv">logging</span>.<span class="nv">debug</span><span class="ss">(</span><span class="nv">user</span><span class="ss">)</span>
    <span class="nv">r_dict</span> <span class="o">=</span> {}
    <span class="k">for</span> <span class="nv">t</span> <span class="nv">in</span> <span class="nv">config</span>:
        <span class="k">for</span> <span class="nv">k</span>,<span class="nv">v</span> <span class="nv">in</span> <span class="nv">t</span>.<span class="nv">items</span><span class="ss">()</span>:
            <span class="nv">cmd</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">grep &#39;^.*rm.* /tmp/kk[[:space:]]$&#39; /tmp/.shellog</span><span class="s2">&quot;</span>
            <span class="nv">output</span>, <span class="nv">status</span> <span class="o">=</span> <span class="nv">pexpect</span>.<span class="nv">run</span><span class="ss">(</span><span class="nv">cmd</span>, <span class="nv">withexitstatus</span><span class="o">=</span><span class="mi">1</span><span class="ss">)</span>
            <span class="k">if</span> <span class="nv">status</span> <span class="o">==</span> <span class="mi">0</span> :
                <span class="nv">logging</span>.<span class="nv">debug</span><span class="ss">(</span><span class="nv">output</span><span class="ss">)</span>
                <span class="nv">r_dict</span> <span class="o">=</span> { <span class="nv">user</span> : <span class="nv">output</span>}
                <span class="nv">logging</span>.<span class="nv">debug</span><span class="ss">(</span><span class="nv">r_dict</span><span class="ss">)</span>
                <span class="nv">ret</span>.<span class="nv">append</span><span class="ss">(</span><span class="nv">r_dict</span><span class="ss">)</span>

    <span class="k">return</span> <span class="nv">ret</span>
</pre></div>


<h2 id="zabbix_agent">安装zabbix_agent</h2>
<div class="codehilite"><pre><span></span><span class="nv">ls</span> <span class="nv">zabbix_linux_install</span><span class="o">/</span>
<span class="nv">agent_install</span>.<span class="nv">sls</span>  <span class="nv">init</span>.<span class="nv">sls</span>  <span class="nv">zabbix_agentd</span>.<span class="nv">conf</span>  <span class="nv">zabbix</span>.<span class="nv">repo</span>

<span class="nv">cat</span> <span class="nv">init</span>.<span class="nv">sls</span>
<span class="k">include</span>:
  <span class="o">-</span> <span class="nv">zabbix_linux_install</span>.<span class="nv">agent_install</span>

<span class="nv">cat</span> <span class="nv">zabbix</span>.<span class="nv">repo</span>
[<span class="nv">zabbix</span>]
<span class="nv">baseurl</span><span class="o">=</span><span class="nv">http</span>:<span class="o">//</span><span class="nv">mirrors</span>.<span class="nv">aliyun</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="mi">2</span>.<span class="mi">4</span><span class="o">/</span><span class="nv">rhel</span><span class="o">/</span><span class="mi">6</span><span class="o">/</span><span class="nv">x86_64</span><span class="o">/</span>
<span class="nv">gpgcheck</span><span class="o">=</span><span class="mi">0</span>

<span class="nv">cat</span> <span class="nv">agent_install</span>.<span class="nv">sls</span>
<span class="nv">agent_install</span>.<span class="nv">sls</span>
<span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">yum</span>.<span class="nv">repos</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">zabbix</span>.<span class="nv">repo</span>:
  <span class="nv">file</span>.<span class="nv">managed</span>:
    <span class="o">-</span> <span class="nv">source</span>: <span class="nv">salt</span>:<span class="o">//</span><span class="nv">zabbix_linux_install</span><span class="o">/</span><span class="nv">zabbix</span>.<span class="nv">repo</span>

<span class="nv">zabbix</span><span class="o">-</span><span class="nv">agent</span>:
  <span class="nv">cmd</span>.<span class="nv">run</span>:
    <span class="o">-</span> <span class="nv">name</span>: <span class="nv">yum</span> <span class="nv">install</span> <span class="nv">zabbix</span><span class="o">-</span><span class="nv">agent</span><span class="o">-</span><span class="mi">2</span>.<span class="mi">4</span>.<span class="mi">5</span> <span class="o">-</span><span class="nv">y</span>
    <span class="o">-</span> <span class="nv">require</span>:
      <span class="o">-</span> <span class="nv">file</span>: <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">yum</span>.<span class="nv">repos</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">zabbix</span>.<span class="nv">repo</span>
  <span class="nv">service</span>.<span class="nv">running</span>:
    <span class="o">-</span> <span class="nv">require</span>:
      <span class="o">-</span> <span class="nv">cmd</span>: <span class="nv">zabbix</span><span class="o">-</span><span class="nv">agent</span>
    <span class="o">-</span> <span class="nv">watch</span>:
      <span class="o">-</span> <span class="nv">file</span>: <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">zabbix_agentd</span>.<span class="nv">conf</span>

<span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">zabbix_agentd</span>.<span class="nv">conf</span>:
  <span class="nv">file</span>.<span class="nv">managed</span>:
    <span class="o">-</span> <span class="nv">source</span>: <span class="nv">salt</span>:<span class="o">//</span><span class="nv">zabbix_linux_install</span><span class="o">/</span><span class="nv">zabbix_agentd</span>.<span class="nv">conf</span>    <span class="ss">(</span> 主要内容：<span class="nv">Hostname</span><span class="o">=</span>{{ <span class="nv">grains</span>[<span class="s1">&#39;</span><span class="s">ip_interfaces</span><span class="s1">&#39;</span>]
                                                                                       [<span class="s1">&#39;</span><span class="s">eth1</span><span class="s1">&#39;</span>][<span class="mi">0</span>] }}<span class="ss">)</span>
    <span class="o">-</span> <span class="nv">template</span>: <span class="nv">jinja</span>
    <span class="o">-</span> <span class="nv">require</span>:
      <span class="o">-</span> <span class="nv">cmd</span>: <span class="nv">zabbix</span><span class="o">-</span><span class="nv">agent</span>



老师的
{<span class="o">%</span> <span class="nv">set</span> <span class="nv">NODENAME</span> <span class="o">=</span> <span class="nv">grains</span>[<span class="s1">&#39;</span><span class="s">nodename</span><span class="s1">&#39;</span>] <span class="o">%</span>}
{<span class="o">%</span> <span class="nv">set</span> <span class="nv">BINDIR</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">/usr/local/zabbix/sbin</span><span class="s1">&#39;</span> <span class="o">%</span>}
{<span class="o">%</span> <span class="nv">set</span> <span class="nv">LOGDIR</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">/var/log/zabbix</span><span class="s1">&#39;</span> <span class="o">%</span>}
{<span class="o">%</span> <span class="nv">set</span> <span class="nv">Serverip</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">192.168.40.11</span><span class="s1">&#39;</span> <span class="o">%</span>}
# <span class="nv">source</span> <span class="nv">pacekages</span>
<span class="nv">zabbix_source</span>:
  <span class="nv">file</span>.<span class="nv">managed</span>:
    <span class="o">-</span> <span class="nv">name</span>: <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">-</span><span class="mi">2</span>.<span class="mi">4</span>.<span class="mi">1</span>.<span class="nv">tar</span>.<span class="nv">gz</span>
    <span class="o">-</span> <span class="nv">unless</span>: <span class="nv">test</span> <span class="o">-</span><span class="nv">e</span> <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">-</span><span class="mi">2</span>.<span class="mi">4</span>.<span class="mi">1</span>.<span class="nv">tar</span>.<span class="nv">gz</span>
    <span class="o">-</span> <span class="nv">source</span>: <span class="nv">salt</span>:<span class="o">//</span><span class="nv">files</span><span class="o">/</span><span class="nv">common</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">-</span><span class="mi">2</span>.<span class="mi">4</span>.<span class="mi">1</span>.<span class="nv">tar</span>.<span class="nv">gz</span>

#<span class="nv">trace</span> <span class="nv">zabbix</span>
<span class="nv">extract_zabbix</span>:
  <span class="nv">cmd</span>.<span class="nv">run</span>:
    <span class="o">-</span> <span class="nv">cwd</span>: <span class="o">/</span><span class="nv">tmp</span>
    <span class="o">-</span> <span class="nv">names</span>:
      <span class="o">-</span> <span class="nv">tar</span> <span class="o">-</span><span class="nv">zxf</span> <span class="nv">zabbix</span><span class="o">-</span><span class="mi">2</span>.<span class="mi">4</span>.<span class="mi">1</span>.<span class="nv">tar</span>.<span class="nv">gz</span> <span class="o">&gt;/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>
    <span class="o">-</span> <span class="nv">unless</span>: <span class="nv">test</span> <span class="o">-</span><span class="nv">d</span> <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">-</span><span class="mi">2</span>.<span class="mi">4</span>.<span class="mi">1</span><span class="o">/</span>
    <span class="o">-</span> <span class="nv">require</span>:
      <span class="o">-</span> <span class="nv">file</span>: <span class="nv">zabbix_source</span>


#<span class="nv">Add</span> <span class="nv">user</span>
<span class="nv">zabbix_user</span>:
  <span class="nv">user</span>.<span class="nv">present</span>:
    <span class="o">-</span> <span class="nv">name</span>: <span class="nv">zabbix</span>
    <span class="o">-</span> <span class="nv">uid</span>: <span class="mi">1000</span>
    <span class="o">-</span> <span class="nv">createhome</span>: <span class="nv">False</span>
    <span class="o">-</span> <span class="nv">gid_from_name</span>: <span class="nv">True</span>
    <span class="o">-</span> <span class="nv">shell</span>: <span class="o">/</span><span class="nv">sbin</span><span class="o">/</span><span class="nv">nologin</span>
<span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">log</span><span class="o">/</span><span class="nv">zabbix</span>:
  <span class="nv">file</span>.<span class="nv">directory</span>:
    <span class="o">-</span> <span class="nv">user</span>: <span class="nv">zabbix</span>
    <span class="o">-</span> <span class="nv">group</span>: <span class="nv">zabbix</span>
    <span class="o">-</span> <span class="nv">dir_mode</span>: <span class="mi">755</span>
    <span class="o">-</span> <span class="nv">file_mode</span>: <span class="mi">655</span>
    <span class="o">-</span> <span class="nv">recurse</span>:
      <span class="o">-</span> <span class="nv">user</span>
      <span class="o">-</span> <span class="nv">group</span>
<span class="s2">&quot;</span><span class="s">init.sls</span><span class="s2">&quot;</span> <span class="mi">87</span><span class="nv">L</span>, <span class="mi">2508</span><span class="nv">C</span>
<span class="nv">agent_start_init</span>:
  <span class="nv">file</span>.<span class="nv">managed</span>:
    <span class="o">-</span> <span class="nv">name</span>: <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">init</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">zabbix_agentd</span>
    <span class="o">-</span> <span class="nv">user</span>: <span class="nv">root</span>
    <span class="o">-</span> <span class="nv">mode</span>: <span class="mi">0755</span>
    <span class="o">-</span> <span class="nv">source</span>: <span class="nv">salt</span>:<span class="o">//</span><span class="nv">files</span><span class="o">/</span><span class="nv">common</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">zabbix_agentd</span>
    <span class="o">-</span> <span class="nv">source_hash</span>: <span class="nv">salt</span>:<span class="o">//</span><span class="nv">files</span><span class="o">/</span><span class="nv">common</span><span class="o">/</span><span class="nv">zabbix_agent</span><span class="o">/</span><span class="nv">zabbix_agentd</span>
    <span class="o">-</span> <span class="nv">template</span>: <span class="nv">jinja</span>
    <span class="o">-</span> <span class="nv">defaults</span>:
      <span class="nv">ZABBIX_BIN</span>: {{ <span class="nv">BINDIR</span> }}
    <span class="o">-</span> <span class="nv">unless</span>: <span class="k">if</span> [[ ${<span class="nv">cat</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">init</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">zabbix_agentd</span>  <span class="o">|</span> <span class="nv">grep</span> <span class="s2">&quot;</span><span class="s">{{ BINDIR }}</span><span class="s2">&quot;</span> <span class="o">|</span> <span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span><span class="s1">&#39;</span><span class="s">=</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">NR==1{print $2}</span><span class="s1">&#39;</span>} <span class="o">=</span> 
                                                                                 <span class="s1">&#39;</span><span class="s">&quot;{{ BINDIR }}&quot;</span><span class="s1">&#39;</span> ]]<span class="c1">;then exit 0;fi</span>
  <span class="nv">cmd</span>.<span class="nv">run</span>:
    <span class="o">-</span> <span class="nv">names</span>:
      <span class="o">-</span> <span class="o">/</span><span class="nv">sbin</span><span class="o">/</span><span class="nv">chkconfig</span> <span class="o">--</span><span class="nv">add</span> <span class="nv">zabbix_agentd</span>
      <span class="o">-</span> <span class="o">/</span><span class="nv">sbin</span><span class="o">/</span><span class="nv">chkconfig</span> <span class="nv">zabbix_agentd</span> <span class="nv">on</span>
    <span class="o">-</span> <span class="nv">unless</span>: <span class="o">/</span><span class="nv">sbin</span><span class="o">/</span><span class="nv">chkconfig</span> <span class="o">--</span><span class="nv">list</span> <span class="nv">zabbix_agentd</span>
  <span class="nv">service</span>.<span class="nv">running</span>:
    <span class="o">-</span> <span class="nv">name</span>: <span class="nv">zabbix_agentd</span>
    <span class="o">-</span> <span class="nv">enable</span>: <span class="nv">True</span>
    <span class="o">-</span> <span class="nv">restart</span>: <span class="nv">True</span>
<span class="nv">zabbix_config_set</span>:
  <span class="nv">file</span>.<span class="nv">managed</span>:
    <span class="o">-</span> <span class="nv">name</span>: <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">zabbix_agentd</span>.<span class="nv">conf</span>
    <span class="o">-</span> <span class="nv">user</span>: <span class="nv">root</span>
    <span class="o">-</span> <span class="nv">mode</span>: <span class="mi">744</span>
    <span class="o">-</span> <span class="nv">source</span>: <span class="nv">salt</span>:<span class="o">//</span><span class="nv">files</span><span class="o">/</span><span class="nv">common</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">zabbix_agentd</span>.<span class="nv">conf</span>
    <span class="o">-</span> <span class="nv">template</span>: <span class="nv">jinja</span>
    <span class="o">-</span> <span class="nv">defaults</span>:
      <span class="nv">ServerADD</span>: {{ <span class="nv">Serverip</span> }}
      <span class="nv">AgentNAME</span>: {{ <span class="nv">NODENAME</span> }}
    <span class="o">-</span> <span class="nv">unless</span>: <span class="k">if</span> <span class="nv">grep</span> <span class="s1">&#39;</span><span class="s">{{ NODENAME }}</span><span class="s1">&#39;</span> <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">zabbix_agentd</span>.<span class="nv">conf</span> <span class="o">&gt;/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span><span class="c1">;then exit 0;fi</span>
<span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">zabbix_get</span>:
  <span class="nv">file</span>.<span class="nv">symlink</span>:
    <span class="o">-</span> <span class="nv">target</span>: <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">zabbix_get</span>
    <span class="o">-</span> <span class="nv">unless</span>: <span class="nv">test</span> <span class="o">-</span><span class="nv">L</span> <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">zabbix_get</span>
<span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">zabbix_sender</span>:
  <span class="nv">file</span>.<span class="nv">symlink</span>:
    <span class="o">-</span> <span class="nv">target</span>: <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">zabbix</span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">zabbix_sender</span>
    <span class="o">-</span> <span class="nv">unless</span>: <span class="nv">test</span> <span class="o">-</span><span class="nv">L</span> <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">zabbix_sender</span>
</pre></div>


<h2 id="salt">显示salt进程具体名称</h2>
<div class="codehilite"><pre><span></span><span class="err">安装</span><span class="n">setproctitle</span><span class="p">(</span><span class="n">Master</span><span class="o">/</span><span class="n">Minion</span><span class="err">端均进行</span><span class="p">)</span>

<span class="n">yum</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">python</span><span class="o">-</span><span class="n">setproctitle</span>
<span class="err">重启</span><span class="n">salt</span>

<span class="n">service</span> <span class="n">salt</span><span class="o">-</span><span class="n">master</span> <span class="k">restart</span>
<span class="n">service</span> <span class="n">salt</span><span class="o">-</span><span class="n">minion</span> <span class="k">restart</span>
<span class="err">查看</span><span class="n">Master</span><span class="err">端进程</span>

<span class="n">ps</span> <span class="n">ax</span> <span class="o">|</span><span class="n">grep</span> <span class="n">salt</span> <span class="o">|</span><span class="n">grep</span> <span class="o">-</span><span class="n">v</span> <span class="n">salt</span>
<span class="n">Master</span><span class="err">端显示如下</span><span class="p">(</span><span class="err">同时个人在行尾追加上进程的具体用途</span><span class="p">):</span>

<span class="mi">2943</span> <span class="o">?</span>        <span class="n">S</span>      <span class="mi">0</span><span class="p">:</span><span class="mi">00</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">python</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">salt</span><span class="o">-</span><span class="n">master</span> <span class="o">-</span><span class="n">d</span> <span class="n">ProcessManager</span>       <span class="o">#</span> <span class="err">中心进程管理器</span>
<span class="mi">2944</span> <span class="o">?</span>        <span class="n">S</span>      <span class="mi">0</span><span class="p">:</span><span class="mi">00</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">python</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">salt</span><span class="o">-</span><span class="n">master</span> <span class="o">-</span><span class="n">d</span> <span class="n">_clear_old_jobs</span>      <span class="o">#</span> <span class="err">清除旧的</span><span class="n">Jobs</span><span class="err">文件及更新</span><span class="n">fileserver</span>
<span class="mi">2945</span> <span class="o">?</span>        <span class="n">Sl</span>     <span class="mi">0</span><span class="p">:</span><span class="mi">00</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">python</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">salt</span><span class="o">-</span><span class="n">master</span> <span class="o">-</span><span class="n">d</span> <span class="n">Publisher</span>            <span class="o">#</span> <span class="err">将任务</span><span class="n">PUB</span><span class="err">到</span><span class="n">Minion</span><span class="err">端</span>
<span class="mi">2946</span> <span class="o">?</span>        <span class="n">Sl</span>     <span class="mi">0</span><span class="p">:</span><span class="mi">00</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">python</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">salt</span><span class="o">-</span><span class="n">master</span> <span class="o">-</span><span class="n">d</span> <span class="n">EventPublisher</span>       <span class="o">#</span> <span class="n">Event</span> <span class="n">Publisher</span><span class="err">进程</span>
<span class="mi">2951</span> <span class="o">?</span>        <span class="n">S</span>      <span class="mi">0</span><span class="p">:</span><span class="mi">00</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">python</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">salt</span><span class="o">-</span><span class="n">master</span> <span class="o">-</span><span class="n">d</span> <span class="n">ReqServer_ProcessManager</span>    <span class="o">#</span> <span class="n">ReqServer</span><span class="err">进程管理器</span>
<span class="mi">2952</span> <span class="o">?</span>        <span class="n">Sl</span>     <span class="mi">0</span><span class="p">:</span><span class="mi">01</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">python</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">salt</span><span class="o">-</span><span class="n">master</span> <span class="o">-</span><span class="n">d</span> <span class="n">MWorker</span>              <span class="o">#</span> <span class="err">劳苦大众</span><span class="p">,</span> <span class="err">奋斗在一线的</span><span class="n">Worker</span><span class="err">进程</span>
<span class="mi">2953</span> <span class="o">?</span>        <span class="n">Sl</span>     <span class="mi">0</span><span class="p">:</span><span class="mi">01</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">python</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">salt</span><span class="o">-</span><span class="n">master</span> <span class="o">-</span><span class="n">d</span> <span class="n">MWorker</span>              <span class="o">#</span> <span class="err">同楼上</span>
<span class="mi">2954</span> <span class="o">?</span>        <span class="n">Sl</span>     <span class="mi">0</span><span class="p">:</span><span class="mi">01</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">python</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">salt</span><span class="o">-</span><span class="n">master</span> <span class="o">-</span><span class="n">d</span> <span class="n">MWorker</span>
<span class="mi">2955</span> <span class="o">?</span>        <span class="n">Sl</span>     <span class="mi">0</span><span class="p">:</span><span class="mi">01</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">python</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">salt</span><span class="o">-</span><span class="n">master</span> <span class="o">-</span><span class="n">d</span> <span class="n">MWorker</span>
<span class="mi">2956</span> <span class="o">?</span>        <span class="n">Sl</span>     <span class="mi">0</span><span class="p">:</span><span class="mi">01</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">python</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">salt</span><span class="o">-</span><span class="n">master</span> <span class="o">-</span><span class="n">d</span> <span class="n">MWorker</span>
<span class="mi">2957</span> <span class="o">?</span>        <span class="n">Sl</span>     <span class="mi">0</span><span class="p">:</span><span class="mi">00</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">python</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">salt</span><span class="o">-</span><span class="n">master</span> <span class="o">-</span><span class="n">d</span> <span class="n">MWorkerQueue</span>         
<span class="o">#</span> <span class="err">将</span><span class="n">Ret</span><span class="err">接口</span><span class="p">(</span><span class="n">ROUTER</span><span class="p">)</span><span class="err">数据转发到</span><span class="n">Worker</span><span class="p">(</span><span class="n">DEALER</span><span class="p">)</span>
<span class="err">执行个任务</span><span class="p">,</span> <span class="err">看看</span><span class="n">Minion</span><span class="err">端怎么显示</span><span class="p">(</span><span class="err">同时个人在行尾追加上进程的具体用途</span><span class="p">):</span>

<span class="mi">2003</span> <span class="o">?</span>        <span class="n">Sl</span>     <span class="mi">0</span><span class="p">:</span><span class="mi">01</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">python</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">salt</span><span class="o">-</span><span class="n">minion</span> <span class="o">-</span><span class="n">d</span>        <span class="o">#</span> <span class="n">Minion</span><span class="err">进程</span><span class="p">,</span> <span class="err">接收来自</span><span class="n">Master</span><span class="err">端的任务</span>
<span class="mi">2069</span> <span class="o">?</span>        <span class="n">S</span>      <span class="mi">0</span><span class="p">:</span><span class="mi">00</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">python</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">salt</span><span class="o">-</span><span class="n">minion</span> <span class="o">-</span><span class="n">d</span> <span class="mi">20150108034936245247</span>   <span class="o">#</span> <span class="err">接收到任务后</span><span class="p">,</span> <span class="err">会启动名为</span>
<span class="err">对应</span><span class="n">jid</span><span class="err">的进程进行任务处理及结果反馈</span>
<span class="err">这样</span><span class="p">,</span> <span class="err">就可以非常清晰的知道</span><span class="n">Salt</span><span class="err">的每个进程是做什么用途的</span><span class="p">,</span> <span class="err">如果</span><span class="n">Master</span><span class="o">/</span><span class="n">Minion</span><span class="err">进程异常</span><span class="p">,</span> <span class="err">也可以迅速的定位</span>
</pre></div>


<h2 id="salt_1">salt安装</h2>
<div class="codehilite"><pre><span></span>并发 <span class="o">==</span> 效率
差异性

<span class="mi">4505</span>  <span class="mi">4506</span> <span class="nv">master</span>        队列  <span class="nv">zeromq</span>，<span class="nv">raet</span>

<span class="nv">salt</span><span class="o">-</span><span class="nv">call</span> <span class="o">--</span><span class="nv">master</span><span class="o">=</span><span class="mi">10</span>.<span class="mi">21</span>.<span class="mi">40</span>.<span class="mi">23</span> <span class="o">--</span><span class="nv">id</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">host1</span><span class="s2">&quot;</span> <span class="nv">state</span>.<span class="nv">highstate</span>

<span class="nv">yum</span>安装
<span class="nv">https</span>:<span class="o">//</span><span class="nv">repo</span>.<span class="nv">saltstack</span>.<span class="nv">com</span><span class="o">/</span>#<span class="nv">rhel</span>  <span class="nv">salt</span>官方源，版本更新
<span class="nv">http</span>:<span class="o">//</span><span class="nv">repo</span>.<span class="nv">saltstack</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">yum</span><span class="o">/</span><span class="nv">redhat</span>
[<span class="nv">saltstack</span><span class="o">-</span><span class="nv">repo</span>]
<span class="nv">name</span><span class="o">=</span><span class="nv">SaltStack</span> <span class="nv">repo</span> <span class="k">for</span> <span class="nv">RHEL</span><span class="o">/</span><span class="nv">CentOS</span> $<span class="nv">releasever</span>
<span class="nv">baseurl</span><span class="o">=</span><span class="nv">http</span>:<span class="o">//</span><span class="nv">repo</span>.<span class="nv">saltstack</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">yum</span><span class="o">/</span><span class="nv">redhat</span><span class="o">/</span>$<span class="nv">releasever</span><span class="o">/</span><span class="mh">$ba</span><span class="nv">search</span><span class="o">/</span><span class="nv">latest</span>
<span class="nv">enabled</span><span class="o">=</span><span class="mi">1</span>
<span class="nv">gpgcheck</span><span class="o">=</span><span class="mi">1</span>
<span class="nv">gpgkey</span><span class="o">=</span><span class="nv">http</span>:<span class="o">//</span><span class="nv">repo</span>.<span class="nv">saltstack</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">yum</span><span class="o">/</span><span class="nv">redhat</span><span class="o">/</span>$<span class="nv">releasever</span><span class="o">/</span><span class="mh">$ba</span><span class="nv">search</span><span class="o">/</span><span class="nv">latest</span><span class="o">/</span><span class="nv">SALTSTACK</span><span class="o">-</span><span class="nv">GPG</span><span class="o">-</span><span class="nv">KEY</span>.<span class="nv">pub</span>

<span class="nv">yum</span> <span class="nv">install</span> <span class="nv">epel</span><span class="o">-</span><span class="nv">release</span> 
<span class="nv">yum</span> <span class="nv">install</span> <span class="nv">salt</span><span class="o">-</span><span class="nv">master</span>
<span class="nv">master</span>端
<span class="nv">salt</span><span class="o">-</span><span class="mi">2014</span>.<span class="mi">1</span>.<span class="mi">10</span><span class="o">-</span><span class="mi">4</span>.<span class="nv">el6</span>.<span class="nv">noarch</span>
<span class="nv">salt</span><span class="o">-</span><span class="nv">master</span><span class="o">-</span><span class="mi">2014</span>.<span class="mi">1</span>.<span class="mi">10</span><span class="o">-</span><span class="mi">4</span>.<span class="nv">el6</span>.<span class="nv">noarch</span>
<span class="nv">salt</span><span class="o">-</span><span class="nv">minion</span><span class="o">-</span><span class="mi">2014</span>.<span class="mi">1</span>.<span class="mi">10</span><span class="o">-</span><span class="mi">4</span>.<span class="nv">el6</span>.<span class="nv">noarch</span>（<span class="nv">optional</span>）

<span class="nv">minion</span>端（客户端）
<span class="nv">yum</span> <span class="nv">install</span> <span class="nv">salt</span><span class="o">-</span><span class="nv">minion</span>
<span class="nv">salt</span><span class="o">-</span><span class="mi">2014</span>.<span class="mi">1</span>.<span class="mi">10</span><span class="o">-</span><span class="mi">4</span>.<span class="nv">el6</span>.<span class="nv">noarch</span>
<span class="nv">salt</span><span class="o">-</span><span class="nv">minion</span><span class="o">-</span><span class="mi">2014</span>.<span class="mi">1</span>.<span class="mi">10</span><span class="o">-</span><span class="mi">4</span>.<span class="nv">el6</span>.<span class="nv">noarch</span>

防火墙添加
<span class="nv">iptables</span> <span class="o">-</span><span class="nv">I</span> <span class="nv">INPUT</span> <span class="o">-</span><span class="nv">m</span> <span class="nv">state</span> <span class="o">--</span><span class="nv">state</span> <span class="nv">new</span> <span class="o">-</span><span class="nv">m</span> <span class="nv">tcp</span> <span class="o">-</span><span class="nv">p</span> <span class="nv">tcp</span> <span class="o">--</span><span class="nv">dport</span> <span class="mi">4505</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">ACCEPT</span>
<span class="nv">iptables</span> <span class="o">-</span><span class="nv">I</span> <span class="nv">INPUT</span> <span class="o">-</span><span class="nv">m</span> <span class="nv">state</span> <span class="o">--</span><span class="nv">state</span> <span class="nv">new</span> <span class="o">-</span><span class="nv">m</span> <span class="nv">tcp</span> <span class="o">-</span><span class="nv">p</span> <span class="nv">tcp</span> <span class="o">--</span><span class="nv">dport</span> <span class="mi">4506</span> <span class="o">-</span><span class="nv">j</span> <span class="nv">ACCEPT</span>

<span class="nv">python</span>安装
<span class="nv">yum</span> <span class="nv">install</span> <span class="nv">swig</span>
<span class="nv">yum</span> <span class="nv">install</span> <span class="nv">gcc</span> <span class="nv">gcc</span><span class="o">-</span><span class="nv">c</span><span class="o">++</span>
<span class="nv">yum</span> <span class="nv">install</span> <span class="nv">openssl</span><span class="o">-</span><span class="nv">devel</span>
<span class="nv">yum</span> <span class="nv">install</span> <span class="nv">libyaml</span><span class="o">-</span><span class="nv">devel</span> <span class="o">-</span><span class="nv">y</span>

<span class="nv">pip</span> <span class="nv">install</span> <span class="nv">M2Crypto</span>
<span class="nv">pip</span> <span class="nv">install</span> <span class="nv">pyzmq</span>
<span class="nv">pip</span> <span class="nv">uninstall</span> <span class="nv">PyCrypto</span>
<span class="nv">pip</span> <span class="nv">uninstall</span> <span class="nv">salt</span> <span class="nv">Jinja2</span> <span class="nv">msgpack</span><span class="o">-</span><span class="nv">python</span> <span class="nv">PyYAML</span> <span class="nv">MarkupSafe</span>
<span class="nv">pip</span> <span class="nv">install</span> <span class="nv">PyCrypto</span>
<span class="nv">cd</span> <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">python2</span>.<span class="mi">6</span><span class="o">/</span><span class="nv">site</span><span class="o">-</span><span class="nv">packages</span><span class="o">/</span>
<span class="nv">rm</span> <span class="o">-</span><span class="nv">fr</span> <span class="nv">salt</span> <span class="nv">salt</span><span class="o">-</span><span class="mi">2014</span>.<span class="mi">1</span>.<span class="mi">4</span><span class="o">-</span><span class="nv">py2</span>.<span class="mi">6</span>.<span class="nv">egg</span><span class="o">-</span><span class="nv">info</span><span class="o">/</span>
<span class="nv">pip</span> <span class="nv">install</span> <span class="nv">salt</span>

<span class="nv">http</span>:<span class="o">//</span><span class="nv">docs</span>.<span class="nv">saltstack</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">en</span><span class="o">/</span><span class="nv">latest</span><span class="o">/</span>



<span class="nv">http</span>:<span class="o">//</span><span class="nv">msgpack</span>.<span class="nv">org</span><span class="o">/</span>
<span class="nv">zeromq</span>
使用了消息队列
信息使用<span class="nv">msgpack</span>进行封装

选择<span class="nv">salt</span>的理由

<span class="mi">1</span> 使用消息队列（异步） <span class="nv">zeromq</span>
<span class="mi">2</span> 消息封装的是<span class="mi">2</span>机制 <span class="nv">msgpack</span>封装
<span class="mi">3</span> 安全使用<span class="nv">aes</span>算法
<span class="mi">4</span> 服务器开两个端口<span class="mi">4505</span> <span class="mi">4506</span>
<span class="mi">5</span> 理念是<span class="nv">block</span>（适合拼积木，实现业务流）

配置
在<span class="nv">master</span>上编辑<span class="nv">vim</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">hosts</span>
<span class="nv">master_ip</span>  <span class="nv">master_name</span>
<span class="nv">minion_ip</span>  <span class="nv">minion_name</span>
然后把这份文件同步到所有的主机上


修改文件描述符
修改<span class="nv">sk_buffer</span>
<span class="nv">echo</span> <span class="mi">16777216</span> <span class="o">&gt;</span> <span class="o">/</span><span class="nv">proc</span><span class="o">/</span><span class="nv">sys</span><span class="o">/</span><span class="nv">net</span><span class="o">/</span><span class="nv">core</span><span class="o">/</span><span class="nv">rmem_max</span>
<span class="nv">echo</span> <span class="mi">16777216</span> <span class="o">&gt;</span> <span class="o">/</span><span class="nv">proc</span><span class="o">/</span><span class="nv">sys</span><span class="o">/</span><span class="nv">net</span><span class="o">/</span><span class="nv">core</span><span class="o">/</span><span class="nv">wmem_max</span>
<span class="nv">echo</span> <span class="s2">&quot;</span><span class="s">4096 87380 16777216</span><span class="s2">&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="nv">proc</span><span class="o">/</span><span class="nv">sys</span><span class="o">/</span><span class="nv">net</span><span class="o">/</span><span class="nv">ipv4</span><span class="o">/</span><span class="nv">tcp_rmem</span>
<span class="nv">echo</span> <span class="s2">&quot;</span><span class="s">4096 87380 16777216</span><span class="s2">&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="nv">proc</span><span class="o">/</span><span class="nv">sys</span><span class="o">/</span><span class="nv">net</span><span class="o">/</span><span class="nv">ipv4</span><span class="o">/</span><span class="nv">tcp_wmem</span>

 <span class="nv">minion</span>  <span class="nv">vim</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">salt</span><span class="o">/</span><span class="nv">minion</span>
 <span class="nv">id</span>: <span class="nv">node2</span> <span class="ss">(</span><span class="nv">minion</span>的名字<span class="ss">)</span>            冒号后有空格
<span class="nv">master</span>: <span class="mi">10</span>.<span class="mi">255</span>.<span class="mi">254</span>.<span class="mi">221</span>（<span class="nv">master</span>的<span class="nv">ip</span>）
<span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">init</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">salt</span><span class="o">-</span><span class="nv">minion</span> <span class="nv">start</span>
<span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">init</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">salt</span><span class="o">-</span><span class="nv">master</span> <span class="nv">start</span>

查看你的<span class="nv">minion</span>是否发送了加入请求
[<span class="nv">root</span>@<span class="nv">node1</span> <span class="nv">salt</span>]# <span class="nv">salt</span><span class="o">-</span><span class="nv">key</span> <span class="o">-</span><span class="nv">L</span>
                <span class="nv">salt</span><span class="o">-</span><span class="nv">key</span> –<span class="nv">A</span>  接受所有<span class="nv">minion</span>   <span class="o">-</span><span class="nv">a</span> <span class="nv">minion</span>名字   接受指定的<span class="nv">minion</span>
测试
<span class="nv">salt</span> <span class="s1">&#39;</span><span class="s">*</span><span class="s1">&#39;</span> <span class="nv">test</span>.<span class="nv">ping</span>
   目标 模块.函数 函数的参数

如何定义目标
<span class="nv">shell</span>下的通配符
<span class="o">*</span>
<span class="s2">&quot;</span><span class="s">*.example.com</span><span class="s2">&quot;</span>
<span class="s2">&quot;</span><span class="s">web?.example.com</span><span class="s2">&quot;</span>
<span class="s2">&quot;</span><span class="s">web[1-5].example.com</span><span class="s2">&quot;</span>
<span class="nv">regex</span>  正则表达式
<span class="nv">salt</span> <span class="o">-</span><span class="nv">E</span> <span class="s1">&#39;</span><span class="s">web1-(prod|devel).example.com</span><span class="s1">&#39;</span>
<span class="nv">list</span>    列表的方式
<span class="nv">salt</span> <span class="o">-</span><span class="nv">L</span> <span class="s1">&#39;</span><span class="s">web1,web2,web3</span><span class="s1">&#39;</span>
<span class="nv">grains</span><span class="ss">(</span>数据存放在<span class="nv">minion</span>上，默认就有<span class="ss">)</span>
[<span class="nv">root</span>@<span class="nv">node1</span> <span class="nv">salt</span>]# <span class="nv">salt</span> <span class="s1">&#39;</span><span class="s">node1</span><span class="s1">&#39;</span> <span class="nv">grains</span>.<span class="nv">ls</span>
<span class="nv">salt</span> <span class="o">-</span><span class="nv">G</span> <span class="s1">&#39;</span><span class="s">os:CentOS</span><span class="s1">&#39;</span> <span class="nv">test</span>.<span class="nv">ping</span>
定义主机组
[<span class="nv">root</span>@<span class="nv">node1</span> <span class="nv">salt</span>]# <span class="nv">vim</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">salt</span><span class="o">/</span><span class="nv">master</span>
<span class="nv">salt</span> <span class="o">-</span><span class="nv">N</span> 组名 <span class="nv">test</span>.<span class="nv">ping</span>
批次执行<span class="o">-</span><span class="nv">b</span> （依次执行）

<span class="nv">salt</span> <span class="s1">&#39;</span><span class="s">*</span><span class="s1">&#39;</span> <span class="nv">sys</span>.<span class="nv">doc</span>
如何使用相对应的模块和函数
<span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">python2</span>.<span class="mi">6</span><span class="o">/</span><span class="nv">site</span><span class="o">-</span><span class="nv">packages</span><span class="o">/</span><span class="nv">salt</span><span class="o">/</span><span class="nv">modules</span>
<span class="nv">test</span>.<span class="nv">ping</span> <span class="ss">(</span>是在<span class="nv">minion</span>上执行<span class="ss">)</span>

<span class="nv">http</span>:<span class="o">//</span><span class="nv">docs</span>.<span class="nv">saltstack</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">en</span><span class="o">/</span><span class="nv">latest</span><span class="o">/</span><span class="nv">ref</span><span class="o">/</span><span class="nv">modules</span><span class="o">/</span><span class="nv">all</span><span class="o">/</span><span class="nv">index</span>.<span class="nv">html</span>
[<span class="nv">root</span>@<span class="nv">node1</span> <span class="nv">modules</span>]# <span class="nv">salt</span> <span class="s1">&#39;</span><span class="s">node3</span><span class="s1">&#39;</span> <span class="nv">cmd</span>.<span class="nv">run</span> <span class="s1">&#39;</span><span class="s">uptime</span><span class="s1">&#39;</span>
<span class="nv">salt</span>中文件的根目录
<span class="nv">file_roots</span>:
  <span class="nv">base</span>:
    <span class="o">-</span> <span class="o">/</span><span class="nv">srv</span><span class="o">/</span><span class="nv">salt</span>
<span class="nv">salt</span> <span class="s1">&#39;</span><span class="s">node2</span><span class="s1">&#39;</span> <span class="nv">cmd</span>.<span class="nv">script</span> <span class="nv">salt</span>:<span class="o">//</span><span class="nv">test</span>.<span class="nv">sh</span>
脚本缓存的路径
<span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">cache</span><span class="o">/</span><span class="nv">salt</span><span class="o">/</span><span class="nv">minion</span><span class="o">/</span><span class="nv">files</span><span class="o">/</span><span class="nv">base</span>
</pre></div>


<h2 id="minion-id">修改minion id</h2>
<div class="codehilite"><pre><span></span><span class="n">service</span> <span class="n">salt</span><span class="o">-</span><span class="n">minion</span> <span class="n">stop</span>
<span class="n">rm</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">salt</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">minion</span><span class="o">/</span><span class="n">minion</span><span class="p">.</span><span class="n">pub</span>
<span class="n">rm</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">salt</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">minion</span><span class="o">/</span><span class="n">minion</span><span class="p">.</span><span class="n">pem</span>
<span class="n">echo</span> <span class="err">$</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">salt</span><span class="o">/</span><span class="n">minion_id</span>
<span class="n">service</span> <span class="n">salt</span><span class="o">-</span><span class="n">minion</span> <span class="k">start</span>
</pre></div>


<h2 id="event">event和反射</h2>
<div class="codehilite"><pre><span></span><span class="mi">1</span>、<span class="nv">event</span>实际就是一个字典
这个字典有两个固定的<span class="nv">key</span>
<span class="s2">&quot;</span><span class="s">tag</span><span class="s2">&quot;</span> 可以用来区分哪一个<span class="nv">mininon</span>
<span class="s2">&quot;</span><span class="s">data</span><span class="s2">&quot;</span> 包含更详细的数据，比如执行是否成功，执行的是哪一个函数，以及<span class="nv">id</span>是谁
<span class="mi">2</span>、把你的<span class="nv">minion</span>和<span class="nv">master</span>，以及其他的<span class="nv">minion</span>可以联动起来

<span class="nv">master</span>执行  <span class="nv">salt</span><span class="o">-</span><span class="nv">run</span> <span class="nv">state</span>.<span class="nv">event</span> <span class="nv">pretty</span><span class="o">=</span><span class="nv">True</span>   捕捉<span class="nv">event</span>
<span class="nv">minion</span>执行 <span class="nv">salt</span><span class="o">-</span><span class="k">call</span> <span class="nl">event</span>.<span class="k">send</span>  <span class="s1">&#39;</span><span class="s">tag</span><span class="s1">&#39;</span>  <span class="s1">&#39;</span><span class="s">data</span><span class="s1">&#39;</span>  <span class="nv">data</span>可以没有,<span class="nv">tag</span>必须有
<span class="nv">master</span>再开一个终端执行<span class="nv">salt</span> <span class="s1">&#39;</span><span class="s">zabbix_server</span><span class="s1">&#39;</span> <span class="nv">state</span>.<span class="nv">sls</span> <span class="nv">apache_install</span>
捕捉到的<span class="nv">event</span>:
<span class="nv">salt</span><span class="o">/</span><span class="nv">job</span><span class="o">/</span><span class="mi">20151018191951447100</span><span class="o">/</span><span class="nv">ret</span><span class="o">/</span><span class="nv">zabbix_server</span>    {   <span class="nv">tag</span>和<span class="nv">data</span> ,字典为<span class="nv">data</span>
    <span class="s2">&quot;</span><span class="s">_stamp</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">2015-10-18T11:20:19.543008</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">cmd</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">_return</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">fun</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">state.sls</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">fun_args</span><span class="s2">&quot;</span>: [
        <span class="s2">&quot;</span><span class="s">apache_install</span><span class="s2">&quot;</span>
    ],
    <span class="s2">&quot;</span><span class="s">id</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">zabbix_server</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">jid</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">20151018191951447100</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">out</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">highstate</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">retcode</span><span class="s2">&quot;</span>: <span class="mi">0</span>,
    <span class="s2">&quot;</span><span class="s">return</span><span class="s2">&quot;</span>: {
        <span class="s2">&quot;</span><span class="s">pkg_|-httpd_|-httpd_|-installed</span><span class="s2">&quot;</span>: {
            <span class="s2">&quot;</span><span class="s">__run_num__</span><span class="s2">&quot;</span>: <span class="mi">0</span>,
            <span class="s2">&quot;</span><span class="s">changes</span><span class="s2">&quot;</span>: {},
            <span class="s2">&quot;</span><span class="s">comment</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">Package httpd is already installed.</span><span class="s2">&quot;</span>,
            <span class="s2">&quot;</span><span class="s">duration</span><span class="s2">&quot;</span>: <span class="mi">4001</span>.<span class="mi">181</span>,
            <span class="s2">&quot;</span><span class="s">name</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">httpd</span><span class="s2">&quot;</span>,
            <span class="s2">&quot;</span><span class="s">result</span><span class="s2">&quot;</span>: <span class="nv">true</span>,
            <span class="s2">&quot;</span><span class="s">start_time</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">11:20:14.264181</span><span class="s2">&quot;</span>
        }
    },
<span class="s2">&quot;</span><span class="s">success</span><span class="s2">&quot;</span>: <span class="nv">true</span>
}
}配置
修改<span class="nv">master</span>配置文件
<span class="nv">reactor</span>:
  <span class="o">-</span> <span class="s2">&quot;</span><span class="s">salt/job/*</span><span class="s2">&quot;</span>:        捕捉到的<span class="nv">tag</span>，<span class="nv">jid</span>会变化用了<span class="o">*</span>代替
    <span class="o">-</span> <span class="o">/</span><span class="nv">srv</span><span class="o">/</span><span class="nv">reactor</span><span class="o">/</span><span class="nv">my_custom_module</span>.<span class="nv">sls</span>     捕捉到<span class="nv">tag</span>要做的事
<span class="nv">mkdir</span> <span class="o">-</span><span class="nv">pv</span> <span class="o">/</span><span class="nv">srv</span><span class="o">/</span><span class="nv">reactor</span><span class="o">/</span>  <span class="o">&amp;&amp;</span>  <span class="nv">vim</span> <span class="o">/</span><span class="nv">srv</span><span class="o">/</span><span class="nv">reactor</span><span class="o">/</span><span class="nv">my_custom_module</span>.<span class="nv">sls</span>
{<span class="o">%</span> <span class="k">if</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">fun_args</span><span class="s2">&quot;</span>][<span class="mi">0</span>] <span class="o">==</span> <span class="s2">&quot;</span><span class="s">apache_install</span><span class="s2">&quot;</span> <span class="nv">and</span> <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">success</span><span class="s2">&quot;</span>] <span class="o">==</span> <span class="nv">true</span> <span class="o">%</span>}  进行一些具体的判断
<span class="nv">touch_new_file</span>:
  <span class="nv">local</span>.<span class="nv">state</span>.<span class="nv">sls</span>:   （老版本这里是<span class="nv">cmd</span>.<span class="nv">state</span>.<span class="nv">sls</span>）
    <span class="o">-</span> <span class="nv">tgt</span>: <span class="s1">&#39;</span><span class="s">zabbix_server</span><span class="s1">&#39;</span>   执行的目标
    <span class="o">-</span> <span class="nv">arg</span>:
      <span class="o">-</span> <span class="nv">newfile</span>       执行<span class="o">/</span><span class="nv">srv</span><span class="o">/</span><span class="nv">salt</span><span class="o">/</span><span class="nv">newfile</span>.<span class="nv">sls</span>文件
    <span class="o">-</span> <span class="nv">kwarg</span>:          临时定义<span class="nv">pillar</span>
        <span class="nv">pillar</span>:          注意这里是四个空格
          <span class="nv">filename</span>: {{ <span class="nv">data</span>[<span class="s2">&quot;</span><span class="s">fun_args</span><span class="s2">&quot;</span>][<span class="mi">0</span>] }}
{<span class="o">%</span> <span class="k">endif</span> <span class="o">%</span>} ##这个{{<span class="nv">data</span>是模板里面的变量}}
相当于 <span class="nv">salt</span> <span class="s1">&#39;</span><span class="s"> zabbix_server </span><span class="s1">&#39;</span> <span class="nv">state</span>.<span class="nv">sls</span> <span class="nv">newfile</span> <span class="nv">pillar</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">{&quot;filename&quot;: &quot; apache_install &quot;}</span><span class="s1">&#39;</span>

<span class="nv">cat</span> <span class="o">/</span><span class="nv">srv</span><span class="o">/</span><span class="nv">salt</span><span class="o">/</span><span class="nv">newfile</span>.<span class="nv">sls</span>
<span class="o">/</span><span class="nv">tmp</span><span class="o">/</span>{{<span class="nv">pillar</span>[<span class="s1">&#39;</span><span class="s">filename</span><span class="s1">&#39;</span>]}}:
  <span class="nv">file</span>.<span class="nv">managed</span>:
<span class="o">-</span> <span class="nv">source</span>: <span class="nv">salt</span>:<span class="o">//</span><span class="nv">passwd</span>

到此，执行<span class="nv">salt</span> <span class="s1">&#39;</span><span class="s">zabbix_server</span><span class="s1">&#39;</span> <span class="nv">state</span>.<span class="nv">sls</span> <span class="nv">apache_install</span>后<span class="ss">(</span>成功<span class="ss">)</span>，就会联动执行<span class="nv">newfile</span>.<span class="nv">sls</span>
</pre></div>


<h2 id="_1">帮助文档</h2>
<div class="codehilite"><pre><span></span>包含所有模块，<span class="nv">state</span>等，记不起来可以在这找
<span class="nv">salt</span> <span class="s1">&#39;</span><span class="s">centos2</span><span class="s1">&#39;</span> <span class="nv">sys</span>.<span class="nv">list_functions</span>
<span class="nv">salt</span> <span class="s1">&#39;</span><span class="s">centos2</span><span class="s1">&#39;</span> <span class="nv">sys</span>.<span class="nv">list_functions</span> <span class="nv">sys</span>
    <span class="o">-</span> <span class="nv">sys</span>.<span class="nv">argspec</span>
    <span class="o">-</span> <span class="nv">sys</span>.<span class="nv">doc</span>          文档， <span class="nv">salt</span> <span class="s1">&#39;</span><span class="s">*</span><span class="s1">&#39;</span> <span class="nv">sys</span>.<span class="nv">doc</span> <span class="nv">cmd</span>  为<span class="nv">cmd</span>的文档，其他类似
    <span class="o">-</span> <span class="nv">sys</span>.<span class="nv">list_functions</span>   <span class="nv">module</span>的所有<span class="nv">function</span>的命令， <span class="nv">salt</span>  <span class="s1">&#39;</span><span class="s">Minion</span><span class="s1">&#39;</span> <span class="nv">sys</span>.<span class="nv">list_functions</span> <span class="nv">cmd</span>
    <span class="o">-</span> <span class="nv">sys</span>.<span class="nv">list_modules</span>   <span class="nv">Minion</span>支持的所有<span class="nv">module</span>列表，<span class="nv">salt</span> <span class="s1">&#39;</span><span class="s">Minion</span><span class="s1">&#39;</span> <span class="nv">sys</span>.<span class="nv">list_modules</span>
    <span class="o">-</span> <span class="nv">sys</span>.<span class="nv">list_renderers</span>  查看所有<span class="k">Return</span>列表
    <span class="o">-</span> <span class="nv">sys</span>.<span class="nv">list_returner_functions</span>
    <span class="o">-</span> <span class="nv">sys</span>.<span class="nv">list_returners</span>
    <span class="o">-</span> <span class="nv">sys</span>.<span class="nv">list_runner_functions</span>
    <span class="o">-</span> <span class="nv">sys</span>.<span class="nv">list_runners</span>
    <span class="o">-</span> <span class="nv">sys</span>.<span class="nv">list_state_functions</span>  指定<span class="nv">states</span>的所有<span class="nv">function</span>，<span class="nv">salt</span>  <span class="s1">&#39;</span><span class="s">Minion</span><span class="s1">&#39;</span> <span class="nv">sys</span>.<span class="nv">list_state_functions</span> <span class="nv">file</span>
    <span class="o">-</span> <span class="nv">sys</span>.<span class="nv">list_state_modules</span>   <span class="nv">Minion</span>支持的所有<span class="nv">states</span>列表
    <span class="o">-</span> <span class="nv">sys</span>.<span class="nv">state_doc</span>                 <span class="nv">state</span>的详细用法与例子
    <span class="o">-</span> <span class="nv">sys</span>.<span class="nv">reload_modules</span>
    <span class="o">-</span> <span class="nv">sys</span>.<span class="nv">renderer_doc</span>
    <span class="o">-</span> <span class="nv">sys</span>.<span class="nv">returner_argspec</span>
    <span class="o">-</span> <span class="nv">sys</span>.<span class="nv">returner_doc</span>
    <span class="o">-</span> <span class="nv">sys</span>.<span class="nv">runner_argspec</span>
    <span class="o">-</span> <span class="nv">sys</span>.<span class="nv">runner_doc</span>
    <span class="o">-</span> <span class="nv">sys</span>.<span class="nv">state_argspec</span>
</pre></div>


<h2 id="grains">grains</h2>
<div class="codehilite"><pre><span></span><span class="n">grains</span><span class="err">是</span><span class="n">master</span><span class="err">从</span><span class="n">minion</span><span class="err">上拿数据</span>
<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">grains</span><span class="o">.</span><span class="n">ls</span>
<span class="n">salt</span> <span class="s1">&#39;node1&#39;</span> <span class="n">grains</span><span class="o">.</span><span class="n">items</span>
<span class="n">salt</span> <span class="s1">&#39;node1&#39;</span> <span class="n">grains</span><span class="o">.</span><span class="n">item</span> <span class="n">os</span>
<span class="n">salt</span> <span class="o">-</span><span class="n">G</span> <span class="s1">&#39;os:CentOS&#39;</span> <span class="n">test</span><span class="o">.</span><span class="n">ping</span>

<span class="mi">1</span><span class="err">、用</span><span class="n">grains</span><span class="err">命令添加</span>
<span class="n">salt</span> <span class="s1">&#39;Minion&#39;</span> <span class="n">grains</span><span class="o">.</span><span class="n">append</span>  <span class="n">saltbook</span>  <span class="s1">&#39;verycool&#39;</span> 
<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">grains</span><span class="o">.</span><span class="n">setval</span> <span class="n">key</span> <span class="s2">&quot;{&#39;sub-key&#39;: &#39;val&#39;, &#39;sub-key2&#39;: &#39;val2&#39;}&quot;</span>  <span class="err">设置多个</span>
<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">grains</span><span class="o">.</span><span class="n">remove</span> <span class="n">key</span> <span class="n">val</span>  <span class="err">删除</span>

<span class="mi">2</span><span class="err">、在</span><span class="n">minion</span><span class="err">端定义</span><span class="n">grains</span>
<span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">salt</span><span class="o">/</span><span class="n">minion</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">hostinfo</span><span class="o">.</span><span class="n">conf</span>       <span class="c1">#自定义grains,相当于打上一个标签，在根据标签进行操作</span>
<span class="n">grains</span><span class="p">:</span>
  <span class="n">roles</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">webserver</span>
    <span class="o">-</span> <span class="n">memcache</span>
  <span class="n">deployment</span><span class="p">:</span> <span class="n">datacenter4</span>
  <span class="n">cabinet</span><span class="p">:</span> <span class="mi">13</span>
 <span class="err">重启</span><span class="n">minion</span>   <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">salt</span><span class="o">-</span><span class="n">minion</span> <span class="n">restart</span>

<span class="mi">3</span><span class="err">、在</span><span class="n">master</span><span class="err">端自己编写</span><span class="n">grains</span><span class="err">，然后推送给</span><span class="n">minion</span>
<span class="n">mkdir</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">salt</span><span class="o">/</span><span class="n">_grains</span>
<span class="n">vim</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">salt</span><span class="o">/</span><span class="n">_grains</span><span class="o">/</span><span class="n">system</span><span class="o">.</span><span class="n">py</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="k">def</span> <span class="nf">get_system</span><span class="p">():</span>
    <span class="n">grains</span> <span class="o">=</span> <span class="p">{}</span>                 <span class="c1"># 初始化一个grains字典</span>
    <span class="n">grains</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">platform</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">grains</span>              <span class="c1">#返回结果</span>

<span class="n">salt</span> <span class="s2">&quot;zabbix_agent&quot;</span> <span class="n">saltutil</span><span class="o">.</span><span class="n">sync_grains</span>        <span class="c1">#推送给minion（被控端的/var/cache/salt/minion/extmods/grains/目录下）</span>
<span class="n">salt</span> <span class="s2">&quot;zabbix_agent&quot;</span> <span class="n">grains</span><span class="o">.</span><span class="n">item</span> <span class="n">system</span>        <span class="c1">#查看这个grains</span>

<span class="err">使用</span>
<span class="n">grains</span><span class="err">是静态的</span>
<span class="mi">1</span><span class="err">、通过目标使用</span><span class="n">grains</span>
<span class="n">salt</span> <span class="o">-</span><span class="n">G</span> <span class="s1">&#39;os:CentOS&#39;</span> <span class="n">test</span><span class="o">.</span><span class="n">ping</span>
<span class="mi">2</span><span class="err">、通过</span><span class="n">top</span><span class="o">.</span><span class="n">sls</span><span class="err">来使用</span>
<span class="n">vim</span> <span class="n">top</span><span class="o">.</span><span class="n">sls</span>
<span class="n">base</span><span class="p">:</span>
<span class="s1">&#39;location:shanghai&#39;</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">match</span><span class="p">:</span> <span class="n">grain</span>
    <span class="o">-</span> <span class="n">webserver</span> <span class="p">(</span><span class="err">具体的</span><span class="n">sls</span><span class="err">文件名</span><span class="p">)</span>
<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">state</span><span class="o">.</span><span class="n">highstate</span><span class="err">来调用，只有</span><span class="n">location</span><span class="p">:</span><span class="n">shanghai</span><span class="err">的主机才执行</span><span class="n">user</span><span class="o">.</span><span class="n">sls</span>
<span class="mi">3</span><span class="err">、通过在定义的</span><span class="n">state</span><span class="err">，</span><span class="n">sls</span><span class="err">文件使用</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">the_node_type</span> <span class="o">=</span> <span class="n">salt</span><span class="p">[</span><span class="s1">&#39;grains.get&#39;</span><span class="p">](</span><span class="s1">&#39;grains的key&#39;</span><span class="p">,</span> <span class="s1">&#39;默认值&#39;</span><span class="p">)</span>  <span class="o">%</span><span class="p">}</span>    <span class="ow">or</span>  <span class="n">grains</span><span class="p">[</span><span class="s1">&#39;os&#39;</span><span class="p">]</span>
<span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">the_node_type</span> <span class="o">%</span><span class="p">}</span>
  <span class="s1">&#39;node_type:{{ the_node_type }}&#39;</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">match</span><span class="p">:</span> <span class="n">grain</span>
    <span class="o">-</span> <span class="p">{{</span> <span class="n">the_node_type</span> <span class="p">}}</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
<span class="mi">4</span><span class="err">、通过编写模块来调用</span><span class="n">grains</span><span class="err">，</span><span class="n">__grains__</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span>
<span class="n">vim</span> <span class="n">g1</span><span class="o">.</span><span class="n">py</span>
<span class="k">def</span> <span class="nf">t1</span><span class="p">():</span>
<span class="k">return</span> <span class="n">__grains__</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span>
<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">saltutil</span><span class="o">.</span><span class="n">sync_modules</span> <span class="err">推送</span>
<span class="n">salt</span> <span class="err">‘</span><span class="o">*</span><span class="err">’</span> <span class="n">g1</span><span class="o">.</span><span class="n">t1</span>    <span class="err">调用</span>
</pre></div>


<h2 id="modules">modules</h2>
<div class="codehilite"><pre><span></span><span class="err">常用模块</span>  <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">docs</span><span class="o">.</span><span class="n">saltstack</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">ref</span><span class="o">/</span><span class="n">modules</span><span class="o">/</span><span class="nb">all</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">html</span><span class="c1">#all-salt-modules</span>

<span class="kn">import</span> <span class="nn">salt.client</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">salt</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">LocalClient</span><span class="p">()</span>
<span class="n">ret</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;test.ping&#39;</span><span class="p">)</span>
<span class="k">print</span> <span class="n">ret</span>
<span class="n">Archive</span><span class="err">压缩包</span>

<span class="n">salt</span> <span class="s1">&#39;centos1&#39;</span> <span class="n">archive</span><span class="o">.</span><span class="n">gunzip</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">sourcefile</span><span class="o">.</span><span class="n">txt</span><span class="o">.</span><span class="n">gz</span>   <span class="c1">#采用gzunzip解压/tmp/sourcefile.txt.gz包</span>
<span class="n">salt</span> <span class="s1">&#39;centos1&#39;</span> <span class="n">archive</span><span class="o">.</span><span class="n">gzip</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">sourcefile</span><span class="o">.</span><span class="n">txt</span>     <span class="c1">#采用gzip压缩/tmp/sourcefile.txt文件</span>
<span class="o">---</span>   <span class="n">API</span><span class="err">调用：</span><span class="n">client</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="s1">&#39;centos1&#39;</span><span class="p">,</span> <span class="s1">&#39; archive.gunzip&#39;</span> <span class="err">，</span> <span class="p">[</span><span class="s1">&#39;/tmp/sourcefile.txt.gz &#39;</span><span class="p">])</span>
<span class="n">cmd</span><span class="err">命令</span>

<span class="n">salt</span> <span class="s1">&#39;centos1&#39;</span> <span class="n">cmd</span><span class="o">.</span><span class="n">run</span> <span class="s2">&quot;free -m&quot;</span>   <span class="c1">#获取所有被控主机的内存使用情况</span>
<span class="n">salt</span> <span class="s1">&#39;centos1&#39;</span> <span class="n">cmd</span><span class="o">.</span><span class="n">script</span> <span class="n">salt</span><span class="p">:</span><span class="o">//</span><span class="n">script</span><span class="o">/</span><span class="n">test</span><span class="o">.</span><span class="n">sh</span>   <span class="c1">#在centos1主机运行test.sh脚本，其中script/test.sh存放在</span>
<span class="n">file_roots</span><span class="err">指定的目录，首先同步</span><span class="n">test</span><span class="o">.</span><span class="n">sh</span><span class="err">到</span><span class="n">minion</span><span class="err">的</span><span class="n">cache</span><span class="err">目录（如同步到</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">salt</span><span class="o">/</span><span class="n">minion</span><span class="o">/</span><span class="n">files</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="n">script</span><span class="o">/</span><span class="n">test</span><span class="o">.</span><span class="n">sh</span><span class="err">）；</span>
<span class="err">其次运行该脚本</span>
<span class="o">---</span>  <span class="n">API</span><span class="err">调用：</span><span class="n">client</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="s1">&#39;SN2013-08-021&#39;</span><span class="p">,</span> <span class="s1">&#39;cmd.run&#39;</span><span class="p">,[</span><span class="s1">&#39;free -m&#39;</span><span class="p">])</span>
<span class="n">cp</span><span class="err">文件目录管理</span>

<span class="n">salt</span> <span class="s1">&#39;centos1&#39;</span> <span class="n">cp</span><span class="o">.</span><span class="n">cache_local_file</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span>  <span class="c1">#将指定被控主机的/etc/hosts文件复制到被控主机本地的salt cache目录</span>
<span class="err">（</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">salt</span><span class="o">/</span><span class="n">minion</span><span class="o">/</span><span class="n">localfiles</span><span class="o">/</span><span class="err">）</span>
<span class="n">salt</span> <span class="s1">&#39;centos1&#39;</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_dir</span> <span class="n">salt</span><span class="p">:</span><span class="o">//</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="nb">dir</span><span class="o">/</span> <span class="o">/</span><span class="n">minion</span><span class="o">/</span><span class="n">dest</span>   <span class="c1">#将主服务器file_roots指定位置下的目录复制到被控主机</span>
<span class="n">salt</span> <span class="s1">&#39;centos1&#39;</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_file</span> <span class="n">salt</span><span class="p">:</span><span class="o">//</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="nb">file</span> <span class="o">/</span><span class="n">minion</span><span class="o">/</span><span class="n">dest</span>  <span class="c1">#将主服务器file_roots指定位置下的文件复制到被控主机</span>
<span class="n">salt</span> <span class="s1">&#39;centos1&#39;</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_url</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">slashdot</span><span class="o">.</span><span class="n">org</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">html</span>  <span class="c1">#下载URL内容到被控主机指定位置</span>
<span class="o">-----</span>  <span class="n">API</span><span class="err">调用：</span><span class="n">client</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="s1">&#39;centos1&#39;</span><span class="p">,</span> <span class="s1">&#39;cp.get_file&#39;</span><span class="p">,[</span><span class="s1">&#39; salt://path/to/file &#39;</span><span class="p">,</span><span class="s1">&#39; /minion/dest&#39;</span><span class="p">])</span>
<span class="n">crontab</span><span class="err">定时任务</span>

<span class="n">salt</span> <span class="s1">&#39;centos1&#39;</span> <span class="n">cron</span><span class="o">.</span><span class="n">raw_cron</span> <span class="n">root</span>    <span class="ow">or</span>  <span class="n">salt</span> <span class="s1">&#39;centos1&#39;</span> <span class="n">cron</span><span class="o">.</span><span class="n">list_tab</span> <span class="n">root</span>  <span class="c1">#查看指定被控主机、root用户的crontab清单</span>
<span class="n">salt</span> <span class="s1">&#39;centos1&#39;</span> <span class="n">cron</span><span class="o">.</span><span class="n">set_job</span> <span class="n">root</span> <span class="s1">&#39;*&#39;</span> <span class="s1">&#39;*&#39;</span> <span class="s1">&#39;*&#39;</span> <span class="s1">&#39;*&#39;</span> <span class="mi">1</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">weekly</span>   <span class="c1">#为指定的被控主机、root用户添加/usr/local/weekly任务</span>
<span class="n">salt</span> <span class="s1">&#39;centos1&#39;</span> <span class="n">cron</span><span class="o">.</span><span class="n">rm_job</span> <span class="n">root</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">weekly</span>  <span class="c1">#删除指定的被控主机、root用户crontab的/usr/local/weekly任务</span>
<span class="o">-----</span>  <span class="n">API</span><span class="err">调用：</span><span class="n">client</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="s1">&#39;centos1&#39;</span><span class="p">,</span> <span class="s1">&#39;cron.set_job&#39;</span><span class="p">,[</span><span class="s1">&#39;root&#39;</span><span class="p">,</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="s1">&#39;/usr/echo&#39;</span><span class="p">])</span>
<span class="n">dnsutil</span> <span class="n">DNS</span><span class="err">相关</span>

<span class="n">salt</span> <span class="s1">&#39;centos1&#39;</span> <span class="n">dnsutil</span><span class="o">.</span><span class="n">hosts_append</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">8.12</span> <span class="n">salt</span><span class="o">-</span><span class="n">master</span> <span class="c1">#添加指定被控主机hosts的主机配置项</span>
<span class="n">salt</span> <span class="s1">&#39;centos1&#39;</span> <span class="n">dnsutil</span><span class="o">.</span><span class="n">hosts_remove</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span> <span class="n">salt</span><span class="o">-</span><span class="n">master</span>  <span class="c1">#删除指定被控主机hosts的主机配置项</span>
<span class="o">-----</span>  <span class="n">API</span><span class="err">调用：</span><span class="n">client</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;dnsutil.hosts_append&#39;</span><span class="p">,[</span><span class="s1">&#39;/etc/hosts&#39;</span><span class="p">,</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span><span class="s1">&#39;ad1.yuk.co&#39;</span><span class="p">])</span>
<span class="nb">file</span><span class="err">文件</span>

<span class="n">salt</span> <span class="s1">&#39;centos2&#39;</span> <span class="nb">file</span><span class="o">.</span><span class="n">check_hash</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fstab</span> <span class="n">md5</span><span class="p">:</span><span class="n">e4b13a1b984950ade18cbc8bc33be658</span>  <span class="c1">#校验被控主机/etc/fstab文件的md5</span>
<span class="err">一致则返回</span><span class="bp">True</span>
<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="nb">file</span><span class="o">.</span><span class="n">get_sum</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">passwd</span> <span class="n">md5</span>   <span class="c1">#校验所有被控主机文件的加密信息、支持md5、sha1、sha224、sha256、sha384、sha512</span>
<span class="err">加密算法</span>
<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="nb">file</span><span class="o">.</span><span class="n">chown</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">passwd</span> <span class="n">root</span> <span class="n">root</span>  <span class="c1">#修改所有被控主机/etc/passwd文件的属组、用户权限，</span>
<span class="err">等价于</span><span class="n">chown</span> <span class="n">root</span><span class="p">:</span><span class="n">root</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">passwd</span>
<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="nb">file</span><span class="o">.</span><span class="n">copy</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">src</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">dst</span>   <span class="c1">#复制所有被控主机本地/path/to/src文件到本地的/path/to/dst文件</span>
<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="nb">file</span><span class="o">.</span><span class="n">directory_exists</span> <span class="o">/</span><span class="n">etc</span>   <span class="c1">#检查所有被控主机/etc目录是否存在，存在则返回True，检查文件是否存在使用</span>
<span class="nb">file</span><span class="o">.</span><span class="n">file_exists</span><span class="err">方法</span>
<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="nb">file</span><span class="o">.</span><span class="n">stats</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">passwd</span>    <span class="c1">#获取所有被控主机/etc/passwd的stats信息</span>
<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="nb">file</span><span class="o">.</span><span class="n">get_mode</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">passwd</span>  <span class="c1">#获取所有被控主机/etc/passwd的权限mode，如755、644</span>
<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="nb">file</span><span class="o">.</span><span class="n">set_mode</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">passwd</span> <span class="mo">0644</span>   <span class="c1">#修改所有被控主机/etc/passwd的权限mode为0644</span>
<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="nb">file</span><span class="o">.</span><span class="n">mkdir</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">test</span>   <span class="c1">#在所有被控主机创建/opt/test目录</span>
<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="nb">file</span><span class="o">.</span><span class="n">sed</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">httpd</span><span class="o">.</span><span class="n">conf</span> <span class="s1">&#39;LogLevel warn&#39;</span> <span class="s1">&#39;LogLevel info&#39;</span>  <span class="c1">#将所有被控主机/etc/httpd/httpd.conf</span>
<span class="err">文件的</span><span class="n">LogLevel</span><span class="err">参数的</span><span class="n">warn</span><span class="err">值修改成</span><span class="n">info</span>
<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="nb">file</span><span class="o">.</span><span class="n">append</span>  <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">test</span><span class="o">.</span><span class="n">conf</span> <span class="s2">&quot;maxclient 100&quot;</span>  <span class="c1">#给所有被控主机的/tmp/test/test.conf文件追加内容&quot;maxclient 100&quot;</span>
<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="nb">file</span><span class="o">.</span><span class="n">remove</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">foo3</span>   <span class="c1">#删除所有被控主机的/tmp/foo文件</span>
<span class="o">------</span>  <span class="n">API</span><span class="err">调用：</span><span class="n">client</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39; file.remove &#39;</span><span class="p">,[</span><span class="s1">&#39;/tmp/foo&#39;</span><span class="p">])</span>
<span class="n">iptables</span><span class="err">防火墙</span>

<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">iptables</span><span class="o">.</span><span class="n">append</span> <span class="nb">filter</span> <span class="n">INPUT</span> <span class="n">rule</span><span class="o">=</span><span class="s1">&#39;-m state --state RELATED,ESTABLISHED -j ACCEPT&#39;</span>
<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">iptables</span><span class="o">.</span><span class="n">insert</span> <span class="nb">filter</span> <span class="n">INPUT</span> <span class="n">position</span><span class="o">=</span><span class="mi">3</span> <span class="n">rule</span><span class="o">=</span><span class="s1">&#39;-m state --state RELATED,ESTABLISHED -j ACCEPT&#39;</span>
<span class="c1">#在所有被控端主机追加(append)、插入(insert)iptables规则,其中INPUT为输入链</span>
<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">iptables</span><span class="o">.</span><span class="n">delete</span> <span class="nb">filter</span> <span class="n">INPUT</span> <span class="n">position</span><span class="o">=</span><span class="mi">3</span>
<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">iptables</span><span class="o">.</span><span class="n">delete</span> <span class="nb">filter</span> <span class="n">INPUT</span> <span class="n">rule</span><span class="o">=</span><span class="s1">&#39;-m state --state RELATED,ESTABLISHED-j ACCEPT&#39;</span>
<span class="c1">#在所有被控端主机删除指定链编号为3（position=3）或指定存在的规则</span>
<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">iptables</span><span class="o">.</span><span class="n">save</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysconfig</span><span class="o">/</span><span class="n">iptables</span>   <span class="c1">#保存所有被控端主机规则到本地硬盘(/etc/sysconfig/iptables)</span>
<span class="o">----</span>  <span class="n">API</span><span class="err">调用：</span> <span class="n">client</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="s1">&#39;SN2013-08-022&#39;</span><span class="p">,</span> <span class="s1">&#39;iptables.append&#39;</span><span class="p">,[</span><span class="s1">&#39;filter&#39;</span><span class="p">,</span><span class="s1">&#39;INPUT&#39;</span><span class="p">,</span><span class="s1">&#39;rule=</span><span class="se">\&#39;</span><span class="s1">-p tcp --sport 80 -j ACCEPT</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">])</span>
<span class="n">netwrok</span><span class="err">网络信息</span>

<span class="n">salt</span> <span class="s1">&#39;centos2&#39;</span> <span class="n">network</span><span class="o">.</span><span class="n">dig</span> <span class="n">www</span><span class="o">.</span><span class="n">qq</span><span class="o">.</span><span class="n">com</span>
<span class="n">salt</span> <span class="s1">&#39;centos2&#39;</span> <span class="n">network</span><span class="o">.</span><span class="n">ping</span> <span class="n">www</span><span class="o">.</span><span class="n">qq</span><span class="o">.</span><span class="n">com</span>
<span class="n">salt</span> <span class="s1">&#39;centos2&#39;</span> <span class="n">network</span><span class="o">.</span><span class="n">traceroute</span> <span class="n">www</span><span class="o">.</span><span class="n">qq</span><span class="o">.</span><span class="n">com</span>
<span class="c1">#在指定被控主机&#39;centos2&#39;获取dig、ping、traceroute目录域名信息</span>
<span class="n">salt</span> <span class="s1">&#39;centos2&#39;</span> <span class="n">network</span><span class="o">.</span><span class="n">hwaddr</span> <span class="n">eth0</span>  <span class="c1">#获取指定被控主机的MAC地址</span>
<span class="n">salt</span> <span class="s1">&#39;centos2&#39;</span> <span class="n">network</span><span class="o">.</span><span class="n">in_subnet</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.0</span><span class="o">/</span><span class="mi">16</span> <span class="c1">#检测指定被控主机是否属于10.0.0.0/16子网范围，属于则返回True</span>
<span class="n">salt</span> <span class="s1">&#39;centos2&#39;</span> <span class="n">network</span><span class="o">.</span><span class="n">interfaces</span> <span class="c1">#获取指定被控主机的网卡配置信息</span>
<span class="n">salt</span> <span class="s1">&#39;centos2&#39;</span> <span class="n">network</span><span class="o">.</span><span class="n">ip_addrs</span>  <span class="c1">#获取指定被控主机的IP地址配置信息</span>
<span class="n">salt</span> <span class="s1">&#39;centos2&#39;</span> <span class="n">network</span><span class="o">.</span><span class="n">subnets</span>  <span class="c1">#获取指定被控主机的子网信息</span>
<span class="o">----</span>  <span class="n">API</span><span class="err">调用：</span><span class="n">client</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="s1">&#39;SN2013-08-022&#39;</span><span class="p">,</span> <span class="s1">&#39;network.ip_addrs&#39;</span><span class="p">)</span>
<span class="n">pkg</span><span class="err">包管理</span>

<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">pkg</span><span class="o">.</span><span class="n">install</span> <span class="n">php</span>  <span class="c1">#为所有被控主机安装PHP环境，根据不同系统发行版调用不同安装工具进行部署，如redhat平台的yum，</span>
<span class="err">等价于</span><span class="n">yum</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">php</span>
<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">pkg</span><span class="o">.</span><span class="n">remove</span> <span class="n">php</span>  <span class="c1">#卸载所有被控主机的PHP环境</span>
<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">pkg</span><span class="o">.</span><span class="n">upgrade</span>   <span class="c1">#升级所有被控主机的软件包</span>
<span class="o">----</span>   <span class="n">API</span><span class="err">调用：</span><span class="n">client</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="s1">&#39;SN2013-08-022&#39;</span><span class="p">,</span> <span class="s1">&#39;pkg.remove&#39;</span><span class="p">,[</span><span class="s1">&#39;php&#39;</span><span class="p">])</span>
<span class="n">Service</span><span class="err">服务</span>

<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">service</span><span class="o">.</span><span class="n">enable</span> <span class="n">nginx</span>
<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">service</span><span class="o">.</span><span class="n">disable</span> <span class="n">nginx</span> 
<span class="c1">#开启（enable）、禁用（disable）nginx开机自启动服务</span>
<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">service</span><span class="o">.</span><span class="n">reload</span> <span class="n">nginx</span>
<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">service</span><span class="o">.</span><span class="n">restart</span> <span class="n">nginx</span>
<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">service</span><span class="o">.</span><span class="n">start</span> <span class="n">nginx</span>
<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">service</span><span class="o">.</span><span class="n">stop</span> <span class="n">nginx</span>
<span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">service</span><span class="o">.</span><span class="n">status</span> <span class="n">nginx</span>
<span class="c1">#针对nginx服务的reload、restart、start、stop、status操作</span>
<span class="o">-----</span>  <span class="n">API</span><span class="err">调用：</span> <span class="n">client</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="s1">&#39;SN2013-08-022&#39;</span><span class="p">,</span> <span class="s1">&#39;service.stop&#39;</span><span class="p">,[</span><span class="s1">&#39;nginx&#39;</span><span class="p">])</span>
<span class="n">other</span>

<span class="n">Saltstack</span><span class="err">还提供了</span><span class="n">user</span><span class="err">（系统用户模块）、</span><span class="n">group</span><span class="err">（系统组模块）、</span><span class="n">partition</span><span class="err">（系统分区模块）、</span><span class="n">puppet</span><span class="err">（</span><span class="n">puppet</span><span class="err">管理模块）、</span>
<span class="n">system</span><span class="err">（系统重启、关机模块）、</span><span class="n">timezone</span><span class="err">（时区管理模块）、</span><span class="n">nginx</span><span class="err">（</span><span class="n">Nginx</span><span class="err">管理模块）、</span><span class="n">mount</span><span class="err">（文件系统挂载模块），等等</span>

<span class="err">自定义模块</span>

<span class="err">分发机制</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="o">.</span><span class="mi">6</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">salt</span><span class="o">/</span><span class="n">modules</span>
<span class="err">在</span><span class="n">minion</span><span class="err">执行，可以在</span><span class="n">master</span><span class="err">写分发到</span><span class="n">minion</span>
<span class="err">根目录</span> <span class="n">fileroot</span><span class="p">:</span>  <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">salt</span><span class="o">/</span><span class="n">master</span>
<span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">salt</span>
<span class="mi">1</span><span class="err">、</span>    <span class="n">module</span><span class="err">是在</span><span class="n">minion</span><span class="err">执行</span>
<span class="mi">2</span><span class="err">、</span>    <span class="n">master</span><span class="err">创建</span><span class="mi">2</span><span class="err">次开发出来的</span><span class="n">modules</span><span class="p">,</span><span class="err">发布到所有的</span><span class="n">minion</span>
<span class="mi">3</span><span class="err">、</span><span class="n">mkdir</span> <span class="err">–</span><span class="n">pv</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">salt</span><span class="o">/</span><span class="n">_modules</span> <span class="o">&amp;&amp;</span> <span class="n">cd</span> <span class="o">/</span><span class="n">srv</span><span class="o">/</span><span class="n">salt</span><span class="o">/</span><span class="n">_modules</span>
<span class="mi">4</span><span class="err">、创建</span><span class="n">module</span><span class="err">文件并且定义函数</span>
<span class="n">cat</span> <span class="nb">file</span><span class="o">.</span><span class="n">py</span>             <span class="err">模块名</span><span class="n">File</span>
<span class="k">def</span> <span class="nf">t1</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>            <span class="err">函数名</span>
<span class="err">‘’‘</span><span class="n">salt</span> \<span class="o">*</span> <span class="nb">file</span><span class="o">.</span><span class="n">t1</span> <span class="err">’‘’</span>     <span class="err">描述</span>
<span class="k">return</span> <span class="n">num</span><span class="o">*</span><span class="n">num</span>    <span class="err">信息在函数的</span><span class="k">return</span><span class="err">里</span>
<span class="mi">5</span><span class="err">、推送给所有的</span><span class="n">minion</span>  <span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">saltutil</span><span class="o">.</span><span class="n">sync_modules</span>
<span class="err">会推送给</span><span class="n">minion</span><span class="err">的路径：</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">salt</span><span class="o">/</span><span class="n">minion</span><span class="o">/</span><span class="n">extmods</span><span class="o">/</span><span class="n">modules</span>
<span class="err">推送所有</span> <span class="p">:</span> <span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">saltutil</span><span class="o">.</span><span class="n">sync_all</span>  <span class="err">包括以下所有的</span>
</pre></div>


<h2 id="zmq">zmq</h2>
<div class="codehilite"><pre><span></span><span class="nv">saltstack</span>
<span class="nv">master</span> 启动


<span class="nv">REQSERVER</span>
<span class="mi">1</span> 接收来自于<span class="nv">client</span>的请求，然后派发给空闲的<span class="nv">Mworker</span>
<span class="mi">2</span> 接收来自于<span class="nv">minion</span>的返回信息
<span class="mi">4506</span> <span class="nv">bind</span> <span class="nv">ROUTER</span>
<span class="nv">workers</span>.<span class="nv">ipc</span>  <span class="nv">bind</span>  <span class="nv">DEALER</span>


<span class="nv">Publisher</span>
发布来自于<span class="nv">client</span>的请求给所有的<span class="nv">minion</span>
<span class="mi">4505</span> <span class="nv">bind</span>  <span class="nv">PUB</span>
<span class="nv">publish_pull</span>.<span class="nv">ipc</span> <span class="nv">bind</span> <span class="nv">PULL</span>


<span class="nv">EVENTPUBLISHER</span>
主要是通知<span class="nv">client</span>，任务执行的状态，结果！
<span class="nv">master_event_pull</span>.<span class="nv">ipc</span> <span class="nv">bind</span> <span class="nv">pull</span>
<span class="nv">master_event_pub</span>.<span class="nv">ipc</span> <span class="nv">bind</span> <span class="nv">PUB</span>



<span class="nv">MWORKER</span>
多进程，实际处理工作
<span class="nv">wokers</span>.<span class="nv">ipc</span> <span class="k">connect</span>  <span class="nv">REP</span> 


<span class="nv">minion</span>
<span class="mi">4505</span> <span class="k">connect</span> <span class="nv">SUB</span> <span class="ss">(</span>接收执行任务，数据以字典格式发送<span class="ss">)</span>
<span class="mi">4605</span> <span class="k">connect</span> <span class="nv">REQ</span> <span class="ss">(</span>返回执行结果<span class="ss">)</span>


执行具体任务的时候
<span class="nv">job</span> <span class="nv">flow</span>
<span class="mi">1</span> <span class="nv">salt</span> <span class="s1">&#39;</span><span class="s">*</span><span class="s1">&#39;</span> <span class="nv">test</span>.<span class="nv">ping</span>
创建了一个<span class="nv">client</span>对象
<span class="mi">2</span> <span class="nv">client</span> <span class="mi">4506</span> <span class="nv">REQ</span> <span class="k">connect</span>
发送执行项目
<span class="mi">3</span> <span class="nv">REQSERVER</span>把请求交给可用的<span class="nv">MWOKER</span>，通过<span class="nv">wokers</span>.<span class="nv">ipc</span>

<span class="mi">4</span> 首先，确定你有权利这么做。然后通过<span class="nv">publish</span> 把<span class="nv">client</span>交予的命令发送给所有的<span class="nv">minion</span>。<span class="nv">ClearFuncs</span>.<span class="nv">publish</span><span class="ss">()</span>
<span class="nv">MWokers</span> 产生新的配对
<span class="nv">publish_pull</span>.<span class="nv">ipc</span> <span class="k">connect</span> <span class="nv">PUSH</span>

<span class="mi">5</span> 你的<span class="nv">woker</span>宣告任务开始执行利用<span class="nv">evnetpublish</span>
<span class="nv">master_event_pull</span>.<span class="nv">ipc</span>  <span class="k">connect</span> <span class="nv">push</span>
然后<span class="nv">eventpublish</span>通过<span class="nv">pub</span>方式把消息传送给所有的<span class="nv">client</span>订阅者
（连接到<span class="nv">master_event_pub</span>.<span class="nv">ipc</span>）

<span class="mi">6</span> 消息加密以后通过<span class="nv">Publisher</span>发送给所有的<span class="nv">mininon</span>

<span class="mi">7</span> 所有的<span class="nv">minion</span>通过<span class="mi">4505</span>的订阅接收消息

<span class="mi">8</span> <span class="nv">minion</span>先解密消息，再在本地执行操作，但是事先会判断对象是不是自己

<span class="mi">9</span> <span class="nv">minion</span>把响应数据加密后发送给<span class="nv">master</span>的<span class="mi">4506</span>，<span class="nv">master</span>把数据交给可用<span class="nv">Mwoker</span>

<span class="mi">10</span> <span class="nv">Mwoker</span>接收数据后解密，然后通过<span class="nv">eventpublish</span> 发送相对应的状态通知

<span class="mi">11</span> 此时你的<span class="nv">LocalClient</span>就接收到返回信息了。或者等待超时。

<span class="mi">12</span> 当所有的<span class="nv">minion</span>都返回了结果，或者超时，则此次任务结束。
<span class="nv">salt</span><span class="o">-</span><span class="nv">zmq</span>.<span class="nv">png</span>
</pre></div>


<p><img alt="" src="../assets/zmq.png" /></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../apache/" title="apache" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                apache
              </span>
            </div>
          </a>
        
        
          <a href="../tomcat/" title="tomcat" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                tomcat
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>