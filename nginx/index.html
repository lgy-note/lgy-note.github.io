



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>nginx - mkdocs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.30686662.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#map" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="mkdocs" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              mkdocs
            </span>
            <span class="md-header-nav__topic">
              
                nginx
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href=".." class="md-tabs__link">
        home
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../python-base/" class="md-tabs__link">
          python
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="./" class="md-tabs__link md-tabs__link--active">
          service
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../mysql/" class="md-tabs__link">
          database
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../open-falcon/" class="md-tabs__link">
          monitor
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../tcp-issue/" class="md-tabs__link">
          basis
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="mkdocs" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    mkdocs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="home" class="md-nav__link">
      home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      python
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        python
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../python-base/" title="python-base" class="md-nav__link">
      python-base
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-lib/" title="python-lib" class="md-nav__link">
      python-lib
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-lib2/" title="python-lib2" class="md-nav__link">
      python-lib2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-web/" title="python-web" class="md-nav__link">
      python-web
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-other/" title="python-other" class="md-nav__link">
      python-other
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      service
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        service
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        nginx
      </label>
    
    <a href="./" title="nginx" class="md-nav__link md-nav__link--active">
      nginx
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#map" class="md-nav__link">
    map
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#session-hash" class="md-nav__link">
    session hash规则
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx-rewrite" class="md-nav__link">
    nginx rewrite
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    动静分离
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#locationrewrite" class="md-nav__link">
    location和rewrite
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx" class="md-nav__link">
    nginx忽略参数
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cdn" class="md-nav__link">
    配置cdn后做限制
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    反向代理
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#proxy_pass" class="md-nav__link">
    proxy_pass
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    用户认证
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rootalias" class="md-nav__link">
    root和alias
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx_1" class="md-nav__link">
    nginx限速
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx_2" class="md-nav__link">
    压测 nginx性能调优
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx_rtmp-hls" class="md-nav__link">
    nginx_rtmp hls
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../nginx2/" title="nginx2" class="md-nav__link">
      nginx2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../apache/" title="apache" class="md-nav__link">
      apache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../saltstack/" title="saltstack" class="md-nav__link">
      saltstack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tomcat/" title="tomcat" class="md-nav__link">
      tomcat
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ansible/" title="ansible" class="md-nav__link">
      ansible
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../trafficserver/" title="trafficserver" class="md-nav__link">
      trafficserver
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../haproxy/" title="haproxy" class="md-nav__link">
      haproxy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../docker/" title="docker" class="md-nav__link">
      docker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../varnish/" title="varnish" class="md-nav__link">
      varnish
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../bind/" title="bind" class="md-nav__link">
      bind
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lvs/" title="lvs" class="md-nav__link">
      lvs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../log-analysis/" title="log-analysis" class="md-nav__link">
      log-analysis
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      database
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        database
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../mysql/" title="mysql" class="md-nav__link">
      mysql
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mysql2/" title="mysql2" class="md-nav__link">
      mysql2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../memcached/" title="memcached" class="md-nav__link">
      memcached
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../redis/" title="redis" class="md-nav__link">
      redis
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mongodb/" title="mongodb" class="md-nav__link">
      mongodb
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../hadoop/" title="hadoop" class="md-nav__link">
      hadoop
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../postgresql/" title="postgresql" class="md-nav__link">
      postgresql
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      monitor
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        monitor
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../open-falcon/" title="open-falcon" class="md-nav__link">
      open-falcon
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zabbix/" title="zabbix" class="md-nav__link">
      zabbix
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zabbix2/" title="zabbix2" class="md-nav__link">
      zabbix2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../netdata/" title="netdata" class="md-nav__link">
      netdata
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      basis
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        basis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../tcp-issue/" title="tcp-issue" class="md-nav__link">
      tcp-issue
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../git-svn/" title="git-svn" class="md-nav__link">
      git-svn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../vpn/" title="vpn" class="md-nav__link">
      vpn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../shell/" title="shell" class="md-nav__link">
      shell
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../disk/" title="disk" class="md-nav__link">
      disk
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../filesystem/" title="filesystem" class="md-nav__link">
      filesystem
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../source/" title="source" class="md-nav__link">
      source
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../command/" title="command" class="md-nav__link">
      command
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../linux-base/" title="linux-base" class="md-nav__link">
      linux-base
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../linux-soft/" title="linux-soft" class="md-nav__link">
      linux-soft
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../other/" title="other" class="md-nav__link">
      other
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#map" class="md-nav__link">
    map
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#session-hash" class="md-nav__link">
    session hash规则
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx-rewrite" class="md-nav__link">
    nginx rewrite
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    动静分离
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#locationrewrite" class="md-nav__link">
    location和rewrite
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx" class="md-nav__link">
    nginx忽略参数
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cdn" class="md-nav__link">
    配置cdn后做限制
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    反向代理
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#proxy_pass" class="md-nav__link">
    proxy_pass
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    用户认证
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rootalias" class="md-nav__link">
    root和alias
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx_1" class="md-nav__link">
    nginx限速
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx_2" class="md-nav__link">
    压测 nginx性能调优
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx_rtmp-hls" class="md-nav__link">
    nginx_rtmp hls
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>nginx</h1>
                
                <h2 id="map">map</h2>
<div class="codehilite"><pre><span></span><span class="k">map</span> <span class="err">$</span><span class="n">uri</span> <span class="err">$</span><span class="k">match</span> <span class="err">{</span>
        <span class="o">~^/</span><span class="n">common</span><span class="o">/</span><span class="n">file</span><span class="o">/</span><span class="n">dachui</span><span class="o">/</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span> <span class="o">/</span><span class="n">dachui</span><span class="o">/</span><span class="p">;</span>
    <span class="err">}</span>

<span class="err">$</span><span class="k">match</span>  <span class="err">为</span> <span class="o">/</span><span class="n">dachui</span><span class="o">/</span>
<span class="err">$</span><span class="n">uri</span>  <span class="n">nginx</span><span class="err">内置变量</span>  

<span class="err">假如</span> <span class="err">$</span><span class="n">uri</span> <span class="err">为</span> <span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="n">file</span><span class="o">/</span><span class="n">dachui</span><span class="o">/</span><span class="mi">20170427160407</span><span class="p">.</span><span class="n">jpg</span>
<span class="err">正则匹配后</span> <span class="err">$</span><span class="mi">1</span> <span class="err">为</span> <span class="mi">20170427160407</span><span class="p">.</span><span class="n">jpg</span>

<span class="err">$</span><span class="k">match</span><span class="err">$</span><span class="mi">1</span> <span class="err">为</span>  <span class="n">dachui</span><span class="o">/</span><span class="mi">20170427160407</span><span class="p">.</span><span class="n">jpg</span>   <span class="err">要放一起用，否则$</span><span class="mi">1</span><span class="err">不生效</span>

<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="p">.</span><span class="n">ttlsa</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="k">using</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="k">map</span><span class="o">-</span><span class="k">method</span><span class="o">/</span>
</pre></div>


<h2 id="session-hash">session hash规则</h2>
<div class="codehilite"><pre><span></span><span class="k">if</span> <span class="ss">(</span> $<span class="nv">http_cookie</span> <span class="o">~*</span> <span class="s2">&quot;</span><span class="s">JSESSIONID=(.*?);</span><span class="s2">&quot;</span><span class="ss">)</span> #<span class="ss">(</span>.<span class="o">*</span>?<span class="ss">)</span><span class="c1">;(.*)</span>
        {
        <span class="nv">set</span> $<span class="nv">wap_cookie</span> <span class="mh">$1</span><span class="c1">;</span>
        }

<span class="nv">upstream</span> <span class="nv">pool1</span> {
<span class="nv">hash</span>  <span class="mh">$c</span><span class="nv">ookie_jsessionid</span><span class="c1">;         后端为tomcat或者php等使用session服务器（无cookie方式）</span>
<span class="nv">server</span> <span class="nv">server1</span>:<span class="mi">80</span><span class="c1">;</span>
<span class="nv">server</span> <span class="nv">server2</span>:<span class="mi">80</span><span class="c1">;</span>
<span class="nv">server</span> <span class="nv">server3</span>:<span class="mi">80</span><span class="c1">;</span>
<span class="nv">hash_again</span> <span class="mi">2</span><span class="c1">;      提高系统可用性</span>
}

<span class="nv">hash_again</span><span class="o">=</span><span class="mi">1</span>，那么当<span class="nv">server2</span>和 <span class="nv">server1</span>都宕机，但是<span class="nv">server3</span>可用。用户请求时仍然会无法访问。
如果我们改成<span class="nv">hash_again</span><span class="o">=</span><span class="mi">2</span>，那么<span class="nv">nginx</span>会进行两次<span class="nv">hash</span>尝试，尝试访问后端其他可以用的机器。
也就是说<span class="nv">hash_again</span>的值越大，整个系统的可用性就越高。
</pre></div>


<h2 id="nginx-rewrite">nginx rewrite</h2>
<div class="codehilite"><pre><span></span><span class="mh">$a</span><span class="nv">rg_PARAMETER</span> #这个变量包含<span class="nv">GET</span>请求中，如果有变量<span class="nv">PARAMETER</span>时的值
例如  <span class="nv">gRead</span>.<span class="k">do</span>?<span class="nv">imgurl</span><span class="o">=/</span><span class="nv">dachui</span><span class="o">/</span><span class="mi">20170427160407</span>.<span class="nv">jpg</span>   <span class="mh">$a</span><span class="nv">rgs</span>   为     <span class="nv">imgurl</span><span class="o">=/</span><span class="nv">dachui</span><span class="o">/</span><span class="mi">20170427160407</span>.<span class="nv">jpg</span>
                                                   <span class="mh">$a</span><span class="nv">rg_imgurl</span>  为 <span class="o">/</span><span class="nv">dachui</span><span class="o">/</span><span class="mi">20170427160407</span>.<span class="nv">jpg</span>
<span class="mh">$a</span><span class="nv">rgs</span>, 请求中的参数<span class="c1">;</span>
<span class="mh">$d</span><span class="nv">ocument_root</span>, 针对当前请求的根路径设置值<span class="c1">;</span>
$<span class="nv">host</span>, 请求信息中的<span class="s2">&quot;</span><span class="s">Host</span><span class="s2">&quot;</span>，如果请求中没有 <span class="nv">Host</span> 行，则等于设置的服务器名<span class="c1">;</span>
$<span class="nv">limit_rate</span>, 对连接速率的限制<span class="c1">;</span>
$<span class="nv">request_method</span>, 请求的方法，比如<span class="s2">&quot;</span><span class="s">GET</span><span class="s2">&quot;</span>、<span class="s2">&quot;</span><span class="s">POST</span><span class="s2">&quot;</span>等<span class="c1">;</span>
$<span class="nv">remote_addr</span>, 客户端地址<span class="c1">;</span>
$<span class="nv">remote_port</span>, 客户端端口号<span class="c1">;</span>
$<span class="nv">remote_user</span>, 客户端用户名，认证用<span class="c1">;</span>
$<span class="nv">request_filename</span>, 当前请求的文件路径名
$<span class="nv">query_string</span>, 与<span class="mh">$a</span><span class="nv">rgs</span> 相同<span class="c1">;</span>
$<span class="nv">scheme</span>, 所用的协议，比如 <span class="nv">http</span> 或者是 <span class="nv">https</span>
$<span class="nv">server_protocol</span>, 请求的协议版本，<span class="s2">&quot;</span><span class="s">HTTP/1.0</span><span class="s2">&quot;</span>或<span class="s2">&quot;</span><span class="s">HTTP/1.1</span><span class="s2">&quot;</span><span class="c1">;</span>
$<span class="nv">server_addr</span>, 服务器地址，如果没有用 <span class="nv">listen</span> 指明服务器地址，使用这个变量将发起一次系统调用
以取得地址<span class="ss">(</span>造成资源浪费<span class="ss">)</span><span class="c1">;</span>
$<span class="nv">server_name</span>, 请求到达的服务器名<span class="c1">;</span>
<span class="mh">$d</span><span class="nv">ocument_uri</span> 与$<span class="nv">uri</span> 一样，<span class="nv">URI</span>地址<span class="c1">;</span>
$<span class="nv">server_port</span>, 请求到达的服务器端口号<span class="c1">;</span>

<span class="nv">nginx</span> <span class="nv">rewrite</span>指令执行顺序：
<span class="mi">1</span>.执行<span class="nv">server</span>块的<span class="nv">rewrite</span>指令<span class="ss">(</span>这里的块指的是<span class="nv">server</span>关键字后{}包围的区域，其它<span class="nv">xx</span>块类似<span class="ss">)</span>
<span class="mi">2</span>.执行<span class="nv">location</span>匹配
<span class="mi">3</span>.执行选定的<span class="nv">location</span>中的<span class="nv">rewrite</span>指令
如果其中某步<span class="nv">URI</span>被重写，则重新循环执行<span class="mi">1</span><span class="o">-</span><span class="mi">3</span>，直到找到真实存在的文件

如果循环超过<span class="mi">10</span>次，则返回<span class="mi">500</span> <span class="nv">Internal</span> <span class="nv">Server</span> <span class="nv">Error</span>错误

<span class="k">if</span> <span class="ss">(</span>$<span class="nv">hosts</span> <span class="o">~*</span> <span class="o">^</span><span class="nv">www</span>.<span class="nv">hah</span><span class="ss">)</span> {
    <span class="nv">set</span> $<span class="nv">who</span> <span class="s1">&#39;</span><span class="s">who.html</span><span class="s1">&#39;</span><span class="c1">;        set  指令是用于定义一个变量，并且赋值</span>
    <span class="nv">rewrite</span> <span class="o">^/</span><span class="ss">(</span>.<span class="o">*</span><span class="ss">)</span>$ <span class="nv">http</span>:<span class="o">//</span>$<span class="nv">host</span><span class="o">/</span><span class="mh">$1$2</span><span class="o">/</span> <span class="nv">permanent</span><span class="c1">;</span>
}
<span class="nv">last</span> 相当于 <span class="nv">Apache</span> 里的[<span class="nv">L</span>]标记，表示完成 <span class="nv">rewrite</span>
<span class="k">break</span> 本条规则匹配完成后，终止匹配，不再匹配后面的规则
<span class="nv">redirect</span> 返回 <span class="mi">302</span> 临时重定向，浏览器地址会显示跳转后的 <span class="nv">URL</span>地址
<span class="nv">permanent</span> 返回 <span class="mi">301</span> 永久重定向，浏览器地址会显示跳转后 <span class="nv">URL</span>地址

<span class="nv">rewrite</span>  <span class="o">^/</span><span class="nv">test</span>.<span class="nv">php</span>  <span class="o">/</span><span class="nv">new</span>  <span class="nv">permanent</span><span class="c1">;       //重写向带参数的地址</span>
<span class="nv">rewrite</span>  <span class="o">^/</span><span class="nv">test</span>.<span class="nv">php</span>  <span class="o">/</span><span class="nv">new</span>?  <span class="nv">permanent</span><span class="c1">;      //重定向后不带参数</span>
<span class="nv">rewrite</span>  <span class="o">^/</span><span class="nv">test</span>.<span class="nv">php</span>   <span class="o">/</span><span class="nv">new</span>?<span class="nv">id</span><span class="o">=</span><span class="mh">$a</span><span class="nv">rg_id</span>?  <span class="nv">permanent</span><span class="c1">;    //重定向后带指定的参数</span>

<span class="nv">location</span> <span class="o">/</span><span class="nv">search</span> {
            <span class="k">if</span> <span class="ss">(</span><span class="mh">$a</span><span class="nv">rgs</span> <span class="o">~*</span> <span class="s2">&quot;</span><span class="s">ei=</span><span class="s2">&quot;</span><span class="ss">)</span> {
                <span class="nv">rewrite</span> <span class="o">^/</span> <span class="o">/</span><span class="nv">search</span>?<span class="nv">newwindow</span><span class="o">=</span><span class="mi">1</span><span class="o">&amp;</span><span class="nv">q</span><span class="o">=</span><span class="mh">$a</span><span class="nv">rg_q</span><span class="o">&amp;</span><span class="nv">start</span><span class="o">=</span><span class="mh">$a</span><span class="nv">rg_start</span>?  <span class="nv">permanent</span><span class="c1">;</span>
            }
            <span class="nv">proxy_pass</span> <span class="nv">https</span>:<span class="o">//</span><span class="nv">ipv6</span>.<span class="nv">google</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">search</span><span class="c1">;</span>
            <span class="nv">proxy_hide_header</span> <span class="s2">&quot;</span><span class="s">Set-Cookie</span><span class="s2">&quot;</span><span class="c1">;</span>
            <span class="nv">proxy_hide_header</span> <span class="s2">&quot;</span><span class="s">Cache-Control</span><span class="s2">&quot;</span><span class="c1">;</span>
            <span class="nv">proxy_ignore_headers</span> <span class="s2">&quot;</span><span class="s">Expires</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="s">Cache-Control</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="s">Set-Cookie</span><span class="s2">&quot;</span><span class="c1">;</span>
            <span class="nv">expires</span> <span class="mi">30</span><span class="nv">d</span><span class="c1">;</span>
        }
</pre></div>


<h2 id="_1">动静分离</h2>
<div class="codehilite"><pre><span></span><span class="nv">nginx</span>.<span class="nv">conf</span>
动静分离<span class="nv">rewrite</span>新域名跨越问题
<span class="nv">rewrite</span> <span class="o">^/</span> <span class="nv">http</span>:<span class="o">//</span><span class="nv">staticwww</span>.<span class="nv">dachuizichan</span>.<span class="nv">com</span>$<span class="nv">uri</span> <span class="nv">permanent</span><span class="c1">;</span>

<span class="nv">add_header</span> <span class="nv">Access</span><span class="o">-</span><span class="nv">Control</span><span class="o">-</span><span class="nv">Allow</span><span class="o">-</span><span class="nv">Origin</span> <span class="o">*</span><span class="c1">;</span>
<span class="k">if</span> <span class="ss">(</span>$<span class="nv">request_method</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">OPTIONS</span><span class="s1">&#39;</span><span class="ss">)</span> {
                <span class="nv">add_header</span> <span class="nv">Access</span><span class="o">-</span><span class="nv">Control</span><span class="o">-</span><span class="nv">Allow</span><span class="o">-</span><span class="nv">Origin</span> <span class="o">*</span><span class="c1">;</span>
                <span class="nv">add_header</span> <span class="nv">Access</span><span class="o">-</span><span class="nv">Control</span><span class="o">-</span><span class="nv">Allow</span><span class="o">-</span><span class="nv">Credentials</span> <span class="nv">true</span><span class="c1">;</span>
                <span class="nv">add_header</span> <span class="nv">Access</span><span class="o">-</span><span class="nv">Control</span><span class="o">-</span><span class="nv">Allow</span><span class="o">-</span><span class="nv">Methods</span> <span class="s1">&#39;</span><span class="s">GET, POST, OPTIONS</span><span class="s1">&#39;</span><span class="c1">;</span>
                <span class="nv">add_header</span> <span class="s1">&#39;</span><span class="s">Access-Control-Allow-Headers</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">Access-Control-Allow-Origin, x-requested-with, content-type</span><span class="s1">&#39;</span><span class="c1">;</span>
                <span class="k">return</span> <span class="mi">200</span><span class="c1">;</span>
            }



<span class="nv">user</span>  <span class="nv">nginx</span><span class="c1">;</span>
<span class="nv">worker_processes</span>  <span class="mi">1</span><span class="c1">;</span>
<span class="nv">events</span> {
    <span class="nv">worker_connections</span>  <span class="mi">1024</span><span class="c1">;</span>
}
<span class="nv">http</span> {
    <span class="k">include</span>       <span class="nv">mime</span>.<span class="nv">types</span><span class="c1">;</span>
    <span class="nv">default_type</span>  <span class="nv">application</span><span class="o">/</span><span class="nv">octet</span><span class="o">-</span><span class="nv">stream</span><span class="c1">;</span>
    <span class="nv">log_format</span>  <span class="nv">main</span>  <span class="s1">&#39;</span><span class="s">$remote_addr - $remote_user [$time_local] &quot;$request&quot; </span><span class="s1">&#39;</span>
                      <span class="s1">&#39;</span><span class="s">$status $body_bytes_sent &quot;$http_referer&quot; </span><span class="s1">&#39;</span>
                      <span class="s1">&#39;</span><span class="s">&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;</span><span class="s1">&#39;</span><span class="c1">;</span>
    #<span class="nv">access_log</span>  <span class="nv">logs</span><span class="o">/</span><span class="nv">access</span>.<span class="nv">log</span>  <span class="nv">main</span><span class="c1">;</span>
    <span class="k">sendfile</span>        <span class="nv">on</span><span class="c1">;</span>
    <span class="nv">keepalive_timeout</span>  <span class="mi">65</span><span class="c1">;</span>
    <span class="nv">gzip</span>  <span class="nv">on</span><span class="c1">;</span>
    <span class="nv">gzip_min_length</span> <span class="mi">1</span><span class="nv">k</span><span class="c1">;</span>
    <span class="nv">gzip_buffers</span>    <span class="mi">4</span> <span class="mi">16</span><span class="nv">k</span><span class="c1">;</span>
    <span class="nv">gzip_http_version</span> <span class="mi">1</span>.<span class="mi">0</span><span class="c1">;</span>
    <span class="nv">gzip_comp_level</span> <span class="mi">2</span><span class="c1">;   1-10，数字越大压缩的越好，时间也越长</span>
    <span class="nv">gzip_types</span> <span class="nv">text</span><span class="o">/</span><span class="nv">plain</span> <span class="nv">application</span><span class="o">/</span><span class="nv">x</span><span class="o">-</span><span class="nv">javascript</span> <span class="nv">text</span><span class="o">/</span><span class="nv">css</span> <span class="nv">application</span><span class="o">/</span><span class="nv">xml</span> <span class="nv">text</span><span class="o">/</span><span class="nv">javascript</span> <span class="nv">application</span><span class="o">/</span>
    <span class="nv">x</span><span class="o">-</span><span class="nv">httpd</span><span class="o">-</span><span class="nv">php</span> <span class="nv">image</span><span class="o">/</span><span class="nv">jpeg</span> <span class="nv">image</span><span class="o">/</span><span class="nv">gif</span> <span class="nv">image</span><span class="o">/</span><span class="nv">png</span><span class="c1">;</span>
    <span class="nv">gzip_vary</span> <span class="nv">off</span><span class="c1">;  跟Squid等缓存服务有关，on的话会在Header里增加&quot;Vary: Accept-Encoding&quot;</span>

    <span class="nv">proxy_temp_path</span> <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">temp_dir</span><span class="c1">;   #缓存目录</span>
    <span class="nv">proxy_cache_path</span> <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">cache</span> <span class="nv">levels</span><span class="o">=</span><span class="mi">1</span>:<span class="mi">2</span> <span class="nv">keys_zone</span><span class="o">=</span><span class="nv">cache_one</span>:<span class="mi">200</span><span class="nv">m</span> <span class="nv">inactive</span><span class="o">=</span><span class="mi">1</span><span class="nv">d</span> <span class="nv">max_size</span><span class="o">=</span><span class="mi">30</span><span class="nv">g</span><span class="c1">;</span>
    <span class="nv">server</span> {
        <span class="nv">listen</span>       <span class="mi">81</span><span class="c1">;</span>
        <span class="nv">server_name</span>  <span class="nv">localhost</span><span class="c1">;</span>
        <span class="nv">rewrite</span> <span class="o">^/</span> <span class="nv">http</span>:<span class="o">//</span>$<span class="nv">host</span>:<span class="mi">8081</span><span class="o">/</span><span class="mi">3</span><span class="nv">m</span><span class="o">/</span><span class="nv">index</span>.<span class="k">do</span> <span class="nv">last</span><span class="c1">;</span>
    }
    <span class="nv">server</span> {
        <span class="nv">listen</span>       <span class="mi">8081</span><span class="c1">;</span>
        <span class="nv">server_name</span>  <span class="nv">localhost</span><span class="c1">;</span>
        <span class="nv">root</span>  <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">tomcat</span><span class="o">/</span><span class="nv">webapps</span><span class="c1">;</span>
        <span class="nv">location</span> <span class="o">~</span> <span class="ss">(</span>\.<span class="nv">jsp</span><span class="o">|</span>\.<span class="k">do</span><span class="o">|</span><span class="nv">imageServlet</span><span class="ss">)</span>$ {
            <span class="nv">proxy_pass</span> <span class="nv">http</span>:<span class="o">//</span><span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span>:<span class="mi">8080</span><span class="c1">;</span>
            <span class="nv">proxy_redirect</span> <span class="nv">off</span><span class="c1">;</span>
            <span class="nv">proxy_set_header</span> <span class="nv">Host</span> $<span class="nv">host</span><span class="c1">;</span>
            <span class="nv">proxy_set_header</span> <span class="nv">X</span><span class="o">-</span><span class="nv">Real</span><span class="o">-</span><span class="nv">IP</span> $<span class="nv">remote_addr</span><span class="c1">;</span>
            <span class="nv">proxy_set_header</span> <span class="nv">X</span><span class="o">-</span><span class="nv">Forwarded</span><span class="o">-</span><span class="k">For</span> $<span class="nv">proxy_add_x_forwarded_for</span><span class="c1">;</span>
            <span class="nv">client_max_body_size</span> <span class="mi">10</span><span class="nv">m</span><span class="c1">;   #允许客户端请求的最大单文件字节数</span>
            <span class="nv">client_body_buffer_size</span> <span class="mi">128</span><span class="nv">k</span><span class="c1">; #缓冲区代理缓冲用户端请求的最大字节数</span>
            <span class="nv">proxy_connect_timeout</span> <span class="mi">90</span><span class="c1">;   #nginx跟后端服务器连接超时时间(代理连接超时)</span>
            <span class="nv">proxy_read_timeout</span> <span class="mi">90</span><span class="c1">;      #连接成功后，后端服务器响应时间(代理接收超时)</span>
            <span class="nv">proxy_buffer_size</span> <span class="mi">4</span><span class="nv">k</span><span class="c1">;       #设置代理服务器（nginx）保存用户头信息的缓冲区大小</span>
            <span class="nv">proxy_buffers</span> <span class="mi">6</span> <span class="mi">32</span><span class="nv">k</span><span class="c1">;        #proxy_buffers缓冲区，网页平均在32k以下的话，这样设置</span>
            <span class="nv">proxy_busy_buffers_size</span> <span class="mi">64</span><span class="nv">k</span><span class="c1">;#高负荷下缓冲大小（proxy_buffers*2）</span>
            <span class="nv">proxy_temp_file_write_size</span> <span class="mi">64</span><span class="nv">k</span><span class="c1">; #设定缓存文件夹大小，大于这个值，将从upstream服务器传   </span>
        }
        <span class="nv">location</span> <span class="o">~</span> .<span class="o">*</span>\.<span class="ss">(</span><span class="nv">html</span><span class="o">|</span><span class="nv">js</span><span class="o">|</span><span class="nv">css</span><span class="o">|</span><span class="nv">gif</span><span class="o">|</span><span class="nv">jpg</span><span class="o">|</span><span class="nv">png</span><span class="o">|</span><span class="nv">bmp</span><span class="o">|</span><span class="nv">swf</span><span class="o">|</span><span class="nv">ico</span><span class="o">|</span><span class="nv">txt</span><span class="ss">)</span>?$ {
            <span class="nv">proxy_cache</span> <span class="nv">cache_one</span><span class="c1">; # 设置缓存共享内存区块，也就是keys_zone名称。</span>
            <span class="nv">proxy_cache_valid</span> <span class="mi">200</span> <span class="mi">302</span> <span class="mi">1</span><span class="nv">h</span><span class="c1">;</span>
            <span class="nv">expires</span> <span class="mi">1</span><span class="nv">d</span><span class="c1">;</span>
            <span class="nv">root</span> <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">nginx</span><span class="o">/</span><span class="nv">aaa</span><span class="o">/</span><span class="c1">;  文件目录</span>
        }
        <span class="nv">error_page</span>  <span class="mi">404</span>              <span class="o">/</span><span class="mi">404</span>.<span class="nv">html</span><span class="c1">;</span>
        <span class="nv">error_page</span>   <span class="mi">500</span> <span class="mi">502</span> <span class="mi">503</span> <span class="mi">504</span>  <span class="o">/</span><span class="mi">50</span><span class="nv">x</span>.<span class="nv">html</span><span class="c1">;</span>
        <span class="nv">location</span> <span class="o">=</span> <span class="o">/</span><span class="mi">50</span><span class="nv">x</span>.<span class="nv">html</span> {
            <span class="nv">root</span>   <span class="nv">html</span><span class="c1">;</span>
        }
    }
}
</pre></div>


<h2 id="locationrewrite">location和rewrite</h2>
<div class="codehilite"><pre><span></span><span class="n">location</span>  <span class="o">/</span><span class="n">manage</span><span class="o">/</span> <span class="p">{</span>
           <span class="n">proxy_pass</span> <span class="nl">http</span><span class="p">:</span><span class="c1">//dachui_servers/DaChui/manage/;  可以写uri</span>
           <span class="n">sub_filter</span> <span class="err">&#39;</span><span class="nl">dachui_servers</span><span class="p">:</span><span class="mi">80</span><span class="o">/</span><span class="n">DaChui</span><span class="o">/</span><span class="sc">&#39; &#39;</span><span class="n">wwwtest</span><span class="p">.</span><span class="n">dachuizichan</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="err">&#39;</span><span class="p">;</span>     <span class="err">进行替换</span><span class="n">url</span>
           <span class="cp">#sub_filter &#39;http:</span><span class="c1">//dachui_servers:80/DaChui/&#39; &#39;http://wwwtest.dachuizichan.com/&#39;;</span>
           <span class="n">sub_filter</span> <span class="err">&#39;</span><span class="nl">http</span><span class="p">:</span><span class="c1">//dachui_servers/DaChui/&#39; &#39;http://wwwtest.dachuizichan.com/&#39;;</span>
           <span class="n">sub_filter_once</span> <span class="n">off</span><span class="p">;</span>
<span class="p">}</span>
   <span class="err">不能在有正则匹配的</span><span class="n">location</span><span class="err">中用带</span><span class="n">URI</span><span class="err">的</span><span class="n">proxy_pass</span><span class="err">，因为这可能导致</span><span class="n">nginx</span><span class="err">不知道怎么做替换</span>
<span class="n">location</span>  <span class="o">=</span> <span class="o">/</span> <span class="p">{</span>
  <span class="cp"># 精确匹配 / ，主机名后面不能带任何字符串</span>
  <span class="p">[</span> <span class="n">configuration</span> <span class="n">A</span> <span class="p">]</span> 
<span class="p">}</span>

<span class="n">location</span>  <span class="o">/</span> <span class="p">{</span>
  <span class="cp"># 因为所有的地址都以 / 开头，所以这条规则将匹配到所有请求# 但是正则和最长字符串会优先匹配</span>
  <span class="p">[</span> <span class="n">configuration</span> <span class="n">B</span> <span class="p">]</span> 
<span class="p">}</span>

<span class="n">location</span> <span class="o">/</span><span class="n">documents</span><span class="o">/</span> <span class="p">{</span>
  <span class="cp"># 匹配任何以 /documents/ 开头的地址，匹配符合以后，还要继续往下搜索# 只有后面的正则表达式没有匹配到时，这一条才会采用这一条</span>
  <span class="p">[</span> <span class="n">configuration</span> <span class="n">C</span> <span class="p">]</span> 
<span class="p">}</span>

<span class="n">location</span> <span class="o">~</span> <span class="o">/</span><span class="n">documents</span><span class="o">/</span><span class="n">Abc</span> <span class="p">{</span>
  <span class="cp"># 匹配任何以 /documents/ 开头的地址，匹配符合以后，还要继续往下搜索# 只有后面的正则表达式没有匹配到时，这一条才会采用这一条</span>
  <span class="p">[</span> <span class="n">configuration</span> <span class="n">CC</span> <span class="p">]</span> 
<span class="p">}</span>

<span class="n">location</span> <span class="o">^~</span> <span class="o">/</span><span class="n">images</span><span class="o">/</span> <span class="p">{</span>
  <span class="cp"># 匹配任何以 /images/ 开头的地址，匹配符合以后，停止往下搜索正则，采用这一条。</span>
  <span class="p">[</span> <span class="n">configuration</span> <span class="n">D</span> <span class="p">]</span> 
<span class="p">}</span>

<span class="n">location</span> <span class="o">~*</span> <span class="err">\</span><span class="p">.(</span><span class="n">gif</span><span class="o">|</span><span class="n">jpg</span><span class="o">|</span><span class="n">jpeg</span><span class="p">)</span><span class="err">$</span> <span class="p">{</span>
  <span class="cp"># 匹配所有以 gif,jpg或jpeg 结尾的请求# 然而，所有请求 /images/ 下的图片会被 config D 处理，因为 ^~ 到达不了这一条正则</span>
  <span class="p">[</span> <span class="n">configuration</span> <span class="n">E</span> <span class="p">]</span> 
<span class="p">}</span>

<span class="n">location</span> <span class="o">/</span><span class="n">images</span><span class="o">/</span> <span class="p">{</span>
  <span class="cp"># 字符匹配到 /images/，继续往下，会发现 ^~ 存在</span>
  <span class="p">[</span> <span class="n">configuration</span> <span class="n">F</span> <span class="p">]</span> 
<span class="p">}</span>

<span class="n">location</span> <span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="n">abc</span> <span class="p">{</span>
  <span class="cp"># 最长字符匹配到 /images/abc，继续往下，会发现 ^~ 存在# F与G的放置顺序是没有关系的</span>
  <span class="p">[</span> <span class="n">configuration</span> <span class="n">G</span> <span class="p">]</span> 
<span class="p">}</span>

<span class="n">location</span> <span class="o">~</span> <span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="n">abc</span><span class="o">/</span> <span class="p">{</span>
  <span class="cp"># 只有去掉 config D 才有效：先最长匹配 config G 开头的地址，继续往下搜索，匹配到这一条正则，采用</span>
    <span class="p">[</span> <span class="n">configuration</span> <span class="n">H</span> <span class="p">]</span> 
<span class="p">}</span>

<span class="n">location</span> <span class="o">~*</span> <span class="o">/</span><span class="n">js</span><span class="o">/</span><span class="p">.</span><span class="err">*/\</span><span class="p">.</span><span class="n">js</span>
<span class="err">已</span><span class="o">=</span><span class="err">开头表示精确匹配</span>
<span class="err">如</span> <span class="n">A</span> <span class="err">中只匹配根目录结尾的请求，后面不能带任何字符串。</span>
<span class="o">^~</span> <span class="err">开头表示</span><span class="n">uri</span><span class="err">以某个常规字符串开头，不是正则匹配</span>
<span class="o">~</span> <span class="err">开头表示区分大小写的正则匹配</span><span class="p">;</span>
<span class="o">~*</span> <span class="err">开头表示不区分大小写的正则匹配</span>
<span class="o">/</span> <span class="err">通用匹配</span><span class="p">,</span> <span class="err">如果没有其它匹配</span><span class="p">,</span><span class="err">任何请求都会匹配到</span>
<span class="err">顺序</span> <span class="n">no</span><span class="err">优先级：</span>
<span class="p">(</span><span class="n">location</span> <span class="o">=</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">location</span> <span class="err">完整路径</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">location</span> <span class="o">^~</span> <span class="err">路径</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">location</span> <span class="o">~</span><span class="p">,</span><span class="o">~*</span> <span class="err">正则顺序</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">location</span> <span class="err">部分起始路径</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="o">/</span><span class="p">)</span>

<span class="err">上面的匹配结果</span>
<span class="err">按照上面的</span><span class="n">location</span><span class="err">写法，以下的匹配示例成立：</span>

<span class="o">/</span> <span class="o">-&gt;</span> <span class="n">config</span> <span class="n">A</span>
<span class="err">精确完全匹配，即使</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">html</span><span class="err">也匹配不了</span>
<span class="o">/</span><span class="n">downloads</span><span class="o">/</span><span class="n">download</span><span class="p">.</span><span class="n">html</span> <span class="o">-&gt;</span> <span class="n">config</span> <span class="n">B</span>
<span class="err">匹配</span><span class="n">B</span><span class="err">以后，往下没有任何匹配，采用</span><span class="n">B</span>
<span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="mf">1.</span><span class="n">gif</span> <span class="o">-&gt;</span> <span class="n">configuration</span> <span class="n">D</span>
<span class="err">匹配到</span><span class="n">F</span><span class="err">，往下匹配到</span><span class="n">D</span><span class="err">，停止往下</span>
<span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="n">abc</span><span class="o">/</span><span class="n">def</span> <span class="o">-&gt;</span> <span class="n">config</span> <span class="n">D</span>
<span class="err">最长匹配到</span><span class="n">G</span><span class="err">，往下匹配</span><span class="n">D</span><span class="err">，停止往下</span>
<span class="err">你可以看到</span> <span class="err">任何以</span><span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="err">开头的都会匹配到</span><span class="n">D</span><span class="err">并停止，</span><span class="n">FG</span><span class="err">写在这里是没有任何意义的，</span><span class="n">H</span><span class="err">是永远轮不到的，这里只是为了说明匹配顺序</span>
<span class="o">/</span><span class="n">documents</span><span class="o">/</span><span class="n">document</span><span class="p">.</span><span class="n">html</span> <span class="o">-&gt;</span> <span class="n">config</span> <span class="n">C</span>
<span class="err">匹配到</span><span class="n">C</span><span class="err">，往下没有任何匹配，采用</span><span class="n">C</span>
<span class="o">/</span><span class="n">documents</span><span class="o">/</span><span class="mf">1.</span><span class="n">jpg</span> <span class="o">-&gt;</span> <span class="n">configuration</span> <span class="n">E</span>
<span class="err">匹配到</span><span class="n">C</span><span class="err">，往下正则匹配到</span><span class="n">E</span>
<span class="o">/</span><span class="n">documents</span><span class="o">/</span><span class="n">Abc</span><span class="p">.</span><span class="n">jpg</span> <span class="o">-&gt;</span> <span class="n">config</span> <span class="n">CC</span>
<span class="err">最长匹配到</span><span class="n">C</span><span class="err">，往下正则顺序匹配到</span><span class="n">CC</span><span class="err">，不会往下到</span><span class="n">E</span>
<span class="err">实际使用建议</span>
<span class="err">所以实际使用中，个人觉得至少有三个匹配规则定义，如下：</span>
<span class="cp">#直接匹配网站根，通过域名访问网站首页比较频繁，使用这个会加速处理，官网如是说。#这里是直接转发给后端应用服务器了，</span>
<span class="err">也可以是一个静态首页#</span> <span class="err">第一个必选规则</span>
<span class="n">location</span> <span class="o">=</span> <span class="o">/</span> <span class="p">{</span>
    <span class="n">proxy_pass</span> <span class="nl">http</span><span class="p">:</span><span class="c1">//tomcat:8080/index</span>
<span class="p">}</span>
<span class="cp"># 第二个必选规则是处理静态文件请求，这是nginx作为http服务器的强项# 有两种配置模式，目录匹配或后缀匹配,任选其一或搭配使用</span>
<span class="n">location</span> <span class="o">^~</span> <span class="o">/</span><span class="k">static</span><span class="o">/</span> <span class="p">{</span>
    <span class="n">root</span> <span class="o">/</span><span class="n">webroot</span><span class="o">/</span><span class="k">static</span><span class="o">/</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">location</span> <span class="o">~*</span> <span class="err">\</span><span class="p">.(</span><span class="n">gif</span><span class="o">|</span><span class="n">jpg</span><span class="o">|</span><span class="n">jpeg</span><span class="o">|</span><span class="n">png</span><span class="o">|</span><span class="n">css</span><span class="o">|</span><span class="n">js</span><span class="o">|</span><span class="n">ico</span><span class="p">)</span><span class="err">$</span> <span class="p">{</span>
    <span class="n">root</span> <span class="o">/</span><span class="n">webroot</span><span class="o">/</span><span class="n">res</span><span class="o">/</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#第三个规则就是通用规则，用来转发动态请求到后端应用服务器#非静态文件请求就默认是动态请求，自己根据实际把握#毕竟目前的一些</span>
<span class="err">框架的流行，带</span><span class="p">.</span><span class="n">php</span><span class="p">,.</span><span class="n">jsp</span><span class="err">后缀的情况很少了</span>
<span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
    <span class="n">proxy_pass</span> <span class="nl">http</span><span class="p">:</span><span class="c1">//tomcat:8080/</span>
<span class="p">}</span>
<span class="nl">http</span><span class="p">:</span><span class="c1">//tengine.taobao.org/book/chapter_02.html</span>
<span class="nl">http</span><span class="p">:</span><span class="c1">//nginx.org/en/docs/http/ngx_http_rewrite_module.html</span>

<span class="n">Rewrite</span><span class="err">规则</span>
<span class="n">rewrite</span><span class="err">功能就是，使用</span><span class="n">nginx</span><span class="err">提供的全局变量或自己设置的变量，结合正则表达式和标志位实现</span><span class="n">url</span><span class="err">重写以及重定向。</span><span class="n">rewrite</span><span class="err">只能放在</span>
<span class="n">server</span><span class="p">{},</span><span class="n">location</span><span class="p">{},</span><span class="k">if</span><span class="p">{}</span><span class="err">中，并且只能对域名后边的除去传递的参数外的字符串起作用，</span>
<span class="err">例如</span> <span class="nl">http</span><span class="p">:</span><span class="c1">//seanlook.com/a/we/index.php?id=1&amp;u=str 只对/a/we/index.php重写。语法rewrite regex replacement [flag];</span>

<span class="err">如果相对域名或参数字符串起作用，可以使用全局变量匹配，也可以使用</span><span class="n">proxy_pass</span><span class="err">反向代理。</span>

<span class="err">表明看</span><span class="n">rewrite</span><span class="err">和</span><span class="n">location</span><span class="err">功能有点像，都能实现跳转，主要区别在于</span><span class="n">rewrite</span><span class="err">是在同一域名内更改获取资源的路径，而</span><span class="n">location</span><span class="err">是对</span>
<span class="err">一类路径做控制访问或反向代理，可以</span><span class="n">proxy_pass</span><span class="err">到其他机器。很多情况下</span><span class="n">rewrite</span><span class="err">也会写在</span><span class="n">location</span><span class="err">里，它们的执行顺序是：</span>

<span class="err">执行</span><span class="n">server</span><span class="err">块的</span><span class="n">rewrite</span><span class="err">指令</span>
<span class="err">执行</span><span class="n">location</span><span class="err">匹配</span>
<span class="err">执行选定的</span><span class="n">location</span><span class="err">中的</span><span class="n">rewrite</span><span class="err">指令</span>
<span class="err">如果其中某步</span><span class="n">URI</span><span class="err">被重写，则重新循环执行</span><span class="mi">1</span><span class="o">-</span><span class="mi">3</span><span class="err">，直到找到真实存在的文件；循环超过</span><span class="mi">10</span><span class="err">次，则返回</span><span class="mi">500</span> <span class="n">Internal</span> <span class="n">Server</span> <span class="n">Error</span><span class="err">错误。</span>

<span class="n">flag</span><span class="err">标志位</span>
<span class="nl">last</span> <span class="p">:</span> <span class="err">相当于</span><span class="n">Apache</span><span class="err">的</span><span class="p">[</span><span class="n">L</span><span class="p">]</span><span class="err">标记，表示完成</span><span class="n">rewrite</span>
<span class="k">break</span> <span class="o">:</span> <span class="err">停止执行当前虚拟主机的后续</span><span class="n">rewrite</span><span class="err">指令集</span>
<span class="nl">redirect</span> <span class="p">:</span> <span class="err">返回</span><span class="mi">302</span><span class="err">临时重定向，地址栏会显示跳转后的地址</span>
<span class="nl">permanent</span> <span class="p">:</span> <span class="err">返回</span><span class="mi">301</span><span class="err">永久重定向，地址栏会显示跳转后的地址</span>
<span class="err">因为</span><span class="mi">301</span><span class="err">和</span><span class="mi">302</span><span class="err">不能简单的只返回状态码，还必须有重定向的</span><span class="n">URL</span><span class="err">，这就是</span><span class="k">return</span><span class="err">指令无法返回</span><span class="mi">301</span><span class="p">,</span><span class="mi">302</span><span class="err">的原因了。这里</span> <span class="n">last</span> <span class="err">和</span> <span class="k">break</span> 
<span class="err">区别有点难以理解：</span>

<span class="n">last</span><span class="err">一般写在</span><span class="n">server</span><span class="err">和</span><span class="k">if</span><span class="err">中，而</span><span class="k">break</span><span class="err">一般使用在</span><span class="n">location</span><span class="err">中</span>
<span class="n">last</span><span class="err">不终止重写后的</span><span class="n">url</span><span class="err">匹配，即新的</span><span class="n">url</span><span class="err">会再从</span><span class="n">server</span><span class="err">走一遍匹配流程，而</span><span class="k">break</span><span class="err">终止重写后的匹配</span>
<span class="k">break</span><span class="err">和</span><span class="n">last</span><span class="err">都能组织继续执行后面的</span><span class="n">rewrite</span><span class="err">指令</span>
<span class="k">if</span><span class="err">指令与全局变量</span>
<span class="k">if</span><span class="err">判断指令</span>
<span class="err">语法为</span><span class="k">if</span><span class="p">(</span><span class="n">condition</span><span class="p">){...}</span><span class="err">，对给定的条件</span><span class="n">condition</span><span class="err">进行判断。如果为真，大括号内的</span><span class="n">rewrite</span><span class="err">指令将被执行，</span><span class="k">if</span><span class="err">条件</span><span class="p">(</span><span class="n">conditon</span><span class="p">)</span><span class="err">可</span>
<span class="err">以是如下任何内容：</span>

<span class="err">当表达式只是一个变量时，如果值为空或任何以</span><span class="mi">0</span><span class="err">开头的字符串都会当做</span><span class="nb">false</span>
<span class="err">直接比较变量和内容时，使用</span><span class="o">=</span><span class="err">或</span><span class="o">!=</span>
<span class="o">~</span><span class="err">正则表达式匹配，</span><span class="o">~*</span><span class="err">不区分大小写的匹配，</span><span class="o">!~</span><span class="err">区分大小写的不匹配</span>
<span class="o">-</span><span class="n">f</span><span class="err">和</span><span class="o">!-</span><span class="n">f</span><span class="err">用来判断是否存在文件</span>
<span class="o">-</span><span class="n">d</span><span class="err">和</span><span class="o">!-</span><span class="n">d</span><span class="err">用来判断是否存在目录</span>
<span class="o">-</span><span class="n">e</span><span class="err">和</span><span class="o">!-</span><span class="n">e</span><span class="err">用来判断是否存在文件或目录</span>
<span class="o">-</span><span class="n">x</span><span class="err">和</span><span class="o">!-</span><span class="n">x</span><span class="err">用来判断文件是否可执行</span>

<span class="err">例如：</span>

<span class="k">if</span> <span class="p">(</span><span class="err">$</span><span class="n">http_user_agent</span> <span class="o">~</span> <span class="n">MSIE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">rewrite</span> <span class="o">^</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="err">$</span> <span class="o">/</span><span class="n">msie</span><span class="o">/</span><span class="err">$</span><span class="mi">1</span> <span class="k">break</span><span class="p">;</span>
<span class="p">}</span> <span class="c1">//如果UA包含&quot;MSIE&quot;，rewrite请求到/msid/目录下</span>

<span class="k">if</span> <span class="p">(</span><span class="err">$</span><span class="n">http_cookie</span> <span class="o">~*</span> <span class="s">&quot;id=([^;]+)(?:;|$)&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">set</span> <span class="err">$</span><span class="kt">id</span> <span class="err">$</span><span class="mi">1</span><span class="p">;</span>
 <span class="p">}</span> <span class="c1">//如果cookie匹配正则，设置变量$id等于正则引用部分</span>

<span class="k">if</span> <span class="p">(</span><span class="err">$</span><span class="n">request_method</span> <span class="o">=</span> <span class="n">POST</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">405</span><span class="p">;</span>
<span class="p">}</span> <span class="c1">//如果提交方法为POST，则返回状态405（Method not allowed）。return不能返回301,302if ($slow) {</span>
    <span class="n">limit_rate</span> <span class="mi">10</span><span class="n">k</span><span class="p">;</span>
<span class="p">}</span> <span class="c1">//限速，$slow可以通过 set 指令设置</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!-</span><span class="n">f</span> <span class="err">$</span><span class="n">request_filename</span><span class="p">){</span>
    <span class="k">break</span><span class="p">;</span>
    <span class="n">proxy_pass</span>  <span class="nl">http</span><span class="p">:</span><span class="c1">//127.0.0.1; </span>
<span class="p">}</span> <span class="c1">//如果请求的文件名不存在，则反向代理到localhost 。这里的break也是停止rewrite检查</span>

<span class="k">if</span> <span class="p">(</span><span class="err">$</span><span class="n">args</span> <span class="o">~</span> <span class="n">post</span><span class="o">=</span><span class="mi">140</span><span class="p">){</span>
    <span class="n">rewrite</span> <span class="o">^</span> <span class="nl">http</span><span class="p">:</span><span class="c1">//example.com/ permanent;</span>
<span class="p">}</span> <span class="c1">//如果query string中包含&quot;post=140&quot;，永久重定向到example.com</span>

<span class="n">location</span> <span class="o">~*</span> <span class="err">\</span><span class="p">.(</span><span class="n">gif</span><span class="o">|</span><span class="n">jpg</span><span class="o">|</span><span class="n">png</span><span class="o">|</span><span class="n">swf</span><span class="o">|</span><span class="n">flv</span><span class="p">)</span><span class="err">$</span> <span class="p">{</span>
    <span class="n">valid_referers</span> <span class="n">none</span> <span class="n">blocked</span> <span class="n">www</span><span class="p">.</span><span class="n">jefflei</span><span class="p">.</span><span class="n">com</span> <span class="n">www</span><span class="p">.</span><span class="n">leizhenfang</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="err">$</span><span class="n">invalid_referer</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">404</span><span class="p">;</span>
    <span class="p">}</span> <span class="c1">//防盗链</span>
<span class="p">}</span>
<span class="err">全局变量</span>
<span class="err">下面是可以用作</span><span class="k">if</span><span class="err">判断的全局变量</span>

<span class="err">$</span><span class="n">args</span> <span class="err">：</span> <span class="err">#这个变量等于请求行中的参数，同$</span><span class="n">query_string</span>
<span class="err">$</span><span class="n">content_length</span> <span class="err">：</span> <span class="err">请求头中的</span><span class="n">Content</span><span class="o">-</span><span class="n">length</span><span class="err">字段。</span>
<span class="err">$</span><span class="n">content_type</span> <span class="err">：</span> <span class="err">请求头中的</span><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="err">字段。</span>
<span class="err">$</span><span class="n">document_root</span> <span class="err">：</span> <span class="err">当前请求在</span><span class="n">root</span><span class="err">指令中指定的值。</span>
<span class="err">$</span><span class="n">host</span> <span class="err">：</span> <span class="err">请求主机头字段，否则为服务器名称。</span>
<span class="err">$</span><span class="n">http_user_agent</span> <span class="err">：</span> <span class="err">客户端</span><span class="n">agent</span><span class="err">信息</span>
<span class="err">$</span><span class="n">http_cookie</span> <span class="err">：</span> <span class="err">客户端</span><span class="n">cookie</span><span class="err">信息</span>
<span class="err">$</span><span class="n">limit_rate</span> <span class="err">：</span> <span class="err">这个变量可以限制连接速率。</span>
<span class="err">$</span><span class="n">request_method</span> <span class="err">：</span> <span class="err">客户端请求的动作，通常为</span><span class="n">GET</span><span class="err">或</span><span class="n">POST</span><span class="err">。</span>
<span class="err">$</span><span class="n">remote_addr</span> <span class="err">：</span> <span class="err">客户端的</span><span class="n">IP</span><span class="err">地址。</span>
<span class="err">$</span><span class="n">remote_port</span> <span class="err">：</span> <span class="err">客户端的端口。</span>
<span class="err">$</span><span class="n">remote_user</span> <span class="err">：</span> <span class="err">已经经过</span><span class="n">Auth</span> <span class="n">Basic</span> <span class="n">Module</span><span class="err">验证的用户名。</span>
<span class="err">$</span><span class="n">request_filename</span> <span class="err">：</span> <span class="err">当前请求的文件路径，由</span><span class="n">root</span><span class="err">或</span><span class="n">alias</span><span class="err">指令与</span><span class="n">URI</span><span class="err">请求生成。</span>
<span class="err">$</span><span class="n">scheme</span> <span class="err">：</span> <span class="n">HTTP</span><span class="err">方法（如</span><span class="n">http</span><span class="err">，</span><span class="n">https</span><span class="err">）。</span>
<span class="err">$</span><span class="n">server_protocol</span> <span class="err">：</span> <span class="err">请求使用的协议，通常是</span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.0</span><span class="err">或</span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span><span class="err">。</span>
<span class="err">$</span><span class="n">server_addr</span> <span class="err">：</span> <span class="err">服务器地址，在完成一次系统调用后可以确定这个值。</span>
<span class="err">$</span><span class="n">server_name</span> <span class="err">：</span> <span class="err">服务器名称。</span>
<span class="err">$</span><span class="n">server_port</span> <span class="err">：</span> <span class="err">请求到达服务器的端口号。</span>
<span class="err">$</span><span class="n">request_uri</span> <span class="err">：</span> <span class="err">包含请求参数的原始</span><span class="n">URI</span><span class="err">，不包含主机名，如：”</span><span class="o">/</span><span class="n">foo</span><span class="o">/</span><span class="n">bar</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">arg</span><span class="o">=</span><span class="n">baz</span><span class="err">”。</span>
<span class="err">$</span><span class="n">uri</span> <span class="err">：</span> <span class="err">不带请求参数的当前</span><span class="n">URI</span><span class="err">，$</span><span class="n">uri</span><span class="err">不包含主机名，如”</span><span class="o">/</span><span class="n">foo</span><span class="o">/</span><span class="n">bar</span><span class="p">.</span><span class="n">html</span><span class="err">”。</span>
<span class="err">$</span><span class="n">document_uri</span> <span class="err">：</span> <span class="err">与$</span><span class="n">uri</span><span class="err">相同。</span>
<span class="err">例：</span><span class="nl">http</span><span class="p">:</span><span class="c1">//localhost:88/test1/test2/test.php</span>
<span class="err">$</span><span class="n">host</span><span class="err">：</span><span class="n">localhost</span>
<span class="err">$</span><span class="n">server_port</span><span class="err">：</span><span class="mi">88</span>
<span class="err">$</span><span class="n">request_uri</span><span class="err">：</span><span class="nl">http</span><span class="p">:</span><span class="c1">//localhost:88/test1/test2/test.php</span>
<span class="err">$</span><span class="n">document_uri</span><span class="err">：</span><span class="o">/</span><span class="n">test1</span><span class="o">/</span><span class="n">test2</span><span class="o">/</span><span class="n">test</span><span class="p">.</span><span class="n">php</span>
<span class="err">$</span><span class="n">document_root</span><span class="err">：</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span>
<span class="err">$</span><span class="n">request_filename</span><span class="err">：</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">test1</span><span class="o">/</span><span class="n">test2</span><span class="o">/</span><span class="n">test</span><span class="p">.</span><span class="n">php</span>

<span class="err">常用正则</span>
<span class="p">.</span> <span class="err">：</span> <span class="err">匹配除换行符以外的任意字符</span>
<span class="o">?</span> <span class="err">：</span> <span class="err">重复</span><span class="mi">0</span><span class="err">次或</span><span class="mi">1</span><span class="err">次</span>
<span class="o">+</span> <span class="err">：</span> <span class="err">重复</span><span class="mi">1</span><span class="err">次或更多次</span>
<span class="o">*</span> <span class="err">：</span> <span class="err">重复</span><span class="mi">0</span><span class="err">次或更多次</span>
<span class="err">\</span><span class="n">d</span> <span class="err">：匹配数字</span>
<span class="o">^</span> <span class="err">：</span> <span class="err">匹配字符串的开始</span>
<span class="err">$</span> <span class="err">：</span> <span class="err">匹配字符串的介绍</span>
<span class="p">{</span><span class="n">n</span><span class="p">}</span> <span class="err">：</span> <span class="err">重复</span><span class="n">n</span><span class="err">次</span>
<span class="p">{</span><span class="n">n</span><span class="p">,}</span> <span class="err">：</span> <span class="err">重复</span><span class="n">n</span><span class="err">次或更多次</span>
<span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="err">：</span> <span class="err">匹配单个字符</span><span class="n">c</span>
<span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="n">z</span><span class="p">]</span> <span class="err">：</span> <span class="err">匹配</span><span class="n">a</span><span class="o">-</span><span class="n">z</span><span class="err">小写字母的任意一个</span>
<span class="err">小括号</span><span class="p">()</span><span class="err">之间匹配的内容，可以在后面通过$</span><span class="mi">1</span><span class="err">来引用，$</span><span class="mi">2</span><span class="err">表示的是前面第二个</span><span class="p">()</span><span class="err">里的内容。正则里面容易让人困惑的是\转义特殊字符。</span>

<span class="n">rewrite</span><span class="err">实例</span>
<span class="err">例</span><span class="mi">1</span><span class="err">：</span>

<span class="n">rewrite</span> <span class="o">^</span> <span class="nl">http</span><span class="p">:</span><span class="c1">//staticwww.dachuizichan.com$request_uri? permanent;   域名重定向</span>

<span class="n">http</span> <span class="p">{</span>
    <span class="cp"># 定义image日志格式log_format imagelog &#39;[$time_local] &#39; $image_file &#39; &#39; $image_type &#39; &#39; $body_bytes_sent &#39; &#39; </span>
    <span class="err">$</span><span class="n">status</span><span class="p">;</span>
    <span class="cp"># 开启重写日志rewrite_log on;</span>

    <span class="n">server</span> <span class="p">{</span>
        <span class="n">root</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">www</span><span class="p">;</span>

        <span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
                <span class="cp"># 重写规则信息error_log logs/rewrite.log notice; </span>
                <span class="cp"># 注意这里要用‘’单引号引起来，避免{}rewrite &#39;^/images/([a-z]{2})/([a-z0-9]{5})/(.*)\.(png|jpg|gif)$&#39; </span>
                <span class="o">/</span><span class="n">data</span><span class="o">?</span><span class="n">file</span><span class="o">=</span><span class="err">$</span><span class="mf">3.</span><span class="err">$</span><span class="mi">4</span><span class="p">;</span>
                <span class="cp"># 注意不能在上面这条规则后面加上“last”参数，否则下面的set指令不会执行set $image_file $3;</span>
                <span class="n">set</span> <span class="err">$</span><span class="n">image_type</span> <span class="err">$</span><span class="mi">4</span><span class="p">;</span>
        <span class="p">}</span>


        <span class="n">location</span> <span class="o">/</span><span class="n">data</span> <span class="p">{</span>
                <span class="cp"># 指定针对图片的日志格式，来分析图片类型和大小access_log logs/images.log mian;</span>
                <span class="n">root</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">images</span><span class="p">;</span>
                <span class="cp"># 应用前面定义的变量。判断首先文件在不在，不在再判断目录在不在，如果还不在就跳转到最后一个url里try_files</span>
                 <span class="o">/</span><span class="err">$</span><span class="n">arg_file</span> <span class="o">/</span><span class="n">image404</span><span class="p">.</span><span class="n">html</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">location</span> <span class="o">=</span> <span class="o">/</span><span class="n">image404</span><span class="p">.</span><span class="n">html</span> <span class="p">{</span>
                <span class="cp"># 图片不存在返回特定的信息return 404 &quot;image not found\n&quot;;</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="err">对形如</span><span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="n">ef</span><span class="o">/</span><span class="n">uh7b3</span><span class="o">/</span><span class="n">test</span><span class="p">.</span><span class="n">png</span><span class="err">的请求，重写到</span><span class="o">/</span><span class="n">data</span><span class="o">?</span><span class="n">file</span><span class="o">=</span><span class="n">test</span><span class="p">.</span><span class="n">png</span><span class="err">，于是匹配到</span><span class="n">location</span> <span class="o">/</span><span class="n">data</span><span class="err">，先看</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="n">test</span><span class="p">.</span><span class="n">png</span>
<span class="err">文件存不存在，如果存在则正常响应，如果不存在则重写</span><span class="n">tryfiles</span><span class="err">到新的</span><span class="n">image404</span> <span class="n">location</span><span class="err">，直接返回</span><span class="mi">404</span><span class="err">状态码。</span>

<span class="err">例</span><span class="mi">2</span><span class="err">：</span>

<span class="n">rewrite</span> <span class="o">^/</span><span class="n">images</span><span class="o">/</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="n">_</span><span class="p">(</span><span class="err">\</span><span class="n">d</span><span class="o">+</span><span class="p">)</span><span class="n">x</span><span class="p">(</span><span class="err">\</span><span class="n">d</span><span class="o">+</span><span class="p">)</span><span class="err">\</span><span class="p">.(</span><span class="n">png</span><span class="o">|</span><span class="n">jpg</span><span class="o">|</span><span class="n">gif</span><span class="p">)</span><span class="err">$</span> <span class="o">/</span><span class="n">resizer</span><span class="o">/</span><span class="err">$</span><span class="mf">1.</span><span class="err">$</span><span class="mi">4</span><span class="o">?</span><span class="n">width</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">height</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span><span class="o">?</span> <span class="n">last</span><span class="p">;</span>
<span class="err">对形如</span><span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="n">bla_500x400</span><span class="p">.</span><span class="n">jpg</span><span class="err">的文件请求，重写到</span><span class="o">/</span><span class="n">resizer</span><span class="o">/</span><span class="n">bla</span><span class="p">.</span><span class="n">jpg</span><span class="o">?</span><span class="n">width</span><span class="o">=</span><span class="mi">500</span><span class="o">&amp;</span><span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="err">地址，并会继续尝试匹配</span><span class="n">location</span><span class="err">。</span>

<span class="err">正则匹配的参数，$</span><span class="mi">1</span><span class="err">表示第一个</span><span class="p">()</span><span class="err">内的正则匹配内容，$</span><span class="mi">2</span><span class="err">为第二个，以此类推。</span>
</pre></div>


<h2 id="nginx">nginx忽略参数</h2>
<div class="codehilite"><pre><span></span>例如：
把<span class="nv">http</span>:<span class="o">//</span><span class="nv">example</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">test</span>.<span class="nv">php</span>?<span class="nv">para</span><span class="o">=</span><span class="nv">xxx</span> 重定向到 <span class="nv">http</span>:<span class="o">//</span><span class="nv">example</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">new</span>
若按照默认的写法：<span class="nv">rewrite</span> <span class="o">^/</span><span class="nv">test</span>.<span class="nv">php</span><span class="ss">(</span>.<span class="o">*</span><span class="ss">)</span> <span class="o">/</span><span class="nv">new</span> <span class="nv">permanent</span><span class="c1">;</span>
重定向后的结果是：<span class="nv">http</span>:<span class="o">//</span><span class="nv">example</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">new</span>?<span class="nv">para</span><span class="o">=</span><span class="nv">xxx</span>
如果改写成：<span class="nv">rewrite</span> <span class="o">^/</span><span class="nv">test</span>.<span class="nv">php</span><span class="ss">(</span>.<span class="o">*</span><span class="ss">)</span> <span class="o">/</span><span class="nv">new</span>? <span class="nv">permanent</span><span class="c1">;</span>
那结果就是：<span class="nv">http</span>:<span class="o">//</span><span class="nv">example</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">new</span>

所以，关键点就在于“？”这个尾缀。假如又想保留某个特定的参数，那又该如何呢？可以利用<span class="nv">Nginx</span>本身就带有的<span class="mh">$a</span><span class="nv">rg_PARAMETER</span>参数来实现。

例如：
把<span class="nv">http</span>:<span class="o">//</span><span class="nv">example</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">test</span>.<span class="nv">php</span>?<span class="nv">para</span><span class="o">=</span><span class="nv">xxx</span><span class="o">&amp;</span><span class="nv">p</span><span class="o">=</span><span class="nv">xx</span> 重写向到 <span class="nv">http</span>:<span class="o">//</span><span class="nv">example</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">new</span>?<span class="nv">p</span><span class="o">=</span><span class="nv">xx</span>
可以写成：<span class="nv">rewrite</span>  <span class="o">^/</span><span class="nv">test</span>.<span class="nv">php</span>   <span class="o">/</span><span class="nv">new</span>?<span class="nv">p</span><span class="o">=</span><span class="mh">$a</span><span class="nv">rg_p</span>?  <span class="nv">permanent</span><span class="c1">;</span>


<span class="nv">rewrite</span>  <span class="o">^/</span><span class="nv">test</span>.<span class="nv">php</span>  <span class="o">/</span><span class="nv">new</span>  <span class="nv">permanent</span><span class="c1">;       //重写向带参数的地址</span>
<span class="nv">rewrite</span>  <span class="o">^/</span><span class="nv">test</span>.<span class="nv">php</span>  <span class="o">/</span><span class="nv">new</span>?  <span class="nv">permanent</span><span class="c1">;      //重定向后不带参数</span>
<span class="nv">rewrite</span>  <span class="o">^/</span><span class="nv">test</span>.<span class="nv">php</span>   <span class="o">/</span><span class="nv">new</span>?<span class="nv">id</span><span class="o">=</span><span class="mh">$a</span><span class="nv">rg_id</span>?  <span class="nv">permanent</span><span class="c1">;    //重定向后带指定的参数</span>
<span class="nv">permanent</span>是永久重定向参数，根据需要去掉也可以，不过最好是带有。

<span class="k">if</span> <span class="ss">(</span><span class="mh">$a</span><span class="nv">rgs</span><span class="ss">)</span> {     不做判断会循环<span class="nv">rewrite</span>
                <span class="nv">rewrite</span> <span class="o">^/</span><span class="ss">(</span>.<span class="o">*</span><span class="ss">)</span> <span class="o">/</span><span class="mh">$1</span>? <span class="nv">permanent</span><span class="c1">;    忽略后面的参数</span>
            }
</pre></div>


<h2 id="cdn">配置cdn后做限制</h2>
<div class="codehilite"><pre><span></span><span class="nv">http</span> {    放到<span class="nv">http</span>下
# <span class="k">for</span> <span class="nv">pre</span><span class="o">-</span><span class="nv">open</span> <span class="nv">closed</span> <span class="nv">test</span>
<span class="nv">map</span> $<span class="nv">http_x_forwarded_for</span> <span class="mh">$a</span><span class="nv">llowed</span> {
    <span class="nv">default</span> <span class="nv">deny</span><span class="c1">;</span>
    <span class="o">~</span>\<span class="nv">s</span><span class="o">*</span><span class="mi">111</span>.<span class="mi">222</span>.<span class="mi">333</span>.<span class="mi">444</span>$ <span class="nv">allow</span><span class="c1">;</span>
    <span class="o">~</span>\<span class="nv">s</span><span class="o">*</span><span class="mi">123</span>.<span class="mi">456</span>.<span class="mi">789</span>.<span class="o">*</span>$   <span class="nv">allow</span><span class="c1">;</span>
}
} 
<span class="nv">location</span> <span class="o">/</span> {
    <span class="k">if</span> <span class="ss">(</span><span class="mh">$a</span><span class="nv">llowed</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">deny</span><span class="s2">&quot;</span><span class="ss">)</span> { <span class="k">return</span> <span class="mi">403</span><span class="c1">; }</span>
    <span class="nv">alias</span> <span class="o">/</span><span class="nv">path</span><span class="o">/</span><span class="nv">to</span><span class="o">/</span><span class="nv">document_root</span>
}

<span class="o">===========================================</span>
<span class="nv">nginx</span> <span class="nv">http_realip_module</span>模块
<span class="nv">location</span> <span class="o">=</span> <span class="o">/</span><span class="nv">getRealip</span>.<span class="nv">php</span>
        {
                <span class="nv">set_real_ip_from</span>  <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">50</span>.<span class="mi">0</span><span class="o">/</span><span class="mi">24</span><span class="c1">;</span>
                <span class="nv">set_real_ip_from</span>  <span class="mi">61</span>.<span class="mi">22</span>.<span class="mi">22</span>.<span class="mi">22</span><span class="c1">;</span>
                <span class="nv">set_real_ip_from</span>  <span class="mi">121</span>.<span class="mi">207</span>.<span class="mi">33</span>.<span class="mi">33</span><span class="c1">;</span>
                <span class="nv">set_real_ip_from</span> <span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span><span class="c1">;</span>
                <span class="nv">real_ip_header</span>    <span class="nv">X</span><span class="o">-</span><span class="nv">Forwarded</span><span class="o">-</span><span class="k">For</span><span class="c1">;</span>
                <span class="nv">real_ip_recursive</span> <span class="nv">on</span><span class="c1">;</span>
                <span class="nv">fastcgi_pass</span>  <span class="nv">unix</span>:<span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">run</span><span class="o">/</span><span class="nv">phpfpm</span>.<span class="nv">sock</span><span class="c1">;</span>
                <span class="nv">fastcgi_index</span> <span class="nv">index</span>.<span class="nv">php</span><span class="c1">;</span>
                <span class="k">include</span> <span class="nv">fastcgi</span>.<span class="nv">conf</span><span class="c1">;</span>
        }
<span class="nv">set_real_ip_from</span>：真实服务器上一级代理的<span class="nv">IP</span>地址或者<span class="nv">IP</span>段,可以写多行
<span class="nv">real_ip_header</span>：从哪个<span class="nv">header</span>头检索出要的<span class="nv">IP</span>地址
<span class="nv">real_ip_recursive</span>：递归排除<span class="nv">IP</span>地址,<span class="nv">ip</span>串从右到左开始排除<span class="nv">set_real_ip_from</span>里面出现的<span class="nv">IP</span>,如果出现了未出现这些<span class="nv">ip</span>段的<span class="nv">IP</span>，
那么这个<span class="nv">IP</span>将被认为是用户的<span class="nv">IP</span>。例如我这边的例子，真实服务器获取到的<span class="nv">IP</span>地址串如下：
<span class="mi">120</span>.<span class="mi">22</span>.<span class="mi">11</span>.<span class="mi">11</span>,<span class="mi">61</span>.<span class="mi">22</span>.<span class="mi">22</span>.<span class="mi">22</span>,<span class="mi">121</span>.<span class="mi">207</span>.<span class="mi">33</span>.<span class="mi">33</span>,<span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">50</span>.<span class="mi">121</span>
在<span class="nv">real_ip_recursive</span> <span class="nv">on</span>的情况下
<span class="mi">61</span>.<span class="mi">22</span>.<span class="mi">22</span>.<span class="mi">22</span>,<span class="mi">121</span>.<span class="mi">207</span>.<span class="mi">33</span>.<span class="mi">33</span>,<span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">50</span>.<span class="mi">121</span>都出现在<span class="nv">set_real_ip_from</span>中,仅仅<span class="mi">120</span>.<span class="mi">22</span>.<span class="mi">11</span>.<span class="mi">11</span>没出现,那么他就被认为是用户的<span class="nv">ip</span>地址，
并且赋值到<span class="nv">remote_addr</span>变量
在<span class="nv">real_ip_recursive</span> <span class="nv">off</span>或者不设置的情况下
<span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">50</span>.<span class="mi">121</span>出现在<span class="nv">set_real_ip_from</span>中,排除掉，接下来的<span class="nv">ip</span>地址便认为是用户的<span class="nv">ip</span>地址
如果仅仅如下配置：
    <span class="nv">set_real_ip_from</span>   <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">50</span>.<span class="mi">0</span><span class="o">/</span><span class="mi">24</span><span class="c1">;</span>
    <span class="nv">set_real_ip_from</span> <span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span><span class="c1">;</span>
    <span class="nv">real_ip_header</span>    <span class="nv">X</span><span class="o">-</span><span class="nv">Forwarded</span><span class="o">-</span><span class="k">For</span><span class="c1">;</span>
    <span class="nv">real_ip_recursive</span> <span class="nv">on</span><span class="c1">;</span>
访问结果如下：
   <span class="mi">121</span>.<span class="mi">207</span>.<span class="mi">33</span>.<span class="mi">33</span>
使用<span class="nv">realip</span>获取
优点：程序不需要改动，直接使用<span class="nv">remote_addr</span>即可获取<span class="nv">IP</span>地址
缺点：<span class="nv">ip</span>地址有可能被伪装，而且需要知道所有<span class="nv">CDN</span>节点的<span class="nv">ip</span>地址或者<span class="nv">ip</span>段
或者 <span class="nv">set_real_ip_from</span> <span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">0</span><span class="o">/</span><span class="mi">0</span><span class="c1">; 待验证</span>
</pre></div>


<h2 id="_2">反向代理</h2>
<div class="codehilite"><pre><span></span><span class="nv">http</span> {
… …
<span class="nv">client_max_body_size</span> <span class="mi">300</span><span class="nv">m</span><span class="c1">;</span>
#允许客户端请求的最大单个文件字节数，它出现在请求头部的 <span class="nv">Content</span><span class="o">-</span><span class="nv">Length</span> 字段。 （可以更改此参数达到限制用户上传文件大小的目的）
<span class="nv">client_body_buffer_size</span> <span class="mi">128</span><span class="nv">k</span><span class="c1">;</span>
#这个指令可以指定连接请求使用的缓冲区大小，默认值：<span class="mi">8</span><span class="nv">k</span><span class="o">/</span><span class="mi">16</span><span class="nv">k</span> 。如果客户端请求一个文
件大于 <span class="mi">128</span><span class="nv">k</span>，则 <span class="nv">Nginx</span> 会尝试在硬盘上创建临时文件。如果硬盘满了，则会报错。
<span class="nv">client_body_temp_path</span> <span class="o">/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">shm</span><span class="o">/</span><span class="nv">client_body_temp</span><span class="c1">;</span>
#这个指令指定连接请求试图写入缓存文件的目录路径。
<span class="nv">proxy_connect_timeout</span> <span class="mi">600</span><span class="c1">;</span>
#跟后端服务器连接的超时时间，发起握手等候响应超时时间
<span class="nv">proxy_read_timeout</span> <span class="mi">600</span><span class="c1">;</span>
#默认值：<span class="nv">proxy_read_timeout</span> <span class="mi">60</span>。决定读取后端服务器应答的超时时间，它决定 <span class="nv">nginx</span> 将
等待多久时间来取得一个请求的应答。超时时间是指完成了两次握手后并且状态为 <span class="nv">established</span> 的超
时时间，而不是所有的应答时间。 相对于 <span class="nv">proxy_connect_timeout</span>，这个时间可以扑捉到一台将你
的连接放入连接池延迟处理并且没有数据传送的服务器，注意不要将此值设置太低，某些情况下代理
服务器将花很长的时间来获得页面应答 。如果被代理服务器在设置的时间内没有传递数据，<span class="nv">nginx</span>
将关闭连接。
<span class="nv">proxy_send_timeout</span> <span class="mi">600</span><span class="c1">;</span>
#设置代理服务器转发请求的超时时间，同样指完成两次握手后的时间，如果超过这个时间代
理服务器没有数据转发到后端服务器，<span class="nv">nginx</span> 将关闭连接。
<span class="nv">proxy_buffer_size</span> <span class="mi">16</span><span class="nv">k</span><span class="c1">;</span>
#默认值：<span class="nv">proxy_buffer_size</span> <span class="mi">4</span><span class="nv">k</span><span class="o">/</span><span class="mi">8</span><span class="nv">k</span> 。设置从后端服务器读取的第一部分应答的缓冲区大小，
通常情况下这部分应答中包含一个小的应答头。
<span class="nv">proxy_buffers</span> <span class="mi">4</span> <span class="mi">32</span><span class="nv">k</span><span class="c1">;</span>
#设置用于读取应答（来自后端服务器）的缓冲区数目和大小，告诉 <span class="nv">Nginx</span> 保存单个用的几个
<span class="nv">Buffer</span>，最大用多大空间
<span class="nv">proxy_busy_buffers_size</span> <span class="mi">64</span><span class="nv">k</span><span class="c1">;</span>
#如果系统很忙的时候可以申请更大的 <span class="nv">proxy_buffers</span>，官方推荐<span class="o">*</span><span class="mi">2</span>
<span class="nv">proxy_temp_file_write_size</span> <span class="mi">64</span><span class="nv">k</span><span class="c1">;</span>
#设置在写入 <span class="nv">proxy_temp_path</span> 时缓存临文件数据的大小，在预防一个工作进程在传递文件
时阻塞太长。
<span class="nv">proxy_temp_path</span> <span class="o">/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">shm</span><span class="o">/</span><span class="nv">proxy_temp</span><span class="c1">;</span>
#类似于 <span class="nv">http</span> 核心模块中的 <span class="nv">client_body_temp_path</span> 指令，指定一个目录来缓冲比较大的被
代理请求。
<span class="nv">upstream</span> <span class="nv">server_pool</span>  {
<span class="nv">server</span> <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">0</span>.<span class="mi">88</span>:<span class="mi">80</span> <span class="nv">weight</span><span class="o">=</span><span class="mi">4</span> <span class="nv">max_fails</span><span class="o">=</span><span class="mi">2</span> <span class="nv">fail_timeout</span><span class="o">=</span><span class="mi">30</span><span class="nv">s</span><span class="c1">;</span>
<span class="nv">server</span> <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">0</span>.<span class="mi">89</span>:<span class="mi">80</span> <span class="nv">weight</span><span class="o">=</span><span class="mi">2</span> <span class="nv">max_fails</span><span class="o">=</span><span class="mi">2</span> <span class="nv">fail_timeout</span><span class="o">=</span><span class="mi">30</span><span class="nv">s</span><span class="c1">;</span>
}
#<span class="nv">HTTP</span> 负载均衡模块。<span class="nv">upstream</span> 这个字段设置一群服务器，可以将这个字段放在
<span class="nv">proxy_pass</span> 和 <span class="nv">fastcgi_pass</span> 指令中作为一个单独的实体，它们可以是监听不同端口的服务器，并且
也可以是同时监听 <span class="nv">TCP</span>和 <span class="nv">Unix</span> <span class="nv">socket</span> 的服务器。 服务器可以指定不同的权重，默认为 <span class="mi">1</span>。

<span class="nv">location</span> <span class="o">/</span> {
<span class="nv">proxy_pass</span> <span class="nv">http</span>:<span class="o">//</span><span class="nv">server_pool</span><span class="o">/</span><span class="c1">;</span>
#确定需要代理的 <span class="nv">URL</span>，端口或 <span class="nv">socket</span>。
<span class="nv">proxy_redirect</span> <span class="nv">off</span><span class="c1">;</span>
#如果需要修改从后端服务器传来的应答头中的<span class="s2">&quot;</span><span class="s">Location</span><span class="s2">&quot;</span>和<span class="s2">&quot;</span><span class="s">Refresh</span><span class="s2">&quot;</span>字段，可以用这个指令
设置。
<span class="nv">proxy_set_header</span> <span class="nv">X</span><span class="o">-</span><span class="nv">Real</span><span class="o">-</span><span class="nv">IP</span> $<span class="nv">remote_addr</span><span class="c1">;</span>
#这个指令允许将发送到后端服务器的请求头重新定义或者增加一些字段。 这个值可以是一个
文本，变量或者它们的组合。
<span class="nv">proxy_set_header</span> <span class="nv">X</span><span class="o">-</span><span class="nv">Forwarded</span><span class="o">-</span><span class="k">For</span> $<span class="nv">proxy_add_x_forwarded_for</span><span class="c1">;</span>
<span class="nv">proxy_set_header</span> <span class="nv">Host</span> $<span class="nv">host</span><span class="c1">;</span>
<span class="nv">proxy_next_upstream</span> <span class="nv">error</span> <span class="nb">timeout</span> <span class="nv">invalid_header</span> <span class="nv">http_500</span> <span class="nv">http_502</span> <span class="nv">http_503</span>
<span class="nv">http_504</span> <span class="nv">http_404</span><span class="c1">;</span>
#确定在何种情况下请求将转发到下一个服务器：
#<span class="nv">error</span> <span class="o">-</span> 在连接到一个服务器，发送一个请求，或者读取应答时发生错误。
#<span class="nb">timeout</span> <span class="o">-</span> 在连接到服务器，转发请求或者读取应答时发生超时。
#<span class="nv">invalid_header</span> <span class="o">-</span> 服务器返回空的或者错误的应答。
#<span class="nv">http_500</span> <span class="o">-</span> 服务器返回 <span class="mi">500</span> 代码。
#<span class="nv">http_502</span> <span class="o">-</span> 服务器返回 <span class="mi">502</span> 代码。
#<span class="nv">http_503</span> <span class="o">-</span> 服务器返回 <span class="mi">503</span> 代码。
#<span class="nv">http_504</span> <span class="o">-</span> 服务器返回 <span class="mi">504</span> 代码。
#<span class="nv">http_404</span> <span class="o">-</span> 服务器返回 <span class="mi">404</span> 代码。
#<span class="nv">off</span> <span class="o">-</span> 禁止转发请求到下一台服务器。
}

<span class="nv">Nginx</span> 的 <span class="nv">upstream</span> 目前支持 <span class="mi">5</span> 种方式的分配
<span class="mi">1</span> 　轮询（默认）
每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器 <span class="nv">down</span> 掉，能自
动剔除。
<span class="mi">2</span> 　 <span class="nv">weight</span>
指定轮询几率， <span class="nv">weight</span> 和访问比率成正比，用于后端服务器性能不均的情况。
例如：
<span class="nv">upstream</span> <span class="nv">bakend</span> {
<span class="nv">server</span> <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">0</span>.<span class="mi">88</span> <span class="nv">weight</span><span class="o">=</span><span class="mi">10</span><span class="c1">;</span>
<span class="nv">server</span> <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">0</span>.<span class="mi">89</span> <span class="nv">weight</span><span class="o">=</span><span class="mi">10</span><span class="c1">;</span>
}
<span class="mi">3</span> 　 <span class="nv">ip_hash</span>
每个请求按访问 <span class="nv">ip</span> 的 <span class="nv">hash</span> 结果分配，这样每个访客固定访问一个后端服务器，可以
解决 <span class="nv">session</span> 的问题。
例如：
<span class="nv">upstream</span> <span class="nv">bakend</span> {
<span class="nv">ip_hash</span><span class="c1">;</span>
或者  <span class="nv">hash</span> $<span class="nv">http_x_forwarded_for</span><span class="c1">;  前面还有cdn</span>
<span class="nv">server</span> <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">0</span>.<span class="mi">88</span>:<span class="mi">80</span><span class="c1">;</span>
<span class="nv">server</span> <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">0</span>.<span class="mi">89</span>:<span class="mi">80</span><span class="c1">;</span>
}
<span class="mi">4</span> 　 <span class="nv">fair</span> （第三方）
按后端服务器的响应时间来分配请求，响应时间短的优先分配。
例如：
<span class="nv">upstream</span> <span class="nv">bakend</span> {
<span class="nv">server</span> <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">0</span>.<span class="mi">88</span>:<span class="mi">80</span><span class="c1">;</span>
<span class="nv">server</span> <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">0</span>.<span class="mi">89</span>:<span class="mi">80</span><span class="c1">;</span>
<span class="nv">fair</span><span class="c1">;</span>
}
<span class="mi">5</span> 　 <span class="nv">url_hash</span> （第三方）
按访问 <span class="nv">url</span> 的 <span class="nv">hash</span> 结果来分配请求，使每个 <span class="nv">url</span> 定向到同一个后端服务器，后端服务
器为缓存时比较有效。
例如：
<span class="nv">upstream</span> <span class="nv">backend</span> {
<span class="nv">server</span> <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">0</span>.<span class="mi">88</span>:<span class="mi">3128</span><span class="c1">;</span>
<span class="nv">server</span> <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">0</span>.<span class="mi">89</span>:<span class="mi">3128</span><span class="c1">;</span>
<span class="nv">hash</span> $<span class="nv">request_uri</span><span class="c1">;</span>
或者  <span class="nv">hash</span> $<span class="nv">http_x_forwarded_for</span><span class="c1">;  前面还有cdn</span>
#<span class="nv">hash_method</span> <span class="k">crc32</span><span class="c1">;</span>
}
每个设备的状态设置为 :
<span class="mi">1</span>. <span class="nv">down</span>  表示单前的 <span class="nv">server</span> 暂时不参与负载
<span class="mi">2</span>. <span class="nv">weight</span>  默认为 <span class="mi">1</span>.<span class="nv">weight</span> 越大，负载的权重就越大。
<span class="mi">3</span>. <span class="nv">max_fails</span>  ：允许请求失败的次数默认为 <span class="mi">1</span>. 当超过最大次数时，返回
<span class="nv">proxy_next_upstream</span>  模块定义的错误
<span class="mi">4</span>. <span class="nv">fail_timeout</span>:<span class="nv">max_fails</span> 次失败后，暂停的时间。
<span class="mi">5</span>. <span class="nv">backup</span> ： 其它所有的非 <span class="nv">backup</span> 机器 <span class="nv">down</span> 或者忙的时候，请求 <span class="nv">backup</span> 机器。
所以这台机器压力会最轻。
<span class="nv">Nginx</span> 支持同时设置多组的负载均衡，用来给不用的 <span class="nv">server</span> 来使用。
</pre></div>


<h2 id="proxy_pass">proxy_pass</h2>
<div class="codehilite"><pre><span></span>           <span class="nv">sub_filter</span> <span class="s1">&#39;</span><span class="s">www_servers:80/DaChui/</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">www.xxx.com/</span><span class="s1">&#39;</span><span class="c1">;</span>
           <span class="nv">sub_filter</span> <span class="s1">&#39;</span><span class="s">http://www_servers:80/DaChui/</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">http://www.xxx.com/</span><span class="s1">&#39;</span><span class="c1">;</span>
           <span class="nv">sub_filter</span> <span class="s1">&#39;</span><span class="s">http://www_servers/DaChui/</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">http://www.xxx.com/</span><span class="s1">&#39;</span><span class="c1">;</span>
           <span class="nv">sub_filter_once</span> <span class="nv">off</span><span class="c1">;</span>

在<span class="nv">nginx</span>中配置<span class="nv">proxy_pass</span>代理转发时，如果在<span class="nv">proxy_pass</span>后面的<span class="nv">url</span>加<span class="o">/</span>，表示绝对根路径；如果没有<span class="o">/</span>，表示相对路径，
把匹配的路径部分也给代理走。

代理非<span class="mi">80</span>端口问题 需要添加 <span class="nv">proxy_set_header</span> <span class="nv">Host</span> $<span class="nv">host</span>:$<span class="nv">server_port</span>
<span class="nv">upstream</span> <span class="nv">falcon</span> {
        <span class="nv">server</span> <span class="mi">172</span>.<span class="mi">31</span>.<span class="mi">20</span>.<span class="mi">205</span>:<span class="mi">8010</span><span class="c1">;</span>
}
<span class="nv">location</span> <span class="o">/</span> {
            <span class="nv">proxy_pass</span> <span class="nv">http</span>:<span class="o">//</span><span class="nv">falcon</span><span class="o">/</span><span class="c1">;</span>
            <span class="nv">proxy_set_header</span> <span class="nv">Host</span> $<span class="nv">host</span>:$<span class="nv">server_port</span><span class="c1">;</span>
            <span class="nv">proxy_set_header</span> <span class="nv">X</span><span class="o">-</span><span class="nv">Real</span><span class="o">-</span><span class="nv">IP</span> $<span class="nv">remote_addr</span><span class="c1">;</span>
            <span class="nv">proxy_set_header</span> <span class="nv">X</span><span class="o">-</span><span class="nv">Forwarded</span><span class="o">-</span><span class="k">For</span> $<span class="nv">proxy_add_x_forwarded_for</span><span class="c1">;</span>
        }

假设下面四种情况分别用 <span class="nv">http</span>:<span class="o">//</span><span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">1</span>.<span class="mi">1</span><span class="o">/</span><span class="nv">proxy</span><span class="o">/</span><span class="nv">test</span>.<span class="nv">html</span> 进行访问。


第一种：
<span class="nv">location</span> <span class="o">/</span><span class="nv">proxy</span><span class="o">/</span> {
    <span class="nv">proxy_pass</span> <span class="nv">http</span>:<span class="o">//</span><span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span><span class="o">/</span><span class="c1">;</span>
}
代理到<span class="nv">URL</span>：<span class="nv">http</span>:<span class="o">//</span><span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span><span class="o">/</span><span class="nv">test</span>.<span class="nv">html</span>


第二种（相对于第一种，最后少一个 <span class="o">/</span> ）
<span class="nv">location</span> <span class="o">/</span><span class="nv">proxy</span><span class="o">/</span> {
    <span class="nv">proxy_pass</span> <span class="nv">http</span>:<span class="o">//</span><span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span><span class="c1">;</span>
}
代理到<span class="nv">URL</span>：<span class="nv">http</span>:<span class="o">//</span><span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span><span class="o">/</span><span class="nv">proxy</span><span class="o">/</span><span class="nv">test</span>.<span class="nv">html</span>


第三种：
<span class="nv">location</span> <span class="o">/</span><span class="nv">proxy</span><span class="o">/</span> {
    <span class="nv">proxy_pass</span> <span class="nv">http</span>:<span class="o">//</span><span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span><span class="o">/</span><span class="nv">aaa</span><span class="o">/</span><span class="c1">;</span>
}
代理到<span class="nv">URL</span>：<span class="nv">http</span>:<span class="o">//</span><span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span><span class="o">/</span><span class="nv">aaa</span><span class="o">/</span><span class="nv">test</span>.<span class="nv">html</span>


第四种（相对于第三种，最后少一个 <span class="o">/</span> ）
<span class="nv">location</span> <span class="o">/</span><span class="nv">proxy</span><span class="o">/</span> {
    <span class="nv">proxy_pass</span> <span class="nv">http</span>:<span class="o">//</span><span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span><span class="o">/</span><span class="nv">aaa</span><span class="c1">;</span>
}
代理到<span class="nv">URL</span>：<span class="nv">http</span>:<span class="o">//</span><span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span><span class="o">/</span><span class="nv">aaatest</span>.<span class="nv">html</span>
</pre></div>


<h2 id="_3">用户认证</h2>
<div class="codehilite"><pre><span></span><span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">nginx</span><span class="o">/</span><span class="nt">conf</span><span class="p">.</span><span class="nc">d</span><span class="o">/</span><span class="nt">default</span><span class="p">.</span><span class="nc">conf</span>
<span class="nt">location</span> <span class="o">/</span><span class="nt">logio</span> <span class="p">{</span>
        <span class="err">proxy_pass</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168.1.2</span><span class="o">:</span><span class="mi">28778</span><span class="o">/</span><span class="p">;</span>
        <span class="err">auth_basic</span> <span class="err">&quot;secret&quot;</span><span class="p">;</span>
        <span class="err">auth_basic_user_file</span> <span class="err">/etc/nginx/passwd.db</span><span class="p">;</span>
    <span class="p">}</span>
<span class="err">语法</span><span class="o">:</span>     <span class="nt">auth_basic</span> <span class="nt">string</span> <span class="o">|</span> <span class="nt">off</span><span class="o">;</span>
<span class="err">默认值</span><span class="o">:</span>     <span class="nt">auth_basic</span> <span class="nt">off</span><span class="o">;</span>
<span class="err">配置段</span><span class="o">:</span>     <span class="nt">http</span><span class="o">,</span> <span class="nt">server</span><span class="o">,</span> <span class="nt">location</span><span class="o">,</span> <span class="nt">limit_except</span>
<span class="err">默认表示不开启认证，后面如果跟上字符，这些字符会在弹窗中显示。</span>
<span class="err">语法</span><span class="o">:</span>     <span class="nt">auth_basic_user_file</span> <span class="nt">file</span><span class="o">;</span>
<span class="err">默认值</span><span class="o">:</span>     <span class="err">—</span>
<span class="err">配置段</span><span class="o">:</span>     <span class="nt">http</span><span class="o">,</span> <span class="nt">server</span><span class="o">,</span> <span class="nt">location</span><span class="o">,</span> <span class="nt">limit_except</span>

<span class="nt">htpasswd</span> <span class="nt">-c</span> <span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">nginx</span><span class="o">/</span><span class="nt">passwd</span><span class="p">.</span><span class="nc">db</span> <span class="nt">admin</span>   <span class="err">用户密码文件</span>
<span class="nt">chmod</span> <span class="nt">400</span> <span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">nginx</span><span class="o">/</span><span class="nt">passwd</span><span class="p">.</span><span class="nc">db</span>
<span class="nt">chown</span> <span class="nt">nginx</span><span class="p">.</span><span class="nc">nginx</span> <span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">nginx</span><span class="o">/</span><span class="nt">passwd</span><span class="p">.</span><span class="nc">db</span>

<span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">init</span><span class="p">.</span><span class="nc">d</span><span class="o">/</span><span class="nt">nginx</span> <span class="nt">reload</span>
</pre></div>


<h2 id="rootalias">root和alias</h2>
<div class="codehilite"><pre><span></span><span class="k">location</span> <span class="o">/</span><span class="n">img</span><span class="o">/</span> <span class="err">{</span>
    <span class="k">alias</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">image</span><span class="o">/</span><span class="p">;</span>
<span class="err">}</span>
<span class="o">#</span><span class="err">若按照上述配置的话，则访问</span><span class="o">/</span><span class="n">img</span><span class="o">/</span><span class="err">目录里面的文件时，</span><span class="n">ningx</span><span class="err">会自动去</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">image</span><span class="o">/</span><span class="err">目录找文件</span>

<span class="k">location</span> <span class="o">/</span><span class="n">img</span><span class="o">/</span> <span class="err">{</span>
    <span class="n">root</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">image</span><span class="p">;</span>
<span class="err">}</span>
<span class="o">#</span><span class="err">若按照这种配置的话，则访问</span><span class="o">/</span><span class="n">img</span><span class="o">/</span><span class="err">目录下的文件时，</span><span class="n">nginx</span><span class="err">会去</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">image</span><span class="o">/</span><span class="n">img</span><span class="o">/</span><span class="err">目录下找文件</span>

<span class="k">alias</span><span class="err">是一个目录别名的定义，</span><span class="n">root</span><span class="err">则是最上层目录的定义。</span>

<span class="err">还有一个重要的区别是</span><span class="k">alias</span><span class="err">后面必须要用“</span><span class="o">/</span><span class="err">”结束，否则会找不到文件的</span>   <span class="err">而</span><span class="n">root</span><span class="err">则可有可无</span>
</pre></div>


<h2 id="nginx_1">nginx限速</h2>
<div class="codehilite"><pre><span></span><span class="err">在</span><span class="nt">nginx</span><span class="p">.</span><span class="nc">conf</span><span class="err">的</span><span class="nt">http</span><span class="p">{}</span><span class="err">添加</span>
<span class="p">#</span><span class="nn">ip</span> <span class="nt">limit</span>
<span class="nt">limit_conn_zone</span> <span class="o">$</span><span class="nt">binary_remote_addr</span> <span class="nt">zone</span><span class="o">=</span><span class="nt">perip</span><span class="p">:</span><span class="nd">10m</span><span class="o">;</span>
<span class="nt">limit_conn_zone</span> <span class="o">$</span><span class="nt">server_name</span> <span class="nt">zone</span><span class="o">=</span><span class="nt">perserver</span><span class="p">:</span><span class="nd">10m</span><span class="o">;</span>
<span class="err">然后在</span><span class="nt">location</span><span class="err">里写</span>

<span class="nt">location</span> <span class="o">/</span> <span class="p">{</span>
  <span class="err">limit_conn</span> <span class="err">perip</span> <span class="err">2</span><span class="p">;</span>
  <span class="err">limit_conn</span> <span class="err">perserver</span> <span class="err">20</span><span class="p">;</span>
  <span class="err">limit_rate</span> <span class="err">100k</span><span class="p">;</span>
<span class="p">}</span>

<span class="err">补充说明下参数：</span>
<span class="o">$</span><span class="nt">binary_remote_addr</span><span class="err">是限制同一客户端</span><span class="nt">ip</span><span class="err">地址；</span>
<span class="o">$</span><span class="nt">server_name</span><span class="err">是限制同一</span><span class="nt">server</span><span class="err">最大并发数；</span>
<span class="nt">limit_conn</span><span class="err">为限制并发连接数；</span>
<span class="nt">limit_rate</span><span class="err">为限制下载速度；</span>

<span class="nt">nginx</span> <span class="nt">1</span><span class="p">.</span><span class="nc">1</span><span class="p">.</span><span class="nc">8</span> <span class="err">之后的版本的语法改为</span><span class="nt">limit_conn_zone</span> <span class="o">$</span><span class="nt">binary_remote_addr</span> <span class="nt">zone</span><span class="o">=</span><span class="nt">NAME</span><span class="p">:</span><span class="nd">10m</span><span class="o">;</span>

<span class="nt">NAME</span> <span class="err">就是</span> <span class="nt">zone</span> <span class="err">的名字详情请看这里</span> <span class="nt">http</span><span class="o">://</span><span class="nt">nginx</span><span class="p">.</span><span class="nc">org</span><span class="o">/</span><span class="nt">en</span><span class="o">/</span><span class="nt">docs</span><span class="o">/</span><span class="nt">http</span><span class="o">/</span><span class="nt">ngx_http_limit_conn_module</span><span class="p">.</span><span class="nc">html</span>



<span class="err">限制连接数</span><span class="o">:</span>

<span class="err">要限制连接，必须先有一个容器对连接进行计数，在</span><span class="nt">http</span><span class="err">段加入如下代码：</span>

<span class="s2">&quot;zone=&quot;</span> <span class="err">给它一个名字，可以随便叫，这个名字要跟下面的</span> <span class="nt">limit_conn</span> <span class="err">一致</span>

<span class="o">$</span><span class="nt">binary_remote_addr</span> <span class="o">=</span> <span class="err">用二进制来储存客户端的地址，</span><span class="nt">1m</span> <span class="err">可以储存</span> <span class="nt">32000</span> <span class="err">个并发会话</span>



<span class="o">...</span> <span class="err">省掉</span> <span class="nt">N</span> <span class="err">字</span>

<span class="nt">http</span>

<span class="p">{</span>

<span class="err">limit_conn_zone</span> <span class="err">$binary_remote_addr</span> <span class="err">zone=</span><span class="n">addr</span><span class="p">:</span><span class="mi">10</span><span class="n">m</span><span class="p">;</span>



<span class="err">接下来需要对server不同的位置（location段）进行限速，比如限制每个IP并发连接数为1，则</span>

<span class="err">server</span>

<span class="err">{</span>

<span class="err">listen</span> <span class="err">80</span><span class="p">;</span>

<span class="err">server_name</span> <span class="err">192.168.11.128</span><span class="p">;</span>

<span class="err">index</span> <span class="err">index.html</span> <span class="err">index.htm</span> <span class="err">index.php</span><span class="p">;</span>

<span class="err">limit_conn</span> <span class="err">addr</span> <span class="err">1</span><span class="p">;</span> <span class="err">#是限制每个IP只能发起1个连接</span> <span class="err">（addr</span> <span class="err">要跟</span> <span class="err">limit_conn_zone</span> <span class="err">的变量对应）</span>

<span class="err">limit_rate</span> <span class="err">100k</span><span class="p">;</span> <span class="err">#限速为</span> <span class="err">100KB/秒</span>

<span class="err">root</span> <span class="err">html</span><span class="p">;</span>



<span class="err">注意事项：</span>

<span class="err">limit_rate</span> <span class="err">100k</span><span class="p">;</span> <span class="err">//是对每个连接限速100k。这里是对连接限速，而不是对IP限速！如果一个IP允许两个并发连接，</span>
<span class="err">那么这个IP就是限速limit_rate</span> <span class="err">*</span> <span class="err">2</span>
</pre></div>


<h2 id="nginx_2">压测 nginx性能调优</h2>
<div class="codehilite"><pre><span></span>这边有个性能要求极高的<span class="nv">api</span>要上线，这个服务端是<span class="nv">golang</span> <span class="nv">http</span>模块实现的。在上线之前我们理所当然的要做压力测试。
起初是 “小白同学” 起头进行压力测试，但当我看到那压力测试的结果时，我也是逗乐了。   现象是，直接访问
<span class="nv">Golang</span> <span class="nv">http</span> <span class="nv">api</span>是每秒可以到<span class="mi">3</span>.<span class="mi">5</span><span class="nv">W</span>的访问,  为了理论承受更强的<span class="nv">QPS</span>，多开了几个<span class="nv">go</span> <span class="nv">http</span> <span class="nv">api</span>进程端口，又在这前面
加了层<span class="nv">nginx</span>负载均衡，结果往<span class="nv">nginx</span>压测的结果是每秒才可以解决<span class="mi">1</span>.<span class="mi">5</span><span class="nv">w</span>的访问量。 这结果让高级黑 “小白” 把<span class="nv">nginx</span>又给鄙视了。 

     虽然哥平时开发任务很饱和，又因为带几个新人的原因，有点心累。 但哥还是抽出宝贵的时间来解决<span class="nv">nginx</span>在压力测试下性能上
     不去的问题。 哈哈，这里肯定有人要打我了。  说实话，做运维虽然能时常碰一些负载均衡调度器，但由于很多时候配置都
     标准化了，新开一个业务线，把配置一<span class="nv">scp</span>，然后选择性的修改域名及<span class="nv">location</span>就可以了，还真是没遇到过这次的问题。 



我们在寻找性能瓶颈的是时候，会频繁的使用后面的工具进行监控，推荐大家使用<span class="nv">tmux</span>或者<span class="nv">screen</span>开启多个终端监控，用<span class="nv">top</span>可以看到
<span class="nv">nginx</span>及<span class="nv">go</span> <span class="nv">api</span>的<span class="nv">cpu</span>占用率，<span class="nv">load</span>值，<span class="nv">run</span>数，各个<span class="nv">cpu</span>核心的百分比，处理网络的中断。用<span class="nv">dstat</span>可以看到流量及上下文切换的测试。
  <span class="nv">ss</span> <span class="o">+</span> <span class="nv">netstat</span> 查看连接数。



首先是压力测试的方法问题



以前做运维的时候，我们一般不会用简单的<span class="nv">ab</span>来进行压测，这样会造成压力源过热的情况，正常的针对服务端测试的方法是，分布式压力测试，
一个主机压测的结果很是不准，当然前提是 服务端的性能够高，别尼玛整个<span class="nv">python</span> <span class="nv">django</span>就用分布式压测，随便找个<span class="nv">webbench</span>,<span class="nv">ab</span> , 
<span class="nv">boom</span>这类的<span class="nv">http</span>压测就可以了。 



    关于客户端压测过热的情况有几个元素，最主要的元素是端口占用情况。首先我们需要明确几个点, 作为服务端只是消耗<span class="nv">fd</span>而已，
    但是客户端是需要占用端口来发起请求。 如果你自己同时作为服务端和客户端，会被受限于<span class="mi">65535</span><span class="o">-</span><span class="mi">1024</span>的限制，<span class="mi">1024</span>内一般是
    常规的系统保留端口。   如果你按照<span class="mi">65535</span><span class="o">-</span><span class="mi">1024</span>计算的话，你可以占用<span class="mi">64511</span>端口数，但如果你是自己压力测试<span class="nv">nginx</span>，然后
    <span class="nv">nginx</span>又反向代理几个<span class="nv">golang</span> <span class="nv">http</span> <span class="nv">api</span>。  那么这端口被严重的缩水了。   当你压测的数目才<span class="mi">6</span><span class="nv">w</span>以上，很明显报错，
    不想报错，那么只能进行排队阻塞，好让客户端完成该请求。 



另外一点是<span class="nv">nginx</span> 配置问题。

   这一点很重要，也是最基本的要求，如果<span class="nv">nginx</span> <span class="nv">worker</span>连接数过少的化，你的请求连接就算没有被阻塞到<span class="nv">backlog</span>队列外，
   <span class="nv">nginx</span> <span class="nv">worker</span>也会因为过载保护不会处理新的请求。<span class="nv">nginx</span>的最大连接数是<span class="nv">worker</span> <span class="nv">num</span> <span class="o">*</span><span class="nv">worker_connections</span>, 
   默认<span class="nv">worker_connections</span>是<span class="mi">1024</span>, 直接干到<span class="mi">10</span><span class="nv">w</span>就可以了。



在我们配置调整之后，访问的速度有明显的提升，但还是没有达到我们的预期。 接着通过<span class="nv">lsof</span>追了下进程，发现<span class="nv">nginx</span> 跟 
后端创建了大量的连接。  这很明显是没有使用<span class="nv">http1</span>.<span class="mi">1</span>长连接导致的，使用<span class="nv">tcpdump</span>抓包分析了下，果然是<span class="nv">http1</span>.<span class="mi">0</span>短链接，
虽然我们在<span class="nv">sysctl</span>内核里做了一些网络<span class="nv">tcp</span>回收的优化，但那也赶不上压力测试带来的频繁创建<span class="nv">tcp</span>的消耗。   果然在<span class="nv">upstream</span>加了<span class="nv">keepalive</span>。



<span class="nv">COMMAND</span>     <span class="nv">PID</span>        <span class="nv">USER</span>   <span class="nv">FD</span>   <span class="nv">TYPE</span>    <span class="nv">DEVICE</span> <span class="nv">SIZE</span><span class="o">/</span><span class="nv">OFF</span> <span class="nv">NODE</span> <span class="nv">NAME</span>
<span class="nv">python</span>      <span class="mi">538</span> <span class="nv">ruifengyun</span>    <span class="mi">9</span><span class="nv">u</span>  <span class="nv">IPv4</span> <span class="mi">595559383</span>      <span class="mi">0</span><span class="nv">t0</span>  <span class="nv">TCP</span> <span class="mi">58</span>.<span class="mi">215</span>.<span class="mi">141</span>.<span class="mi">194</span>:<span class="mi">46665</span><span class="o">-&gt;</span><span class="mi">58</span>.<span class="mi">215</span>.<span class="mi">141</span>.<span class="mi">83</span>:<span class="mi">9001</span> <span class="ss">(</span><span class="nv">ESTABLISHED</span><span class="ss">)</span>
<span class="nv">test_dic4</span>  <span class="mi">7476</span> <span class="nv">ruifengyun</span>    <span class="mi">5</span><span class="nv">u</span>  <span class="nv">IPv6</span> <span class="mi">660251515</span>      <span class="mi">0</span><span class="nv">t0</span>  <span class="nv">TCP</span> <span class="o">*</span>:<span class="mi">9001</span> <span class="ss">(</span><span class="nv">LISTEN</span><span class="ss">)</span>
<span class="nv">test_dic4</span>  <span class="mi">7476</span> <span class="nv">ruifengyun</span>   <span class="mi">10</span><span class="nv">u</span>  <span class="nv">IPv6</span> <span class="mi">660870187</span>      <span class="mi">0</span><span class="nv">t0</span>  <span class="nv">TCP</span> <span class="nv">localhost</span>:<span class="mi">9001</span><span class="o">-&gt;</span><span class="nv">localhost</span>:<span class="mi">46679</span> <span class="ss">(</span><span class="nv">ESTABLISHED</span><span class="ss">)</span>
<span class="nv">test_dic4</span>  <span class="mi">7476</span> <span class="nv">ruifengyun</span>   <span class="mi">13</span><span class="nv">u</span>  <span class="nv">IPv6</span> <span class="mi">660870138</span>      <span class="mi">0</span><span class="nv">t0</span>  <span class="nv">TCP</span> <span class="nv">localhost</span>:<span class="mi">9001</span><span class="o">-&gt;</span><span class="nv">localhost</span>:<span class="mi">46608</span> <span class="ss">(</span><span class="nv">ESTABLISHED</span><span class="ss">)</span>
<span class="nv">test_dic4</span>  <span class="mi">7476</span> <span class="nv">ruifengyun</span>   <span class="mi">14</span><span class="nv">u</span>  <span class="nv">IPv6</span> <span class="mi">660870137</span>      <span class="mi">0</span><span class="nv">t0</span>  <span class="nv">TCP</span> <span class="nv">localhost</span>:<span class="mi">9001</span><span class="o">-&gt;</span><span class="nv">localhost</span>:<span class="mi">46607</span> <span class="ss">(</span><span class="nv">ESTABLISHED</span><span class="ss">)</span>
<span class="nv">test_dic4</span>  <span class="mi">7476</span> <span class="nv">ruifengyun</span>   <span class="mi">22</span><span class="nv">u</span>  <span class="nv">IPv6</span> <span class="mi">660870153</span>      <span class="mi">0</span><span class="nv">t0</span>  <span class="nv">TCP</span> <span class="nv">localhost</span>:<span class="mi">9001</span><span class="o">-&gt;</span><span class="nv">localhost</span>:<span class="mi">46632</span> <span class="ss">(</span><span class="nv">ESTABLISHED</span><span class="ss">)</span>
<span class="nv">test_dic4</span>  <span class="mi">7476</span> <span class="nv">ruifengyun</span>   <span class="mi">23</span><span class="nv">u</span>  <span class="nv">IPv6</span> <span class="mi">660870143</span>      <span class="mi">0</span><span class="nv">t0</span>  <span class="nv">TCP</span> <span class="nv">localhost</span>:<span class="mi">9001</span><span class="o">-&gt;</span><span class="nv">localhost</span>:<span class="mi">46618</span> <span class="ss">(</span><span class="nv">ESTABLISHED</span><span class="ss">)</span>
<span class="nv">test_dic4</span>  <span class="mi">7476</span> <span class="nv">ruifengyun</span>   <span class="mi">27</span><span class="nv">u</span>  <span class="nv">IPv6</span> <span class="mi">660870166</span>      <span class="mi">0</span><span class="nv">t0</span>  <span class="nv">TCP</span> <span class="nv">localhost</span>:<span class="mi">9001</span><span class="o">-&gt;</span><span class="nv">localhost</span>:<span class="mi">46654</span> <span class="ss">(</span><span class="nv">ESTABLISHED</span><span class="ss">)</span>
<span class="nv">test_dic4</span>  <span class="mi">7476</span> <span class="nv">ruifengyun</span>   <span class="mi">73</span><span class="nv">u</span>  <span class="nv">IPv6</span> <span class="mi">660870191</span>      <span class="mi">0</span><span class="nv">t0</span>  <span class="nv">TCP</span> <span class="nv">localhost</span>:<span class="mi">9001</span><span class="o">-&gt;</span><span class="nv">localhost</span>:<span class="mi">46685</span> <span class="ss">(</span><span class="nv">ESTABLISHED</span><span class="ss">)</span>
<span class="nv">test_dic4</span>  <span class="mi">7476</span> <span class="nv">ruifengyun</span>   <span class="mi">85</span><span class="nv">u</span>  <span class="nv">IPv6</span> <span class="mi">660870154</span>      <span class="mi">0</span><span class="nv">t0</span>  <span class="nv">TCP</span> <span class="nv">localhost</span>:<span class="mi">9001</span><span class="o">-&gt;</span><span class="nv">localhost</span>:<span class="mi">46633</span> <span class="ss">(</span><span class="nv">ESTABLISHED</span><span class="ss">)</span>
<span class="nv">test_dic4</span>  <span class="mi">7476</span> <span class="nv">ruifengyun</span>   <span class="mi">87</span><span class="nv">u</span>  <span class="nv">IPv6</span> <span class="mi">660870147</span>      <span class="mi">0</span><span class="nv">t0</span>  <span class="nv">TCP</span> <span class="nv">localhost</span>:<span class="mi">9001</span><span class="o">-&gt;</span><span class="nv">localhost</span>:<span class="mi">46625</span> <span class="ss">(</span><span class="nv">ESTABLISHED</span><span class="ss">)</span>
....






摘录官方文档的说明如下。该参数开启与上游服务器之间的连接池，其数值为每个<span class="nv">nginx</span> <span class="nv">worker</span>可以保持的最大连接数，
默认不设置，即<span class="nv">nginx</span>作为客户端时<span class="nv">keepalive</span>未生效。

<span class="nv">Activates</span> <span class="nv">cache</span> <span class="nv">of</span> <span class="nv">connections</span> <span class="nv">to</span> <span class="nv">upstream</span> <span class="nv">servers</span>

<span class="nv">The</span> <span class="nv">connections</span> <span class="nv">parameter</span> <span class="nv">sets</span> <span class="nv">the</span> <span class="nv">maximum</span> <span class="nv">number</span> <span class="nv">of</span> <span class="nv">idle</span> <span class="nv">keepalive</span> <span class="nv">connections</span> <span class="nv">to</span> <span class="nv">upstream</span> <span class="nv">servers</span> 
<span class="nv">that</span> <span class="nv">are</span> <span class="nv">retained</span> <span class="nv">in</span> <span class="nv">the</span> <span class="nv">cache</span> <span class="nv">per</span> <span class="nv">one</span> <span class="nv">worker</span> <span class="nv">process</span>. <span class="nv">When</span> <span class="nv">this</span> <span class="nv">number</span> <span class="nv">is</span> <span class="nv">exceeded</span>, <span class="nv">the</span> <span class="nv">least</span> <span class="nv">recently</span> 
<span class="nv">used</span> <span class="nv">connections</span> <span class="nv">are</span> <span class="nv">closed</span>

<span class="nv">Python</span>


# <span class="nv">xiaorui</span>.<span class="nv">cc</span>
<span class="nv">upstream</span> <span class="nv">http_backend</span> {
    <span class="nv">server</span> <span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span>:<span class="mi">8080</span><span class="c1">;</span>

    <span class="nv">keepalive</span> <span class="mi">256</span><span class="c1">;</span>
}
<span class="nv">server</span> {
    ...

    <span class="nv">location</span> <span class="o">/</span><span class="nv">http</span><span class="o">/</span> {
        <span class="nv">proxy_pass</span> <span class="nv">http</span>:<span class="o">//</span><span class="nv">http_backend</span><span class="c1">;</span>
        <span class="nv">proxy_http_version</span> <span class="mi">1</span>.<span class="mi">1</span><span class="c1">;</span>
        <span class="nv">proxy_set_header</span> <span class="nv">Connection</span> <span class="s2">&quot;&quot;</span><span class="c1">;</span>
        ...
    }
}



继续进行压力测试，返现这访问量还是那样，没有什么提升，通过排除问题确认又是连接数大引起的，这长连接不生效呀。 
以前我在线上也是这么调配的，应该没问题。  最后通过<span class="nv">nginx</span> <span class="nv">error</span> <span class="nv">log</span>找到了原因。  这<span class="nv">Nginx</span>版本居然不支持<span class="nv">keepalive</span> 
长连接，没招，换个版本再次测试。




<span class="nv">Python</span>



<span class="mi">2016</span><span class="o">/</span><span class="mi">06</span><span class="o">/</span><span class="mi">24</span> <span class="mi">16</span>:<span class="mi">34</span>:<span class="mi">12</span> [<span class="nv">error</span>] <span class="mi">15419</span><span class="sc">#0</span>: <span class="o">*</span><span class="mi">9421660</span> <span class="k">connect</span><span class="ss">()</span> <span class="nv">failed</span> <span class="ss">(</span><span class="mi">111</span>: <span class="nv">Connection</span> <span class="nv">refused</span><span class="ss">)</span> <span class="k">while</span> <span class="nv">connecting</span> 
<span class="nv">to</span> <span class="nv">upstream</span>, <span class="nv">client</span>: <span class="mi">10</span>.<span class="mi">1</span>.<span class="mi">1</span>.<span class="mi">58</span>, <span class="nv">server</span>: , <span class="nv">request</span>: <span class="s2">&quot;</span><span class="s">GET / HTTP/1.0</span><span class="s2">&quot;</span>, <span class="nv">upstream</span>: <span class="s2">&quot;</span><span class="s">http://127.0.0.1:9001/</span><span class="s2">&quot;</span>, 
<span class="nv">host</span>: <span class="s2">&quot;</span><span class="s">10.1.1.63</span><span class="s2">&quot;</span>
<span class="mi">2016</span><span class="o">/</span><span class="mi">06</span><span class="o">/</span><span class="mi">24</span> <span class="mi">16</span>:<span class="mi">34</span>:<span class="mi">12</span> [<span class="nv">error</span>] <span class="mi">15418</span><span class="sc">#0</span>: <span class="o">*</span><span class="mi">9423639</span> <span class="k">connect</span><span class="ss">()</span> <span class="nv">failed</span> <span class="ss">(</span><span class="mi">111</span>: <span class="nv">Connection</span> <span class="nv">refused</span><span class="ss">)</span> <span class="k">while</span> <span class="nv">connecting</span>
 <span class="nv">to</span> <span class="nv">upstream</span>, <span class="nv">client</span>: <span class="mi">10</span>.<span class="mi">1</span>.<span class="mi">1</span>.<span class="mi">58</span>, <span class="nv">server</span>: , <span class="nv">request</span>: <span class="s2">&quot;</span><span class="s">GET / HTTP/1.0</span><span class="s2">&quot;</span>, <span class="nv">upstream</span>: <span class="s2">&quot;</span><span class="s">http://127.0.0.1:9004/</span><span class="s2">&quot;</span>, 
 <span class="nv">host</span>: <span class="s2">&quot;</span><span class="s">10.1.1.63</span><span class="s2">&quot;</span>
<span class="mi">2016</span><span class="o">/</span><span class="mi">06</span><span class="o">/</span><span class="mi">24</span> <span class="mi">16</span>:<span class="mi">34</span>:<span class="mi">12</span> [<span class="nv">error</span>] <span class="mi">15418</span><span class="sc">#0</span>: <span class="o">*</span><span class="mi">9423639</span> <span class="nv">no</span> <span class="nv">live</span> <span class="nv">upstreams</span> <span class="k">while</span> <span class="nv">connecting</span> <span class="nv">to</span> <span class="nv">upstream</span>, <span class="nv">client</span>: 
<span class="mi">10</span>.<span class="mi">1</span>.<span class="mi">1</span>.<span class="mi">58</span>, <span class="nv">server</span>: , <span class="nv">request</span>: <span class="s2">&quot;</span><span class="s">GET / HTTP/1.0</span><span class="s2">&quot;</span>, <span class="nv">upstream</span>: <span class="s2">&quot;</span><span class="s">http://test_servers/</span><span class="s2">&quot;</span>, <span class="nv">host</span>: <span class="s2">&quot;</span><span class="s">10.1.1.63</span><span class="s2">&quot;</span>
<span class="mi">2016</span><span class="o">/</span><span class="mi">06</span><span class="o">/</span><span class="mi">24</span> <span class="mi">16</span>:<span class="mi">34</span>:<span class="mi">12</span> [<span class="nv">error</span>] <span class="mi">15418</span><span class="sc">#0</span>: <span class="o">*</span><span class="mi">9393899</span> <span class="k">connect</span><span class="ss">()</span> <span class="nv">failed</span> <span class="ss">(</span><span class="mi">111</span>: <span class="nv">Connection</span> <span class="nv">refused</span><span class="ss">)</span> <span class="k">while</span> <span class="nv">connecting</span>
 <span class="nv">to</span> <span class="nv">upstream</span>, <span class="nv">client</span>: <span class="mi">10</span>.<span class="mi">1</span>.<span class="mi">1</span>.<span class="mi">58</span>, <span class="nv">server</span>: , <span class="nv">request</span>: <span class="s2">&quot;</span><span class="s">GET / HTTP/1.0</span><span class="s2">&quot;</span>, <span class="nv">upstream</span>: <span class="s2">&quot;</span><span class="s">http://127.0.0.1:9004/</span><span class="s2">&quot;</span>,
  <span class="nv">host</span>: <span class="s2">&quot;</span><span class="s">10.1.1.63</span><span class="s2">&quot;</span>

<span class="mi">2016</span><span class="o">/</span><span class="mi">06</span><span class="o">/</span><span class="mi">24</span> <span class="mi">16</span>:<span class="mi">58</span>:<span class="mi">13</span> [<span class="nv">notice</span>] <span class="mi">26449</span><span class="sc">#26449</span>: <span class="nv">signal</span> <span class="nv">process</span> <span class="nv">started</span>
<span class="mi">2016</span><span class="o">/</span><span class="mi">06</span><span class="o">/</span><span class="mi">24</span> <span class="mi">16</span>:<span class="mi">58</span>:<span class="mi">13</span> [<span class="nv">emerg</span>] <span class="mi">27280</span><span class="sc">#0</span>: <span class="nv">unknown</span> <span class="nv">directive</span> <span class="s2">&quot;</span><span class="s">keepalive</span><span class="s2">&quot;</span> <span class="nv">in</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">nginx</span><span class="o">/</span><span class="nv">conf</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">test_multi</span>.<span class="nv">conf</span>:<span class="mi">7</span>
<span class="mi">2016</span><span class="o">/</span><span class="mi">06</span><span class="o">/</span><span class="mi">24</span> <span class="mi">17</span>:<span class="mi">02</span>:<span class="mi">18</span> [<span class="nv">notice</span>] <span class="mi">3141</span><span class="sc">#3141</span>: <span class="nv">signal</span> <span class="nv">process</span> <span class="nv">started</span>
<span class="mi">2016</span><span class="o">/</span><span class="mi">06</span><span class="o">/</span><span class="mi">24</span> <span class="mi">17</span>:<span class="mi">02</span>:<span class="mi">18</span> [<span class="nv">emerg</span>] <span class="mi">27280</span><span class="sc">#0</span>: <span class="nv">unknown</span> <span class="nv">directive</span> <span class="s2">&quot;</span><span class="s">keepalive</span><span class="s2">&quot;</span> <span class="nv">in</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">nginx</span><span class="o">/</span><span class="nv">conf</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">test_multi</span>.<span class="nv">conf</span>:<span class="mi">7</span>
<span class="mi">2016</span><span class="o">/</span><span class="mi">06</span><span class="o">/</span><span class="mi">24</span> <span class="mi">17</span>:<span class="mi">02</span>:<span class="mi">44</span> [<span class="nv">notice</span>] <span class="mi">4079</span><span class="sc">#4079</span>: <span class="nv">signal</span> <span class="nv">process</span> <span class="nv">started</span>
<span class="mi">2016</span><span class="o">/</span><span class="mi">06</span><span class="o">/</span><span class="mi">24</span> <span class="mi">17</span>:<span class="mi">02</span>:<span class="mi">44</span> [<span class="nv">emerg</span>] <span class="mi">27280</span><span class="sc">#0</span>: <span class="nv">unknown</span> <span class="nv">directive</span> <span class="s2">&quot;</span><span class="s">keepalive</span><span class="s2">&quot;</span> <span class="nv">in</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">nginx</span><span class="o">/</span><span class="nv">conf</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">test_multi</span>.<span class="nv">conf</span>:<span class="mi">7</span>


简单描述下<span class="nv">nginx</span> <span class="nv">upstream</span> <span class="nv">keepalive</span>是个怎么一回事?   

默认情况下 <span class="nv">Nginx</span> 访问后端都是用的短连接<span class="ss">(</span><span class="nv">HTTP1</span>.<span class="mi">0</span><span class="ss">)</span>，一个请求来了，<span class="nv">Nginx</span> 新开一个端口和后端建立连接，请求结束连接回收。

如过配置了<span class="nv">http</span> <span class="mi">1</span>.<span class="mi">1</span>长连接，那么<span class="nv">Nginx</span>会以长连接保持后端的连接，如果并发请求超过了 <span class="nv">keepalive</span> 指定的最大连接数，<span class="nv">Nginx</span> 
会启动新的连接 来转发请求，新连接在请求完毕后关闭，而且新建立的连接是长连接。



下图是<span class="nv">nginx</span> <span class="nv">upstream</span> <span class="nv">keepalive</span>长连接的实现原理.

首先每个进程需要一个<span class="nv">connection</span> <span class="nv">pool</span>，里面都是长连接，多进程之间是不需要共享这个连接池的。 一旦与后端服务器建立连接，
则在当前请求连接结束之后不会立即关闭连接，而是把用完的连接保存在一个<span class="nv">keepalive</span> <span class="nv">connection</span> <span class="nv">pool</span>里面，以后每次需要建立
向后连接的时候，只需要从这个连接池里面找，如果找到合适的连接的话，就可以直接来用这个连接，不需要重新创建<span class="nv">socket</span>或者发起
<span class="k">connect</span><span class="ss">()</span>。这样既省下建立连接时在握手的时间消耗，又可以避免<span class="nv">TCP</span>连接的<span class="nv">slow</span> <span class="nv">start</span>。如果在<span class="nv">keepalive</span>连接池找不到合适的连接
那就按照原来的步骤重新建立连接。 我没有看过<span class="nv">nginx</span>在连接池中查找可用连接的代码，但是我自己写过<span class="nv">redis</span>，<span class="nv">mysqldb</span>的连接池代码，
逻辑应该都是一样的。谁用谁<span class="nv">pop</span>，用完了再<span class="nv">push</span>进去，这样时间才<span class="nv">O</span><span class="ss">(</span><span class="mi">1</span><span class="ss">)</span>。 

如果你的连接池的数控制在<span class="mi">128</span>，但因为你要应对更多的并发请求，所以临时又加了很多的连接，但这临时的连接是短连接和长连接要
看你的<span class="nv">nginx</span>版本，我这<span class="mi">1</span>.<span class="mi">8</span>是长连接，那他如何被收回，两地保证，一点是他会主动去释放，另一点是<span class="nv">keepalive</span> <span class="nb">timeout</span>的时间。







<span class="nv">Golang</span>的<span class="nv">http</span>模块貌似对<span class="nv">http</span> <span class="nv">spdy</span>支持不怎么好， 要不然可以直接用淘宝的<span class="nv">tengine</span> <span class="nv">upstream</span> <span class="nv">spdy</span>的方式连接后端<span class="nv">Server</span>。 
他的速度要比<span class="nv">keepalive</span>要好的多，毕竟省去了等待上次返回的结果的过程。
</pre></div>


<h2 id="nginx_rtmp-hls">nginx_rtmp hls</h2>
<div class="codehilite"><pre><span></span><span class="nv">docker</span>项目 <span class="nv">https</span>:<span class="o">//</span><span class="nv">github</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">brocaar</span><span class="o">/</span><span class="nv">nginx</span><span class="o">-</span><span class="nv">rtmp</span><span class="o">-</span><span class="nv">dockerfile</span>

<span class="nv">ffmpeg</span>要源码安装，<span class="nv">ubuntu</span>可以用<span class="nv">apt</span>源安装
二进制版  <span class="nv">http</span>:<span class="o">//</span><span class="nv">johnvansickle</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">ffmpeg</span><span class="o">/</span>
<span class="nv">wget</span> <span class="nv">http</span>:<span class="o">//</span><span class="nv">johnvansickle</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">ffmpeg</span><span class="o">/</span><span class="nv">builds</span><span class="o">/</span><span class="nv">ffmpeg</span><span class="o">-</span><span class="nv">git</span><span class="o">-</span><span class="mi">64</span><span class="nv">bit</span><span class="o">-</span><span class="nv">static</span>.<span class="nv">tar</span>.<span class="nv">xz</span>

配置<span class="nv">rpmforce</span>源
<span class="nv">mkdir</span> <span class="o">/</span><span class="nv">data</span> <span class="o">&amp;&amp;</span> <span class="nv">mkdir</span> <span class="o">/</span><span class="nv">static</span>
<span class="nv">yum</span> <span class="nv">install</span> <span class="nv">ffmpeg</span> <span class="nv">wget</span> <span class="nv">pcre</span><span class="o">-</span><span class="nv">devel</span> <span class="nv">zlib</span><span class="o">-</span><span class="nv">devel</span> <span class="nv">openssl</span><span class="o">-</span><span class="nv">devel</span>
<span class="nv">wget</span> <span class="nv">http</span>:<span class="o">//</span><span class="nv">nginx</span>.<span class="nv">org</span><span class="o">/</span><span class="nv">download</span><span class="o">/</span><span class="nv">nginx</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">6</span>.<span class="mi">2</span>.<span class="nv">tar</span>.<span class="nv">gz</span> <span class="o">&amp;&amp;</span> <span class="nv">tar</span> <span class="nv">zxf</span> <span class="nv">nginx</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">6</span>.<span class="mi">2</span>.<span class="nv">tar</span>.<span class="nv">gz</span>
<span class="nv">wget</span> <span class="nv">https</span>:<span class="o">//</span><span class="nv">github</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">arut</span><span class="o">/</span><span class="nv">nginx</span><span class="o">-</span><span class="nv">rtmp</span><span class="o">-</span><span class="nv">module</span><span class="o">/</span><span class="nv">archive</span><span class="o">/</span><span class="nv">v1</span>.<span class="mi">1</span>.<span class="mi">6</span>.<span class="nv">tar</span>.<span class="nv">gz</span> <span class="o">&amp;&amp;</span> <span class="nv">tar</span> <span class="nv">zxf</span> <span class="nv">v1</span>.<span class="mi">1</span>.<span class="mi">6</span>.<span class="nv">tar</span>.<span class="nv">gz</span>
<span class="nv">cd</span> <span class="nv">nginx</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">6</span>.<span class="mi">2</span> <span class="o">&amp;&amp;</span> .<span class="o">/</span><span class="nv">configure</span> <span class="o">--</span><span class="nv">add</span><span class="o">-</span><span class="nv">module</span><span class="o">=</span>..<span class="o">/</span><span class="nv">nginx</span><span class="o">-</span><span class="nv">rtmp</span><span class="o">-</span><span class="nv">module</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">1</span>.<span class="mi">6</span> <span class="o">--</span><span class="nv">prefix</span><span class="o">=/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">nginx</span>
<span class="nv">make</span> <span class="o">&amp;&amp;</span> <span class="nv">make</span> <span class="nv">install</span>

<span class="nv">nginx</span>配置文件
<span class="nv">daemon</span>  <span class="nv">off</span><span class="c1">;</span>
<span class="nv">events</span> {
    <span class="nv">worker_connections</span> <span class="mi">1024</span><span class="c1">;</span>
}
<span class="nv">rtmp</span> {
    <span class="nv">server</span> {
        <span class="nv">listen</span> <span class="mi">1935</span><span class="c1">;</span>
        <span class="nv">chunk_size</span> <span class="mi">4000</span><span class="c1">;</span>
        <span class="nv">application</span> <span class="nv">encoder</span> {
            <span class="nv">live</span> <span class="nv">on</span><span class="c1">;</span>
            <span class="k">exec</span> <span class="nv">ffmpeg</span> <span class="o">-</span><span class="nv">i</span> <span class="nv">rtmp</span>:<span class="o">//</span><span class="nv">localhost</span>:<span class="mi">1935</span><span class="o">/</span><span class="nv">encoder</span><span class="o">/</span>$<span class="nv">name</span>
              <span class="o">-</span><span class="nv">c</span>:<span class="nv">a</span> <span class="nv">libfdk_aac</span> <span class="o">-</span><span class="nv">b</span>:<span class="nv">a</span> <span class="mi">128</span><span class="nv">k</span> <span class="o">-</span><span class="nv">c</span>:<span class="nv">v</span> <span class="nv">libx264</span> <span class="o">-</span><span class="nv">b</span>:<span class="nv">v</span> <span class="mi">2500</span><span class="nv">k</span> <span class="o">-</span><span class="nv">f</span> <span class="nv">flv</span> <span class="o">-</span><span class="nv">g</span> <span class="mi">30</span> <span class="o">-</span><span class="nv">r</span> <span class="mi">30</span> <span class="o">-</span><span class="nv">s</span> <span class="mi">1280</span><span class="nv">x720</span> <span class="o">-</span><span class="nv">preset</span> 
              <span class="nv">superfast</span> <span class="o">-</span><span class="nv">profile</span>:<span class="nv">v</span> <span class="nv">baseline</span> <span class="nv">rtmp</span>:<span class="o">//</span><span class="nv">localhost</span>:<span class="mi">1935</span><span class="o">/</span><span class="nv">hls</span><span class="o">/</span>$<span class="nv">name_720p2628kbs</span>
              <span class="o">-</span><span class="nv">c</span>:<span class="nv">a</span> <span class="nv">libfdk_aac</span> <span class="o">-</span><span class="nv">b</span>:<span class="nv">a</span> <span class="mi">128</span><span class="nv">k</span> <span class="o">-</span><span class="nv">c</span>:<span class="nv">v</span> <span class="nv">libx264</span> <span class="o">-</span><span class="nv">b</span>:<span class="nv">v</span> <span class="mi">1000</span><span class="nv">k</span> <span class="o">-</span><span class="nv">f</span> <span class="nv">flv</span> <span class="o">-</span><span class="nv">g</span> <span class="mi">30</span> <span class="o">-</span><span class="nv">r</span> <span class="mi">30</span> <span class="o">-</span><span class="nv">s</span> <span class="mi">854</span><span class="nv">x480</span> <span class="o">-</span><span class="nv">preset</span> 
              <span class="nv">superfast</span> <span class="o">-</span><span class="nv">profile</span>:<span class="nv">v</span> <span class="nv">baseline</span> <span class="nv">rtmp</span>:<span class="o">//</span><span class="nv">localhost</span>:<span class="mi">1935</span><span class="o">/</span><span class="nv">hls</span><span class="o">/</span>$<span class="nv">name_480p1128kbs</span>
              <span class="o">-</span><span class="nv">c</span>:<span class="nv">a</span> <span class="nv">libfdk_aac</span> <span class="o">-</span><span class="nv">b</span>:<span class="nv">a</span> <span class="mi">128</span><span class="nv">k</span> <span class="o">-</span><span class="nv">c</span>:<span class="nv">v</span> <span class="nv">libx264</span> <span class="o">-</span><span class="nv">b</span>:<span class="nv">v</span> <span class="mi">750</span><span class="nv">k</span> <span class="o">-</span><span class="nv">f</span> <span class="nv">flv</span> <span class="o">-</span><span class="nv">g</span> <span class="mi">30</span> <span class="o">-</span><span class="nv">r</span> <span class="mi">30</span> <span class="o">-</span><span class="nv">s</span> <span class="mi">640</span><span class="nv">x360</span> <span class="o">-</span><span class="nv">preset</span> 
              <span class="nv">superfast</span> <span class="o">-</span><span class="nv">profile</span>:<span class="nv">v</span> <span class="nv">baseline</span> <span class="nv">rtmp</span>:<span class="o">//</span><span class="nv">localhost</span>:<span class="mi">1935</span><span class="o">/</span><span class="nv">hls</span><span class="o">/</span>$<span class="nv">name_360p878kbs</span>
              <span class="o">-</span><span class="nv">c</span>:<span class="nv">a</span> <span class="nv">libfdk_aac</span> <span class="o">-</span><span class="nv">b</span>:<span class="nv">a</span> <span class="mi">128</span><span class="nv">k</span> <span class="o">-</span><span class="nv">c</span>:<span class="nv">v</span> <span class="nv">libx264</span> <span class="o">-</span><span class="nv">b</span>:<span class="nv">v</span> <span class="mi">400</span><span class="nv">k</span> <span class="o">-</span><span class="nv">f</span> <span class="nv">flv</span> <span class="o">-</span><span class="nv">g</span> <span class="mi">30</span> <span class="o">-</span><span class="nv">r</span> <span class="mi">30</span> <span class="o">-</span><span class="nv">s</span> <span class="mi">426</span><span class="nv">x240</span> <span class="o">-</span><span class="nv">preset</span> 
              <span class="nv">superfast</span> <span class="o">-</span><span class="nv">profile</span>:<span class="nv">v</span> <span class="nv">baseline</span> <span class="nv">rtmp</span>:<span class="o">//</span><span class="nv">localhost</span>:<span class="mi">1935</span><span class="o">/</span><span class="nv">hls</span><span class="o">/</span>$<span class="nv">name_240p528kbs</span>
              <span class="o">-</span><span class="nv">c</span>:<span class="nv">a</span> <span class="nv">libfdk_aac</span> <span class="o">-</span><span class="nv">b</span>:<span class="nv">a</span> <span class="mi">64</span><span class="nv">k</span> <span class="o">-</span><span class="nv">c</span>:<span class="nv">v</span> <span class="nv">libx264</span> <span class="o">-</span><span class="nv">b</span>:<span class="nv">v</span> <span class="mi">200</span><span class="nv">k</span> <span class="o">-</span><span class="nv">f</span> <span class="nv">flv</span> <span class="o">-</span><span class="nv">g</span> <span class="mi">15</span> <span class="o">-</span><span class="nv">r</span> <span class="mi">15</span> <span class="o">-</span><span class="nv">s</span> <span class="mi">426</span><span class="nv">x240</span> <span class="o">-</span><span class="nv">preset</span> 
              <span class="nv">superfast</span> <span class="o">-</span><span class="nv">profile</span>:<span class="nv">v</span> <span class="nv">baseline</span> <span class="nv">rtmp</span>:<span class="o">//</span><span class="nv">localhost</span>:<span class="mi">1935</span><span class="o">/</span><span class="nv">hls</span><span class="o">/</span>$<span class="nv">name_240p264kbs</span><span class="c1">;</span>
        }
        <span class="nv">application</span> <span class="nv">hls</span> {
            <span class="nv">live</span> <span class="nv">on</span><span class="c1">;</span>
            <span class="nv">hls</span> <span class="nv">on</span><span class="c1">;</span>
            <span class="nv">hls_fragment_naming</span> <span class="nv">system</span><span class="c1">;</span>
            <span class="nv">hls_fragment</span> <span class="mi">5</span><span class="nv">s</span><span class="c1">;</span>
            <span class="nv">hls_path</span> <span class="o">/</span><span class="nv">data</span><span class="o">/</span><span class="nv">hls</span><span class="c1">;</span>
            <span class="nv">hls_nested</span> <span class="nv">on</span><span class="c1">;</span>
            <span class="nv">hls_variant</span> <span class="nv">_720p2628kbs</span> <span class="nv">BANDWIDTH</span><span class="o">=</span><span class="mi">2628000</span>,<span class="nv">RESOLUTION</span><span class="o">=</span><span class="mi">1280</span><span class="nv">x720</span><span class="c1">;</span>
            <span class="nv">hls_variant</span> <span class="nv">_480p1128kbs</span> <span class="nv">BANDWIDTH</span><span class="o">=</span><span class="mi">1128000</span>,<span class="nv">RESOLUTION</span><span class="o">=</span><span class="mi">854</span><span class="nv">x480</span><span class="c1">;</span>
            <span class="nv">hls_variant</span> <span class="nv">_360p878kbs</span> <span class="nv">BANDWIDTH</span><span class="o">=</span><span class="mi">878000</span>,<span class="nv">RESOLUTION</span><span class="o">=</span><span class="mi">640</span><span class="nv">x360</span><span class="c1">;</span>
            <span class="nv">hls_variant</span> <span class="nv">_240p528kbs</span> <span class="nv">BANDWIDTH</span><span class="o">=</span><span class="mi">528000</span>,<span class="nv">RESOLUTION</span><span class="o">=</span><span class="mi">426</span><span class="nv">x240</span><span class="c1">;</span>
            <span class="nv">hls_variant</span> <span class="nv">_240p264kbs</span> <span class="nv">BANDWIDTH</span><span class="o">=</span><span class="mi">264000</span>,<span class="nv">RESOLUTION</span><span class="o">=</span><span class="mi">426</span><span class="nv">x240</span><span class="c1">;</span>
        }
    }
}
<span class="nv">http</span> {
    <span class="nv">server</span> {
        <span class="nv">listen</span> <span class="mi">80</span><span class="c1">;</span>
        <span class="nv">location</span> <span class="o">/</span><span class="nv">hls</span> {
            <span class="nv">types</span> {
                <span class="nv">application</span><span class="o">/</span><span class="nv">vnd</span>.<span class="nv">apple</span>.<span class="nv">mpegurl</span> <span class="nv">m3u8</span><span class="c1">;</span>
                <span class="nv">video</span><span class="o">/</span><span class="nv">mp2t</span> <span class="nv">ts</span><span class="c1">;</span>
            }
            <span class="nv">root</span> <span class="o">/</span><span class="nv">data</span><span class="c1">;</span>
            <span class="nv">add_header</span> <span class="nv">Cache</span><span class="o">-</span><span class="nv">Control</span> <span class="nv">no</span><span class="o">-</span><span class="nv">cache</span><span class="c1">;</span>
            <span class="nv">add_header</span> <span class="nv">Access</span><span class="o">-</span><span class="nv">Control</span><span class="o">-</span><span class="nv">Allow</span><span class="o">-</span><span class="nv">Origin</span> <span class="o">*</span><span class="c1">;</span>
        }
        <span class="nv">location</span> <span class="o">/</span><span class="nv">stat</span> {
            <span class="nv">rtmp_stat</span> <span class="nv">all</span><span class="c1">;</span>
            <span class="nv">rtmp_stat_stylesheet</span> <span class="nv">static</span><span class="o">/</span><span class="nv">stat</span>.<span class="nv">xsl</span><span class="c1">;</span>
        }
        <span class="nv">location</span> <span class="o">/</span><span class="nv">static</span> {
            <span class="nv">alias</span> <span class="o">/</span><span class="nv">static</span><span class="c1">;</span>
        }
        <span class="nv">location</span> <span class="o">/</span><span class="nv">crossdomain</span>.<span class="nv">xml</span> {
            <span class="nv">default_type</span> <span class="nv">text</span><span class="o">/</span><span class="nv">xml</span><span class="c1">;</span>
            <span class="k">return</span> <span class="mi">200</span> <span class="s1">&#39;</span><span class="s">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
                <span class="o">&lt;!</span><span class="nv">DOCTYPE</span> <span class="nv">cross</span><span class="o">-</span><span class="nv">domain</span><span class="o">-</span><span class="nv">policy</span> <span class="nv">SYSTEM</span> <span class="s2">&quot;</span><span class="s">http://www.adobe.com/xml/dtds/cross-domain-policy.dtd</span><span class="s2">&quot;</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="nv">cross</span><span class="o">-</span><span class="nv">domain</span><span class="o">-</span><span class="nv">policy</span><span class="o">&gt;</span>
                    <span class="o">&lt;</span><span class="nv">site</span><span class="o">-</span><span class="nv">control</span> <span class="nv">permitted</span><span class="o">-</span><span class="nv">cross</span><span class="o">-</span><span class="nv">domain</span><span class="o">-</span><span class="nv">policies</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">all</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
                    <span class="o">&lt;</span><span class="nv">allow</span><span class="o">-</span><span class="nv">access</span><span class="o">-</span><span class="nv">from</span> <span class="nv">domain</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">*</span><span class="s2">&quot;</span> <span class="nv">secure</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">false</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
                    <span class="o">&lt;</span><span class="nv">allow</span><span class="o">-</span><span class="nv">http</span><span class="o">-</span><span class="nv">request</span><span class="o">-</span><span class="nv">headers</span><span class="o">-</span><span class="nv">from</span> <span class="nv">domain</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">*</span><span class="s2">&quot;</span> <span class="nv">headers</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">*</span><span class="s2">&quot;</span> <span class="nv">secure</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">false</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
                <span class="o">&lt;/</span><span class="nv">cross</span><span class="o">-</span><span class="nv">domain</span><span class="o">-</span><span class="nv">policy</span><span class="o">&gt;</span><span class="s1">&#39;</span><span class="s">;</span>
            <span class="nv">expires</span> <span class="mi">24</span><span class="nv">h</span><span class="c1">;</span>
        }
    }
}


<span class="o">------------------------------</span>
<span class="nv">cat</span> <span class="o">/</span><span class="nv">static</span><span class="o">/</span><span class="nv">stat</span>.<span class="nv">xsl</span>

<span class="o">&lt;</span>?<span class="nv">xml</span> <span class="nv">version</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">1.0</span><span class="s2">&quot;</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">utf-8</span><span class="s2">&quot;</span> ?<span class="o">&gt;</span>
<span class="o">&lt;!--</span>
   <span class="nv">Copyright</span> <span class="ss">(</span><span class="nv">C</span><span class="ss">)</span> <span class="nv">Roman</span> <span class="nv">Arutyunyan</span>
<span class="o">--&gt;</span>
<span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">stylesheet</span> <span class="nv">version</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">1.0</span><span class="s2">&quot;</span> <span class="nv">xmlns</span>:<span class="nv">xsl</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">http://www.w3.org/1999/XSL/Transform</span><span class="s2">&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">template</span> <span class="nv">match</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">/</span><span class="s2">&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nv">html</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">head</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">title</span><span class="o">&gt;</span><span class="nv">RTMP</span> <span class="nv">statistics</span><span class="o">&lt;/</span><span class="nv">title</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="nv">head</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">body</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">apply</span><span class="o">-</span><span class="nv">templates</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">rtmp</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
            <span class="o">&lt;</span><span class="nv">hr</span><span class="o">/&gt;</span>
            <span class="nv">Generated</span> <span class="nv">by</span> <span class="o">&lt;</span><span class="nv">a</span> <span class="nv">href</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">https://github.com/arut/nginx-rtmp-module</span><span class="s1">&#39;</span><span class="o">&gt;</span>
            <span class="nv">nginx</span><span class="o">-</span><span class="nv">rtmp</span><span class="o">-</span><span class="nv">module</span><span class="o">&lt;/</span><span class="nv">a</span><span class="o">&gt;&amp;</span><span class="sc">#160</span><span class="c1">;&lt;xsl:value-of select=&quot;/rtmp/nginx_rtmp_version&quot;/&gt;,</span>
            <span class="o">&lt;</span><span class="nv">a</span> <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">http://nginx.org</span><span class="s2">&quot;</span><span class="o">&gt;</span><span class="nv">nginx</span><span class="o">&lt;/</span><span class="nv">a</span><span class="o">&gt;&amp;</span><span class="sc">#160</span><span class="c1">;&lt;xsl:value-of select=&quot;/rtmp/nginx_version&quot;/&gt;,</span>
            <span class="nv">pid</span> <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">/rtmp/pid</span><span class="s2">&quot;</span><span class="o">/&gt;</span>,
            <span class="nv">built</span> <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">/rtmp/built</span><span class="s2">&quot;</span><span class="o">/&gt;&amp;</span><span class="sc">#160</span><span class="c1">;&lt;xsl:value-of select=&quot;/rtmp/compiler&quot;/&gt;</span>
        <span class="o">&lt;/</span><span class="nv">body</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="nv">html</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">template</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">template</span> <span class="nv">match</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">rtmp</span><span class="s2">&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nv">table</span> <span class="nv">cellspacing</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">1</span><span class="s2">&quot;</span> <span class="nv">cellpadding</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">5</span><span class="s2">&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">tr</span> <span class="nv">bgcolor</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">#999999</span><span class="s2">&quot;</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">th</span><span class="o">&gt;</span><span class="nv">RTMP</span><span class="o">&lt;/</span><span class="nv">th</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">th</span><span class="o">&gt;</span>#<span class="nv">clients</span><span class="o">&lt;/</span><span class="nv">th</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">th</span> <span class="nv">colspan</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">4</span><span class="s2">&quot;</span><span class="o">&gt;</span><span class="nv">Video</span><span class="o">&lt;/</span><span class="nv">th</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">th</span> <span class="nv">colspan</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">4</span><span class="s2">&quot;</span><span class="o">&gt;</span><span class="nv">Audio</span><span class="o">&lt;/</span><span class="nv">th</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">th</span><span class="o">&gt;</span><span class="nv">In</span> <span class="nv">bytes</span><span class="o">&lt;/</span><span class="nv">th</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">th</span><span class="o">&gt;</span><span class="nv">Out</span> <span class="nv">bytes</span><span class="o">&lt;/</span><span class="nv">th</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">th</span><span class="o">&gt;</span><span class="nv">In</span> <span class="nv">bits</span><span class="o">/</span><span class="nv">s</span><span class="o">&lt;/</span><span class="nv">th</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">th</span><span class="o">&gt;</span><span class="nv">Out</span> <span class="nv">bits</span><span class="o">/</span><span class="nv">s</span><span class="o">&lt;/</span><span class="nv">th</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">th</span><span class="o">&gt;</span><span class="nv">State</span><span class="o">&lt;/</span><span class="nv">th</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">th</span><span class="o">&gt;</span><span class="nv">Time</span><span class="o">&lt;/</span><span class="nv">th</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="nv">tr</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">tr</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">td</span> <span class="nv">colspan</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">2</span><span class="s2">&quot;</span><span class="o">&gt;</span><span class="nv">Accepted</span>: <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">naccepted</span><span class="s2">&quot;</span><span class="o">/&gt;&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">th</span> <span class="nv">bgcolor</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">#999999</span><span class="s2">&quot;</span><span class="o">&gt;</span><span class="nv">codec</span><span class="o">&lt;/</span><span class="nv">th</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">th</span> <span class="nv">bgcolor</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">#999999</span><span class="s2">&quot;</span><span class="o">&gt;</span><span class="nv">bits</span><span class="o">/</span><span class="nv">s</span><span class="o">&lt;/</span><span class="nv">th</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">th</span> <span class="nv">bgcolor</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">#999999</span><span class="s2">&quot;</span><span class="o">&gt;</span><span class="nv">size</span><span class="o">&lt;/</span><span class="nv">th</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">th</span> <span class="nv">bgcolor</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">#999999</span><span class="s2">&quot;</span><span class="o">&gt;</span><span class="nv">fps</span><span class="o">&lt;/</span><span class="nv">th</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">th</span> <span class="nv">bgcolor</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">#999999</span><span class="s2">&quot;</span><span class="o">&gt;</span><span class="nv">codec</span><span class="o">&lt;/</span><span class="nv">th</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">th</span> <span class="nv">bgcolor</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">#999999</span><span class="s2">&quot;</span><span class="o">&gt;</span><span class="nv">bits</span><span class="o">/</span><span class="nv">s</span><span class="o">&lt;/</span><span class="nv">th</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">th</span> <span class="nv">bgcolor</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">#999999</span><span class="s2">&quot;</span><span class="o">&gt;</span><span class="nv">freq</span><span class="o">&lt;/</span><span class="nv">th</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">th</span> <span class="nv">bgcolor</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">#999999</span><span class="s2">&quot;</span><span class="o">&gt;</span><span class="nv">chan</span><span class="o">&lt;/</span><span class="nv">th</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">call</span><span class="o">-</span><span class="nv">template</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">showsize</span><span class="s2">&quot;</span><span class="o">&gt;</span>
                    <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">with</span><span class="o">-</span><span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">size</span><span class="s2">&quot;</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">bytes_in</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
                <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">call</span><span class="o">-</span><span class="nv">template</span><span class="o">&gt;</span>
            <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">call</span><span class="o">-</span><span class="nv">template</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">showsize</span><span class="s2">&quot;</span><span class="o">&gt;</span>
                    <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">with</span><span class="o">-</span><span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">size</span><span class="s2">&quot;</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">bytes_out</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
                <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">call</span><span class="o">-</span><span class="nv">template</span><span class="o">&gt;</span>
            <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">call</span><span class="o">-</span><span class="nv">template</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">showsize</span><span class="s2">&quot;</span><span class="o">&gt;</span>
                    <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">with</span><span class="o">-</span><span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">size</span><span class="s2">&quot;</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">bw_in</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
                    <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">with</span><span class="o">-</span><span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">bits</span><span class="s2">&quot;</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">1</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
                    <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">with</span><span class="o">-</span><span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">persec</span><span class="s2">&quot;</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">1</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
                <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">call</span><span class="o">-</span><span class="nv">template</span><span class="o">&gt;</span>
            <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">call</span><span class="o">-</span><span class="nv">template</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">showsize</span><span class="s2">&quot;</span><span class="o">&gt;</span>
                    <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">with</span><span class="o">-</span><span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">size</span><span class="s2">&quot;</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">bw_out</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
                    <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">with</span><span class="o">-</span><span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">bits</span><span class="s2">&quot;</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">1</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
                    <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">with</span><span class="o">-</span><span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">persec</span><span class="s2">&quot;</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">1</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
                <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">call</span><span class="o">-</span><span class="nv">template</span><span class="o">&gt;</span>
            <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">td</span><span class="o">/&gt;</span>
            <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">call</span><span class="o">-</span><span class="nv">template</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">showtime</span><span class="s2">&quot;</span><span class="o">&gt;</span>
                    <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">with</span><span class="o">-</span><span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">time</span><span class="s2">&quot;</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">/rtmp/uptime * 1000</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
                <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">call</span><span class="o">-</span><span class="nv">template</span><span class="o">&gt;</span>
            <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="nv">tr</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">apply</span><span class="o">-</span><span class="nv">templates</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">server</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
    <span class="o">&lt;/</span><span class="nv">table</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">template</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">template</span> <span class="nv">match</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">server</span><span class="s2">&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">apply</span><span class="o">-</span><span class="nv">templates</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">application</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">template</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">template</span> <span class="nv">match</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">application</span><span class="s2">&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nv">tr</span> <span class="nv">bgcolor</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">#999999</span><span class="s2">&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">b</span><span class="o">&gt;&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">name</span><span class="s2">&quot;</span><span class="o">/&gt;&lt;/</span><span class="nv">b</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="nv">tr</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">apply</span><span class="o">-</span><span class="nv">templates</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">live</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">apply</span><span class="o">-</span><span class="nv">templates</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">play</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">template</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">template</span> <span class="nv">match</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">live</span><span class="s2">&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nv">tr</span> <span class="nv">bgcolor</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">#aaaaaa</span><span class="s2">&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">i</span><span class="o">&gt;</span><span class="nv">live</span> <span class="nv">streams</span><span class="o">&lt;/</span><span class="nv">i</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span> <span class="nv">align</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">middle</span><span class="s2">&quot;</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">nclients</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
        <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="nv">tr</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">apply</span><span class="o">-</span><span class="nv">templates</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">stream</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">template</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">template</span> <span class="nv">match</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">play</span><span class="s2">&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nv">tr</span> <span class="nv">bgcolor</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">#aaaaaa</span><span class="s2">&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">i</span><span class="o">&gt;</span><span class="nv">vod</span> <span class="nv">streams</span><span class="o">&lt;/</span><span class="nv">i</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span> <span class="nv">align</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">middle</span><span class="s2">&quot;</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">nclients</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
        <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="nv">tr</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">apply</span><span class="o">-</span><span class="nv">templates</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">stream</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">template</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">template</span> <span class="nv">match</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">stream</span><span class="s2">&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nv">tr</span> <span class="nv">valign</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">top</span><span class="s2">&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">attribute</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">bgcolor</span><span class="s2">&quot;</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">choose</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">when</span> <span class="nv">test</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">active</span><span class="s2">&quot;</span><span class="o">&gt;</span>#<span class="nv">cccccc</span><span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">when</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">otherwise</span><span class="o">&gt;</span>#<span class="nv">dddddd</span><span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">otherwise</span><span class="o">&gt;</span>
            <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">choose</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">attribute</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">a</span> <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">attribute</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">onclick</span><span class="s2">&quot;</span><span class="o">&gt;</span>
                    <span class="nv">var</span> <span class="nv">d</span><span class="o">=</span><span class="nv">document</span>.<span class="nv">getElementById</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">&lt;xsl:value-of select=&quot;../../name&quot;/&gt;-&lt;xsl:value-of select=&quot;name&quot;/&gt;</span><span class="s1">&#39;</span><span class="ss">)</span><span class="c1">;</span>
                    <span class="nv">d</span>.<span class="nv">style</span>.<span class="nv">display</span><span class="o">=</span><span class="nv">d</span>.<span class="nv">style</span>.<span class="nv">display</span><span class="o">==</span><span class="s1">&#39;</span><span class="s">none</span><span class="s1">&#39;</span>?<span class="s1">&#39;&#39;</span>:<span class="s1">&#39;</span><span class="s">none</span><span class="s1">&#39;</span><span class="c1">;</span>
                    <span class="k">return</span> <span class="nv">false</span>
                <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">attribute</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">name</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="k">if</span> <span class="nv">test</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">string-length(name) = 0</span><span class="s2">&quot;</span><span class="o">&gt;</span>
                    [<span class="nv">EMPTY</span>]
                <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="k">if</span><span class="o">&gt;</span>
            <span class="o">&lt;/</span><span class="nv">a</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span> <span class="nv">align</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">middle</span><span class="s2">&quot;</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">nclients</span><span class="s2">&quot;</span><span class="o">/&gt;</span> <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">meta/video/codec</span><span class="s2">&quot;</span><span class="o">/&gt;&amp;</span><span class="sc">#160</span><span class="c1">;&lt;xsl:value-of select=&quot;meta/video/profile&quot;/&gt;&amp;#160;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">meta/video/level</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
        <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">call</span><span class="o">-</span><span class="nv">template</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">showsize</span><span class="s2">&quot;</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">with</span><span class="o">-</span><span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">size</span><span class="s2">&quot;</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">bw_video</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">with</span><span class="o">-</span><span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">bits</span><span class="s2">&quot;</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">1</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">with</span><span class="o">-</span><span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">persec</span><span class="s2">&quot;</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">1</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
            <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">call</span><span class="o">-</span><span class="nv">template</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">apply</span><span class="o">-</span><span class="nv">templates</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">meta/video/width</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
        <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">meta/video/frame_rate</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
        <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">meta/audio/codec</span><span class="s2">&quot;</span><span class="o">/&gt;&amp;</span><span class="sc">#160</span><span class="c1">;&lt;xsl:value-of select=&quot;meta/audio/profile&quot;/&gt;</span>
        <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">call</span><span class="o">-</span><span class="nv">template</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">showsize</span><span class="s2">&quot;</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">with</span><span class="o">-</span><span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">size</span><span class="s2">&quot;</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">bw_audio</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">with</span><span class="o">-</span><span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">bits</span><span class="s2">&quot;</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">1</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">with</span><span class="o">-</span><span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">persec</span><span class="s2">&quot;</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">1</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
            <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">call</span><span class="o">-</span><span class="nv">template</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">apply</span><span class="o">-</span><span class="nv">templates</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">meta/audio/sample_rate</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
        <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">meta/audio/channels</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
        <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">call</span><span class="o">-</span><span class="nv">template</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">showsize</span><span class="s2">&quot;</span><span class="o">&gt;</span>
               <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">with</span><span class="o">-</span><span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">size</span><span class="s2">&quot;</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">bytes_in</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
           <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">call</span><span class="o">-</span><span class="nv">template</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">call</span><span class="o">-</span><span class="nv">template</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">showsize</span><span class="s2">&quot;</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">with</span><span class="o">-</span><span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">size</span><span class="s2">&quot;</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">bytes_out</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
            <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">call</span><span class="o">-</span><span class="nv">template</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">call</span><span class="o">-</span><span class="nv">template</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">showsize</span><span class="s2">&quot;</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">with</span><span class="o">-</span><span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">size</span><span class="s2">&quot;</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">bw_in</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">with</span><span class="o">-</span><span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">bits</span><span class="s2">&quot;</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">1</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">with</span><span class="o">-</span><span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">persec</span><span class="s2">&quot;</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">1</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
            <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">call</span><span class="o">-</span><span class="nv">template</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">call</span><span class="o">-</span><span class="nv">template</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">showsize</span><span class="s2">&quot;</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">with</span><span class="o">-</span><span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">size</span><span class="s2">&quot;</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">bw_out</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">with</span><span class="o">-</span><span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">bits</span><span class="s2">&quot;</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">1</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">with</span><span class="o">-</span><span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">persec</span><span class="s2">&quot;</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">1</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
            <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">call</span><span class="o">-</span><span class="nv">template</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;&lt;</span><span class="nv">xsl</span>:<span class="nv">call</span><span class="o">-</span><span class="nv">template</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">streamstate</span><span class="s2">&quot;</span><span class="o">/&gt;&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">call</span><span class="o">-</span><span class="nv">template</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">showtime</span><span class="s2">&quot;</span><span class="o">&gt;</span>
               <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">with</span><span class="o">-</span><span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">time</span><span class="s2">&quot;</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">time</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
            <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">call</span><span class="o">-</span><span class="nv">template</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="nv">tr</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nv">tr</span> <span class="nv">style</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">display:none</span><span class="s2">&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">attribute</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">id</span><span class="s2">&quot;</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">../../name</span><span class="s2">&quot;</span><span class="o">/&gt;-&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">name</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
        <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">attribute</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span> <span class="nv">colspan</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">16</span><span class="s2">&quot;</span> <span class="nv">ngcolor</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">#eeeeee</span><span class="s2">&quot;</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">table</span> <span class="nv">cellspacing</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">1</span><span class="s2">&quot;</span> <span class="nv">cellpadding</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">5</span><span class="s2">&quot;</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="nv">tr</span><span class="o">&gt;</span>
                    <span class="o">&lt;</span><span class="nv">th</span><span class="o">&gt;</span><span class="nv">Id</span><span class="o">&lt;/</span><span class="nv">th</span><span class="o">&gt;</span>
                    <span class="o">&lt;</span><span class="nv">th</span><span class="o">&gt;</span><span class="nv">State</span><span class="o">&lt;/</span><span class="nv">th</span><span class="o">&gt;</span>
                    <span class="o">&lt;</span><span class="nv">th</span><span class="o">&gt;</span><span class="nv">Address</span><span class="o">&lt;/</span><span class="nv">th</span><span class="o">&gt;</span>
                    <span class="o">&lt;</span><span class="nv">th</span><span class="o">&gt;</span><span class="nv">Flash</span> <span class="nv">version</span><span class="o">&lt;/</span><span class="nv">th</span><span class="o">&gt;</span>
                    <span class="o">&lt;</span><span class="nv">th</span><span class="o">&gt;</span><span class="nv">Page</span> <span class="nv">URL</span><span class="o">&lt;/</span><span class="nv">th</span><span class="o">&gt;</span>
                    <span class="o">&lt;</span><span class="nv">th</span><span class="o">&gt;</span><span class="nv">SWF</span> <span class="nv">URL</span><span class="o">&lt;/</span><span class="nv">th</span><span class="o">&gt;</span>
                    <span class="o">&lt;</span><span class="nv">th</span><span class="o">&gt;</span><span class="nv">Dropped</span><span class="o">&lt;/</span><span class="nv">th</span><span class="o">&gt;</span>
                    <span class="o">&lt;</span><span class="nv">th</span><span class="o">&gt;</span><span class="nv">Timestamp</span><span class="o">&lt;/</span><span class="nv">th</span><span class="o">&gt;</span>
                    <span class="o">&lt;</span><span class="nv">th</span><span class="o">&gt;</span><span class="nv">A</span><span class="o">-</span><span class="nv">V</span><span class="o">&lt;/</span><span class="nv">th</span><span class="o">&gt;</span>
                    <span class="o">&lt;</span><span class="nv">th</span><span class="o">&gt;</span><span class="nv">Time</span><span class="o">&lt;/</span><span class="nv">th</span><span class="o">&gt;</span>
                <span class="o">&lt;/</span><span class="nv">tr</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">apply</span><span class="o">-</span><span class="nv">templates</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">client</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
            <span class="o">&lt;/</span><span class="nv">table</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="nv">tr</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">template</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">template</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">showtime</span><span class="s2">&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">time</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="k">if</span> <span class="nv">test</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">$time &amp;gt; 0</span><span class="s2">&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">variable</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">sec</span><span class="s2">&quot;</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">floor($time div 1000)</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
        <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">variable</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="k">if</span> <span class="nv">test</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">$sec &amp;gt;= 86400</span><span class="s2">&quot;</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">floor($sec div 86400)</span><span class="s2">&quot;</span><span class="o">/&gt;</span><span class="nv">d</span>
        <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="k">if</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="k">if</span> <span class="nv">test</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">$sec &amp;gt;= 3600</span><span class="s2">&quot;</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">(floor($sec div 3600)) mod 24</span><span class="s2">&quot;</span><span class="o">/&gt;</span><span class="nv">h</span>
        <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="k">if</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="k">if</span> <span class="nv">test</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">$sec &amp;gt;= 60</span><span class="s2">&quot;</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">(floor($sec div 60)) mod 60</span><span class="s2">&quot;</span><span class="o">/&gt;</span><span class="nv">m</span>
        <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="k">if</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">$sec mod 60</span><span class="s2">&quot;</span><span class="o">/&gt;</span><span class="nv">s</span>
    <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="k">if</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">template</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">template</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">showsize</span><span class="s2">&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">size</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">bits</span><span class="s2">&quot;</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">0</span><span class="s2">&quot;</span> <span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">persec</span><span class="s2">&quot;</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">0</span><span class="s2">&quot;</span> <span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">variable</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">sizen</span><span class="s2">&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">floor($size div 1024)</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
    <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">variable</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">choose</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">when</span> <span class="nv">test</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">$sizen &amp;gt;= 1073741824</span><span class="s2">&quot;</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">format-number($sizen div 1073741824,&#39;#.###&#39;)</span><span class="s2">&quot;</span><span class="o">/&gt;</span> <span class="nv">T</span><span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">when</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">when</span> <span class="nv">test</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">$sizen &amp;gt;= 1048576</span><span class="s2">&quot;</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">format-number($sizen div 1048576,&#39;#.###&#39;)</span><span class="s2">&quot;</span><span class="o">/&gt;</span> <span class="nv">G</span><span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">when</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">when</span> <span class="nv">test</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">$sizen &amp;gt;= 1024</span><span class="s2">&quot;</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">format-number($sizen div 1024,&#39;#.##&#39;)</span><span class="s2">&quot;</span><span class="o">/&gt;</span> <span class="nv">M</span><span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">when</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">when</span> <span class="nv">test</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">$sizen &amp;gt;= 0</span><span class="s2">&quot;</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">$sizen</span><span class="s2">&quot;</span><span class="o">/&gt;</span> <span class="nv">K</span><span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">when</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">choose</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="k">if</span> <span class="nv">test</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">string-length($size) &amp;gt; 0</span><span class="s2">&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">choose</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">when</span> <span class="nv">test</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">$bits = 1</span><span class="s2">&quot;</span><span class="o">&gt;</span><span class="nv">b</span><span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">when</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">otherwise</span><span class="o">&gt;</span><span class="nv">B</span><span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">otherwise</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">choose</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="k">if</span> <span class="nv">test</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">$persec = 1</span><span class="s2">&quot;</span><span class="o">&gt;/</span><span class="nv">s</span><span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="k">if</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="k">if</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">template</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">template</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">streamstate</span><span class="s2">&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">choose</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">when</span> <span class="nv">test</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">active</span><span class="s2">&quot;</span><span class="o">&gt;</span><span class="nv">active</span><span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">when</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">otherwise</span><span class="o">&gt;</span><span class="nv">idle</span><span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">otherwise</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">choose</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">template</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">template</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">clientstate</span><span class="s2">&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">choose</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">when</span> <span class="nv">test</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">publishing</span><span class="s2">&quot;</span><span class="o">&gt;</span><span class="nv">publishing</span><span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">when</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">otherwise</span><span class="o">&gt;</span><span class="nv">playing</span><span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">otherwise</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">choose</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">template</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">template</span> <span class="nv">match</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">client</span><span class="s2">&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nv">tr</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">attribute</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">bgcolor</span><span class="s2">&quot;</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">choose</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">when</span> <span class="nv">test</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">publishing</span><span class="s2">&quot;</span><span class="o">&gt;</span>#<span class="nv">cccccc</span><span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">when</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">otherwise</span><span class="o">&gt;</span>#<span class="nv">eeeeee</span><span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">otherwise</span><span class="o">&gt;</span>
            <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">choose</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">attribute</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">id</span><span class="s2">&quot;</span><span class="o">/&gt;&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;&lt;</span><span class="nv">xsl</span>:<span class="nv">call</span><span class="o">-</span><span class="nv">template</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">clientstate</span><span class="s2">&quot;</span><span class="o">/&gt;&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">a</span> <span class="nv">target</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">_blank</span><span class="s2">&quot;</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">attribute</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">href</span><span class="s2">&quot;</span><span class="o">&gt;</span>
                    <span class="nv">http</span>:<span class="o">//</span><span class="nv">apps</span>.<span class="nv">db</span>.<span class="nv">ripe</span>.<span class="nv">net</span><span class="o">/</span><span class="nv">search</span><span class="o">/</span><span class="nv">query</span>.<span class="nv">html</span><span class="o">&amp;</span><span class="sc">#63</span><span class="c1">;searchtext=&lt;xsl:value-of select=&quot;address&quot;/&gt;</span>
                <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">attribute</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">attribute</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">title</span><span class="s2">&quot;</span><span class="o">&gt;</span><span class="nv">whois</span><span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">attribute</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">address</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
            <span class="o">&lt;/</span><span class="nv">a</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">flashver</span><span class="s2">&quot;</span><span class="o">/&gt;&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">a</span> <span class="nv">target</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">_blank</span><span class="s2">&quot;</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">attribute</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">href</span><span class="s2">&quot;</span><span class="o">&gt;</span>
                    <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">pageurl</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
                <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">attribute</span><span class="o">&gt;</span>
                <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">pageurl</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
            <span class="o">&lt;/</span><span class="nv">a</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">swfurl</span><span class="s2">&quot;</span><span class="o">/&gt;&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">dropped</span><span class="s2">&quot;</span><span class="o">/&gt;&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">timestamp</span><span class="s2">&quot;</span><span class="o">/&gt;&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">avsync</span><span class="s2">&quot;</span><span class="o">/&gt;&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nv">td</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">call</span><span class="o">-</span><span class="nv">template</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">showtime</span><span class="s2">&quot;</span><span class="o">&gt;</span>
               <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">with</span><span class="o">-</span><span class="nv">param</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">time</span><span class="s2">&quot;</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">time</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
            <span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">call</span><span class="o">-</span><span class="nv">template</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="nv">td</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="nv">tr</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">template</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">template</span> <span class="nv">match</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">publishing</span><span class="s2">&quot;</span><span class="o">&gt;</span>
    <span class="nv">publishing</span>
<span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">template</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">template</span> <span class="nv">match</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">active</span><span class="s2">&quot;</span><span class="o">&gt;</span>
    <span class="nv">active</span>
<span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">template</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">template</span> <span class="nv">match</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">width</span><span class="s2">&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">.</span><span class="s2">&quot;</span><span class="o">/&gt;</span><span class="nv">x</span><span class="o">&lt;</span><span class="nv">xsl</span>:<span class="nv">value</span><span class="o">-</span><span class="nv">of</span> <span class="nv">select</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">../height</span><span class="s2">&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">template</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="nv">xsl</span>:<span class="nv">stylesheet</span><span class="o">&gt;</span>
</pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../python-other/" title="python-other" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                python-other
              </span>
            </div>
          </a>
        
        
          <a href="../nginx2/" title="nginx2" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                nginx2
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>