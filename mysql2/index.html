



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>mysql2 - mkdocs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.30686662.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#_1" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="mkdocs" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              mkdocs
            </span>
            <span class="md-header-nav__topic">
              
                mysql2
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href=".." class="md-tabs__link">
        home
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../python-base/" class="md-tabs__link">
          python
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../nginx/" class="md-tabs__link">
          service
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../mysql/" class="md-tabs__link md-tabs__link--active">
          database
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../open-falcon/" class="md-tabs__link">
          monitor
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../tcp-issue/" class="md-tabs__link">
          basis
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="mkdocs" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    mkdocs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="home" class="md-nav__link">
      home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      python
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        python
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../python-base/" title="python-base" class="md-nav__link">
      python-base
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-lib/" title="python-lib" class="md-nav__link">
      python-lib
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-lib2/" title="python-lib2" class="md-nav__link">
      python-lib2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-web/" title="python-web" class="md-nav__link">
      python-web
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python-other/" title="python-other" class="md-nav__link">
      python-other
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      service
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        service
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../nginx/" title="nginx" class="md-nav__link">
      nginx
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../nginx2/" title="nginx2" class="md-nav__link">
      nginx2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../apache/" title="apache" class="md-nav__link">
      apache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../saltstack/" title="saltstack" class="md-nav__link">
      saltstack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tomcat/" title="tomcat" class="md-nav__link">
      tomcat
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ansible/" title="ansible" class="md-nav__link">
      ansible
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../trafficserver/" title="trafficserver" class="md-nav__link">
      trafficserver
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../haproxy/" title="haproxy" class="md-nav__link">
      haproxy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../docker/" title="docker" class="md-nav__link">
      docker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../varnish/" title="varnish" class="md-nav__link">
      varnish
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../bind/" title="bind" class="md-nav__link">
      bind
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lvs/" title="lvs" class="md-nav__link">
      lvs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../log-analysis/" title="log-analysis" class="md-nav__link">
      log-analysis
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      database
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        database
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../mysql/" title="mysql" class="md-nav__link">
      mysql
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        mysql2
      </label>
    
    <a href="./" title="mysql2" class="md-nav__link md-nav__link--active">
      mysql2
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    用户
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#explain" class="md-nav__link">
    explain用法
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gtid" class="md-nav__link">
    gtid主从
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#xtrabackup" class="md-nav__link">
    xtrabackup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#myisam-innodb" class="md-nav__link">
    MyISAM InnoDB
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mysql" class="md-nav__link">
    MySQL优化三板斧
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mycat" class="md-nav__link">
    mycat
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sql" class="md-nav__link">
    常用sql
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    中间件对比
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#atlas_keepalived" class="md-nav__link">
    atlas_keepalived
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mycnf" class="md-nav__link">
    my.cnf
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../memcached/" title="memcached" class="md-nav__link">
      memcached
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../redis/" title="redis" class="md-nav__link">
      redis
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mongodb/" title="mongodb" class="md-nav__link">
      mongodb
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../hadoop/" title="hadoop" class="md-nav__link">
      hadoop
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../postgresql/" title="postgresql" class="md-nav__link">
      postgresql
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      monitor
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        monitor
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../open-falcon/" title="open-falcon" class="md-nav__link">
      open-falcon
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zabbix/" title="zabbix" class="md-nav__link">
      zabbix
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../zabbix2/" title="zabbix2" class="md-nav__link">
      zabbix2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../netdata/" title="netdata" class="md-nav__link">
      netdata
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      basis
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        basis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../tcp-issue/" title="tcp-issue" class="md-nav__link">
      tcp-issue
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../git-svn/" title="git-svn" class="md-nav__link">
      git-svn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../vpn/" title="vpn" class="md-nav__link">
      vpn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../shell/" title="shell" class="md-nav__link">
      shell
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../disk/" title="disk" class="md-nav__link">
      disk
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../filesystem/" title="filesystem" class="md-nav__link">
      filesystem
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../source/" title="source" class="md-nav__link">
      source
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../command/" title="command" class="md-nav__link">
      command
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../linux-base/" title="linux-base" class="md-nav__link">
      linux-base
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../linux-soft/" title="linux-soft" class="md-nav__link">
      linux-soft
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../other/" title="other" class="md-nav__link">
      other
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    用户
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#explain" class="md-nav__link">
    explain用法
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gtid" class="md-nav__link">
    gtid主从
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#xtrabackup" class="md-nav__link">
    xtrabackup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#myisam-innodb" class="md-nav__link">
    MyISAM InnoDB
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mysql" class="md-nav__link">
    MySQL优化三板斧
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mycat" class="md-nav__link">
    mycat
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sql" class="md-nav__link">
    常用sql
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    中间件对比
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#atlas_keepalived" class="md-nav__link">
    atlas_keepalived
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mycnf" class="md-nav__link">
    my.cnf
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>mysql2</h1>
                
                <h2 id="_1">用户</h2>
<div class="codehilite"><pre><span></span><span class="n">delete</span> <span class="n">from</span> <span class="n">mysql</span><span class="p">.</span><span class="n">user</span> <span class="n">where</span> <span class="n">user</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">;</span>  <span class="err">删除匿名用户</span>
<span class="n">set</span> <span class="n">password</span><span class="o">=</span><span class="n">PASSWORD</span><span class="p">(</span><span class="err">&#39;</span><span class="n">pass</span><span class="err">&#39;</span><span class="p">);</span>      <span class="err">设置登录密码</span>
<span class="n">FLUSH</span> <span class="n">PRIVILEGES</span><span class="p">;</span>


<span class="n">create</span> <span class="n">user</span> <span class="n">sky</span><span class="p">;</span>
<span class="n">select</span> <span class="n">host</span><span class="p">,</span><span class="n">user</span><span class="p">,</span><span class="n">password</span> <span class="n">from</span> <span class="n">mysql</span><span class="p">.</span><span class="n">user</span><span class="p">;</span>
<span class="err">可以看到</span><span class="n">sky</span><span class="err">用户信息</span>

<span class="n">drop</span> <span class="n">user</span> <span class="n">sky</span><span class="p">;</span>
<span class="n">select</span> <span class="n">host</span><span class="p">,</span><span class="n">user</span><span class="p">,</span><span class="n">password</span> <span class="n">from</span> <span class="n">mysql</span><span class="p">.</span><span class="n">user</span>
<span class="err">可以看到</span><span class="n">sky</span><span class="err">用户信息没了</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="o">?</span> <span class="n">create</span> <span class="n">user</span>  <span class="err">看帮助</span>

<span class="n">mysql</span><span class="o">&gt;</span><span class="n">create</span> <span class="n">user</span> <span class="n">sky</span> <span class="n">identified</span> <span class="n">by</span> <span class="s">&quot;123&quot;</span><span class="p">;</span>

<span class="err">查看某个用户的权限</span>
<span class="n">show</span> <span class="n">grants</span> <span class="k">for</span> <span class="err">&#39;</span><span class="n">sky</span><span class="sc">&#39;@&#39;</span><span class="o">%</span><span class="err">&#39;</span><span class="p">;</span>
<span class="n">USAGE</span> <span class="err">权限最小</span>
<span class="o">%</span><span class="err">代表所有机器</span><span class="n">IP</span>

<span class="err">提权</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">grant</span> <span class="n">select</span> <span class="n">on</span> <span class="n">vfast</span><span class="p">.</span><span class="o">*</span> <span class="n">to</span> <span class="s">&quot;sky&quot;@&quot;%&quot;</span><span class="p">;</span>

<span class="err">回收权限</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">revoke</span> <span class="n">select</span> <span class="n">on</span> <span class="n">vfast</span><span class="p">.</span><span class="o">*</span> <span class="n">from</span> <span class="s">&quot;sky&quot;@&quot;%&quot;</span>

<span class="n">lab</span>
<span class="err">同一用户，不同</span><span class="n">IP</span><span class="err">，不同或相同密码，对某一库的权限不同</span>

<span class="err">删除一个用户例子</span>
<span class="n">revoke</span> <span class="n">all</span> <span class="n">privileges</span>  <span class="n">on</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="n">from</span> <span class="s">&quot;rhce&quot;@&quot;192.168.18.234&quot;</span><span class="p">;</span>
<span class="n">drop</span> <span class="n">user</span> <span class="s">&quot;rhce&quot;@&quot;192.168.18.234&quot;</span><span class="p">;</span>

<span class="err">给</span><span class="mf">192.168.18.234</span><span class="err">这台机器登陆</span><span class="n">mysql</span><span class="err">对</span><span class="n">VFAST</span><span class="err">库的操作是只读（</span><span class="n">select</span><span class="err">）权限</span>
<span class="n">grant</span> <span class="n">select</span> <span class="n">on</span> <span class="n">vfast</span><span class="p">.</span><span class="o">*</span> <span class="n">to</span> <span class="s">&quot;sky&quot;@&quot;192.168.18.234&quot;</span> <span class="n">identified</span> <span class="n">by</span> <span class="s">&quot;123&quot;</span><span class="p">;</span>

<span class="err">给</span><span class="mf">192.168.18.200</span><span class="err">这台机器登陆</span><span class="n">mysql</span><span class="err">对</span><span class="n">VFAST</span><span class="err">库的操作是</span><span class="n">select</span><span class="p">,</span><span class="n">insert</span><span class="p">,</span><span class="n">delete</span><span class="p">,</span><span class="n">update</span><span class="err">权限</span>
<span class="n">grant</span> <span class="n">select</span><span class="p">,</span><span class="n">insert</span><span class="p">,</span><span class="n">delete</span><span class="p">,</span><span class="n">update</span> <span class="n">on</span> <span class="n">vfast</span><span class="p">.</span><span class="o">*</span> <span class="n">to</span> <span class="s">&quot;sky&quot;@&quot;192.168.18.200&quot;</span><span class="n">identified</span> <span class="n">by</span> <span class="s">&quot;123&quot;</span><span class="p">;</span>

<span class="n">select</span> <span class="n">host</span><span class="p">,</span><span class="n">password</span><span class="p">,</span><span class="n">user</span> <span class="n">from</span> <span class="n">user</span><span class="p">;</span>



<span class="err">测试在</span><span class="mf">192.168.18.234</span><span class="err">上登陆</span><span class="n">mysql</span>

<span class="n">mysql</span> <span class="o">-</span><span class="n">h</span> <span class="mf">192.168.18.254</span> <span class="o">-</span><span class="n">u</span> <span class="n">sky</span> <span class="o">-</span><span class="n">p123</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">use</span> <span class="n">vfast</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">insert</span> <span class="n">into</span> <span class="n">H1</span> <span class="n">values</span><span class="p">(</span><span class="mo">00</span><span class="p">);</span>
<span class="err">正确提示</span>  <span class="err">拒绝插入</span>

<span class="err">在</span><span class="mf">192.168.18.200</span><span class="err">上登陆</span><span class="n">mysql</span>

<span class="n">mysql</span> <span class="o">-</span><span class="n">h</span> <span class="mf">192.168.18.254</span> <span class="o">-</span><span class="n">u</span> <span class="n">sky</span> <span class="o">-</span><span class="n">p123</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">databases</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">insert</span> <span class="n">into</span> <span class="n">H1</span> <span class="n">values</span><span class="p">(</span><span class="mo">00</span><span class="p">);</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">delete</span> <span class="n">from</span> <span class="n">H1</span> <span class="n">where</span> <span class="kt">id</span><span class="o">=</span><span class="mo">00</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">update</span> <span class="n">H1</span> <span class="n">set</span> <span class="kt">id</span><span class="o">=</span><span class="mi">16</span> <span class="n">where</span> <span class="kt">id</span><span class="o">=</span><span class="mi">17</span><span class="p">;</span>  <span class="err">将</span><span class="n">ID</span><span class="o">=</span><span class="mi">17</span><span class="err">改为等于</span><span class="mi">16</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">H1</span><span class="p">;</span>
<span class="err">以上命令都可以正常执行成功</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">drop</span> <span class="n">table</span> <span class="n">H1</span><span class="p">;</span>  <span class="err">执行不成功</span>  <span class="err">没权限</span>

<span class="o">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="err">权限中全局最大</span>

<span class="n">GRANT</span> <span class="n">ALL</span> <span class="n">PRIVILEGES</span> <span class="n">ON</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="n">TO</span> <span class="err">&#39;</span><span class="n">kyo</span><span class="sc">&#39;@&#39;</span><span class="o">%</span><span class="err">&#39;</span> <span class="n">identified</span> <span class="n">by</span> <span class="err">&#39;</span><span class="mi">123</span><span class="err">&#39;</span><span class="p">;</span>
<span class="n">flush</span> <span class="n">privileges</span>  <span class="err">刷新权限</span>
<span class="n">ALL</span> <span class="n">PRIVILEGES</span> <span class="err">所有权限</span>
<span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="err">所有库的所有表</span>
<span class="n">kyo</span> <span class="err">登陆用户，</span><span class="o">%</span><span class="err">允许登陆的</span><span class="n">IP</span> <span class="err">其代表所有</span>

<span class="err">‘</span><span class="mi">123</span><span class="err">’</span> <span class="err">登陆密码</span>

<span class="err">登陆后能干什么</span>
<span class="n">select</span>  <span class="err">查看</span>
<span class="n">ALL</span> <span class="n">PRIVILEGES</span>  <span class="err">所有权限</span>

<span class="err">权限指定符</span> <span class="err">权限允许的操作</span> 
<span class="err">　　</span><span class="n">Alter</span> <span class="err">　　　　　　修改表和索引</span> 
<span class="err">　　</span><span class="n">Create</span> <span class="err">　　　　</span> <span class="err">创建数据库和表</span> 
<span class="err">　　</span><span class="n">Delete</span> <span class="err">　　　　</span> <span class="err">删除表中已有的记录</span> 
<span class="err">　　</span><span class="n">Drop</span> <span class="err">　　</span> <span class="err">抛弃（删除）数据库和表</span> 
<span class="err">　　</span><span class="n">INDEX</span> <span class="err">　　　　</span> <span class="err">创建或抛弃索引</span> 
<span class="err">　　</span><span class="n">Insert</span> <span class="err">　　　　</span> <span class="err">向表中插入新行</span> 
<span class="err">　　</span><span class="n">REFERENCE</span> <span class="err">　　未用</span> 
<span class="err">　　</span><span class="n">Select</span><span class="err">　　　　</span> <span class="err">检索表中的记录</span> 
<span class="err">　　</span><span class="n">Update</span> <span class="err">　　　　</span> <span class="err">修改现存表记录</span> 
<span class="err">　　</span><span class="kt">FILE</span> <span class="err">　　　　　　读或写服务器上的文件</span> 
<span class="err">　　</span><span class="n">PROCESS</span> <span class="err">　　</span> <span class="err">查看服务器中执行的线程信息或杀死线程</span> 
<span class="err">　　</span><span class="n">RELOAD</span> <span class="err">　　　　重载授权表或清空日志、主机缓存或表缓存。</span> 
<span class="err">　　</span><span class="n">SHUTDOWN</span><span class="err">　　</span> <span class="err">关闭服务器</span> 
<span class="err">　　</span><span class="n">ALL</span> <span class="err">　　　　　　所有；</span><span class="n">ALL</span> <span class="n">PRIVILEGES</span><span class="err">同义词</span> 
<span class="err">　　</span><span class="n">USAGE</span> <span class="err">　　　　特殊的“无权限”权限</span>

<span class="err">权限涉及三个表</span>
<span class="n">mysql</span><span class="p">.</span><span class="n">user</span>
<span class="n">mysql</span><span class="p">.</span><span class="n">db</span>
<span class="n">mysql</span><span class="p">.</span><span class="n">tables_orive</span>

 <span class="err">删除权限</span>
<span class="n">revoke</span> <span class="n">all</span> <span class="n">privileges</span> <span class="n">on</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="n">from</span> <span class="err">&#39;</span><span class="n">kyo</span><span class="sc">&#39;@&#39;</span><span class="o">%</span><span class="err">&#39;</span><span class="p">;</span>

<span class="n">show</span> <span class="n">grants</span> <span class="k">for</span> <span class="err">&#39;</span><span class="n">kyo</span><span class="sc">&#39;@&#39;</span><span class="o">%</span><span class="err">&#39;</span><span class="p">;</span>
<span class="n">USAGE</span> <span class="err">权限最小</span>

<span class="err">忘记密码怎么办</span>
<span class="err">方法一</span>
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">convirt</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span> 
<span class="n">skip</span><span class="o">-</span><span class="n">grant</span><span class="o">-</span><span class="n">tables</span>   <span class="err">#本地和远程登陆不管用户是谁都可以跳过密码</span>
<span class="err">重启</span><span class="n">mysql</span> 

<span class="err">直接不用密码登陆</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">flush</span> <span class="n">privileges</span> <span class="p">;</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">GRANT</span> <span class="n">ALL</span> <span class="n">PRIVILEGES</span> <span class="n">ON</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="n">TO</span> <span class="err">&#39;</span><span class="n">root</span><span class="sc">&#39;@&#39;</span><span class="n">localhost</span><span class="err">&#39;</span> <span class="n">identified</span> <span class="n">by</span> <span class="err">&#39;&#39;</span><span class="p">;</span>  <span class="n">password</span> <span class="n">is</span> <span class="n">null</span>

<span class="cp">##方法二测试不成功</span>
<span class="n">mysqld_safe</span> <span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">grant</span><span class="o">-</span><span class="n">tables</span>
<span class="err">即可跳过密码验证文件登陆（本地和远程都可以）</span>
            <span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">networking</span>   <span class="err">网络不可以登陆只能本地</span>
<span class="err">改口令</span>
<span class="n">update</span> <span class="n">mysql</span><span class="p">.</span><span class="n">user</span> <span class="n">set</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">(</span><span class="err">&#39;</span><span class="mi">456</span><span class="err">&#39;</span><span class="p">)</span> <span class="n">where</span> <span class="n">user</span><span class="o">=</span><span class="err">“</span><span class="n">kyo</span><span class="err">”</span> <span class="n">and</span> <span class="n">host</span><span class="o">=</span><span class="err">“</span><span class="n">localhost</span><span class="err">”</span><span class="p">;</span>
<span class="n">password</span><span class="p">(</span><span class="err">&#39;</span><span class="mi">456</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">kyo</span><span class="p">@</span><span class="n">localhost</span><span class="err">的密码改为</span><span class="mi">456</span>

<span class="n">password</span> <span class="err">是将密码</span><span class="mi">456</span><span class="err">加密</span>


<span class="err">如何下线未知用户</span>
<span class="err">查看谁在登陆数据库</span>
<span class="n">show</span> <span class="n">full</span> <span class="n">processlist</span> <span class="err">可以看到进程</span><span class="n">ID</span>
<span class="err">改掉该用户的密码</span>  <span class="err">然后刷新生效</span> <span class="err">杀死其登陆进程。对方就会被踢下线，在连接密码错误，无法登陆。</span>
<span class="n">kill</span> <span class="err">$</span><span class="n">ID</span> <span class="err">杀死用户登陆</span><span class="n">ID</span> <span class="err">强迫其重新登陆</span>
</pre></div>


<h2 id="explain">explain用法</h2>
<div class="codehilite"><pre><span></span><span class="nv">explain</span>显示了<span class="nv">mysql</span>如何使用索引来处理<span class="nv">select</span>语句以及连接表。可以帮助选择更好的索引和写出更优化的查询语句。

使用方法，在<span class="nv">select</span>语句前加上<span class="nv">explain</span>就可以了，如：

<span class="nv">explain</span> <span class="nv">select</span> <span class="o">*</span> <span class="nv">from</span> <span class="nv">statuses_status</span> <span class="nv">where</span> <span class="nv">id</span><span class="o">=</span><span class="mi">11</span><span class="c1">;</span>


<span class="nv">explain</span>列的解释
<span class="nv">table</span>：显示这一行的数据是关于哪张表的

<span class="nv">type</span>：这是重要的列，显示连接使用了何种类型。从最好到最差的连接类型为<span class="nv">const</span>、<span class="nv">eq_reg</span>、<span class="nv">ref</span>、<span class="nv">range</span>、<span class="nv">indexhe</span>和<span class="nv">all</span>

<span class="nv">possible_keys</span>：显示可能应用在这张表中的索引。如果为空，没有可能的索引。可以为相关的域从<span class="nv">where</span>语句中选择一个合适的语句

<span class="nv">key</span>： 实际使用的索引。如果为<span class="nv">null</span>，则没有使用索引。很少的情况下，<span class="nv">mysql</span>会选择优化不足的索引。这种情况下，可以在<span class="nv">select</span>语句中
使用<span class="nv">use</span> <span class="nv">index</span>（<span class="nv">indexname</span>）来强制使用一个索引或者用<span class="nv">ignore</span> <span class="nv">index</span>（<span class="nv">indexname</span>）来强制<span class="nv">mysql</span>忽略索引

<span class="nv">key_len</span>：使用的索引的长度。在不损失精确性的情况下，长度越短越好

<span class="nv">ref</span>：显示索引的哪一列被使用了，如果可能的话，是一个常数

<span class="nv">rows</span>：<span class="nv">mysql</span>认为必须检查的用来返回请求数据的行数

<span class="nv">extra</span>：关于<span class="nv">mysql</span>如何解析查询的额外信息。将在表<span class="mi">4</span>.<span class="mi">3</span>中讨论，但这里可以看到的坏的例子是<span class="nv">using</span> <span class="nv">temporary</span>和<span class="nv">using</span> <span class="nv">filesort</span>，
意思<span class="nv">mysql</span>根本不能使用索引，结果是检索会很慢


<span class="nv">extra</span>列返回的描述的意义

<span class="nv">distinct</span>:一旦<span class="nv">mysql</span>找到了与行相联合匹配的行，就不再搜索了

<span class="nv">not</span> <span class="nv">exists</span>: <span class="nv">mysql</span>优化了<span class="nv">left</span> <span class="nv">join</span>，一旦它找到了匹配<span class="nv">left</span> <span class="nv">join</span>标准的行，就不再搜索了

<span class="nv">range</span> <span class="nv">checked</span> <span class="k">for</span> <span class="nv">each</span> <span class="nv">record</span>（<span class="nv">index</span> <span class="nv">map</span>:#）:没有找到理想的索引，因此对于从前面表中来的每一个行组合，<span class="nv">mysql</span>检查使用哪个
索引，并用它来从表中返回行。这是使用索引的最慢的连接之一

<span class="nv">using</span> <span class="nv">filesort</span>: 看到这个的时候，查询就需要优化了。<span class="nv">mysql</span>需要进行额外的步骤来发现如何对返回的行排序。它根据连接类型以及存储
排序键值和匹配条件的全部行的行指针来排序全部行

<span class="nv">using</span> <span class="nv">index</span>: 列数据是从仅仅使用了索引中的信息而没有读取实际的行动的表返回的，这发生在对表的全部的请求列都是同一个索引的部
分的时候

<span class="nv">using</span> <span class="nv">temporary</span> 看到这个的时候，查询需要优化了。这里，<span class="nv">mysql</span>需要创建一个临时表来存储结果，这通常发生在对不同的列集进行
<span class="nv">order</span> <span class="nv">by</span>上，而不是<span class="nv">group</span> <span class="nv">by</span>上

<span class="nv">where</span> <span class="nv">used</span> 使用了<span class="nv">where</span>从句来限制哪些行将与下一张表匹配或者是返回给用户。如果不想返回表中的全部行，并且连接类型<span class="nv">all</span>或<span class="nv">index</span>，
这就会发生，或者是查询有问题不同连接类型的解释（按照效率高低的顺序排序）

<span class="nv">system</span> 表只有一行：<span class="nv">system</span>表。这是<span class="nv">const</span>连接类型的特殊情况

<span class="nv">const</span>:表中的一个记录的最大值能够匹配这个查询（索引可以是主键或惟一索引）。因为只有一行，这个值实际就是常数，因为<span class="nv">mysql</span>先读
这个值然后把它当做常数来对待

<span class="nv">eq_ref</span>:在连接中，<span class="nv">mysql</span>在查询时，从前面的表中，对每一个记录的联合都从表中读取一个记录，它在查询使用了索引为主键或惟一键的
全部时使用

<span class="nv">ref</span>:这个连接类型只有在查询使用了不是惟一或主键的键或者是这些类型的部分（比如，利用最左边前缀）时发生。对于之前的表的每一个
行联合，全部记录都将从表中读出。这个类型严重依赖于根据索引匹配的记录多少—越少越好

<span class="nv">range</span>:这个连接类型使用索引返回一个范围中的行，比如使用<span class="o">&gt;</span>或<span class="o">&lt;</span>查找东西时发生的情况

<span class="nv">index</span>: 这个连接类型对前面的表中的每一个记录联合进行完全扫描（比<span class="nv">all</span>更好，因为索引一般小于表数据）

<span class="nv">all</span>:这个连接类型对于前面的每一个记录联合进行完全扫描，这一般比较糟糕，应该尽量避免
</pre></div>


<h2 id="gtid">gtid主从</h2>
<div class="codehilite"><pre><span></span><span class="n">MySQL</span> <span class="mf">5.6</span><span class="err">引入的</span><span class="n">GTID</span><span class="p">(</span><span class="n">Global</span> <span class="n">Transaction</span> <span class="n">IDs</span><span class="p">)</span><span class="err">使得其复制功能的配置、监控及管理变得更加易于实现，且更加健壮。</span>

<span class="err">要在</span><span class="n">MySQL</span> <span class="mf">5.6</span><span class="err">中使用复制功能，其服务配置段</span><span class="p">[</span><span class="n">mysqld</span><span class="p">]</span><span class="err">中于少应该定义如下选项：</span>

<span class="n">binlog</span><span class="o">-</span><span class="n">format</span><span class="err">：二进制日志的格式，有</span><span class="n">row</span><span class="err">、</span><span class="n">statement</span><span class="err">和</span><span class="n">mixed</span><span class="err">几种类型；</span>
    <span class="err">需要注意的是：当设置隔离级别为</span><span class="n">READ</span><span class="o">-</span><span class="n">COMMITED</span><span class="err">必须设置二进制日志格式为</span><span class="n">ROW</span><span class="err">，现在</span><span class="n">MySQL</span><span class="err">官方认为</span><span class="n">STATEMENT</span><span class="err">这个已经不</span>
    <span class="err">再适合继续使用；但</span><span class="n">mixed</span><span class="err">类型在默认的事务隔离级别下，可能会导致主从数据不一致；</span>
<span class="n">log</span><span class="o">-</span><span class="n">slave</span><span class="o">-</span><span class="n">updates</span><span class="err">、</span><span class="n">gtid</span><span class="o">-</span><span class="n">mode</span><span class="err">、</span><span class="n">enforce</span><span class="o">-</span><span class="n">gtid</span><span class="o">-</span><span class="n">consistency</span><span class="err">、</span><span class="n">report</span><span class="o">-</span><span class="n">port</span><span class="err">和</span><span class="n">report</span><span class="o">-</span><span class="n">host</span><span class="err">：用于启动</span><span class="n">GTID</span><span class="err">及满足附属的其它需求；</span>
<span class="n">master</span><span class="o">-</span><span class="n">info</span><span class="o">-</span><span class="n">repository</span><span class="err">和</span><span class="n">relay</span><span class="o">-</span><span class="n">log</span><span class="o">-</span><span class="n">info</span><span class="o">-</span><span class="n">repository</span><span class="err">：启用此两项，可用于实现在崩溃时保证二进制及从服务器安全的功能；</span>
<span class="n">sync</span><span class="o">-</span><span class="n">master</span><span class="o">-</span><span class="n">info</span><span class="err">：启用之可确保无信息丢失；</span>
<span class="n">slave</span><span class="o">-</span><span class="n">paralles</span><span class="o">-</span><span class="n">workers</span><span class="err">：设定从服务器的</span><span class="n">SQL</span><span class="err">线程数；</span><span class="mi">0</span><span class="err">表示关闭多线程复制功能；</span>
<span class="n">binlog</span><span class="o">-</span><span class="n">checksum</span><span class="err">、</span><span class="n">master</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="n">checksum</span><span class="err">和</span><span class="n">slave</span><span class="o">-</span><span class="n">sql</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="n">checksum</span><span class="err">：启用复制有关的所有校验功能；</span>
<span class="n">binlog</span><span class="o">-</span><span class="n">rows</span><span class="o">-</span><span class="n">query</span><span class="o">-</span><span class="n">log</span><span class="o">-</span><span class="n">events</span><span class="err">：启用之可用于在二进制日志记录事件相关的信息，可降低故障排除的复杂度；</span>
<span class="n">log</span><span class="o">-</span><span class="n">bin</span><span class="err">：启用二进制日志，这是保证复制功能的基本前提；</span>
<span class="n">server</span><span class="o">-</span><span class="kt">id</span><span class="err">：同一个复制拓扑中的所有服务器的</span><span class="kt">id</span><span class="err">号必须惟一；</span>


<span class="n">report</span><span class="o">-</span><span class="n">host</span><span class="err">：</span>
<span class="n">The</span> <span class="n">host</span> <span class="n">name</span> <span class="n">or</span> <span class="n">IP</span> <span class="n">address</span> <span class="n">of</span> <span class="n">the</span> <span class="n">slave</span> <span class="n">to</span> <span class="n">be</span> <span class="n">reported</span> <span class="n">to</span> <span class="n">the</span> <span class="n">master</span> <span class="n">during</span> <span class="n">slave</span> <span class="n">registration</span><span class="p">.</span> <span class="n">This</span> <span class="n">value</span> 
<span class="n">appears</span> <span class="k">in</span> <span class="n">the</span> <span class="n">output</span> <span class="n">of</span> <span class="n">SHOW</span> <span class="n">SLAVE</span> <span class="n">HOSTS</span> <span class="n">on</span> <span class="n">the</span> <span class="n">master</span> <span class="n">server</span><span class="p">.</span>

<span class="n">report</span><span class="o">-</span><span class="nl">port</span><span class="p">:</span>
<span class="n">The</span> <span class="n">TCP</span><span class="o">/</span><span class="n">IP</span> <span class="n">port</span> <span class="n">number</span> <span class="k">for</span> <span class="n">connecting</span> <span class="n">to</span> <span class="n">the</span> <span class="n">slave</span><span class="p">,</span> <span class="n">to</span> <span class="n">be</span> <span class="n">reported</span> <span class="n">to</span> <span class="n">the</span> <span class="n">master</span> <span class="n">during</span> <span class="n">slave</span> <span class="n">registration</span><span class="p">.</span>

<span class="n">master</span><span class="o">-</span><span class="n">info</span><span class="o">-</span><span class="nl">repository</span><span class="p">:</span>
<span class="n">The</span> <span class="n">setting</span> <span class="n">of</span> <span class="n">this</span> <span class="n">variable</span> <span class="n">determines</span> <span class="n">whether</span> <span class="n">the</span> <span class="n">slave</span> <span class="n">logs</span> <span class="n">master</span> <span class="n">status</span> <span class="n">and</span> <span class="n">connection</span> <span class="n">information</span> <span class="n">to</span> <span class="n">a</span> 
<span class="kt">FILE</span> <span class="p">(</span><span class="n">master</span><span class="p">.</span><span class="n">info</span><span class="p">),</span> <span class="n">or</span> <span class="n">to</span> <span class="n">a</span> <span class="n">TABLE</span> <span class="p">(</span><span class="n">mysql</span><span class="p">.</span><span class="n">slave_master_info</span><span class="p">)</span>

<span class="n">relay</span><span class="o">-</span><span class="n">log</span><span class="o">-</span><span class="n">info</span><span class="o">-</span><span class="n">repository</span><span class="err">：</span>
<span class="n">This</span> <span class="n">option</span> <span class="n">causes</span> <span class="n">the</span> <span class="n">server</span> <span class="n">to</span> <span class="n">log</span> <span class="n">its</span> <span class="n">relay</span> <span class="n">log</span> <span class="n">info</span> <span class="n">to</span> <span class="n">a</span> <span class="n">file</span> <span class="n">or</span> <span class="n">a</span> <span class="n">table</span><span class="p">.</span>

<span class="n">log_slave_updates</span><span class="err">：</span>
<span class="n">Whether</span> <span class="n">updates</span> <span class="n">received</span> <span class="n">by</span> <span class="n">a</span> <span class="n">slave</span> <span class="n">server</span> <span class="n">from</span> <span class="n">a</span> <span class="n">master</span> <span class="n">server</span> <span class="n">should</span> <span class="n">be</span> <span class="n">logged</span> <span class="n">to</span> <span class="n">the</span> <span class="n">slave</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">own</span> <span class="n">binary</span> 
<span class="n">log</span><span class="p">.</span> <span class="n">Binary</span> <span class="n">logging</span> <span class="n">must</span> <span class="n">be</span> <span class="n">enabled</span> <span class="n">on</span> <span class="n">the</span> <span class="n">slave</span> <span class="k">for</span> <span class="n">this</span> <span class="n">variable</span> <span class="n">to</span> <span class="n">have</span> <span class="n">any</span> <span class="n">effect</span><span class="p">.</span> 

 <span class="n">enforce_gtid_consistency</span><span class="err">：</span>




<span class="err">一、简单主从模式配置步骤</span>

<span class="mi">1</span><span class="err">、配置主从节点的服务配置文件</span>

<span class="mf">1.1</span><span class="err">、配置</span><span class="n">master</span><span class="err">节点：</span>
<span class="p">[</span><span class="n">mysqld</span><span class="p">]</span>
<span class="n">binlog</span><span class="o">-</span><span class="n">format</span><span class="o">=</span><span class="n">ROW</span>
<span class="n">log</span><span class="o">-</span><span class="n">bin</span><span class="o">=</span><span class="n">master</span><span class="o">-</span><span class="n">bin</span>
<span class="n">log</span><span class="o">-</span><span class="n">slave</span><span class="o">-</span><span class="n">updates</span><span class="o">=</span><span class="nb">true</span>
<span class="n">gtid</span><span class="o">-</span><span class="n">mode</span><span class="o">=</span><span class="n">on</span> 
<span class="n">enforce</span><span class="o">-</span><span class="n">gtid</span><span class="o">-</span><span class="n">consistency</span><span class="o">=</span><span class="nb">true</span>
<span class="n">master</span><span class="o">-</span><span class="n">info</span><span class="o">-</span><span class="n">repository</span><span class="o">=</span><span class="n">TABLE</span>
<span class="n">relay</span><span class="o">-</span><span class="n">log</span><span class="o">-</span><span class="n">info</span><span class="o">-</span><span class="n">repository</span><span class="o">=</span><span class="n">TABLE</span>
<span class="n">sync</span><span class="o">-</span><span class="n">master</span><span class="o">-</span><span class="n">info</span><span class="o">=</span><span class="mi">1</span>
<span class="n">slave</span><span class="o">-</span><span class="n">parallel</span><span class="o">-</span><span class="n">workers</span><span class="o">=</span><span class="mi">2</span>
<span class="n">binlog</span><span class="o">-</span><span class="n">checksum</span><span class="o">=</span><span class="n">CRC32</span>
<span class="n">master</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="n">checksum</span><span class="o">=</span><span class="mi">1</span>
<span class="n">slave</span><span class="o">-</span><span class="n">sql</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="n">checksum</span><span class="o">=</span><span class="mi">1</span>
<span class="n">binlog</span><span class="o">-</span><span class="n">rows</span><span class="o">-</span><span class="n">query</span><span class="o">-</span><span class="n">log_events</span><span class="o">=</span><span class="mi">1</span>
<span class="n">server</span><span class="o">-</span><span class="kt">id</span><span class="o">=</span><span class="mi">1</span>
<span class="n">report</span><span class="o">-</span><span class="n">port</span><span class="o">=</span><span class="mi">3306</span>
<span class="n">port</span><span class="o">=</span><span class="mi">3306</span>
<span class="n">datadir</span><span class="o">=/</span><span class="n">mydata</span><span class="o">/</span><span class="n">data</span>
<span class="n">socket</span><span class="o">=/</span><span class="n">tmp</span><span class="o">/</span><span class="n">mysql</span><span class="p">.</span><span class="n">sock</span>
<span class="n">report</span><span class="o">-</span><span class="n">host</span><span class="o">=</span><span class="n">master</span><span class="p">.</span><span class="n">magedu</span><span class="p">.</span><span class="n">com</span>

<span class="mf">1.2</span><span class="err">、配置</span><span class="n">slave</span><span class="err">节点：</span>
<span class="p">[</span><span class="n">mysqld</span><span class="p">]</span>
<span class="n">binlog</span><span class="o">-</span><span class="n">format</span><span class="o">=</span><span class="n">ROW</span>
<span class="n">log</span><span class="o">-</span><span class="n">slave</span><span class="o">-</span><span class="n">updates</span><span class="o">=</span><span class="nb">true</span>
<span class="n">gtid</span><span class="o">-</span><span class="n">mode</span><span class="o">=</span><span class="n">on</span> 
<span class="n">enforce</span><span class="o">-</span><span class="n">gtid</span><span class="o">-</span><span class="n">consistency</span><span class="o">=</span><span class="nb">true</span>
<span class="n">master</span><span class="o">-</span><span class="n">info</span><span class="o">-</span><span class="n">repository</span><span class="o">=</span><span class="n">TABLE</span>
<span class="n">relay</span><span class="o">-</span><span class="n">log</span><span class="o">-</span><span class="n">info</span><span class="o">-</span><span class="n">repository</span><span class="o">=</span><span class="n">TABLE</span>
<span class="n">sync</span><span class="o">-</span><span class="n">master</span><span class="o">-</span><span class="n">info</span><span class="o">=</span><span class="mi">1</span>
<span class="n">slave</span><span class="o">-</span><span class="n">parallel</span><span class="o">-</span><span class="n">workers</span><span class="o">=</span><span class="mi">2</span>
<span class="n">binlog</span><span class="o">-</span><span class="n">checksum</span><span class="o">=</span><span class="n">CRC32</span>
<span class="n">master</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="n">checksum</span><span class="o">=</span><span class="mi">1</span>
<span class="n">slave</span><span class="o">-</span><span class="n">sql</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="n">checksum</span><span class="o">=</span><span class="mi">1</span>
<span class="n">binlog</span><span class="o">-</span><span class="n">rows</span><span class="o">-</span><span class="n">query</span><span class="o">-</span><span class="n">log_events</span><span class="o">=</span><span class="mi">1</span>
<span class="n">server</span><span class="o">-</span><span class="kt">id</span><span class="o">=</span><span class="mi">11</span>
<span class="n">report</span><span class="o">-</span><span class="n">port</span><span class="o">=</span><span class="mi">3306</span>
<span class="n">port</span><span class="o">=</span><span class="mi">3306</span>
<span class="n">log</span><span class="o">-</span><span class="n">bin</span><span class="o">=</span><span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="p">.</span><span class="n">log</span>
<span class="n">datadir</span><span class="o">=/</span><span class="n">mydata</span><span class="o">/</span><span class="n">data</span>
<span class="n">socket</span><span class="o">=/</span><span class="n">tmp</span><span class="o">/</span><span class="n">mysql</span><span class="p">.</span><span class="n">sock</span>
<span class="n">report</span><span class="o">-</span><span class="n">host</span><span class="o">=</span><span class="n">slave</span><span class="p">.</span><span class="n">magedu</span><span class="p">.</span><span class="n">com</span>

<span class="mi">2</span><span class="err">、创建复制用户</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">GRANT</span> <span class="n">REPLICATION</span> <span class="n">SLAVE</span> <span class="n">ON</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="n">TO</span> <span class="n">repluser</span><span class="mf">@172.16.100.7</span> <span class="n">IDENTIFIED</span> <span class="n">BY</span> <span class="err">&#39;</span><span class="n">replpass</span><span class="err">&#39;</span><span class="p">;</span>

<span class="err">说明：</span><span class="mf">172.16.100.7</span><span class="err">是从节点服务器；如果想一次性授权更多的节点，可以自行根据需要修改；</span>

<span class="mi">3</span><span class="err">、为备节点提供初始数据集</span>

<span class="err">锁定主表，备份主节点上的数据，将其还原至从节点；如果没有启用</span><span class="n">GTID</span><span class="err">，在备份时需要在</span><span class="n">master</span><span class="err">上使用</span><span class="n">show</span> <span class="n">master</span> <span class="n">status</span><span class="err">命令查看二</span>
<span class="err">进制日志文件名称及事件位置，以便后面启动</span><span class="n">slave</span><span class="err">节点时使用。</span>

<span class="mi">4</span><span class="err">、启动从节点的复制线程</span>

<span class="err">如果启用了</span><span class="n">GTID</span><span class="err">功能，则使用如下命令：</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">CHANGE</span> <span class="n">MASTER</span> <span class="n">TO</span> <span class="n">MASTER_HOST</span><span class="o">=</span><span class="err">&#39;</span><span class="n">master</span><span class="p">.</span><span class="n">magedu</span><span class="p">.</span><span class="n">com</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">MASTER_USER</span><span class="o">=</span><span class="err">&#39;</span><span class="n">repluser</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">MASTER_PASSWORD</span><span class="o">=</span><span class="err">&#39;</span><span class="n">replpass</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="n">MASTER_AUTO_POSITION</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>

<span class="err">没启用</span><span class="n">GTID</span><span class="err">，需要使用如下命令：</span>
<span class="n">slave</span><span class="o">&gt;</span> <span class="n">CHANGE</span> <span class="n">MASTER</span> <span class="n">TO</span> <span class="n">MASTER_HOST</span><span class="o">=</span><span class="err">&#39;</span><span class="mf">172.16.100.6</span><span class="err">&#39;</span><span class="p">,</span>
<span class="o">-&gt;</span> <span class="n">MASTER_USER</span><span class="o">=</span><span class="err">&#39;</span><span class="n">repluser</span><span class="err">&#39;</span><span class="p">,</span>
<span class="o">-&gt;</span> <span class="n">MASTER_PASSWORD</span><span class="o">=</span><span class="err">&#39;</span><span class="n">replpass</span><span class="err">&#39;</span><span class="p">,</span>
<span class="o">-&gt;</span> <span class="n">MASTER_LOG_FILE</span><span class="o">=</span><span class="err">&#39;</span><span class="n">master</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000003</span><span class="err">&#39;</span><span class="p">,</span>
<span class="o">-&gt;</span> <span class="n">MASTER_LOG_POS</span><span class="o">=</span><span class="mi">1174</span><span class="p">;</span>

<span class="err">二、半同步复制</span>

<span class="mi">1</span><span class="err">、分别在主从节点上安装相关的插件</span>

<span class="n">master</span><span class="o">&gt;</span> <span class="n">INSTALL</span> <span class="n">PLUGIN</span> <span class="n">rpl_semi_sync_master</span> <span class="n">SONAME</span> <span class="err">&#39;</span><span class="n">semisync_master</span><span class="p">.</span><span class="n">so</span><span class="err">&#39;</span><span class="p">;</span>
<span class="n">slave</span><span class="o">&gt;</span> <span class="n">INSTALL</span> <span class="n">PLUGIN</span> <span class="n">rpl_semi_sync_slave</span> <span class="n">SONAME</span> <span class="err">&#39;</span><span class="n">semisync_slave</span><span class="p">.</span><span class="n">so</span><span class="err">&#39;</span><span class="p">;</span>

<span class="mi">2</span><span class="err">、启用半同步复制</span>

<span class="err">在</span><span class="n">master</span><span class="err">上的配置文件中，添加</span>
<span class="n">rpl_semi_sync_master_enabled</span><span class="o">=</span><span class="n">ON</span>

<span class="err">在至少一个</span><span class="n">slave</span><span class="err">节点的配置文件中添加</span>
<span class="n">rpl_semi_sync_slave_enabled</span><span class="o">=</span><span class="n">ON</span>

<span class="err">而后重新启动</span><span class="n">mysql</span><span class="err">服务即可生效。</span>


<span class="err">或者，也可以</span><span class="n">mysql</span><span class="err">服务上动态启动其相关功能：</span>

<span class="n">master</span><span class="o">&gt;</span> <span class="n">SET</span> <span class="n">GLOBAL</span> <span class="n">rpl_semi_sync_master_enabled</span> <span class="o">=</span> <span class="n">ON</span><span class="p">;</span>
<span class="n">slave</span><span class="o">&gt;</span> <span class="n">SET</span> <span class="n">GLOBAL</span> <span class="n">rpl_semi_sync_slave_enabled</span> <span class="o">=</span> <span class="n">ON</span><span class="p">;</span>
<span class="n">slave</span><span class="o">&gt;</span> <span class="n">STOP</span> <span class="n">SLAVE</span> <span class="n">IO_THREAD</span><span class="p">;</span> <span class="n">START</span> <span class="n">SLAVE</span> <span class="n">IO_THREAD</span><span class="p">;</span>

<span class="mi">3</span><span class="err">、确认半同步功能已经启用</span>

<span class="n">master</span><span class="o">&gt;</span> <span class="n">CREATE</span> <span class="n">DATABASE</span> <span class="n">magedudb</span><span class="p">;</span>
<span class="n">master</span><span class="o">&gt;</span> <span class="n">SHOW</span> <span class="n">STATUS</span> <span class="n">LIKE</span> <span class="err">&#39;</span><span class="n">Rpl_semi_sync_master_yes_tx</span><span class="err">&#39;</span><span class="p">;</span>

<span class="n">slave</span><span class="o">&gt;</span> <span class="n">SHOW</span> <span class="n">DATABASES</span><span class="p">;</span>
</pre></div>


<h2 id="xtrabackup">xtrabackup</h2>
<div class="codehilite"><pre><span></span>使用<span class="nv">Xtrabackup</span>进行<span class="nv">MySQL</span>备份：

一、安装

<span class="mi">1</span>、简介
<span class="nv">Xtrabackup</span>是由<span class="nv">percona</span>提供的<span class="nv">mysql</span>数据库备份工具，据官方介绍，这也是世界上惟一一款开源的能够对<span class="nv">innodb</span>和<span class="nv">xtradb</span>数据库进行热备
的工具。特点：
<span class="ss">(</span><span class="mi">1</span><span class="ss">)</span>备份过程快速、可靠；
<span class="ss">(</span><span class="mi">2</span><span class="ss">)</span>备份过程不会打断正在执行的事务；
<span class="ss">(</span><span class="mi">3</span><span class="ss">)</span>能够基于压缩等功能节约磁盘空间和流量；
<span class="ss">(</span><span class="mi">4</span><span class="ss">)</span>自动实现备份检验；
<span class="ss">(</span><span class="mi">5</span><span class="ss">)</span>还原速度快；

<span class="mi">2</span>、安装
其最新版的软件可从 <span class="nv">http</span>:<span class="o">//</span><span class="nv">www</span>.<span class="nv">percona</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">software</span><span class="o">/</span><span class="nv">percona</span><span class="o">-</span><span class="nv">xtrabackup</span><span class="o">/</span> 获得。本文基于<span class="nv">RHEL5</span>.<span class="mi">8</span>的系统，因此，直接下载相
应版本的<span class="nv">rpm</span>包安装即可，这里不再演示其过程。
<span class="nv">wget</span> <span class="nv">https</span>:<span class="o">//</span><span class="nv">www</span>.<span class="nv">percona</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">downloads</span><span class="o">/</span><span class="nv">XtraBackup</span><span class="o">/</span><span class="nv">Percona</span><span class="o">-</span><span class="nv">XtraBackup</span><span class="o">-</span><span class="mi">2</span>.<span class="mi">4</span>.<span class="mi">8</span><span class="o">/</span><span class="nv">binary</span><span class="o">/</span><span class="nv">redhat</span><span class="o">/</span><span class="mi">6</span><span class="o">/</span><span class="nv">x86_64</span><span class="o">/</span><span class="nv">percona</span><span class="o">-</span>
<span class="nv">xtrabackup</span><span class="o">-</span><span class="mi">24</span><span class="o">-</span><span class="mi">2</span>.<span class="mi">4</span>.<span class="mi">8</span><span class="o">-</span><span class="mi">1</span>.<span class="nv">el6</span>.<span class="nv">x86_64</span>.<span class="nv">rpm</span>
<span class="nv">yum</span> <span class="nv">install</span> <span class="nv">libev</span> <span class="o">-</span><span class="nv">y</span>
<span class="nv">rpm</span> <span class="o">-</span><span class="nv">ivh</span> <span class="nv">percona</span><span class="o">-</span><span class="nv">xtrabackup</span><span class="o">-</span><span class="mi">24</span><span class="o">-</span><span class="mi">2</span>.<span class="mi">4</span>.<span class="mi">8</span><span class="o">-</span><span class="mi">1</span>.<span class="nv">el6</span>.<span class="nv">x86_64</span>.<span class="nv">rpm</span>


二、备份的实现

<span class="mi">1</span>、完全备份

# <span class="nv">innobackupex</span> <span class="o">--</span><span class="nv">user</span><span class="o">=</span><span class="nv">DBUSER</span> <span class="o">--</span><span class="nv">password</span><span class="o">=</span><span class="nv">DBUSERPASS</span>  <span class="o">/</span><span class="nv">path</span><span class="o">/</span><span class="nv">to</span><span class="o">/</span><span class="nv">BACKUP</span><span class="o">-</span><span class="nv">DIR</span><span class="o">/</span>

如果要使用一个最小权限的用户进行备份，则可基于如下命令创建此类用户：
<span class="nv">mysql</span><span class="o">&gt;</span> <span class="nv">CREATE</span> <span class="nv">USER</span> ’<span class="nv">bkpuser</span>’@’<span class="nv">localhost</span>’ <span class="nv">IDENTIFIED</span> <span class="nv">BY</span> ’<span class="nv">s3cret</span>’<span class="c1">;</span>
<span class="nv">mysql</span><span class="o">&gt;</span> <span class="nv">REVOKE</span> <span class="nv">ALL</span> <span class="nv">PRIVILEGES</span>, <span class="nv">GRANT</span> <span class="nv">OPTION</span> <span class="nv">FROM</span> ’<span class="nv">bkpuser</span>’<span class="c1">;</span>
<span class="nv">mysql</span><span class="o">&gt;</span> <span class="nv">GRANT</span> <span class="nv">RELOAD</span>, <span class="nv">LOCK</span> <span class="nv">TABLES</span>, <span class="nv">REPLICATION</span> <span class="nv">CLIENT</span> <span class="nv">ON</span> <span class="o">*</span>.<span class="o">*</span> <span class="nv">TO</span> ’<span class="nv">bkpuser</span>’@’<span class="nv">localhost</span>’<span class="c1">;</span>
<span class="nv">mysql</span><span class="o">&gt;</span> <span class="nv">FLUSH</span> <span class="nv">PRIVILEGES</span><span class="c1">;</span>

使用<span class="nv">innobakupex</span>备份时，其会调用<span class="nv">xtrabackup</span>备份所有的<span class="nv">InnoDB</span>表，复制所有关于表结构定义的相关文件<span class="ss">(</span>.<span class="nv">frm</span><span class="ss">)</span>、以及<span class="nv">MyISAM</span>、<span class="nv">MERGE</span>、
<span class="nv">CSV</span>和<span class="nv">ARCHIVE</span>表的相关文件，同时还会备份触发器和数据库配置信息相关的文件。这些文件会被保存至一个以时间命令的目录中。

在备份的同时，<span class="nv">innobackupex</span>还会在备份目录中创建如下文件：
<span class="ss">(</span><span class="mi">1</span><span class="ss">)</span><span class="nv">xtrabackup_checkpoints</span> —— 备份类型（如完全或增量）、备份状态（如是否已经为<span class="nv">prepared</span>状态）和<span class="nv">LSN</span><span class="ss">(</span>日志序列号<span class="ss">)</span>范围信息；

每个<span class="nv">InnoDB</span>页<span class="ss">(</span>通常为<span class="mi">16</span><span class="nv">k</span>大小<span class="ss">)</span>都会包含一个日志序列号，即<span class="nv">LSN</span>。<span class="nv">LSN</span>是整个数据库系统的系统版本号，每个页面相关的<span class="nv">LSN</span>能够表明此页面最
近是如何发生改变的。

<span class="ss">(</span><span class="mi">2</span><span class="ss">)</span><span class="nv">xtrabackup_binlog_info</span> —— <span class="nv">mysql</span>服务器当前正在使用的二进制日志文件及至备份这一刻为止二进制日志事件的位置。

<span class="ss">(</span><span class="mi">3</span><span class="ss">)</span><span class="nv">xtrabackup_binlog_pos_innodb</span> —— 二进制日志文件及用于<span class="nv">InnoDB</span>或<span class="nv">XtraDB</span>表的二进制日志文件的当前<span class="nv">position</span>。

<span class="ss">(</span><span class="mi">4</span><span class="ss">)</span><span class="nv">xtrabackup_binary</span> —— 备份中用到的<span class="nv">xtrabackup</span>的可执行文件；

<span class="ss">(</span><span class="mi">5</span><span class="ss">)</span><span class="nv">backup</span><span class="o">-</span><span class="nv">my</span>.<span class="nv">cnf</span> —— 备份命令用到的配置选项信息；

在使用<span class="nv">innobackupex</span>进行备份时，还可以使用<span class="o">--</span><span class="nv">no</span><span class="o">-</span><span class="nv">timestamp</span>选项来阻止命令自动创建一个以时间命名的目录；如此一来，<span class="nv">innobackupex</span>
命令将会创建一个<span class="nv">BACKUP</span><span class="o">-</span><span class="nv">DIR</span>目录来存储备份数据。

<span class="mi">2</span>、准备<span class="ss">(</span><span class="nv">prepare</span><span class="ss">)</span>一个完全备份


一般情况下，在备份完成后，数据尚且不能用于恢复操作，因为备份的数据中可能会包含尚未提交的事务或已经提交但尚
未同步至数据文件中的事务。因此，此时数据文件仍处理不一致状态。“准备”的主要作用正是通过回滚未提交的事务及同步已经提交的事务至
数据文件也使得数据文件处于一致性状态。


<span class="nv">innobakupex</span>命令的<span class="o">--</span><span class="nv">apply</span><span class="o">-</span><span class="nv">log</span>选项可用于实现上述功能。如下面的命令：

# <span class="nv">innobackupex</span> <span class="o">--</span><span class="nv">apply</span><span class="o">-</span><span class="nv">log</span>  <span class="o">/</span><span class="nv">path</span><span class="o">/</span><span class="nv">to</span><span class="o">/</span><span class="nv">BACKUP</span><span class="o">-</span><span class="nv">DIR</span>
如果执行正确，其最后输出的几行信息通常如下：
<span class="nv">xtrabackup</span>: <span class="nv">starting</span> <span class="nv">shutdown</span> <span class="nv">with</span> <span class="nv">innodb_fast_shutdown</span> <span class="o">=</span> <span class="mi">1</span>
<span class="mi">120407</span>  <span class="mi">9</span>:<span class="mi">01</span>:<span class="mi">36</span>  <span class="nv">InnoDB</span>: <span class="nv">Starting</span> <span class="nv">shutdown</span>...
<span class="mi">120407</span>  <span class="mi">9</span>:<span class="mi">01</span>:<span class="mi">40</span>  <span class="nv">InnoDB</span>: <span class="nv">Shutdown</span> <span class="nv">completed</span><span class="c1">; log sequence number 92036620</span>
<span class="mi">120407</span> <span class="mi">09</span>:<span class="mi">01</span>:<span class="mi">40</span>  <span class="nv">innobackupex</span>: <span class="nv">completed</span> <span class="nv">OK</span><span class="o">!</span>

在实现“准备”的过程中，<span class="nv">innobackupex</span>通常还可以使用<span class="o">--</span><span class="nv">use</span><span class="o">-</span><span class="nv">memory</span>选项来指定其可以使用的内存的大小，默认通常为<span class="mi">100</span><span class="nv">M</span>。如果有足够
的内存可用，可以多划分一些内存给<span class="nv">prepare</span>的过程，以提高其完成速度。


<span class="mi">3</span>、从一个完全备份中恢复数据

<span class="nv">innobackupex</span>命令的<span class="o">--</span><span class="nv">copy</span><span class="o">-</span><span class="nv">back</span>选项用于执行恢复操作，其通过复制所有数据相关的文件至<span class="nv">mysql</span>服务器<span class="nv">DATADIR</span>目录中来执行恢
复过程。<span class="nv">innobackupex</span>通过<span class="nv">backup</span><span class="o">-</span><span class="nv">my</span>.<span class="nv">cnf</span>来获取<span class="nv">DATADIR</span>目录的相关信息。

# <span class="nv">innobackupex</span> <span class="o">--</span><span class="nv">copy</span><span class="o">-</span><span class="nv">back</span>  <span class="o">/</span><span class="nv">path</span><span class="o">/</span><span class="nv">to</span><span class="o">/</span><span class="nv">BACKUP</span><span class="o">-</span><span class="nv">DIR</span>
如果执行正确，其输出信息的最后几行通常如下：
<span class="nv">innobackupex</span>: <span class="nv">Starting</span> <span class="nv">to</span> <span class="nv">copy</span> <span class="nv">InnoDB</span> <span class="nv">log</span> <span class="nv">files</span>
<span class="nv">innobackupex</span>: <span class="nv">in</span> <span class="s1">&#39;</span><span class="s">/backup/2012-04-07_08-17-03</span><span class="s1">&#39;</span>
<span class="nv">innobackupex</span>: <span class="nv">back</span> <span class="nv">to</span> <span class="nv">original</span> <span class="nv">InnoDB</span> <span class="nv">log</span> <span class="nv">directory</span> <span class="s1">&#39;</span><span class="s">/mydata/data</span><span class="s1">&#39;</span>
<span class="nv">innobackupex</span>: <span class="nv">Finished</span> <span class="nv">copying</span> <span class="nv">back</span> <span class="nv">files</span>.

<span class="mi">120407</span> <span class="mi">09</span>:<span class="mi">36</span>:<span class="mi">10</span>  <span class="nv">innobackupex</span>: <span class="nv">completed</span> <span class="nv">OK</span><span class="o">!</span>

请确保如上信息的最行一行出现“<span class="nv">innobackupex</span>: <span class="nv">completed</span> <span class="nv">OK</span><span class="o">!</span>”。

当数据恢复至<span class="nv">DATADIR</span>目录以后，还需要确保所有数据文件的属主和属组均为正确的用户，如<span class="nv">mysql</span>，否则，在启动<span class="nv">mysqld</span>之前还需要事先修改
数据文件的属主和属组。如：

# <span class="nv">chown</span> <span class="o">-</span><span class="nv">R</span>  <span class="nv">mysql</span>:<span class="nv">mysql</span>  <span class="o">/</span><span class="nv">mydata</span><span class="o">/</span><span class="nv">data</span><span class="o">/</span>


<span class="mi">4</span>、使用<span class="nv">innobackupex</span>进行增量备份

每个<span class="nv">InnoDB</span>的页面都会包含一个<span class="nv">LSN</span>信息，每当相关的数据发生改变，相关的页面的<span class="nv">LSN</span>就会自动增长。这正是<span class="nv">InnoDB</span>表可以进行增量备份的
基础，即<span class="nv">innobackupex</span>通过备份上次完全备份之后发生改变的页面来实现。

要实现第一次增量备份，可以使用下面的命令进行：

# <span class="nv">innobackupex</span> <span class="o">--</span><span class="nv">incremental</span> <span class="o">/</span><span class="nv">backup</span> <span class="o">--</span><span class="nv">incremental</span><span class="o">-</span><span class="nv">basedir</span><span class="o">=</span><span class="nv">BASEDIR</span>

其中，<span class="nv">BASEDIR</span>指的是完全备份所在的目录，此命令执行结束后，<span class="nv">innobackupex</span>命令会在<span class="o">/</span><span class="nv">backup</span>目录中创建一个新的以时间命名的目录以
存放所有的增量备份数据。另外，在执行过增量备份之后再一次进行增量备份时，其<span class="o">--</span><span class="nv">incremental</span><span class="o">-</span><span class="nv">basedir</span>应该指向上一次的增量备份所在的目录。

需要注意的是，增量备份仅能应用于<span class="nv">InnoDB</span>或<span class="nv">XtraDB</span>表，对于<span class="nv">MyISAM</span>表而言，执行增量备份时其实进行的是完全备份。

“准备”<span class="ss">(</span><span class="nv">prepare</span><span class="ss">)</span>增量备份与整理完全备份有着一些不同，尤其要注意的是：
<span class="ss">(</span><span class="mi">1</span><span class="ss">)</span>需要在每个备份<span class="ss">(</span>包括完全和各个增量备份<span class="ss">)</span>上，将已经提交的事务进行“重放”。“重放”之后，所有的备份数据将合并到完全备份上。
<span class="ss">(</span><span class="mi">2</span><span class="ss">)</span>基于所有的备份将未提交的事务进行“回滚”。

于是，操作就变成了：
# <span class="nv">innobackupex</span> <span class="o">--</span><span class="nv">apply</span><span class="o">-</span><span class="nv">log</span> <span class="o">--</span><span class="nv">redo</span><span class="o">-</span><span class="nv">only</span> <span class="nv">BASE</span><span class="o">-</span><span class="nv">DIR</span>

接着执行：
# <span class="nv">innobackupex</span> <span class="o">--</span><span class="nv">apply</span><span class="o">-</span><span class="nv">log</span> <span class="o">--</span><span class="nv">redo</span><span class="o">-</span><span class="nv">only</span> <span class="nv">BASE</span><span class="o">-</span><span class="nv">DIR</span> <span class="o">--</span><span class="nv">incremental</span><span class="o">-</span><span class="nv">dir</span><span class="o">=</span><span class="nv">INCREMENTAL</span><span class="o">-</span><span class="nv">DIR</span><span class="o">-</span><span class="mi">1</span>

而后是第二个增量：
# <span class="nv">innobackupex</span> <span class="o">--</span><span class="nv">apply</span><span class="o">-</span><span class="nv">log</span> <span class="o">--</span><span class="nv">redo</span><span class="o">-</span><span class="nv">only</span> <span class="nv">BASE</span><span class="o">-</span><span class="nv">DIR</span> <span class="o">--</span><span class="nv">incremental</span><span class="o">-</span><span class="nv">dir</span><span class="o">=</span><span class="nv">INCREMENTAL</span><span class="o">-</span><span class="nv">DIR</span><span class="o">-</span><span class="mi">2</span>

其中<span class="nv">BASE</span><span class="o">-</span><span class="nv">DIR</span>指的是完全备份所在的目录，而<span class="nv">INCREMENTAL</span><span class="o">-</span><span class="nv">DIR</span><span class="o">-</span><span class="mi">1</span>指的是第一次增量备份的目录，<span class="nv">INCREMENTAL</span><span class="o">-</span><span class="nv">DIR</span><span class="o">-</span><span class="mi">2</span>指的是第二次增量
备份的目录，其它依次类推，即如果有多次增量备份，每一次都要执行如上操作；

<span class="mi">5</span>、<span class="nv">Xtrabackup</span>的“流”及“备份压缩”功能

<span class="nv">Xtrabackup</span>对备份的数据文件支持“流”功能，即可以将备份的数据通过<span class="nv">STDOUT</span>传输给<span class="nv">tar</span>程序进行归档，而不是默认的直接保存至某备份目
录中。要使用此功能，仅需要使用<span class="o">--</span><span class="nv">stream</span>选项即可。如：

# <span class="nv">innobackupex</span> <span class="o">--</span><span class="nv">stream</span><span class="o">=</span><span class="nv">tar</span>  <span class="o">/</span><span class="nv">backup</span> <span class="o">|</span> <span class="nv">gzip</span> <span class="o">&gt;</span> <span class="o">/</span><span class="nv">backup</span><span class="o">/</span>`<span class="nv">date</span> <span class="o">+%</span><span class="nv">F_</span><span class="o">%</span><span class="nv">H</span><span class="o">-%</span><span class="nv">M</span><span class="o">-%</span><span class="nv">S</span>`.<span class="nv">tar</span>.<span class="nv">gz</span>

甚至也可以使用类似如下命令将数据备份至其它服务器：
# <span class="nv">innobackupex</span> <span class="o">--</span><span class="nv">stream</span><span class="o">=</span><span class="nv">tar</span>  <span class="o">/</span><span class="nv">backup</span> <span class="o">|</span> <span class="nv">ssh</span> <span class="nv">user</span>@<span class="nv">www</span>.<span class="nv">magedu</span>.<span class="nv">com</span>  <span class="s2">&quot;</span><span class="s">cat -  &gt; /backups/`date +%F_%H-%M-%S`.tar</span><span class="s2">&quot;</span>

此外，在执行本地备份时，还可以使用<span class="o">--</span><span class="nv">parallel</span>选项对多个文件进行并行复制。此选项用于指定在复制时启动的线程数目。当然，在实际
进行备份时要利用此功能的便利性，也需要启用<span class="nv">innodb_file_per_table</span>选项或共享的表空间通过<span class="nv">innodb_data_file_path</span>选项存储在
多个<span class="nv">ibdata</span>文件中。对某一数据库的多个文件的复制无法利用到此功能。其简单使用方法如下：
# <span class="nv">innobackupex</span> <span class="o">--</span><span class="nv">parallel</span>  <span class="o">/</span><span class="nv">path</span><span class="o">/</span><span class="nv">to</span><span class="o">/</span><span class="nv">backup</span>

同时，<span class="nv">innobackupex</span>备份的数据文件也可以存储至远程主机，这可以使用<span class="o">--</span><span class="nv">remote</span><span class="o">-</span><span class="nv">host</span>选项来实现：
# <span class="nv">innobackupex</span> <span class="o">--</span><span class="nv">remote</span><span class="o">-</span><span class="nv">host</span><span class="o">=</span><span class="nv">root</span>@<span class="nv">www</span>.<span class="nv">magedu</span>.<span class="nv">com</span>  <span class="o">/</span><span class="nv">path</span><span class="o">/</span><span class="nv">IN</span><span class="o">/</span><span class="nv">REMOTE</span><span class="o">/</span><span class="nv">HOST</span><span class="o">/</span><span class="nv">to</span><span class="o">/</span><span class="nv">backup</span>



<span class="mi">6</span>、导入或导出单张表

默认情况下，<span class="nv">InnoDB</span>表不能通过直接复制表文件的方式在<span class="nv">mysql</span>服务器之间进行移植，即便使用了<span class="nv">innodb_file_per_table</span>选项。而使
用<span class="nv">Xtrabackup</span>工具可以实现此种功能，不过，此时需要“导出”表的<span class="nv">mysql</span>服务器启用了<span class="nv">innodb_file_per_table</span>选项（严格来说，是要
“导出”的表在其创建之前，<span class="nv">mysql</span>服务器就启用了<span class="nv">innodb_file_per_table</span>选项），并且“导入”表的服务器同时启用了
<span class="nv">innodb_file_per_table</span>和<span class="nv">innodb_expand_import</span>选项。

<span class="ss">(</span><span class="mi">1</span><span class="ss">)</span>“导出”表
导出表是在备份的<span class="nv">prepare</span>阶段进行的，因此，一旦完全备份完成，就可以在<span class="nv">prepare</span>过程中通过<span class="o">--</span><span class="nv">export</span>选项将某表导出了：
# <span class="nv">innobackupex</span> <span class="o">--</span><span class="nv">apply</span><span class="o">-</span><span class="nv">log</span> <span class="o">--</span><span class="nv">export</span> <span class="o">/</span><span class="nv">path</span><span class="o">/</span><span class="nv">to</span><span class="o">/</span><span class="nv">backup</span>

此命令会为每个<span class="nv">innodb</span>表的表空间创建一个以.<span class="nv">exp</span>结尾的文件，这些以.<span class="nv">exp</span>结尾的文件则可以用于导入至其它服务器。

<span class="ss">(</span><span class="mi">2</span><span class="ss">)</span>“导入”表
要在<span class="nv">mysql</span>服务器上导入来自于其它服务器的某<span class="nv">innodb</span>表，需要先在当前服务器上创建一个跟原表表结构一致的表，而后才能实现将表导入：
<span class="nv">mysql</span><span class="o">&gt;</span> <span class="nv">CREATE</span> <span class="nv">TABLE</span> <span class="nv">mytable</span> <span class="ss">(</span>...<span class="ss">)</span>  <span class="nv">ENGINE</span><span class="o">=</span><span class="nv">InnoDB</span><span class="c1">;</span>

然后将此表的表空间删除：
<span class="nv">mysql</span><span class="o">&gt;</span> <span class="nv">ALTER</span> <span class="nv">TABLE</span> <span class="nv">mydatabase</span>.<span class="nv">mytable</span>  <span class="nv">DISCARD</span> <span class="nv">TABLESPACE</span><span class="c1">;</span>

接下来，将来自于“导出”表的服务器的<span class="nv">mytable</span>表的<span class="nv">mytable</span>.<span class="nv">ibd</span>和<span class="nv">mytable</span>.<span class="nv">exp</span>文件复制到当前服务器的数据目录，然后使用如下命令将其“导入”：
<span class="nv">mysql</span><span class="o">&gt;</span> <span class="nv">ALTER</span> <span class="nv">TABLE</span> <span class="nv">mydatabase</span>.<span class="nv">mytable</span>  <span class="nv">IMPORT</span> <span class="nv">TABLESPACE</span><span class="c1">;</span>




<span class="mi">7</span>、使用<span class="nv">Xtrabackup</span>对数据库进行部分备份

<span class="nv">Xtrabackup</span>也可以实现部分备份，即只备份某个或某些指定的数据库或某数据库中的某个或某些表。但要使用此功能，必须启用
<span class="nv">innodb_file_per_table</span>选项，即每张表保存为一个独立的文件。同时，其也不支持<span class="o">--</span><span class="nv">stream</span>选项，即不支持将数据通过管道传输
给其它程序进行处理。

此外，还原部分备份跟还原全部数据的备份也有所不同，即你不能通过简单地将<span class="nv">prepared</span>的部分备份使用<span class="o">--</span><span class="nv">copy</span><span class="o">-</span><span class="nv">back</span>选项直接复制回数据
目录，而是要通过导入表的方向来实现还原。当然，有些情况下，部分备份也可以直接通过<span class="o">--</span><span class="nv">copy</span><span class="o">-</span><span class="nv">back</span>进行还原，但这种方式还原而来
的数据多数会产生数据不一致的问题，因此，无论如何不推荐使用这种方式。

<span class="ss">(</span><span class="mi">1</span><span class="ss">)</span>创建部分备份

创建部分备份的方式有三种：正则表达式<span class="ss">(</span><span class="o">--</span><span class="k">include</span><span class="ss">)</span>, 枚举表文件<span class="ss">(</span><span class="o">--</span><span class="nv">tables</span><span class="o">-</span><span class="nv">file</span><span class="ss">)</span>和列出要备份的数据库<span class="ss">(</span><span class="o">--</span><span class="nv">databases</span><span class="ss">)</span>。

<span class="ss">(</span><span class="nv">a</span><span class="ss">)</span>使用<span class="o">--</span><span class="k">include</span>
使用<span class="o">--</span><span class="k">include</span>时，要求为其指定要备份的表的完整名称，即形如<span class="nv">databasename</span>.<span class="nv">tablename</span>，如：
# <span class="nv">innobackupex</span> <span class="o">--</span><span class="k">include</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">^mageedu[.]tb1</span><span class="s1">&#39;</span>  <span class="o">/</span><span class="nv">path</span><span class="o">/</span><span class="nv">to</span><span class="o">/</span><span class="nv">backup</span>

<span class="ss">(</span><span class="nv">b</span><span class="ss">)</span>使用<span class="o">--</span><span class="nv">tables</span><span class="o">-</span><span class="nv">file</span>
此选项的参数需要是一个文件名，此文件中每行包含一个要备份的表的完整名称；如：
# <span class="nv">echo</span> <span class="o">-</span><span class="nv">e</span> <span class="s1">&#39;</span><span class="s">mageedu.tb1</span><span class="se">\n</span><span class="s">mageedu.tb2</span><span class="s1">&#39;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">tables</span>.<span class="nv">txt</span>
# <span class="nv">innobackupex</span> <span class="o">--</span><span class="nv">tables</span><span class="o">-</span><span class="nv">file</span><span class="o">=/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">tables</span>.<span class="nv">txt</span>  <span class="o">/</span><span class="nv">path</span><span class="o">/</span><span class="nv">to</span><span class="o">/</span><span class="nv">backup</span>

<span class="ss">(</span><span class="nv">c</span><span class="ss">)</span>使用<span class="o">--</span><span class="nv">databases</span>
此选项接受的参数为数据名，如果要指定多个数据库，彼此间需要以空格隔开；同时，在指定某数据库时，也可以只指定其中的某张表。此外，
此选项也可以接受一个文件为参数，文件中每一行为一个要备份的对象。如：
# <span class="nv">innobackupex</span> <span class="o">--</span><span class="nv">databases</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">mageedu testdb</span><span class="s2">&quot;</span>  <span class="o">/</span><span class="nv">path</span><span class="o">/</span><span class="nv">to</span><span class="o">/</span><span class="nv">backup</span>


<span class="ss">(</span><span class="mi">2</span><span class="ss">)</span>整理<span class="ss">(</span><span class="nv">preparing</span><span class="ss">)</span>部分备份
<span class="nv">prepare</span>部分备份的过程类似于导出表的过程，要使用<span class="o">--</span><span class="nv">export</span>选项进行：
# <span class="nv">innobackupex</span> <span class="o">--</span><span class="nv">apply</span><span class="o">-</span><span class="nv">log</span> <span class="o">--</span><span class="nv">export</span>  <span class="o">/</span><span class="nv">pat</span><span class="o">/</span><span class="nv">to</span><span class="o">/</span><span class="nv">partial</span><span class="o">/</span><span class="nv">backup</span>

此命令执行过程中，<span class="nv">innobackupex</span>会调用<span class="nv">xtrabackup</span>命令从数据字典中移除缺失的表，因此，会显示出许多关于“表不存在”类的警告信息。
同时，也会显示出为备份文件中存在的表创建.<span class="nv">exp</span>文件的相关信息。

<span class="ss">(</span><span class="mi">3</span><span class="ss">)</span>还原部分备份
还原部分备份的过程跟导入表的过程相同。当然，也可以通过直接复制<span class="nv">prepared</span>状态的备份直接至数据目录中实现还原，不要此时要求数据目
录处于一致状态。
</pre></div>


<h2 id="myisam-innodb">MyISAM InnoDB</h2>
<div class="codehilite"><pre><span></span><span class="n">MyISAM</span>  <span class="err">和</span> <span class="n">InnoDB</span>

<span class="err">构成上的区别：</span>

        <span class="err">每个</span><span class="n">MyISAM</span><span class="err">在磁盘上存储成三个文件。第一个文件的名字以表的名字开始，扩展名指出文件类型。</span> <span class="p">.</span><span class="n">frm</span><span class="err">文件存储表定义。</span>

  <span class="err">数据文件的扩展名为</span><span class="p">.</span><span class="n">MYD</span> <span class="p">(</span><span class="n">MYData</span><span class="p">)</span><span class="err">，索引文件的扩展名是</span><span class="p">.</span><span class="n">MYI</span> <span class="p">(</span><span class="n">MYIndex</span><span class="p">)</span><span class="err">。</span>

        <span class="err">基于磁盘的资源是</span><span class="n">InnoDB</span><span class="err">表空间数据文件和它的日志文件，</span><span class="n">InnoDB</span> <span class="err">表的大小只受限于操作系统文件的大小，一般为</span> <span class="mi">2</span><span class="n">GB</span>

  <span class="err">事务处理上方面</span><span class="p">:</span>

        <span class="n">MyISAM</span><span class="err">类型的表强调的是性能，其执行数度比</span><span class="n">InnoDB</span><span class="err">类型更快，但是不提供事务支持</span>

        <span class="n">InnoDB</span><span class="err">提供事务支持事务，外部键等高级数据库功能</span>


  <span class="k">SELECT</span>   <span class="k">UPDATE</span><span class="p">,</span><span class="k">INSERT</span><span class="err">，</span><span class="k">Delete</span><span class="err">操作</span>
        <span class="err">如果执行大量的</span><span class="k">SELECT</span><span class="err">，</span><span class="n">MyISAM</span><span class="err">是更好的选择</span>

<span class="mi">1</span><span class="p">.</span><span class="err">如果你的数据执行大量的</span><span class="k">INSERT</span><span class="err">或</span><span class="k">UPDATE</span><span class="err">，出于性能方面的考虑，应该使用</span><span class="n">InnoDB</span><span class="err">表</span>

<span class="mi">2</span><span class="p">.</span><span class="k">DELETE</span>   <span class="k">FROM</span> <span class="k">table</span><span class="err">时，</span><span class="n">InnoDB</span><span class="err">不会重新建立表，而是一行一行的删除。</span>

<span class="mi">3</span><span class="p">.</span><span class="k">LOAD</span>   <span class="k">TABLE</span> <span class="k">FROM</span> <span class="n">MASTER</span><span class="err">操作对</span><span class="n">InnoDB</span><span class="err">是不起作用的，解决方法是首先把</span><span class="n">InnoDB</span><span class="err">表改成</span><span class="n">MyISAM</span><span class="err">表，导入数据后再改成</span><span class="n">InnoDB</span><span class="err">表，</span>
<span class="err">但是对于使用的额外的</span><span class="n">InnoDB</span><span class="err">特性（例如外键）的表不适用</span>
</pre></div>


<h2 id="mysql">MySQL优化三板斧</h2>
<div class="codehilite"><pre><span></span><span class="err">首先从</span><span class="n">CPU</span><span class="err">说起。</span>

<span class="err">你仔细检查的话，有些服务器上会有的一个有趣的现象：你</span><span class="n">cat</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">cpuinfo</span><span class="err">时，会发现</span><span class="n">CPU</span><span class="err">的频率竟然跟它标称的频率不一样：</span>

<span class="cp">#cat /proc/cpuinfo </span>
<span class="nl">processor</span> <span class="p">:</span> <span class="mi">5</span>
<span class="n">model</span> <span class="nl">name</span> <span class="p">:</span> <span class="n">Intel</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="n">Xeon</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="n">CPU</span> <span class="n">E5</span><span class="o">-</span><span class="mi">2620</span> <span class="mi">0</span> <span class="mf">@2.00</span><span class="n">GHz</span>
 <span class="p">...</span>
<span class="n">cpu</span> <span class="nl">MHz</span> <span class="p">:</span> <span class="mf">1200.000</span>
<span class="err">这个是</span><span class="n">Intel</span> <span class="n">E5</span><span class="o">-</span><span class="mi">2620</span><span class="err">的</span><span class="n">CPU</span><span class="err">，他是</span><span class="mf">2.00</span><span class="n">G</span> <span class="o">*</span> <span class="mi">24</span><span class="err">的</span><span class="n">CPU</span><span class="err">，但是，我们发现第</span><span class="mi">5</span><span class="err">颗</span><span class="n">CPU</span><span class="err">的频率为</span><span class="mf">1.2</span><span class="n">G</span><span class="err">。</span>

<span class="err">这是什么原因呢？</span>

<span class="err">这些其实都源于</span><span class="n">CPU</span><span class="err">最新的技术：节能模式。操作系统和</span><span class="n">CPU</span><span class="err">硬件配合，系统不繁忙的时候，为了节约电能和降低温度，它会将</span><span class="n">CPU</span><span class="err">降频。</span>
<span class="err">这对环保人士和抵制地球变暖来说是一个福音，但是对</span><span class="n">MySQL</span><span class="err">来说，可能是一个灾难。</span>

<span class="err">为了保证</span><span class="n">MySQL</span><span class="err">能够充分利用</span><span class="n">CPU</span><span class="err">的资源，建议设置</span><span class="n">CPU</span><span class="err">为最大性能模式。这个设置可以在</span><span class="n">BIOS</span><span class="err">和操作系统中设置，当然，在</span><span class="n">BIOS</span><span class="err">中设置该选</span>
<span class="err">项更好，更彻底。由于各种</span><span class="n">BIOS</span><span class="err">类型的区别，设置为</span><span class="n">CPU</span><span class="err">为最大性能模式千差万别，我们这里就不具体展示怎么设置了。</span>

<span class="err">二、内存</span>
<span class="err">然后我们看看内存方面，我们有哪些可以优化的。</span>

<span class="n">i</span><span class="p">)</span> <span class="err">我们先看看</span><span class="n">numa</span>
<span class="err">非一致存储访问结构</span> <span class="p">(</span><span class="n">NUMA</span> <span class="err">：</span> <span class="n">Non</span><span class="o">-</span><span class="n">Uniform</span> <span class="n">Memory</span> <span class="n">Access</span><span class="p">)</span> <span class="err">也是最新的内存管理技术。它和对称多处理器结构</span> <span class="p">(</span><span class="n">SMP</span> <span class="err">：</span>
 <span class="n">Symmetric</span> <span class="n">Multi</span><span class="o">-</span><span class="n">Processor</span><span class="p">)</span> <span class="err">是对应的。简单的队别如下：</span>



<span class="err">如图所示，详细的</span><span class="n">NUMA</span><span class="err">信息我们这里不介绍了。但是我们可以直观的看到：</span><span class="n">SMP</span><span class="err">访问内存的都是代价都是一样的；但是在</span><span class="n">NUMA</span><span class="err">架构下，</span>
<span class="err">本地内存的访问和非</span> <span class="err">本地内存的访问代价是不一样的。对应的根据这个特性，操作系统上，我们可以设置进程的内存分配方式。目前支持</span>
<span class="err">的方式包括：</span>

<span class="o">--</span><span class="n">interleave</span><span class="o">=</span><span class="n">nodes</span>
<span class="o">--</span><span class="n">membind</span><span class="o">=</span><span class="n">nodes</span>
<span class="o">--</span><span class="n">cpunodebind</span><span class="o">=</span><span class="n">nodes</span>
<span class="o">--</span><span class="n">physcpubind</span><span class="o">=</span><span class="n">cpus</span>
<span class="o">--</span><span class="n">localalloc</span>
<span class="o">--</span><span class="n">preferred</span><span class="o">=</span><span class="n">node</span>
<span class="err">简而言之，就是说，你可以指定内存在本地分配，在某几个</span><span class="n">CPU</span><span class="err">节点分配或者轮询分配。除非</span> <span class="err">是设置为</span><span class="o">--</span><span class="n">interleave</span><span class="o">=</span><span class="n">nodes</span><span class="err">轮询分配方式，</span>
<span class="err">即内存可以在任意</span><span class="n">NUMA</span><span class="err">节点上分配这种方式以外。其他的方式就算其他</span><span class="n">NUMA</span><span class="err">节点上还有内</span> <span class="err">存剩余，</span><span class="n">Linux</span><span class="err">也不会把剩余的内存分配给这个进程，</span>
<span class="err">而是采用</span><span class="n">SWAP</span><span class="err">的方式来获得内存。有经验的系统管理员或者</span><span class="n">DBA</span><span class="err">都知道</span><span class="n">SWAP</span><span class="err">导致的数据库性能</span> <span class="err">下降有多么坑爹。</span>

<span class="err">所以最简单的方法，还是关闭掉这个特性。</span>

<span class="err">关闭特性的方法，分别有：可以从</span><span class="n">BIOS</span><span class="err">，操作系统，启动进程时临时关闭这个特性。</span>

<span class="n">a</span><span class="p">)</span> <span class="err">由于各种</span><span class="n">BIOS</span><span class="err">类型的区别，如何关闭</span><span class="n">NUMA</span><span class="err">千差万别，我们这里就不具体展示怎么设置了。</span>

<span class="n">b</span><span class="p">)</span> <span class="err">在操作系统中关闭，可以直接在</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">grub</span><span class="p">.</span><span class="n">conf</span><span class="err">的</span><span class="n">kernel</span><span class="err">行最后添加</span><span class="n">numa</span><span class="o">=</span><span class="n">off</span><span class="err">，如下所示：</span>

<span class="n">kernel</span> <span class="o">/</span><span class="n">vmlinuz</span><span class="o">-</span><span class="mf">2.6.32</span><span class="o">-</span><span class="mf">220.</span><span class="n">el6</span><span class="p">.</span><span class="n">x86_64</span> <span class="n">ro</span> <span class="n">root</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">mapper</span><span class="o">/</span><span class="n">VolGroup</span><span class="o">-</span><span class="n">root</span>   <span class="n">rd_NO_LUKS</span> 
<span class="n">LANG</span><span class="o">=</span><span class="n">en_US</span><span class="p">.</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span> <span class="n">rd_LVM_LV</span><span class="o">=</span><span class="n">VolGroup</span><span class="o">/</span><span class="n">root</span> <span class="n">rd_NO_MD</span> <span class="n">quiet</span>   <span class="n">SYSFONT</span><span class="o">=</span><span class="n">latarcyrheb</span><span class="o">-</span><span class="n">sun16</span> <span class="n">rhgb</span> 
<span class="n">crashkernel</span><span class="o">=</span><span class="k">auto</span> <span class="n">rd_LVM_LV</span><span class="o">=</span><span class="n">VolGroup</span><span class="o">/</span><span class="n">swap</span>  <span class="n">rhgb</span> <span class="n">crashkernel</span><span class="o">=</span><span class="k">auto</span> <span class="n">quiet</span> <span class="n">KEYBOARDTYPE</span><span class="o">=</span><span class="n">pc</span> 
<span class="n">KEYTABLE</span><span class="o">=</span><span class="n">us</span> <span class="n">rd_NO_DM</span> <span class="n">numa</span><span class="o">=</span><span class="n">off</span>   
<span class="err">另外可以设置</span> <span class="n">vm</span><span class="p">.</span><span class="n">zone_reclaim_mode</span><span class="o">=</span><span class="mi">0</span><span class="err">尽量回收内存。</span>

<span class="n">c</span><span class="p">)</span> <span class="err">启动</span><span class="n">MySQL</span><span class="err">的时候，关闭</span><span class="n">NUMA</span><span class="err">特性：</span>

<span class="n">numactl</span> <span class="o">--</span><span class="n">interleave</span><span class="o">=</span><span class="n">all</span>  <span class="n">mysqld</span> <span class="o">&amp;</span>
<span class="err">当然，最好的方式是在</span><span class="n">BIOS</span><span class="err">中关闭。</span>

<span class="n">ii</span><span class="p">)</span> <span class="err">我们再看看</span><span class="n">vm</span><span class="p">.</span><span class="n">swappiness</span><span class="err">。</span>
<span class="n">vm</span><span class="p">.</span><span class="n">swappiness</span><span class="err">是操作系统控制物理内存交换出去的策略。它允许的值是一个百分比的值，最小为</span><span class="mi">0</span><span class="err">，最大运行</span><span class="mi">100</span><span class="err">，该值默认为</span><span class="mi">60</span><span class="err">。</span>
<span class="n">vm</span><span class="p">.</span><span class="n">swappiness</span><span class="err">设置为</span><span class="mi">0</span><span class="err">表示尽量少</span><span class="n">swap</span><span class="err">，</span><span class="mi">100</span><span class="err">表示尽量将</span><span class="n">inactive</span><span class="err">的内存页交换出去。</span>

<span class="err">具体的说：当内存基本用满的时候，系统会根据这个参数来判断是把内存中很少用到的</span><span class="n">inactive</span> <span class="err">内存交换出去，还是释放数据的</span><span class="n">cache</span><span class="err">。</span>
<span class="n">cache</span><span class="err">中缓存着从磁盘读出来的数据，根据程序的局部性原理，这些数据有可能在接下来又要被读</span> <span class="err">取；</span><span class="n">inactive</span> <span class="err">内存顾名思义，</span>
<span class="err">就是那些被应用程序映射着，但是“长时间”不用的内存。</span>

<span class="err">我们可以利用</span><span class="n">vmstat</span><span class="err">看到</span><span class="n">inactive</span><span class="err">的内存的数量：</span>

<span class="cp">#vmstat -an 1 </span>
 <span class="n">procs</span> <span class="o">-----------</span><span class="n">memory</span><span class="o">----------</span> <span class="o">---</span><span class="n">swap</span><span class="o">--</span> <span class="o">-----</span><span class="n">io</span><span class="o">----</span> <span class="o">--</span><span class="n">system</span><span class="o">--</span> <span class="o">-----</span><span class="n">cpu</span><span class="o">-----</span> 
 <span class="n">r</span> <span class="n">b</span> <span class="n">swpd</span> <span class="n">free</span>  <span class="n">inact</span>  <span class="n">active</span> <span class="n">si</span> <span class="n">so</span> <span class="n">bi</span> <span class="n">bo</span> <span class="k">in</span> <span class="n">cs</span> <span class="n">us</span> <span class="n">sy</span> <span class="kt">id</span> <span class="n">wa</span> <span class="n">st</span> 
 <span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">27522384</span> <span class="mi">326928</span> <span class="mi">1704644</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">153</span> <span class="mi">11</span> <span class="mi">10</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">100</span> <span class="mi">0</span> <span class="mi">0</span> 
 <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">27523300</span> <span class="mi">326936</span> <span class="mi">1704164</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">74</span> <span class="mi">784</span> <span class="mi">590</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">100</span> <span class="mi">0</span> <span class="mi">0</span> 
 <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">27523656</span> <span class="mi">326936</span> <span class="mi">1704692</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">8</span> <span class="mi">8</span> <span class="mi">439</span> <span class="mi">1686</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">100</span> <span class="mi">0</span> <span class="mi">0</span> 
 <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">27524300</span> <span class="mi">326916</span> <span class="mi">1703412</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">4</span> <span class="mi">52</span> <span class="mi">198</span> <span class="mi">262</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">100</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="err">通过</span><span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">meminfo</span> <span class="err">你可以看到更详细的信息：</span>

<span class="cp">#cat /proc/meminfo | grep -i inact </span>
 <span class="nl">Inactive</span><span class="p">:</span> <span class="mi">326972</span> <span class="n">kB</span> 
 <span class="n">Inactive</span><span class="p">(</span><span class="n">anon</span><span class="p">)</span><span class="o">:</span> <span class="mi">248</span> <span class="n">kB</span> 
 <span class="n">Inactive</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">:</span> <span class="mi">326724</span> <span class="n">kB</span>
<span class="err">这里我们对不活跃</span><span class="n">inactive</span><span class="err">内存进一步深入讨论。</span> <span class="n">Linux</span><span class="err">中，内存可能处于三种状态：</span><span class="n">free</span><span class="err">，</span><span class="n">active</span><span class="err">和</span><span class="n">inactive</span><span class="err">。众所周知，</span>
<span class="n">Linux</span> <span class="n">Kernel</span><span class="err">在内部维护了很多</span><span class="n">LRU</span><span class="err">列表用来管理内存，比如</span><span class="n">LRU_INACTIVE_ANON</span><span class="p">,</span> <span class="n">LRU_ACTIVE_ANON</span><span class="p">,</span> <span class="n">LRU_INACTIVE_FILE</span> <span class="p">,</span>
 <span class="n">LRU_ACTIVE_FILE</span><span class="p">,</span> <span class="n">LRU_UNEVICTABLE</span><span class="err">。其中</span><span class="n">LRU_INACTIVE_ANON</span><span class="p">,</span> <span class="n">LRU_ACTIVE_ANON</span><span class="err">用来管理匿名页，</span><span class="n">LRU_INACTIVE_FILE</span> <span class="p">,</span>
  <span class="n">LRU_ACTIVE_FILE</span><span class="err">用来管理</span><span class="n">page</span> <span class="n">caches</span><span class="err">页缓存。系统内核会根据内存页的访问情况，不定时的将活跃</span><span class="n">active</span><span class="err">内存被移到</span><span class="n">inactive</span><span class="err">列表中，</span>
  <span class="err">这些</span><span class="n">inactive</span><span class="err">的内存可以被</span> <span class="err">交换到</span><span class="n">swap</span><span class="err">中去。</span>

<span class="err">一般来说，</span><span class="n">MySQL</span><span class="err">，特别是</span><span class="n">InnoDB</span><span class="err">管理内存缓存，它占用的内存比较多，不经常访问的内存也会不少，这些内存如果被</span><span class="n">Linux</span><span class="err">错误的交换出去了，</span>
<span class="err">将</span> <span class="err">浪费很多</span><span class="n">CPU</span><span class="err">和</span><span class="n">IO</span><span class="err">资源。</span> <span class="n">InnoDB</span><span class="err">自己管理缓存，</span><span class="n">cache</span><span class="err">的文件数据来说占用了内存，对</span><span class="n">InnoDB</span><span class="err">几乎没有任何好处。</span>

<span class="err">所以，我们在</span><span class="n">MySQL</span><span class="err">的服务器上最好设置</span><span class="n">vm</span><span class="p">.</span><span class="n">swappiness</span><span class="o">=</span><span class="mi">0</span><span class="err">。</span>

<span class="err">我们可以通过在</span><span class="n">sysctl</span><span class="p">.</span><span class="n">conf</span><span class="err">中添加一行：</span>

<span class="n">echo</span> <span class="s">&quot;vm.swappiness = 0&quot;</span> <span class="o">&gt;&gt;/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysctl</span><span class="p">.</span><span class="n">conf</span>
<span class="err">并使用</span><span class="n">sysctl</span> <span class="o">-</span><span class="n">p</span><span class="err">来使得该参数生效。</span>

<span class="err">三、文件系统</span>
<span class="err">最后，我们看一下文件系统的优化</span>

<span class="n">i</span><span class="p">)</span> <span class="err">我们建议在文件系统的</span><span class="n">mount</span><span class="err">参数上加上</span><span class="n">noatime</span><span class="err">，</span><span class="n">nobarrier</span><span class="err">两个选项。</span>
<span class="err">用</span><span class="n">noatime</span> <span class="n">mount</span><span class="err">的话，文件系统在程序访问对应的文件或者文件夹时，不会更新对应的</span><span class="n">access</span> <span class="n">time</span><span class="err">。一般来说，</span><span class="n">Linux</span><span class="err">会给文件记录</span>
<span class="err">了三个时间，</span><span class="n">change</span> <span class="n">time</span><span class="p">,</span> <span class="n">modify</span> <span class="n">time</span><span class="err">和</span><span class="n">access</span> <span class="n">time</span><span class="err">。</span>

<span class="err">我们可以通过</span><span class="n">stat</span><span class="err">来查看文件的三个时间：</span>

<span class="n">stat</span> <span class="n">libnids</span><span class="o">-</span><span class="mf">1.16</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span> 
 <span class="nl">File</span><span class="p">:</span> <span class="err">`</span><span class="n">libnids</span><span class="o">-</span><span class="mf">1.16</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span><span class="err">&#39;</span> 
 <span class="nl">Size</span><span class="p">:</span> <span class="mi">72309</span> <span class="nl">Blocks</span><span class="p">:</span> <span class="mi">152</span> <span class="n">IO</span> <span class="nl">Block</span><span class="p">:</span> <span class="mi">4096</span> <span class="n">regular</span> <span class="n">file</span> 
 <span class="nl">Device</span><span class="p">:</span> <span class="mi">302</span><span class="n">h</span><span class="o">/</span><span class="mi">770</span><span class="n">d</span> <span class="nl">Inode</span><span class="p">:</span> <span class="mi">4113144</span> <span class="nl">Links</span><span class="p">:</span> <span class="mi">1</span> 
 <span class="nl">Access</span><span class="p">:</span> <span class="p">(</span><span class="mo">0644</span><span class="o">/-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span><span class="p">)</span> <span class="nl">Uid</span><span class="p">:</span> <span class="p">(</span> <span class="mi">0</span><span class="o">/</span> <span class="n">root</span><span class="p">)</span> <span class="nl">Gid</span><span class="p">:</span> <span class="p">(</span> <span class="mi">0</span><span class="o">/</span> <span class="n">root</span><span class="p">)</span> 
  <span class="nl">Access</span>  <span class="p">:</span> <span class="mi">2008</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mi">27</span> <span class="mi">15</span><span class="o">:</span><span class="mi">13</span><span class="o">:</span><span class="mf">03.000000000</span> <span class="o">+</span><span class="mi">0800</span> 
 <span class="nl">Modify</span><span class="p">:</span> <span class="mi">2004</span><span class="o">-</span><span class="mo">03</span><span class="o">-</span><span class="mi">10</span> <span class="mi">12</span><span class="o">:</span><span class="mi">25</span><span class="o">:</span><span class="mf">09.000000000</span> <span class="o">+</span><span class="mi">0800</span> 
 <span class="nl">Change</span><span class="p">:</span> <span class="mi">2008</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mi">27</span> <span class="mi">14</span><span class="o">:</span><span class="mi">18</span><span class="o">:</span><span class="mf">18.000000000</span> <span class="o">+</span><span class="mi">0800</span>
<span class="err">其中</span><span class="n">access</span> <span class="n">time</span><span class="err">指文件最后一次被读取的时间，</span><span class="n">modify</span> <span class="n">time</span><span class="err">指的是文件的文本内容最后发生变化的时间，</span><span class="n">change</span> <span class="n">time</span><span class="err">指的是文件的</span>
<span class="n">inode</span><span class="err">最后发生变化</span><span class="p">(</span><span class="err">比如位置、用户属性、组属性等</span><span class="p">)</span><span class="err">的时间。一般来说，文件都是读多写少，而且我们也很少关心某一个文件最近什</span> <span class="err">么时间被访问了。</span>

<span class="err">所以，我们建议采用</span><span class="n">noatime</span><span class="err">选项，这样文件系统不记录</span><span class="n">access</span> <span class="n">time</span><span class="err">，避免浪费资源。</span>

<span class="err">现在的很多文件系统会在数据提交时强制底层设备刷新</span><span class="n">cache</span><span class="err">，避免数据丢失，称之为</span><span class="n">write</span> <span class="n">barriers</span><span class="err">。但是，其实我们数据库服务器底</span>
<span class="err">层存储设备要么采用</span><span class="n">RAID</span><span class="err">卡，</span><span class="n">RAID</span><span class="err">卡本身的电池可以掉电保护；要么采用</span><span class="n">Flash</span><span class="err">卡，它也有自我保</span> <span class="err">护机制，保证数据不会丢失。所以我们</span>
<span class="err">可以安全的使用</span><span class="n">nobarrier</span><span class="err">挂载文件系统。设置方法如下：</span>

<span class="err">对于</span><span class="n">ext3</span><span class="p">,</span> <span class="n">ext4</span><span class="err">和</span> <span class="n">reiserfs</span><span class="err">文件系统可以在</span><span class="n">mount</span><span class="err">时指定</span><span class="n">barrier</span><span class="o">=</span><span class="mi">0</span><span class="err">；对于</span><span class="n">xfs</span><span class="err">可以指定</span><span class="n">nobarrier</span><span class="err">选项。</span>

<span class="n">ii</span><span class="p">)</span> <span class="err">文件系统上还有一个提高</span><span class="n">IO</span><span class="err">的优化万能钥匙，那就是</span><span class="n">deadline</span><span class="err">。</span>
<span class="err">在</span> <span class="n">Flash</span><span class="err">技术之前，我们都是使用机械磁盘存储数据的，机械磁盘的寻道时间是影响它速度的最重要因素，直接导致它的每秒可做</span>
<span class="err">的</span><span class="n">IO</span><span class="p">(</span><span class="n">IOPS</span><span class="p">)</span><span class="err">非常有限，</span> <span class="err">为了尽量排序和合并多个请求，以达到一次寻道能够满足多次</span><span class="n">IO</span><span class="err">请求的目的，</span><span class="n">Linux</span><span class="err">文件系统设计了多种</span><span class="n">IO</span><span class="err">调度</span>
<span class="err">策略，已适用各种场景和存储设备。</span>

<span class="n">Linux</span><span class="err">的</span><span class="n">IO</span><span class="err">调度策略包括：</span><span class="n">Deadline</span> <span class="n">scheduler</span><span class="err">，</span><span class="n">Anticipatory</span> <span class="n">scheduler</span><span class="err">，</span><span class="n">Completely</span> <span class="n">Fair</span> <span class="n">Queuing</span><span class="p">(</span><span class="n">CFQ</span><span class="p">)</span><span class="err">，</span><span class="n">NOOP</span><span class="err">。每种调度策</span>
<span class="err">略的详细调度方式我们这里不详细描述，这里我们主要介绍</span><span class="n">CFQ</span><span class="err">和</span><span class="n">Deadline</span><span class="err">，</span><span class="n">CFQ</span><span class="err">是</span><span class="n">Linux</span><span class="err">内</span> <span class="err">核</span><span class="mf">2.6.18</span><span class="err">之后的默认调度策略，它声称对每一个</span> <span class="n">IO</span>
 <span class="err">请求都是公平的，这种调度策略对大部分应用都是适用的。但是如果数据库有两个请求，一个请求</span><span class="mi">3</span><span class="err">次</span><span class="n">IO</span><span class="err">，一个请求</span><span class="mi">10000</span><span class="err">次</span><span class="n">IO</span><span class="err">，由于绝对公平，</span>
 <span class="mi">3</span><span class="err">次</span><span class="n">IO</span> <span class="err">的这个请求都需要跟其他</span><span class="mi">10000</span><span class="err">个</span><span class="n">IO</span><span class="err">请求竞争，可能要等待上千个</span><span class="n">IO</span><span class="err">完成才能返回，导致它的响应时间非常慢。并且如果在处理的过程中，</span>
 <span class="err">又有很多</span><span class="n">IO</span><span class="err">请</span> <span class="err">求陆续发送过来，部分</span><span class="n">IO</span><span class="err">请求甚至可能一直无法得到调度被“饿死”。而</span><span class="n">deadline</span><span class="err">兼顾到一个请求不会在队列中等待太久导致饿死，</span>
 <span class="err">对数据库这种应用来</span> <span class="err">说更加适用。</span>

<span class="err">实时设置，我们可以通过</span>

<span class="n">echo</span> <span class="n">deadline</span> <span class="o">&gt;/</span><span class="n">sys</span><span class="o">/</span><span class="n">block</span><span class="o">/</span><span class="n">sda</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">scheduler</span>
<span class="err">来将</span><span class="n">sda</span><span class="err">的调度策略设置为</span><span class="n">deadline</span><span class="err">。</span>

<span class="err">我们也可以直接在</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">grub</span><span class="p">.</span><span class="n">conf</span><span class="err">的</span><span class="n">kernel</span><span class="err">行最后添加</span><span class="n">elevator</span><span class="o">=</span><span class="n">deadline</span><span class="err">来永久生效。</span>

<span class="err">总结</span>
<span class="n">CPU</span><span class="err">方面：</span>

<span class="err">关闭电源保护模式</span>

<span class="err">内存：</span>

<span class="n">vm</span><span class="p">.</span><span class="n">swappiness</span> <span class="o">=</span> <span class="mi">0</span>

<span class="err">关闭</span><span class="n">numa</span>

<span class="err">文件系统：</span>

<span class="err">用</span><span class="n">noatime</span><span class="err">，</span><span class="n">nobarrier</span><span class="err">挂载系统</span>

<span class="n">IO</span><span class="err">调度策略修改为</span><span class="n">deadline</span><span class="err">。</span>


<span class="err">来源：</span> <span class="nl">http</span><span class="p">:</span><span class="c1">//os.51cto.com/art/201407/446750.htm</span>
</pre></div>


<h2 id="mycat">mycat</h2>
<div class="codehilite"><pre><span></span>http://www.mycat.org.cn/
https://github.com/MyCATApache/Mycat-download

读写分离中间件

涉及到的配置文件：
1.conf/server.xml
主要配置的是mycat的用户名和密码，mycat的用户名和密码和mysql的用户名密码是分开的，应用连接mycat就用这个用户名和密码。

<span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mycat:server SYSTEM &quot;server.dtd&quot;&gt;</span>
<span class="nt">&lt;mycat:server</span> <span class="na">xmlns:mycat=</span><span class="s">&quot;http://org.opencloudb/&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;system&gt;</span>
    <span class="c">&lt;!--</span>
<span class="c">    &lt;property name=&quot;processors&quot;&gt;32&lt;/property&gt;</span>
<span class="c">    &lt;property name=&quot;processorExecutor&quot;&gt;32&lt;/property&gt;</span>
<span class="c">    &lt;property name=&quot;serverPort&quot;&gt;8066&lt;/property&gt;</span>
<span class="c">    &lt;property name=&quot;managerPort&quot;&gt;9066&lt;/property&gt;</span>
<span class="c">    --&gt;</span>
  <span class="nt">&lt;/system&gt;</span>
  <span class="nt">&lt;user</span> <span class="na">name=</span><span class="s">&quot;root&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span><span class="nt">&gt;</span>root<span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;schemas&quot;</span><span class="nt">&gt;</span>数据库名称<span class="nt">&lt;/property&gt;</span>
  <span class="nt">&lt;/user&gt;</span>
<span class="nt">&lt;/mycat:server&gt;</span>
2.conf/schema.xml
主要配置主从库的数据库连接地址信息，schema里面不能配置table的定义，如果配置了就会检查sql的语法，目前mycat还有很多问题。


<span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mycat:schema SYSTEM &quot;schema.dtd&quot;&gt;</span>
<span class="nt">&lt;mycat:schema</span> <span class="na">xmlns:mycat=</span><span class="s">&quot;http://org.opencloudb/&quot;</span><span class="nt">&gt;</span>

  <span class="nt">&lt;schema</span> <span class="na">name=</span><span class="s">&quot;数据库名称&quot;</span> <span class="na">checkSQLschema=</span><span class="s">&quot;false&quot;</span> <span class="na">dataNode=</span><span class="s">&quot;dn1&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/schema&gt;</span>

  <span class="nt">&lt;dataNode</span> <span class="na">name=</span><span class="s">&quot;dn1&quot;</span> <span class="na">dataHost=</span><span class="s">&quot;localhost1&quot;</span> <span class="na">database=</span><span class="s">&quot;数据库名称&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;dataHost</span> <span class="na">name=</span><span class="s">&quot;localhost1&quot;</span> <span class="na">maxCon=</span><span class="s">&quot;1000&quot;</span> <span class="na">minCon=</span><span class="s">&quot;100&quot;</span> <span class="na">balance=</span><span class="s">&quot;1&quot;</span>      <span class="na">dbType=</span><span class="s">&quot;mysql&quot;</span> <span class="na">dbDriver=</span><span class="s">&quot;native&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;heartbeat&gt;</span>select user()<span class="nt">&lt;/heartbeat&gt;</span>
    <span class="c">&lt;!-- can have multi write hosts --&gt;</span>
    <span class="nt">&lt;writeHost</span> <span class="na">host=</span><span class="s">&quot;10.1.3.50&quot;</span> <span class="na">url=</span><span class="s">&quot;10.1.3.50:3306&quot;</span> <span class="na">user=</span><span class="s">&quot;数据库用户名&quot;</span>  <span class="na">password=</span><span class="s">&quot;数据库密码&quot;</span><span class="nt">&gt;</span>
      <span class="c">&lt;!-- can have multi read hosts --&gt;</span>           
      <span class="nt">&lt;readHost</span> <span class="na">host=</span><span class="s">&quot;10.1.3.5&quot;</span> <span class="na">url=</span><span class="s">&quot;10.1.3.5:3306&quot;</span> <span class="na">user=</span><span class="s">&quot;数据库用户名&quot;</span> <span class="na">password=</span><span class="s">&quot;数据库密码&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;readHost</span> <span class="na">host=</span><span class="s">&quot;10.1.3.6&quot;</span> <span class="na">url=</span><span class="s">&quot;10.1.3.6:3306&quot;</span> <span class="na">user=</span><span class="s">&quot;数据库用户名&quot;</span> <span class="na">password=</span><span class="s">&quot;数据库密码&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/writeHost&gt;</span>       
    <span class="c">&lt;!--writeHost host=&quot;10.1.3.34&quot; url=&quot;10.1.3.34:3306&quot; user=&quot;数据库用户名&quot;  password=&quot;数据库密码&quot;--&gt;</span>
      <span class="c">&lt;!-- can have multi read hosts --&gt;</span>           
      <span class="c">&lt;!--readHost host=&quot;10.1.3.7&quot; url=&quot;10.1.3.7:3306&quot; user=&quot;数据库用户名&quot; password=&quot;数据库密码&quot; /--&gt;</span>
      <span class="c">&lt;!--readHost host=&quot;10.1.3.8&quot; url=&quot;10.1.3.8:3306&quot; user=&quot;数据库用户名&quot; password=&quot;数据库密码&quot; /--&gt;</span>
    <span class="c">&lt;!--/writeHost--&gt;</span>
  <span class="nt">&lt;/dataHost&gt;</span>
<span class="nt">&lt;/mycat:schema&gt;</span>
高可用性以及读写分离
MyCAT的读写分离机制如下：
• 事务内的SQL，全部走写节点，除非某个select语句以注释/*balance*/开头
• 自动提交的select语句会走读节点，并在所有可用读节点中间随机负载均衡
• 当某个主节点宕机，则其全部读节点都不再被使用，因为此时，同步失败，数据已经不是最新的，MYCAT会采用另外一个主节点所对应的
全部读节点来实现select负载均衡。
• 当所有主节点都失败，则为了系统高可用性，自动提交的所有select语句仍将提交到全部存活的读节点上执行，此时系统的很多页面还是
能出来数据，只是用户修改或提交会失败。

dataHost的balance属性设置为：
• 0，不开启读写分离机制
• 1，全部的readHost与stand by writeHost参与select语句的负载均衡，简单的说，当双主双从模式(M1-&gt;S1，M2-&gt;S2，并且M1与 M2
互为主备)，正常情况下，M2,S1,S2都参与select语句的负载均衡。
• 2，所有的readHost与writeHost都参与select语句的负载均衡，也就是说，当系统的写操作压力不大的情况下，所有主机都可以承担负载均衡。
一个dataHost元素，表明进行了数据同步的一组数据库，DBA需要保证这一组数据库服务器是进行了数据同步复制的。writeHost相当于
Master DB Server，而旗下的readHost则是与从数据库同步的Slave DB Server。当dataHost配置了多个writeHost的时候，任何一个
writeHost宕机，Mycat 都会自动检测出来，并尝试切换到下一个可用的writeHost。

MyCAT支持高可用性的企业级特性，根据您的应用特性，可以配置如下几种策略：
• 后端数据库配置为一主多从，并开启读写分离机制。
• 后端数据库配置为双主双从（多从），并开启读写分离机制
• 后端数据库配置为多主多从，并开启读写分离机制
后面两种配置，具有更高的系统可用性，当其中一个写节点（主节点）失败后，Mycat会侦测出来（心跳机制）并自动切换到下一个写节点，
MyCAT在任何时候，只会往一个写节点写数据。
</pre></div>


<h2 id="sql">常用sql</h2>
<div class="codehilite"><pre><span></span><span class="nv">yum</span> <span class="nv">install</span> <span class="nv">mysql</span> <span class="nv">mysql</span><span class="o">-</span><span class="nv">server</span> <span class="o">-</span><span class="nv">y</span>
如果是第一次启动会初始化数据库  会在默认目录（<span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">mysql</span>）下创建默认数据库文件夹。
<span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">init</span>.<span class="nv">d</span><span class="o">/</span><span class="nv">mysqld</span> <span class="nv">start</span>

批量替换数据
<span class="nv">UPDATE</span> <span class="nv">tablename</span> <span class="nv">SET</span> 字段名<span class="o">=</span><span class="nv">REPLACE</span><span class="ss">(</span>字段名, <span class="s1">&#39;</span><span class="s">HTML</span><span class="s1">&#39;</span>, <span class="s1">&#39;</span><span class="s">.YOUKU</span><span class="s1">&#39;</span><span class="ss">)</span><span class="c1">;</span>

库
<span class="nv">create</span> <span class="nv">database</span> <span class="nv">vfast</span><span class="c1">;</span>
<span class="nv">drop</span> <span class="nv">database</span> <span class="nv">vfast</span><span class="c1">;</span>
<span class="nv">use</span> <span class="nv">vfast</span><span class="c1">;</span>
<span class="k">show</span> <span class="nv">databases</span><span class="c1">;</span>

<span class="nv">flush</span> <span class="nv">tables</span> <span class="nv">with</span> <span class="nv">read</span> <span class="nv">lock</span><span class="c1">;  全局读锁定</span>
<span class="nv">unlock</span> <span class="nv">tables</span><span class="c1">;</span>

表
<span class="k">show</span> <span class="nv">tables</span><span class="c1">;</span>
<span class="nv">create</span> <span class="nv">table</span> <span class="nv">rhce</span> <span class="ss">(</span><span class="nv">id</span> <span class="nv">int</span><span class="ss">)</span><span class="c1">;</span>
<span class="nv">alter</span> <span class="nv">table</span> <span class="nv">rhce</span> <span class="nv">rename</span> <span class="nv">cbd</span><span class="c1">;                      修改表名</span>
<span class="nv">alter</span> <span class="nv">table</span> <span class="nv">cbd</span> <span class="nv">add</span> <span class="nv">sex</span> <span class="nv">enum</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">Y</span><span class="s1">&#39;</span>,<span class="s1">&#39;</span><span class="s">N</span><span class="s1">&#39;</span><span class="ss">)</span><span class="c1">;        增加字段  sex </span>
<span class="nv">alter</span> <span class="nv">table</span> <span class="nv">cbd</span> <span class="nv">drop</span> <span class="nv">id</span><span class="c1">;                               删除字段  id         </span>
<span class="nv">alter</span> <span class="nv">table</span> <span class="nv">cbd</span> <span class="nv">modify</span> <span class="nv">name</span> <span class="nv">char</span><span class="ss">(</span><span class="mi">16</span><span class="ss">)</span><span class="c1">;       修改字段name的类型char（16）</span>
<span class="nv">or</span>
<span class="nv">alter</span> <span class="nv">table</span> <span class="nv">vfast_user</span> <span class="nv">change</span> <span class="nv">name</span> <span class="nv">name</span> <span class="nv">enum</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">B</span><span class="s1">&#39;</span>,<span class="s1">&#39;</span><span class="s">G</span><span class="s1">&#39;</span><span class="ss">)</span><span class="c1">;</span>
<span class="nv">alter</span> <span class="nv">table</span> <span class="nv">cbd</span> <span class="nv">change</span> <span class="nv">name</span> <span class="nv">mingzi</span> <span class="nv">char</span><span class="ss">(</span><span class="mi">26</span><span class="ss">)</span><span class="c1">;　改变列名name为mingzi 类型为char(26)</span>
<span class="k">show</span> <span class="nv">warnings</span> \<span class="nv">G</span><span class="c1">;                                        显示mysql警告</span>
<span class="k">show</span> <span class="nv">create</span> <span class="nv">table</span> <span class="nv">cbd</span><span class="c1">;                                    显示表cbd的创建过程</span>
<span class="nv">desc</span> <span class="nv">cbd</span><span class="c1">;                                                      显示cbd表的所有字段 </span>
<span class="nv">drop</span> <span class="nv">table</span> <span class="nv">cbd</span><span class="c1">;</span>

数据
数据类型
<span class="nv">char</span>     字符串   空间预先分配
<span class="nv">varchar</span>  字符串（空间占用更合理，每次存取数据都用<span class="nv">CPU</span>计算，所以更耗<span class="nv">CPU</span>） 空间后分配
<span class="nv">int</span>     整形  一个整数，支持 <span class="o">-</span><span class="mi">2147493648</span>到<span class="mi">2147493647</span>
<span class="nv">bigint</span> 大数据整形  一个大整数，支持 <span class="o">-</span><span class="mi">9223372036854775808</span>到<span class="mi">9223372036854775807</span>
<span class="nv">float</span> 浮点型（小数点） 一个小的菜单精度浮点数。支持 <span class="o">-</span><span class="mi">3</span>.<span class="mi">402823466</span><span class="nv">E</span><span class="o">+</span><span class="mi">38</span>到<span class="o">-</span><span class="mi">1</span>.<span class="mi">175494351</span><span class="nv">E</span><span class="o">-</span><span class="mi">38</span>
<span class="nv">date</span>  年月日
<span class="nv">time</span>  时分秒
<span class="nv">datetime</span> 存储年月日时分秒
<span class="nv">blob</span>   存储二进制
<span class="nv">text</span>   存储文本
<span class="nv">enum</span>    单选
<span class="nv">set</span>     多选
<span class="nv">timestamp</span>  自动插入当天前时间

<span class="nv">select</span> <span class="o">*</span> <span class="nv">from</span> <span class="nv">xt701</span><span class="c1">; </span>
<span class="nv">insert</span> <span class="nv">into</span> <span class="nv">xt701</span> <span class="ss">(</span><span class="nv">name</span>,<span class="nv">ID</span>,<span class="nv">yuwen</span><span class="ss">)</span>  <span class="nv">values</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">lin</span><span class="s1">&#39;</span>,<span class="mi">1007</span>,<span class="mi">99</span><span class="ss">)</span><span class="c1">;</span>
 <span class="nv">or</span>
<span class="nv">insert</span> <span class="nv">into</span> <span class="nv">xt701</span> <span class="nv">values</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">zhang</span><span class="s1">&#39;</span>,<span class="mi">1001</span>,<span class="mi">80</span>,<span class="mi">70</span>,<span class="mi">90</span><span class="ss">)</span>,<span class="ss">(</span><span class="s1">&#39;</span><span class="s">li</span><span class="s1">&#39;</span>,<span class="mi">1002</span>,<span class="mi">90</span>,<span class="mi">98</span>,<span class="mi">19</span><span class="ss">)</span>,<span class="ss">(</span><span class="s1">&#39;</span><span class="s">zhao</span><span class="s1">&#39;</span>,<span class="mi">1003</span>,<span class="mi">68</span>,<span class="mi">67</span>,<span class="mi">90</span><span class="ss">)</span><span class="c1">;</span>
<span class="nv">select</span> <span class="nv">name</span>,<span class="nv">id</span> <span class="nv">from</span> <span class="nv">xt701</span> <span class="nv">where</span> <span class="nv">shuxue</span><span class="o">&gt;=</span><span class="mi">80</span><span class="c1">;</span>
注意：同时插入多条记录比单条插入执行起来更快些！！
<span class="nv">update</span> <span class="nv">xt701</span> <span class="nv">set</span> <span class="nv">shuxue</span><span class="o">=</span><span class="mi">80</span> <span class="nv">where</span> <span class="nv">id</span><span class="o">=</span><span class="mi">1007</span> <span class="nv">and</span> <span class="nv">shuxue</span> <span class="nv">is</span> <span class="nv">NULL</span><span class="c1">;</span>
批量替换数据
<span class="nv">update</span> <span class="mi">3</span><span class="nv">m_recording_meeting</span> <span class="nv">m</span> <span class="nv">set</span> <span class="nv">m</span>.<span class="nv">play_url</span><span class="o">=</span><span class="nv">REPLACE</span> <span class="ss">(</span><span class="nv">m</span>.<span class="nv">play_url</span>,<span class="s1">&#39;</span><span class="s">127.0.0.1</span><span class="s1">&#39;</span>,<span class="s1">&#39;</span><span class="s">saas.3mang.com</span><span class="s1">&#39;</span><span class="ss">)</span>   
<span class="nv">where</span> <span class="nv">m</span>.<span class="nv">play_url</span> <span class="nv">like</span> <span class="s1">&#39;</span><span class="s">%127.0.0.1%</span><span class="s1">&#39;</span>

<span class="nv">truncate</span>   删除所有数据 （打碎表后重建新表）  删除速度快于<span class="nv">delete</span>
<span class="nv">delete</span>     逐行删除数据
<span class="nv">delete</span> <span class="nv">from</span> <span class="nv">xt701</span><span class="c1">;</span>
<span class="nv">truncate</span> <span class="nv">xt701</span><span class="c1">;</span>
<span class="nv">delete</span> <span class="nv">from</span> <span class="nv">xt701</span> <span class="nv">where</span> <span class="nv">yingyu</span><span class="o">=</span><span class="mi">80</span><span class="c1">;</span>
<span class="nv">select</span> <span class="o">*</span> <span class="nv">from</span> <span class="nv">T1</span> <span class="nv">where</span> <span class="nv">YUWEN</span> <span class="nv">between</span> <span class="mi">70</span> <span class="nv">and</span> <span class="mi">90</span><span class="c1">;</span>


向表中导入数据
<span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span>: <span class="s1">&#39;</span><span class="s">{print $1 </span><span class="s1">&#39;</span>,<span class="s1">&#39;</span><span class="s"> $3 </span><span class="s1">&#39;</span>,<span class="s1">&#39;</span><span class="s"> $4 </span><span class="s1">&#39;</span>,<span class="s1">&#39;</span><span class="s"> $NF}</span><span class="s1">&#39;</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">passwd</span> <span class="o">&gt;</span> <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">user</span>

<span class="nv">create</span> <span class="nv">table</span> <span class="nv">H2</span> <span class="ss">(</span> <span class="nv">NAME</span> <span class="nv">char</span><span class="ss">(</span><span class="mi">15</span><span class="ss">)</span>, <span class="nv">PASSWORD</span> <span class="nv">char</span><span class="ss">(</span><span class="mi">50</span><span class="ss">)</span>, <span class="nv">UID</span> <span class="nv">int</span><span class="ss">(</span><span class="mi">5</span><span class="ss">)</span>, <span class="nv">GID</span> <span class="nv">int</span><span class="ss">(</span><span class="mi">5</span><span class="ss">)</span>, <span class="nv">MIAOSHU</span> <span class="nv">varchar</span><span class="ss">(</span><span class="mi">100</span><span class="ss">)</span>,
 <span class="nv">HOME</span> <span class="nv">varchar</span><span class="ss">(</span><span class="mi">100</span><span class="ss">)</span>, <span class="nv">SHELL</span> <span class="nv">varchar</span><span class="ss">(</span><span class="mi">100</span><span class="ss">))</span><span class="c1">;</span>
<span class="nv">load</span> <span class="nv">data</span> <span class="nv">infile</span> <span class="s1">&#39;</span><span class="s">/etc/passwd</span><span class="s1">&#39;</span> <span class="nv">into</span> <span class="nv">table</span> <span class="nv">H2</span> <span class="nv">fields</span> <span class="nv">terminated</span> <span class="nv">by</span> <span class="s1">&#39;</span><span class="s">:</span><span class="s1">&#39;</span><span class="c1">;</span>

<span class="nv">mysql</span>函数
<span class="nv">sum</span>  求和
<span class="nv">max</span>   取最大值
<span class="nv">min</span>   取最小值
<span class="nv">avg</span>   取平均值
<span class="nv">count</span>  统计
</pre></div>


<h2 id="_2">中间件对比</h2>
<div class="codehilite"><pre><span></span><span class="nv">mysql</span>中间件研究
<span class="nv">Atlas</span>，<span class="nv">cobar</span>，<span class="nv">TDDL</span>，<span class="nv">mycat</span>，<span class="nv">heisenberg</span>,<span class="nv">Oceanus</span>,<span class="nv">vitess</span>,<span class="nv">OneProxy</span>

来源： <span class="nv">http</span>:<span class="o">//</span><span class="nv">songwie</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">articlelist</span><span class="o">/</span><span class="mi">44</span>

<span class="nv">mysql</span><span class="o">-</span><span class="nv">proxy</span>是官方提供的<span class="nv">mysql</span>中间件产品可以实现负载平衡，读写分离，<span class="nv">failover</span>等，但其不支持大数据量的分库分表且性能较差。
下面介绍几款能代替其的<span class="nv">mysql</span>开源中间件产品，<span class="nv">Atlas</span>，<span class="nv">cobar</span>，<span class="nv">tddl</span>，让我们看看它们各自有些什么优点和新特性吧。

<span class="nv">Atlas</span>


<span class="nv">Atlas</span>是由 <span class="nv">Qihoo</span> <span class="mi">360</span>, <span class="nv">Web</span>平台部基础架构团队开发维护的一个基于<span class="nv">MySQL</span>协议的数据中间层项目。它是在<span class="nv">mysql</span><span class="o">-</span><span class="nv">proxy</span> <span class="mi">0</span>.<span class="mi">8</span>.<span class="mi">2</span>版本的基础上，
对其进行了优化，增加了一些新的功能特性。<span class="mi">360</span>内部使用<span class="nv">Atlas</span>运行的<span class="nv">mysql</span>业务，每天承载的读写请求数达几十亿条。
<span class="nv">Altas</span>架构：
<span class="nv">Atlas</span>是一个位于应用程序与<span class="nv">MySQL</span>之间，它实现了<span class="nv">MySQL</span>的客户端与服务端协议，作为服务端与应用程序通讯，同时作为客户端与<span class="nv">MySQL</span>通讯。
它对应用程序屏蔽了<span class="nv">DB</span>的细节，同时为了降低<span class="nv">MySQL</span>负担，它还维护了连接池。



以下是一个可以参考的整体架构，<span class="nv">LVS</span>前端做负载均衡，两个<span class="nv">Altas</span>做<span class="nv">HA</span>,防止单点故障。


<span class="nv">Altas</span>的一些新特性：
<span class="mi">1</span>.主库宕机不影响读
主库宕机，<span class="nv">Atlas</span>自动将宕机的主库摘除，写操作会失败，读操作不受影响。从库宕机，<span class="nv">Atlas</span>自动将宕机的从库摘除，对应用没有影响。
在<span class="nv">mysql</span>官方的<span class="nv">proxy</span>中主库宕机，从库亦不可用。
<span class="mi">2</span>.通过管理接口，简化管理工作，<span class="nv">DB</span>的上下线对应用完全透明，同时可以手动上下线。
图<span class="mi">1</span>是手动添加一台从库的示例。
图<span class="mi">1</span>


<span class="mi">3</span>.自己实现读写分离
（<span class="mi">1</span>）为了解决读写分离存在写完马上就想读而这时可能存在主从同步延迟的情况，<span class="nv">Altas</span>中可以在<span class="nv">SQL</span>语句前增加 <span class="cm">/*master*/</span> 就可以
将读请求强制发往主库。
（<span class="mi">2</span>）如图<span class="mi">2</span>中，主库可设置多项，用逗号分隔，从库可设置多项和权重，达到负载均衡。
图<span class="mi">2</span>

<span class="mi">4</span>.自己实现分表（图<span class="mi">3</span>）
（<span class="mi">1</span>）需带有分表字段。
（<span class="mi">2</span>）支持<span class="nv">SELECT</span>、<span class="nv">INSERT</span>、<span class="nv">UPDATE</span>、<span class="nv">DELETE</span>、<span class="nv">REPLACE</span>语句。
（<span class="mi">3</span>）支持多个子表查询结果的合并和排序。
图<span class="mi">3</span> 

这里不得不吐槽<span class="nv">Atlas</span>的分表功能，不能实现分布式分表，所有的子表必须在同一台<span class="nv">DB</span>的同一个<span class="nv">database</span>里且所有的子表必须事先建好，
<span class="nv">Atlas</span>没有自动建表的功能。
<span class="mi">5</span>.之前官方主要功能逻辑由使用<span class="nv">lua</span>脚本编写，效率低，<span class="nv">Atlas</span>用<span class="nv">C</span>改写，<span class="nv">QPS</span>提高，<span class="nv">latency</span>降低。
<span class="mi">6</span>.安全方面的提升
（<span class="mi">1</span>）通过配置文件中的<span class="nv">pwds</span>参数进行连接<span class="nv">Atlas</span>的用户的权限控制。
（<span class="mi">2</span>）通过<span class="nv">client</span><span class="o">-</span><span class="nv">ips</span>参数对有权限连接<span class="nv">Atlas</span>的<span class="nv">ip</span>进行过滤。
（<span class="mi">3</span>）日志中记录所有通过<span class="nv">Altas</span>处理的<span class="nv">SQL</span>语句，包括客户端<span class="nv">IP</span>、实际执行该语句的<span class="nv">DB</span>、执行成功与否、执行所耗费的时间 ，如下面例子（图<span class="mi">4</span>）。
图<span class="mi">4</span>

<span class="mi">7</span>.平滑重启
通过配置文件中设置<span class="nv">lvs</span><span class="o">-</span><span class="nv">ips</span>参数实现平滑重启功能，否则重启<span class="nv">Altas</span>的瞬间那些<span class="nv">SQL</span>请求都会失败。该参数前面挂接的<span class="nv">lvs</span>的物理网卡的<span class="nv">ip</span>，注
意不是虚<span class="nv">ip</span>。平滑重启的条件是至少有两台配置相同的<span class="nv">Atlas</span>且挂在<span class="nv">lvs</span>之后。
<span class="nv">source</span>：<span class="nv">https</span>:<span class="o">//</span><span class="nv">github</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">Qihoo360</span><span class="o">/</span><span class="nv">Atlas</span>

<span class="nv">alibaba</span>.<span class="nv">cobar</span>

<span class="nv">Cobar</span>是阿里巴巴（<span class="nv">B2B</span>）部门开发的一种关系型数据的分布式处理系统，它可以在分布式的环境下看上去像传统数据库一样为您提供海量
数据服务。那么具体说说我们为什么要用它，或说<span class="nv">cobar</span><span class="o">--</span>能干什么？以下是我们业务运行中会存在的一些问题：
<span class="mi">1</span>.随着业务的进行数据库的数据量和访问量的剧增，需要对数据进行水平拆分来降低单库的压力，而且需要高效且相对透明的来屏蔽掉水平拆分的细节。
<span class="mi">2</span>.为提高访问的可用性，数据源需要备份。
<span class="mi">3</span>.数据源可用性的检测和<span class="nv">failover</span>。
<span class="mi">4</span>.前台的高并发造成后台数据库连接数过多，降低了性能，怎么解决。 

针对以上问题就有了<span class="nv">cobar</span>施展自己的空间了，<span class="nv">cobar</span>中间件以<span class="nv">proxy</span>的形式位于前台应用和实际数据库之间，对前台的开放的接口是<span class="nv">mysq</span>
<span class="nv">l</span>通信协议。将前台<span class="nv">SQL</span>语句变更并按照数据分布规则转发到合适的后台数据分库，再合并返回结果，模拟单库下的数据库行为。 

<span class="nv">Cobar</span>应用举例
应用架构：

应用介绍：
<span class="mi">1</span>.通过<span class="nv">Cobar</span>提供一个名为<span class="nv">test</span>的数据库，其中包含<span class="nv">t1</span>,<span class="nv">t2</span>两张表。后台有<span class="mi">3</span>个<span class="nv">MySQL</span>实例<span class="ss">(</span><span class="nv">ip</span>:<span class="nv">port</span><span class="ss">)</span>为其提供服务，分别为：<span class="nv">A</span>,<span class="nv">B</span>,<span class="nv">C</span>。
<span class="mi">2</span>.期望<span class="nv">t1</span>表的数据放置在实例<span class="nv">A</span>中，<span class="nv">t2</span>表的数据水平拆成四份并在实例<span class="nv">B</span>和<span class="nv">C</span>中各自放两份。<span class="nv">t2</span>表的数据要具备<span class="nv">HA</span>功能，即<span class="nv">B</span>或者<span class="nv">C</span>实例其中
一个出现故障，不影响使用且可提供完整的数据服务。
<span class="nv">cabar</span>优点总结：
<span class="mi">1</span>.数据和访问从集中式改变为分布：
（<span class="mi">1</span>）<span class="nv">Cobar</span>支持将一张表水平拆分成多份分别放入不同的库来实现表的水平拆分
（<span class="mi">2</span>）<span class="nv">Cobar</span>也支持将不同的表放入不同的库
（<span class="mi">3</span>） 多数情况下，用户会将以上两种方式混合使用
注意！：<span class="nv">Cobar</span>不支持将一张表，例如<span class="nv">test</span>表拆分成<span class="nv">test_1</span>,<span class="nv">test_2</span>, <span class="nv">test_3</span>.....放在同一个库中，必须将拆分后的表分别放入不同
的库来实现分布式。
<span class="mi">2</span>.解决连接数过大的问题。
<span class="mi">3</span>.对业务代码侵入性少。
<span class="mi">4</span>.提供数据节点的<span class="nv">failover</span>,<span class="nv">HA</span>：
<span class="ss">(</span><span class="mi">1</span><span class="ss">)</span><span class="nv">Cobar</span>的主备切换有两种触发方式，一种是用户手动触发，一种是<span class="nv">Cobar</span>的心跳语句检测到异常后自动触发。那么，当心跳检测到主机
异常，切换到备机，如果主机恢复了，需要用户手动切回主机工作，<span class="nv">Cobar</span>不会在主机恢复时自动切换回主机，除非备机的心跳也返回异常。
<span class="ss">(</span><span class="mi">2</span><span class="ss">)</span><span class="nv">Cobar</span>只检查<span class="nv">MySQL</span>主备异常，不关心主备之间的数据同步，因此用户需要在使用<span class="nv">Cobar</span>之前在<span class="nv">MySQL</span>主备上配置双向同步。
<span class="nv">cobar</span>缺点：
开源版本中数据库只支持<span class="nv">mysql</span>，并且不支持读写分离。
<span class="nv">source</span>：<span class="nv">http</span>:<span class="o">//</span><span class="nv">code</span>.<span class="nv">alibabatech</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">wiki</span><span class="o">/</span><span class="nv">display</span><span class="o">/</span><span class="nv">cobar</span><span class="o">/</span><span class="nv">Home</span>

<span class="nv">TDDL</span>

淘宝根据自己的业务特点开发了<span class="nv">TDDL</span>（<span class="nv">Taobao</span> <span class="nv">Distributed</span> <span class="nv">Data</span> <span class="nv">Layer</span> 外号:头都大了 ©<span class="nv">_Ob</span>）框架，主要解决了分库分表对应用的
透明化以及异构数据库之间的数据复制，它是一个基于集中式配置的 <span class="nv">jdbc</span> <span class="nv">datasource</span>实现，具有主备，读写分离，动态数据库配置等功能。
<span class="nv">TDDL</span>所处的位置（<span class="nv">tddl</span>通用数据访问层，部署在客户端的<span class="nv">jar</span>包，用于将用户的<span class="nv">SQL</span>路由到指定的数据库中）：


淘宝很早就对数据进行过分库的处理， 上层系统连接多个数据库，中间有一个叫做<span class="nv">DBRoute</span>的路由来对数据进行统一访问。<span class="nv">DBRoute</span>对
数据进行多库的操作、数据的整合，让上层系统像操作一个数据库一样操作多个库。但是随着数据量的增长，对于库表的分法有了更高
的要求，例如，你的商品数据到了百亿级别的时候，任何一个库都无法存放了，于是分成<span class="mi">2</span>个、<span class="mi">4</span>个、<span class="mi">8</span>个、<span class="mi">16</span>个、<span class="mi">32</span>个……直到<span class="mi">1024</span>个、
<span class="mi">2048</span>个。好，分成这么多，数据能够存放了，那怎么查询它？这时候，数据查询的中间件就要能够承担这个重任了，它对上层来说，
必须像查询一个数据库一样来查询数据，还要像查询一个数据库一样快（每条查询在几毫秒内完成），<span class="nv">TDDL</span>就承担了这样一个工作。
在外面有些系统也用<span class="nv">DAL</span>（数据访问层） 这个概念来命名这个中间件。
下图展示了一个简单的分库分表数据查询策略：

主要优点：
<span class="mi">1</span>.数据库主备和动态切换
<span class="mi">2</span>.带权重的读写分离
<span class="mi">3</span>.单线程读重试
<span class="mi">4</span>.集中式数据源信息管理和动态变更
<span class="mi">5</span>.剥离的稳定<span class="nv">jboss</span>数据源
<span class="mi">6</span>.支持<span class="nv">mysql</span>和<span class="nv">oracle</span>数据库
<span class="mi">7</span>.基于<span class="nv">jdbc</span>规范，很容易扩展支持实现<span class="nv">jdbc</span>规范的数据源
<span class="mi">8</span>.无<span class="nv">server</span>,<span class="nv">client</span><span class="o">-</span><span class="nv">jar</span>形式存在，应用直连数据库
<span class="mi">9</span>.读写次数,并发度流程控制，动态变更
<span class="mi">10</span>.可分析的日志打印,日志流控，动态变更
<span class="nv">TDDL</span>必须要依赖<span class="nv">diamond</span>配置中心（<span class="nv">diamond</span>是淘宝内部使用的一个管理持久配置的系统，目前淘宝内部绝大多数系统的配置，
由<span class="nv">diamond</span>来进行统一管理，同时<span class="nv">diamond</span>也已开源）。
<span class="nv">TDDL</span>动态数据源使用示例说明：<span class="nv">http</span>:<span class="o">//</span><span class="nv">rdc</span>.<span class="nv">taobao</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">team</span><span class="o">/</span><span class="nv">jm</span><span class="o">/</span><span class="nv">archives</span><span class="o">/</span><span class="mi">1645</span>
<span class="nv">diamond</span>简介和快速使用：<span class="nv">http</span>:<span class="o">//</span><span class="nv">jm</span>.<span class="nv">taobao</span>.<span class="nv">org</span><span class="o">/</span><span class="nv">tag</span><span class="o">/</span><span class="nv">diamond</span><span class="o">%</span><span class="nv">E4</span><span class="o">%</span><span class="nv">B8</span><span class="o">%</span><span class="mi">93</span><span class="o">%</span><span class="nv">E9</span><span class="o">%</span><span class="nv">A2</span><span class="o">%</span><span class="mi">98</span><span class="o">/</span>
<span class="nv">TDDL</span>源码：<span class="nv">https</span>:<span class="o">//</span><span class="nv">github</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">alibaba</span><span class="o">/</span><span class="nv">tb_tddl</span> 
<span class="nv">TDDL</span>复杂度相对较高。当前公布的文档较少，只开源动态数据源，分表分库部分还未开源，还需要依赖<span class="nv">diamond</span>，不推荐使用。
终其所有，我们研究中间件的目的是使数据库实现性能的提高。具体使用哪种还要经过深入的研究，严谨的测试才可决定。



<span class="nv">MyCAT</span>

<span class="nv">http</span>:<span class="o">//</span><span class="nv">www</span>.<span class="nv">org</span>.<span class="nv">cn</span><span class="o">/</span>

<span class="nv">https</span>:<span class="o">//</span><span class="nv">github</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">myCATApache</span>


什么是<span class="nv">MyCAT</span>?简单的说，<span class="nv">MyCAT</span>就是： 一个彻底开源的，面向企业应用开发的“大数据库集群” 支持事务、<span class="nv">ACID</span>、可以替代<span class="nv">Mysql</span>
的加强版数据库 ? 一个可以视为“<span class="nv">Mysql</span>”集群的企业级数据库，用来替代昂贵的<span class="nv">Oracle</span>集群 ? 一个融合内存缓存技术、<span class="nv">Nosql</span>技术、
<span class="nv">HDFS</span>大数据的新型<span class="nv">SQL</span> <span class="nv">Server</span> ? 结合传统数据库和新型分布式数据仓库的新一代企业级数据库产品 ? 一个新颖的数据库中间件产品。

目标

低成本的将现有的单机数据库和应用平滑迁移到“云”端，解决数据存储和业务规模迅速增长情况下的数据瓶颈问题。

关键特性

<span class="mi">1</span>. 支持 <span class="nv">SQL</span> <span class="mi">92</span>标准 支持<span class="nv">Mysql</span>集群，可以作为<span class="nv">Proxy</span>使用 支持<span class="nv">JDBC</span>连接<span class="nv">ORACLE</span>、<span class="nv">DB2</span>、<span class="nv">SQL</span> <span class="nv">Server</span>，将其模拟为<span class="nv">MySQL</span> <span class="nv">Server</span>
使用 支持<span class="nv">galera</span> <span class="k">for</span> <span class="nv">mysql</span>集群，<span class="nv">percona</span><span class="o">-</span><span class="nv">cluster</span>或者<span class="nv">mariadb</span> <span class="nv">cluster</span>，提供高可用性数据分片集群，自动故障切换，高可用性 。

<span class="mi">2</span>. 支持读写分离。

<span class="mi">3</span>. 支持<span class="nv">Mysql</span>双主多从，以及一主多从的模式 。

<span class="mi">4</span>. 支持全局表。

<span class="mi">5</span>. 支持数据自动分片到多个节点，用于高效表关联查询 。

<span class="mi">6</span>. 垮裤<span class="nv">join</span>，支持独有的基于<span class="nv">E</span><span class="o">-</span><span class="nv">R</span> 关系的分片策略，实现了高效的表关联查询多平台支持，部署和实施简单。

优势

基于阿里开源的<span class="nv">Cobar</span>产品而研发，<span class="nv">Cobar</span>的稳定性、可靠性、优秀的架构和性能，以及众多成熟的使用案例使得<span class="nv">MyCAT</span>一开始就拥有
一个很好的起点，站在巨人的肩膀上，我们能看到更远。广泛吸取业界优秀的开源项目和创新思路，将其融入到<span class="nv">MyCAT</span>的基因中，使得
<span class="nv">MyCAT</span>在很多方面都领先于目前其他一些同类的开源项目，甚至超越某些商业产品。<span class="nv">MyCAT</span>背后有一只强大的技术团队，其参与者都是
<span class="mi">5</span>年以上资深软件工程师、架构师、<span class="nv">DBA</span>等，优秀的技术团队保证了<span class="nv">MyCAT</span>的产品质量。 <span class="nv">MyCAT</span>并不依托于任何一个商业公司，因此不像
某些开源项目，将一些重要的特性封闭在其商业产品中，使得开源项目成了一个摆设，目前在持续维护更新。

长期规划

在支持<span class="nv">Mysql</span>的基础上，后端增加更多的开源数据库和商业数据库的支持，包括原生支持<span class="nv">PosteSQL</span>、<span class="nv">FireBird</span>等开源数据库，以及通过
<span class="nv">JDBC</span>等方式间接支持其他非开源的数据库如<span class="nv">Oracle</span>、<span class="nv">DB2</span>、<span class="nv">SQL</span> <span class="nv">Server</span>等实现更为智能的自我调节特性，如自动统计分析<span class="nv">SQL</span>，
自动创建和调整索引，根据数据表的读写频率，自动优化缓存和备份策略等实现更全面的监控管理功能与<span class="nv">HDFS</span>集成，提供<span class="nv">SQL</span>命令，
将数据库装入<span class="nv">HDFS</span>中并能够快速分析集成优秀的开源报表工具，使之具备一定的数据分析的能力。



<span class="nv">heisenberg</span>

强大好用的<span class="nv">mysql</span>分库分表中间件,来自百度

其优点： 分库分表与应用脱离，分库表如同使用单库表一样 减少<span class="nv">db</span> 连接数压力 热重启配置 可水平扩容 遵守<span class="nv">Mysql</span>原生协议 
读写分离 无语言限制，<span class="nv">mysqlclient</span>,<span class="nv">c</span>,<span class="nv">java</span>等都可以使用 <span class="nv">Heisenberg</span>服务器通过管理命令可以查看，如连接数，线程池，结点等，
并可以调整 采用<span class="nv">velocity</span>的分库分表脚本进行自定义分库表，相当的灵活

<span class="nv">qq</span>群：<span class="mi">150720285</span> 邮箱:<span class="nv">brucest0078</span>@<span class="nv">gmail</span>.<span class="nv">com</span>

<span class="nv">https</span>:<span class="o">//</span><span class="nv">github</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">songwie</span><span class="o">/</span><span class="nv">heisenberg</span>



分库分表与应用脱离，分库表如同使用单库表一样
减少<span class="nv">db</span> 连接数压力
热重启配置
可水平扩容
遵守<span class="nv">Mysql</span>原生协议
无语言限制，<span class="nv">mysqlclient</span>,<span class="nv">c</span>,<span class="nv">java</span>等都可以使用
<span class="nv">Heisenberg</span>服务器通过管理命令可以查看，如连接数，线程池，结点等，并可以调整

<span class="nv">Oceanus</span>:

<span class="nv">Oceanus</span>致力于打造一个功能简单、可依赖、易于上手、易于扩展、易于集成的解决方案，甚至是平台化系统。拥抱开源，提供各类
插件机制集成其他开源项目，新手可以在几分钟内上手编程，分库分表逻辑不再与业务紧密耦合，扩容有标准模式，减少意外错误的发生。

<span class="nv">Oceanus</span>内部名词定义

<span class="nv">datanode</span>：数据源节点。为一个数据源命名，配置链接属性、报警实现

<span class="nv">namenode</span>：数据源的簇。为一组数据源命名，指定这组数据源的负载方式、访问模式、权重

<span class="nv">table</span>：映射表。匹配解析<span class="nv">sql</span>中的<span class="nv">table</span>名称，命中<span class="nv">table</span>标签的<span class="nv">name</span>属性值后，会执行约定的路由逻辑

<span class="nv">bean</span>：实体。由其他标签引用，实体类必须有无参的构造函数

<span class="nv">tracker</span>：监控埋点。涉及到计算和<span class="nv">IO</span>的功能点都有监控点，自定义一个埋点实现类，当功能耗时超出预期时会执行其中的回调函数，
便于监控和优化系统

为什么说<span class="nv">Oceanus</span>是非常易用的

<span class="nv">Oceanus</span>在设计时非常注重使用者的评价，配置结构近乎于和使用者交流约定业务规则，便于不同的人看同一套配置，互相理解流程。
当配置文件编写 完成后，编码就变得更加简单，只调用<span class="nv">Oceanus</span>客户端的几个方法就可以实现数据库操作，不再关心<span class="nv">HA</span>、报警、负载均衡、
性能监控等问题。良好的用户视 觉减少了分库分表在业务场景中的耦合度，对于编码者就像只对一个<span class="nv">table</span>操作，<span class="nv">Oceanus</span>负责进行<span class="nv">sql</span>解析、
路由、<span class="nv">sql</span>重写。

如提交：    <span class="nv">select</span> <span class="o">*</span> <span class="nv">from</span> <span class="nv">user</span>； 改写成：    <span class="nv">select</span> <span class="o">*</span> <span class="nv">from</span> <span class="nv">user0</span><span class="c1">;            select * from user1;            </span>
<span class="nv">select</span> <span class="o">*</span> <span class="nv">from</span> <span class="nv">user2</span><span class="c1">;            select * from user3;</span>
分发给不同的库<span class="ss">(</span>或者同库<span class="ss">)</span>执行，用户视觉如图：<span class="nv">github</span>

开源集成

“接地气，拥抱开源” 是<span class="nv">Oceanus</span>的设计原则之一，可以很好的集成到<span class="nv">mybatis</span>和<span class="nv">hibernate</span>中，只要引用其中的插件，编写<span class="nv">Oceanus</span>配置
文件，然后改写各 自的<span class="nv">DataSource</span>实现或<span class="nv">ConnectionProvider</span>即可做到集成。这样既用到了熟悉的<span class="nv">ORM</span>，又借助<span class="nv">Oceanus</span>实现了分库分表等功 能。

待开发

不得不说<span class="nv">Oceanus</span>在设计上非常灵活，使得每一个细小的功能点都有极高的切入价值，比如<span class="nv">Cache</span>机制、全局的<span class="nv">ID</span>生成规则、资源可视化监控
等等，把其中某一个点做得足够好，都会为整体产品带来质的提升，简化实际生产环境中的配套系统研发维护成本。

<span class="nv">vitess</span>:

谷歌开发的数据库中间件，集群基于<span class="nv">ZooKeeper</span>管理，通过<span class="nv">RPC</span>方式进行数据处理，总体分为，<span class="nv">server</span>，<span class="nv">command</span> <span class="nv">line</span>，<span class="nv">gui</span>监控 <span class="mi">3</span>部分。
<span class="nv">https</span>:<span class="o">//</span><span class="nv">github</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">youtube</span><span class="o">/</span><span class="nv">vitess</span>




<span class="nv">OneProxy</span>

 <span class="nv">OneProxy</span>是由原支付宝首席架构师楼方鑫开发，目前由楼方鑫创立的杭州平民软件公司（@平民架构）提供技术支持。它保留了
 <span class="nv">MySQL</span><span class="o">-</span><span class="nv">Proxy</span> <span class="mi">0</span>.<span class="mi">8</span>.<span class="mi">4</span>官方版本上其协议处理和软件框架，然后对软件做了大量优化，极大增强了系统的并发能力。目前已有多家公司
 在生成环境中使用，其中包括了支付、电商等行业。

     <span class="nv">OneProxy</span>的主要功能有：
<span class="mi">1</span>. 垂直分库
<span class="mi">2</span>. 水平分表
<span class="mi">3</span>. <span class="nv">Proxy</span>集群【暂无文档】
<span class="mi">4</span>. 读高可用
<span class="mi">5</span>. 读写分离（<span class="nv">master</span>不参与读）
<span class="mi">6</span>. 读写分离（<span class="nv">master</span>参与读）
<span class="mi">7</span>. 写高可用
<span class="mi">8</span>. 读写随机
<span class="mi">9</span>. <span class="nv">SQL</span>检查
<span class="mi">10</span>. <span class="nv">SQL</span>统计【暂无文档】
<span class="mi">11</span>. 任务队列监控【暂无文档】
<span class="mi">12</span>. 连接池管理【暂无文档】

最新博文在<span class="nv">http</span>:<span class="o">//</span><span class="nv">www</span>.<span class="nv">cnblogs</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">youge</span><span class="o">-</span><span class="nv">OneSQL</span><span class="o">/</span><span class="nv">articles</span><span class="o">/</span><span class="mi">4208583</span>.<span class="nv">html</span>
重要概念
     <span class="nv">Server</span> <span class="nv">Group</span>
     在<span class="nv">OneProxy</span>中，一组主从复制的<span class="nv">MySQL</span>集群被称为<span class="nv">Server</span> <span class="nv">Group</span>。如图. <span class="nv">A</span>所示，有<span class="nv">Server</span> <span class="nv">Group</span> <span class="nv">A</span>和<span class="nv">Server</span> <span class="nv">Group</span> <span class="nv">B</span>。
     <span class="nv">A</span>
                                                            图. <span class="nv">A</span>
     在<span class="nv">OneProxy</span>中，垂直分库和水平分表的实现思路都是建立在<span class="nv">Server</span> <span class="nv">Group</span>的概念上。为了更好地说明，我们假设以下场景。
     <span class="nv">A</span>）<span class="nv">Server</span> <span class="nv">Group</span> <span class="nv">A</span>中有三张表<span class="nv">table</span> <span class="nv">X</span>, <span class="nv">table</span> <span class="nv">Y</span>, <span class="nv">table</span> <span class="nv">Z</span>，其中应用对<span class="nv">table</span> <span class="nv">X</span>操作非常频繁，占用大量<span class="nv">I</span><span class="o">/</span><span class="nv">O</span>带宽，
     严重影响了应用对<span class="nv">tableY</span>, <span class="nv">tableZ</span>的操作效率。
              <span class="nv">B</span>
                                                                      图. <span class="nv">B</span>
     解决方案<span class="mi">1</span>.<span class="mi">0</span>：把<span class="nv">table</span> <span class="nv">X</span>移到另一组数据库，即<span class="nv">Server</span> <span class="nv">Group</span> <span class="nv">B</span>中（如图<span class="nv">C</span>所示），然后通过修改<span class="nv">OneProxy</span>的配置来改变
     <span class="nv">table</span> <span class="nv">X</span>的路由规则，无须改动应用。
<span class="nv">C</span>

                                                                      图. <span class="nv">C</span>
     <span class="nv">B</span>）在使用了解决方案<span class="mi">1</span>.<span class="mi">0</span>后，系统的<span class="nv">I</span><span class="o">/</span><span class="nv">O</span>压力得到缓解。由于后期业务越来越多，<span class="nv">Server</span> <span class="nv">Group</span> <span class="nv">B</span>的写入压力越来越大，
     响应时间变慢。
     解决方案<span class="mi">2</span>.<span class="mi">0</span> : 把<span class="nv">Server</span> <span class="nv">Group</span> <span class="nv">B</span>中的<span class="nv">table</span> <span class="nv">X</span>水平拆分，将<span class="nv">X_00</span>, <span class="nv">X_01</span>留在<span class="nv">Server</span> <span class="nv">Group</span> <span class="nv">B</span>中，把<span class="nv">X_02</span>，<span class="nv">X_03</span>留在
     <span class="nv">Server</span> <span class="nv">Group</span> <span class="nv">C</span>中，如图<span class="nv">D</span>所示
<span class="nv">D</span>
</pre></div>


<h2 id="atlas_keepalived">atlas_keepalived</h2>
<div class="codehilite"><pre><span></span><span class="err">背景描述</span>
<span class="err">目前我们的高可用</span><span class="n">DB</span><span class="err">的代理层采用的是</span><span class="mi">360</span><span class="err">开源的</span><span class="n">Atlas</span><span class="err">，从上线以来，已稳定运行</span><span class="mi">2</span><span class="err">个多月。无论是从性能上，还是稳定性上，</span>
<span class="err">相比其他开源组件（</span><span class="n">amoeba</span><span class="err">、</span><span class="n">cobar</span><span class="err">、</span><span class="n">MaxScale</span><span class="err">、</span><span class="n">MySQL</span><span class="o">-</span><span class="n">Proxy</span><span class="err">等），还是很出色的。</span>

<span class="err">当初我们之所以选择</span><span class="n">Atlas</span><span class="err">，主要看中它有以下优点：</span>
<span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="err">、基于</span><span class="n">mysql</span><span class="o">-</span><span class="n">proxy</span><span class="o">-</span><span class="mf">0.8.2</span><span class="err">进行修改，代码完全开源；</span>
<span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="err">、比较轻量级，部署配置也比较简单；</span>
<span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="err">、支持</span><span class="n">DB</span><span class="err">读写分离；</span>
<span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="err">、支持从</span><span class="n">DB</span><span class="err">读负载均衡，并自动剔除故障从</span><span class="n">DB</span><span class="err">；</span>
<span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="err">、支持平滑上下线</span><span class="n">DB</span><span class="err">；</span>
<span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="err">、具备较好的安全机制（</span><span class="n">IP</span><span class="err">过滤、账号认证）；</span>
<span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="err">、版本更新、问题跟进、交流圈子都比较活跃。</span>

<span class="err">在测试期间以及线上问题排查过程中，得到了</span><span class="mi">360</span> <span class="n">Atlas</span><span class="err">作者朱超的热心解答，在此表示感谢。有关更多</span><span class="n">Atlas</span><span class="err">的介绍，我就不一一例举，</span>
<span class="err">可以参考以下链接：</span>
<span class="nl">https</span><span class="p">:</span><span class="c1">//github.com/Qihoo360/Atlas/blob/master/README_ZH.md</span>

<span class="mi">2</span><span class="err">、总体架构图</span>
<span class="n">wKioL1Sw6iagbaHjAAJX6OZk</span><span class="o">-</span><span class="n">GM940</span><span class="p">.</span><span class="n">jpg</span>

<span class="mi">3</span><span class="err">、系统环境</span>
<span class="n">CentOS</span> <span class="mf">6.3</span> <span class="n">x86_64</span>

<span class="err">需注意的地方</span>
<span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="err">、本次安装不使用系统默认的</span><span class="n">glib</span><span class="err">库，之前的</span><span class="n">yum</span><span class="err">安装只是为了先解决依赖库的问题；</span>
<span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="err">、</span><span class="n">LUA</span><span class="err">库的版本不能太高，为</span><span class="mf">5.1</span><span class="p">.</span><span class="n">x</span><span class="err">即可；</span>
<span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="err">、</span><span class="n">glib</span><span class="err">库的版本也不能太高，为</span><span class="n">glib</span><span class="o">-</span><span class="mf">2.32</span><span class="p">.</span><span class="n">x</span><span class="err">即可；</span>
<span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="err">、对于编译不成功的情况，注意查看下面的说明。</span>


<span class="n">yum</span> <span class="n">install</span> <span class="n">glib</span> <span class="n">glib</span><span class="o">-</span><span class="n">devel</span> <span class="n">ncurses</span> <span class="n">readline</span> <span class="n">lua</span>  <span class="n">libevent</span> <span class="n">libevent</span><span class="o">-</span><span class="n">devel</span> <span class="n">openssl</span> <span class="n">openssl</span><span class="o">-</span><span class="n">devel</span> <span class="o">-</span><span class="n">y</span>

<span class="nl">https</span><span class="p">:</span><span class="c1">//github.com/Qihoo360/Atlas/wiki/</span>

<span class="err">从</span><span class="nl">https</span><span class="p">:</span><span class="c1">//github.com/Qihoo360/Atlas/releases 页面下载最新版RPM包，然后执行：</span>
<span class="n">sudo</span> <span class="n">rpm</span> <span class="err">–</span><span class="n">i</span> <span class="n">Atlas</span><span class="o">-</span><span class="n">XX</span><span class="p">.</span><span class="n">el6</span><span class="p">.</span><span class="n">x86_64</span><span class="p">.</span><span class="n">rpm</span><span class="err">安装。</span>

<span class="n">Atlas</span><span class="err">运行需要依赖一个配置文件（</span><span class="n">test</span><span class="p">.</span><span class="n">cnf</span><span class="err">）。在运行</span><span class="n">Atlas</span><span class="err">之前，需要对该文件进行配置。</span><span class="n">Atlas</span><span class="err">的安装目录是</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">mysql</span><span class="o">-</span><span class="n">proxy</span><span class="err">，</span>
<span class="err">进入安装目录下的</span><span class="n">conf</span><span class="err">目录，可以看到已经有一个名为</span><span class="n">test</span><span class="p">.</span><span class="n">cnf</span><span class="err">的默认配置文件，我们只需要修改里面的某些配置项，不需要从头写一个配置文件。</span>

<span class="mf">1.</span><span class="err">配置范例及说明如下：</span>
<span class="p">[</span><span class="n">mysql</span><span class="o">-</span><span class="n">proxy</span><span class="p">]</span>

<span class="p">(</span><span class="err">必备，默认值即可</span><span class="p">)</span><span class="err">管理接口的用户名</span>
<span class="n">admin</span><span class="o">-</span><span class="n">username</span> <span class="o">=</span> <span class="n">user</span>
<span class="p">(</span><span class="err">必备，默认值即可</span><span class="p">)</span><span class="err">管理接口的密码</span>
<span class="n">admin</span><span class="o">-</span><span class="n">password</span> <span class="o">=</span> <span class="n">pwd</span>
<span class="p">(</span><span class="err">必备，根据实际情况配置</span><span class="p">)</span><span class="err">主库的</span><span class="n">IP</span><span class="err">和端口</span>
<span class="n">proxy</span><span class="o">-</span><span class="n">backend</span><span class="o">-</span><span class="n">addresses</span> <span class="o">=</span> <span class="mf">192.168.0.12</span><span class="o">:</span><span class="mi">3306</span>
<span class="p">(</span><span class="err">非必备，根据实际情况配置</span><span class="p">)</span><span class="err">从库的</span><span class="n">IP</span><span class="err">和端口，</span><span class="p">@</span><span class="err">后面的数字代表权重，用来作负载均衡，若省略则默认为</span><span class="mi">1</span><span class="err">，可设置多项，用逗号分隔。</span>
<span class="err">如果想让主库也能分担读请求的话，只需要将主库信息加入到下面的配置项中。</span>
<span class="n">proxy</span><span class="o">-</span><span class="n">read</span><span class="o">-</span><span class="n">only</span><span class="o">-</span><span class="n">backend</span><span class="o">-</span><span class="n">addresses</span> <span class="o">=</span> <span class="mf">192.168.0.13</span><span class="o">:</span><span class="mi">3306</span><span class="p">,</span><span class="mf">192.168.0.14</span><span class="o">:</span><span class="mi">3306</span>
<span class="p">(</span><span class="err">必备，根据实际情况配置</span><span class="p">)</span><span class="err">用户名与其对应的加密过的</span><span class="n">MySQL</span><span class="err">密码，密码使用</span><span class="n">PREFIX</span><span class="o">/</span><span class="n">bin</span><span class="err">目录下的加密程序</span><span class="n">encrypt</span><span class="err">加密，用户名与密码</span>
<span class="err">之间用冒号分隔。主从数据库上需要先创建该用户并设置密码（用户名和密码在主从数据库上要一致）。比如用户名为</span><span class="n">myuser</span><span class="err">，密码为</span><span class="n">mypwd</span><span class="err">，</span>
<span class="err">执行</span><span class="p">.</span><span class="o">/</span><span class="n">encrypt</span> <span class="n">mypwd</span><span class="err">结果为</span><span class="n">HJBoxfRsjeI</span><span class="o">=</span><span class="err">。如果有多个用户用逗号分隔即可。则设置如下行所示：</span>
<span class="n">pwds</span> <span class="o">=</span> <span class="nl">myuser</span><span class="p">:</span> <span class="n">HJBoxfRsjeI</span><span class="o">=</span><span class="p">,</span><span class="nl">myuser2</span><span class="p">:</span><span class="n">HJBoxfRsjeI</span><span class="o">=</span>
<span class="err">（必备，默认值即可</span><span class="p">)</span><span class="n">Atlas</span><span class="err">的运行方式，设为</span><span class="nb">true</span><span class="err">时为守护进程方式，设为</span><span class="nb">false</span><span class="err">时为前台方式，一般开发调试时设为</span><span class="nb">false</span><span class="err">，线上运行时</span>
<span class="err">设为</span><span class="nb">true</span>
<span class="n">daemon</span> <span class="o">=</span> <span class="nb">true</span>
<span class="p">(</span><span class="err">必备，默认值即可</span><span class="p">)</span><span class="err">设置</span><span class="n">Atlas</span><span class="err">的运行方式，设为</span><span class="nb">true</span><span class="err">时</span><span class="n">Atlas</span><span class="err">会启动两个进程，一个为</span><span class="n">monitor</span><span class="err">，一个为</span><span class="n">worker</span><span class="err">，</span><span class="n">monitor</span><span class="err">在</span><span class="n">worker</span><span class="err">意外退</span>
<span class="err">出后会自动将其重启，设为</span><span class="nb">false</span><span class="err">时只有</span><span class="n">worker</span><span class="err">，没有</span><span class="n">monitor</span><span class="err">，一般开发调试时设为</span><span class="nb">false</span><span class="err">，线上运行时设为</span><span class="nb">true</span>
<span class="n">keepalive</span> <span class="o">=</span> <span class="nb">true</span>
<span class="p">(</span><span class="err">必备，根据实际情况配置</span><span class="p">)</span><span class="err">工作线程数，推荐设置成系统的</span><span class="n">CPU</span><span class="err">核数的</span><span class="mi">2</span><span class="err">至</span><span class="mi">4</span><span class="err">倍</span>
<span class="n">event</span><span class="o">-</span><span class="n">threads</span> <span class="o">=</span> <span class="mi">4</span>
<span class="p">(</span><span class="err">必备，默认值即可</span><span class="p">)</span><span class="err">日志级别，分为</span><span class="n">message</span><span class="err">、</span><span class="n">warning</span><span class="err">、</span><span class="n">critical</span><span class="err">、</span><span class="n">error</span><span class="err">、</span><span class="n">debug</span><span class="err">五个级别</span>
<span class="n">log</span><span class="o">-</span><span class="n">level</span> <span class="o">=</span> <span class="n">message</span>
<span class="p">(</span><span class="err">必备，默认值即可</span><span class="p">)</span><span class="err">日志存放的路径</span>
<span class="n">log</span><span class="o">-</span><span class="n">path</span> <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">mysql</span><span class="o">-</span><span class="n">proxy</span><span class="o">/</span><span class="n">log</span>
<span class="p">(</span><span class="err">必备，根据实际情况配置</span><span class="p">)</span><span class="n">SQL</span><span class="err">日志的开关，可设置为</span><span class="n">OFF</span><span class="err">、</span><span class="n">ON</span><span class="err">、</span><span class="n">REALTIME</span><span class="err">，</span><span class="n">OFF</span><span class="err">代表不记录</span><span class="n">SQL</span><span class="err">日志，</span><span class="n">ON</span><span class="err">代表记录</span><span class="n">SQL</span><span class="err">日志，该模式下日志</span>
<span class="err">刷新是基于缓冲区的，当日志填满缓冲区后，才将日志信息刷到磁盘。</span><span class="n">REALTIME</span><span class="err">用于调试，代表记录</span><span class="n">SQL</span><span class="err">日志且实时写入磁盘，默认为</span><span class="n">OFF</span>
<span class="n">sql</span><span class="o">-</span><span class="n">log</span> <span class="o">=</span> <span class="n">OFF</span>
<span class="p">(</span><span class="err">可选项，可不设置）慢日志输出设置。当设置了该参数时，则日志只输出执行时间超过</span><span class="n">sql</span><span class="o">-</span><span class="n">log</span><span class="o">-</span><span class="n">slow</span><span class="err">（单位：</span><span class="n">ms</span><span class="p">)</span><span class="err">的日志记录。不设置该</span>
<span class="err">参数则输出全部日志。</span>
<span class="n">sql</span><span class="o">-</span><span class="n">log</span><span class="o">-</span><span class="n">slow</span> <span class="o">=</span> <span class="mi">10</span>
<span class="p">(</span><span class="err">可选项，可不设置）关闭不活跃的客户端连接设置。当设置了该参数时，</span><span class="n">Atlas</span><span class="err">会主动关闭经过&#39;</span><span class="n">wait</span><span class="o">-</span><span class="n">timeout</span><span class="err">&#39;时间后一直未活跃的连接。单位：秒</span>
<span class="n">wait</span><span class="o">-</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span>
<span class="p">(</span><span class="err">必备，默认值即可</span><span class="p">)</span><span class="n">Atlas</span><span class="err">监听的工作接口</span><span class="n">IP</span><span class="err">和端口</span>
<span class="n">proxy</span><span class="o">-</span><span class="n">address</span> <span class="o">=</span> <span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">1234</span>
<span class="p">(</span><span class="err">必备，默认值即可</span><span class="p">)</span><span class="n">Atlas</span><span class="err">监听的管理接口</span><span class="n">IP</span><span class="err">和端口</span> <span class="n">admin</span><span class="o">-</span><span class="n">address</span> <span class="o">=</span> <span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">2345</span>
<span class="p">(</span><span class="err">可选项，可不设置</span><span class="p">)</span><span class="err">分表设置，此例中</span><span class="n">person</span><span class="err">为库名，</span><span class="n">mt</span><span class="err">为表名，</span><span class="kt">id</span><span class="err">为分表字段，</span><span class="mi">3</span><span class="err">为子表数量，可设置多项，以逗号分隔，若不分表则不</span>
<span class="err">需要设置该项，子表需要事先建好，子表名称为表名</span><span class="n">_</span><span class="err">数字，数字范围为</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="err">子表数</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="err">，如本例里，子表名称为</span><span class="n">mt_0</span><span class="err">、</span><span class="n">mt_1</span><span class="err">、</span><span class="n">mt_2</span>
<span class="n">tables</span> <span class="o">=</span> <span class="n">person</span><span class="p">.</span><span class="n">mt</span><span class="p">.</span><span class="kt">id</span><span class="mf">.3</span>
<span class="p">(</span><span class="err">可选项，可不设置</span><span class="p">)</span><span class="err">默认字符集，若不设置该项，则默认字符集为</span><span class="n">latin1</span>
<span class="n">charset</span> <span class="o">=</span> <span class="n">utf8</span>
<span class="p">(</span><span class="err">可选项，可不设置</span><span class="p">)</span><span class="err">允许连接</span><span class="n">Atlas</span><span class="err">的客户端的</span><span class="n">IP</span><span class="err">，可以是精确</span><span class="n">IP</span><span class="err">，也可以是</span><span class="n">IP</span><span class="err">段，以逗号分隔，若不设置该项则允许所有</span><span class="n">IP</span><span class="err">连接，否则</span>
<span class="err">只允许列表中的</span><span class="n">IP</span><span class="err">连接</span>
<span class="n">client</span><span class="o">-</span><span class="n">ips</span> <span class="o">=</span> <span class="mf">127.0.0.1</span><span class="p">,</span> <span class="mf">192.168.1</span>
<span class="p">(</span><span class="err">可选项，极少需要</span><span class="p">)</span><span class="n">Atlas</span><span class="err">前面挂接的</span><span class="n">LVS</span><span class="err">的物理网卡的</span><span class="n">IP</span><span class="p">(</span><span class="err">注意不是虚</span><span class="n">IP</span><span class="p">)</span><span class="err">，若有</span><span class="n">LVS</span><span class="err">且设置了</span><span class="n">client</span><span class="o">-</span><span class="n">ips</span><span class="err">则此项必须设置，否则可以不设置</span>
<span class="n">lvs</span><span class="o">-</span><span class="n">ips</span> <span class="o">=</span> <span class="mf">192.168.1.1</span>

<span class="mf">2.</span> <span class="err">重要配置说明</span>
<span class="err">以下几项配置参数对性能和正常运行起到重要作用，需要正确设置。</span>
<span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="err">线程数</span>
<span class="n">event</span><span class="o">-</span><span class="n">threads</span><span class="err">项设置，过小无法充分发挥多核</span><span class="n">CPU</span><span class="err">的性能，过大造成不必要的线程切换开销，推荐设置为</span><span class="n">CPU</span><span class="err">的核数。</span>
<span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="err">最小空闲连接数</span><span class="p">(</span><span class="mf">2.</span><span class="n">x</span><span class="err">以上版本不需要该项，</span><span class="mf">1.</span><span class="n">x</span><span class="err">版本需要</span><span class="p">)</span>
<span class="n">min</span><span class="o">-</span><span class="n">idle</span><span class="o">-</span><span class="n">connections</span><span class="err">项设置，过小则在高并发下会有报错，过大虽然不报错但在测试时不容易看出读写分离效果，推荐设置为比客户端</span>
<span class="err">的并发峰值稍大，详见《配置参数详解》。上面的配置范例是针对</span><span class="n">Atlas</span> <span class="mf">2.</span><span class="n">X</span><span class="err">版本，没有该选项。对于</span><span class="n">Atlas</span> <span class="mf">1.</span><span class="n">X</span><span class="err">版本的配置文件，需要加入</span>
<span class="err">该配置选项。</span>
<span class="mf">3.</span> <span class="err">可选配置说明</span>
<span class="err">以下几项可以设置，也可以使用默认值，区别不大。</span>
<span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="n">Atlas</span><span class="err">的工作端口</span>
<span class="n">proxy</span><span class="o">-</span><span class="n">address</span><span class="err">项配置，例如</span><span class="n">proxy</span><span class="o">-</span><span class="n">address</span> <span class="o">=</span> <span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">1234</span><span class="err">代表客户端应该使用</span><span class="mi">1234</span><span class="err">这个端口连接</span><span class="n">Atlas</span><span class="err">来发送</span><span class="n">SQL</span><span class="err">请求。</span>
<span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="n">Atlas</span><span class="err">的管理端口</span>
<span class="n">admin</span><span class="o">-</span><span class="n">address</span><span class="err">项配置，例如</span><span class="n">admin</span><span class="o">-</span><span class="n">address</span> <span class="o">=</span> <span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">2345</span><span class="err">代表</span><span class="n">DBA</span><span class="err">应该使用</span><span class="mi">2345</span><span class="err">这个端口连接</span><span class="n">Atlas</span><span class="err">来执行运维管理操作。</span>
<span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="err">管理接口的用户名和密码</span>
<span class="n">admin</span><span class="o">-</span><span class="n">username</span><span class="err">项和</span><span class="n">admin</span><span class="o">-</span><span class="n">password</span><span class="err">项设置，这两项是用来进入</span><span class="n">Atlas</span><span class="err">的管理界面的，与后端连接的</span><span class="n">MySQL</span><span class="err">没有关系，所以可以任意设</span>
<span class="err">置，不需要</span><span class="n">MySQL</span><span class="err">在配置上做任何改动。</span>
<span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="err">日志级别</span>
<span class="err">以</span><span class="n">log</span><span class="o">-</span><span class="n">level</span><span class="err">项配置，分为</span><span class="n">message</span><span class="err">、</span><span class="n">warning</span><span class="err">、</span><span class="n">critical</span><span class="err">、</span><span class="n">error</span><span class="err">、</span><span class="n">debug</span><span class="err">五个级别</span>
<span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="err">日志路径</span>
<span class="err">以</span><span class="n">log</span><span class="o">-</span><span class="n">path</span><span class="err">项配置，如</span><span class="n">log</span><span class="o">-</span><span class="n">path</span> <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">mysql</span><span class="o">-</span><span class="n">proxy</span><span class="o">/</span><span class="n">log</span><span class="err">。</span>

<span class="err">进入</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">mysql</span><span class="o">-</span><span class="n">proxy</span><span class="o">/</span><span class="n">bin</span><span class="err">目录，执行下面的命令启动、重启或停止</span><span class="n">Atlas</span><span class="err">。</span>
<span class="p">(</span><span class="mi">1</span><span class="p">).</span> <span class="n">sudo</span> <span class="p">.</span><span class="o">/</span><span class="n">mysql</span><span class="o">-</span><span class="n">proxyd</span> <span class="n">test</span> <span class="n">start</span><span class="err">，启动</span><span class="n">Atlas</span><span class="err">。</span>
<span class="p">(</span><span class="mi">2</span><span class="p">).</span> <span class="n">sudo</span> <span class="p">.</span><span class="o">/</span><span class="n">mysql</span><span class="o">-</span><span class="n">proxyd</span> <span class="n">test</span> <span class="n">restart</span><span class="err">，重启</span><span class="n">Atlas</span><span class="err">。</span>
<span class="p">(</span><span class="mi">3</span><span class="p">).</span> <span class="n">sudo</span> <span class="p">.</span><span class="o">/</span><span class="n">mysql</span><span class="o">-</span><span class="n">proxyd</span> <span class="n">test</span> <span class="n">stop</span><span class="err">，停止</span><span class="n">Atlas</span><span class="err">。</span>
<span class="err">注意：</span>
<span class="p">(</span><span class="mi">1</span><span class="p">).</span> <span class="err">运行文件是：</span><span class="n">mysql</span><span class="o">-</span><span class="n">proxyd</span><span class="p">(</span><span class="err">不是</span><span class="n">mysql</span><span class="o">-</span><span class="n">proxy</span><span class="p">)</span><span class="err">。</span>
<span class="p">(</span><span class="mi">2</span><span class="p">).</span> <span class="n">test</span><span class="err">是</span><span class="n">conf</span><span class="err">目录下配置文件的名字，也是配置文件里</span><span class="n">instance</span><span class="err">项的名字，三者需要统一。</span>
<span class="p">(</span><span class="mi">3</span><span class="p">).</span> <span class="err">可以使用</span><span class="n">ps</span> <span class="o">-</span><span class="n">ef</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">mysql</span><span class="o">-</span><span class="n">proxy</span><span class="err">查看</span><span class="n">Atlas</span><span class="err">是否已经启动或停止。</span>
<span class="err">执行命令：</span><span class="n">mysql</span> <span class="o">-</span><span class="n">h127</span><span class="mf">.0.0.1</span> <span class="o">-</span><span class="n">P1234</span> <span class="o">-</span><span class="n">u</span><span class="err">用户名</span> <span class="o">-</span><span class="n">p</span><span class="err">密码，如果能连上则证明</span><span class="n">Atlas</span><span class="err">初步测试正常，可以再尝试发几条</span><span class="n">SQL</span><span class="err">语句看看执行</span>
<span class="err">结果是否正确。</span>
<span class="err">进入</span><span class="n">Atlas</span><span class="err">的管理界面的命令：</span><span class="n">mysql</span> <span class="o">-</span><span class="n">h127</span><span class="mf">.0.0.1</span> <span class="o">-</span><span class="n">P2345</span> <span class="o">-</span><span class="n">uuser</span> <span class="o">-</span><span class="n">ppwd</span><span class="err">，进入后执行</span><span class="o">:</span><span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">help</span><span class="p">;</span><span class="err">查看管理</span><span class="n">DB</span><span class="err">的各类命令。</span>

<span class="n">Atlas</span><span class="err">高可用【</span><span class="n">Keepalived</span><span class="err">】</span>
<span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="err">、主节点配置</span>
<span class="cp"># vim /etc/keepalived/keepalived.conf</span>

<span class="n">global_defs</span> <span class="p">{</span>
    <span class="n">notification_email</span> <span class="p">{</span>
        <span class="n">lovezym5</span><span class="mf">@126.</span><span class="n">com</span>
    <span class="p">}</span>

    <span class="n">notification_email_from</span> <span class="n">lovezym5</span><span class="mf">@126.</span><span class="n">com</span>
    <span class="n">smtp_server</span> <span class="mf">127.0.0.1</span>
    <span class="n">smtp_connect_timeout</span> <span class="mi">30</span>
    <span class="n">router_id</span> <span class="n">dbproxy1</span>
<span class="p">}</span>

<span class="n">vrrp_script</span> <span class="n">chk_mysql_proxy_health</span> <span class="p">{</span>
    <span class="n">script</span> <span class="s">&quot;/data/scripts/keepalived_check_mysql_proxy.sh&quot;</span>
    <span class="n">interval</span> <span class="mi">1</span>
    <span class="n">weight</span> <span class="o">-</span><span class="mi">2</span>
<span class="p">}</span>

<span class="n">vrrp_instance</span> <span class="n">VI_1</span> <span class="p">{</span>
    <span class="n">state</span> <span class="n">MASTER</span>
    <span class="n">interface</span> <span class="n">eth1</span>
    <span class="n">virtual_router_id</span> <span class="mi">51</span>
    <span class="n">priority</span> <span class="mi">100</span>
    <span class="n">advert_int</span> <span class="mi">1</span>
    <span class="n">smtp_alert</span>

    <span class="n">authentication</span> <span class="p">{</span>
        <span class="n">auth_type</span> <span class="n">PASS</span>
        <span class="n">auth_pass</span> <span class="mi">123456</span>
    <span class="p">}</span>

    <span class="n">virtual_ipaddress</span> <span class="p">{</span>
        <span class="mf">10.209.6.115</span>
    <span class="p">}</span>

    <span class="n">track_script</span> <span class="p">{</span>
        <span class="n">chk_mysql_proxy_health</span>
    <span class="p">}</span>

    <span class="n">notify_master</span> <span class="s">&quot;/data/scripts/notify.sh master&quot;</span>
    <span class="n">notify_bakcup</span> <span class="s">&quot;/data/scripts/notify.sh backup&quot;</span>
    <span class="n">notify_fault</span> <span class="s">&quot;/data/scripts/notify.sh fault&quot;</span>
<span class="p">}</span>
<span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="err">、备用节点配置</span>
<span class="cp"># vim /etc/keepalived/keepalived.conf</span>

<span class="n">global_defs</span> <span class="p">{</span>
    <span class="n">notification_email</span> <span class="p">{</span>
        <span class="n">lovezym5</span><span class="mf">@126.</span><span class="n">com</span>
    <span class="p">}</span>

    <span class="n">notification_email_from</span> <span class="n">lovezym5</span><span class="mf">@126.</span><span class="n">com</span>
    <span class="n">smtp_server</span> <span class="mf">127.0.0.1</span>
    <span class="n">smtp_connect_timeout</span> <span class="mi">30</span>
    <span class="n">router_id</span> <span class="n">dbproxy2</span>
<span class="p">}</span>

<span class="n">vrrp_script</span> <span class="n">chk_mysql_proxy_health</span> <span class="p">{</span>
    <span class="n">script</span> <span class="s">&quot;/data/scripts/keepalived_check_mysql_proxy.sh&quot;</span>
    <span class="n">interval</span> <span class="mi">1</span>
    <span class="n">weight</span> <span class="o">-</span><span class="mi">2</span>
<span class="p">}</span>

<span class="n">vrrp_instance</span> <span class="n">VI_1</span> <span class="p">{</span>
    <span class="n">state</span> <span class="n">BACKUP</span>
    <span class="n">interface</span> <span class="n">eth1</span>
    <span class="n">virtual_router_id</span> <span class="mi">51</span>
    <span class="n">priority</span> <span class="mi">90</span>
    <span class="n">advert_int</span> <span class="mi">1</span>
    <span class="n">smtp_alert</span>

    <span class="n">authentication</span> <span class="p">{</span>
        <span class="n">auth_type</span> <span class="n">PASS</span>
        <span class="n">auth_pass</span> <span class="mi">123456</span>
    <span class="p">}</span>

    <span class="n">virtual_ipaddress</span> <span class="p">{</span>
        <span class="mf">10.209.6.115</span>
    <span class="p">}</span>

    <span class="n">track_script</span> <span class="p">{</span>
        <span class="n">chk_mysql_proxy_health</span>
    <span class="p">}</span>

    <span class="n">notify_master</span> <span class="s">&quot;/data/scripts/notify.sh master&quot;</span>
    <span class="n">notify_bakcup</span> <span class="s">&quot;/data/scripts/notify.sh backup&quot;</span>
    <span class="n">notify_fault</span> <span class="s">&quot;/data/scripts/notify.sh fault&quot;</span>
<span class="p">}</span>
<span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="err">、</span><span class="n">VIP</span><span class="err">切换通知脚本</span>
<span class="cp"># vim /data/scripts/notify.sh</span>

<span class="cp">#!/bin/sh</span>
<span class="n">PATH</span><span class="o">=/</span><span class="nl">sbin</span><span class="p">:</span><span class="o">/</span><span class="nl">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nl">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nl">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nl">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span>

<span class="n">KEEPALIVE_CONF</span><span class="o">=</span><span class="s">&quot;/etc/keepalived/keepalived.conf&quot;</span>

<span class="n">VIP</span><span class="o">=</span><span class="err">`</span><span class="n">grep</span> <span class="o">-</span><span class="n">A</span> <span class="mi">1</span> <span class="n">virtual_ipaddress</span> <span class="err">$</span><span class="p">{</span><span class="n">KEEPALIVE_CONF</span><span class="p">}</span> <span class="o">|</span> <span class="n">tail</span> <span class="o">-</span><span class="mi">1</span> <span class="o">|</span> <span class="n">sed</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="err">\</span><span class="n">t</span><span class="c1">//g; s/ //g&#39;`</span>
<span class="n">ETH1_ADDR</span><span class="o">=</span><span class="err">`</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">ifconfig</span> <span class="n">eth1</span> <span class="o">|</span> <span class="n">awk</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">inet</span> <span class="nl">addr</span><span class="p">:</span><span class="o">/</span><span class="p">{</span><span class="n">print</span> <span class="err">$</span><span class="mi">2</span><span class="p">}</span><span class="err">&#39;</span> <span class="o">|</span> <span class="n">awk</span> <span class="o">-</span><span class="nl">F</span><span class="p">:</span> <span class="err">&#39;</span><span class="p">{</span><span class="n">print</span> <span class="err">$</span><span class="mi">2</span><span class="p">}</span><span class="err">&#39;`</span>

<span class="n">MONITOR</span><span class="o">=</span><span class="s">&quot;/usr/local/oms/agent/alarm/BusMonitorAgent&quot;</span>
<span class="n">TOKEN</span><span class="o">=</span><span class="s">&quot;ha_monitor&quot;</span>

<span class="n">function</span> <span class="n">notify</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">TITLE</span><span class="o">=</span><span class="s">&quot;$ETH1_ADDR to be $1: $VIP floating&quot;</span>
    <span class="n">CONTENT</span><span class="o">=</span><span class="s">&quot;vrrp transition, $ETH1_ADDR changed to be $1&quot;</span>
    <span class="err">$</span><span class="p">{</span><span class="n">MONITOR</span><span class="p">}</span> <span class="o">-</span><span class="n">c</span> <span class="mi">2</span> <span class="o">-</span><span class="n">f</span> <span class="err">$</span><span class="p">{</span><span class="n">TOKEN</span><span class="p">}</span> <span class="o">-</span><span class="n">t</span> <span class="s">&quot;${TITLE}&quot;</span> <span class="o">-</span><span class="n">i</span> <span class="s">&quot;${CONTENT}&quot;</span>
<span class="p">}</span>

<span class="k">case</span> <span class="s">&quot;$1&quot;</span> <span class="k">in</span>
<span class="n">master</span><span class="p">)</span>
    <span class="n">notify</span> <span class="n">master</span>
    <span class="n">exit</span> <span class="mi">0</span>
    <span class="p">;;</span>

<span class="n">backup</span><span class="p">)</span>
    <span class="n">notify</span> <span class="n">backup</span>
    <span class="n">exit</span> <span class="mi">0</span>
    <span class="p">;;</span>

<span class="n">fault</span><span class="p">)</span>
    <span class="n">notify</span> <span class="n">fault</span>
    <span class="n">exit</span> <span class="mi">0</span>
    <span class="p">;;</span>

<span class="o">*</span><span class="p">)</span>
    <span class="n">echo</span> <span class="err">&#39;</span><span class="nl">Usage</span><span class="p">:</span> <span class="err">`</span><span class="n">basename</span> <span class="err">$</span><span class="mi">0</span><span class="err">`</span> <span class="p">{</span><span class="n">master</span><span class="o">|</span><span class="n">backup</span><span class="o">|</span><span class="n">fault</span><span class="p">}</span><span class="err">&#39;</span>
    <span class="n">exit</span> <span class="mi">1</span>
    <span class="p">;;</span>
<span class="n">esac</span>
<span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="err">、</span><span class="n">DB</span><span class="err">中间层进程检查脚本</span>
<span class="cp"># vim /data/scripts/keepalived_check_mysql_proxy.sh</span>

<span class="cp">#!/bin/sh</span>
<span class="n">PATH</span><span class="o">=/</span><span class="nl">sbin</span><span class="p">:</span><span class="o">/</span><span class="nl">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nl">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nl">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nl">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span>

<span class="k">if</span> <span class="p">[[</span> <span class="err">`</span><span class="n">pgrep</span> <span class="n">mysql</span><span class="o">-</span><span class="n">proxy</span> <span class="o">|</span> <span class="n">wc</span> <span class="o">-</span><span class="n">l</span><span class="err">`</span> <span class="o">-</span><span class="n">eq</span> <span class="mi">0</span> <span class="p">]];</span> <span class="n">then</span>
    <span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">service</span> <span class="n">mysql</span><span class="o">-</span><span class="n">proxy</span> <span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="n">sleep</span> <span class="mi">5</span>
    <span class="p">[[</span> <span class="o">-</span><span class="n">z</span> <span class="err">`</span><span class="n">pgrep</span> <span class="n">mysql</span><span class="o">-</span><span class="n">proxy</span><span class="err">`</span> <span class="p">]]</span> <span class="o">&amp;&amp;</span> <span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">service</span> <span class="n">keepalived</span> <span class="n">stop</span>
<span class="n">fi</span>
<span class="cp"># chmod +x /data/scripts/*.sh</span>
<span class="cp"># service keepalived start</span>
<span class="n">wKioL1Sw72OBWcdcAABQovflyow736</span><span class="p">.</span><span class="n">jpg</span>
<span class="cp"># ip addr show eth1</span>
<span class="n">wKiom1Sw7r3S6v6_AACfXZvxonQ064</span><span class="p">.</span><span class="n">jpg</span>
<span class="cp"># ps aux | grep keepalive[d]</span>
<span class="n">wKiom1Sw7tnzsSOAAABqz91YIVo562</span><span class="p">.</span><span class="n">jpg</span>

<span class="o">==========================================================================================</span>
<span class="err">三、其他设置</span>
<span class="o">==========================================================================================</span>
<span class="mi">1</span><span class="err">、</span><span class="n">Atlas</span><span class="err">服务监控</span>
<span class="cp"># vim /usr/local/mysql-proxy/bin/check_service.sh</span>

<span class="cp">#!/bin/sh</span>
<span class="n">PATH</span><span class="o">=/</span><span class="nl">sbin</span><span class="p">:</span><span class="o">/</span><span class="nl">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nl">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nl">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nl">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span>

<span class="p">[[</span> <span class="err">$#</span> <span class="o">-</span><span class="n">ne</span> <span class="mi">3</span> <span class="p">]]</span> <span class="o">&amp;&amp;</span> <span class="n">echo</span> <span class="s">&quot;$0 端口号 协议类型 服务名&quot;</span> <span class="o">&amp;&amp;</span> <span class="n">exit</span> <span class="mi">1</span>

<span class="n">SRV_PORT</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span>  <span class="err">##</span> <span class="err">端口号</span>
<span class="n">SRV_PROT</span><span class="o">=</span><span class="err">$</span><span class="mi">2</span>  <span class="err">##</span> <span class="err">协议类型</span>
<span class="n">SRV_NAME</span><span class="o">=</span><span class="err">$</span><span class="mi">3</span>  <span class="err">##</span> <span class="err">服务名</span>

<span class="n">MONITOR</span><span class="o">=</span><span class="s">&quot;/usr/local/oms/agent/alarm/BusMonitorAgent&quot;</span>
<span class="n">TOKEN</span><span class="o">=</span><span class="s">&quot;ha_monitor&quot;</span>

<span class="n">TITLE</span><span class="o">=</span><span class="s">&quot;${SRV_NAME}服务异常监控&quot;</span>
<span class="n">CONTENT</span><span class="o">=</span><span class="s">&quot;${SRV_NAME}服务发生异常，已自动拉起！&quot;</span>

<span class="cp">## 是否已正确扫描</span>
<span class="n">SCAN_FLAG</span><span class="o">=</span><span class="mi">0</span>

<span class="n">function</span> <span class="n">RESTART_SRV_AND_ALERT</span><span class="p">()</span> 
<span class="p">{</span>
    <span class="n">local</span> <span class="n">CUR_SRV_NAME</span>

    <span class="p">[[</span> <span class="err">$#</span> <span class="o">-</span><span class="n">ne</span> <span class="mi">1</span> <span class="p">]]</span> <span class="o">&amp;&amp;</span> <span class="n">exit</span> <span class="mi">1</span>
    <span class="n">CUR_SRV_NAME</span><span class="o">=</span><span class="err">$</span><span class="mi">1</span>

    <span class="n">TMP_SRV_NAME</span><span class="o">=</span><span class="err">`</span><span class="n">echo</span> <span class="err">$</span><span class="p">{</span><span class="n">CUR_SRV_NAME</span><span class="p">}</span> <span class="o">|</span> <span class="n">tr</span> <span class="err">&#39;</span><span class="p">[</span><span class="n">A</span><span class="o">-</span><span class="n">Z</span><span class="p">]</span><span class="sc">&#39; &#39;</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="n">z</span><span class="p">]</span><span class="err">&#39;`</span>
    <span class="p">[[</span> <span class="o">!</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="err">$</span><span class="p">{</span><span class="n">TMP_SRV_NAME</span><span class="p">}</span> <span class="p">]]</span> <span class="o">&amp;&amp;</span> <span class="n">TMP_SRV_NAME</span><span class="o">=</span><span class="s">&quot;${TMP_SRV_NAME}d&quot;</span>

    <span class="n">killall</span> <span class="o">-</span><span class="mi">9</span> <span class="err">$</span><span class="p">{</span><span class="n">TMP_SRV_NAME</span><span class="p">}</span>

    <span class="k">if</span> <span class="p">[[</span> <span class="o">-</span><span class="n">z</span> <span class="err">`</span><span class="n">ps</span> <span class="n">aux</span> <span class="o">|</span> <span class="n">grep</span> <span class="err">$</span><span class="p">{</span><span class="n">TMP_SRV_NAME</span><span class="p">}</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">v</span> <span class="n">grep</span><span class="err">`</span> <span class="p">]];</span> <span class="n">then</span>
        <span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">service</span> <span class="err">$</span><span class="p">{</span><span class="n">TMP_SRV_NAME</span><span class="p">}</span> <span class="n">start</span> <span class="o">&gt;/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>
    <span class="n">fi</span>

    <span class="err">$</span><span class="p">{</span><span class="n">MONITOR</span><span class="p">}</span> <span class="o">-</span><span class="n">c</span> <span class="mi">2</span> <span class="o">-</span><span class="n">f</span> <span class="err">$</span><span class="p">{</span><span class="n">TOKEN</span><span class="p">}</span> <span class="o">-</span><span class="n">t</span> <span class="s">&quot;${TITLE}&quot;</span> <span class="o">-</span><span class="n">i</span> <span class="s">&quot;${CONTENT}&quot;</span>
    <span class="n">rm</span> <span class="o">-</span><span class="n">f</span> <span class="err">`</span><span class="n">pwd</span><span class="err">`</span><span class="o">/</span><span class="n">connect_error</span><span class="p">.</span><span class="n">log</span>
<span class="p">}</span>

<span class="n">ETH1_ADDR</span><span class="o">=</span><span class="err">`</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">ifconfig</span> <span class="n">eth1</span> <span class="o">|</span> <span class="n">awk</span> <span class="o">-</span><span class="n">F</span> <span class="sc">&#39;:&#39;</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">inet</span> <span class="n">addr</span><span class="o">/</span><span class="p">{</span><span class="n">print</span> <span class="err">$</span><span class="mi">2</span><span class="p">}</span><span class="err">&#39;</span> <span class="o">|</span> <span class="n">sed</span> <span class="err">&#39;</span><span class="n">s</span><span class="o">/</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="n">zA</span><span class="o">-</span><span class="n">Z</span> <span class="p">]</span><span class="c1">//g&#39;`</span>
<span class="n">TMP_SRV_PROT</span><span class="o">=</span><span class="err">`</span><span class="n">echo</span> <span class="err">$</span><span class="p">{</span><span class="n">SRV_PROT</span><span class="p">}</span> <span class="o">|</span> <span class="n">tr</span> <span class="err">&#39;</span><span class="p">[</span><span class="n">A</span><span class="o">-</span><span class="n">Z</span><span class="p">]</span><span class="sc">&#39; &#39;</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="n">z</span><span class="p">]</span><span class="err">&#39;`</span>

<span class="k">if</span> <span class="p">[[</span> <span class="s">&quot;${TMP_SRV_PROT}&quot;</span> <span class="o">==</span> <span class="s">&quot;tcp&quot;</span> <span class="p">]];</span> <span class="n">then</span>
    <span class="n">PROT_OPT</span><span class="o">=</span><span class="s">&quot;S&quot;</span>
<span class="n">elif</span> <span class="p">[[</span> <span class="s">&quot;${TMP_SRV_PROT}&quot;</span> <span class="o">==</span> <span class="s">&quot;udp&quot;</span> <span class="p">]];</span> <span class="n">then</span>
    <span class="n">PROT_OPT</span><span class="o">=</span><span class="s">&quot;U&quot;</span>
<span class="k">else</span>
    <span class="n">echo</span> <span class="s">&quot;未知的协议类型！&quot;</span> <span class="o">&amp;&amp;</span> <span class="n">exit</span> <span class="mi">1</span>
<span class="n">fi</span>

<span class="cp">## 最多扫描3次，成功一次即可，以避免网络抖动而导致误判</span>
<span class="k">for</span> <span class="p">((</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">));</span> <span class="k">do</span>
    <span class="n">RETVAL</span><span class="o">=</span><span class="err">`</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">nmap</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">s</span><span class="err">$</span><span class="p">{</span><span class="n">PROT_OPT</span><span class="p">}</span> <span class="o">-</span><span class="n">p</span> <span class="err">$</span><span class="p">{</span><span class="n">SRV_PORT</span><span class="p">}</span> <span class="err">$</span><span class="p">{</span><span class="n">ETH1_ADDR</span><span class="p">}</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">open</span><span class="err">`</span>
    <span class="p">[[</span> <span class="o">-</span><span class="n">n</span> <span class="s">&quot;${RETVAL}&quot;</span> <span class="p">]]</span> <span class="o">&amp;&amp;</span> <span class="n">SCAN_FLAG</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="k">break</span> <span class="o">||</span> <span class="n">sleep</span> <span class="mi">10</span>
<span class="n">done</span>

<span class="cp">## 1、针对Atlas服务端口不通的情况，也就是服务彻底挂掉</span>
<span class="p">[[</span> <span class="err">$</span><span class="p">{</span><span class="n">SCAN_FLAG</span><span class="p">}</span> <span class="o">-</span><span class="n">ne</span> <span class="mi">1</span> <span class="p">]]</span> <span class="o">&amp;&amp;</span> <span class="n">RESTART_SRV_AND_ALERT</span> <span class="err">$</span><span class="p">{</span><span class="n">SRV_NAME</span><span class="p">}</span>

<span class="cp">## 2、检查Atlas服务是否正常工作，也就是服务端口正常，但访问异常的情况【高权限DB用户】</span>
<span class="n">mysqladmin</span> <span class="o">-</span><span class="n">h</span><span class="err">$</span><span class="p">{</span><span class="n">ETH1_ADDR</span><span class="p">}</span> <span class="o">-</span><span class="n">uhealth_check1</span> <span class="o">-</span><span class="n">p123456</span> <span class="o">--</span><span class="n">connect</span><span class="o">-</span><span class="n">timeout</span><span class="o">=</span><span class="mi">15</span> <span class="o">--</span><span class="n">shutdown</span><span class="o">-</span><span class="n">timeout</span><span class="o">=</span><span class="mi">15</span> <span class="n">ping</span>
<span class="p">[[</span> <span class="err">$</span><span class="o">?</span> <span class="o">-</span><span class="n">ne</span> <span class="mi">0</span> <span class="p">]]</span> <span class="o">&amp;&amp;</span> <span class="n">RESTART_SRV_AND_ALERT</span> <span class="err">$</span><span class="p">{</span><span class="n">SRV_NAME</span><span class="p">}</span>

<span class="cp">## 3、检查Atlas服务是否正常工作，也就是服务端口正常，高权限DB用户访问也正常，但低权限</span>
<span class="cp">##    DB用户访问异常的情况【低权限DB用户】</span>
<span class="n">mysqladmin</span> <span class="o">-</span><span class="n">h</span><span class="err">$</span><span class="p">{</span><span class="n">ETH1_ADDR</span><span class="p">}</span> <span class="o">-</span><span class="n">uhealth_check2</span> <span class="o">-</span><span class="n">p123456</span> <span class="o">--</span><span class="n">connect</span><span class="o">-</span><span class="n">timeout</span><span class="o">=</span><span class="mi">15</span> <span class="o">--</span><span class="n">shutdown</span><span class="o">-</span><span class="n">timeout</span><span class="o">=</span><span class="mi">15</span> <span class="n">ping</span>
<span class="p">[[</span> <span class="err">$</span><span class="o">?</span> <span class="o">-</span><span class="n">ne</span> <span class="mi">0</span> <span class="p">]]</span> <span class="o">&amp;&amp;</span> <span class="n">RESTART_SRV_AND_ALERT</span> <span class="err">$</span><span class="p">{</span><span class="n">SRV_NAME</span><span class="p">}</span>
<span class="mi">2</span><span class="err">、</span><span class="n">Atlas</span><span class="err">访问日志切割</span>
<span class="cp"># vim /data/scripts/cut_and_clear_access_log.sh</span>

<span class="cp">#!/bin/sh</span>
<span class="cp"># 切割Atlas的访问日志，同时清理15天之前的日志</span>
<span class="cp">#</span>
<span class="n">PATH</span><span class="o">=/</span><span class="nl">sbin</span><span class="p">:</span><span class="o">/</span><span class="nl">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nl">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nl">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nl">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span>

<span class="cp">## mysql-proxy日志路径</span>
<span class="n">LOGPATH</span><span class="o">=</span><span class="s">&quot;/usr/local/mysql-proxy/log&quot;</span>

<span class="p">[[</span> <span class="err">`</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">ip</span> <span class="n">addr</span> <span class="n">show</span> <span class="n">eth1</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">inet</span> <span class="o">|</span> <span class="n">wc</span> <span class="o">-</span><span class="n">l</span><span class="err">`</span> <span class="o">-</span><span class="n">eq</span> <span class="mi">2</span> <span class="p">]]</span> <span class="o">||</span> <span class="n">exit</span> <span class="mi">1</span> 
<span class="n">cd</span> <span class="err">$</span><span class="p">{</span><span class="n">LOGPATH</span><span class="p">}</span>

<span class="cp">## 日志切割</span>
<span class="n">HISTORY_LOG_PATH</span><span class="o">=</span><span class="err">`</span><span class="n">date</span> <span class="o">-</span><span class="n">d</span> <span class="err">&#39;</span><span class="o">-</span><span class="mi">1</span> <span class="n">hour</span><span class="err">&#39;</span> <span class="o">+</span><span class="s">&quot;%Y-%m-%d/sql_mysql-proxy_%H.log&quot;</span><span class="err">`</span>
<span class="p">[[</span> <span class="o">-</span><span class="n">d</span> <span class="err">`</span><span class="n">dirname</span> <span class="err">$</span><span class="p">{</span><span class="n">HISTORY_LOG_PATH</span><span class="p">}</span><span class="err">`</span> <span class="p">]]</span> <span class="o">||</span> <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="err">`</span><span class="n">dirname</span> <span class="err">$</span><span class="p">{</span><span class="n">HISTORY_LOG_PATH</span><span class="p">}</span><span class="err">`</span>
<span class="n">cp</span> <span class="o">-</span><span class="n">a</span> <span class="n">sql_mysql</span><span class="o">-</span><span class="n">proxy</span><span class="p">.</span><span class="n">log</span> <span class="err">$</span><span class="p">{</span><span class="n">HISTORY_LOG_PATH</span><span class="p">}</span>

<span class="n">echo</span> <span class="o">&gt;</span> <span class="n">sql_mysql</span><span class="o">-</span><span class="n">proxy</span><span class="p">.</span><span class="n">log</span>

<span class="cp">## 日志清理</span>
<span class="n">HISTORY_LOG_PATH</span><span class="o">=</span><span class="err">`</span><span class="n">date</span> <span class="o">-</span><span class="n">d</span> <span class="err">&#39;</span><span class="mi">15</span> <span class="n">days</span> <span class="n">ago</span><span class="err">&#39;</span> <span class="o">+</span><span class="err">&#39;</span><span class="o">%</span><span class="n">Y</span><span class="o">-%</span><span class="n">m</span><span class="o">-%</span><span class="n">d</span><span class="err">&#39;`</span>
<span class="p">[[</span> <span class="o">-</span><span class="n">d</span> <span class="err">$</span><span class="p">{</span><span class="n">HISTORY_LOG_PATH</span><span class="p">}</span> <span class="p">]]</span> <span class="o">&amp;&amp;</span> <span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="err">$</span><span class="p">{</span><span class="n">HISTORY_LOG_PATH</span><span class="p">}</span>
<span class="mi">3</span><span class="err">、</span><span class="n">crontab</span><span class="err">内容添加</span>
<span class="cp"># touch /var/lock/check_service.lock</span>
<span class="cp"># echo &#39;touch /var/lock/check_service.lock&#39; &gt;&gt; /etc/rc.d/rc.local</span>
<span class="cp"># crontab -uroot -e</span>
<span class="mi">1</span>
<span class="mi">2</span>
<span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="p">(</span><span class="n">flock</span> <span class="o">--</span><span class="n">timeout</span><span class="o">=</span><span class="mi">0</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lock</span><span class="o">/</span><span class="n">check_service</span><span class="p">.</span><span class="n">lock</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">mysql</span><span class="o">-</span><span class="n">proxy</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">check_service</span><span class="p">.</span><span class="n">sh</span> 
<span class="mi">3306</span> <span class="n">tcp</span> <span class="n">mysql</span><span class="o">-</span><span class="n">proxy</span> <span class="o">&gt;/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span><span class="p">)</span>
<span class="mo">00</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">cut_and_clear_access_log</span><span class="p">.</span><span class="n">sh</span> <span class="o">&gt;/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>
<span class="mi">4</span><span class="err">、平滑设置功能</span>
<span class="cp"># mysql -h10.209.6.101 -P3307 -usysadmin -p&#39;admin2356!@()&#39;</span>
<span class="n">wKioL1Sw8S_gXZOuAALgQK7R39c195</span><span class="p">.</span><span class="n">jpg</span>
</pre></div>


<h2 id="mycnf">my.cnf</h2>
<div class="codehilite"><pre><span></span><span class="n">以下选项会被MySQL客户端应用读取</span><span class="err">。</span><span class="w"></span>
<span class="n">注意只有MySQL附带的客户端应用程序保证可以读取这段内容</span><span class="err">。</span><span class="w"></span>
<span class="n">如果你想你自己的MySQL应用程序获取这些值</span><span class="err">。</span><span class="w"></span>
<span class="n">需要在MySQL客户端库初始化的时候指定这些选项</span><span class="err">。</span><span class="w"></span>


<span class="o">[</span><span class="n">client</span><span class="o">]</span><span class="w"></span>
<span class="n">password</span><span class="o">=[</span><span class="n">your_password</span><span class="o">]</span><span class="w"></span>
<span class="n">port</span><span class="o">=</span><span class="nv">@MYSQL_TCP_PORT</span><span class="err">@</span><span class="w"></span>
<span class="n">socket</span><span class="o">=</span><span class="nv">@MYSQL_UNIX_ADDR</span><span class="err">@</span><span class="w"></span>

<span class="o">***</span><span class="n">应用定制选项</span><span class="o">***</span><span class="w"></span>


<span class="n">MySQL服务端</span><span class="w"></span>

<span class="o">[</span><span class="n">mysqld</span><span class="o">]</span><span class="w"></span>

<span class="n">一般配置选项</span><span class="w"></span>
<span class="n">port</span><span class="o">=</span><span class="nv">@MYSQL_TCP_PORT</span><span class="err">@</span><span class="w"></span>
<span class="n">socket</span><span class="o">=</span><span class="nv">@MYSQL_UNIX_ADDR</span><span class="err">@</span><span class="w"></span>

<span class="n">skip</span><span class="o">-</span><span class="n">name</span><span class="o">-</span><span class="n">resolve</span><span class="w"></span>
<span class="n">选项就能禁用DNS解析</span><span class="err">，</span><span class="n">连接速度会快很多</span><span class="err">。</span><span class="n">不过</span><span class="err">，</span><span class="n">这样的话就不能在MySQL的授权表中使用主机名了而只能用ip格式</span><span class="w"></span>

<span class="n">back_log是操作系统在监听队列中所能保持的连接数</span><span class="p">,</span><span class="w"></span>
<span class="n">队列保存了在MySQL连接管理器线程处理之前的连接</span><span class="p">.</span><span class="w"></span>
<span class="n">如果你有非常高的连接率并且出现</span><span class="err">”</span><span class="n">connectionrefused</span><span class="err">”</span><span class="n">报错</span><span class="p">,</span><span class="w"></span>
<span class="n">你就应该增加此处的值</span><span class="p">.</span><span class="w"></span>
<span class="n">检查你的操作系统文档来获取这个变量的最大值</span><span class="p">.</span><span class="w"></span>
<span class="n">如果将back_log设定到比你操作系统限制更高的值</span><span class="p">,</span><span class="n">将会没有效果</span><span class="w"></span>
<span class="n">back_log</span><span class="o">=</span><span class="mi">300</span><span class="w"></span>

<span class="n">不在TCP</span><span class="o">/</span><span class="n">IP端口上进行监听</span><span class="p">.</span><span class="w"></span>
<span class="n">如果所有的进程都是在同一台服务器连接到本地的mysqld</span><span class="p">,</span><span class="w"></span>
<span class="n">这样设置将是增强安全的方法</span><span class="w"></span>
<span class="n">所有mysqld的连接都是通过Unixsockets或者命名管道进行的</span><span class="p">.</span><span class="w"></span>
<span class="n">注意在windows下如果没有打开命名管道选项而只是用此项</span><span class="w"></span>
<span class="p">(</span><span class="n">通过</span><span class="err">“</span><span class="n">enable</span><span class="o">-</span><span class="n">named</span><span class="o">-</span><span class="n">pipe</span><span class="err">”</span><span class="n">选项</span><span class="p">)</span><span class="n">将会导致mysql服务没有任何作用</span><span class="err">!</span><span class="w"></span>
<span class="n">skip</span><span class="o">-</span><span class="n">networking</span><span class="w"></span>

<span class="n">MySQL服务所允许的同时会话数的上限</span><span class="w"></span>
<span class="n">其中一个连接将被SUPER权限保留作为管理员登录</span><span class="p">.</span><span class="w"></span>
<span class="n">即便已经达到了连接数的上限</span><span class="p">.</span><span class="w"></span>
<span class="n">max_connections</span><span class="o">=</span><span class="mi">3000</span><span class="w"></span>
<span class="n">每个客户端连接最大的错误允许数量</span><span class="p">,</span><span class="n">如果达到了此限制</span><span class="p">.</span><span class="w"></span>
<span class="n">这个客户端将会被MySQL服务阻止直到执行了</span><span class="err">”</span><span class="n">FLUSHHOSTS</span><span class="err">”</span><span class="n">或者服务重启</span><span class="w"></span>
<span class="n">非法的密码以及其他在链接时的错误会增加此值</span><span class="p">.</span><span class="w"></span>
<span class="n">查看</span><span class="err">“</span><span class="n">Aborted_connects</span><span class="err">”</span><span class="n">状态来获取全局计数器</span><span class="p">.</span><span class="w"></span>
<span class="n">max_connect_errors</span><span class="o">=</span><span class="mi">30</span><span class="w"></span>

<span class="n">所有线程所打开表的数量</span><span class="p">.</span><span class="w"></span>
<span class="n">增加此值就增加了mysqld所需要的文件描述符的数量</span><span class="w"></span>
<span class="n">这样你需要确认在</span><span class="o">[</span><span class="n">mysqld_safe</span><span class="o">]</span><span class="n">中</span><span class="err">“</span><span class="k">open</span><span class="o">-</span><span class="n">files</span><span class="o">-</span><span class="k">limit</span><span class="err">”</span><span class="n">变量设置打开文件数量允许至少4096</span><span class="w"></span>
<span class="n">table_cache</span><span class="o">=</span><span class="mi">4096</span><span class="w"></span>

<span class="n">允许外部文件级别的锁</span><span class="p">.</span><span class="n">打开文件锁会对性能造成负面影响</span><span class="w"></span>
<span class="n">所以只有在你在同样的文件上运行多个数据库实例时才使用此选项</span><span class="p">(</span><span class="n">注意仍会有其他约束</span><span class="err">!</span><span class="p">)</span><span class="w"></span>
<span class="n">或者你在文件层面上使用了其他一些软件依赖来锁定MyISAM表</span><span class="w"></span>
<span class="k">external</span><span class="o">-</span><span class="n">locking</span><span class="w"></span>

<span class="n">服务所能处理的请求包的最大大小以及服务所能处理的最大的请求大小</span><span class="p">(</span><span class="n">当与大的BLOB字段一起工作时相当必要</span><span class="p">)</span><span class="w"></span>
<span class="n">每个连接独立的大小</span><span class="p">.</span><span class="n">大小动态增加</span><span class="w"></span>
<span class="n">max_allowed_packet</span><span class="o">=</span><span class="mi">32</span><span class="n">M</span><span class="w"></span>

<span class="n">在一个事务中binlog为了记录SQL状态所持有的cache大小</span><span class="w"></span>
<span class="n">如果你经常使用大的</span><span class="p">,</span><span class="n">多声明的事务</span><span class="p">,</span><span class="n">你可以增加此值来获取更大的性能</span><span class="p">.</span><span class="w"></span>
<span class="n">所有从事务来的状态都将被缓冲在binlog缓冲中然后在提交后一次性写入到binlog中</span><span class="w"></span>
<span class="n">如果事务比此值大</span><span class="p">,</span><span class="n">会使用磁盘上的临时文件来替代</span><span class="p">.</span><span class="w"></span>
<span class="n">此缓冲在每个连接的事务第一次更新状态时被创建</span><span class="w"></span>
<span class="n">binlog_cache_size</span><span class="o">=</span><span class="mi">4</span><span class="n">M</span><span class="w"></span>

<span class="n">独立的内存表所允许的最大容量</span><span class="p">.</span><span class="w"></span>
<span class="n">此选项为了防止意外创建一个超大的内存表导致永尽所有的内存资源</span><span class="p">.</span><span class="w"></span>
<span class="n">max_heap_table_size</span><span class="o">=</span><span class="mi">128</span><span class="n">M</span><span class="w"></span>

<span class="n">排序缓冲被用来处理类似ORDERBY以及GROUPBY队列所引起的排序</span><span class="w"></span>
<span class="n">如果排序后的数据无法放入排序缓冲</span><span class="p">,</span><span class="w"></span>
<span class="n">一个用来替代的基于磁盘的合并分类会被使用</span><span class="w"></span>
<span class="n">查看</span><span class="err">“</span><span class="n">Sort_merge_passes</span><span class="err">”</span><span class="n">状态变量</span><span class="p">.</span><span class="w"></span>
<span class="n">在排序发生时由每个线程分配</span><span class="w"></span>
<span class="n">sort_buffer_size</span><span class="o">=</span><span class="mi">16</span><span class="n">M</span><span class="w"></span>

<span class="n">此缓冲被使用来优化全联合</span><span class="p">(</span><span class="n">fullJOINs不带索引的联合</span><span class="p">).</span><span class="w"></span>
<span class="n">类似的联合在极大多数情况下有非常糟糕的性能表现</span><span class="p">,</span><span class="w"></span>
<span class="n">但是将此值设大能够减轻性能影响</span><span class="p">.</span><span class="w"></span>
<span class="n">通过</span><span class="err">“</span><span class="n">Select_full_join</span><span class="err">”</span><span class="n">状态变量查看全联合的数量</span><span class="w"></span>
<span class="n">当全联合发生时</span><span class="p">,</span><span class="n">在每个线程中分配</span><span class="w"></span>
<span class="n">join_buffer_size</span><span class="o">=</span><span class="mi">16</span><span class="n">M</span><span class="w"></span>

<span class="n">我们在cache中保留多少线程用于重用</span><span class="w"></span>
<span class="n">当一个客户端断开连接后</span><span class="p">,</span><span class="n">如果cache中的线程还少于thread_cache_size</span><span class="p">,</span><span class="w"></span>
<span class="n">则客户端线程被放入cache中</span><span class="p">.</span><span class="w"></span>
<span class="n">这可以在你需要大量新连接的时候极大的减少线程创建的开销</span><span class="w"></span>
<span class="p">(</span><span class="n">一般来说如果你有好的线程模型的话</span><span class="p">,</span><span class="n">这不会有明显的性能提升</span><span class="p">.)</span><span class="w"></span>
<span class="n">thread_cache_size</span><span class="o">=</span><span class="mi">16</span><span class="w"></span>

<span class="n">此允许应用程序给予线程系统一个提示在同一时间给予渴望被运行的线程的数量</span><span class="p">.</span><span class="w"></span>
<span class="n">此值只对于支持thread_concurrency</span><span class="p">()</span><span class="n">函数的系统有意义</span><span class="p">(</span><span class="n">例如SunSolaris</span><span class="p">).</span><span class="w"></span>
<span class="n">你可可以尝试使用</span><span class="o">[</span><span class="n">CPU数量</span><span class="o">]*</span><span class="p">(</span><span class="mf">2..4</span><span class="p">)</span><span class="n">来作为thread_concurrency的值</span><span class="w"></span>
<span class="n">thread_concurrency</span><span class="o">=</span><span class="mi">8</span><span class="w"></span>

<span class="n">查询缓冲常被用来缓冲SELECT的结果并且在下一次同样查询的时候不再执行直接返回结果</span><span class="p">.</span><span class="w"></span>
<span class="n">打开查询缓冲可以极大的提高服务器速度</span><span class="p">,</span><span class="n">如果你有大量的相同的查询并且很少修改表</span><span class="p">.</span><span class="w"></span>
<span class="n">查看</span><span class="err">“</span><span class="n">Qcache_lowmem_prunes</span><span class="err">”</span><span class="n">状态变量来检查是否当前值对于你的负载来说是否足够高</span><span class="p">.</span><span class="w"></span>
<span class="nl">注意</span><span class="p">:</span><span class="n">在你表经常变化的情况下或者如果你的查询原文每次都不同</span><span class="p">,</span><span class="w"></span>
<span class="n">查询缓冲也许引起性能下降而不是性能提升</span><span class="p">.</span><span class="w"></span>
<span class="n">query_cache_size</span><span class="o">=</span><span class="mi">128</span><span class="n">M</span><span class="w"></span>

<span class="n">只有小于此设定值的结果才会被缓冲</span><span class="w"></span>
<span class="n">此设置用来保护查询缓冲</span><span class="p">,</span><span class="n">防止一个极大的结果集将其他所有的查询结果都覆盖</span><span class="p">.</span><span class="w"></span>
<span class="n">query_cache_limit</span><span class="o">=</span><span class="mi">4</span><span class="n">M</span><span class="w"></span>

<span class="n">被全文检索索引的最小的字长</span><span class="p">.</span><span class="w"></span>
<span class="n">你也许希望减少它</span><span class="p">,</span><span class="n">如果你需要搜索更短字的时候</span><span class="p">.</span><span class="w"></span>
<span class="n">注意在你修改此值之后</span><span class="p">,</span><span class="w"></span>
<span class="n">你需要重建你的FULLTEXT索引</span><span class="w"></span>
<span class="n">ft_min_word_len</span><span class="o">=</span><span class="mi">8</span><span class="w"></span>

<span class="n">如果你的系统支持memlock</span><span class="p">()</span><span class="n">函数</span><span class="p">,</span><span class="n">你也许希望打开此选项用以让运行中的mysql在在内存高度紧张的时候</span><span class="p">,</span><span class="n">数据在内存中保持锁定并且防</span><span class="w"></span>
<span class="n">止可能被swappingout</span><span class="w"></span>
<span class="n">此选项对于性能有益</span><span class="w"></span>
<span class="n">memlock</span><span class="w"></span>

<span class="n">当创建新表时作为默认使用的表类型</span><span class="p">,</span><span class="w"></span>
<span class="n">如果在创建表示没有特别执行表类型</span><span class="p">,</span><span class="n">将会使用此值</span><span class="w"></span>
<span class="n">default_table_type</span><span class="o">=</span><span class="n">MYISAM</span><span class="w"></span>

<span class="n">线程使用的堆大小</span><span class="p">.</span><span class="n">此容量的内存在每次连接时被预留</span><span class="p">.</span><span class="w"></span>
<span class="n">MySQL本身常不会需要超过64K的内存</span><span class="w"></span>
<span class="n">如果你使用你自己的需要大量堆的UDF函数</span><span class="w"></span>
<span class="n">或者你的操作系统对于某些操作需要更多的堆</span><span class="p">,</span><span class="w"></span>
<span class="n">你也许需要将其设置的更高一点</span><span class="p">.</span><span class="w"></span>
<span class="n">thread_stack</span><span class="o">=</span><span class="mi">512</span><span class="n">K</span><span class="w"></span>

<span class="n">设定默认的事务隔离级别</span><span class="p">.</span><span class="nl">可用的级别如下</span><span class="p">:</span><span class="w"></span>
<span class="k">READ</span><span class="o">-</span><span class="n">UNCOMMITTED</span><span class="p">,</span><span class="k">READ</span><span class="o">-</span><span class="n">COMMITTED</span><span class="p">,</span><span class="n">REPEATABLE</span><span class="o">-</span><span class="k">READ</span><span class="p">,</span><span class="n">SERIALIZABLE</span><span class="w"></span>
<span class="n">transaction_isolation</span><span class="o">=</span><span class="n">REPEATABLE</span><span class="o">-</span><span class="k">READ</span><span class="w"></span>

<span class="n">内部</span><span class="p">(</span><span class="n">内存中</span><span class="p">)</span><span class="n">临时表的最大大小</span><span class="w"></span>
<span class="n">如果一个表增长到比此值更大</span><span class="p">,</span><span class="n">将会自动转换为基于磁盘的表</span><span class="p">.</span><span class="w"></span>
<span class="n">此限制是针对单个表的</span><span class="p">,</span><span class="n">而不是总和</span><span class="p">.</span><span class="w"></span>
<span class="n">tmp_table_size</span><span class="o">=</span><span class="mi">128</span><span class="n">M</span><span class="w"></span>

<span class="n">打开二进制日志功能</span><span class="p">.</span><span class="w"></span>
<span class="n">在复制</span><span class="p">(</span><span class="k">replication</span><span class="p">)</span><span class="n">配置中</span><span class="p">,</span><span class="n">作为MASTER主服务器必须打开此项</span><span class="w"></span>
<span class="n">如果你需要从你最后的备份中做基于时间点的恢复</span><span class="p">,</span><span class="n">你也同样需要二进制日志</span><span class="p">.</span><span class="w"></span>
<span class="nf">log</span><span class="o">-</span><span class="n">bin</span><span class="o">=</span><span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="w"></span>

<span class="n">如果你在使用链式从服务器结构的复制模式</span><span class="p">(</span><span class="n">A</span><span class="o">-&gt;</span><span class="n">B</span><span class="o">-&gt;</span><span class="n">C</span><span class="p">),</span><span class="w"></span>
<span class="n">你需要在服务器B上打开此项</span><span class="p">.</span><span class="w"></span>
<span class="n">此选项打开在从线程上重做过的更新的日志</span><span class="p">,</span><span class="w"></span>
<span class="n">并将其写入从服务器的二进制日志</span><span class="p">.</span><span class="w"></span>
<span class="n">log_slave_updates</span><span class="w"></span>

<span class="n">打开全查询日志</span><span class="p">.</span><span class="n">所有的由服务器接收到的查询</span><span class="p">(</span><span class="n">甚至对于一个错误语法的查询</span><span class="p">)</span><span class="w"></span>
<span class="n">都会被记录下来</span><span class="p">.</span><span class="n">这对于调试非常有用</span><span class="p">,</span><span class="n">在生产环境中常常关闭此项</span><span class="p">.</span><span class="w"></span>
<span class="nf">log</span><span class="w"></span>

<span class="n">将警告打印输出到错误log文件</span><span class="p">.</span><span class="n">如果你对于MySQL有任何问题</span><span class="w"></span>
<span class="n">你应该打开警告log并且仔细审查错误日志</span><span class="p">,</span><span class="n">查出可能的原因</span><span class="p">.</span><span class="w"></span>
<span class="n">log_warnings</span><span class="w"></span>

<span class="n">记录慢速查询</span><span class="p">.</span><span class="n">慢速查询是指消耗了比</span><span class="err">“</span><span class="n">long_query_time</span><span class="err">”</span><span class="n">定义的更多时间的查询</span><span class="p">.</span><span class="w"></span>
<span class="n">如果log_long_format被打开</span><span class="p">,</span><span class="n">那些没有使用索引的查询也会被记录</span><span class="p">.</span><span class="w"></span>
<span class="n">如果你经常增加新查询到已有的系统内的话</span><span class="p">.</span><span class="n">一般来说这是一个好主意</span><span class="p">,</span><span class="w"></span>
<span class="n">log_slow_queries</span><span class="w"></span>

<span class="n">所有的使用了比这个时间</span><span class="p">(</span><span class="n">以秒为单位</span><span class="p">)</span><span class="n">更多的查询会被认为是慢速查询</span><span class="p">.</span><span class="w"></span>
<span class="n">不要在这里使用</span><span class="err">”</span><span class="mi">1</span><span class="err">″</span><span class="p">,</span><span class="n">否则会导致所有的查询</span><span class="p">,</span><span class="n">甚至非常快的查询页被记录下来</span><span class="p">(</span><span class="n">由于MySQL目前时间的精确度只能达到秒的级别</span><span class="p">).</span><span class="w"></span>
<span class="n">long_query_time</span><span class="o">=</span><span class="mi">6</span><span class="w"></span>

<span class="n">在慢速日志中记录更多的信息</span><span class="p">.</span><span class="w"></span>
<span class="n">一般此项最好打开</span><span class="p">.</span><span class="w"></span>
<span class="n">打开此项会记录使得那些没有使用索引的查询也被作为到慢速查询附加到慢速日志里</span><span class="w"></span>
<span class="n">log_long_format</span><span class="w"></span>

<span class="n">此目录被MySQL用来保存临时文件</span><span class="p">.</span><span class="n">例如</span><span class="p">,</span><span class="w"></span>
<span class="n">它被用来处理基于磁盘的大型排序</span><span class="p">,</span><span class="n">和内部排序一样</span><span class="p">.</span><span class="w"></span>
<span class="n">以及简单的临时表</span><span class="p">.</span><span class="w"></span>
<span class="n">如果你不创建非常大的临时文件</span><span class="p">,</span><span class="n">将其放置到swapfs</span><span class="o">/</span><span class="n">tmpfs文件系统上也许比较好</span><span class="w"></span>
<span class="n">另一种选择是你也可以将其放置在独立的磁盘上</span><span class="p">.</span><span class="w"></span>
<span class="n">你可以使用</span><span class="err">”</span><span class="p">;</span><span class="err">”</span><span class="n">来放置多个路径</span><span class="w"></span>
<span class="n">他们会按照roud</span><span class="o">-</span><span class="n">robin方法被轮询使用</span><span class="p">.</span><span class="w"></span>
<span class="n">tmpdir</span><span class="o">=/</span><span class="n">tmp</span><span class="w"></span>

<span class="o">***</span><span class="n">主从复制相关的设置</span><span class="w"></span>

<span class="n">唯一的服务辨识号</span><span class="p">,</span><span class="n">数值位于1到2</span><span class="o">^</span><span class="mi">32</span><span class="o">-</span><span class="mi">1</span><span class="n">之间</span><span class="p">.</span><span class="w"></span>
<span class="n">此值在master和slave上都需要设置</span><span class="p">.</span><span class="w"></span>
<span class="n">如果</span><span class="err">“</span><span class="n">master</span><span class="o">-</span><span class="k">host</span><span class="err">”</span><span class="n">没有被设置</span><span class="p">,</span><span class="n">则默认为1</span><span class="p">,</span><span class="n">但是如果忽略此选项</span><span class="p">,</span><span class="n">MySQL不会作为master生效</span><span class="p">.</span><span class="w"></span>
<span class="n">server</span><span class="o">-</span><span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>

<span class="n">复制的Slave</span><span class="p">(</span><span class="n">去掉master段的注释来使其生效</span><span class="p">)</span><span class="w"></span>

<span class="n">为了配置此主机作为复制的slave服务器</span><span class="p">,</span><span class="nl">你可以选择两种方法</span><span class="p">:</span><span class="w"></span>

<span class="mi">1</span><span class="p">)</span><span class="n">使用CHANGEMASTERTO命令</span><span class="p">(</span><span class="n">在我们的手册中有完整描述</span><span class="p">)</span><span class="o">-</span><span class="w"></span>
<span class="nl">语法如下</span><span class="p">:</span><span class="w"></span>

<span class="n">CHANGEMASTERTOMASTER_HOST</span><span class="o">=</span><span class="p">,</span><span class="n">MASTER_PORT</span><span class="o">=</span><span class="p">,</span><span class="w"></span>
<span class="n">MASTER_USER</span><span class="o">=</span><span class="p">,</span><span class="n">MASTER_PASSWORD</span><span class="o">=</span><span class="p">;</span><span class="w"></span>

<span class="n">你需要替换掉</span><span class="p">,,</span><span class="n">等被尖括号包围的字段以及使用master的端口号替换</span><span class="p">(</span><span class="n">默认3306</span><span class="p">).</span><span class="w"></span>

<span class="nl">例子</span><span class="p">:</span><span class="w"></span>

<span class="n">CHANGEMASTERTOMASTER_HOST</span><span class="o">=</span><span class="err">’</span><span class="mf">125.564.12.1</span><span class="err">′</span><span class="p">,</span><span class="n">MASTER_PORT</span><span class="o">=</span><span class="mi">3306</span><span class="p">,</span><span class="w"></span>
<span class="n">MASTER_USER</span><span class="o">=</span><span class="err">’</span><span class="n">joe</span><span class="err">’</span><span class="p">,</span><span class="n">MASTER_PASSWORD</span><span class="o">=</span><span class="err">’</span><span class="n">secret</span><span class="err">’</span><span class="p">;</span><span class="w"></span>

<span class="n">或者</span><span class="w"></span>

<span class="mi">2</span><span class="p">)</span><span class="n">设置以下的变量</span><span class="p">.</span><span class="n">不论如何</span><span class="p">,</span><span class="n">在你选择这种方法的情况下</span><span class="p">,</span><span class="n">然后第一次启动复制</span><span class="p">(</span><span class="n">甚至不成功的情况下</span><span class="p">,</span><span class="w"></span>
<span class="n">例如如果你输入错密码在master</span><span class="o">-</span><span class="n">password字段并且slave无法连接</span><span class="p">),</span><span class="w"></span>
<span class="n">slave会创建一个master</span><span class="p">.</span><span class="n">info文件</span><span class="p">,</span><span class="n">并且之后任何对于包含在此文件内的参数的变化都会被忽略</span><span class="w"></span>
<span class="n">并且由master</span><span class="p">.</span><span class="n">info文件内的内容覆盖</span><span class="p">,</span><span class="n">除非你关闭slave服务</span><span class="p">,</span><span class="n">删除master</span><span class="p">.</span><span class="n">info并且重启slave服务</span><span class="p">.</span><span class="w"></span>
<span class="n">由于这个原因</span><span class="p">,</span><span class="n">你也许不想碰一下的配置</span><span class="p">(</span><span class="n">注释掉的</span><span class="p">)</span><span class="n">并且使用CHANGEMASTERTO</span><span class="p">(</span><span class="n">查看上面</span><span class="p">)</span><span class="n">来代替</span><span class="w"></span>

<span class="n">所需要的唯一id号位于2和2</span><span class="o">^</span><span class="mi">32</span><span class="err">–</span><span class="mi">1</span><span class="n">之间</span><span class="w"></span>
<span class="p">(</span><span class="n">并且和master不同</span><span class="p">)</span><span class="w"></span>
<span class="n">如果master</span><span class="o">-</span><span class="n">host被设置了</span><span class="p">.</span><span class="n">则默认值是2</span><span class="w"></span>
<span class="n">但是如果省略</span><span class="p">,</span><span class="n">则不会生效</span><span class="w"></span>
<span class="n">server</span><span class="o">-</span><span class="n">id</span><span class="o">=</span><span class="mi">2</span><span class="w"></span>

<span class="n">复制结构中的master</span><span class="err">–</span><span class="n">必须</span><span class="w"></span>
<span class="n">master</span><span class="o">-</span><span class="k">host</span><span class="o">=</span><span class="w"></span>

<span class="n">当连接到master上时slave所用来认证的用户名</span><span class="err">–</span><span class="n">必须</span><span class="w"></span>
<span class="n">master</span><span class="o">-</span><span class="k">user</span><span class="o">=</span><span class="w"></span>

<span class="n">当连接到master上时slave所用来认证的密码</span><span class="err">–</span><span class="n">必须</span><span class="w"></span>
<span class="n">master</span><span class="o">-</span><span class="n">password</span><span class="o">=</span><span class="w"></span>

<span class="n">master监听的端口</span><span class="p">.</span><span class="w"></span>
<span class="n">可选</span><span class="err">–</span><span class="n">默认是3306</span><span class="w"></span>
<span class="n">master</span><span class="o">-</span><span class="n">port</span><span class="o">=</span><span class="w"></span>

<span class="n">使得slave只读</span><span class="p">.</span><span class="n">只有用户拥有SUPER权限和在上面的slave线程能够修改数据</span><span class="p">.</span><span class="w"></span>
<span class="n">你可以使用此项去保证没有应用程序会意外的修改slave而不是master上的数据</span><span class="w"></span>
<span class="n">read_only</span><span class="w"></span>

<span class="o">***</span><span class="n">MyISAM相关选项</span><span class="w"></span>

<span class="n">关键词缓冲的大小</span><span class="p">,</span><span class="n">一般用来缓冲MyISAM表的索引块</span><span class="p">.</span><span class="w"></span>
<span class="n">不要将其设置大于你可用内存的30</span><span class="o">%</span><span class="p">,</span><span class="w"></span>
<span class="n">因为一部分内存同样被OS用来缓冲行数据</span><span class="w"></span>
<span class="n">甚至在你并不使用MyISAM表的情况下</span><span class="p">,</span><span class="n">你也需要仍旧设置起8</span><span class="o">-</span><span class="mi">64</span><span class="n">M内存由于它同样会被内部临时磁盘表使用</span><span class="p">.</span><span class="w"></span>
<span class="n">key_buffer_size</span><span class="o">=</span><span class="mi">128</span><span class="n">M</span><span class="w"></span>

<span class="n">用来做MyISAM表全表扫描的缓冲大小</span><span class="p">.</span><span class="w"></span>
<span class="n">当全表扫描需要时</span><span class="p">,</span><span class="n">在对应线程中分配</span><span class="p">.</span><span class="w"></span>
<span class="n">read_buffer_size</span><span class="o">=</span><span class="mi">8</span><span class="n">M</span><span class="w"></span>

<span class="n">当在排序之后</span><span class="p">,</span><span class="n">从一个已经排序好的序列中读取行时</span><span class="p">,</span><span class="n">行数据将从这个缓冲中读取来防止磁盘寻道</span><span class="p">.</span><span class="w"></span>
<span class="n">如果你增高此值</span><span class="p">,</span><span class="n">可以提高很多ORDERBY的性能</span><span class="p">.</span><span class="w"></span>
<span class="n">当需要时由每个线程分配</span><span class="w"></span>
<span class="n">read_rnd_buffer_size</span><span class="o">=</span><span class="mi">64</span><span class="n">M</span><span class="w"></span>

<span class="n">MyISAM使用特殊的类似树的cache来使得突发插入</span><span class="w"></span>
<span class="p">(</span><span class="n">这些插入是</span><span class="p">,</span><span class="k">INSERT</span><span class="err">…</span><span class="k">SELECT</span><span class="p">,</span><span class="k">INSERT</span><span class="err">…</span><span class="k">VALUES</span><span class="p">(</span><span class="err">…</span><span class="p">),(</span><span class="err">…</span><span class="p">),</span><span class="err">…</span><span class="p">,</span><span class="n">以及LOADDATA</span><span class="w"></span>
<span class="n">INFILE</span><span class="p">)</span><span class="n">更快</span><span class="p">.</span><span class="n">此变量限制每个进程中缓冲树的字节数</span><span class="p">.</span><span class="w"></span>
<span class="n">设置为0会关闭此优化</span><span class="p">.</span><span class="w"></span>
<span class="n">为了最优化不要将此值设置大于</span><span class="err">“</span><span class="n">key_buffer_size</span><span class="err">”</span><span class="p">.</span><span class="w"></span>
<span class="n">当突发插入被检测到时此缓冲将被分配</span><span class="p">.</span><span class="w"></span>
<span class="n">bulk_insert_buffer_size</span><span class="o">=</span><span class="mi">256</span><span class="n">M</span><span class="w"></span>

<span class="n">此缓冲当MySQL需要在REPAIR</span><span class="p">,</span><span class="n">OPTIMIZE</span><span class="p">,</span><span class="n">ALTER以及LOADDATAINFILE到一个空表中引起重建索引时被分配</span><span class="p">.</span><span class="w"></span>
<span class="n">这在每个线程中被分配</span><span class="p">.</span><span class="n">所以在设置大值时需要小心</span><span class="p">.</span><span class="w"></span>
<span class="n">myisam_sort_buffer_size</span><span class="o">=</span><span class="mi">256</span><span class="n">M</span><span class="w"></span>

<span class="n">MySQL重建索引时所允许的最大临时文件的大小</span><span class="p">(</span><span class="n">当REPAIR</span><span class="p">,</span><span class="n">ALTERTABLE或者LOADDATAINFILE</span><span class="p">).</span><span class="w"></span>
<span class="n">如果文件大小比此值更大</span><span class="p">,</span><span class="n">索引会通过键值缓冲创建</span><span class="p">(</span><span class="n">更慢</span><span class="p">)</span><span class="w"></span>
<span class="n">myisam_max_sort_file_size</span><span class="o">=</span><span class="mi">10</span><span class="n">G</span><span class="w"></span>

<span class="n">如果被用来更快的索引创建索引所使用临时文件大于制定的值</span><span class="p">,</span><span class="n">那就使用键值缓冲方法</span><span class="p">.</span><span class="w"></span>
<span class="n">这主要用来强制在大表中长字串键去使用慢速的键值缓冲方法来创建索引</span><span class="p">.</span><span class="w"></span>
<span class="n">myisam_max_extra_sort_file_size</span><span class="o">=</span><span class="mi">10</span><span class="n">G</span><span class="w"></span>

<span class="n">如果一个表拥有超过一个索引</span><span class="p">,</span><span class="n">MyISAM可以通过并行排序使用超过一个线程去修复他们</span><span class="p">.</span><span class="w"></span>
<span class="n">这对于拥有多个CPU以及大量内存情况的用户</span><span class="p">,</span><span class="n">是一个很好的选择</span><span class="p">.</span><span class="w"></span>
<span class="n">myisam_repair_threads</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>

<span class="n">自动检查和修复没有适当关闭的MyISAM表</span><span class="p">.</span><span class="w"></span>
<span class="n">myisam_recover</span><span class="w"></span>

<span class="n">默认关闭Federated</span><span class="w"></span>
<span class="n">skip</span><span class="o">-</span><span class="n">federated</span><span class="w"></span>

<span class="o">***</span><span class="n">BDB相关选项</span><span class="o">***</span><span class="w"></span>

<span class="n">如果你运行的MySQL服务有BDB支持但是你不准备使用的时候使用此选项</span><span class="p">.</span><span class="n">这会节省内存并且可能加速一些事</span><span class="p">.</span><span class="w"></span>
<span class="n">skip</span><span class="o">-</span><span class="n">bdb</span><span class="w"></span>

<span class="o">***</span><span class="n">INNODB相关选项</span><span class="o">***</span><span class="w"></span>

<span class="n">如果你的MySQL服务包含InnoDB支持但是并不打算使用的话</span><span class="p">,</span><span class="w"></span>
<span class="n">使用此选项会节省内存以及磁盘空间</span><span class="p">,</span><span class="n">并且加速某些部分</span><span class="w"></span>
<span class="n">skip</span><span class="o">-</span><span class="n">innodb</span><span class="w"></span>

<span class="n">附加的内存池被InnoDB用来保存metadata信息</span><span class="w"></span>
<span class="n">如果InnoDB为此目的需要更多的内存</span><span class="p">,</span><span class="n">它会开始从OS这里申请内存</span><span class="p">.</span><span class="w"></span>
<span class="n">由于这个操作在大多数现代操作系统上已经足够快</span><span class="p">,</span><span class="n">你一般不需要修改此值</span><span class="p">.</span><span class="w"></span>
<span class="n">SHOWINNODBSTATUS命令会显示当先使用的数量</span><span class="p">.</span><span class="w"></span>
<span class="n">innodb_additional_mem_pool_size</span><span class="o">=</span><span class="mi">64</span><span class="n">M</span><span class="w"></span>

<span class="n">InnoDB使用一个缓冲池来保存索引和原始数据</span><span class="p">,</span><span class="n">不像MyISAM</span><span class="p">.</span><span class="w"></span>
<span class="n">这里你设置越大</span><span class="p">,</span><span class="n">你在存取表里面数据时所需要的磁盘I</span><span class="o">/</span><span class="n">O越少</span><span class="p">.</span><span class="w"></span>
<span class="n">在一个独立使用的数据库服务器上</span><span class="p">,</span><span class="n">你可以设置这个变量到服务器物理内存大小的80</span><span class="o">%</span><span class="w"></span>
<span class="n">不要设置过大</span><span class="p">,</span><span class="n">否则</span><span class="p">,</span><span class="n">由于物理内存的竞争可能导致操作系统的换页颠簸</span><span class="p">.</span><span class="w"></span>
<span class="n">注意在32位系统上你每个进程可能被限制在2</span><span class="o">-</span><span class="mf">3.5</span><span class="n">G用户层面内存限制</span><span class="p">,</span><span class="w"></span>
<span class="n">所以不要设置的太高</span><span class="p">.</span><span class="w"></span>
<span class="n">innodb_buffer_pool_size</span><span class="o">=</span><span class="mi">6</span><span class="n">G</span><span class="w"></span>

<span class="n">InnoDB将数据保存在一个或者多个数据文件中成为表空间</span><span class="p">.</span><span class="w"></span>
<span class="n">如果你只有单个逻辑驱动保存你的数据</span><span class="p">,</span><span class="n">一个单个的自增文件就足够好了</span><span class="p">.</span><span class="w"></span>
<span class="n">其他情况下</span><span class="p">.</span><span class="n">每个设备一个文件一般都是个好的选择</span><span class="p">.</span><span class="w"></span>
<span class="n">你也可以配置InnoDB来使用裸盘分区</span><span class="err">–</span><span class="n">请参考手册来获取更多相关内容</span><span class="w"></span>
<span class="n">innodb_data_file_path</span><span class="o">=</span><span class="nl">ibdata1</span><span class="p">:</span><span class="mi">10</span><span class="nl">M</span><span class="p">:</span><span class="n">autoextend</span><span class="w"></span>

<span class="n">设置此选项如果你希望InnoDB表空间文件被保存在其他分区</span><span class="p">.</span><span class="w"></span>
<span class="n">默认保存在MySQL的datadir中</span><span class="p">.</span><span class="w"></span>
<span class="n">innodb_data_home_dir</span><span class="o">=</span><span class="w"></span>

<span class="n">用来同步IO操作的IO线程的数量</span><span class="p">.</span><span class="n">Thisvalueis</span><span class="w"></span>
<span class="n">此值在Unix下被硬编码为4</span><span class="p">,</span><span class="n">但是在Windows磁盘I</span><span class="o">/</span><span class="n">O可能在一个大数值下表现的更好</span><span class="p">.</span><span class="w"></span>
<span class="n">innodb_file_io_threads</span><span class="o">=</span><span class="mi">4</span><span class="w"></span>

<span class="n">如果你发现InnoDB表空间损坏</span><span class="p">,</span><span class="n">设置此值为一个非零值可能帮助你导出你的表</span><span class="p">.</span><span class="w"></span>
<span class="n">从1开始并且增加此值知道你能够成功的导出表</span><span class="p">.</span><span class="w"></span>
<span class="n">innodb_force_recovery</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>

<span class="n">在InnoDb核心内的允许线程数量</span><span class="p">.</span><span class="w"></span>
<span class="n">最优值依赖于应用程序</span><span class="p">,</span><span class="n">硬件以及操作系统的调度方式</span><span class="p">.</span><span class="w"></span>
<span class="n">过高的值可能导致线程的互斥颠簸</span><span class="p">.</span><span class="w"></span>
<span class="n">innodb_thread_concurrency</span><span class="o">=</span><span class="mi">16</span><span class="w"></span>

<span class="n">如果设置为1</span><span class="p">,</span><span class="n">InnoDB会在每次提交后刷新</span><span class="p">(</span><span class="n">fsync</span><span class="p">)</span><span class="n">事务日志到磁盘上</span><span class="p">,</span><span class="w"></span>
<span class="n">这提供了完整的ACID行为</span><span class="p">.</span><span class="w"></span>
<span class="n">如果你愿意对事务安全折衷</span><span class="p">,</span><span class="n">并且你正在运行一个小的食物</span><span class="p">,</span><span class="n">你可以设置此值到0或者2来减少由事务日志引起的磁盘I</span><span class="o">/</span><span class="n">O</span><span class="w"></span>
<span class="mi">0</span><span class="n">代表日志只大约每秒写入日志文件并且日志文件刷新到磁盘</span><span class="p">.</span><span class="w"></span>
<span class="mi">2</span><span class="n">代表日志写入日志文件在每次提交后</span><span class="p">,</span><span class="n">但是日志文件只有大约每秒才会刷新到磁盘上</span><span class="p">.</span><span class="w"></span>
<span class="n">innodb_flush_log_at_trx_commit</span><span class="o">=</span><span class="mi">2</span><span class="w"></span>
<span class="err">（</span><span class="n">说明</span><span class="err">：</span><span class="n">如果是游戏服务器</span><span class="err">，</span><span class="n">建议此值设置为2</span><span class="err">；</span><span class="n">如果是对数据安全要求极高的应用</span><span class="err">，</span><span class="n">建议设置为1</span><span class="err">；</span><span class="n">设置为0性能最高</span><span class="err">，</span><span class="n">但如果发生故障</span><span class="err">，</span><span class="w"></span>
<span class="n">数据可能会有丢失的危险</span><span class="err">！</span><span class="n">默认值1的意思是每一次事务提交或事务外的指令都需要把日志写入</span><span class="err">（</span><span class="n">flush</span><span class="err">）</span><span class="n">硬盘</span><span class="err">，</span><span class="n">这是很费时的</span><span class="err">。</span><span class="n">特别是使用电</span><span class="w"></span>
<span class="n">池供电缓存</span><span class="err">（</span><span class="n">Batterybackedupcache</span><span class="err">）</span><span class="n">时</span><span class="err">。</span><span class="n">设成2对于很多运用</span><span class="err">，</span><span class="n">特别是从MyISAM表转过来的是可以的</span><span class="err">，</span><span class="n">它的意思是不写入硬盘而是写入</span><span class="w"></span>
<span class="n">系统缓存</span><span class="err">。</span><span class="n">日志仍然会每秒flush到硬盘</span><span class="err">，</span><span class="n">所以你一般不会丢失超过1</span><span class="o">-</span><span class="mi">2</span><span class="n">秒的更新</span><span class="err">。</span><span class="n">设成0会更快一点</span><span class="err">，</span><span class="n">但安全方面比较差</span><span class="err">，</span><span class="n">即使MySQL挂了</span><span class="w"></span>
<span class="n">也可能会丢失事务的数据</span><span class="err">。</span><span class="n">而值2只会在整个操作系统挂了时才可能丢数据</span><span class="err">。）</span><span class="w"></span>

<span class="n">加速InnoDB的关闭</span><span class="p">.</span><span class="n">这会阻止InnoDB在关闭时做全清除以及插入缓冲合并</span><span class="p">.</span><span class="w"></span>
<span class="n">这可能极大增加关机时间</span><span class="p">,</span><span class="n">但是取而代之的是InnoDB可能在下次启动时做这些操作</span><span class="p">.</span><span class="w"></span>
<span class="n">innodb_fast_shutdown</span><span class="w"></span>

<span class="n">用来缓冲日志数据的缓冲区的大小</span><span class="p">.</span><span class="w"></span>
<span class="n">当此值快满时</span><span class="p">,</span><span class="n">InnoDB将必须刷新数据到磁盘上</span><span class="p">.</span><span class="w"></span>
<span class="n">由于基本上每秒都会刷新一次</span><span class="p">,</span><span class="n">所以没有必要将此值设置的太大</span><span class="p">(</span><span class="n">甚至对于长事务而言</span><span class="p">)</span><span class="w"></span>

<span class="n">innodb_log_buffer_size</span><span class="o">=</span><span class="mi">16</span><span class="n">M</span><span class="w"></span>

<span class="n">在日志组中每个日志文件的大小</span><span class="p">.</span><span class="w"></span>
<span class="n">你应该设置日志文件总合大小到你缓冲池大小的25</span><span class="o">%~</span><span class="mi">100</span><span class="o">%</span><span class="w"></span>
<span class="n">来避免在日志文件覆写上不必要的缓冲池刷新行为</span><span class="p">.</span><span class="w"></span>
<span class="n">不论如何</span><span class="p">,</span><span class="n">请注意一个大的日志文件大小会增加恢复进程所需要的时间</span><span class="p">.</span><span class="w"></span>
<span class="n">innodb_log_file_size</span><span class="o">=</span><span class="mi">512</span><span class="n">M</span><span class="w"></span>

<span class="n">在日志组中的文件总数</span><span class="p">.</span><span class="w"></span>
<span class="n">通常来说2</span><span class="o">~</span><span class="mi">3</span><span class="n">是比较好的</span><span class="p">.</span><span class="w"></span>
<span class="n">innodb_log_files_in_group</span><span class="o">=</span><span class="mi">3</span><span class="w"></span>

<span class="n">InnoDB的日志文件所在位置</span><span class="p">.</span><span class="n">默认是MySQL的datadir</span><span class="p">.</span><span class="w"></span>
<span class="n">你可以将其指定到一个独立的硬盘上或者一个RAID1卷上来提高其性能</span><span class="w"></span>
<span class="n">innodb_log_group_home_dir</span><span class="w"></span>

<span class="n">在InnoDB缓冲池中最大允许的脏页面的比例</span><span class="p">.</span><span class="w"></span>
<span class="n">如果达到限额</span><span class="p">,</span><span class="n">InnoDB会开始刷新他们防止他们妨碍到干净数据页面</span><span class="p">.</span><span class="w"></span>
<span class="n">这是一个软限制</span><span class="p">,</span><span class="n">不被保证绝对执行</span><span class="p">.</span><span class="w"></span>
<span class="n">innodb_max_dirty_pages_pct</span><span class="o">=</span><span class="mi">90</span><span class="w"></span>

<span class="n">InnoDB用来刷新日志的方法</span><span class="p">.</span><span class="w"></span>
<span class="n">表空间总是使用双重写入刷新方法</span><span class="w"></span>
<span class="n">默认值是</span><span class="err">“</span><span class="n">fdatasync</span><span class="err">”</span><span class="p">,</span><span class="n">另一个是</span><span class="err">“</span><span class="n">O_DSYNC</span><span class="err">”</span><span class="p">.</span><span class="w"></span>
<span class="n">innodb_flush_method</span><span class="o">=</span><span class="n">O_DSYNC</span><span class="w"></span>

<span class="n">在被回滚前</span><span class="p">,</span><span class="n">一个InnoDB的事务应该等待一个锁被批准多久</span><span class="p">.</span><span class="w"></span>
<span class="n">InnoDB在其拥有的锁表中自动检测事务死锁并且回滚事务</span><span class="p">.</span><span class="w"></span>
<span class="n">如果你使用LOCKTABLES指令</span><span class="p">,</span><span class="n">或者在同样事务中使用除了InnoDB以外的其他事务安全的存储引擎</span><span class="w"></span>
<span class="n">那么一个死锁可能发生而InnoDB无法注意到</span><span class="p">.</span><span class="w"></span>
<span class="n">这种情况下这个timeout值对于解决这种问题就非常有帮助</span><span class="p">.</span><span class="w"></span>
<span class="n">innodb_lock_wait_timeout</span><span class="o">=</span><span class="mi">120</span><span class="w"></span>

<span class="o">[</span><span class="n">mysqldump</span><span class="o">]</span><span class="w"></span>
<span class="n">不要在将内存中的整个结果写入磁盘之前缓存</span><span class="p">.</span><span class="n">在导出非常巨大的表时需要此项</span><span class="w"></span>
<span class="n">quick</span><span class="w"></span>

<span class="n">max_allowed_packet</span><span class="o">=</span><span class="mi">32</span><span class="n">M</span><span class="w"></span>

<span class="o">[</span><span class="n">mysql</span><span class="o">]</span><span class="w"></span>
<span class="k">no</span><span class="o">-</span><span class="n">auto</span><span class="o">-</span><span class="n">rehash</span><span class="w"></span>

<span class="n">仅仅允许使用键值的UPDATEs和DELETEs</span><span class="p">.</span><span class="w"></span>
<span class="n">safe</span><span class="o">-</span><span class="n">updates</span><span class="w"></span>

<span class="o">[</span><span class="n">isamchk</span><span class="o">]</span><span class="w"></span>
<span class="n">key_buffer</span><span class="o">=</span><span class="mi">2048</span><span class="n">M</span><span class="w"></span>
<span class="n">sort_buffer_size</span><span class="o">=</span><span class="mi">2048</span><span class="n">M</span><span class="w"></span>
<span class="n">read_buffer</span><span class="o">=</span><span class="mi">32</span><span class="n">M</span><span class="w"></span>
<span class="n">write_buffer</span><span class="o">=</span><span class="mi">32</span><span class="n">M</span><span class="w"></span>

<span class="o">[</span><span class="n">myisamchk</span><span class="o">]</span><span class="w"></span>
<span class="n">key_buffer</span><span class="o">=</span><span class="mi">2048</span><span class="n">M</span><span class="w"></span>
<span class="n">sort_buffer_size</span><span class="o">=</span><span class="mi">2048</span><span class="n">M</span><span class="w"></span>
<span class="n">read_buffer</span><span class="o">=</span><span class="mi">32</span><span class="n">M</span><span class="w"></span>
<span class="n">write_buffer</span><span class="o">=</span><span class="mi">32</span><span class="n">M</span><span class="w"></span>

<span class="o">[</span><span class="n">mysqlhotcopy</span><span class="o">]</span><span class="w"></span>
<span class="n">interactive</span><span class="o">-</span><span class="n">timeout</span><span class="w"></span>

<span class="o">[</span><span class="n">mysqld_safe</span><span class="o">]</span><span class="w"></span>
<span class="n">增加每个进程的可打开文件数量</span><span class="p">.</span><span class="w"></span>
<span class="nl">警告</span><span class="p">:</span><span class="n">确认你已经将全系统限制设定的足够高</span><span class="err">!</span><span class="w"></span>
<span class="n">打开大量表需要将此值设大</span><span class="w"></span>
<span class="k">open</span><span class="o">-</span><span class="n">files</span><span class="o">-</span><span class="k">limit</span><span class="o">=</span><span class="mi">8192</span><span class="w"></span>
</pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../mysql/" title="mysql" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                mysql
              </span>
            </div>
          </a>
        
        
          <a href="../memcached/" title="memcached" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                memcached
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>